<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>ceoDOC.it - MCC RATING ANALYSIS PROTOCOL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    FILE: anacrisk.html
    POSIZIONE: utente\Desktop\ceoDOC\archivio\centralerischi\anacrisk.html
    VERSIONE: v1.4 COMPLETA FINALE - Parser esteso + 60 mesi + 12 mesi grafici
    LIBRERIE: ../libs/ (Chart.js, PDF.js, jsPDF, XLSX)
    SALVATAGGI: ../dati/reportcrisk/
  -->

  <!-- Favicon ceoDOC -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%23ff6b00'/%3E%3Cstop offset='100%25' stop-color='%231d3557'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='10' y='60' width='8' height='30' rx='2' fill='url(%23g1)'/%3E%3Crect x='25' y='45' width='8' height='45' rx='2' fill='url(%23g1)'/%3E%3Crect x='40' y='35' width='8' height='55' rx='2' fill='url(%23g1)'/%3E%3Crect x='55' y='50' width='8' height='40' rx='2' fill='url(%23g1)'/%3E%3Crect x='70' y='40' width='8' height='50' rx='2' fill='url(%23g1)'/%3E%3C/svg%3E">

  <style>
    /* ==========================================
       RESET E VARIABILI ceoDOC
       ========================================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #ff6b00;
      --secondary-color: #1d3557;
      --accent-color: #4299e1;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #f56565;
      --info-color: #38b2ac;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #1e3a8a;
      --text-secondary: #64748b;
      --border-color: #dee2e6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: linear-gradient(135deg, #a8b8e6 0%, #c9a9dd 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* ==========================================
       HEADER PRINCIPALE
       ========================================== */
    .main-header {
      background: var(--card-bg);
      padding: 15px 20px;
      margin: 10px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      border-left: 5px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .main-header:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .header-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 8px;
      text-align: center;
    }

    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .mode-indicator {
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-online {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
    }

    .mode-offline {
      background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
      color: #2e7d32;
    }

    .header-btn {
      padding: 8px 16px;
      border: 2px solid var(--primary-color);
      background: transparent;
      color: var(--primary-color);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }

    .header-btn:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    .help-btn {
      background: var(--info-color);
      color: white;
      border: 2px solid var(--info-color);
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
    }

    /* ==========================================
       IMPORT E ANAGRAFICA MIGLIORATA
       ========================================== */
    .import-anagrafica-section {
      background: var(--card-bg);
      margin: 10px;
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .import-anagrafica-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .import-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }

    .import-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .import-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, #ff8f40 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .import-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 0, 0.3);
    }

    .anagrafica-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .anagrafica-selector label {
      font-weight: bold;
      color: var(--info-color);
    }

    .anagrafica-selector select {
      padding: 10px;
      border: 2px solid var(--info-color);
      border-radius: 8px;
      background: white;
      font-size: 0.9em;
      color: var(--info-color);
    }

    /* Contatore mesi - COME HELP BUTTON */
    .mesi-counter {
      padding: 10px 15px;
      background: var(--info-color);
      color: white;
      border: 2px solid var(--info-color);
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.9em;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.2;
    }

    .anagrafica-grid {
      display: grid;
      grid-template-columns: 1fr 3fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .anagrafica-date-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .anagrafica-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    /* Ogni campo base */
    .anagrafica-field {
      flex: 1 1 15%;
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    /* Fai crescere la denominazione pi√π delle altre */
    .anagrafica-field#denominazioneField {
      flex: 2 1 30%;
    }

    /* Responsive per schermi piccoli */
    @media (max-width: 768px) {
      .anagrafica-row {
        flex-direction: column;
      }
      .anagrafica-field {
        flex: 1 1 100%;
      }
    }

    .anagrafica-field label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9em;
    }

    /* CARD ANAGRAFICA - CONTORNI ARANCIONI FISSI */
    .anagrafica-field input, .anagrafica-field select {
      padding: 10px;
      border: 2px solid var(--primary-color);
      border-radius: 8px;
      font-size: 0.9em;
      transition: border-color 0.3s ease;
      background: white;
      color: var(--text-primary);
    }

    .anagrafica-field input:focus, .anagrafica-field select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
    }

    /* ==========================================
       LAYOUT PRINCIPALE 3 COLONNE - SIDEBAR PI√ô BASSI
       ========================================== */
    .main-layout {
      display: grid;
      grid-template-columns: 250px 1fr 250px;
      gap: 15px;
      margin: 10px;
      min-height: 600px;
      align-items: start;
    }

    .sidebar {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
      height: fit-content;
      transition: all 0.3s ease;
      margin-top: 60px; /* PI√ô BASSI PER CENTRARE CON GRIGLIA */
    }

    .sidebar:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .sidebar h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-btn {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      text-align: left;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--text-primary);
    }

    .sidebar-btn:hover {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      transform: translateX(5px);
    }

    .central-grid {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .central-grid:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* ==========================================
       RATING PROMINENTE CON TACHIMETRO MIGLIORATO - SFONDI PALLIDI
       ========================================== */
    .rating-prominente {
      background: linear-gradient(135deg, #ff9533 0%, #ffb366 100%);
      color: white;
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: left;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
    }

    .rating-prominente:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(255, 149, 51, 0.3);
    }

    .rating-prominente h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .rating-value {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .rating-description {
      font-size: 1.1em;
      opacity: 0.9;
    }

    /* Layout per tachimetro e card integrate - SFONDI PALLIDI */
    .rating-with-cards {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .rating-main-card {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: var(--text-primary);
      padding: 18px;
      border-radius: 12px;
      text-align: left;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      border: 2px solid var(--primary-color);
    }

    .rating-main-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(255, 149, 51, 0.3);
    }

    .rating-card-2 {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      color: var(--text-primary);
      padding: 18px;
      border-radius: 12px;
      text-align: left;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      border: 2px solid #8b5cf6;
    }

    .rating-card-2:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(139, 92, 246, 0.3);
    }

    .rating-card-3 {
      background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
      color: var(--text-primary);
      padding: 18px;
      border-radius: 12px;
      text-align: left;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      border: 2px solid #10b981;
    }

    .rating-card-3:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(16, 185, 129, 0.3);
    }

    .scoring-card {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      border: 2px solid #7b1fa2;
      padding: 18px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .scoring-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .mcc-finale-card {
      background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
      border: 2px solid #388e3c;
      padding: 18px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .mcc-finale-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .card-value {
      font-size: 1.8em;
      font-weight: bold;
      margin: 8px 0;
    }

    .card-description {
      font-size: 1.1em;
      opacity: 0.8;
    }

    /* ==========================================
       GRID FUNZIONI 4x4x4 CON SVG E FLOW
       ========================================== */
    .function-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* üëà CAMBIA DA 5 A 4 COLONNE */
  gap: 15px;
  margin-bottom: 20px;
  /* üëà CENTRATURA PRECISA RISPETTO ALLE 3 CARD RATING */
  width: calc(100% - 60px); /* Considera gap delle card rating */
  margin: 0 auto 20px auto;
  justify-self: center;
}

    .function-btn {
      padding: 20px 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-size: 0.85em;
      line-height: 1.3;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .function-btn svg {
      width: 24px;
      height: 24px;
      margin-bottom: 5px;
    }

    .function-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .function-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .function-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* COLORI LOGICI PULSANTI */
    /* Gruppo RISCHI - Varianti BLU */
    .btn-rischi-1 {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
    }

    .btn-rischi-2 {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
    }

    .btn-rischi-3 {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
    }

    /* Gruppo GARANZIE e SALVA - Varianti VERDE */
    .btn-garanzie {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-salva {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
    }

    /* Gruppo RATING/TABELLA/GRAFICI - Varianti ARANCIONE */
    .btn-rating-1 {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .btn-rating-2 {
      background: linear-gradient(135deg, #ff6b00 0%, #ea580c 100%);
      color: white;
    }

    .btn-rating-3 {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      color: white;
    }

    /* Gruppo BILANCI - Varianti VIOLA */
    .btn-bilanci-1 {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: white;
    }

    .btn-bilanci-2 {
      background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%);
      color: white;
    }

    .btn-bilanci-3 {
      background: linear-gradient(135deg, #d8b4fe 0%, #c084fc 100%);
      color: white;
    }

    .btn-bilanci-4 {
      background: linear-gradient(135deg, #e879f9 0%, #d946ef 100%);
      color: white;
    }

    .btn-disabled {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-disabled:hover {
      transform: none;
      box-shadow: var(--shadow);
    }

    /* ==========================================
       EVENTI PREGIUDIZIEVOLI CON FLOW COMPLETO
       ========================================== */
    .eventi-pregiudizievoli {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border: 2px solid var(--warning-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .eventi-pregiudizievoli::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .eventi-pregiudizievoli:hover::before {
      width: 400px;
      height: 400px;
    }

    .eventi-pregiudizievoli:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .eventi-pregiudizievoli h4 {
      color: var(--warning-color);
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    .eventi-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .evento-item {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    /* FLOW EFFECT per evento-item */
    .evento-item::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .evento-item:hover::before {
      width: 300px;
      height: 300px;
    }

    .evento-item:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .eventi-gestisci-btn {
      padding: 8px 16px;
      border: 2px solid var(--warning-color);
      background: transparent;
      color: var(--warning-color);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9em;
      position: relative;
      overflow: hidden;
    }

    /* FLOW EFFECT per eventi-gestisci-btn */
    .eventi-gestisci-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .eventi-gestisci-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .eventi-gestisci-btn:hover {
      background: var(--warning-color);
      color: white;
      transform: translateY(-2px);
    }

    /* ==========================================
       REPORT MCC FINALE CON FLOW
       ========================================== */
    .report-mcc-finale {
      background: var(--card-bg);
      margin: 10px;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow-lg);
      border-left: 5px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .report-mcc-finale:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .report-mcc-finale h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .mcc-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .mcc-action-btn {
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, #ff8f40 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mcc-action-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .mcc-action-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .mcc-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 0, 0.3);
    }

    /* ==========================================
       TABELLE E VISUALIZZAZIONI + CARD SCONFINI
       ========================================== */
    .tabella-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--info-color);
    }

    .tabella-container h3 {
      color: var(--info-color);
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    /* Card sconfini */
    .card-sconfini {
      background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);
      border: 2px solid var(--danger-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .card-sconfini h4 {
      color: var(--danger-color);
      margin-bottom: 15px;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .card-sconfini .sconfini-numero {
      font-size: 2.5em;
      font-weight: bold;
      color: var(--danger-color);
      margin: 10px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card-sconfini .sconfini-dettagli {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .card-sconfini .sconfini-item {
      background: rgba(255, 255, 255, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .tabella-cr {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    .tabella-cr th {
      background: linear-gradient(135deg, var(--info-color) 0%, #20c997 100%);
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      border: 1px solid #ddd;
    }

    .tabella-cr td {
      padding: 10px 8px;
      border: 1px solid #ddd;
      background: white;
      color: var(--text-primary);
    }

    .tabella-cr tr:nth-child(even) td {
      background: #f8f9fa;
    }

    .utilizzo-eccesso td {
      background: #ffe6e6 !important;
      color: #721c24;
      font-weight: 600;
    }

    .utilizzo-eccesso {
      border-left: 4px solid var(--danger-color) !important;
    }

    .sofferenze td {
      background: #fff3cd !important;
      color: #856404;
      font-style: italic;
    }

    .garanzie td {
      background: #d1ecf1 !important;
      color: #0c5460;
    }

    /* ==========================================
       LAYOUT HORIZONTAL RATING  
       ========================================== */
    .rating-horizontal {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
    }

    .tachimetro-left {
      flex-shrink: 0;
    }

    .rating-info-right {
      flex: 1;
      text-align: left;
    }

    .rating-details {
      font-size: 0.9em;
      opacity: 0.9;
      margin-top: 5px;
    }

    /* ==========================================
       TOAST NOTIFICATIONS
       ========================================== */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 9999;
      animation: slideInRight 0.3s ease-out, fadeOut 4s ease-in forwards;
      box-shadow: var(--shadow-lg);
      max-width: 300px;
      pointer-events: none;
    }

    .toast.success {
      background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, var(--danger-color) 0%, #e53e3e 100%);
    }

    .toast.warning {
      background: linear-gradient(135deg, var(--warning-color) 0%, #dd6b20 100%);
    }

    .toast.info {
      background: linear-gradient(135deg, var(--info-color) 0%, #319795 100%);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      0%, 80% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* ==========================================
       OVERLAY BREAKDOWN STYLES
       ========================================== */
    #breakdownOverlay {
      position: fixed;
      top: 60px;
      right: 50px;
      width: 380px;
      max-width: 97vw;
      background: #fffbe6;
      box-shadow: -4px 0 25px rgba(0,0,0,0.12);
      border-radius: 20px;
      z-index: 99999;
      padding: 18px 22px 18px 18px;
      display: none;
      animation: slideInRight 0.23s;
    }
    
    #breakdownOverlay h3 { 
      margin: 0 0 10px 0; 
      font-size: 1.1em; 
      color: #e55a00;
    }
    
    #breakdownOverlay table { 
      width: 100%; 
      font-size: 0.8em; 
      margin-bottom: 0;
      table-layout: fixed;
    }
    
    #breakdownOverlay th, #breakdownOverlay td { 
      padding: 2px 4px !important; 
      text-align: center;
      white-space: nowrap;
      font-size: 0.9em;
    }
    
    #breakdownOverlay th:nth-child(1), #breakdownOverlay td:nth-child(1) { width: 26%; }
    #breakdownOverlay th:nth-child(2), #breakdownOverlay td:nth-child(2) { width: 26%; }
    #breakdownOverlay th:nth-child(3), #breakdownOverlay td:nth-child(3) { width: 26%; }
    #breakdownOverlay th:nth-child(4), #breakdownOverlay td:nth-child(4) { width: 22%; }
    
    #breakdownOverlay tfoot td { 
      font-weight: bold; 
    }
    
    #breakdownOverlay .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.2em;
      background: none;
      border: none;
      color: #e55a00;
      cursor: pointer;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      z-index: 10;
    }

    #breakdownOverlay .close-btn:hover {
      background: rgba(229, 90, 0, 0.1);
    }
    
    @keyframes slideInRight {
      from { transform: translateX(90px); opacity: 0.5;}
      to   { transform: translateX(0); opacity: 1;}
    }
    
    @media (max-width: 650px) {
      #breakdownOverlay { 
        top: 0; 
        right: 0; 
        left: 0; 
        border-radius: 0; 
        max-width: 100vw;
      }
    }

    /* ==========================================
       GRAFICI MIGLIORATI - 1 COLONNA x 4 RIGHE
       ========================================== */
    .grafici-grid-1x4 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 25px;
      margin-top: 20px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .grafico-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      min-height: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .grafico-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .grafico-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
    }

    .grafico-header h4 {
      color: var(--text-primary);
      margin: 0;
      font-size: 1.3em;
    }

    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
    }

    .chart-container.tachimetro {
      height: 200px;
    }

    /* MODAL DOPPIONI CR */
    .modal-doppioni {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10002;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-doppioni-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
    }

    .modal-doppioni h3 {
      color: var(--warning-color);
      margin-bottom: 20px;
      font-size: 1.4em;
    }

    .modal-doppioni-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .modal-doppioni-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-sovrascrivi {
      background: var(--warning-color);
      color: white;
    }

    .btn-ignora {
      background: var(--text-secondary);
      color: white;
    }

    .modal-doppioni-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* ==========================================
       RESPONSIVE DESIGN
       ========================================== */
    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .function-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .anagrafica-grid {
        grid-template-columns: 1fr 1fr 2fr;
      }

      .import-row {
        grid-template-columns: 1fr;
      }

      .import-controls {
        justify-content: center;
      }

      .rating-with-cards {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .header-controls {
        justify-content: center;
      }

      .grafici-grid-1x4 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .function-grid {
        grid-template-columns: 1fr;
      }

      .function-btn {
        min-height: 60px;
        font-size: 0.8em;
        padding: 15px 10px;
      }
    }

    /* ==========================================
       MODAL GENERICI
       ========================================== */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 1200px;
      width: 95%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-close:hover {
      color: var(--danger-color);
    }

    /* ==========================================
       HIDDEN CLASS
       ========================================== */
    .hidden {
      display: none !important;
    }



/* ==========================================
   CSS GESTIONE PDF MULTIPLI - STILE ceoDOC
   ========================================== */

/* Modal base per PDF multipli */
.modal[id*="PDF"], 
.modal[id*="progress"], 
.modal[id*="risultati"], 
.modal[id*="FIFO"], 
.modal[id*="doppione"] {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease;
}

/* Content dei modal PDF */
.modal[id*="PDF"] .modal-content,
.modal[id*="progress"] .modal-content,
.modal[id*="risultati"] .modal-content,
.modal[id*="FIFO"] .modal-content,
.modal[id*="doppione"] .modal-content {
  background: white;
  border-radius: 15px;
  padding: 25px;
  max-width: 90%;
  max-height: 90%;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  position: relative;
  animation: slideIn 0.3s ease;
  border-top: 4px solid var(--primary-color, #ff6b00);
}

/* Progress Bar Container */
.progress-container {
  background: #f0f0f0;
  border-radius: 10px;
  padding: 3px;
  margin: 20px 0;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Progress Fill con gradiente ceoDOC */
#progress-fill {
  background: linear-gradient(90deg, #ff6b00, #ff8533, #ff9f4a);
  height: 20px;
  border-radius: 8px;
  width: 0%;
  transition: width 0.5s ease-in-out;
  box-shadow: 0 2px 4px rgba(255, 107, 0, 0.3);
  position: relative;
  overflow: hidden;
}

/* Animazione progress bar */
#progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255, 255, 255, 0.3), 
    transparent
  );
  animation: progressShine 2s infinite;
}

@keyframes progressShine {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Testo progress */
#progress-text {
  font-weight: 600;
  color: #333;
  margin-top: 10px;
  font-size: 0.95rem;
}

/* Grid risultati import */
.risultati-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 15px;
  margin: 20px 0;
}

.risultato-card {
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  transition: transform 0.2s ease;
}

.risultato-card:hover {
  transform: translateY(-2px);
}

.risultato-importati {
  background: #d4edda;
  border-left: 4px solid #28a745;
}

.risultato-doppioni {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
}

.risultato-errori {
  background: #f8d7da;
  border-left: 4px solid #dc3545;
}

.risultato-numero {
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 5px;
}

.risultato-label {
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Dettaglio risultati */
.dettaglio-risultati {
  max-height: 200px;
  overflow-y: auto;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  line-height: 1.4;
}

.dettaglio-risultati::-webkit-scrollbar {
  width: 6px;
}

.dettaglio-risultati::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.dettaglio-risultati::-webkit-scrollbar-thumb {
  background: var(--primary-color, #ff6b00);
  border-radius: 3px;
}

/* Bottoni stile ceoDOC */
.btn-fifo {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 600;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 5px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  font-size: 0.95rem;
}

.btn-fifo.primary {
  background: linear-gradient(135deg, #ff6b00, #ff8533);
  color: white;
  box-shadow: 0 3px 6px rgba(255, 107, 0, 0.3);
}

.btn-fifo.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 12px rgba(255, 107, 0, 0.4);
  background: linear-gradient(135deg, #ff8533, #ff6b00);
}

.btn-fifo.secondary {
  background: #6c757d;
  color: white;
  box-shadow: 0 3px 6px rgba(108, 117, 125, 0.3);
}

.btn-fifo.secondary:hover {
  background: #5a6268;
  transform: translateY(-2px);
}

.btn-fifo.info {
  background: #17a2b8;
  color: white;
  box-shadow: 0 3px 6px rgba(23, 162, 184, 0.3);
}

.btn-fifo.info:hover {
  background: #138496;
  transform: translateY(-2px);
}

/* Alert FIFO specifico */
.alert-fifo {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
  border: 2px solid #ff6b00;
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
}

.alert-fifo h3 {
  color: #e65100;
  margin-bottom: 15px;
  font-size: 1.3rem;
}

.mesi-eliminare {
  background: rgba(255, 107, 0, 0.1);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  border-left: 4px solid #ff6b00;
}

.mesi-eliminare strong {
  color: #e65100;
}

/* Doppioni avanzati */
.modal-doppione-avanzato {
  min-width: 400px;
}

.doppione-info {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin: 20px 0;
  border-left: 4px solid #ffc107;
}

.doppione-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 20px;
}

/* Responsive per mobile */
@media (max-width: 768px) {
  .modal[id*="PDF"] .modal-content,
  .modal[id*="progress"] .modal-content,
  .modal[id*="risultati"] .modal-content,
  .modal[id*="FIFO"] .modal-content,
  .modal[id*="doppione"] .modal-content {
    margin: 10px;
    padding: 20px;
    max-width: calc(100% - 20px);
  }

  .risultati-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .doppione-actions {
    flex-direction: column;
  }

  .btn-fifo {
    width: 100%;
    justify-content: center;
  }
}

/* Animazioni */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(-20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

/* Toast notifications per PDF multipli */
.toast.pdf-multipli {
  border-left: 4px solid #ff6b00;
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
}

.toast.pdf-multipli .toast-title {
  color: #e65100;
  font-weight: 600;
}

/* Icone per stati */
.stato-importato::before { content: '‚úÖ'; margin-right: 5px; }
.stato-doppione::before { content: '‚ö†Ô∏è'; margin-right: 5px; }
.stato-errore::before { content: '‚ùå'; margin-right: 5px; }
.stato-ignorato::before { content: '‚è≠Ô∏è'; margin-right: 5px; }

/* Highlight per file in elaborazione */
.file-in-elaborazione {
  background: linear-gradient(90deg, #fff3e0, #ffe0b2, #fff3e0);
  background-size: 200% 100%;
  animation: fileProcessing 2s infinite;
  padding: 5px 10px;
  border-radius: 5px;
  margin: 2px 0;
}

@keyframes fileProcessing {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Focus states per accessibilit√† */
.btn-fifo:focus {
  outline: 3px solid rgba(255, 107, 0, 0.5);
  outline-offset: 2px;
}

/* Stato disabled */
.btn-fifo:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}

.btn-fifo:disabled:hover {
  transform: none !important;
  box-shadow: none !important;
}

/* Contatori visuali */
.contatore-pdf {
  display: inline-block;
  background: var(--primary-color, #ff6b00);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  margin-left: 5px;
}

/* Loading spinner per operazioni lunghe */
.spinner-pdf {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--primary-color, #ff6b00);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


  </style>

</head>

<body>
  <!-- Header Principale -->
  <div class="main-header">
    <div class="header-title" style="text-align: left; display: flex; align-items: center; gap: 15px;">
      <svg width="70" height="70" viewBox="0 0 24 24" fill="none">
        <!-- Dashboard panels -->
        <rect x="3" y="3" width="7" height="5" fill="#1e40af" opacity="0.2" rx="1"/>
        <rect x="11" y="3" width="7" height="5" fill="#2563eb" opacity="0.2" rx="1"/>
        <rect x="3" y="9" width="7" height="5" fill="#1e40af" opacity="0.2" rx="1"/>
        <rect x="11" y="9" width="7" height="5" fill="#2563eb" opacity="0.2" rx="1"/>
        <rect x="3" y="15" width="7" height="5" fill="#1e40af" opacity="0.2" rx="1"/>
        <rect x="11" y="15" width="7" height="5" fill="#2563eb" opacity="0.2" rx="1"/>
        
        <!-- Mini grafici nei pannelli -->
        <path d="M4 6 L5 5 L6 6 L7 4" stroke="#3b82f6" stroke-width="0.5" fill="none" opacity="0.8"/>
        <rect x="12" y="4" width="1" height="3" fill="#3b82f6" opacity="0.8"/>
        <rect x="14" y="5" width="1" height="2" fill="#3b82f6" opacity="0.8"/>
        <rect x="16" y="4.5" width="1" height="2.5" fill="#3b82f6" opacity="0.8"/>
        
        <!-- Lente di ingrandimento sopra il dashboard -->
        <circle cx="10" cy="10" r="4" fill="white" stroke="#1e40af" stroke-width="2"/>
        <path d="M13 13 L16.5 16.5" stroke="#1e40af" stroke-width="2" stroke-linecap="round"/>
        
        <!-- Dettaglio ingrandito dentro la lente -->
        <rect x="8" y="8" width="4" height="0.5" fill="#1d4ed8" opacity="0.9"/>
        <rect x="8" y="9" width="3" height="0.5" fill="#1d4ed8" opacity="0.9"/>
        <rect x="8" y="10" width="3.5" height="0.5" fill="#1d4ed8" opacity="0.9"/>
        
        <!-- Riflesso lente -->
        <path d="M8 8 Q9 7 10 8" stroke="#60a5fa" stroke-width="0.5" fill="none" opacity="0.7"/>
      </svg>      <strong>
        <span style="color: #1e40af">Analisi Integrata</span><br>
        <span style="color: #ff6b00">CR + Bilanci Consuntivi + Score MCC</span>
      </strong>
    </div>
    <div class="header-controls">
      <div id="modeIndicator" class="mode-indicator">Inizializzazione...</div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button class="header-btn" onclick="mostraSceltaModalita()">Scegli Connessione: <span id="modalitaCorrente">Online</span></button>
        <button class="header-btn" onclick="esportaBackup()">Backup</button>
        <button class="header-btn" onclick="importaBackup()">Restore</button>
        <button class="header-btn" onclick="mostraAssistente()">Assistente</button>
        <button class="help-btn" onclick="mostraHelp()">?</button>
      </div>
    </div>
  </div>
  <!-- Sezione Anagrafica: Selezione + Creazione -->
  <div class="import-anagrafica-section">
    <div class="import-row">
      <!-- Colonna sinistra: Scelta Natura + Settore -->
      <div class="import-controls">
        <label for="naturaGiuridicaScelta" style="font-weight: bold; color: var(--warning-color);">Natura Giuridica:</label>
        <select id="naturaGiuridicaScelta" style="padding: 8px; border: 2px solid var(--warning-color); border-radius: 6px;color: var(--text-primary)">
          <option value="">-- Seleziona --</option>
          <option value="SC">SC</option>
          <option value="SP">SP</option>
          <option value="DI">DI</option>
        </select>

        <label for="settoreScelto" style="font-weight: bold; color: var(--warning-color); margin-left: 10px;">Settore:</label>
        <select id="settoreScelto" style="padding: 8px; border: 2px solid var(--warning-color); border-radius: 6px;color: var(--text-primary)">
          <option value="">-- Seleziona --</option>
          <option value="COMMERCIO">COMMERCIO</option>
          <option value="SERVIZI">SERVIZI</option>
          <option value="INDUSTRIA">INDUSTRIA</option>
          <option value="EDILIZIA">EDILIZIA</option>
          <option value="AGRICOLTURA">AGRICOLTURA</option>
          <option value="ALTRO">ALTRO</option>
        </select>

        <button class="import-btn" onclick="nuovaAnagrafica()">‚ûï Nuova Anagrafica</button>
        <button class="import-btn" onclick="salvaAnagrafica()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">üíæ Salva</button>
      </div>

      <!-- Colonna centrale: Dropdown anagrafiche -->
      <div class="anagrafica-selector" style="display: flex; flex-direction: column; gap: 6px;">
        <label for="selectAzienda"><strong>Seleziona Anagrafica:</strong></label>
       <select id="selectAzienda" onchange="dropdown()">
          <option value="">-- Seleziona Azienda --</option>
        </select>
        <button onclick="eliminaAziendaSelezionata()" class="btn btn-danger">üóëÔ∏è Elimina anagrafica selezionata</button>
      </div>

      <!-- Colonna destra: Contatore mesi -->
      <div class="mesi-counter" id="mesiCounter">
        Mesi<br>0
      </div>
    </div>

    <!-- Griglia riepilogo anagrafica selezionata -->
    <div class="anagrafica-row" style="margin-top: 20px;">
      <div class="anagrafica-field">
        <label for="anagraficaCF">Codice Fiscale</label>
        <input type="text" id="anagraficaCF" readonly>
      </div>

      <div class="anagrafica-field">
        <label for="anagraficaSede">Sede</label>
        <input type="text" id="anagraficaSede" readonly>
      </div>

      <div class="anagrafica-field">
        <label for="naturaGiuridica">Natura Giuridica</label>
        <select id="naturaGiuridica" disabled>
          <option value="">-- Seleziona --</option>
          <option value="SC">Societ√† di Capitali</option>
          <option value="SP">Societ√† di Persone</option>
          <option value="DI">Ditta Individuale</option>
        </select>
      </div>

      <div class="anagrafica-field">
        <label for="settore">Settore</label>
        <select id="settore" disabled>
          <option value="">-- Seleziona --</option>
          <option value="COMMERCIO">Commercio</option>
          <option value="SERVIZI">Servizi</option>
          <option value="INDUSTRIA">Industria</option>
          <option value="EDILIZIA">Edilizia</option>
          <option value="AGRICOLTURA">Agricoltura</option>
          <option value="ALTRO">Altro</option>
        </select>
      </div>

    <div class="anagrafica-field" style="flex: 1 1 100px; max-width: 140px;">
  <label for="dataInserimento">Data Inserimento</label>
  <input type="text" id="dataInserimento" readonly style="border: 2px solid var(--info-color); border-radius: 6px;">
</div>

     <div class="anagrafica-field" id="denominazioneField" style="flex: 2 1 30%;">
  <label for="anagraficaDenominazione">Denominazione</label>
  <input type="text" id="anagraficaDenominazione" readonly>
</div>

    </div>
  </div>

  <!-- Layout Principale 3 Colonne -->
  <div class="main-layout">
    <!-- Sidebar Sinistra: Report Andamentale -->
    <div class="sidebar">
      <h3> Report Andamentale</h3>
      <button class="sidebar-btn" onclick="importaCR()">üì• Importa CR</button>
      <button class="sidebar-btn" onclick="visualizzaDateInserite()">üìÖ Visualizza Date Inserite</button>

      <button class="sidebar-btn" onclick="visualizzaAnalisiCRPeriodo()">üîé Visualizza Analisi di periodo</button>

      <button class="sidebar-btn" onclick="cancellaCRPeriodo()">üóëÔ∏è Cancella CR di periodo</button>
      <button class="sidebar-btn" onclick="linkBI()">üîó Link Banca d'Italia</button>
    </div>

    <!-- Grid Centrale -->
    <div class="central-grid">
      <!-- Rating Prominente con Cards Integrate - 3 CARD IDENTICHE CON SFONDI PALLIDI -->
      <div class="rating-with-cards">
        <div class="rating-main-card">
          <h3 id="ratingTitle1">RATING ANDAMENTALE ULTIMO MESE</h3>
          <div class="rating-horizontal">
            <div class="tachimetro-left">
              <canvas id="tachimetroProminente1" width="160" height="100"></canvas>
            </div>
            <div class="rating-info-right">
              <div class="rating-value" id="ratingValue1">--</div>
              <div class="rating-description" id="ratingDescription1">Nessun dato disponibile</div>
            </div>
          </div>
        </div>

        <div class="rating-card-2">
          <h3 id="ratingTitle2">RATING ANDAMENTALE MEDIA 6 MESI</h3>
          <div class="rating-horizontal">
            <div class="tachimetro-left">
              <canvas id="tachimetroProminente2" width="160" height="100"></canvas>
            </div>
            <div class="rating-info-right">
              <div class="rating-value" id="ratingValue2">--</div>
              <div class="rating-description" id="ratingDescription2">Nessun dato disponibile</div>
            </div>
          </div>
        </div>

        <div class="rating-card-3">
          <h3 id="ratingTitle3">RATING ANDAMENTALE MEDIA 12 MESI</h3>
          <div class="rating-horizontal">
            <div class="tachimetro-left">
              <canvas id="tachimetroProminente3" width="160" height="100"></canvas>
            </div>
            <div class="rating-info-right">
              <div class="rating-value" id="ratingValue3">--</div>
              <div class="rating-description" id="ratingDescription3">Nessun dato disponibile</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRIMA RIGA - 5 COLONNE: Rischi + Analisi Base -->
      <div class="function-grid">
        <button class="function-btn btn-rischi-1" onclick="visualizzaRischiRevoca()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          RISCHI A REVOCA
        </button>
        <button class="function-btn btn-rischi-2" onclick="visualizzaRischiAutoliquidanti()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          RISCHI AUTOLIQUIDANTI
        </button>
        <button class="function-btn btn-rischi-3" onclick="visualizzaRischiScadenza()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
            <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
          </svg>
          RISCHI A SCADENZA
        </button>
        <button class="function-btn btn-garanzie" onclick="visualizzaAltreInformazioni()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
          </svg>
          ALTRE INFORMAZIONI
        </button>
      </div>

      <!-- Seconda Riga: Analisi - COLORI ARANCIONE CON SVG -->
      <div class="function-grid">
        <button class="function-btn btn-rating-1" onclick="visualizzaRatingMensili()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 11H7v9h2v-9zm4-4h-2v13h2V7zm4-4h-2v17h2V3z"/>
          </svg>
          RATING MENSILI
        </button>
        <button class="function-btn btn-rating-2" onclick="visualizzaTabellaUtilizzi()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
          </svg>
          SCONFINI
        </button>
        <button class="function-btn btn-rating-3" onclick="visualizzaGraficiAndamentali()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/>
          </svg>
          GRAFICI ANDAMENTALI
        </button>
        <button class="function-btn btn-salva" onclick="gestisciEventiPregiudizievoli()">
          <svg fill="currentColor" viewBox="0 0 24 24">
  <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
</svg>
         EVENTI PREGIUDIZIEVOLI
        </button>
      </div>

      <!-- Terza Riga: Bilanci - COLORI VIOLA CON SVG -->
      <div class="function-grid">
        <button class="function-btn btn-bilanci-1" onclick="showMessage('Import Bilanci', 'Funzionalit√† Import Bilanci in sviluppo')">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
          </svg>
          BILANCI CONSUNTIVI
        </button>
        <button class="function-btn btn-bilanci-2" onclick="showMessage('KPI & Grafici', 'Funzionalit√† KPI & Grafici in sviluppo')">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          KPI & GRAFICI
        </button>
        <button class="function-btn btn-bilanci-3" onclick="showMessage('Score MCC', 'Funzionalit√† Score MCC in sviluppo')">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/>
          </svg>
          SCORE MCC & GRAFICI
        </button>
        <button class="function-btn btn-bilanci-4" onclick="gestisciReportMCC()">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
          </svg>
          REPORT FINALE MCC
        </button>

    </div>

       </div>

    <!-- Sidebar Destra: Report Scoring -->
    <div class="sidebar">
      <h3>Report Scoring</h3>
      <button class="sidebar-btn" onclick="importaBilanci()"> üì•Import Bilanci</button>
      <button class="sidebar-btn" onclick="aggiungiPeriodoConsuntivo()">‚ûï Aggiungi Bilancio Consuntivo</button>

      <button class="sidebar-btn" onclick="visualizzaAnalisiEF()">üîé Visualizza Analisi Bilanci</button>

      <button class="sidebar-btn" onclick="cancellaPeriodoEF()">üóëÔ∏èCancella Periodo Bilanci</button>
      <button class="sidebar-btn" onclick="linkCCIAA()"> üîóLink CCIAA</button>
    </div>
  </div>



  <!-- Modal Help -->
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="chiudiModal('helpModal')">&times;</button>
      <div id="helpContent"></div>
    </div>
  </div>

  <!-- Modal Assistente -->
  <div id="assistenteModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="chiudiModal('assistenteModal')">&times;</button>
      <div id="assistenteContent"></div>
    </div>
  </div>

  <!-- Modal Visualizzazioni -->
  <div id="visualizzazioneModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="chiudiModal('visualizzazioneModal')">&times;</button>
      <div id="visualizzazioneContent"></div>
    </div>
  </div>

  <!-- Modal Doppioni CR -->
  <div id="modalDoppioni" class="modal-doppioni">
    <div class="modal-doppioni-content">
      <h3>‚ö†Ô∏è ATTENZIONE</h3>
      <p id="messaggioDoppione"></p>
      <div class="modal-doppioni-buttons">
        <button id="btnSovrascrivi" class="modal-doppioni-btn btn-sovrascrivi">‚úîÔ∏è Sovrascrivi</button>
        <button id="btnIgnora" class="modal-doppioni-btn btn-ignora">‚ùå Ignora</button>
      </div>
    </div>
  </div>

  <!-- Input File Nascosto -->
  <input type="file" id="anagraficaFileInput" accept=".pdf" style="display: none;" onchange="handleAnagraficaImport(event)">
  <input type="file" id="crFileInput" accept=".pdf" multiple style="display: none;" onchange="handleCRImport(event)">
  <input type="file" id="backupInput" accept=".json" style="display: none;" onchange="handleBackupImport(event)">

  <!-- Overlay Breakdown Laterale -->
  <div id="breakdownOverlay"></div>

  <!-- JavaScript COMPLETO AGGIORNATO v1.4 FINALE -->
  <script>
if (!window.parent || window.parent === window) {
    document.body.innerHTML = '<div style="padding:50px;text-align:center"><h1>Accesso negato</h1><p>Questo modulo richiede ceoDOC.it</p></div>';
    throw new Error('Modulo richiede ceoDOC');
  }
    // ==========================================
    // VARIABILI GLOBALI
    // ==========================================
    let modalitaCorrente = 'online';
    let archivioAziende = {};
    let aziendaCorrente = null;
    let contatori = {
      pdfImportati: 0,
      analisiGenerate: 0,
      backupCreati: 0
    };

    // Variabili per gestione doppioni CR
    let pendingCRData = null;
    let pendingResolve = null;

    // Variabile globale per breakdown crediti
    let _creditiRawBreakdown = {};

 // ==========================================
// COEFFICIENTI MCC CORRETTI (da sostituire in anacrisk.html)
// ==========================================
const coefficientiMCC = {
  SC: { // Societ√† di Capitali - ‚úÖ TUTTI CORRETTI  
    C1_COEFF: 3.179026,
    DC1_COEFF: -1.066972,
    DC3_COEFF: 0.720867,
    C2_COEFF: 0.0326226,
    COSTANTE: -4.984468,
    FATTORE_CORR_1: 0.0518888,
    FATTORE_CORR_2: 0.0502134
  },
  SP: { // Societ√† di Persone - üîß CORRETTI
    C1_COEFF: 2.205599,
    DC1_COEFF: -0.5394119,      // Era: -0.539419 ‚ùå
    DC3_COEFF: 0.8980523,       // Era: 0.898033 ‚ùå
    C2_COEFF: 0.1121999,        // Era: 0.112199 ‚ùå  
    COSTANTE: -4.759176,
    FATTORE_CORR_1: 0.0541028,  // Era: 0.041028 ‚ùå ERRORE IMPORTANTE!
    FATTORE_CORR_2: 0.04577744  // Era: 0.045744 ‚ùå
  },
  DI: { // Ditta Individuale - üîß CORRETTI
    C1_COEFF: 1.060481,
    DC1_COEFF: -0.181663,
    DC3_COEFF: 0.9357013,       // Era: 0.935013 ‚ùå
    C2_COEFF: 0.2115435,        // Era: 0.211435 ‚ùå
    COSTANTE: -4.010012,
    FATTORE_CORR_1: 0.046722,
    FATTORE_CORR_2: 0.0494868   // Era: 0.049868 ‚ùå
  }
};


    // ==========================================
    // CLASSI RATING MCC
    // ==========================================
    const classiMCC = [
      { classe: "CR1", min: -10, max: -4.706674576, descr: "Sicurezza", emoji: "üòÄ" },
      { classe: "CR2", min: -4.706674576, max: -4.433824062, descr: "Solvibilit√†", emoji: "üòé" },
      { classe: "CR3", min: -4.433824062, max: -4.254777908, descr: "Solvibilit√†", emoji: "üòâ" },
      { classe: "CR4", min: -4.254777908, max: -3.888909817, descr: "Solvibilit√†", emoji: "üôÇ" },
      { classe: "CR5", min: -3.888909817, max: -3.467784882, descr: "Vulnerabilit√†", emoji: "üò∂" },
      { classe: "CR6", min: -3.467784882, max: -3.213093996, descr: "Vulnerabilit√†", emoji: "üòê" },
      { classe: "CR7", min: -3.213093996, max: -2.884413958, descr: "Vulnerabilit√†", emoji: "üôÑ" },
      { classe: "CR8", min: -2.884413958, max: -2.619804621, descr: "Pericolosit√†", emoji: "üôÅ" },
      { classe: "CR9", min: -2.619804621, max: -2.198198080, descr: "Pericolosit√†", emoji: "üòü" },
      { classe: "CR10", min: -2.198198080, max: -1.532480597, descr: "Pericolosit√†", emoji: "üò£" },
      { classe: "CR11", min: -1.532480597, max: 999999, descr: "Rischiosit√†", emoji: "üò´" }
    ];

    // ==========================================
    // INIZIALIZZAZIONE SISTEMA
    // ==========================================
    function aggiornaIndicatoreModalita() {
      const indicator = document.getElementById('modeIndicator');
      const modalitaSpan = document.getElementById('modalitaCorrente');

      if (modalitaCorrente === 'online') {
        indicator.className = 'mode-indicator mode-online';
        indicator.innerHTML = 'Online';
        if (modalitaSpan) modalitaSpan.textContent = 'Online';
      } else {
        indicator.className = 'mode-indicator mode-offline';
        indicator.innerHTML = 'Offline';
        if (modalitaSpan) modalitaSpan.textContent = 'Offline';
      }
    }

    function caricaDatiSalvati() {
      try {
        const archivioSalvato = localStorage.getItem('ceoDOC_CR_archivio');
        if (archivioSalvato) {
          archivioAziende = JSON.parse(archivioSalvato);
        }

        const aziendaSalvata = localStorage.getItem('ceoDOC_CR_aziendaCorrente');
        if (aziendaSalvata) {
          // NON caricare l'ultima azienda - sempre partire con "Seleziona azienda"
          // aziendaCorrente = aziendaSalvata;
        }

        const modalitaSalvata = localStorage.getItem('ceoDOC_CR_modalita');
        modalitaCorrente = modalitaSalvata || 'online';
        aggiornaIndicatoreModalita();

        const contatoriSalvati = localStorage.getItem('ceoDOC_CR_contatori');
        if (contatoriSalvati) {
          contatori = JSON.parse(contatoriSalvati);
        }

      } catch (error) {
        console.warn('‚ö†Ô∏è Errore caricamento dati salvati:', error);
        modalitaCorrente = 'online';
        aggiornaIndicatoreModalita();
      }
    }

    function caricaLibrerieOffline() {
      console.log('üìÅ Caricamento librerie offline da ../libs/cr/...');

      caricaLibreriaLocale('chart');

      setTimeout(() => {
        caricaLibreriaLocale('pdfjs');
      }, 200);

      setTimeout(() => {
        caricaLibreriaLocale('jspdf');
      }, 400);

      setTimeout(() => {
        caricaLibreriaLocale('html2pdf');
      }, 600);

      setTimeout(() => {
        caricaLibreriaLocale('xlsx');
      }, 800);

      setTimeout(() => {
        showToast('‚úÖ Librerie offline caricate', 'success');
      }, 1000);
    }

    function scegliModalita(modalita) {
      const vecchiaModalita = modalitaCorrente;
      modalitaCorrente = modalita;

      aggiornaIndicatoreModalita();
      salvaDatiLocali();

      if (modalita === 'online') {
        caricaLibrerieOnline();
      } else {
        caricaLibrerieOffline();
      }

      showToast(`Modalit√† ${modalita.toUpperCase()} attivata${vecchiaModalita !== modalita ? ' (da ' + vecchiaModalita + ')' : ''}`, 'success');
    }

    function mostraSceltaModalita() {
      const scelta = confirm(`CAMBIA MODALIT√Ä

Modalit√† corrente: ${modalitaCorrente.toUpperCase()}

Online = Librerie da Internet
Offline = Librerie locali dal PC

Vuoi cambiare modalit√†?`);

      if (scelta) {
        const nuova = modalitaCorrente === 'online' ? 'offline' : 'online';
        scegliModalita(nuova);
      }
    }


    function caricaLibrerieOnline() {
    console.log('üåê Caricamento librerie online con sistema unificato...');

    // Usa il nostro sistema unificato che fa: Export ‚Üí Backup ‚Üí CDN
    // Questo elimina conflitti e gestisce tutto automaticamente

    const librerieDaCaricare = [
        'chart',    // Chart.js
        'pdfjs',    // PDF.js
        'jspdf',    // jsPDF
        'xlsx',     // XLSX
        'html2pdf'  // html2pdf
    ];

    // Carica tutte le librerie in sequenza
    librerieDaCaricare.forEach((nome, index) => {
        // Piccolo delay tra i caricamenti per evitare sovraccarico
        setTimeout(() => {
            console.log(`üöÄ Avvio caricamento ${nome}...`);
            caricaLibreriaLocale(nome, true);
        }, index * 200);
    });

    console.log('üéØ Sistema unificato avviato - prova prima locali, poi CDN se necessario');
}



    function testLibrerie() {
      const risultati = {
        pdfjsLib: typeof pdfjsLib !== 'undefined',
        Chart: typeof Chart !== 'undefined',
        jsPDF: typeof jsPDF === 'function',
        XLSX: typeof XLSX !== 'undefined',
        html2pdf: typeof html2pdf !== 'undefined'
      };

      console.log('üìä Test librerie:', risultati);

      const disponibili = Object.values(risultati).filter(Boolean).length;
      const totali = Object.keys(risultati).length;

      showToast(`Librerie caricate: ${disponibili}/${totali}`, disponibili === totali ? 'success' : 'warning');
    }

    function showToast(message, type = 'info') {
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());

      const toast = document.createElement('div');
      toast.className = `toast ${type || 'info'}`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast && toast.parentNode) {
          toast.remove();
        }
      }, 4000);
    }

    let intervalloConnessione;

    function avviaControlloConnessione() {
      intervalloConnessione = setInterval(() => {
        if (!navigator.onLine && modalitaCorrente === 'online') {
          clearInterval(intervalloConnessione);

          const scelta = confirm(`CONNESSIONE INTERNET PERSA

Stai usando la modalit√† Online ma la connessione si √® interrotta.

Online: Richiede connessione per librerie CDN
Offline: Usa librerie locali (pi√π stabile)

Vuoi passare alla modalit√† Offline?`);

          if (scelta) {
            scegliModalita('offline');
          } else {
            showToast('Modalit√† Online mantenuta - Alcune funzioni potrebbero non funzionare', 'warning');
          }

          setTimeout(avviaControlloConnessione, 60000);
        }
      }, 30000);
    }

    function salvaDatiLocali() {
      try {
        localStorage.setItem('ceoDOC_CR_archivio', JSON.stringify(archivioAziende));
        localStorage.setItem('ceoDOC_CR_aziendaCorrente', aziendaCorrente || '');
        localStorage.setItem('ceoDOC_CR_modalita', modalitaCorrente);
        localStorage.setItem('ceoDOC_CR_contatori', JSON.stringify(contatori));
      } catch (error) {
        console.warn('‚ö†Ô∏è Errore salvataggio localStorage:', error);
      }
    }

    // ==========================================
    // INIZIALIZZAZIONE DOCUMENTO
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ ceoDOC Centrale Rischi - Inizializzazione v1.4 FINALE...');

      modalitaCorrente = 'online';
      aggiornaIndicatoreModalita();
      caricaDatiSalvati();
      caricaLibrerieOnline();
      aggiornaInterfaccia();
      avviaControlloConnessione();

      setTimeout(() => {
        testLibrerie();
      }, 2000);

      console.log('‚úÖ Inizializzazione completata - Modalit√† Online attiva');
      showToast('‚úÖ ceoDOC v1.4 FINALE avviato correttamente', 'success');
    });

// ==========================================
// GESTIONE INTERFACCIA
// ==========================================
function dropdown() {
  const selectedCF = document.getElementById('selectAzienda').value;

  if (!selectedCF || !archivioAziende[selectedCF]) {
    aziendaCorrente = null;

    // Reset visualizzazione inferiore
    document.getElementById('anagraficaCF').value = '';
    document.getElementById('anagraficaDenominazione').value = '';
    document.getElementById('anagraficaSede').value = '';
    document.getElementById('naturaGiuridica').value = '';
    document.getElementById('settore').value = '';
    document.getElementById('dataInserimento').value = '';

    // Reset tendine superiori
    document.getElementById('naturaGiuridicaScelta').value = '';
    document.getElementById('settoreScelto').value = '';

    // Reset contatore mesi
    document.getElementById('mesiCounter').innerHTML = 'Mesi<br>0';

    aggiornaInterfaccia();
    return;
  }

  // Selezione valida
  // CORREZIONE: Reset completo prima di caricare nuova azienda
  console.log('üîÑ Reset completo prima di caricare nuova azienda');

  // Reset dropdown superiori prima di caricare nuovi dati
  document.getElementById('naturaGiuridicaScelta').value = '';
  document.getElementById('settoreScelto').value = '';

  aziendaCorrente = selectedCF;
  aggiornaInterfaccia();
}

function aggiornaContatoreMesi() {
  const counter = document.getElementById('mesiCounter');
  if (!counter) return;

  if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
    counter.innerHTML = 'Mesi<br>0';
    return;
  }

  const numeroMesi = Object.keys(archivioAziende[aziendaCorrente].mesi || {}).length;
  counter.innerHTML = `Mesi<br>${numeroMesi}`;
}

function aggiornaInterfaccia() {
  console.log('üîÑ Aggiornamento interfaccia...');
  try {
    if (typeof aggiornaDropdownAziende === 'function') aggiornaDropdownAziende();
    if (typeof aggiornaContatoreMesi === 'function') aggiornaContatoreMesi();
    if (typeof aggiornaAnagraficaCorrente === 'function') aggiornaAnagraficaCorrente();
    if (typeof ricaricaAltreInformazioniDaStorage === 'function') ricaricaAltreInformazioniDaStorage();
    if (typeof aggiornaRatingProminente === 'function') aggiornaRatingProminente();
    if (typeof aggiornaStatusMCC === 'function') aggiornaStatusMCC();
    if (typeof aggiornaGrafici === 'function') aggiornaGrafici();
    if (typeof aggiornaContatori === 'function') aggiornaContatori();
    if (typeof aggiornaInterfacciaDopoImport === 'function') aggiornaInterfacciaDopoImport();
    console.log('‚úÖ Interfaccia aggiornata con successo');
  } catch (error) {
    console.error('‚ùå Errore aggiornamento interfaccia:', error);
    showToast('‚ö†Ô∏è Errore aggiornamento interfaccia', 'warning');
  }
}

function aggiornaDropdownAziende() {
  const select = document.getElementById('selectAzienda');
  if (!select) return;

  select.innerHTML = '<option value="">-- Seleziona Azienda --</option>';

  Object.keys(archivioAziende).forEach(cf => {
    const azienda = archivioAziende[cf];
    const denominazione = azienda.anagrafica?.denominazione || 'Denominazione non disponibile';
    const option = document.createElement('option');
    option.value = cf;
    option.textContent = `${cf} - ${denominazione}`;
    if (cf === aziendaCorrente) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

function aggiornaAnagraficaCorrente() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  document.getElementById('anagraficaCF').value = azienda.anagrafica?.cf || '';
  document.getElementById('anagraficaDenominazione').value = azienda.anagrafica?.denominazione || '';
  document.getElementById('anagraficaSede').value = azienda.anagrafica?.sedeLegale || '';

  // Natura Giuridica e Settore: visualizzazione nei campi fissi della card
  const natura = azienda.naturaGiuridica || azienda.anagrafica?.naturaGiuridica || '';
  const settore = azienda.anagrafica?.settore || '';
  document.getElementById('naturaGiuridica').value = natura;
  document.getElementById('settore').value = settore;

  // Data Inserimento
  const data = azienda.anagrafica?.dataInserimento || '';
  document.getElementById('dataInserimento').value = data;

  // Date richieste (da CR)
  const dateList = azienda.dateRichieste;
  const dateField = document.getElementById('anagraficaDate');
  if (dateField) {
    const dateStr = Array.isArray(dateList) && dateList.length > 0
      ? `Da ${dateList[0]} A ${dateList[dateList.length - 1]}`
      : 'Da estrarre con Importa CR';
    dateField.value = dateStr;
  }
}

// ==========================================
// GESTIONE ANAGRAFICA
// ==========================================
function nuovaAnagrafica() {
  console.log('üîÑ Funzione nuovaAnagrafica() chiamata - CORRETTA');
  // CORREZIONE: Leggere dai dropdown di selezione, NON aprire direttamente il file
  const naturaGiuridicaSelect = document.getElementById('naturaGiuridicaScelta').value;
  const settoreSelect = document.getElementById('settoreScelto').value;
  console.log('Natura Giuridica selezionata:', naturaGiuridicaSelect);
  console.log('Settore selezionato:', settoreSelect);

  if (!naturaGiuridicaSelect || !settoreSelect) {
    showToast('‚ùå ERRORE: Seleziona prima Natura Giuridica e Settore dai menu a tendina!', 'error');
    return;
  }

  document.getElementById('anagraficaFileInput').click();
}

function handleAnagraficaImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!window.pdfjsLib) {
    showToast('PDF.js non disponibile - Cambia modalit√† o carica librerie', 'error');
    return;
  }

  showToast('Elaborazione anagrafica in corso...', 'info');

  const reader = new FileReader();
  reader.onload = async function() {
    try {
      const typedarray = new Uint8Array(reader.result);
      const pdf = await window.pdfjsLib.getDocument({ data: typedarray }).promise;

      let text = "";
      for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        text += textContent.items.map(item => item.str).join(" ") + "\n";
      }

      const anagrafica = estraiAnagrafica(text);

      if (!anagrafica.codiceFiscale) {
        throw new Error('Codice fiscale non trovato nel PDF');
      }

      // Verifica conflitti
      if (archivioAziende[anagrafica.codiceFiscale]) {
        const conferma = confirm(`L'azienda con CF ${anagrafica.codiceFiscale} esiste gi√†.\n\nVuoi sovrascrivere i dati anagrafici?`);
        if (!conferma) {
          showToast('Importazione annullata', 'info');
          return;
        }
      }

      // Salva anagrafica
      if (!archivioAziende[anagrafica.codiceFiscale]) {
        archivioAziende[anagrafica.codiceFiscale] = { mesi: {} };
      }

      archivioAziende[anagrafica.codiceFiscale].anagrafica = {
        cf: anagrafica.codiceFiscale,
        denominazione: anagrafica.denominazione,
        sedeLegale: anagrafica.sedeLegale,
        cciaa: anagrafica.cciaa,
        dataInserimento: new Date().toLocaleDateString('it-IT')
      };

      aziendaCorrente = anagrafica.codiceFiscale;
      salvaDatiLocali && salvaDatiLocali();
      aggiornaInterfaccia && aggiornaInterfaccia();

      showToast(`‚úÖ Anagrafica importata: ${anagrafica.denominazione}`, 'success');
      notificaAnagraficaImportata && notificaAnagraficaImportata();
    } catch (error) {
      console.error('Errore elaborazione anagrafica:', error);
      showToast(`‚ùå Errore: ${error.message}`, 'error');
    }
  };

  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function salvaAnagrafica() {
  const cf = document.getElementById('anagraficaCF').value.trim();
  if (!cf) {
    showToast("‚ö†Ô∏è Codice Fiscale mancante", "warning");
    return;
  }

  const denominazione = document.getElementById('anagraficaDenominazione').value.trim();
  const sede = document.getElementById('anagraficaSede').value.trim();
  const naturaGiuridica = document.getElementById('naturaGiuridicaScelta')?.value;
  const settore = document.getElementById('settoreScelto')?.value;

  const dataInserimento = document.getElementById('dataInserimento')?.value || '';

  if (!naturaGiuridica || !settore) {
    alert("‚ö†Ô∏è Inserisci Natura Giuridica e Settore prima di salvare.");
    return;
  }

  archivioAziende[cf] = archivioAziende[cf] || {};
  archivioAziende[cf].anagrafica = {
    cf,
    denominazione,
    sedeLegale: sede,
    naturaGiuridica,
    settore,
    dataInserimento
  };
  archivioAziende[cf].naturaGiuridica = naturaGiuridica;

  aziendaCorrente = cf;
  salvaDatiLocali && salvaDatiLocali();
  aggiornaDropdownAziende && aggiornaDropdownAziende();
  salvaAnagraficaCompleta && salvaAnagraficaCompleta(cf, archivioAziende[cf]);

  showToast("üíæ Anagrafica salvata correttamente", "success");
  notificaAnagraficaSalvata && notificaAnagraficaSalvata();
}

function salvaAnagraficaCompleta(cf, dati) {
  const blob = new Blob([JSON.stringify(dati, null, 2)], { type: "application/json" });
  const nomeFile = `${cf}_salvataggio_anagrafica.json`;
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = nomeFile;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  alert(`‚úÖ File JSON salvato correttamente!\n\nFile: ${nomeFile}\n\nPercorso suggerito:\nutente\\ceoDOC\\archivio\\dati\\anacrisk\\`);
  notificaAnagraficaSalvata && notificaAnagraficaSalvata();
}

// =============== MODIFICA CRITICA QUI ===============
// SOVRASCRIVE LA VECCHIA VERSIONE, FIX COMPORTAMENTO!
function eliminaAziendaSelezionata() {
  const select = document.getElementById('selectAzienda');
  const cf = select.value;
  if (!cf) {
    showToast("‚ö†Ô∏è Nessuna azienda selezionata", "warning");
    return;
  }

  if (!archivioAziende[cf]) {
    showToast("‚ö†Ô∏è Azienda non trovata nell'archivio", "warning");
    return;
  }

  const conferma = confirm(`‚ö†Ô∏è Vuoi davvero eliminare l'azienda con CF ${cf}?\n\nTutti i dati relativi saranno rimossi in modo definitivo!`);
  if (!conferma) {
    showToast("‚ùå Eliminazione annullata", "info");
    return;
  }

  // Rimozione effettiva
  delete archivioAziende[cf];

  // Se stai eliminando quella selezionata, reset variabile
  if (aziendaCorrente === cf) aziendaCorrente = null;

    // ========== PULIZIA TACHIMETRI QUANDO NON RESTANO AZIENDE ==========
    setTimeout(() => {
      const canvas1 = document.getElementById('tachimetroProminente1');
      const canvas2 = document.getElementById('tachimetroProminente2'); 
      const canvas3 = document.getElementById('tachimetroProminente3');

      [canvas1, canvas2, canvas3].forEach((canvas, index) => {
        if (canvas) {
          // Rimuovi l'indicatore con faccina
          const indicatore = canvas.parentElement?.querySelector('.tachimetro-indicator');
          if (indicatore) indicatore.remove();

          // Distruggi il grafico Chart.js
          const chartKey = `tachimetroChart_tachimetroProminente${index + 1}`;
          if (window[chartKey]) {
            window[chartKey].destroy();
            window[chartKey] = null;
          }

          // Pulisci il canvas
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        }
      });

      console.log('üßπ Tachimetri puliti dopo elimina ultima azienda');
    }, 200);
    // ========== FINE PULIZIA ==========

    // Reset visualizzazione e blocca la UI
    if (typeof resetAnalisiView === 'function') resetAnalisiView();

  // Aggiorna dropdown e UI
  aggiornaDropdownAziende && aggiornaDropdownAziende();

  // Se restano aziende, seleziona la prima automaticamente
  const aziende = Object.keys(archivioAziende);
  if (aziende.length > 0) {
    document.getElementById('selectAzienda').value = aziende[0];
    aziendaCorrente = aziende[0];
    aggiornaInterfaccia && aggiornaInterfaccia();
  } else {
    aziendaCorrente = null;
    // Reset visualizzazione e blocca la UI
    if (typeof resetAnalisiView === 'function') resetAnalisiView();
    document.getElementById('anagraficaCF').value = '';
    document.getElementById('anagraficaDenominazione').value = '';
    document.getElementById('anagraficaSede').value = '';
    document.getElementById('naturaGiuridica').value = '';
    document.getElementById('settore').value = '';
    document.getElementById('dataInserimento').value = '';
    document.getElementById('mesiCounter').innerHTML = 'Mesi<br>0';
  }

  // Salva su localStorage
  salvaDatiLocali && salvaDatiLocali();

  showToast("üóëÔ∏è Anagrafica eliminata con successo", "success");
}

// ==========================================
// ESTRAZIONE ANAGRAFICA DA PDF
// ==========================================
function estraiAnagrafica(text) {
  const upper = text.replace(/\s+/g, " ").toUpperCase();
  const result = {
    codiceFiscale: "",
    denominazione: "",
    sedeLegale: "",
    cciaa: ""
  };

  const cfMatch = upper.match(/\b(00000\d{11}|[A-Z0-9]{16})\b/);
  result.codiceFiscale = cfMatch ? cfMatch[1] : "";

  if (result.codiceFiscale) {
    const cfIndex = upper.indexOf(result.codiceFiscale);
    const before = upper.slice(0, cfIndex);
    const after = upper.slice(cfIndex + result.codiceFiscale.length);

    const cciaaMatch = [...before.matchAll(/\b(\d{5,7})\b/g)];
    if (cciaaMatch.length > 0) {
      result.cciaa = cciaaMatch[cciaaMatch.length - 1][1];
    }

    const denomBlock = before.split("CCIAA:")[1];
    result.denominazione = denomBlock
      ? denomBlock.replace(/\b\d{5,15}\b/g, "").trim()
      : "DENOMINAZIONE NON RILEVATA";

    // Sede ‚Äì prima cerca SEDE LEGALE, poi fallback come v19
    const sedeMatch = after.match(/SEDE(?:\s+LEGALE)?[:\s\-]*([A-Z√Ä-√ô'\s]{3,40})/i)
                    || after.match(/\b([A-Z']{3,})\b/); // fallback v19
    result.sedeLegale = sedeMatch ? sedeMatch[1] : "N/D";
  }

  return result;
}

function resetAnalisiView() {
  // Reset campi anagrafica (card superiore e inferiore)
  document.getElementById('anagraficaCF').value = '';
  document.getElementById('anagraficaDenominazione').value = '';
  document.getElementById('anagraficaSede').value = '';
  document.getElementById('naturaGiuridica').value = '';
  document.getElementById('settore').value = '';
  document.getElementById('dataInserimento').value = '';

  // Reset dropdown superiori
  document.getElementById('naturaGiuridicaScelta').value = '';
  document.getElementById('settoreScelto').value = '';

  // Reset contatore mesi
  const mesiCounter = document.getElementById('mesiCounter');
  if (mesiCounter) mesiCounter.innerHTML = 'Mesi<br>0';

  // Reset rating prominenti (valore e descrizione)
  document.getElementById('ratingValue1').textContent = '--';
  document.getElementById('ratingDescription1').textContent = 'Nessun dato disponibile';
  document.getElementById('ratingValue2').textContent = '--';
  document.getElementById('ratingDescription2').textContent = 'Nessun dato disponibile';
  document.getElementById('ratingValue3').textContent = '--';
  document.getElementById('ratingDescription3').textContent = 'Nessun dato disponibile';

  // Reset tachimetri (canvas)
  ['tachimetroProminente1','tachimetroProminente2','tachimetroProminente3'].forEach(id => {
    const canvas = document.getElementById(id);
    if (canvas && canvas.getContext) canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
  });

  // Reset tabelle/grafici (se presenti)
  if (document.querySelector('.tabella-cr')) document.querySelector('.tabella-cr').innerHTML = '';
  if (document.getElementById('graficiContainer')) document.getElementById('graficiContainer').innerHTML = '';
  if (document.getElementById('risultatiContainer')) document.getElementById('risultatiContainer').classList.add('hidden');

  // Disabilita pulsanti azione (opzionale, aggiungi altri ID se necessario)
  document.getElementById('btnCancellaCRPeriodo')?.setAttribute('disabled', true);
  document.getElementById('btnAnalisiPeriodo')?.setAttribute('disabled', true);

  // Chiudi tutte le modali aperte
  document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
}

    // ==========================================
    // IMPORT CENTRALE RISCHI
    // ==========================================
    function importaCR() {
      if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
        showToast('Seleziona prima un\'anagrafica con "Nuova Anagrafica"', 'warning');
        return;
      }

      // Verifica e recupera natura giuridica se non √® gi√† salvata
      if (!archivioAziende[aziendaCorrente].naturaGiuridica) {
        const selectNJ = document.getElementById('naturaGiuridica');
        const valoreNJ = selectNJ?.value || '';

        if (valoreNJ) {
          archivioAziende[aziendaCorrente].naturaGiuridica = valoreNJ;
          salvaDatiLocali();
          showToast(`üìò Natura giuridica recuperata dalla card: ${valoreNJ}`, "info");
        } else {
          alert("‚ö†Ô∏è Natura giuridica mancante.\nSelezionala prima di importare il PDF CR.");
          return;
        }
      }

      document.getElementById('crFileInput').click();
    }

    async function handleCRImport(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      if (!window.pdfjsLib) {
        showToast('PDF.js non disponibile - Cambia modalit√† o carica librerie', 'error');
        return;
      }

      if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
        showToast('Seleziona prima un\'anagrafica', 'warning');
        return;
      }

      showToast('Importazione CR in corso...', 'info');

      let mesiNuovi = 0;
      let mesiDuplicati = 0;

      for (let file of files) {
        try {
          const risultato = await elaboraCRFile(file);
          mesiNuovi += risultato.mesiNuovi;
          mesiDuplicati += risultato.mesiDuplicati;
        } catch (error) {
          console.error('Errore elaborazione CR:', error);
          showToast(`Errore ${file.name}: ${error.message}`, 'error');
        }
      }

      event.target.value = '';

      if (mesiNuovi === 0 && mesiDuplicati > 0) {
        showToast(`Nessun nuovo mese importato - ${mesiDuplicati} mesi gi√† presenti`, 'warning');
      } else if (mesiNuovi > 0) {
        showToast(`Importati ${mesiNuovi} nuovi mesi${mesiDuplicati > 0 ? ` (${mesiDuplicati} duplicati gestiti)` : ''}`, 'success');
      }

      aggiornaInterfaccia();
notificaImportCompletato();
    }

    async function elaboraCRFile(file) {
      const reader = new FileReader();

      return new Promise((resolve, reject) => {
        reader.onload = async function () {
          try {
            const typedarray = new Uint8Array(reader.result);
            const pdf = await window.pdfjsLib.getDocument({ data: typedarray }).promise;

            let rawText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              rawText += textContent.items.map(t => t.str).join(" ") + "\n";

              if (rawText.toUpperCase().includes('LEGENDA')) {
                const cutIndex = rawText.toUpperCase().indexOf('LEGENDA');
                rawText = rawText.slice(0, cutIndex);
                break;
              }
            }

            // Estrai anagrafica dal testo
            const anagraficaPDF = estraiAnagrafica(rawText);
            const cfEstratto = anagraficaPDF.codiceFiscale?.toUpperCase() || '';
            const cfAttuale = archivioAziende[aziendaCorrente]?.anagrafica?.cf?.toUpperCase() || '';

            // Se CF del PDF NON corrisponde all'anagrafica selezionata ‚ûú blocca
            if (!cfEstratto || cfEstratto !== cfAttuale) {
              alert(`‚ùå Codice fiscale del PDF (${cfEstratto || 'non trovato'}) non corrisponde a quello dell'anagrafica selezionata (${cfAttuale}).\n\nControlla di aver selezionato l'azienda corretta prima di importare.`);
              return reject(new Error("Codice fiscale non corrispondente"));
            }

            // Continua l'elaborazione se il CF √® corretto
            const dateRichieste = estraiDateRichieste(rawText);
            if (dateRichieste.length > 0) {
              archivioAziende[aziendaCorrente].dateRichieste = dateRichieste;
            }

            const parsed = parseCRTabelleEsteso(rawText);



// ===== ESTRAZIONE ALTRE INFORMAZIONI AUTOMATICA =====
console.log("üîç DEBUG: Inizio estrazione altre informazioni");
console.log("üìÑ Testo PDF (primi 2000 caratteri):", rawText.substring(0, 2000));

function estraiCrediti(testo) {
  console.log("üí∞ [estraiCrediti] Parser robusto breakdown+tabella (tutti i mesi, anche a zero)");
  const crediti = [];
  const breakdown = {};
  const mesiSet = new Set();
  const matchMesi = testo.matchAll(/DATA DI RIFERIMENTO\s*[:]\s*([a-zA-Z]+ \d{4})/gi);
  for (const m of matchMesi) { mesiSet.add(m[1].trim()); }
  const listaMesi = Array.from(mesiSet).sort((a, b) => {
    const mesiIt = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
    const [ma, ya] = a.split(' '); const [mb, yb] = b.split(' ');
    return (parseInt(ya)*12 + mesiIt.indexOf(ma.toLowerCase())) - (parseInt(yb)*12 + mesiIt.indexOf(mb.toLowerCase()));
  });
  listaMesi.forEach(mese => { breakdown[mese] = []; });
  const blocchiMese = testo.split(/DATA DI RIFERIMENTO\s*[:]\s*/gi).slice(1);
  blocchiMese.forEach(blocco => {
    const meseMatch = blocco.match(/^([a-zA-Z]+ \d{4})/);
    if (!meseMatch) return;
    const mese = meseMatch[1].trim();
    const righe = [...blocco.matchAll(/RISCHI AUTOLIQUIDANTI\s*-\s*CREDITI SCADUTI.*?CREDITI\s+(PAGATI|IMPAGATI)\s+([\d\.]+)/gi)];
    console.log("üîç [DEBUG] Mese:", mese, "- Righe trovate:", righe.length);
    if (righe.length > 0) {
      console.log("üîç [DEBUG] Prima riga match:", righe[0]);
    }
    righe.forEach(r => {
      const tipo = r[1].toUpperCase();
      const val = parseInt(r[2].replace(/\./g, '')) || 0;
      console.log("üîç [DEBUG] Parsing", tipo, "valore:", val);
      if (tipo === "PAGATI") breakdown[mese].push({ pagati: val, impagati: 0 });
      if (tipo === "IMPAGATI") breakdown[mese].push({ pagati: 0, impagati: val });
    });
  });
  Object.keys(breakdown).forEach(mese => {
    let righe = breakdown[mese];
    let merge = [];
    for (let i = 0; i < righe.length; ) {
      if (righe[i].pagati && righe[i+1] && righe[i+1].impagati) {
        merge.push({ pagati: righe[i].pagati, impagati: righe[i+1].impagati });
        i += 2;
      } else if (righe[i].impagati && righe[i+1] && righe[i+1].pagati) {
        merge.push({ pagati: righe[i+1].pagati, impagati: righe[i].impagati });
        i += 2;
      } else {
        merge.push(righe[i]);
        i++;
      }
    }
    breakdown[mese] = merge;
  });
  listaMesi.forEach(mese => {
    const lista = breakdown[mese] || [];
    const pagati = lista.reduce((a, x) => a + (x.pagati||0), 0);
    const impagati = lista.reduce((a, x) => a + (x.impagati||0), 0);
    const totale = pagati + impagati;
    const perc = totale ? (impagati/totale)*100 : 0;
    crediti.push({
      mese,
      pagati,
      impagati,
      totale,
      percentualeInsoluti: perc
    });
  });
  window._creditiRawBreakdown = breakdown;
  console.log("üí∞ [estraiCrediti] Estratti " + crediti.length + " mesi (completi) + breakdown");
  return crediti;
}

function estraiGaranzie(testo) {
  const garanzie = [];
  const blocchi = testo.split(/DATA DI RIFERIMENTO\s*[:]\s*/gi).slice(1);
  blocchi.forEach(blocco => {
    const meseMatch = blocco.match(/^([a-zA-Z]+ \d{4})/);
    if (!meseMatch) return;
    const mese = meseMatch[1].trim();

    const intermediari = [];
    const regexInterm = /Intermediario:\s*([^\n]+)/gi;
    let m;
    while ((m = regexInterm.exec(blocco)) !== null) {
      intermediari.push({ nome: m[1].trim(), pos: m.index });
    }
    intermediari.forEach((intm, idx) => {
      const fine = (idx + 1 < intermediari.length) ? intermediari[idx + 1].pos : blocco.length;
      const chunk = blocco.slice(intm.pos, fine);
      const garantiMatches = [...chunk.matchAll(/INFORMAZIONI SUI GARANTI(.*?)(?=Intermediario:|Crediti per cassa|Sezione informativa|DATA DI RIFERIMENTO|$)/gis)];
      garantiMatches.forEach(match => {
        const bloccoGaranti = match[1];
        const righe = bloccoGaranti.split('\n').filter(r => /(codice censito)/.test(r));
        righe.forEach(riga => {
          const g = riga.match(/^(.+?)\(codice censito\s+(\d+)\)\s+(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s+(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)/);
          if (g) {
            garanzie.push({
              mese: mese,
              intermediario: intm.nome,
              nome: g[1].trim(),
              codiceCensito: g[2],
              importoGarantito: parseFloat(g[3].replace(/\./g, '').replace(',', '.')),
              valoreGaranzia: parseFloat(g[4].replace(/\./g, '').replace(',', '.'))
            });
          }
        });
      });
    });
  });
  console.log("üõ°Ô∏è Garanzie estratte per tutti i mesi/intermediari: " + garanzie.length);
  return garanzie;
}

function estraiRichieste(testo) {
  const richieste = [];
  try {
    const patterns = [/RICHIESTE DI INFORMAZIONE(.*?)(?=LEGENDA|$)/is];
    let sezione = null;
    for (let p of patterns) {
      const m = testo.match(p);
      if (m) { sezione = m[1]; break; }
    }
    if (!sezione) return richieste;
    const righe = sezione.split('\n').filter(r => /\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}/.test(r));
    righe.forEach(riga => {
      const dataMatch = riga.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/);
      if (!dataMatch) return;
      const data = dataMatch[1];
      const dataPos = riga.indexOf(data);
      const intermediario = riga.substring(0, dataPos).trim();
      richieste.push({ data, intermediario });
    });
  } catch (e) { }
  console.log("üìã Richieste estratte: " + richieste.length);
  return richieste;
}

const richieste = (typeof estraiRichieste === 'function') ? estraiRichieste(rawText) : [];
console.log("üìã Richieste estratte:", richieste);
const garanzie = (typeof estraiGaranzie === 'function') ? estraiGaranzie(rawText) : [];
console.log("üõ°Ô∏è Garanzie estratte:", garanzie);
const crediti = (typeof estraiCrediti === 'function') ? estraiCrediti(rawText) : [];
console.log("üí∞ Crediti estratti:", crediti);
console.log("üí∞ [DEBUG] Breakdown dopo estrazione:", window._creditiRawBreakdown);

// Cerca sezioni specifiche nel testo
console.log("üîç Contiene 'CREDITI SCADUTI'?", rawText.includes('CREDITI SCADUTI'));
console.log("üîç Contiene 'AUTOLIQUIDANTI'?", rawText.includes('AUTOLIQUIDANTI'));
console.log("üîç Contiene 'INFORMAZIONI SUI GARANTI'?", rawText.includes('INFORMAZIONI SUI GARANTI'));
console.log("üîç Contiene 'PAGATI'?", rawText.includes('PAGATI'));
console.log("üîç Contiene 'IMPAGATI'?", rawText.includes('IMPAGATI'));
console.log("üîç Contiene 'GARANZIA'?", rawText.includes('GARANZIA'));
console.log("üîç Contiene 'GARANTE'?", rawText.includes('GARANTE'));

// Salva altre informazioni nell'archivio azienda
if (!archivioAziende[aziendaCorrente].altreInformazioni) {
  archivioAziende[aziendaCorrente].altreInformazioni = {};
}
archivioAziende[aziendaCorrente].altreInformazioni.crediti = crediti;
archivioAziende[aziendaCorrente].altreInformazioni.garanzie = garanzie;
archivioAziende[aziendaCorrente].altreInformazioni.richieste = richieste;
console.log('üíæ [DEBUG] Salvataggio breakdown - window._creditiRawBreakdown:', window._creditiRawBreakdown);
archivioAziende[aziendaCorrente].altreInformazioni.creditiRawBreakdown = window._creditiRawBreakdown;
archivioAziende[aziendaCorrente].altreInformazioni.dataUltimoAggiornamento = new Date().toISOString();
console.log('üíæ [DEBUG] Breakdown salvato nell\'archivio:', archivioAziende[aziendaCorrente].altreInformazioni.creditiRawBreakdown);

// Aggiorna anche le variabili globali per compatibilit√†
// Aggiorna anche le variabili globali per compatibilit√†
window._creditiAnalisi = crediti;
window._garanzieAnalisi = garanzie;
window._richiesteAnalisi = richieste;
window._altreInfoCrediti = crediti;
window._altreInfoGaranzie = garanzie;

console.log("‚úÖ Altre Informazioni estratte automaticamente:", {
  crediti: crediti.length,
  garanzie: garanzie.length,
  richieste: richieste.length
});
            let mesiNuovi = 0;
            let mesiDuplicati = 0;

            for (const [mese, datiMese] of Object.entries(parsed.mesi)) {
              if (archivioAziende[aziendaCorrente].mesi[mese]) {
                const scelta = await mostraModalDoppione(mese);
                if (scelta === 'sovrascrivi') {
                  archivioAziende[aziendaCorrente].mesi[mese] = datiMese;
                  mesiNuovi++;
                } else {
                  mesiDuplicati++;
                  console.log(`Mese duplicato ignorato: ${mese}`);
                }
                continue;
              }

              archivioAziende[aziendaCorrente].mesi[mese] = datiMese;
              mesiNuovi++;
            }

            // Limita a 60 mesi
            const mesiOrdinati = Object.keys(archivioAziende[aziendaCorrente].mesi).sort((a, b) => {
              return new Date(parseMeseAnno(a)) - new Date(parseMeseAnno(b));
            });

            if (mesiOrdinati.length > 60) {
              const mesiDaRimuovere = mesiOrdinati.slice(0, mesiOrdinati.length - 60);
              mesiDaRimuovere.forEach(mese => {
                delete archivioAziende[aziendaCorrente].mesi[mese];
              });

              showToast(`Rimossi ${mesiDaRimuovere.length} mesi pi√π vecchi (limite 60)`, 'warning');
            }

if (Object.keys(archivioAziende[aziendaCorrente].mesi).length === 0) {
  showToast(
    "‚ÑπÔ∏è Nessun periodo CR caricato per questa azienda. Puoi reimportare un PDF Centrale Rischi oppure eliminare l'anagrafica dal menu.",
    "info"
  );
}



            contatori.pdfImportati++;
            salvaDatiLocali();
            resolve({ mesiNuovi, mesiDuplicati });

          } catch (error) {
            reject(error);
          }
        };

        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Modal per gestione doppioni
    function mostraModalDoppione(mese) {
      return new Promise((resolve) => {
        const modal = document.getElementById('modalDoppioni');
        const messaggio = document.getElementById('messaggioDoppione');
        const btnSovrascrivi = document.getElementById('btnSovrascrivi');
        const btnIgnora = document.getElementById('btnIgnora');

        messaggio.textContent = `Il mese "${mese}" √® gi√† presente nella tua base dati. Vuoi sovrascrivere i dati di questo mese con quelli nuovi?`;

        modal.style.display = 'flex';

        const handleSovrascrivi = () => {
          modal.style.display = 'none';
          btnSovrascrivi.removeEventListener('click', handleSovrascrivi);
          btnIgnora.removeEventListener('click', handleIgnora);
          resolve('sovrascrivi');
        };

        const handleIgnora = () => {
          modal.style.display = 'none';
          btnSovrascrivi.removeEventListener('click', handleSovrascrivi);
          btnIgnora.removeEventListener('click', handleIgnora);
          resolve('ignora');
        };

        btnSovrascrivi.addEventListener('click', handleSovrascrivi);
        btnIgnora.addEventListener('click', handleIgnora);
      });
    }

    function estraiDateRichieste(text) {
      const dateMatch = text.match(/Date richieste[:\s]*((?:[a-z]{3}-\d{2}\s*)+)(?=DATI ANAGRAFICI)/i);
      return dateMatch ? dateMatch[1].trim().split(/\s+/) : [];

    }

    // ==========================================
    // PARSER CR ESTESO - CON 11 COLONNE
    // ==========================================
    function parseCRTabelleEsteso(text) {
      const result = { mesi: {} };

      const blocchi = text.split(/DATA DI RIFERIMENTO\s*:\s*/gi).slice(1);

      blocchi.forEach(blocco => {
        const meseMatch = blocco.match(/^([a-zA-Z]+ \d{4})/);
        if (!meseMatch) return;

        const mese = meseMatch[1].trim();
        if (!result.mesi[mese]) {
          result.mesi[mese] = { intermediari: [] };
        }

        // REGEX CORRETTA CON VIRGOLA PER UNICREDIT
        const intestazioni = [...blocco.matchAll(/([A-Z√Ä-√ú0-9 ',\-\.]{6,})\s+Intermediario:/gi)];

        intestazioni.forEach((match, idx) => {
          let nome = match[1].trim();
          nome = nome.replace(/^((\d+[.,]?\d*)\s+)+/, '').trim();
          if (nome === "SOCIETA' PER AZIONI") return;

          const start = match.index;
          const end = (idx + 1 < intestazioni.length) ? intestazioni[idx + 1].index : blocco.length;
          const chunk = blocco.slice(start, end);

          const righe = chunk.split(/RISCHI /gi).slice(1);
          const rischi = [];

          righe.forEach(r => {
            const categoriaMatch = r.match(/^([A-Z ]{5,})/);
            const numeri = r.match(/(\d{1,3}(?:\.\d{3})*|\d+)\s+(\d{1,3}(?:\.\d{3})*|\d+)\s+(\d{1,3}(?:\.\d{3})*|\d+)\s+(\d{1,3}(?:\.\d{3})*|\d+)/);

            if (categoriaMatch && numeri) {
              let categoria = categoriaMatch[1].trim();
              if (categoria.includes("SCAD") && !categoria.includes("SCADENZA")) {
                categoria = "A SCADENZA";
              }

              // ESTRAZIONE 6 COLONNE AGGIUNTIVE
              const durataOriginaria = estraiDurataOriginaria(r);
              const durataResidua = estraiDurataResidua(r);
              const importExport = estraiImportExport(r);
              const statoRapporto = estraiStatoRapporto(r);
              const tipoGaranzia = estraiTipoGaranzia(r);
              const ruoloAffidato = estraiRuoloAffidato(r);
              const saldoMedio = estraiSaldoMedio(r);

              rischi.push({
                categoria,
                accordato: parseFloat(numeri[1].replace(/\./g, '')),
                accordatoOperativo: parseFloat(numeri[2].replace(/\./g, '')),
                utilizzato: parseFloat(numeri[3].replace(/\./g, '')),
                garantito: parseFloat(numeri[4].replace(/\./g, '')),
                // 6 COLONNE AGGIUNTIVE
                durataOriginaria: durataOriginaria,
                durataResidua: durataResidua,
                importExport: importExport,
                statoRapporto: statoRapporto,
                tipoGaranzia: tipoGaranzia,
                ruoloAffidato: ruoloAffidato,
                saldoMedio: saldoMedio
              });
            }
          });

          if (rischi.length > 0) {
            const esistente = result.mesi[mese].intermediari.find(i => i.nome === nome);
            if (esistente) {
              esistente.rischi.push(...rischi);
            } else {
              result.mesi[mese].intermediari.push({ nome, rischi });
            }
          }
        });
      });

      return result;
    }

    // ==========================================
    // FUNZIONI ESTRAZIONE 6 COLONNE AGGIUNTIVE
    // ==========================================
    function estraiDurataOriginaria(testo) {
      const durataMatch = testo.match(/(\d{1,3})\s*MESI?|BREVE\s*TERMINE|LUNGO\s*TERMINE/i);
      if (durataMatch) {
        if (durataMatch[1]) {
          return `${durataMatch[1]} mesi`;
        } else {
          return durataMatch[0].toUpperCase();
        }
      }
      return 'N/D';
    }
    function estraiDurataResidua(testo) {
      const residuaMatch = testo.match(/RESIDUA?s*[:-]?s*(d{1,3})s*MESI?|RESTANTE?s*[:-]?s*(d{1,3})/i);
      if (residuaMatch) {
        const mesi = residuaMatch[1] || residuaMatch[2];
        return `${mesi} mesi`;
      }
      return "N/D";
    }

    function estraiImportExport(testo) {
      if (testo.match(/IMPORT|IMPb/i)) return "IMPORT";
      if (testo.match(/EXPORT|EXPb/i)) return "EXPORT";
      if (testo.match(/DOMESTICO|DOMb|NAZIONALE/i)) return "DOMESTICO";
      return "N/D";
    }

    function estraiStatoRapporto(testo) {
      if (testo.match(/ATTIVO|ATTIVA/i)) return "ATTIVO";
      if (testo.match(/CHIUSO|CHIUSA/i)) return "CHIUSO";
      if (testo.match(/SOSPESO|SOSPESA/i)) return "SOSPESO";
      if (testo.match(/SCADUTO|SCADUTA/i)) return "SCADUTO";
      return "ATTIVO"; // Default
    }

    function estraiTipoGaranzia(testo) {
      if (testo.match(/IPOTECARIA|IPOTECA/i)) return "IPOTECARIA";
      if (testo.match(/PERSONALE|FIDEIUSS/i)) return "PERSONALE";
      if (testo.match(/PIGNORATIZ/i)) return "PEGNO";
      if (testo.match(/REAL[EI]/i)) return "REALE";
      if (testo.match(/MISTA/i)) return "MISTA";
      return "NESSUNA";
    }

    function estraiRuoloAffidato(testo) {
      if (testo.match(/TITOLARE|PRINCIPALE/i)) return "TITOLARE";
      if (testo.match(/GARANTE|GARANZIA/i)) return "GARANTE";
      if (testo.match(/COOBBLIGATO|CO-OBBLIGATO/i)) return "COOBBLIGATO";
      if (testo.match(/AVALISTA/i)) return "AVALISTA";
      return "TITOLARE"; // Default
    }

    function estraiSaldoMedio(testo) {
      const saldoMatch = testo.match(/SALDOs*MED[IO]?s*[:-]?s*(d{1,3}(?:.d{3})*)/i);
      if (saldoMatch) {
        return parseFloat(saldoMatch[1].replace(/./g, ""));
      }
      return 0;
    }



    function parseMeseAnno(meseStr) {
  const mesi = {
    'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
    'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
    'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
  };

  const parti = meseStr.toLowerCase().split(' ');
  const mese = mesi[parti[0]];
  const anno = parseInt(parti[1]);

  return new Date(anno, mese, 1);
}


    function verificaConsecutivitaMesi(mesi) {
  if (mesi.length <= 1) return { consecutivi: true, gap: 0 };

  const mesiItaliani = [
    'gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
    'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'
  ];

  let gap = 0;

  for (let i = 1; i < mesi.length; i++) {
    const [mesePrec, annoPrec] = mesi[i-1].toLowerCase().split(' ');
    const [meseCorr, annoCorr] = mesi[i].toLowerCase().split(' ');

    const annoNumPrec = parseInt(annoPrec) || 0;
    const annoNumCorr = parseInt(annoCorr) || 0;

    const indiceMesePrec = mesiItaliani.indexOf(mesePrec);
    const indiceMeseCorr = mesiItaliani.indexOf(meseCorr);

    const diffMesi = (annoNumCorr - annoNumPrec) * 12 + (indiceMeseCorr - indiceMesePrec);

    if (diffMesi > 1) {
      gap = diffMesi - 1;
      return { consecutivi: false, gap };
    }
  }

  return { consecutivi: true, gap: 0 };
}


    // ==========================================
    // TABELLA B - ANDAMENTALE MENSILE (TUTTI I MESI FINO A 60)
    // ==========================================
    function creaTabellaAndamentaleMensile(azienda) {
      const mesiOrdinati = Object.keys(azienda.mesi).sort((a, b) => {
        return new Date(parseMeseAnno(a)) - new Date(parseMeseAnno(b));
      });

      const tabellaB = {
        mesi: [],
        media: {},
        mediaUltimi6: {},
        mediaUltimi12: {}
      };

      let sommaAccAutoliqRevoca = 0;
      let sommaUtilizzatoAutoliqRevoca = 0;
      let sommaAccScadenza = 0;
      let sommaUtilizzatoScadenza = 0;
      let contatoreMesi = 0;

      // CALCOLA PER TUTTI I MESI DISPONIBILI (FINO A 60)
      mesiOrdinati.forEach(mese => {
        const datiMese = azienda.mesi[mese];

        let accRevoca = 0;
        let utilizzatoRevoca = 0;
        let accAutoliquidanti = 0;
        let utilizzatoAutoliquidanti = 0;
        let accScadenza = 0;
        let utilizzatoScadenza = 0;

        datiMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.categoria.includes('REVOCA')) {
              accRevoca += rischio.accordatoOperativo;
              utilizzatoRevoca += rischio.utilizzato;
            } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
              accAutoliquidanti += rischio.accordatoOperativo;
              utilizzatoAutoliquidanti += rischio.utilizzato;
            } else if (rischio.categoria.includes('SCADENZA')) {
              accScadenza += rischio.accordatoOperativo;
              utilizzatoScadenza += rischio.utilizzato;
            }
          });
        });

        // Totali per formula MCC (Revoca + Autoliquidanti)
        const accAutoliqRevoca = accRevoca + accAutoliquidanti;
        const utilizzatoAutoliqRevoca = utilizzatoRevoca + utilizzatoAutoliquidanti;

        const c1_percent = accAutoliqRevoca > 0 ? (utilizzatoAutoliqRevoca / accAutoliqRevoca) : 0;
        const scadenza_percent = accScadenza > 0 ? (utilizzatoScadenza / accScadenza) : 0;

        // Aggiungi dati mese con SEPARAZIONE per grafici
        tabellaB.mesi.push({
          mese: mese,
          // Per formula MCC (sommati)
          accAutoliqRevoca: accAutoliqRevoca,
          utilizzatoAutoliqRevoca: utilizzatoAutoliqRevoca,
          c1_percent: c1_percent,
          // Per grafici (separati)
          accRevoca: accRevoca,
          utilizzatoRevoca: utilizzatoRevoca,
          accAutoliquidanti: accAutoliquidanti,
          utilizzatoAutoliquidanti: utilizzatoAutoliquidanti,
          // Scadenza
          accScadenza: accScadenza,
          utilizzatoScadenza: utilizzatoScadenza,
          scadenza_percent: scadenza_percent
        });

        // Accumula per medie
        sommaAccAutoliqRevoca += accAutoliqRevoca;
        sommaUtilizzatoAutoliqRevoca += utilizzatoAutoliqRevoca;
        sommaAccScadenza += accScadenza;
        sommaUtilizzatoScadenza += utilizzatoScadenza;
        contatoreMesi++;
      });

      // MEDIA TOTALE (tutti i mesi)
      if (contatoreMesi > 0) {
        const mediaAccAutoliqRevoca = sommaAccAutoliqRevoca / contatoreMesi;
        const mediaUtilizzatoAutoliqRevoca = sommaUtilizzatoAutoliqRevoca / contatoreMesi;
        const mediaAccScadenza = sommaAccScadenza / contatoreMesi;
        const mediaUtilizzatoScadenza = sommaUtilizzatoScadenza / contatoreMesi;

        tabellaB.media = {
          accAutoliqRevoca: mediaAccAutoliqRevoca,
          utilizzatoAutoliqRevoca: mediaUtilizzatoAutoliqRevoca,
          c1_percent: mediaAccAutoliqRevoca > 0 ? Math.min(mediaUtilizzatoAutoliqRevoca / mediaAccAutoliqRevoca, 1.2) : 0,
          accScadenza: mediaAccScadenza,
          utilizzatoScadenza: mediaUtilizzatoScadenza,
          scadenza_percent: mediaAccScadenza > 0 ? (mediaUtilizzatoScadenza / mediaAccScadenza) : 0
        };
      }

      // MEDIA ULTIMI 6 MESI
      const ultimi6 = tabellaB.mesi.slice(-6);
      if (ultimi6.length > 0) {
        let somma6_acc = 0, somma6_uti = 0, somma6_accSc = 0, somma6_utiSc = 0;
        ultimi6.forEach(item => {
          somma6_acc += item.accAutoliqRevoca;
          somma6_uti += item.utilizzatoAutoliqRevoca;
          somma6_accSc += item.accScadenza;
          somma6_utiSc += item.utilizzatoScadenza;
        });

        tabellaB.mediaUltimi6 = {
          accAutoliqRevoca: somma6_acc / ultimi6.length,
          utilizzatoAutoliqRevoca: somma6_uti / ultimi6.length,
          c1_percent: somma6_acc > 0 ? Math.min((somma6_uti / ultimi6.length) / (somma6_acc / ultimi6.length), 1.2) : 0,
          accScadenza: somma6_accSc / ultimi6.length,
          utilizzatoScadenza: somma6_utiSc / ultimi6.length,
          scadenza_percent: somma6_accSc > 0 ? (somma6_utiSc / ultimi6.length) / (somma6_accSc / ultimi6.length) : 0
        };
      }

      // MEDIA ULTIMI 12 MESI (NUOVO PER GRAFICI)
      const ultimi12 = tabellaB.mesi.slice(-12);
      if (ultimi12.length > 0) {
        let somma12_acc = 0, somma12_uti = 0, somma12_accSc = 0, somma12_utiSc = 0;
        ultimi12.forEach(item => {
          somma12_acc += item.accAutoliqRevoca;
          somma12_uti += item.utilizzatoAutoliqRevoca;
          somma12_accSc += item.accScadenza;
          somma12_utiSc += item.utilizzatoScadenza;
        });

        tabellaB.mediaUltimi12 = {
          accAutoliqRevoca: somma12_acc / ultimi12.length,
          utilizzatoAutoliqRevoca: somma12_uti / ultimi12.length,
          c1_percent: somma12_acc > 0 ? Math.min((somma12_uti / ultimi12.length) / (somma12_acc / ultimi12.length), 1.2) : 0,
          accScadenza: somma12_accSc / ultimi12.length,
          utilizzatoScadenza: somma12_utiSc / ultimi12.length,
          scadenza_percent: somma12_accSc > 0 ? (somma12_utiSc / ultimi12.length) / (somma12_accSc / ultimi12.length) : 0
        };
      }

      return tabellaB;
    }

    function calcolaMedia6Mesi(azienda, mesi) {
      const tabellaB = creaTabellaAndamentaleMensile(azienda);

      const mesiRichiesti = tabellaB.mesi.filter(item => mesi.includes(item.mese));

      if (mesiRichiesti.length === 0) {
        return {
          percentualeUtilizzo: 0,
          nonUtilizzo4Mesi: false,
          sconfinoScadenza: false,
          mesiEccesso: 0
        };
      }

      let sommaC1 = 0;
      let mesiConUtilizzo = 0;
      let mesiSconfinoScadenza = 0;
      let mesiEccesso = 0;

      mesiRichiesti.forEach(item => {
        sommaC1 += item.c1_percent;

        if (item.utilizzatoAutoliqRevoca > 0) {
          mesiConUtilizzo++;
        }

        if (item.scadenza_percent > 1) {
          mesiSconfinoScadenza++;
        }

        if (item.c1_percent > 1) {
          mesiEccesso++;
        }
      });

      const c1_medio = mesiRichiesti.length > 0 ? (sommaC1 / mesiRichiesti.length) : 0;

      return {
        percentualeUtilizzo: c1_medio,
        nonUtilizzo4Mesi: (6 - mesiConUtilizzo) >= 4,
        sconfinoScadenza: mesiSconfinoScadenza > 0,
        mesiEccesso: mesiEccesso
      };
    }

    function calcolaRatingMese(azienda, mese) {
      const tabellaB = creaTabellaAndamentaleMensile(azienda);

      const datiMese = tabellaB.mesi.find(item => item.mese === mese);

      if (!datiMese) {
        return {
          percentualeUtilizzo: 0,
          nonUtilizzo4Mesi: false,
          sconfinoScadenza: false,
          mesiEccesso: 0
        };
      }

      return {
        percentualeUtilizzo: datiMese.c1_percent,
        nonUtilizzo4Mesi: false,
        sconfinoScadenza: datiMese.scadenza_percent > 1,
        mesiEccesso: datiMese.c1_percent > 1 ? 1 : 0,
        score: 0
      };
    }

    function calcolaRatingMCC(azienda) {
      const mesiOrdinati = Object.keys(azienda.mesi).sort((a, b) => {
        return new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a));
      });

      if (!azienda.naturaGiuridica || !coefficientiMCC[azienda.naturaGiuridica]) {
        return {
          score: 0,
          classe: { classe: "UNRATED", descr: "Natura giuridica mancante", emoji: "‚ö†Ô∏è" },
          tipo: 'errore'
        };
      }

      const coeff = coefficientiMCC[azienda.naturaGiuridica];
      const ultimi6Mesi = verificaConsecutivita(mesiOrdinati.slice(0, 6));

      let datiCalcolo, tipo;

      if (ultimi6Mesi.length >= 6) {
        datiCalcolo = calcolaMedia6Mesi(azienda, ultimi6Mesi);
        tipo = 'media6';
      } else {
        const ultimoMese = mesiOrdinati[0];
        datiCalcolo = calcolaRatingMese(azienda, ultimoMese);
        tipo = 'ultimo';
      }

      const c1 = datiCalcolo.percentualeUtilizzo || 0;
      const dc1 = datiCalcolo.nonUtilizzo4Mesi ? c1 : 0;
      const dc3 = datiCalcolo.sconfinoScadenza ? 1 : 0;
      const c2 = datiCalcolo.mesiEccesso || 0;

      const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                                  ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

      const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                    (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                    coeff.COSTANTE + correzione;

      const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                     { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };

      return {
        score: score,
        classe: classe,
        tipo: tipo,
        datiCalcolo: datiCalcolo
      };
    }

    // NUOVE FUNZIONI per i 3 calcoli rating specifici
    function calcolaRating12Mesi(azienda) {
      const mesiOrdinati = Object.keys(azienda.mesi).sort((a, b) => {
        return new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a));
      });

      if (!azienda.naturaGiuridica || !coefficientiMCC[azienda.naturaGiuridica] || mesiOrdinati.length < 12) {
        return { score: 0, classe: { classe: "UNRATED", descr: "Dati insufficienti", emoji: "‚ö†Ô∏è" } };
      }

      const coeff = coefficientiMCC[azienda.naturaGiuridica];
      const ultimi12Mesi = mesiOrdinati.slice(0, 12);
      const datiCalcolo = calcolaMedia6Mesi(azienda, ultimi12Mesi); // Usa la stessa logica ma su 12 mesi

      const c1 = datiCalcolo.percentualeUtilizzo || 0;
      const dc1 = datiCalcolo.nonUtilizzo4Mesi ? c1 : 0;
      const dc3 = datiCalcolo.sconfinoScadenza ? 1 : 0;
      const c2 = datiCalcolo.mesiEccesso || 0;

      const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                                  ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

      const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                    (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                    coeff.COSTANTE + correzione;

      const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                     { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };

      return { score: score, classe: classe };
    }

    function calcolaRating6MesiForzato(azienda) {
      const mesiOrdinati = Object.keys(azienda.mesi).sort((a, b) => {
        return new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a));
      });

      if (!azienda.naturaGiuridica || !coefficientiMCC[azienda.naturaGiuridica] || mesiOrdinati.length < 6) {
        return { score: 0, classe: { classe: "UNRATED", descr: "Dati insufficienti", emoji: "‚ö†Ô∏è" } };
      }

      const coeff = coefficientiMCC[azienda.naturaGiuridica];
      const ultimi6Mesi = mesiOrdinati.slice(0, 6);
      const datiCalcolo = calcolaMedia6Mesi(azienda, ultimi6Mesi);

      const c1 = datiCalcolo.percentualeUtilizzo || 0;
      const dc1 = datiCalcolo.nonUtilizzo4Mesi ? c1 : 0;
      const dc3 = datiCalcolo.sconfinoScadenza ? 1 : 0;
      const c2 = datiCalcolo.mesiEccesso || 0;

      const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                                  ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

      const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                    (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                    coeff.COSTANTE + correzione;

      const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                     { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };

      return { score: score, classe: classe };
    }

    function calcolaRatingUltimoMese(azienda) {
      const mesiOrdinati = Object.keys(azienda.mesi).sort((a, b) => {
        return new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a));
      });

      if (!azienda.naturaGiuridica || !coefficientiMCC[azienda.naturaGiuridica] || mesiOrdinati.length === 0) {
        return { score: 0, classe: { classe: "UNRATED", descr: "Dati insufficienti", emoji: "‚ö†Ô∏è" } };
      }

      const coeff = coefficientiMCC[azienda.naturaGiuridica];
      const ultimoMese = mesiOrdinati[0];
      const datiCalcolo = calcolaRatingMese(azienda, ultimoMese);

      const c1 = datiCalcolo.percentualeUtilizzo || 0;
      const dc1 = 0; // Sempre 0 per singolo mese
      const dc3 = datiCalcolo.sconfinoScadenza ? 1 : 0;
      const c2 = datiCalcolo.mesiEccesso || 0;

      const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                                  ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

      const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                    (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                    coeff.COSTANTE + correzione;

      const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                     { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };

      return { score: score, classe: classe };
    }

    function aggiornaStatusMCC() {
      const azienda = archivioAziende[aziendaCorrente];
      if (!azienda) return;

      const mesiDisponibili = Object.keys(azienda.mesi).length;

      if (mesiDisponibili > 0 && azienda.naturaGiuridica) {
        const rating12 = calcolaRating12Mesi(azienda);
        const rating6 = calcolaRating6MesiForzato(azienda);
        const ratingUltimo = calcolaRatingUltimoMese(azienda);

        console.log('üìä Aggiornamento status MCC:', {
          rating12: rating12.classe.classe,
          rating6: rating6.classe.classe, 
          ratingUltimo: ratingUltimo.classe.classe
        });

      } else {
        console.log('üìä Status MCC: Dati insufficienti');
      }
    }

// ===== RICARICA ALTRE INFORMAZIONI DAL LOCALSTORAGE =====
function ricaricaAltreInformazioniDaStorage() {
  if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) return;

  const azienda = archivioAziende[aziendaCorrente];

  if (azienda.altreInformazioni) {
    // Ricarica crediti
    if (azienda.altreInformazioni.crediti) {
      window._creditiAnalisi = azienda.altreInformazioni.crediti;
      console.log('üîÑ Ricaricati', window._creditiAnalisi.length, 'crediti dal localStorage');
    }

    // Ricarica garanzie
    if (azienda.altreInformazioni.garanzie) {
      window._garanzieAnalisi = azienda.altreInformazioni.garanzie;
      console.log('üîÑ Ricaricate', window._garanzieAnalisi.length, 'garanzie dal localStorage');
    }

    // Ricarica richieste
    if (azienda.altreInformazioni.richieste) {
      window._richiesteAnalisi = azienda.altreInformazioni.richieste;
      console.log('üîÑ Ricaricate', window._richiesteAnalisi.length, 'richieste dal localStorage');
    }

    // Ricarica anche le variabili di compatibilit√†
    if (azienda.altreInformazioni.crediti) {
      window._altreInfoCrediti = azienda.altreInformazioni.crediti;
    }
    if (azienda.altreInformazioni.garanzie) {
      window._altreInfoGaranzie = azienda.altreInformazioni.garanzie;
    }
  }
}

    // ==========================================
    // RATING PROMINENTE CON TACHIMETRO MIGLIORATO v1.4 - 3 CARD COMPLETE
    // ==========================================
    function aggiornaRatingProminente() {
      if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
        // Reset tutte e 3 le card
        document.getElementById('ratingTitle1').textContent = 'RATING ANDAMENTALE ULTIMO MESE';
        document.getElementById('ratingValue1').textContent = '--';
        document.getElementById('ratingDescription1').textContent = 'Nessun dato disponibile';

        document.getElementById('ratingTitle2').textContent = 'RATING ANDAMENTALE MEDIA 6 MESI';
        document.getElementById('ratingValue2').textContent = '--';
        document.getElementById('ratingDescription2').textContent = 'Nessun dato disponibile';

        document.getElementById('ratingTitle3').textContent = 'RATING ANDAMENTALE MEDIA 12 MESI';
        document.getElementById('ratingValue3').textContent = '--';
        document.getElementById('ratingDescription3').textContent = 'Nessun dato disponibile';
        return;
      }

      const azienda = archivioAziende[aziendaCorrente];
      const mesiDisponibili = Object.keys(azienda.mesi);

      if (mesiDisponibili.length === 0) {
        document.getElementById('ratingValue1').textContent = '--';
        document.getElementById('ratingDescription1').textContent = 'Nessun mese importato';
        document.getElementById('ratingValue2').textContent = '--';
        document.getElementById('ratingDescription2').textContent = 'Nessun mese importato';
        document.getElementById('ratingValue3').textContent = '--';
        document.getElementById('ratingDescription3').textContent = 'Nessun mese importato';
        return;
      }

      if (!azienda.naturaGiuridica) {
        document.getElementById('ratingValue1').textContent = 'RICHIESTA';
        document.getElementById('ratingDescription1').textContent = 'Seleziona SC/SP/DI';
        document.getElementById('ratingValue2').textContent = 'RICHIESTA';
        document.getElementById('ratingDescription2').textContent = 'Seleziona SC/SP/DI';
        document.getElementById('ratingValue3').textContent = 'RICHIESTA';
        document.getElementById('ratingDescription3').textContent = 'Seleziona SC/SP/DI';
        return;
      }

      // CALCOLA I 3 RATING
      const ratingUltimo = calcolaRatingUltimoMese(azienda);
      const rating6Mesi = calcolaRating6MesiForzato(azienda);
      const rating12Mesi = calcolaRating12Mesi(azienda);

      // CARD 1: ULTIMO MESE
      document.getElementById('ratingValue1').textContent = ratingUltimo.classe.classe;
      document.getElementById('ratingDescription1').textContent = `${ratingUltimo.classe.descr} | Score: ${ratingUltimo.score.toFixed(2)}`;


      // CARD 2: MEDIA 6 MESI
      document.getElementById('ratingValue2').textContent = rating6Mesi.classe.classe;
      document.getElementById('ratingDescription2').textContent = `${rating6Mesi.classe.descr} | Score: ${rating6Mesi.score.toFixed(2)}`;


      // CARD 3: MEDIA 12 MESI
      document.getElementById('ratingValue3').textContent = rating12Mesi.classe.classe;
      document.getElementById('ratingDescription3').textContent = `${rating12Mesi.classe.descr} | Score: ${rating12Mesi.score.toFixed(2)}`;


      // CREA I 3 TACHIMETRI
      setTimeout(() => {
        creaTachimetroMigliorato_v12(ratingUltimo, 'tachimetroProminente1');
        creaTachimetroMigliorato_v12(rating6Mesi, 'tachimetroProminente2');
        creaTachimetroMigliorato_v12(rating12Mesi, 'tachimetroProminente3');
      }, 100);
    }

    // TACHIMETRO v1.2: SOLO FACCINA + CONTORNI COLORATI + PI√ô GRANDE
    function creaTachimetroMigliorato_v12(rating, canvasId = 'tachimetroProminente') {
      const ctx = document.getElementById(canvasId);
      if (!ctx || !window.Chart) return;

      // Destroy existing chart for this canvas
      const chartKey = `tachimetroChart_${canvasId}`;

      if (window[chartKey]) {
        window[chartKey].destroy();
      }

      // PULIZIA ELEMENTI PRECEDENTI
      const parent = ctx.parentElement;
      const oldIndicator = parent.querySelector('.tachimetro-indicator');
      const oldFreccia = parent.querySelector('.tachimetro-freccia');
      if (oldIndicator) oldIndicator.remove();
      if (oldFreccia) oldFreccia.remove();

      const classeNumero = parseInt(rating.classe.classe.replace('CR', '')) || 6;

      // Colori graduali pi√π belli dal verde smeraldo al rosso cremisi
      const colori = [
        '#10b981', // CR1 - Verde smeraldo
        '#22c55e', // CR2 - Verde lime
        '#84cc16', // CR3 - Verde chiaro
        '#eab308', // CR4 - Giallo oro
        '#f59e0b', // CR5 - Ambra
        '#f97316', // CR6 - Arancione
        '#ef4444', // CR7 - Rosso corallo
        '#dc2626', // CR8 - Rosso intenso
        '#b91c1c', // CR9 - Rosso scuro
        '#991b1b', // CR10 - Rosso cremisi
        '#7f1d1d'  // CR11 - Rosso granata
      ];

      // CONTORNI COLORATI (non pi√π bianchi) + MENO SPESSI
      const bordeColori = colori.map((colore, idx) => 
        idx === (classeNumero - 1) ? colore : '#f1f5f9'
      );
      const bordeLarghezze = Array(11).fill(1);
      bordeLarghezze[classeNumero - 1] = 4; // Meno spesso di prima

      window[chartKey] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['CR1', 'CR2', 'CR3', 'CR4', 'CR5', 'CR6', 'CR7', 'CR8', 'CR9', 'CR10', 'CR11'],
          datasets: [{
            data: Array(11).fill(1),
            backgroundColor: colori,
            borderWidth: bordeLarghezze,
            borderColor: bordeColori,
            cutout: '65%'
          }]
        },
        options: {
          rotation: -90,
          circumference: 180,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const isCurrentClass = context.dataIndex === (classeNumero - 1);
                 return `${context.label}${isCurrentClass ? ' (ATTUALE)' : ''}: ${classiMCC[context.dataIndex].descr}`;
                }
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            animateRotate: true,
            duration: 1200,
            easing: 'easeInOutQuart'
          }
        }
      });

     // INDICATORE CENTRALE: SOLO FACCINA + CR BIANCO (no testo rosso esterno)
    setTimeout(() => {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const parent = canvas.parentElement;

      const indicator = document.createElement('div');
      indicator.className = 'tachimetro-indicator';
      indicator.style.cssText = `
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
        font-weight: 700;
        pointer-events: none;
      `;

      // SOLO FACCINA (senza CR)
      indicator.innerHTML = `
        <div style="font-size: 3em; color: ${colori[classeNumero - 1]};">
          ${rating.classe.emoji}
        </div>
      `;

      parent.style.position = 'relative';
      parent.appendChild(indicator);
    }, 300);
    }

// ==========================================
// FUNZIONI ESTRAZIONE ALTRE INFORMAZIONI (da minimal estrai.html)  
// ==========================================

function formatIT(num) {
  return Number(num).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}



    // ==========================================
    // FUNZIONI GRID CENTRALE
    // ==========================================
    function verificaAziendaSelezionata() {
      if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
        showToast('Seleziona prima un\'azienda', 'warning');
        return false;
      }

      if (!archivioAziende[aziendaCorrente].naturaGiuridica) {
        showToast('Imposta la natura giuridica dell\'azienda', 'warning');
        return false;
      }

      if (Object.keys(archivioAziende[aziendaCorrente].mesi).length === 0) {
        showToast('Nessun mese disponibile - Usa "Importa CR"', 'warning');
        return false;
      }

      return true;
    }

    function visualizzaRischiRevoca() {
      if (!verificaAziendaSelezionata()) return;

      const tabellaHTML = creaTabellaRischiEstesa('REVOCA');
      mostraModal('visualizzazioneModal', 'Rischi a Revoca', tabellaHTML);
    }

    function visualizzaRischiAutoliquidanti() {
      if (!verificaAziendaSelezionata()) return;

      const tabellaHTML = creaTabellaRischiEstesa('AUTOLIQUIDANTI');
      mostraModal('visualizzazioneModal', 'Rischi Autoliquidanti', tabellaHTML);
    }

    function visualizzaRischiScadenza() {
      if (!verificaAziendaSelezionata()) return;

      const tabellaHTML = creaTabellaRischiEstesa('SCADENZA');
      mostraModal('visualizzazioneModal', 'Rischi a Scadenza', tabellaHTML);
    }

    // ==========================================
    // TABELLE RISCHI ESTESE - TUTTI I 60 MESI + 11 COLONNE
    // ==========================================
    function creaTabellaRischiEstesa(tipoRischio) {
      const azienda = archivioAziende[aziendaCorrente];

      // FORZA TUTTI I MESI DISPONIBILI FINO A 60 - NESSUNA LIMITAZIONE
      const tuttiMesiDisponibili = Object.keys(azienda.mesi);
      console.log(`üìä Tabella ${tipoRischio} - Mesi totali disponibili:`, tuttiMesiDisponibili.length, tuttiMesiDisponibili);

      const mesiOrdinati = tuttiMesiDisponibili.sort((a, b) => 
        new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a))
      );

      console.log(`üìä Tabella ${tipoRischio} - Mesi ordinati per visualizzazione:`, mesiOrdinati.length, mesiOrdinati);

      // CALCOLA TOTALI ULTIMO MESE per la categoria specifica
      const ultimoMese = mesiOrdinati[0];
      let accordatoUltimoMese = 0;
      let utilizzatoUltimoMese = 0;
      let sconfiniCategoria = [];

      if (ultimoMese) {
        const datiUltimoMese = azienda.mesi[ultimoMese];
        datiUltimoMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.categoria.includes(tipoRischio)) {
              accordatoUltimoMese += rischio.accordatoOperativo;
              utilizzatoUltimoMese += rischio.utilizzato;
            }
          });
        });
      }

      // CALCOLA SCONFINI per questa categoria specifica (TUTTI I MESI FINO A 60)
      mesiOrdinati.forEach(mese => {
        const datiMese = azienda.mesi[mese];
        datiMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.categoria.includes(tipoRischio) && rischio.utilizzato > rischio.accordatoOperativo) {
              const sconfinoImporto = rischio.utilizzato - rischio.accordatoOperativo;
              sconfiniCategoria.push({
                mese: mese,
                intermediario: int.nome,
                categoria: rischio.categoria,
                eccesso: sconfinoImporto
              });
            }
          });
        });
      });

      let html = `
      <div style="width: 95vw; max-width: 1000px; height: 75vh; overflow-y: auto; padding: 15px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                    padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
          <div style="font-weight: bold; color: #ff6b00; margin-bottom: 10px;">
            ULTIMO MESE (${ultimoMese || 'N/D'}): Acc. ‚Ç¨${formatIT(accordatoUltimoMese)} - Util. ‚Ç¨${formatIT(utilizzatoUltimoMese)}
          </div>
          <div style="font-weight: bold; color: #dc3545; margin-bottom: 15px;">
            SCONFINI (${mesiOrdinati.length} mesi): ${sconfiniCategoria.length} episodi
          </div>
        </div>`;

      // Elenco sconfini specifici per questa categoria - FORMATO NUOVO
      if (sconfiniCategoria.length > 0) {
        sconfiniCategoria.forEach(sconfino => {
          const categoriaCorta = sconfino.categoria.replace('RISCHI ', '');
          html += `
      <div style="margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; text-align: center;">
        <strong>${categoriaCorta} - ${sconfino.mese}: ${sconfino.intermediario}<br>
        -SCONFINO: ‚Ç¨${sconfino.eccesso.toLocaleString('it-IT')}</strong>
      </div>
    `;
        });
      }

      html += `
        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 10%;">Mese</th>
              <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 38%;">Banca</th>
              <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Acc.Op.</th>
              <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Utilizzo</th>
              <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 12%;">%</th>
            </tr>
          </thead>
          <tbody>
    `;

      // TABELLA DETTAGLIATA PER TUTTI I MESI DISPONIBILI (FINO A 60)
      mesiOrdinati.forEach(mese => {
        const datiMese = azienda.mesi[mese];

        datiMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.categoria.includes(tipoRischio)) {
              const percUtilizzo = rischio.accordatoOperativo > 0 ? 
                               (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

              const isEccesso = rischio.utilizzato > rischio.accordatoOperativo;
              const bancaShort = int.nome.length > 20 ? int.nome.substring(0, 20) + '...' : int.nome;
              
              // Formato mese compatto: "agosto 2024" -> "ago-24"
              const mesiMap = {
                'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
                'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
                'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
              };
              const meseParts = mese.split(' ');
              const meseCompatto = meseParts.length === 2 ? 
                `${mesiMap[meseParts[0]] || meseParts[0].substring(0,3)}-${meseParts[1].substring(2)}` : 
                mese.substring(0, 6);
              
              const rowStyle = isEccesso ? 'background: rgba(239, 68, 68, 0.1);' : '';

           html += `
      <tr style="border-bottom: 1px solid #eee; ${rowStyle}">
        <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">${meseCompatto}</td>
        <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: left;">${bancaShort}</td>
        <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.accordatoOperativo)}</td>
        <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.utilizzato)}</td>
        <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${percUtilizzo.toFixed(1)}%</td>
      </tr>
    `;
            }
          });
        });
      });

      html += `
          </tbody>
        </table>
      </div>
    `;
    return html;
    }

    // ==========================================
    // TABELLA SCONFINI LIMITATA A 12 MESI - VERSIONE CORRETTA
    // ==========================================
    function creaTabellaUtilizziConSconfini12Mesi() {
      const azienda = archivioAziende[aziendaCorrente];

      // MODIFICA: Limita agli ultimi 12 mesi per sconfini
      const tuttiMesi = Object.keys(azienda.mesi).sort((a, b) => 
        new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a))
      );
      const ultimi12Mesi = tuttiMesi.slice(0, 12);

      console.log(`üìä Tabella Sconfini - Limitata agli ultimi 12 mesi:`, ultimi12Mesi.length, ultimi12Mesi);

      // AGGREGA DATI PER MESE + CATEGORIA (solo ultimi 12 mesi)
      const datiAggregati = {};
      const sconfiniReali = [];

      ultimi12Mesi.forEach(mese => {
        const datiMese = azienda.mesi[mese];

        // Inizializza categorie per il mese
        if (!datiAggregati[mese]) {
          datiAggregati[mese] = {};
        }

        datiMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            const categoria = rischio.categoria;

            // Inizializza categoria se non esiste
            if (!datiAggregati[mese][categoria]) {
              datiAggregati[mese][categoria] = {
                accordato: 0,
                accordatoOperativo: 0,
                utilizzato: 0,

                intermediari: new Set()
              };
            }

            // Accumula valori per categoria
            datiAggregati[mese][categoria].accordato += rischio.accordato;
            datiAggregati[mese][categoria].accordatoOperativo += rischio.accordatoOperativo;
            datiAggregati[mese][categoria].utilizzato += rischio.utilizzato;
            datiAggregati[mese][categoria].garantito += rischio.garantito;
            datiAggregati[mese][categoria].intermediari.add(int.nome);

            // Calcola sconfini reali CON FORMATO NUOVO
            if (rischio.utilizzato > rischio.accordatoOperativo) {
              const sconfinoImporto = rischio.utilizzato - rischio.accordatoOperativo;
              sconfiniReali.push({
                mese: mese,
                intermediario: int.nome,
                categoria: categoria,
                eccesso: sconfinoImporto,
                utilizzato: rischio.utilizzato,
                accordato: rischio.accordatoOperativo
              });
            }
          });
        });
      });

      // INIZIO COSTRUZIONE HTML
      let html = `
      <div class="tabella-container">
        <h3 style="color: var(--primary-color);">Sconfini (Ultimi 12 Mesi)</h3>

        <p style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-style: italic; color: #856404;">
          ‚ö†Ô∏è <strong>Nota:</strong> Questa tabella mostra solo gli ultimi 12 mesi per focus sui sconfini recenti.<br>
          Per vedere tutti i ${tuttiMesi.length} mesi disponibili, usa le tabelle 
          <strong>"RISCHI A REVOCA"</strong>, <strong>"RISCHI AUTOLIQUIDANTI"</strong>, <strong>"RISCHI A SCADENZA"</strong>.
        </p>
      `;

      // SEZIONE SCONFINI EVIDENZIATI
      if (sconfiniReali.length > 0) {
        html += `
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: var(--danger-color); margin-bottom: 10px;">Sconfini (Ultimi 12 Mesi)</h3>
            <div style="font-size: 2.5em; font-weight: bold; color: var(--danger-color); margin-bottom: 20px;">${sconfiniReali.length}</div>
        `;

        sconfiniReali.forEach(item => {
          const categoriaCorta = item.categoria.replace('RISCHI ', '');
          html += `
            <div style="margin-bottom: 15px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
              <div style="font-weight: bold; font-size: 1.1em; color: var(--text-primary);">
                ${categoriaCorta} - ${item.mese}: ${item.intermediario}<br>
                -SCONFINO: ‚Ç¨${item.eccesso.toLocaleString('it-IT')}
              </div>
            </div>
          `;
        });

        html += `
          </div>
        `;
      } else {
        html += `
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: var(--success-color); margin-bottom: 10px;">‚úÖ Nessun Sconfino (Ultimi 12 Mesi)</h3>
            <div style="font-size: 2.5em; font-weight: bold; color: var(--success-color); margin-bottom: 20px;">0</div>
            <p style="color: var(--success-color); font-weight: 600;">
              Ottima gestione del credito negli ultimi 12 mesi!
            </p>
          </div>
        `;
      }

      // INIZIO TABELLA
      html += `
        <table class="tabella-cr">
          <thead>
            <tr>
              <th>Mese</th>
              <th>Intermediario</th>
              <th>Categoria</th>
              <th>Accordato</th>
              <th>Accordato Op.</th>
              <th>Utilizzato</th>

              <th>% Utilizzo</th>
              <th>Durata</th>
            </tr>
          </thead>
          <tbody>
      `;

      // TABELLA AGGREGATA PER MESE/CATEGORIA (solo ultimi 12 mesi)
      Object.keys(datiAggregati).forEach(mese => {
        Object.keys(datiAggregati[mese]).forEach(categoria => {
          const dati = datiAggregati[mese][categoria];
          const percUtilizzo = dati.accordatoOperativo > 0 ? 
                             (dati.utilizzato / dati.accordatoOperativo * 100) : 0;

          const durata = categoria.includes('SCADENZA') ? 'LUNGO TERMINE' : 'BREVE TERMINE';
          const isEccesso = dati.utilizzato > dati.accordatoOperativo;
          const classeRiga = isEccesso ? 'utilizzo-eccesso' : '';

          // Intermediari coinvolti
          const intermediariList = Array.from(dati.intermediari).join(', ');
          const intermediarioMostrato = dati.intermediari.size === 1
            ? intermediariList
            : `TOTALI (${dati.intermediari.size} banche)`;

          // Riga tabella
          html += `
            <tr class="${classeRiga}">
              <td>${mese}</td>
              <td>${intermediarioMostrato}</td>
              <td>${categoria}</td>
              <td>${dati.accordato.toLocaleString('it-IT')}</td>
              <td>${dati.accordatoOperativo.toLocaleString('it-IT')}</td>
              <td>${dati.utilizzato.toLocaleString('it-IT')}</td>

              <td>${percUtilizzo.toFixed(1)}%</td>
              <td>${durata}</td>
            </tr>
          `;
        });
      });

      // CHIUSURA TABELLA E STATISTICHE
      html += `
          </tbody>
        </table>
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <h4 style="color: var(--info-color); margin-bottom: 10px;">üìä Statistiche Sconfini:</h4>
          <p><strong>Periodo analizzato:</strong> Ultimi ${ultimi12Mesi.length} mesi</p>
          <p><strong>Sconfini totali:</strong> ${sconfiniReali.length}</p>
          <p><strong>Mesi disponibili totali:</strong> ${tuttiMesi.length}</p>
          <p style="margin-top: 10px; color: var(--primary-color);">
            <strong>‚ÑπÔ∏è Per l'analisi completa di tutti i ${tuttiMesi.length} mesi, usa le tabelle specifiche per categoria.</strong>
          </p>
        </div>
      </div>
      `;

      return html;
    }

    // AGGIORNA FUNZIONE VISUALIZZA SCONFINI
    function visualizzaTabellaUtilizzi() {
      if (!verificaAziendaSelezionata()) return;

      const tabellaHTML = creaTabellaUtilizziConSconfini12Mesi();
      mostraModal('visualizzazioneModal', 'Sconfini (Ultimi 12 Mesi)', tabellaHTML);
    }

    // ==========================================
    // GRAFICI AGGIORNATI - 12 MESI INVECE DI 6
    // ==========================================
    function preparaDatiGrafici12Mesi(azienda) {
      // FORZA TUTTI I MESI DISPONIBILI - NESSUNA LIMITAZIONE per le tabelle
      const tuttiMesiDisponibili = Object.keys(azienda.mesi);
      console.log('üìä Grafici - Mesi totali disponibili:', tuttiMesiDisponibili.length, tuttiMesiDisponibili);

      const tuttiMesi = tuttiMesiDisponibili.sort((a, b) => 
        new Date(parseMeseAnno(a)) - new Date(parseMeseAnno(b))
      );

      // USA 12 MESI PER GRAFICI (non pi√π 6)
      const ultimi12MesiGrafici = tuttiMesi.slice(-12);
      console.log('üìä Grafici - Ultimi 12 mesi per visualizzazione:', ultimi12MesiGrafici.length, ultimi12MesiGrafici);

      const dati = {
        mesi: tuttiMesi, // Tutti per tabelle
        mesiGrafici: ultimi12MesiGrafici, // 12 per grafici
        categorieRischi: {
          revoca: 0,
          autoliquidanti: 0,
          scadenza: 0,
          garanzie: 0
        },
        tipologieMensili: {
          revoca: [],
          autoliquidanti: [],
          scadenza: []
        }
      };

      // ELABORA DATI PER GLI ULTIMI 12 MESI (per grafici)
      ultimi12MesiGrafici.forEach(mese => {
        let revocaMese = 0, autoMese = 0, scadenzaMese = 0, garanzieMese = 0;

        azienda.mesi[mese].intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            // Categorizza rischi
            if (rischio.categoria.includes('REVOCA')) {
              revocaMese += rischio.utilizzato;
              dati.categorieRischi.revoca += rischio.utilizzato;
            } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
              autoMese += rischio.utilizzato;
              dati.categorieRischi.autoliquidanti += rischio.utilizzato;
            } else if (rischio.categoria.includes('SCADENZA')) {
              scadenzaMese += rischio.utilizzato;
              dati.categorieRischi.scadenza += rischio.utilizzato;
            }

            if (rischio.garantito > 0) {
              garanzieMese += rischio.garantito;
              dati.categorieRischi.garanzie += rischio.garantito;
            }
          });
        });

        dati.tipologieMensili.revoca.push(revocaMese);
        dati.tipologieMensili.autoliquidanti.push(autoMese);
        dati.tipologieMensili.scadenza.push(scadenzaMese);
      });

      return dati;
    }

    // ==========================================
    // GRAFICO BARRE 12 MESI - AGGIORNATO
    // ==========================================
    // ==========================================
// FIX GRAFICO SCONFINI - BARRA ROSSA VISIBILE
// Sostituisci la funzione creaBarreChart_12Mesi nel tuo anacrisk.html
// ==========================================

function creaBarreChart_12Mesi(azienda, dati) {
  const ctx = document.getElementById('barreChart');
  if (!ctx) return;

  // Destroy existing chart to avoid conflicts
  if (ctx.chart) {
    ctx.chart.destroy();
  }

  // USA TABELLA B con ultimi 12 mesi
  const tabellaB = creaTabellaAndamentaleMensile(azienda);
  const ultimi12Mesi = tabellaB.mesi.slice(-12);

  if (ultimi12Mesi.length === 0) {
    console.warn('Nessun dato disponibile per il grafico barre');
    ctx.innerHTML = '<div style="text-align: center; padding: 50px;">Nessun dato disponibile</div>';
    return;
  }

  console.log(`üìä Grafico Barre - Usando ${ultimi12Mesi.length} mesi:`, ultimi12Mesi.map(m => m.mese));

  const labels = ultimi12Mesi.map(item => item.mese);

  // Calcola sconfini per ogni barra - LOGICA CORRETTA
  const barreData = [];
  let hasSconfini = false;
  let maxSconfino = 0;

  ultimi12Mesi.forEach(item => {
    // REVOCA
    const accRevoca = item.accRevoca || 0;
    const utilizzatoRevoca = item.utilizzatoRevoca || 0;
    const sconfinoRevoca = utilizzatoRevoca > accRevoca ? utilizzatoRevoca - accRevoca : 0;
    const utilizzatoRevocaNormale = utilizzatoRevoca - sconfinoRevoca;

    // AUTOLIQUIDANTI  
    const accAutoliq = item.accAutoliquidanti || 0;
    const utilizzatoAutoliq = item.utilizzatoAutoliquidanti || 0;
    const sconfinoAutoliq = utilizzatoAutoliq > accAutoliq ? utilizzatoAutoliq - accAutoliq : 0;
    const utilizzatoAutoliqNormale = utilizzatoAutoliq - sconfinoAutoliq;

    // SCADENZA
    const accScadenza = item.accScadenza || 0;
    const utilizzatoScadenza = item.utilizzatoScadenza || 0;
    const sconfinoScadenza = utilizzatoScadenza > accScadenza ? utilizzatoScadenza - accScadenza : 0;
    const utilizzatoScadenzaNormale = utilizzatoScadenza - sconfinoScadenza;

    // TOTALE SCONFINI CORRETTO
    const totaleSconfini = sconfinoRevoca + sconfinoAutoliq + sconfinoScadenza;

    // Tracking per alert
    if (totaleSconfini > 0) {
      hasSconfini = true;
      maxSconfino = Math.max(maxSconfino, totaleSconfini);
    }

    barreData.push({
      mese: item.mese,
      accRevoca,
      utilizzatoRevocaNormale,
      sconfinoRevoca,
      accAutoliq,
      utilizzatoAutoliqNormale, 
      sconfinoAutoliq,
      accScadenza,
      utilizzatoScadenzaNormale,
      sconfinoScadenza,
      totaleSconfini
    });
  });

  console.log('üìä Dati barre calcolati:', barreData);
  console.log('üö® Ha sconfini:', hasSconfini, 'Max sconfino:', maxSconfino);

  // CONFIGURAZIONE CHART.JS CORRETTA
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        // REVOCA (3 datasets)
        {
          label: 'Accordato Revoca',
          data: barreData.map(item => item.accRevoca),
          backgroundColor: '#3b82f6',
          borderColor: '#1d4ed8',
          borderWidth: 1,
          stack: 'revoca'
        },
        {
          label: 'Utilizzato Revoca',
          data: barreData.map(item => item.utilizzatoRevocaNormale),
          backgroundColor: '#60a5fa',
          borderColor: '#3b82f6',
          borderWidth: 1,
          stack: 'revoca'
        },
        {
          label: 'Sconfino Revoca',
          data: barreData.map(item => item.sconfinoRevoca),
          backgroundColor: '#ef4444',
          borderColor: '#dc2626',
          borderWidth: 2,
          stack: 'revoca'
        },

        // AUTOLIQUIDANTI (3 datasets)
        {
          label: 'Accordato Autoliq',
          data: barreData.map(item => item.accAutoliq),
          backgroundColor: '#06b6d4',
          borderColor: '#0891b2',
          borderWidth: 1,
          stack: 'autoliq'
        },
        {
          label: 'Utilizzato Autoliq',
          data: barreData.map(item => item.utilizzatoAutoliqNormale),
          backgroundColor: '#22d3ee',
          borderColor: '#06b6d4',
          borderWidth: 1,
          stack: 'autoliq'
        },
        {
          label: 'Sconfino Autoliq',
          data: barreData.map(item => item.sconfinoAutoliq),
          backgroundColor: '#ef4444',
          borderColor: '#dc2626',
          borderWidth: 2,
          stack: 'autoliq'
        },

        // SCADENZA (3 datasets)
        {
          label: 'Accordato Scadenza',
          data: barreData.map(item => item.accScadenza),
          backgroundColor: '#7c3aed',
          borderColor: '#8b5cf6',
          borderWidth: 1,
          stack: 'scadenza'
        },
        {
          label: 'Utilizzato Scadenza',
          data: barreData.map(item => item.utilizzatoScadenzaNormale),
          backgroundColor: '#c084fc',
          borderColor: '#a855f7',
          borderWidth: 1,
          stack: 'scadenza'
        },
        {
          label: 'Sconfino Scadenza',
          data: barreData.map(item => item.sconfinoScadenza),
          backgroundColor: '#ef4444',
          borderColor: '#dc2626',
          borderWidth: 2,
          stack: 'scadenza'
        },

        // BARRA ROSSA TOTALE SCONFINI - FIX PRINCIPALE!
        {
          label: 'üö® TOTALE SCONFINI',
          data: barreData.map(item => {
            // FIX: Rendi visibili anche sconfini piccoli con valore minimo
            if (item.totaleSconfini > 0) {
              // Se c'√® uno sconfino, assicura che sia almeno 1000‚Ç¨ per essere visibile
              return Math.max(item.totaleSconfini, 1000);
            }
            return null;
          }),
          backgroundColor: '#dc2626',
          borderColor: '#b91c1c',
          borderWidth: 3,
          stack: 'sconfini_totale',  // Stack separato per essere sempre visibile
          order: 0,  // Porta in primo piano
          barThickness: 'flex',  // Spessore flessibile
          maxBarThickness: 50,   // Spessore massimo
          minBarLength: 5        // Lunghezza minima della barra
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      // BARRE PI√ô LARGHE - UPGRADE FINALE
      barPercentage: 0.9,
      categoryPercentage: 0.8,
      plugins: {
        title: {
          display: true,
          text: `Accordato vs Utilizzato con Sconfini (${ultimi12Mesi.length} Mesi)`,
          font: { size: 14, weight: 'bold' }
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 11 },
            // Evidenzia la legenda sconfini
            generateLabels: function(chart) {
              const original = Chart.defaults.plugins.legend.labels.generateLabels;
              const labels = original.call(this, chart);

              return labels.map(label => {
                if (label.text.includes('TOTALE SCONFINI')) {
                  label.fontColor = '#dc2626';
                  label.fontStyle = 'bold';
                }
                return label;
              });
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#ff6b00',
          borderWidth: 1,
          callbacks: {
            title: function(context) {
              return `üìÖ ${context[0].label}`;
            },
            label: function(context) {
              const value = context.parsed.y;
              const label = context.dataset.label;

              // Evidenzia sconfini nel tooltip
              if (label.includes('Sconfino') || label.includes('TOTALE SCONFINI')) {
                if (value > 0) {
                  return `üö® ${label}: ‚Ç¨${value.toLocaleString('it-IT')} (SCONFINO!)`;
                } else {
                  return `‚úÖ ${label}: ‚Ç¨0 (Nessuno sconfino)`;
                }
              }

              return `${label}: ‚Ç¨${value.toLocaleString('it-IT')}`;
            }
          }
        }
      },
      scales: {
        x: {
          stacked: false,  // Non stackare sull'asse X per vedere barre separate
          grid: { display: false },
          ticks: {
            font: { size: 10 },
            maxRotation: 45
          }
        },
        y: {
          beginAtZero: true,
          stacked: false,  // Non stackare per vedere tutte le barre
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: {
            font: { size: 10 },
            callback: function(value) {
              return '‚Ç¨' + (value >= 1000 ? (value/1000).toFixed(0) + 'K' : value);
            }
          }
        }
      }
    }
  });

  // Salva riferimento al chart
  ctx.chart = chart;

  // AGGIUNGE AVVISO SCONFINI SE PRESENTI
  if (hasSconfini) {
    setTimeout(() => {
      const container = ctx.parentElement;
      let avviso = container.querySelector('.avviso-sconfini');

      if (!avviso) {
        avviso = document.createElement('div');
        avviso.className = 'avviso-sconfini';
        avviso.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
          border: 2px solid #ef4444;
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 0.85em;
          font-weight: bold;
          color: #dc2626;
          z-index: 100;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        `;

        avviso.innerHTML = `üö® SCONFINI RILEVATI<br><span style="font-size: 0.8em;">Max: ‚Ç¨${maxSconfino.toLocaleString('it-IT')}</span>`;
        container.style.position = 'relative';
        container.appendChild(avviso);
      }
    }, 500);
  }

  // AGGIUNGE NOTA INFORMATIVA
  setTimeout(() => {
    const container = ctx.parentElement.parentElement;
    let nota = container.querySelector('.nota-grafico');

    if (!nota) {
      nota = document.createElement('div');
      nota.className = 'nota-grafico';
      nota.style.cssText = `
        margin-top: 15px;
        padding: 15px;
        background: #fff3e0;
        border-radius: 8px;
        border-left: 4px solid var(--warning-color);
        font-size: 0.9em;
        line-height: 1.6;
      `;

      nota.innerHTML = `
        <p style="margin: 0; font-style: italic; color: #856404;">
          <strong>üìä Nota:</strong> Grafico aggiornato agli ultimi ${ultimi12Mesi.length} mesi. 
          La barra rossa "üö® TOTALE SCONFINI" evidenzia gli sconfini cumulativi per mese.
          ${hasSconfini ? '<br><strong>‚ö†Ô∏è ATTENZIONE:</strong> Sono presenti sconfini nel periodo analizzato.' : '<br><strong>‚úÖ OK:</strong> Nessuno sconfino rilevato nel periodo.'}
        </p>
      `;

      container.appendChild(nota);
    }
  }, 1000);

  console.log('‚úÖ Grafico barre 12 mesi creato con fix sconfini');
}

    // ==========================================
    // TRE LINEE TIPOLOGIE - 12 MESI
    // ==========================================
   // ==========================================
// FIX TRE LINEE CHART 12 MESI - ANDAMENTO TIPOLOGIE
// Sostituisci anche questa funzione nel tuo anacrisk.html
// ==========================================

function creaTreLineeChart12Mesi(azienda, dati) {
  const ctx = document.getElementById('treLineeChart');
  if (!ctx) {
    console.warn('Canvas treLineeChart non trovato');
    return;
  }

  // Destroy existing chart to avoid conflicts
  if (ctx.chart) {
    ctx.chart.destroy();
  }

  // USA GLI ULTIMI 12 MESI dai dati calcolati
  const ultimi12Labels = dati.mesiGrafici; // Gi√† limitati a 12
  const ultimi12Revoca = dati.tipologieMensili.revoca; // Gi√† limitati a 12
  const ultimi12Auto = dati.tipologieMensili.autoliquidanti; // Gi√† limitati a 12  
  const ultimi12Scadenza = dati.tipologieMensili.scadenza; // Gi√† limitati a 12

  console.log(`üìà Tre Linee - Usando ${ultimi12Labels.length} mesi:`, ultimi12Labels);
  console.log('üìä Dati linee:', {
    revoca: ultimi12Revoca,
    autoliquidanti: ultimi12Auto,
    scadenza: ultimi12Scadenza
  });

  // Verifica che ci siano dati
  if (ultimi12Labels.length === 0) {
    ctx.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Nessun dato disponibile per il grafico linee</div>';
    return;
  }

  // Crea il grafico a linee
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ultimi12Labels,
      datasets: [
        {
          label: 'Rischi a Revoca',
          data: ultimi12Revoca.map(val => Math.round(val / 1000)), // Converti in migliaia
          borderColor: '#ff6b00',
          backgroundColor: 'rgba(255, 107, 0, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#ff6b00',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2
        },
        {
          label: 'Autoliquidanti',
          data: ultimi12Auto.map(val => Math.round(val / 1000)), // Converti in migliaia
          borderColor: '#20c997',
          backgroundColor: 'rgba(32, 201, 151, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#20c997',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2
        },
        {
          label: 'A Scadenza',
          data: ultimi12Scadenza.map(val => Math.round(val / 1000)), // Converti in migliaia
          borderColor: '#4299e1',
          backgroundColor: 'rgba(66, 153, 225, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#4299e1',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        title: {
          display: true,
          text: `Andamento per Tipologia (${ultimi12Labels.length} Mesi)`,
          font: { size: 14, weight: 'bold' },
          color: '#333'
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 11 }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#ff6b00',
          borderWidth: 1,
          callbacks: {
            title: function(context) {
              return `üìÖ ${context[0].label}`;
            },
            label: function(context) {
              const value = context.parsed.y;
              const label = context.dataset.label;

              // Formato migliorato per il tooltip
              if (value >= 1000) {
                return `${label}: ‚Ç¨${value.toLocaleString('it-IT')}K`;
              } else {
                return `${label}: ‚Ç¨${(value * 1000).toLocaleString('it-IT')}`;
              }
            },
            footer: function(tooltipItems) {
              // Calcola il totale per il mese
              const totale = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
              return `üìä Totale: ‚Ç¨${totale.toLocaleString('it-IT')}K`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { 
            display: true,
            color: 'rgba(0,0,0,0.05)'
          },
          ticks: {
            font: { size: 10 },
            maxRotation: 45,
            color: '#666'
          },
          title: {
            display: true,
            text: 'Periodo (Mesi)',
            font: { size: 11, weight: 'bold' },
            color: '#333'
          }
        },
        y: {
          beginAtZero: true,
          grid: { 
            color: 'rgba(0,0,0,0.1)'
          },
          ticks: {
            font: { size: 10 },
            color: '#666',
            callback: function(value) {
              // Formato asse Y in migliaia
              if (value >= 1000) {
                return '‚Ç¨' + (value/1000).toFixed(0) + 'M';
              }
              return '‚Ç¨' + value + 'K';
            }
          },
          title: {
            display: true,
            text: 'Importo (‚Ç¨K)',
            font: { size: 11, weight: 'bold' },
            color: '#333'
          }
        }
      },
      // Animazione fluida
      animation: {
        duration: 1000,
        easing: 'easeInOutQuart'
      }
    }
  });

  // Salva riferimento al chart
  ctx.chart = chart;

  // AGGIUNGE NOTA INFORMATIVA per le tre linee
  setTimeout(() => {
    const container = ctx.parentElement.parentElement;
    let nota = container.querySelector('.nota-tre-linee');

    if (!nota) {
      nota = document.createElement('div');
      nota.className = 'nota-tre-linee';
      nota.style.cssText = `
        margin-top: 15px;
        padding: 15px;
        background: #e8f5e8;
        border-radius: 8px;
        border-left: 4px solid #20c997;
        font-size: 0.9em;
        line-height: 1.6;
      `;

      // Calcola i trend per le note
      const calcolaTrend = (dati) => {
        if (dati.length < 2) return 'stabile';
        const primo = dati[0];
        const ultimo = dati[dati.length - 1];
        const variazione = ((ultimo - primo) / primo) * 100;

        if (variazione > 5) return 'crescita';
        if (variazione < -5) return 'decrescita';
        return 'stabile';
      };

      const trendRevoca = calcolaTrend(ultimi12Revoca);
      const trendAuto = calcolaTrend(ultimi12Auto);
      const trendScadenza = calcolaTrend(ultimi12Scadenza);

      const emojiTrend = {
        crescita: 'üìà',
        decrescita: 'üìâ',
        stabile: '‚û°Ô∏è'
      };

      nota.innerHTML = `
        <p style="margin: 0; color: #155724;">
          <strong>üìà Andamento Tipologie (${ultimi12Labels.length} mesi):</strong><br>
          ${emojiTrend[trendRevoca]} <strong>Revoca:</strong> Trend ${trendRevoca}<br>
          ${emojiTrend[trendAuto]} <strong>Autoliquidanti:</strong> Trend ${trendAuto}<br>
          ${emojiTrend[trendScadenza]} <strong>A Scadenza:</strong> Trend ${trendScadenza}
        </p>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #666;">
          üí° <strong>Suggerimento:</strong> Monitora i trend per identificare variazioni significative nell'utilizzo per tipologia di rischio.
        </p>
      `;

      container.appendChild(nota);
    }
  }, 800);

  console.log('‚úÖ Grafico tre linee 12 mesi creato con successo');
}

    // ==========================================
    // EVOLUZIONE RATING 12 MESI
    // ==========================================
    function creaEvoluzioneChart12Mesi(azienda, dati) {
      const ctx = document.getElementById('evoluzioneChart');
      if (!ctx) return;

      const ratingMensili = [];

      // Usa gli ultimi 12 mesi
      dati.mesiGrafici.forEach(mese => {
        const ratingMese = calcolaRatingMese(azienda, mese);
        const coeff = coefficientiMCC[azienda.naturaGiuridica];

        if (coeff && ratingMese) {
          const c1 = ratingMese.percentualeUtilizzo || 0;
          const dc1 = 0;
          const dc3 = ratingMese.sconfinoScadenza ? 1 : 0;
          const c2 = ratingMese.mesiEccesso || 0;

          const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) *
                                      ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

          const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) +
                        (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) +
                        coeff.COSTANTE + correzione;

          const classe = classiMCC.find(cl => score > cl.min && score <= cl.max);
          const classeNumero = classe ? parseInt(classe.classe.replace('CR', '')) : 6;
          ratingMensili.push(classeNumero);
        } else {
          ratingMensili.push(6);
        }
      });

      // Crea grafico
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dati.mesiGrafici,
          datasets: [{
            label: 'Rating MCC',
            data: ratingMensili,
            borderColor: '#ff6b00',
            backgroundColor: 'rgba(255, 107, 0, 0.1)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: '#ff6b00',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
           y: {
  min: 1,
  max: 11,
  reverse: true,
  ticks: {
    stepSize: 1,
    min: 1,
    max: 11,
    autoSkip: false,
    callback: (value) => `CR${value}`
  }
}
          },
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: `Evoluzione Rating (Ultimi ${dati.mesiGrafici.length} Mesi)`
            }
          }
        }
      });
    }

    // ==========================================
    // AGGIORNA FUNZIONE INIZIALIZZA GRAFICI
    // ==========================================
    function inizializzaGrafici12Mesi() {
      try {
        const azienda = archivioAziende[aziendaCorrente];

        // USA NUOVA FUNZIONE CON 12 MESI
        const datiGrafici = preparaDatiGrafici12Mesi(azienda);

        creaBarreChart_12Mesi(azienda, datiGrafici);
        creaTortaChart(azienda, datiGrafici);
        creaEvoluzioneChart12Mesi(azienda, datiGrafici);
        creaTreLineeChart12Mesi(azienda, datiGrafici);

        const mesiUsati = datiGrafici.mesiGrafici.length;
        showToast(`üìä Grafici generati con ${mesiUsati} mesi!`, 'success');

      } catch (error) {
        console.error('Errore inizializzazione grafici:', error);
        showToast('‚ùå Errore generazione grafici', 'error');
      }
    }

    // ==========================================
    // AGGIORNA VISUALIZZAZIONE GRAFICI - USA 12 MESI
    // ==========================================
    function visualizzaGraficiAndamentali() {
      if (!verificaAziendaSelezionata()) return;

      // Verifica Chart.js disponibile
      if (!window.Chart) {
        showToast('‚ùå Chart.js non disponibile - Verifica librerie', 'error');
        return;
      }

      const graficiHTML = creaGraficiHTML12Mesi();
      mostraModal('visualizzazioneModal', 'üìä Grafici Andamentali CR (12 Mesi)', graficiHTML);

      setTimeout(() => {
        inizializzaGrafici12Mesi();
      }, 200);
    }

    function creaGraficiHTML12Mesi() {
      const azienda = archivioAziende[aziendaCorrente];
      const mesiDisponibili = Object.keys(azienda.mesi).length;

      const contenuto = `
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
          <h4 style="color: var(--info-color); margin-bottom: 10px;">üìä Grafici Aggiornati v1.4 FINALE</h4>
          <p style="margin: 0; color: var(--text-primary);">
            <strong>Mesi disponibili:</strong> ${mesiDisponibili} | 
            <strong>Grafici:</strong> Ultimi 12 mesi | 
            <strong>Tabelle rischi:</strong> Tutti i ${mesiDisponibili} mesi
          </p>
        </div>

        <div class="grafici-grid-1x4">

          <div class="grafico-card">
            <div class="grafico-header">
              <span style="font-size: 1.5em;">üìä</span>
              <h4>Accordato vs Utilizzato con Sconfini (12 Mesi)</h4>
            </div>
            <div class="chart-container">
              <canvas id="barreChart"></canvas>
            </div>
          </div>

          <div class="grafico-card">
            <div class="grafico-header">
              <span style="font-size: 1.5em;">ü•ß</span>
              <h4>Distribuzione Rischi (12 Mesi)</h4>
            </div>
            <div class="chart-container">
              <canvas id="tortaChart"></canvas>
            </div>
          </div>

          <div class="grafico-card">
            <div class="grafico-header">
              <span style="font-size: 1.5em;">üìà</span>
              <h4>Evoluzione Rating (12 Mesi)</h4>
            </div>
            <div class="chart-container">
              <canvas id="evoluzioneChart"></canvas>
            </div>
          </div>

          <div class="grafico-card">
            <div class="grafico-header">
              <span style="font-size: 1.5em;">üìà</span>
              <h4>Andamento per Tipologia (12 Mesi)</h4>
            </div>
            <div class="chart-container">
              <canvas id="treLineeChart"></canvas>
            </div>
          </div>

        </div>
      `;

      return contenuto;
    }

    // ==========================================
    // DISTRIBUZIONE RISCHI (TORTA) - AGGIORNATA
    // ==========================================
    function creaTortaChart(azienda, dati) {
      const ctx = document.getElementById('tortaChart');
      if (!ctx) return;

      const totali = Object.values(dati.categorieRischi);
      const somma = totali.reduce((a, b) => a + b, 0);

      if (somma === 0) {
        ctx.innerHTML = '<div style="text-align: center; padding: 50px;">Nessun dato disponibile</div>';
        return;
      }

      console.log('üìä Torta - Dati categorie:', dati.categorieRischi);

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Rischi a Revoca', 'Autoliquidanti', 'A Scadenza', 'Garanzie'],
          datasets: [{
            data: [
              dati.categorieRischi.revoca,
              dati.categorieRischi.autoliquidanti,
              dati.categorieRischi.scadenza,
              dati.categorieRischi.garanzie
            ],
            backgroundColor: ['#ff6b00', '#20c997', '#4299e1', '#ed8936'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const percentage = ((context.parsed / somma) * 100).toFixed(1);
                  return `${context.label}: ‚Ç¨${(context.parsed / 1000).toFixed(0)}K (${percentage}%)`;
                }
              }
            },
            title: {
              display: true,
              text: 'Distribuzione Rischi (Ultimi 12 Mesi)'
            }
          }
        }
      });
    }

    // ==========================================
    // RATING MENSILI CON TUTTI I MESI (FINO A 60)
    // ==========================================
    function creaTabellaRatingMensiliCompleta() {
      const azienda = archivioAziende[aziendaCorrente];
      const coeff = coefficientiMCC[azienda.naturaGiuridica];

      // FORZA TUTTI I MESI DISPONIBILI - NESSUNA LIMITAZIONE
      const tuttiMesiDisponibili = Object.keys(azienda.mesi);
      console.log('üìä Rating mensili - Mesi totali disponibili:', tuttiMesiDisponibili.length, tuttiMesiDisponibili);

      const mesiOrdinati = tuttiMesiDisponibili.sort((a, b) => 
        new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a))
      );

      console.log('üìä Rating mensili - Mesi ordinati:', mesiOrdinati.length, mesiOrdinati);

      let html = `
      <div class="tabella-container">
        <h3>TABELLA C - Rating MCC per Mese (${azienda.naturaGiuridica}) - TUTTI I ${mesiOrdinati.length} MESI</h3>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0; color: var(--info-color); font-weight: 600;">
            üìä <strong>Analisi Completa:</strong> Visualizzando tutti i ${mesiOrdinati.length} mesi disponibili per rating MCC dettagliato
          </p>
        </div>

        <table class="tabella-cr">
          <thead>
            <tr>
              <th>Mese</th>
              <th>C1* (%)</th>
              <th>DC1</th>
              <th>DC3</th>
              <th>C2</th>
              <th>Score</th>
              <th>Classe</th>
              <th>Descrizione</th>
            </tr>
          </thead>
          <tbody>
    `;

      mesiOrdinati.forEach((mese, index) => {
        const rating = calcolaRatingMese(azienda, mese);

        const c1 = rating.percentualeUtilizzo;
        const dc1 = 0;
        const dc3 = rating.sconfinoScadenza ? 1 : 0;
        const c2 = rating.mesiEccesso;

        const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                                    ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

        const score = (c1 * coeff.C1_COEFF) + 
                      (dc1 * coeff.DC1_COEFF) + 
                      (dc3 * coeff.DC3_COEFF) + 
                      (c2 * coeff.C2_COEFF) + 
                      coeff.COSTANTE + 
                      correzione;

        const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                       { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };

        // EVIDENZIAZIONE: Solo l'ultimo mese (indice 0) ha background diverso
       const isUltimoMese = index === 0;
    const classeRiga = isUltimoMese 
      ? 'style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); font-weight: bold;"'
      : '';

    html += `
      <tr ${classeRiga}>
        <td>${mese}${isUltimoMese ? ' ‚≠ê' : ''}</td>
        <td>${(c1 * 100).toFixed(2)}%</td>
        <td>${dc1}</td>
        <td>${dc3}</td>
        <td>${c2}</td>
        <td>${score.toFixed(3)}</td>
        <td>${classe.classe}</td>
        <td>${classe.descr} ${classe.emoji}</td>
      </tr>
    `;
      });

      html += `
        </tbody>
      </table>

      <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="color: var(--success-color); margin-bottom: 10px;">
          Coefficienti utilizzati (${azienda.naturaGiuridica}):
        </h4>
        <p>C1*: ${coeff.C1_COEFF} | DC1: ${coeff.DC1_COEFF} | DC3: ${coeff.DC3_COEFF} | C2: ${coeff.C2_COEFF}</p>
        <p>Costante: ${coeff.COSTANTE} | Fatt1: ${coeff.FATTORE_CORR_1} | Fatt2: ${coeff.FATTORE_CORR_2}</p>
        <p style="margin-top: 10px; color: var(--primary-color);"><strong>‚≠ê = Ultimo mese (evidenziato)</strong></p>
        <p style="margin-top: 10px; color: var(--info-color);">
          <strong>üìä Mesi analizzati: ${mesiOrdinati.length} (tutti disponibili)</strong>
        </p>
      </div>
    </div>
    `;

    return html;
    }

    function visualizzaRatingMensili() {
      if (!verificaAziendaSelezionata()) return;

      const tabellaHTML = creaTabellaRatingMensiliCompleta();
      mostraModal('visualizzazioneModal', 'Rating Mensili (Tabella C) - COMPLETA', tabellaHTML);
    }

    function visualizzaAltreInformazioni() {
  // Rimuovi eventuali modali esistenti
  const oldModal = document.getElementById("estrattoreModal");
  if (oldModal) oldModal.remove();

  const modalHtml = `
    <div id="estrattoreModal" style="
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
      <div style="
  width: 1400px;
  max-width: 99vw;
  height: 92vh;
  min-height: 700px;
  overflow-y: auto;
  background: #fff;
  border-radius: 18px;
  padding: 0 0 28px 0;
  box-shadow: 0 10px 50px rgba(0,0,0,0.32);
  position: relative;
  display: flex;
  flex-direction: column;
">

        <div style="display: flex; justify-content: space-between; align-items: center; background: var(--primary-color); color: white; padding: 16px 28px; border-radius: 18px 18px 0 0;">
          <h3 style="margin: 0; font-size: 1.25em; color: white; letter-spacing: 0.5px;">üîç Altre informazioni Centrale Rischi</h3>
          <button onclick="document.getElementById('estrattoreModal').remove()" style="background: none; border: none; color: white; font-size: 2.1em; cursor: pointer;">&times;</button>
        </div>
        <div style="display: flex; gap: 12px; margin: 18px 0 0 0; justify-content: center;">
          <button class="btn-fifo info" onclick="switchAltreInfoTab('crediti')" id="btnAltreInfoCrediti">üí∞ Analisi Crediti Clienti</button>
          <button class="btn-fifo info" onclick="switchAltreInfoTab('garanzie')" id="btnAltreInfoGaranzie">üõ°Ô∏è Garanzie Ricevute</button>
          <button class="btn-fifo info" onclick="switchAltreInfoTab('richieste')" id="btnAltreInfoRichieste">üìã Richieste Informazione</button>
        </div>
        <div id="contenutoAltreInfo" style="padding: 20px 28px 0 28px; min-height: 230px;">
          <!-- Qui caricherai il contenuto -->
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  // Mostra per default la tab crediti
  setTimeout(()=>switchAltreInfoTab('crediti'),100);
}

function switchAltreInfoTab(tab) {
  // Cambia stile pulsanti attivi
  ['crediti','garanzie','richieste'].forEach(t=>{
    const btn = document.getElementById('btnAltreInfo'+capitalize(t));
    if(btn) btn.style.background = (tab===t) ? 'linear-gradient(135deg, #ff6b00, #ff9533)' : '#17a2b8';
    if(btn) btn.style.color = (tab===t) ? 'white' : 'white';
  });
  // Carica il contenuto della tab richiesta
  let html = '';
  if(tab==='crediti'){
  html += `
    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
      <!-- SEZIONE GRAFICI -->
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="color: #ff6b00; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
          üìä Grafici Analisi Crediti
        </h4>
        <div id="graficiCrediti"></div>
      </div>

      <!-- SEZIONE TABELLA -->
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="color: #ff6b00; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
          üìã Dettaglio Mensile
        </h4>
        <div style="text-align: center; margin-bottom: 15px;">
          <button class="btn-fifo primary" onclick="mostraTabellaCrediti()" style="background: #ff6b00; padding: 12px 24px;">
            üëÅÔ∏è Mostra Tabella Dettagliata
          </button>
        </div>
        <div id="tabellaCreditiDettaglio" style="display:none;"></div>
      </div>
    </div>`;
}

  if(tab==='garanzie'){
    html += `<div>
      <h4 style="color: #2dce89; margin: 0 0 8px 0;"> Garanzie Ricevute</h4>
      <div id="tabellaGaranzie"></div>
    </div>`;
  }
  if(tab==='richieste'){
    html += `<div>
      <h4 style="color: #4299e1; margin: 0 0 8px 0;"> Richieste Informazione</h4>
      <div id="tabellaRichieste"></div>
    </div>`;
  }

  document.getElementById('contenutoAltreInfo').innerHTML = html;
  // Se sono su una delle tab, carico i dati (se disponibili)
  if(tab==='crediti') aggiornaAltreInfoCrediti();
  if(tab==='garanzie') aggiornaAltreInfoGaranzie();
  if(tab==='richieste') aggiornaAltreInfoRichieste();
}

function aggiornaAltreInfoCrediti() {
  console.log('üîç DEBUG aggiornaAltreInfoCrediti START');
  console.log('üìã Container graficiCrediti exists:', !!document.getElementById('graficiCrediti'));
  console.log('üéØ Funzione renderGraficiCrediti exists:', typeof renderGraficiCrediti);

  // Ripristina il breakdown dai dati salvati
  console.log('üîç [DEBUG] Verifico archivio azienda per breakdown...');
  console.log('üîç [DEBUG] archivioAziende[aziendaCorrente]?.altreInformazioni:', archivioAziende[aziendaCorrente]?.altreInformazioni);
  
  if(archivioAziende[aziendaCorrente]?.altreInformazioni?.creditiRawBreakdown) {
    window._creditiRawBreakdown = archivioAziende[aziendaCorrente].altreInformazioni.creditiRawBreakdown;
    console.log('‚úÖ Breakdown ripristinato dall\'archivio:', Object.keys(window._creditiRawBreakdown).length, 'mesi');
  } else {
    console.log('‚ùå Nessun breakdown salvato nell\'archivio');
  }

  // Popola i grafici crediti e la tabella dettaglio - USA SEMPRE TUTTI I MESI per card "Altre Informazioni"
  const azienda = archivioAziende[aziendaCorrente];
  if(azienda?.altreInformazioni?.crediti && azienda.altreInformazioni.crediti.length > 0){
    console.log('‚úÖ Dati crediti trovati (tutti i mesi), chiamo renderGraficiCrediti');
    if(typeof renderGraficiCrediti === 'function'){
      renderGraficiCrediti(azienda.altreInformazioni.crediti, 'graficiCrediti');
      console.log('‚úÖ renderGraficiCrediti chiamata con tutti i mesi');
    } else {
      console.error('‚ùå renderGraficiCrediti non √® una funzione');
    }
    // Nascondi tabella dettaglio all'apertura
    const tabDett = document.getElementById('tabellaCreditiDettaglio');
    if(tabDett) tabDett.style.display = 'none';
  } else {
    console.log('‚ùå Nessun dato crediti, mostro messaggio vuoto');
    const graf = document.getElementById('graficiCrediti');
    if(graf) {
      graf.innerHTML = '<div class="no-data">Nessun dato crediti importato</div>';
      console.log('‚úÖ Messaggio "nessun dato" inserito');
    } else {
      console.error('‚ùå Container graficiCrediti non trovato!');
    }
  }
  console.log('üîç DEBUG aggiornaAltreInfoCrediti END');
}

function mostraTabellaCrediti() {
  console.log('üîç DEBUG mostraTabellaCrediti START');
  console.log('üìã window._creditiAnalisi:', window._creditiAnalisi);
  console.log('üìã Funzione renderTabellaCrediti exists:', typeof renderTabellaCrediti);

  const container = document.getElementById('tabellaCreditiDettaglio');
  if (!container) {
    console.error('‚ùå Container tabellaCreditiDettaglio non trovato');
    return;
  }

  // Ripristina il breakdown dai dati salvati se non √® presente
  if(!window._creditiRawBreakdown && archivioAziende[aziendaCorrente]?.altreInformazioni?.creditiRawBreakdown) {
    window._creditiRawBreakdown = archivioAziende[aziendaCorrente].altreInformazioni.creditiRawBreakdown;
    console.log('‚úÖ Breakdown ripristinato per tabella:', Object.keys(window._creditiRawBreakdown).length, 'mesi');
  }

  // Per card "Altre Informazioni" usa SEMPRE tutti i mesi dall'archivio
  const azienda = archivioAziende[aziendaCorrente];
  let datiCrediti = null;

  if (azienda?.altreInformazioni?.crediti && azienda.altreInformazioni.crediti.length > 0) {
    datiCrediti = azienda.altreInformazioni.crediti;
    console.log('‚úÖ Usando tutti i mesi dall\'archivio per tabella crediti');
  } else {
    console.log('‚ùå Nessun dato crediti trovato nell\'archivio');
    container.innerHTML = '<div class="no-data">Nessun dato crediti disponibile per la tabella</div>';
    container.style.display = 'block';
    return;
  }

  if (typeof renderTabellaCrediti === 'function') {
    container.innerHTML = renderTabellaCrediti(datiCrediti);
    container.style.display = 'block';
    console.log('‚úÖ Tabella crediti renderizzata');
  } else {
    console.error('‚ùå Funzione renderTabellaCrediti non trovata');
    container.innerHTML = '<div class="no-data">Funzione renderTabellaCrediti non disponibile</div>';
    container.style.display = 'block';
  }
}

function aggiornaAltreInfoGaranzie() {
  // Popola la tabella garanzie - USA SEMPRE TUTTI I MESI per card "Altre Informazioni"
  const azienda = archivioAziende[aziendaCorrente];
  if (azienda?.altreInformazioni?.garanzie && azienda.altreInformazioni.garanzie.length > 0) {
    if(typeof renderTabellaGaranzie === 'function'){
      document.getElementById('tabellaGaranzie').innerHTML = renderTabellaGaranzie(azienda.altreInformazioni.garanzie);
    } else {
      document.getElementById('tabellaGaranzie').innerHTML = '<div class="no-data">Funzione renderTabellaGaranzie non disponibile</div>';
    }
  } else {
    const gar = document.getElementById('tabellaGaranzie');
    if(gar) gar.innerHTML = '<div class="no-data">Nessuna garanzia trovata</div>';
  }
}

function aggiornaAltreInfoRichieste() {
  // Popola la tabella richieste informazioni - USA SEMPRE TUTTI I MESI per card "Altre Informazioni"
  const azienda = archivioAziende[aziendaCorrente];
  if (azienda?.altreInformazioni?.richieste && azienda.altreInformazioni.richieste.length > 0) {
    if(typeof renderTabellaRichieste === 'function'){
      document.getElementById('tabellaRichieste').innerHTML = renderTabellaRichieste(azienda.altreInformazioni.richieste);
    } else {
      document.getElementById('tabellaRichieste').innerHTML = '<div class="no-data">Funzione renderTabellaRichieste non disponibile</div>';
    }
  } else {
    const rich = document.getElementById('tabellaRichieste');
    if(rich) rich.innerHTML = '<div class="no-data">Nessuna richiesta informazioni trovata</div>';
  }
}

function aggiornaAltreInfoSofferenze() {
  // Aggiorna tabelle crediti e garanzie con dati salvati
  const tabCrediti = document.getElementById('tabellaCrediti');
  if(tabCrediti) {
    if (archivioAziende[aziendaCorrente]?.altreInformazioni?.crediti && 
        archivioAziende[aziendaCorrente].altreInformazioni.crediti.length > 0) {
      if (typeof renderTabellaCrediti === 'function') {
        tabCrediti.innerHTML = renderTabellaCrediti(archivioAziende[aziendaCorrente].altreInformazioni.crediti);
      } else {
        tabCrediti.innerHTML = '<div class="no-data">Funzione renderTabellaCrediti non disponibile</div>';
      }
    } else {
      tabCrediti.innerHTML = '<div class="no-data">Nessun credito scaduto/autoliquidante trovato</div>';
    }
  }

  const tabGaranzie = document.getElementById('tabellaGaranzie');
  if(tabGaranzie) {
    if (archivioAziende[aziendaCorrente]?.altreInformazioni?.garanzie && 
        archivioAziende[aziendaCorrente].altreInformazioni.garanzie.length > 0) {
      if (typeof renderTabellaGaranzie === 'function') {
        tabGaranzie.innerHTML = renderTabellaGaranzie(archivioAziende[aziendaCorrente].altreInformazioni.garanzie);
      } else {
        tabGaranzie.innerHTML = '<div class="no-data">Funzione renderTabellaGaranzie non disponibile</div>';
      }
    } else {
      tabGaranzie.innerHTML = '<div class="no-data">Nessuna garanzia trovata</div>';
    }
  }

  // Placeholder per future sofferenze
  const soff = document.getElementById('tabellaSofferenze');
  if(soff) soff.innerHTML = '<div class="no-data">Segnalazioni e sofferenze in sviluppo</div>';
}

function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}

// ==========================================
// FUNZIONI COMPLETE ALTRE INFORMAZIONI
// ==========================================

function renderGraficiCrediti(creditiArr, containerId) {
  const container = document.getElementById(containerId || 'graficiCrediti');
  if (!container) {
    console.log('Container grafici non trovato:', containerId);
    return;
  }

  if (!creditiArr || !creditiArr.length) {
    container.innerHTML = '<div class="no-data">Nessun dato crediti disponibile</div>';
    return;
  }

// SVUOTA IL CONTAINER E CREA CANVAS CON ID UNIVOCI
  const timestamp = Date.now();
  const idLinea = `graficoLinea_${timestamp}`;
  const idBarre = `graficoBarre_${timestamp}`;

  container.innerHTML = `
    <div class="chart-container" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px;">
      <h5 style="margin: 0 0 15px 0; color: #dc3545; text-align: center; font-size: 16px;">üìà Percentuale Insoluti</h5>
      <canvas id="${idLinea}"></canvas>
    </div>
    <div class="chart-container" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px;">
      <h5 style="margin: 0 0 15px 0; color: #28a745; text-align: center; font-size: 16px;">üìä Pagati vs Impagati</h5>
      <canvas id="${idBarre}"></canvas>
    </div>
  `;

  setTimeout(() => {
    const mesi = creditiArr.map(c => formatMeseCorto(c.mese));
    const pagati = creditiArr.map(c => c.pagati);
    const impagati = creditiArr.map(c => c.impagati);
    const percentuali = creditiArr.map(c => c.percentualeInsoluti);

    new Chart(document.getElementById(idLinea).getContext('2d'), {
      type: 'line',
      data: {
        labels: mesi,
        datasets: [{
          label: '% Insoluti',
          data: percentuali,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220,53,69,0.15)',
          pointBackgroundColor: '#dc3545',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          tension: 0.3,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        plugins: { 
          legend: { 
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: { size: 12 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#dc3545',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
              }
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            title: { display: true, text: '% Insoluti', font: { size: 11 } },
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { 
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: { 
            title: { display: true, text: 'Mese', font: { size: 11 } },
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { 
              maxRotation: 45,
              font: { size: 10 }
            }
          }
        }
      }
    });

    new Chart(document.getElementById(idBarre).getContext('2d'), {
      type: 'bar',
      data: {
        labels: mesi,
        datasets: [
          { 
            label: 'Pagati', 
            data: pagati, 
            backgroundColor: '#28a745',
            borderColor: '#1e7e34',
            borderWidth: 1,
            hoverBackgroundColor: '#218838',
            hoverBorderColor: '#1e7e34',
            hoverBorderWidth: 2
          },
          { 
            label: 'Impagati', 
            data: impagati, 
            backgroundColor: '#fd7e14',
            borderColor: '#fd6c00',
            borderWidth: 1,
            hoverBackgroundColor: '#e8690d',
            hoverBorderColor: '#fd6c00',
            hoverBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        plugins: { 
          legend: { 
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: { size: 12 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#28a745',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ‚Ç¨${context.parsed.y.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            title: { display: true, text: 'Valore (‚Ç¨)', font: { size: 11 } }, 
            stacked: true,
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { 
              callback: function(value) {
                return '‚Ç¨' + value.toLocaleString();
              }
            }
          },
          x: { 
            stacked: true, 
            title: { display: true, text: 'Mese', font: { size: 11 } },
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { 
              maxRotation: 45,
              font: { size: 10 }
            }
          }
        }
      }
    });
  }, 100);
}
function renderTabellaCrediti(arr) {
  if (!arr.length) return '<div class="no-data">Nessun credito trovato</div>';
  
  // Funzione per convertire formato mese
  function formatMeseCompatto(mese) {
    const mesiMap = {
      'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
      'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
      'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
    };
    
    const parti = mese.toLowerCase().split(' ');
    if (parti.length === 2) {
      const meseNome = mesiMap[parti[0]] || parti[0].slice(0, 3);
      const anno = parti[1].slice(-2);
      return `${meseNome}-${anno}`;
    }
    return mese;
  }
  
  let html = `<div style="display: flex; justify-content: center; margin: 20px 0;">
    <table style="width: 90%; max-width: 1000px; border-collapse: collapse; margin: 0 auto;">
      <thead>
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 8px; width: 80px; font-size: 12px;">Mese</th>
          <th style="border: 1px solid #ddd; padding: 8px; width: 120px; font-size: 12px;">Pagati</th>
          <th style="border: 1px solid #ddd; padding: 8px; width: 120px; font-size: 12px;">Impagati</th>
          <th style="border: 1px solid #ddd; padding: 8px; width: 120px; font-size: 12px;">Totale</th>
          <th style="border: 1px solid #ddd; padding: 8px; width: 60px; font-size: 12px;">Insoluti</th>
          <th style="border: 1px solid #ddd; padding: 8px; width: 40px; font-size: 12px;">üîç</th>
        </tr>
      </thead>
      <tbody>`;
  
  arr.forEach((c) => {
    html += `<tr>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: center;">${formatMeseCompatto(c.mese)}</td>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: right;">‚Ç¨${formatIT(c.pagati)}</td>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: right;">‚Ç¨${formatIT(c.impagati)}</td>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: right;">‚Ç¨${formatIT(c.totale)}</td>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: center; width: 60px;">${c.percentualeInsoluti.toFixed(1)}%</td>
      <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">
        <button onclick="mostraBreakdownCrediti('${c.mese}', this)" style="background: #007bff; color: white; border: none; padding: 3px 6px; border-radius: 3px; font-size: 10px;">üîç</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  return html;
}

function renderTabellaGaranzie(arr) {
  if (!arr.length) return '<div class="no-data">Nessuna garanzia trovata nell\'ultimo mese</div>';
  
  // Funzione per convertire formato mese
  function formatMeseCompatto(mese) {
    const mesiMap = {
      'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
      'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
      'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
    };
    
    const parti = mese.toLowerCase().split(' ');
    if (parti.length === 2) {
      const meseNome = mesiMap[parti[0]] || parti[0].slice(0, 3);
      const anno = parti[1].slice(-2);
      return `${meseNome}-${anno}`;
    }
    return mese;
  }
  
  let html = `<div style="display: flex; justify-content: center; margin: 20px 0;">
    <table style="width: 95%; max-width: 1000px; border-collapse: collapse; margin: 0 auto;">
      <thead>
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 6px; font-size: 11px; width: 60px;">Mese</th>
          <th style="border: 1px solid #ddd; padding: 6px; font-size: 11px; width: 50px;">Codice</th>
          <th style="border: 1px solid #ddd; padding: 6px; font-size: 11px; width: 300px;">Garante</th>
          <th style="border: 1px solid #ddd; padding: 6px; font-size: 11px; width: 80px; text-align: right;">Garantito</th>
          <th style="border: 1px solid #ddd; padding: 6px; font-size: 11px; width: 80px; text-align: right;">Valore</th>
        </tr>
      </thead>
      <tbody>`;
  arr.forEach(g => {
    const meseCompatto = formatMeseCompatto(g.mese);
    html += `<tr>
      <td style="border: 1px solid #ddd; padding: 4px; font-size: 10px; text-align: center;">${meseCompatto}</td>
      <td style="border: 1px solid #ddd; padding: 4px; font-size: 10px; text-align: center;">${g.codiceCensito}</td>
      <td style="border: 1px solid #ddd; padding: 4px; font-size: 10px; word-wrap: break-word; max-width: 300px;" title="${g.nome}">${g.nome}</td>
      <td style="border: 1px solid #ddd; padding: 4px; font-size: 10px; text-align: right;">‚Ç¨${formatIT(g.importoGarantito)}</td>
      <td style="border: 1px solid #ddd; padding: 4px; font-size: 10px; text-align: right;">‚Ç¨${formatIT(g.valoreGaranzia)}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  return html;
}

function renderTabellaRichieste(arr) {
  if (!arr.length) return '<div class="no-data">Nessuna richiesta informazioni trovata</div>';
  let html = `<div style="display: flex; justify-content: center; margin: 20px 0;">
    <table style="width: 90%; max-width: 800px; border-collapse: collapse; margin: 0 auto;">
      <thead>
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 8px; font-size: 12px; width: 120px; color: #e67e22;">Data Richiesta</th>
          <th style="border: 1px solid #ddd; padding: 8px; font-size: 12px; color: #e67e22;">Intermediario</th>
        </tr>
      </thead>
      <tbody>`;
  arr.forEach(r => {
    html += `<tr>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; text-align: center; color: #333;">${r.data}</td>
      <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px; word-wrap: break-word; color: #333;">${r.intermediario}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  return html;
}

window.mostraBreakdownCrediti = function(mese, btn) {
  const overlay = document.getElementById("breakdownOverlay");
  if (!overlay) return;

  const dati = (window._creditiRawBreakdown && window._creditiRawBreakdown[mese]) ? window._creditiRawBreakdown[mese] : [];

  let t = `
    <div style="background: white; border-radius: 12px; padding: 25px; max-width: 800px; margin: 20px auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 999999;">
      <button onclick="document.getElementById('breakdownOverlay').style.display='none'" style="position: absolute; top: 10px; right: 15px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; z-index: 999999;">&times;</button>
      <h3 style="text-align: center; margin-bottom: 20px;">üîç Dettaglio ${mese}</h3>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8f9fa;">
            <th style="padding: 12px; border: 1px solid #ddd;">Intermediario</th>
            <th style="padding: 12px; border: 1px solid #ddd;">Pagati</th>
            <th style="padding: 12px; border: 1px solid #ddd;">Impagati</th>
            <th style="padding: 12px; border: 1px solid #ddd;">Totale</th>
            <th style="padding: 12px; border: 1px solid #ddd;">% Insoluti</th>
          </tr>
        </thead>
        <tbody>`;

  let totalPagati = 0, totalImpagati = 0;
  dati.forEach(r => {
    const pagati = r.pagati||0, impagati = r.impagati||0, tot = pagati+impagati, perc = tot ? (impagati/tot)*100 : 0;
    totalPagati += pagati; totalImpagati += impagati;
    const intermediario = r.intermediario || 'N/D';
    t += `<tr>
      <td style="padding: 10px; border: 1px solid #ddd;">${intermediario}</td>
      <td style="padding: 10px; border: 1px solid #ddd;">‚Ç¨${formatIT(pagati)}</td>
      <td style="padding: 10px; border: 1px solid #ddd;">‚Ç¨${formatIT(impagati)}</td>
      <td style="padding: 10px; border: 1px solid #ddd;">‚Ç¨${formatIT(tot)}</td>
      <td style="padding: 10px; border: 1px solid #ddd;">${perc.toFixed(2)}%</td>
    </tr>`;
  });

  const tot = totalPagati + totalImpagati, percTot = tot ? (totalImpagati/tot)*100 : 0;
  t += `</tbody>
    <tfoot>
      <tr style="background: #e9ecef; font-weight: bold;">
        <td style="padding: 12px; border: 1px solid #ddd;">TOTALE</td>
        <td style="padding: 12px; border: 1px solid #ddd;">‚Ç¨${formatIT(totalPagati)}</td>
        <td style="padding: 12px; border: 1px solid #ddd;">‚Ç¨${formatIT(totalImpagati)}</td>
        <td style="padding: 12px; border: 1px solid #ddd;">‚Ç¨${formatIT(tot)}</td>
        <td style="padding: 12px; border: 1px solid #ddd;">${percTot.toFixed(2)}%</td>
      </tr>
    </tfoot>
  </table>
    </div>`;

  overlay.style.display = "flex";
  overlay.style.zIndex = "999999";
  overlay.innerHTML = t;
};

function mostraTabellaCrediti() {
  const container = document.getElementById('tabellaCreditiDettaglio');
  if (!container) return;

  let dati = window._creditiAnalisi || archivioAziende[aziendaCorrente]?.altreInformazioni?.crediti || [];

  if (dati.length > 0) {
    container.innerHTML = renderTabellaCrediti(dati);
    container.style.display = 'block';
  } else {
    container.innerHTML = '<div class="no-data">Nessun dato disponibile</div>';
    container.style.display = 'block';
  }
}
function chiudiEstrattore() {
  const modal = document.getElementById('estrattoreModal');
  if (modal) {
    modal.remove();
  }
}


    // ==========================================
    // CALCOLO SCONFINI AGGIORNATO
    // ==========================================
    function calcolaSconfini(azienda) {
      const sconfini = {
        totale: 0,
        dettagli: []
      };

      // TUTTI I MESI DISPONIBILI per sconfini
      Object.keys(azienda.mesi).forEach(mese => {
        const datiMese = azienda.mesi[mese];

        datiMese.intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.utilizzato > rischio.accordatoOperativo) {
              sconfini.totale++;
              sconfini.dettagli.push({
                mese: mese,
                intermediario: int.nome,
                categoria: rischio.categoria,
                eccesso: rischio.utilizzato - rischio.accordatoOperativo
              });
            }
          });
        });
      });

      return sconfini;
    }

    function salvaAnalisiAndamentale() {
      if (!verificaAziendaSelezionata()) return;

      const azienda = archivioAziende[aziendaCorrente];
      const timestamp = new Date();
      const analisi = {
        timestamp: timestamp.toISOString(),
        azienda: {
          cf: azienda.anagrafica.cf,
          denominazione: azienda.anagrafica.denominazione,
          naturaGiuridica: azienda.naturaGiuridica
        },
        periodo: {
          da: Object.keys(azienda.mesi).sort((a, b) =>
            new Date(parseMeseAnno(a)) - new Date(parseMeseAnno(b))
          )[0],
          a: Object.keys(azienda.mesi).sort((a, b) =>
            new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a))
          )[0]
        },
        rating: calcolaRatingMCC(azienda),
        numeroMesi: Object.keys(azienda.mesi).length,
        sconfini: calcolaSconfini(azienda),
        pathSuggerito: "archivio/dati/reportcrisk/",
        versione: "v1.4 FINALE - 60 mesi tabelle + 12 mesi grafici"
      };

      // NOME FILE UNICO: anacrisk_CF_YYYYMMDD_HHMMSS.json
      const dataStr = timestamp.toISOString().slice(0, 10).replace(/-/g, '');
      const oraStr = timestamp.toTimeString().slice(0, 8).replace(/:/g, '');
      const nomeFile = `anacrisk_${azienda.anagrafica.cf}_${dataStr}_${oraStr}.json`;

      const blob = new Blob([JSON.stringify(analisi, null, 2)], {
        type: 'application/json'
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nomeFile;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      contatori.analisiGenerate++;
      salvaDatiLocali();

      showToast(`üíæ Analisi v1.4 FINALE salvata: ${nomeFile}`, 'success');
      showToast(`üìÅ Sposta in: archivio/dati/reportcrisk/`, 'info');
    }

    // ==========================================
    // FUNZIONI SIDEBAR (COMPLETE)
    // ==========================================
    function visualizzaDateInserite() {
      if (!verificaAziendaSelezionata()) return;

      const azienda = archivioAziende[aziendaCorrente];
      const mesi = Object.keys(azienda.mesi).sort((a, b) => 
        new Date(parseMeseAnno(b)) - new Date(parseMeseAnno(a))
      );

      const html = `
        <div class="tabella-container">
          <h3>üìÖ Date Inserite (${mesi.length} mesi)</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            ${mesi.map((mese, index) => `
              <div style="background: ${index === 0 ? '#fff3e0' : '#f8f9fa'}; 
                          padding: 15px; border-radius: 8px; text-align: center;
                          border-left: 4px solid ${index === 0 ? 'var(--primary-color)' : 'var(--info-color)'};">
                <strong>${mese}${index === 0 ? ' ‚≠ê' : ''}</strong><br>
                <small>${index === 0 ? 'Ultimo mese' : `${index + 1}¬∞ mese`}</small>
              </div>
            `).join('')}
          </div>
          <p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
            <strong>üìä Riepilogo:</strong> ${mesi.length} mesi disponibili da ${mesi[mesi.length - 1]} a ${mesi[0]}
          </p>
        </div>
      `;

      mostraModal('visualizzazioneModal', 'üìÖ Date Inserite', html);
    }

    function generaReportCRPeriodo() {
      if (!verificaAziendaSelezionata()) return;
      const azienda = archivioAziende[aziendaCorrente];
      const mesiDisponibili = Object.keys(azienda.mesi).length;

      if (mesiDisponibili === 0) {
        alert("‚ö†Ô∏è Carica prima i dati CR!");
        return;
      }

      if (!window.jsPDF) {
        showToast('jsPDF non disponibile - Cambia modalit√† o carica librerie', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      let doc = new jsPDF({ unit: "pt", format: "a4", orientation: "landscape" });

      // INTESTAZIONE
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(230, 83, 0);
      doc.text("ceoDOC.it - ANALISI CENTRALE RISCHI", 40, 40);

      doc.setFontSize(12);
      doc.setTextColor(22, 61, 122);
      doc.text("Generato il: " + new Date().toLocaleDateString('it-IT'), 600, 40);

      doc.setFontSize(10);
      doc.setTextColor(102, 126, 234);
      doc.text("www.ceoDOC.it", 40, 55);

      let y = 80;

      // DATI AZIENDA
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.setTextColor(29, 53, 87);
      doc.text("DATI AZIENDA", 40, y);
      y += 25;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Denominazione: ${azienda.denominazione}`, 40, y); y += 16;
      doc.text(`Codice Fiscale: ${azienda.anagrafica.cf}`, 40, y); y += 16;
      doc.text(`Sede Legale: ${azienda.anagrafica.sedeLegale}`, 40, y); y += 16;
      doc.text(`Natura Giuridica: ${azienda.naturaGiuridica || 'Non specificata'}`, 40, y); y += 30;

      // RATING
      const mesiOrdinati = Object.keys(azienda.mesi).sort();
      const ultimoMese = mesiOrdinati[mesiOrdinati.length - 1];
      const mesiRecenti12 = mesiOrdinati.slice(-12);

      if (ultimoMese && azienda.mesi[ultimoMese]) {
        const ratingUltimo = calcolaRatingMese(azienda.mesi[ultimoMese], azienda.naturaGiuridica);
        const rating12Mesi = calcolaRatingPeriodo(mesiRecenti12.map(m => azienda.mesi[m]));

        let colDestra = 420;
        let yDestra = 105;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 0);
        doc.text("RATING MCC v1.4", colDestra, yDestra);
        yDestra += 25;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(22, 61, 122);

        doc.text(`Rating Ultimo Mese (${ultimoMese}): ${ratingUltimo.classe}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Rating 12 Mesi: ${rating12Mesi.classe} - ${rating12Mesi.descrizione}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Mesi Analizzati: ${mesiDisponibili} / 60`, colDestra, yDestra); yDestra += 20;

        doc.setFont("helvetica", "bold");
        doc.setFillColor(255, 243, 224);
        doc.rect(colDestra - 10, yDestra - 10, 300, 25, "F");
        doc.setTextColor(230, 83, 0);
        doc.text(`RATING FINALE: ${rating12Mesi.classe}`, colDestra, yDestra + 8);
      }

      // Salvataggio PDF
      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      const nomeFile = `ceoDOC_CR_${azienda.anagrafica.cf}_${timestamp}.pdf`;
      doc.save(nomeFile);

      alert(`‚úÖ Report PDF esportato!\n\nFile: ${nomeFile}\nAzienda: ${azienda.denominazione}\nMesi: ${mesiDisponibili}\n\nPercorso: ceoDoc\\archivio\\dati\\reportcrisk\\`);
    }

    function visualizzaAnalisiCRPeriodo() {
      if (!verificaAziendaSelezionata()) return;
      const mesiDisponibili = Object.keys(archivioAziende[aziendaCorrente].mesi).sort();
      if (mesiDisponibili.length === 0) {
        showToast('‚ùå Nessun dato CR disponibile per l\'azienda selezionata', 'error');
        return;
      }

      // Creazione form selezione periodo
      const formSelezione = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="color: var(--primary-color); margin-bottom: 15px;">üìÖ Seleziona Periodo di Analisi</h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label style="font-weight: bold; color: var(--text-primary);">Dal mese:</label>
              <select id="meseDa" style="width: 100%; padding: 8px; border: 2px solid var(--primary-color); border-radius: 6px;">
               ${ordinaMesiCronologicamente(mesiDisponibili).map(mese => 
  `<option value="${mese}">${mese}</option>`
).join('')}
              </select>
            </div>
            <div>
              <label style="font-weight: bold; color: var(--text-primary);">Al mese:</label>
              <select id="meseA" style="width: 100%; padding: 8px; border: 2px solid var(--primary-color); border-radius: 6px;">
                ${ordinaMesiCronologicamente(mesiDisponibili).reverse().map(mese => 
  `<option value="${mese}">${mese}</option>`
).join('')}
              </select>
            </div>
          </div>

          <div style="text-align: center;">
            <button onclick="generaAnalisiPeriodo()" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
              üîç Genera Analisi Periodo
            </button>
          </div>
        </div>

        <div id="risultatiAnalisi" style="display: none;">
          <!-- I risultati verranno inseriti qui -->
        </div>
      `;

      mostraModal('visualizzazioneModal', 'üìä Analisi Centrale Rischi - Periodo', formSelezione);
    }


// ===== FUNZIONE PRINCIPALE: GENERA ANALISI PERIODO =====
function generaAnalisiPeriodo() {
  try {
    // Validazione input base
    const meseDa = document.getElementById('meseDa')?.value;
    const meseA = document.getElementById('meseA')?.value;

    if (!meseDa || !meseA) {
      showToast('‚ùå Seleziona entrambi i mesi', 'error');
      return;
    }

    // Validazione azienda corrente
    if (!aziendaCorrente || !archivioAziende || !archivioAziende[aziendaCorrente]) {
      showToast('‚ùå Nessuna azienda selezionata o dati non disponibili', 'error');
      return;
    }

    const azienda = archivioAziende[aziendaCorrente];

    // Validazione dati azienda
    if (!azienda.mesi || Object.keys(azienda.mesi).length === 0) {
      showToast('‚ùå Nessun dato mensile disponibile per questa azienda', 'error');
      return;
    }

    // Ordinamento cronologico corretto
    const mesiOrdinati = ordinaMesiCronologicamente(Object.keys(azienda.mesi));
    const indiceDa = mesiOrdinati.indexOf(meseDa);
    const indiceA = mesiOrdinati.indexOf(meseA);

    if (indiceDa === -1 || indiceA === -1) {
      showToast('‚ùå Mesi selezionati non validi o non presenti nei dati', 'error');
      return;
    }

    // Calcolo periodo corretto
    const indiceMin = Math.min(indiceDa, indiceA);
    const indiceMax = Math.max(indiceDa, indiceA);
    const mesiPeriodo = mesiOrdinati.slice(indiceMin, indiceMax + 1);

    // Verifica consecutivit√†
    const consecutivita = verificaConsecutivitaMesi(mesiPeriodo);

    // CALCOLO RATING PER IL PERIODO - 3 TIPOLOGIE
    const ultimoMesePeriodo = mesiPeriodo[mesiPeriodo.length - 1];
    const ultimi6MesiPeriodo = mesiPeriodo.slice(-6);
    const ultimi12MesiPeriodo = mesiPeriodo.slice(-12);

    // Rating ultimo mese del periodo
    const ratingUltimo = calcolaRatingMeseSpecifico(azienda, ultimoMesePeriodo);
    console.log('üîç DEBUG Rating Ultimo:', ratingUltimo);

    // Rating ultimi 6 mesi del periodo (se ci sono almeno 6)
    console.log('üîç DEBUG ultimi6MesiPeriodo.length:', ultimi6MesiPeriodo.length);
    const rating6Mesi = ultimi6MesiPeriodo.length >= 6 ? 
      calcolaRatingPeriodoSpecifico(azienda, ultimi6MesiPeriodo) : 
      { score: 0, classe: { classe: 'UNRATED', descr: 'Dati insufficienti (< 6 mesi)', emoji: '‚ùì' } };
    console.log('üîç DEBUG Rating 6 Mesi DOPO CALCOLO:', rating6Mesi);

    // Rating ultimi 12 mesi del periodo (se ci sono almeno 12)
    console.log('üîç DEBUG ultimi12MesiPeriodo.length:', ultimi12MesiPeriodo.length);
    const rating12Mesi = ultimi12MesiPeriodo.length >= 12 ? 
      calcolaRatingPeriodoSpecifico(azienda, ultimi12MesiPeriodo) : 
      { score: 0, classe: { classe: 'UNRATED', descr: 'Dati insufficienti (< 12 mesi)', emoji: '‚ùì' } };
    console.log('üîç DEBUG Rating 12 Mesi DOPO CALCOLO:', rating12Mesi);

    // CALCOLO STATISTICHE COMPLETE PER IL PERIODO
    const statistichePeriodo = calcolaStatistichePeriodoComplete(azienda, mesiPeriodo);

    // CALCOLO SCONFINI PER CATEGORIA NEL PERIODO
    const sconfiniPeriodo = calcolaSconfiniPeriodoCompleti(azienda, mesiPeriodo);

    // GENERAZIONE HTML COMPLETO COME LE TABELLE RISCHI
    const analisiContent = generaHTMLAnalisiPeriodoCompleta(
      meseDa, 
      meseA, 
      mesiPeriodo, 
      consecutivita,
      ratingUltimo,
      rating6Mesi, 
      rating12Mesi,
      statistichePeriodo,
      sconfiniPeriodo,
      azienda
    );

    // Visualizzazione risultato
    const risultatiDiv = document.getElementById('risultatiAnalisi');
    if (risultatiDiv) {
      risultatiDiv.innerHTML = analisiContent;
      risultatiDiv.style.display = 'block';
      risultatiDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      // Salva i mesi del periodo per le modal
      window.mesiPeriodoCorrente = mesiPeriodo;

      // Salva i dati dell'analisi per l'export
      window.ultimaAnalisiGenerata = {
        meseDa, meseA,
        mesiValidi: mesiPeriodo.length,
        mesiPeriodo,
        consecutivita,
        ratingUltimo, rating6Mesi, rating12Mesi,
        statistichePeriodo, sconfiniPeriodo,
        azienda: azienda.anagrafica,
        timestamp: new Date().toISOString()
      };

      // Inizializza grafici e informazioni dettagliate dopo un breve delay
setTimeout(() => {
  inizializzaGraficiPeriodo(azienda, mesiPeriodo);
  inizializzaInformazioniPeriodo(azienda, mesiPeriodo);
}, 300);

showToast(`‚úÖ Analisi completa generata per ${mesiPeriodo.length} mesi`, 'success', 4000);
    } else {
      console.error('Elemento risultatiAnalisi non trovato nel DOM');
      showToast('‚ùå Errore visualizzazione risultati', 'error');
    }

  } catch (error) {
    console.error('Errore in generaAnalisiPeriodo:', error);
    showToast(`‚ùå Errore nell'analisi: ${error.message}`, 'error');
  }
}

// ===== FUNZIONI HELPER PER CALCOLI RATING SPECIFICI =====
function calcolaRatingMeseSpecifico(azienda, mese) {
  const datiMese = azienda.mesi[mese];
  if (!datiMese || !azienda.naturaGiuridica) {
    return { score: 0, classe: { classe: 'UNRATED', descr: 'Dati insufficienti', emoji: '‚ùì' } };
  }

  const coeff = coefficientiMCC[azienda.naturaGiuridica];

  let accAutoliqRevoca = 0, utilizzatoAutoliqRevoca = 0;
  let accScadenza = 0, utilizzatoScadenza = 0;

  datiMese.intermediari.forEach(int => {
    int.rischi.forEach(rischio => {
      if (rischio.categoria.includes('REVOCA') || rischio.categoria.includes('AUTOLIQUIDANTI')) {
        accAutoliqRevoca += rischio.accordatoOperativo;
        utilizzatoAutoliqRevoca += rischio.utilizzato;
      } else if (rischio.categoria.includes('SCADENZA')) {
        accScadenza += rischio.accordatoOperativo;
        utilizzatoScadenza += rischio.utilizzato;
      }
    });
  });

  const c1 = accAutoliqRevoca > 0 ? (utilizzatoAutoliqRevoca / accAutoliqRevoca) : 0;
  const dc1 = 0; // Sempre 0 per singolo mese
  const dc3 = accScadenza > 0 && (utilizzatoScadenza / accScadenza) > 1 ? 1 : 0;
  const c2 = c1 > 1 ? 1 : 0;

  const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                              ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

  const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                coeff.COSTANTE + correzione;

  const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                 { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };
  
  console.log('üîç DEBUG calcolaRatingMeseSpecifico - Score:', score, 'Classe trovata:', classe);

  return { score: score, classe: classe };
}

// FUNZIONE DUPLICATA ELIMINATA - uso quella originale alla linea 8566

// ===== CALCOLO STATISTICHE COMPLETE PER PERIODO =====
function calcolaStatistichePeriodoComplete(azienda, mesiPeriodo) {
  let totaleAccordato = 0, totaleUtilizzato = 0;
  let accordatoRevoca = 0, utilizzatoRevoca = 0;
  let accordatoAutoliq = 0, utilizzatoAutoliq = 0;
  let accordatoScadenza = 0, utilizzatoScadenza = 0;
  let totaleGarantito = 0;

  mesiPeriodo.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    datiMese.intermediari.forEach(int => {
      int.rischi.forEach(rischio => {
        totaleAccordato += rischio.accordatoOperativo;
        totaleUtilizzato += rischio.utilizzato;
        totaleGarantito += rischio.garantito;

        if (rischio.categoria.includes('REVOCA')) {
          accordatoRevoca += rischio.accordatoOperativo;
          utilizzatoRevoca += rischio.utilizzato;
        } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
          accordatoAutoliq += rischio.accordatoOperativo;
          utilizzatoAutoliq += rischio.utilizzato;
        } else if (rischio.categoria.includes('SCADENZA')) {
          accordatoScadenza += rischio.accordatoOperativo;
          utilizzatoScadenza += rischio.utilizzato;
        }
      });
    });
  });

  const numMesi = mesiPeriodo.length;

  return {
    numMesi,
    accordatoMedio: totaleAccordato / numMesi,
    utilizzatoMedio: totaleUtilizzato / numMesi,
    utilizzoPerc: totaleAccordato > 0 ? (totaleUtilizzato / totaleAccordato * 100) : 0,
    acordatoRevocaMedio: accordatoRevoca / numMesi,
    utilizzatoRevocaMedio: utilizzatoRevoca / numMesi,
    acordatoAutoliqMedio: accordatoAutoliq / numMesi,
    utilizzatoAutoliqMedio: utilizzatoAutoliq / numMesi,
    acordatoScadenzaMedio: accordatoScadenza / numMesi,
    utilizzatoScadenzaMedio: utilizzatoScadenza / numMesi,
    garantitoMedio: totaleGarantito / numMesi
  };
}

// ===== CALCOLO SCONFINI COMPLETI PER PERIODO =====
function calcolaSconfiniPeriodoCompleti(azienda, mesiPeriodo) {
  const sconfini = {
    revoca: [],
    autoliquidanti: [],
    scadenza: [],
    totali: 0
  };

  mesiPeriodo.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    datiMese.intermediari.forEach(int => {
      int.rischi.forEach(rischio => {
        if (rischio.utilizzato > rischio.accordatoOperativo) {
          const sconfinoImporto = rischio.utilizzato - rischio.accordatoOperativo;
          const sconfinoItem = {
            mese: mese,
            intermediario: int.nome,
            categoria: rischio.categoria,
            eccesso: sconfinoImporto
          };

          if (rischio.categoria.includes('REVOCA')) {
            sconfini.revoca.push(sconfinoItem);
          } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
            sconfini.autoliquidanti.push(sconfinoItem);
          } else if (rischio.categoria.includes('SCADENZA')) {
            sconfini.scadenza.push(sconfinoItem);
          }
          sconfini.totali++;
        }
      });
    });
  });

  return sconfini;
}

// ===== FUNZIONI SUPPORTO LAYOUT NUOVO =====
// Funzione per inizializzare le informazioni dettagliate del periodo
function inizializzaInformazioniPeriodo(azienda, mesiPeriodo) {
  // Popola grafici crediti
  if (azienda.altreInformazioni?.crediti) {
    const creditiFiltrati = filtraCreditiPerPeriodo(azienda.altreInformazioni.crediti, mesiPeriodo);
    renderGraficiCrediti(creditiFiltrati, 'graficiCrediti');
  }
  
  // Popola tabella sconfini
  const sconfiniPeriodo = calcolaSconfiniPeriodoCompleti(azienda, mesiPeriodo);
  generaTabellaSconfiginiPeriodo(sconfiniPeriodo);

}

// Funzione per generare tabella sconfini del periodo
function generaTabellaSconfiginiPeriodo(sconfiniPeriodo) {
  const container = document.getElementById('tabellaSconfiniPeriodo');
  if (!container) return;
  
  if (!sconfiniPeriodo || sconfiniPeriodo.totali === 0) {
    container.innerHTML = '<div class="no-data">Nessun sconfino nel periodo selezionato</div>';
    return;
  }
  
  let html = '<div style="max-height: 400px; overflow-y: auto;">';
  
  // Sconfini per categoria
  ['revoca', 'autoliquidanti', 'scadenza'].forEach(categoria => {
    const sconfiniCat = sconfiniPeriodo[categoria];
    if (sconfiniCat && sconfiniCat.length > 0) {
      html += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">`;
      html += `<h6 style="color: #f44336; margin: 0 0 8px 0; font-weight: bold;">${categoria.toUpperCase()} (${sconfiniCat.length})</h6>`;
      
      sconfiniCat.forEach(sconfino => {
        html += `<div style="margin-bottom: 5px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #f44336;">`;
        html += `<strong>${sconfino.mese}: ${sconfino.intermediario}</strong><br>`;
        html += `Categoria: ${sconfino.categoria}<br>`;
        html += `Sconfino: ‚Ç¨${sconfino.eccesso?.toLocaleString('it-IT') || '0'}`;
        html += `</div>`;
      });
      
      html += `</div>`;
    }
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Funzione per renderizzare tabella garanzie del periodo
function renderTabellaGaranziePeriodo(garanzieFiltrate) {
  const container = document.getElementById('tabellaGaranziePeriodo');
  if (!container) return;
  
  if (!garanzieFiltrate || garanzieFiltrate.length === 0) {
    container.innerHTML = '<div class="no-data">Nessuna garanzia nel periodo selezionato</div>';
    return;
  }
  
  let html = '<div style="max-height: 400px; overflow-y: auto;">';
  html += '<table style="width: 100%; border-collapse: collapse;">';
  html += '<thead><tr style="background: #4caf50; color: white;">';
  html += '<th style="padding: 10px; text-align: left;">Mese</th>';
  html += '<th style="padding: 10px; text-align: left;">Intermediario</th>';
  html += '<th style="padding: 10px; text-align: left;">Importo</th>';
  html += '<th style="padding: 10px; text-align: left;">Tipo</th>';
  html += '</tr></thead><tbody>';
  
  garanzieFiltrate.forEach((garanzia, index) => {
    const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
    html += `<tr style="background: ${bgColor};">`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${garanzia.mese}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${garanzia.intermediario}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">‚Ç¨${garanzia.importo?.toLocaleString('it-IT') || '0'}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${garanzia.tipo || 'N/A'}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

// Funzione per renderizzare tabella richieste del periodo
function renderTabellaRichiestePeriodo(richiesteFiltrate) {
  const container = document.getElementById('tabellaRichiestePeriodo');
  if (!container) return;
  
  if (!richiesteFiltrate || richiesteFiltrate.length === 0) {
    container.innerHTML = '<div class="no-data">Nessuna richiesta nel periodo selezionato</div>';
    return;
  }
  
  let html = '<div style="max-height: 400px; overflow-y: auto;">';
  html += '<table style="width: 100%; border-collapse: collapse;">';
  html += '<thead><tr style="background: #2196f3; color: white;">';
  html += '<th style="padding: 10px; text-align: left;">Mese</th>';
  html += '<th style="padding: 10px; text-align: left;">Intermediario</th>';
  html += '<th style="padding: 10px; text-align: left;">Tipo</th>';
  html += '<th style="padding: 10px; text-align: left;">Dettagli</th>';
  html += '</tr></thead><tbody>';
  
  richiesteFiltrate.forEach((richiesta, index) => {
    const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
    html += `<tr style="background: ${bgColor};">`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${richiesta.mese}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${richiesta.intermediario}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${richiesta.tipo || 'N/A'}</td>`;
    html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${richiesta.dettagli || 'N/A'}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

// ===== GENERAZIONE HTML COMPLETO COME TABELLE RISCHI =====
function generaHTMLAnalisiPeriodoCompleta(meseDa, meseA, mesiPeriodo, consecutivita, ratingUltimo, rating6Mesi, rating12Mesi, statistiche, sconfini, azienda) {

  // Determinazione colori rating
  const getColorByRating = (classe) => {
    if (['CR1', 'CR2', 'CR3', 'CR4'].includes(classe)) return '#4caf50';
    if (['CR5', 'CR6', 'CR7'].includes(classe)) return '#ff9800';
    return '#f44336';
  };

  const coloreUltimo = getColorByRating(ratingUltimo.classe.classe);
  const colore6Mesi = getColorByRating(rating6Mesi.classe.classe);
  const colore12Mesi = getColorByRating(rating12Mesi.classe.classe);

  return `
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; margin-top: 20px; border: 1px solid #dee2e6;">

      <!-- HEADER PRINCIPALE -->
      <div style="text-align: center; margin-bottom: 25px;">
        <h3 style="color: var(--primary-color, #ff6b00); margin-bottom: 8px; font-size: 1.5em;">
          üìä ANALISI COMPLETA PERIODO SELEZIONATO
        </h3>
        <div style="background: rgba(255,107,0,0.1); padding: 8px 16px; border-radius: 20px; display: inline-block;">
          <strong>${meseDa} ‚ûú ${meseA}</strong> ‚Ä¢ ${mesiPeriodo.length} mesi analizzati
          ${!consecutivita.consecutivi ? ' ‚Ä¢ ‚ö†Ô∏è Non consecutivo' : ' ‚Ä¢ ‚úÖ Consecutivo'}
        </div>
      </div>

      <!-- 3 CARD RATING PROMINENTE PERIODO -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">

        <div style="background: linear-gradient(135deg, ${coloreUltimo}15 0%, ${coloreUltimo}25 100%); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${coloreUltimo};">
          <div style="font-size: 2.2em; margin-bottom: 8px;">${ratingUltimo.classe.emoji}</div>
          <h4 style="color: ${coloreUltimo}; margin: 8px 0;">RATING ULTIMO MESE PERIODO</h4>
          <div style="font-size: 1.8em; font-weight: bold; color: ${coloreUltimo}; margin: 8px 0;">${ratingUltimo.classe.classe}</div>
          <div style="font-size: 0.9em; color: #666; line-height: 1.3;">${ratingUltimo.classe.descr}</div>
          <div style="font-size: 0.8em; color: #888; margin-top: 4px;">Score: ${ratingUltimo.score?.toFixed(3) || 'N/A'}</div>
        </div>

        <div style="background: linear-gradient(135deg, ${colore6Mesi}15 0%, ${colore6Mesi}25 100%); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${colore6Mesi};">
          <div style="font-size: 2.2em; margin-bottom: 8px;">${rating6Mesi.classe.emoji}</div>
          <h4 style="color: ${colore6Mesi}; margin: 8px 0;">RATING 6 MESI PERIODO</h4>
          <div style="font-size: 1.8em; font-weight: bold; color: ${colore6Mesi}; margin: 8px 0;">${rating6Mesi.classe.classe}</div>
          <div style="font-size: 0.9em; color: #666; line-height: 1.3;">${rating6Mesi.classe.descr}</div>
          <div style="font-size: 0.8em; color: #888; margin-top: 4px;">Score: ${rating6Mesi.score?.toFixed(3) || 'N/A'}</div>
        </div>

        <div style="background: linear-gradient(135deg, ${colore12Mesi}15 0%, ${colore12Mesi}25 100%); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid ${colore12Mesi};">
          <div style="font-size: 2.2em; margin-bottom: 8px;">${rating12Mesi.classe.emoji}</div>
          <h4 style="color: ${colore12Mesi}; margin: 8px 0;">RATING 12 MESI PERIODO</h4>
          <div style="font-size: 1.8em; font-weight: bold; color: ${colore12Mesi}; margin: 8px 0;">${rating12Mesi.classe.classe}</div>
          <div style="font-size: 0.9em; color: #666; line-height: 1.3;">${rating12Mesi.classe.descr}</div>
          <div style="font-size: 0.8em; color: #888; margin-top: 4px;">Score: ${rating12Mesi.score?.toFixed(3) || 'N/A'}</div>
        </div>
      </div>

      <!-- CARD STATISTICHE COME TABELLE RISCHI -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--info-color);">
        <div style="font-weight: bold; color: var(--info-color); margin-bottom: 10px;">
          üìä STATISTICHE PERIODO: Accordato Medio ‚Ç¨${statistiche.accordatoMedio?.toLocaleString('it-IT') || '0'} - Utilizzato Medio ‚Ç¨${statistiche.utilizzatoMedio?.toLocaleString('it-IT') || '0'} - Utilizzo: ${statistiche.utilizzoPerc?.toFixed(1) || '0'}%
        </div>
        <div style="font-weight: bold; color: var(--danger-color); margin-bottom: 15px;">
          üö® SCONFINI NEL PERIODO: ${sconfini.totali || 0} episodi (Revoca: ${sconfini.revoca?.length || 0}, Autoliq: ${sconfini.autoliquidanti?.length || 0}, Scadenza: ${sconfini.scadenza?.length || 0})
        </div>
      </div>

      <!-- SEZIONE GRAFICI PERIODO - LAYOUT 2x2 -->
      <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h4 style="color: var(--text-primary, #333); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color, #ff6b00); padding-bottom: 8px;">
          üìä GRAFICI PERIODO (${mesiPeriodo.length} mesi)
        </h4>

        <!-- Layout 1 colonna -->
<div style="display: grid; grid-template-columns: 1fr; gap: 20px; min-height: auto;">
          <!-- Prima riga -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h5 style="text-align: center; margin-bottom: 15px; color: #333;">üìä Accordato vs Utilizzato</h5>
            <div style="position: relative; height: 450px;">
              <canvas id="barreChartPeriodo"></canvas>
            </div>
          </div>

          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h5 style="text-align: center; margin-bottom: 15px; color: #333;">ü•ß Distribuzione Rischi</h5>
            <div style="position: relative; height: 350px;">
              <canvas id="tortaChartPeriodo"></canvas>
            </div>
          </div>

          <!-- Seconda riga -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h5 style="text-align: center; margin-bottom: 15px; color: #333;">üìà Evoluzione Rating</h5>
            <div style="position: relative; height: 450px;">
              <canvas id="lineChartPeriodo"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- SEZIONE INFORMAZIONI PERIODO - SEMPRE VISIBILI -->
      <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h4 style="color: var(--text-primary, #333); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color, #ff6b00); padding-bottom: 8px;">
          üîç INFORMAZIONI DETTAGLIATE PERIODO
        </h4>

        <!-- Grafici Insoluti e Impagati -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h5 style="color: #333; margin-bottom: 15px; text-align: center;">üìä Grafici Insoluti e Impagati</h5>
          <div id="graficiCrediti" style="min-height: 300px;"></div>
        </div>

        <!-- Tabella Sconfini -->
        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f44336;">
          <h5 style="color: #f44336; margin-bottom: 15px;">üö® SCONFINI PERIODO (${sconfini.totali || 0} episodi)</h5>
          <div id="tabellaSconfiniPeriodo"></div>
        </div>


      </div>

      <!-- SEZIONE EXPORT - POSIZIONATA DOPO GRAFICI E PRIMA DELLE TABELLE -->
      <div style="background: linear-gradient(135deg, #ff6b00 0%, #ff8f00 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <h4 style="color: white; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <span style="font-size: 1.5em;">üìÑ</span>
          ESPORTA ANALISI PERIODO
        </h4>

        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
          <button onclick="esportaAnalisiPeriodoHTMLCompleto('${meseDa}', '${meseA}', ${mesiPeriodo.length})" 
                  style="background: rgba(255,255,255,0.9); color: #ff6b00; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; font-size: 1.1em;"
                  onmouseover="this.style.background='white'; this.style.transform='translateY(-2px)'"
                  onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='translateY(0)'">
            <span style="font-size: 1.3em;">üìÑ</span>
            Esporta Analisi
          </button>
        </div>

        <div style="margin-top: 12px; font-size: 0.9em; color: rgba(255,255,255,0.8);">
          üìÅ Export completo con grafici, tabelle e pulsante stampa integrato
        </div>
      </div>

      <!-- SEZIONI RISCHI CON PULSANTI -->
      <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h4 style="color: var(--primary-color, #ff6b00); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color, #ff6b00); padding-bottom: 8px;">
          üìã SEZIONI RISCHI - VISUALIZZA TUTTI I MESI
        </h4>

        <!-- RISCHI A REVOCA -->
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ff6b00; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #ff6b00; margin: 0 0 5px 0;">üìä RISCHI A REVOCA</h5>

            </div>
            <button onclick="visualizzaRischiRevoca()" style="background: #ff6b00; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              üìä Mostra Tabella
            </button>
          </div>
        </div>

        <!-- RISCHI AUTOLIQUIDANTI -->
        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #4caf50; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #4caf50; margin: 0 0 5px 0;">üí∞ RISCHI AUTOLIQUIDANTI</h5>

            </div>
            <button onclick="mostraModalRischiAutoliquidanti()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              üí∞ Mostra Tabella
            </button>
          </div>
        </div>

        <!-- RISCHI A SCADENZA -->
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #2196f3; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #2196f3; margin: 0 0 5px 0;">‚è∞ RISCHI A SCADENZA</h5>

            </div>
            <button onclick="mostraModalRischiScadenza()" style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              ‚è∞ Mostra Tabella
            </button>
          </div>
        </div>

        <!-- RATING MENSILI -->
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ff9800; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #ff9800; margin: 0 0 5px 0;">üìà RATING MENSILI</h5>

            </div>
            <button onclick="mostraModalRatingMensili()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              üìà Mostra Rating
            </button>
          </div>
        </div>

        <!-- SCONFINI -->
        <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #f44336; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #f44336; margin: 0 0 5px 0;">üö® SCONFINI (${sconfini.totali || 0})</h5>

            </div>
            <button onclick="mostraModalSconfini()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              üö® Mostra Sconfini
            </button>
          </div>
        </div>

        <!-- ALTRE INFORMAZIONI -->
        <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #9c27b0; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h5 style="color: #9c27b0; margin: 0 0 5px 0;">üîç ALTRE INFORMAZIONI</h5>

            </div>
            <button onclick="mostraModalAltreInformazioni()" style="background: #9c27b0; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
              üîç Mostra Info
            </button>
          </div>
        </div>
      </div>


    `;  // <-- QUESTA PARENTESI E VIRGOLETTA DEVONO RIMANERE
}

// ===== GENERAZIONE SEZIONI SCONFINI PER CATEGORIA =====
function generaSezioniSconfiniPeriodo(sconfini) {
  let html = '';

  ['revoca', 'autoliquidanti', 'scadenza'].forEach(categoria => {
    const sconfiniCategoria = sconfini[categoria];
    if (sconfiniCategoria && sconfiniCategoria.length > 0) {
      const nomeCategoria = categoria.toUpperCase();

      html += '<div style="margin-bottom: 15px;">';
      html += '<h5 style="color: var(--danger-color); margin-bottom: 10px;">üö® SCONFINI ' + nomeCategoria + ' (' + sconfiniCategoria.length + ')</h5>';

      sconfiniCategoria.forEach(sconfino => {
        const categoriaCorta = sconfino.categoria.replace('RISCHI ', '');
        html += '<div style="margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">';
        html += '<strong>' + categoriaCorta + ' - ' + sconfino.mese + ': ' + sconfino.intermediario + '<br>';
        html += 'SCONFINO: ‚Ç¨' + (sconfino.eccesso?.toLocaleString('it-IT') || '0') + '</strong>';
        html += '</div>';
      });

      html += '</div>';
    }
  });

  return html;
}

// ===== GENERAZIONE TABELLA RISCHI COMPLETA PER PERIODO =====
function generaTabellaRischiPeriodo(azienda, mesiPeriodo) {

  let html = `
    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
      <h4 style="color: var(--text-primary, #333); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color, #ff6b00); padding-bottom: 8px;">
        üìã TABELLE RISCHI - LAYOUT PULITO
      </h4>

      <!-- CARD RISCHI A REVOCA -->
      <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ff6b00; margin-bottom: 20px; cursor: pointer;" onclick="mostraModalRischiRevoca()">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="color: #ff6b00; margin: 0 0 10px 0; font-size: 18px;">üìä RISCHI A REVOCA</h4>
            <p style="margin: 0; color: #666; font-size: 14px;">Clicca per visualizzare dettagli</p>
          </div>
          <div style="text-align: right;">
            <div style="background: #ff6b00; color: white; padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 14px;">
              üìä Mostra Tabella
            </div>
          </div>
        </div>
      </div>

      <table class="tabella-cr" style="display: none;">
        <thead>
          <tr>
            <th>Mese</th>
            <th>Intermediario</th>
            <th>Categoria</th>
            <th>Accordato</th>
            <th>Accordato Op.</th>
            <th>Utilizzato</th>
            <th>% Utilizzo</th>

          </tr>
        </thead>
        <tbody>
  `;

  // Ordina i mesi del periodo cronologicamente (dal pi√π recente al pi√π vecchio)
  const mesiOrdinati = ordinaMesiCronologicamente(mesiPeriodo).reverse();

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    datiMese.intermediari.forEach(int => {
      int.rischi.forEach(rischio => {
        const percUtilizzo = rischio.accordatoOperativo > 0 ? 
                           (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        const isEccesso = rischio.utilizzato > rischio.accordatoOperativo;
        const classeRiga = isEccesso ? 'utilizzo-eccesso' : '';

        html += `
          <tr class="${classeRiga}">
            <td>${formatMeseCorto(mese)}</td>
            <td>${int.nome}</td>
            <td>${rischio.categoria}</td>
            <td>${rischio.accordato?.toLocaleString('it-IT') || '0'}</td>
            <td>${rischio.accordatoOperativo?.toLocaleString('it-IT') || '0'}</td>
            <td>${rischio.utilizzato?.toLocaleString('it-IT') || '0'}</td>
            <td>${percUtilizzo.toFixed(1)}%</td>

          </tr>
        `;
      });
    });
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

html += `
      </div>
    `;

  return html;
}

// ===== FILTRO CREDITI PER PERIODO =====
function filtraCreditiPerPeriodo(crediti, mesiPeriodo) {
  if (!crediti || !mesiPeriodo || mesiPeriodo.length === 0) {
    return [];
  }
  
  // Converti i mesi periodo in formato confrontabile
  const mesiPeriodoSet = new Set(mesiPeriodo);
  
  return crediti.filter(credito => {
    // Se il credito ha un campo mese, verifica se √® nel periodo
    if (credito.mese && mesiPeriodoSet.has(credito.mese)) {
      return true;
    }
    
    // Se il credito ha una data, estrai il mese e verifica
    if (credito.data) {
      const meseCredito = estraiMeseDaData(credito.data);
      if (meseCredito && mesiPeriodoSet.has(meseCredito)) {
        return true;
      }
    }
    
    // Se non ha informazioni temporali, includi per sicurezza
    return false;
  });
}

// ===== FILTRO GARANZIE PER PERIODO =====
function filtraGaranziePerPeriodo(garanzie, mesiPeriodo) {
  if (!garanzie || !mesiPeriodo || mesiPeriodo.length === 0) {
    return [];
  }
  
  const mesiPeriodoSet = new Set(mesiPeriodo);
  
  return garanzie.filter(garanzia => {
    if (garanzia.mese && mesiPeriodoSet.has(garanzia.mese)) {
      return true;
    }
    
    if (garanzia.data) {
      const meseGaranzia = estraiMeseDaData(garanzia.data);
      if (meseGaranzia && mesiPeriodoSet.has(meseGaranzia)) {
        return true;
      }
    }
    
    return false;
  });
}

// ===== FILTRO RICHIESTE PER PERIODO =====
function filtraRichiestePerPeriodo(richieste, mesiPeriodo) {
  if (!richieste || !mesiPeriodo || mesiPeriodo.length === 0) {
    return [];
  }
  
  const mesiPeriodoSet = new Set(mesiPeriodo);
  
  return richieste.filter(richiesta => {
    if (richiesta.mese && mesiPeriodoSet.has(richiesta.mese)) {
      return true;
    }
    
    if (richiesta.data) {
      const meseRichiesta = estraiMeseDaData(richiesta.data);
      if (meseRichiesta && mesiPeriodoSet.has(meseRichiesta)) {
        return true;
      }
    }
    
    return false;
  });
}

// ===== ESTRAI MESE DA DATA =====
function estraiMeseDaData(data) {
  try {
    // Gestisce diversi formati di data
    let dataObj;
    
    if (typeof data === 'string') {
      // Formato "YYYY-MM" o "MM/YYYY" o "DD/MM/YYYY"
      if (data.includes('/')) {
        const parti = data.split('/');
        if (parti.length === 2) {
          // MM/YYYY
          return parti[1] + '-' + parti[0].padStart(2, '0');
        } else if (parti.length === 3) {
          // DD/MM/YYYY
          return parti[2] + '-' + parti[1].padStart(2, '0');
        }
      } else if (data.includes('-')) {
        // YYYY-MM-DD o YYYY-MM
        const parti = data.split('-');
        if (parti.length >= 2) {
          return parti[0] + '-' + parti[1].padStart(2, '0');
        }
      }
    }
    
    return null;
  } catch (error) {
    console.warn('Errore estrazione mese da data:', data, error);
    return null;
  }
}

// ===== FORMATO MESE IN "gen-24" =====
function formatMeseCorto(mese) {
  if (!mese || typeof mese !== 'string') return mese;
  
  // Se √® gi√† in formato "gen-24", restituisci cos√¨
  if (mese.length === 6 && mese.includes('-')) {
    return mese;
  }
  
  // Gestisce formato "gennaio 2024" o "2024-01"
  const mesiNomi = {
    'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
    'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
    'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
  };
  
  const mesiNumeri = {
    '01': 'gen', '02': 'feb', '03': 'mar', '04': 'apr',
    '05': 'mag', '06': 'giu', '07': 'lug', '08': 'ago',
    '09': 'set', '10': 'ott', '11': 'nov', '12': 'dic'
  };
  
  try {
    // Formato "2024-01"
    if (mese.match(/^\d{4}-\d{2}$/)) {
      const [anno, meseNum] = mese.split('-');
      const annoCorto = anno.substring(2);
      return mesiNumeri[meseNum] + '-' + annoCorto;
    }
    
    // Formato "gennaio 2024"
    if (mese.includes(' ')) {
      const parti = mese.split(' ');
      if (parti.length === 2) {
        const nomeCompleto = parti[0].toLowerCase();
        const anno = parti[1];
        if (mesiNomi[nomeCompleto]) {
          return mesiNomi[nomeCompleto] + '-' + anno.substring(2);
        }
      }
    }
    
    return mese; // Fallback
  } catch (error) {
    console.warn('Errore formattazione mese:', mese, error);
    return mese;
  }
}

// ===== INIZIALIZZAZIONE GRAFICI PER PERIODO (CON FIX CONSOLE) =====
function inizializzaGraficiPeriodo(azienda, mesiPeriodo) {
  try {
    if (!window.Chart) {
      console.warn('Chart.js non disponibile per grafici periodo');
      return;
    }

    // ‚úÖ FIX: Controllo dati azienda e mesi prima di procedere
    if (!azienda || !mesiPeriodo || mesiPeriodo.length === 0) {
      console.warn('Dati azienda o mesi periodo non validi per grafici');
      return;
    }

    // ‚úÖ FIX: Verifica che azienda.mesi esista
    if (!azienda.mesi || Object.keys(azienda.mesi).length === 0) {
      console.warn('Nessun dato mensile disponibile per grafici');
      return;
    }

if (azienda.altreInformazioni?.crediti && document.getElementById('graficiCrediti')) {
  // Filtra i crediti solo per il periodo selezionato
  const creditiPeriodo = filtraCreditiPerPeriodo(azienda.altreInformazioni.crediti, mesiPeriodo);
  console.log('üîç FILTRO CREDITI DEBUG:', {
    creditiOriginali: azienda.altreInformazioni.crediti.length,
    mesiPeriodo: mesiPeriodo,
    creditiFiltrati: creditiPeriodo.length,
    creditiFiltratiDettaglio: creditiPeriodo.map(c => ({ mese: c.mese, pagati: c.pagati, impagati: c.impagati }))
  });
  window._creditiAnalisi = creditiPeriodo;
  renderGraficiCrediti(creditiPeriodo, 'graficiCrediti');
}

// NOTA: Garanzie e richieste non vengono filtrate qui perch√© inizializzaGraficiPeriodo
// √® chiamata solo per "Visualizza Analisi di Periodo" dove serve il filtro solo per crediti/grafici
// Le modal delle tabelle controllano autonomamente se usare filtro periodo o meno

    const datiPeriodo = preparaDatiGraficiPeriodo(azienda, mesiPeriodo);

    // NUOVI GRAFICI COME RICHIESTO
    creaBarreChartPeriodo(datiPeriodo, mesiPeriodo);
    creaTortaChartPeriodo(datiPeriodo);
    creaEvoluzioneRatingPeriodoSafe(azienda, mesiPeriodo); // ‚úÖ Versione SAFE
    creaAndamentoTipologiaPeriodo(datiPeriodo, mesiPeriodo);


console.log(`üìä Grafici periodo inizializzati per ${mesiPeriodo.length} mesi - INCLUSI: Evoluzione Rating + Andamento Tipologia + Altre Informazioni`);
// Rimossa duplicazione setTimeout grafici crediti - gi√† gestito sopra

  } catch (error) {
    console.error('Errore inizializzazione grafici periodo:', error);
    showToast('‚ö†Ô∏è Grafici non disponibili - dati insufficienti', 'warning');
  }
}

// ===== PREPARAZIONE DATI GRAFICI PER PERIODO =====
function preparaDatiGraficiPeriodo(azienda, mesiPeriodo) {
  const dati = {
    mesi: mesiPeriodo,
    categorieRischi: {
      revoca: 0,
      autoliquidanti: 0,
      scadenza: 0,
      garanzie: 0
    },
    datiMensili: []
  };

  mesiPeriodo.forEach(mese => {
    let revocaMese = 0, autoMese = 0, scadenzaMese = 0, garanzieMese = 0;

    const datiMese = azienda.mesi[mese];
    if (datiMese && datiMese.intermediari) {
      datiMese.intermediari.forEach(int => {
        if (int.rischi) {
          int.rischi.forEach(rischio => {
            if (rischio.categoria.includes('REVOCA')) {
              revocaMese += rischio.utilizzato || 0;
              dati.categorieRischi.revoca += rischio.utilizzato || 0;
            } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
              autoMese += rischio.utilizzato || 0;
              dati.categorieRischi.autoliquidanti += rischio.utilizzato || 0;
            } else if (rischio.categoria.includes('SCADENZA')) {
              scadenzaMese += rischio.utilizzato || 0;
              dati.categorieRischi.scadenza += rischio.utilizzato || 0;
            }

            if (rischio.garantito > 0) {
              garanzieMese += rischio.garantito || 0;
              dati.categorieRischi.garanzie += rischio.garantito || 0;
            }
          });
        }
      });
    }

    dati.datiMensili.push({
      mese: mese,
      revoca: revocaMese,
      autoliquidanti: autoMese,
      scadenza: scadenzaMese,
      garanzie: garanzieMese
    });
  });

  return dati;
}

// ===== GRAFICO BARRE PERIODO =====
function creaBarreChartPeriodo(datiPeriodo, mesiPeriodo) {
  const ctx = document.getElementById('barreChartPeriodo');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: mesiPeriodo.map(m => formatMeseCorto(m)),
      datasets: [
        {
          label: 'Rischi a Revoca',
          data: datiPeriodo.datiMensili.map(d => d.revoca),
          backgroundColor: '#ff6b00',
          borderColor: '#e55a00',
          borderWidth: 1
        },
        {
          label: 'Autoliquidanti',
          data: datiPeriodo.datiMensili.map(d => d.autoliquidanti),
          backgroundColor: '#20c997',
          borderColor: '#1aa085',
          borderWidth: 1
        },
        {
          label: 'A Scadenza',
          data: datiPeriodo.datiMensili.map(d => d.scadenza),
          backgroundColor: '#4299e1',
          borderColor: '#3182ce',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => {
              if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M‚Ç¨';
              if (value >= 1000) return (value / 1000).toFixed(0) + 'K‚Ç¨';
              return '‚Ç¨' + value;
            }
          }
        }
      },
      plugins: {
        legend: { position: 'top' },
        title: {
          display: true,
          text: `Utilizzo Crediti per Categoria (${mesiPeriodo.length} mesi)`
        }
      }
    }
  });
}

// ===== GRAFICO TORTA PERIODO =====
function creaTortaChartPeriodo(datiPeriodo) {
  const ctx = document.getElementById('tortaChartPeriodo');
  if (!ctx) return;

  const totali = Object.values(datiPeriodo.categorieRischi);
  const somma = totali.reduce((a, b) => a + b, 0);

  if (somma === 0) {
    ctx.innerHTML = '<div style="text-align: center; padding: 50px;">Nessun dato disponibile</div>';
    return;
  }

  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Rischi a Revoca', 'Autoliquidanti', 'A Scadenza'],
      datasets: [{
        data: [
          datiPeriodo.categorieRischi.revoca,
          datiPeriodo.categorieRischi.autoliquidanti,
          datiPeriodo.categorieRischi.scadenza
        ],
        backgroundColor: ['#ff6b00', '#20c997', '#4299e1'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const percentage = ((context.parsed / somma) * 100).toFixed(1);
              return `${context.label}: ‚Ç¨${(context.parsed / 1000).toFixed(0)}K (${percentage}%)`;
            }
          }
        },
        title: {
          display: true,
          text: 'Distribuzione Rischi'
        }
      }
    }
  });
}

// ===== GRAFICO EVOLUZIONE RATING (VERSIONE SAFE) =====
function creaEvoluzioneRatingPeriodoSafe(azienda, mesiPeriodo) {
  const ctx = document.getElementById('lineChartPeriodo');
  if (!ctx) {
    console.warn('Canvas lineChartPeriodo non trovato');
    return;
  }

  try {
    // ‚úÖ FIX: Calcola rating con controlli di sicurezza
    const ratingMensili = mesiPeriodo.map(mese => {
      const datiMese = azienda.mesi[mese];
      if (!datiMese) {
        return { mese, rating: 'N/A', valore: 0 };
      }

      // ‚úÖ FIX: Usa funzione safe per calcolo rating
      const rating = calcolaRatingMeseSafe(datiMese, azienda.naturaGiuridica || 'SRL');

      // Converti rating in valore numerico
      const valoreRating = {
        'CR1': 10, 'CR2': 9, 'CR3': 8, 'CR4': 7, 'CR5': 6,
        'CR6': 5, 'CR7': 4, 'CR8': 3, 'CR9': 2, 'CR10': 1, 'CR11': 0,
        'UNRATED': -1
      };

      return { 
        mese, 
        rating: rating.classe, 
        valore: valoreRating[rating.classe] || 0,
        descrizione: rating.descrizione
      };
    });

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: mesiPeriodo.map(m => formatMeseCorto(m)),
        datasets: [{
          label: 'Evoluzione Rating',
          data: ratingMensili.map(r => r.valore),
          borderColor: '#ff6b00',
          backgroundColor: 'rgba(255, 107, 0, 0.1)',
          borderWidth: 4,
          fill: true,
          tension: 0.3,
          pointBackgroundColor: '#1d3557',
          pointBorderColor: '#ff6b00',
          pointBorderWidth: 2,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
  y: {
    title: { display: true, text: 'Livello Rating' },
    suggestedMin: Math.min(...ratingMensili.map(r => r.valore)) - 1,
    suggestedMax: Math.max(...ratingMensili.map(r => r.valore)) + 1,
    ticks: {
      stepSize: 1,
      callback: function(value) {
        const ratings = {
          10: 'CR1', 9: 'CR2', 8: 'CR3', 7: 'CR4', 6: 'CR5',
          5: 'CR6', 4: 'CR7', 3: 'CR8', 2: 'CR9', 1: 'CR10', 0: 'CR11', '-1': 'UNRATED'
        };
        return ratings[value] || '';
      }
    }
  },
  x: { title: { display: true, text: 'Mesi del Periodo' } }
},
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const rating = ratingMensili[context.dataIndex];
                return `Rating: ${rating.rating} - ${rating.descrizione}`;
              }
            }
          },
          title: { display: true, text: `Evoluzione Rating (nei mesi selezionati)` }
        }
      }
    });

  } catch (error) {
    console.error('Errore creazione grafico rating:', error);
    ctx.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Grafico non disponibile</div>';
  }
}

// ===== FUNZIONE SAFE PER CALCOLO RATING MESE =====
function calcolaRatingMeseSafe(datiMese, naturaGiuridica) {
  try {
    if (!datiMese || !datiMese.intermediari) {
      return { classe: 'UNRATED', descrizione: 'Dati mese non disponibili', score: 0 };
    }
    if (!naturaGiuridica || !coefficientiMCC[naturaGiuridica]) {
      return { classe: 'UNRATED', descrizione: 'Natura giuridica non valida', score: 0 };
    }
    const coeff = coefficientiMCC[naturaGiuridica];
    let accAutoliqRevoca = 0, utilizzatoAutoliqRevoca = 0;
    let accScadenza = 0, utilizzatoScadenza = 0;
    datiMese.intermediari.forEach(int => {
      if (int && int.rischi && Array.isArray(int.rischi)) {
        int.rischi.forEach(rischio => {
          if (rischio && typeof rischio.accordatoOperativo === 'number' && typeof rischio.utilizzato === 'number') {
            if (rischio.categoria && (rischio.categoria.includes('REVOCA') || rischio.categoria.includes('AUTOLIQUIDANTI'))) {
              accAutoliqRevoca += rischio.accordatoOperativo;
              utilizzatoAutoliqRevoca += rischio.utilizzato;
            } else if (rischio.categoria && rischio.categoria.includes('SCADENZA')) {
              accScadenza += rischio.accordatoOperativo;
              utilizzatoScadenza += rischio.utilizzato;
            }
          }
        });
      }
    });
    const c1 = accAutoliqRevoca > 0 ? (utilizzatoAutoliqRevoca / accAutoliqRevoca) : 0;
    const dc1 = 0;
    const dc3 = accScadenza > 0 && (utilizzatoScadenza / accScadenza) > 1 ? 1 : 0;
    const c2 = c1 > 1 ? 1 : 0;
    const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));
    const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + coeff.COSTANTE + correzione;
    const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || { classe: "UNRATED", descr: "Non classificabile", emoji: "?" };
    return { classe: classe.classe, descrizione: classe.descr, score: score, emoji: classe.emoji };
  } catch (error) {
    console.error('Errore calcolo rating mese:', error);
    return { classe: 'UNRATED', descrizione: 'Errore calcolo', score: 0 };
  }
}

// ===== GRAFICO ANDAMENTO PER TIPOLOGIA =====
function creaAndamentoTipologiaPeriodo(datiPeriodo, mesiPeriodo) {
  const ctx = document.getElementById('andamentoTipologiaChart');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: mesiPeriodo.map(m => formatMeseCorto(m)),
      datasets: [
        {
          label: 'Rischi a Revoca',
          data: datiPeriodo.datiMensili.map(d => d.revoca / 1000),
          borderColor: '#ff6b00',
          backgroundColor: 'rgba(255, 107, 0, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4
        },
        {
          label: 'Autoliquidanti',
          data: datiPeriodo.datiMensili.map(d => d.autoliquidanti / 1000),
          borderColor: '#20c997',
          backgroundColor: 'rgba(32, 201, 151, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4
        },
        {
          label: 'A Scadenza',
          data: datiPeriodo.datiMensili.map(d => d.scadenza / 1000),
          borderColor: '#4299e1',
          backgroundColor: 'rgba(66, 153, 225, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4
        },
        {
          label: 'Garanzie',
          data: datiPeriodo.datiMensili.map(d => d.garanzie / 1000),
          borderColor: '#ed8936',
          backgroundColor: 'rgba(237, 131, 54, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.4,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Importo (K‚Ç¨)' },
          ticks: { callback: (value) => value + 'K‚Ç¨' }
        },
        x: { title: { display: true, text: 'Mesi del Periodo' } }
      },
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: `Accordato vs Utilizzato e Sconfini (nei mesi selezionati)` }
      }
    }
  });
}

// ===== FUNZIONI EXPORT COMPLETE =====

function salvaAnalisiPeriodo() {
  if (!window.ultimaAnalisiGenerata) {
    showToast('‚ùå Nessuna analisi periodo da salvare', 'error');
    return;
  }

  try {
    const analisi = window.ultimaAnalisiGenerata;
    const azienda = archivioAziende[aziendaCorrente];
    const denominazione = azienda.anagrafica?.denominazione || 'Azienda';
    const timestamp = new Date().toISOString();
    const timestampFile = timestamp.slice(0, 10).replace(/-/g, '');

    // Nome file sicuro
    const denominazionePulita = denominazione
      .replace(/[^a-zA-Z0-9\s]/g, '')
      .replace(/\s+/g, '_')
      .substring(0, 20);

    const nomeFile = `REPCR_${denominazionePulita}_${timestampFile}.json`;

    // 1. SALVA IN LOCALSTORAGE
    const analisiPerStorage = {
      id: `analisi_${Date.now()}`,
      timestamp: timestamp,
      denominazione: denominazione,
      nomeFile: nomeFile,
      analisiCompleta: analisi
    };

    let analisiSalvate = [];
    const stored = localStorage.getItem('ceoDOC_analisiSalvate');
    if (stored) {
      analisiSalvate = JSON.parse(stored);
    }

    analisiSalvate.push(analisiPerStorage);
    localStorage.setItem('ceoDOC_analisiSalvate', JSON.stringify(analisiSalvate));

    // 2. SALVA FILE JSON
    const dataJSON = {
      metadata: {
        versione: "ceoDOC-CR ANALISI v1.4",
        dataCreazione: timestamp,
        azienda: denominazione,
        percorsoSalvataggio: "ceoDOC/archivio/dati/reportcrisk/"
      },
      analisiCompleta: analisi,
      aziendaCompleta: azienda
    };

    const blob = new Blob([JSON.stringify(dataJSON, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nomeFile;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // 3. MESSAGGIO FINALE
    setTimeout(() => {
      alert(`üíæ ANALISI SALVATA!

üìÅ File scaricato: ${nomeFile}
üíæ Salvata in memoria: ${analisiSalvate.length} analisi totali

üìÇ PERCORSO SUGGERITO:
Sposta il file in: ceoDOC\\archivio\\dati\\reportcrisk\\

‚úÖ Analisi: ${denominazione}`);
    }, 500);

    showToast('üíæ Analisi salvata in memoria e file!', 'success');

  } catch (error) {
    console.error('Errore salvataggio:', error);
    showToast('‚ùå Errore durante il salvataggio: ' + error.message, 'error');
  }
}

function apriAnalisiSalvate() {
  let analisiSalvate = [];

  // Recupera analisi dal localStorage
  try {
    const stored = localStorage.getItem('ceoDOC_analisiSalvate');
    if (stored) {
      analisiSalvate = JSON.parse(stored);
    }
  } catch (error) {
    console.warn('Errore lettura localStorage:', error);
  }

  if (analisiSalvate.length === 0) {
    showToast('üìÇ Nessuna analisi salvata trovata', 'info');
    return;
  }

  // Ordina per data (pi√π recenti prima)
  analisiSalvate.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  // Crea lista HTML
  let listaHTML = `
    <div style="max-height: 500px; overflow-y: auto;">
      <h3 style="color: #17a2b8; margin-bottom: 20px;">üìÇ ANALISI SALVATE (${analisiSalvate.length}/20)</h3>
  `;

  analisiSalvate.forEach((analisi, index) => {
    const dataFormattata = new Date(analisi.timestamp).toLocaleDateString('it-IT', {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    listaHTML += `
      <div style="
        background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; 
        padding: 15px; margin-bottom: 10px; position: relative;">

        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center;">

          <div>
            <h4 style="margin: 0 0 8px 0; color: #495057; font-size: 1.1em;">
              ${analisi.denominazione}
            </h4>
            <div style="font-size: 0.9em; color: #6c757d; line-height: 1.4;">
              <div><strong>CF:</strong> ${analisi.codiceFiscale}</div>
              <div><strong>Periodo:</strong> ${analisi.periodoAnalisi}</div>
              <div><strong>Salvata:</strong> ${dataFormattata}</div>
              <div><strong>Mesi:</strong> ${analisi.analisiCompleta?.mesiValidi || 'N/A'}</div>
            </div>
          </div>

          <button onclick="visualizzaAnalisiSalvata('${analisi.id}')" style="
            background: #28a745; color: white; border: none; 
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;">
            üëÅÔ∏è Visualizza
          </button>

          <button onclick="eliminaAnalisiSalvata('${analisi.id}')" style="
            background: #dc3545; color: white; border: none; 
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;">
            üóëÔ∏è Elimina
          </button>

        </div>
      </div>
    `;
  });

  listaHTML += `
    </div>
    <div style="margin-top: 20px; text-align: center; border-top: 1px solid #ddd; padding-top: 15px;">
      <button onclick="eliminaTutteAnalisiSalvate()" style="
        background: #6c757d; color: white; border: none; 
        padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
        üóëÔ∏è Elimina Tutte
      </button>
      <button onclick="chiudiModal('visualizzazioneModal')" style="
        background: #17a2b8; color: white; border: none; 
        padding: 10px 20px; border-radius: 6px; cursor: pointer;">
        ‚úÖ Chiudi
      </button>
    </div>
  `;

  // Mostra nel modal
  mostraModal('visualizzazioneModal', 'Analisi Salvate', listaHTML);
}

// VISUALIZZA ANALISI SPECIFICA
function visualizzaAnalisiSalvata(analisiId) {
  let analisiSalvate = [];

  try {
    const stored = localStorage.getItem('ceoDOC_analisiSalvate');
    if (stored) {
      analisiSalvate = JSON.parse(stored);
    }
  } catch (error) {
    showToast('‚ùå Errore lettura analisi', 'error');
    return;
  }

  const analisi = analisiSalvate.find(a => a.id === analisiId);
  if (!analisi) {
    showToast('‚ùå Analisi non trovata', 'error');
    return;
  }

  // Ripristina l'analisi
  window.ultimaAnalisiGenerata = analisi.analisiCompleta;

  // Chiudi modal
  chiudiModal('visualizzazioneModal');

  // Richiama la visualizzazione (usa la funzione esistente)
  const contenutoAnalisi = document.getElementById('contenutoAnalisi');
  if (contenutoAnalisi && analisi.analisiCompleta.htmlGenerato) {
    contenutoAnalisi.innerHTML = analisi.analisiCompleta.htmlGenerato;
  }

  showToast(`üìä Analisi caricata: ${analisi.denominazione}`, 'success', 3000);
}

// ELIMINA ANALISI SPECIFICA
function eliminaAnalisiSalvata(analisiId) {
  const conferma = confirm('üóëÔ∏è Vuoi eliminare questa analisi salvata?');
  if (!conferma) return;

  let analisiSalvate = [];

  try {
    const stored = localStorage.getItem('ceoDOC_analisiSalvate');
    if (stored) {
      analisiSalvate = JSON.parse(stored);
    }
  } catch (error) {
    showToast('‚ùå Errore lettura analisi', 'error');
    return;
  }

  // Rimuovi analisi
  analisiSalvate = analisiSalvate.filter(a => a.id !== analisiId);

  // Salva aggiornamento
  try {
    localStorage.setItem('ceoDOC_analisiSalvate', JSON.stringify(analisiSalvate));
    showToast('üóëÔ∏è Analisi eliminata', 'success');

    // Ricarica lista
    apriAnalisiSalvate();

  } catch (error) {
    showToast('‚ùå Errore eliminazione', 'error');
  }
}

// ELIMINA TUTTE LE ANALISI
function eliminaTutteAnalisiSalvate() {
  const conferma = confirm('üóëÔ∏è ATTENZIONE!\n\nVuoi eliminare TUTTE le analisi salvate dalla memoria?\n\nQuesta operazione √® irreversibile!');
  if (!conferma) return;

  try {
    localStorage.removeItem('ceoDOC_analisiSalvate');

    alert(`üóëÔ∏è TUTTE LE ANALISI ELIMINATE DALLA MEMORIA

‚úÖ Memoria browser completamente pulita

üíæ BACKUP SU PC:
I file di backup rimangono salvati in:
üìÅ ceoDOC\\archivio\\dati\\reportcrisk\\

üîç Se vuoi eliminare anche i backup:
1. Vai nella cartella reportcrisk
2. Cerca tutti i file REPCR_*.json e REPCR_*.pdf  
3. Eliminali manualmente

üí° SUGGERIMENTO:
Tieni i backup su PC per sicurezza, occupano poco spazio!`);

    showToast('üóëÔ∏è Tutte le analisi eliminate dalla memoria', 'success');
    chiudiModal('visualizzazioneModal');

  } catch (error) {
    showToast('‚ùå Errore eliminazione', 'error');
  }
}

// ===== FUNZIONI HELPER PER PDF CORRETTO =====

function generaGraficoTestualePDFMigliorato(doc, titolo, startY, analisi, azienda, tipo) {
  let y = startY;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.setTextColor(255, 107, 0);
  doc.text(`${titolo}`, 40, y);
  y += 15;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.setTextColor(51, 51, 51);

  if (tipo === 'accordato_utilizzato') {
    doc.text("Confronto mensile tra credito accordato e utilizzato", 40, y);
    y += 15;

    // Header tabella
    doc.setFont("helvetica", "bold");
    doc.setFontSize(7);
    doc.text("MESE", 40, y);
    doc.text("ACCORDATO", 100, y);
    doc.text("UTILIZZATO", 170, y);
    doc.text("UTILIZZO%", 240, y);
    doc.text("GRAFICO", 300, y);
    y += 12;

    // Linea separatrice
    doc.setDrawColor(200, 200, 200);
    doc.line(40, y, 500, y);
    y += 8;

    // Dati ultimi 6 mesi
    const ultimi6Mesi = ordinaMesiCronologicamente(Object.keys(azienda.mesi)).slice(-6);

    ultimi6Mesi.forEach(mese => {
      const datiMese = azienda.mesi[mese];
      if (!datiMese) return;

      let totaleAccordato = 0;
      let totaleUtilizzato = 0;

      datiMese.intermediari.forEach(int => {
        int.rischi.forEach(rischio => {
          totaleAccordato += (rischio.accordato || 0);
          totaleUtilizzato += (rischio.utilizzato || 0);
        });
      });

      const utilizzoPerc = totaleAccordato > 0 ? (totaleUtilizzato / totaleAccordato * 100) : 0;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(6);
      doc.text(abbreviaMesePDF(mese), 40, y);
      doc.text(`${Math.round(totaleAccordato/1000)}K`, 100, y);
      doc.text(`${Math.round(totaleUtilizzato/1000)}K`, 170, y);
      doc.text(`${utilizzoPerc.toFixed(1)}%`, 240, y);

      // Barra grafica
      const maxWidth = 80;
      const widthAccordato = Math.min(maxWidth, (totaleAccordato / 1000000) * maxWidth);
      const widthUtilizzato = Math.min(maxWidth, (totaleUtilizzato / 1000000) * maxWidth);

      doc.setFillColor(220, 220, 220);
      doc.rect(300, y - 4, widthAccordato, 3, 'F');
      doc.setFillColor(255, 107, 0);
      doc.rect(300, y - 1, widthUtilizzato, 3, 'F');

      y += 10;
    });

  } else if (tipo === 'distribuzione') {
    doc.text("Ripartizione percentuale per tipologia di rischio", 40, y);
    y += 15;

    // Calcola distribuzione reale
    let totaleRevoca = 0, totaleAutoliq = 0, totaleScadenza = 0;

    Object.keys(azienda.mesi).forEach(mese => {
      const datiMese = azienda.mesi[mese];
      if (!datiMese) return;

      datiMese.intermediari.forEach(int => {
        int.rischi.forEach(rischio => {
          if (rischio.categoria.includes('REVOCA')) {
            totaleRevoca += (rischio.utilizzato || 0);
          } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
            totaleAutoliq += (rischio.utilizzato || 0);
          } else if (rischio.categoria.includes('SCADENZA')) {
            totaleScadenza += (rischio.utilizzato || 0);
          }
        });
      });
    });

    const totaleComplessivo = totaleRevoca + totaleAutoliq + totaleScadenza;

    if (totaleComplessivo > 0) {
      const percRevoca = (totaleRevoca / totaleComplessivo * 100);
      const percAutoliq = (totaleAutoliq / totaleComplessivo * 100);
      const percScadenza = (totaleScadenza / totaleComplessivo * 100);

      doc.setFont("helvetica", "bold");
      doc.setFontSize(7);
      doc.text("CATEGORIA", 40, y);
      doc.text("IMPORTO", 130, y);
      doc.text("PERCENTUALE", 200, y);
      doc.text("GRAFICO", 280, y);
      y += 12;

      doc.setDrawColor(200, 200, 200);
      doc.line(40, y, 500, y);
      y += 8;

      // Revoca
      doc.setFont("helvetica", "normal");
      doc.setFontSize(6);
      doc.text("Rischi a Revoca", 40, y);
      doc.text(`${Math.round(totaleRevoca/1000)}K`, 130, y);
      doc.text(`${percRevoca.toFixed(1)}%`, 200, y);
      doc.setFillColor(255, 107, 0);
      doc.rect(280, y - 4, percRevoca, 6, 'F');
      y += 12;

      // Autoliquidanti
      doc.text("Autoliquidanti", 40, y);
      doc.text(`${Math.round(totaleAutoliq/1000)}K`, 130, y);
      doc.text(`${percAutoliq.toFixed(1)}%`, 200, y);
      doc.setFillColor(32, 201, 151);
      doc.rect(280, y - 4, percAutoliq, 6, 'F');
      y += 12;

      // Scadenza
      doc.text("A Scadenza", 40, y);
      doc.text(`${Math.round(totaleScadenza/1000)}K`, 130, y);
      doc.text(`${percScadenza.toFixed(1)}%`, 200, y);
      doc.setFillColor(66, 153, 225);
      doc.rect(280, y - 4, percScadenza, 6, 'F');
      y += 12;
    }

  } else if (tipo === 'evoluzione') {
    doc.text("Andamento rating MCC nel periodo analizzato", 40, y);
    y += 15;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(7);
    doc.text("MESE", 40, y);
    doc.text("RATING", 100, y);
    doc.text("DESCRIZIONE", 150, y);
    doc.text("TREND", 280, y);
    y += 12;

    doc.setDrawColor(200, 200, 200);
    doc.line(40, y, 500, y);
    y += 8;

    // Mostra evoluzione ultimi 6 mesi
    const ultimi6Mesi = ordinaMesiCronologicamente(Object.keys(azienda.mesi)).slice(-6);

    ultimi6Mesi.forEach((mese, index) => {
      // Simula calcolo rating per mese (semplificato)
      const rating = calcolaRatingPeriodoSpecifico(azienda, [mese]);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(6);
      doc.text(abbreviaMesePDF(mese), 40, y);
      doc.text(rating.classe, 100, y);
      doc.text(pulisciTestoPDF(rating.descrizione).substring(0, 20), 150, y);

      // Trend visuale
      const colore = getColorByRatingPDF(rating.classe);
      doc.setFillColor(colore.r, colore.g, colore.b);
      doc.circle(290 + (index * 15), y - 2, 2, 'F');

      if (index > 0) {
        doc.setDrawColor(150, 150, 150);
        doc.line(275 + ((index - 1) * 15), y - 2, 290 + (index * 15), y - 2);
      }

      y += 12;
    });

  } else if (tipo === 'tipologie') {
    doc.text("Confronto utilizzo tra tipologie nel tempo", 40, y);
    y += 15;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(7);
    doc.text("MESE", 40, y);
    doc.text("REVOCA", 90, y);
    doc.text("AUTOLIQ", 140, y);
    doc.text("SCADENZA", 190, y);
    doc.text("TREND", 250, y);
    y += 12;

    doc.setDrawColor(200, 200, 200);
    doc.line(40, y, 500, y);
    y += 8;

    const ultimi6Mesi = ordinaMesiCronologicamente(Object.keys(azienda.mesi)).slice(-6);

    ultimi6Mesi.forEach((mese, index) => {
      const datiMese = azienda.mesi[mese];
      if (!datiMese) return;

      let revoca = 0, autoliq = 0, scadenza = 0;

      datiMese.intermediari.forEach(int => {
        int.rischi.forEach(rischio => {
          if (rischio.categoria.includes('REVOCA')) {
            revoca += (rischio.utilizzato || 0);
          } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
            autoliq += (rischio.utilizzato || 0);
          } else if (rischio.categoria.includes('SCADENZA')) {
            scadenza += (rischio.utilizzato || 0);
          }
        });
      });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(6);
      doc.text(abbreviaMesePDF(mese), 40, y);
      doc.text(`${Math.round(revoca/1000)}K`, 90, y);
      doc.text(`${Math.round(autoliq/1000)}K`, 140, y);
      doc.text(`${Math.round(scadenza/1000)}K`, 190, y);

      // Linee trend
      doc.setFillColor(255, 107, 0);
      doc.circle(250 + (index * 10), y - 3, 1, 'F');
      doc.setFillColor(32, 201, 151);
      doc.circle(250 + (index * 10), y, 1, 'F');
      doc.setFillColor(66, 153, 225);
      doc.circle(250 + (index * 10), y + 3, 1, 'F');

      y += 12;
    });
  }

  return y + 20;
}


// ===== FUNZIONI HELPER =====


function esportaAnalisiPeriodoPDFCompleto(meseDa, meseA, mesiValidi) {
  if (!window.ultimaAnalisiGenerata) {
    showToast('‚ùå Nessuna analisi periodo da esportare. Genera prima l\'analisi.', 'error');
    return;
  }

  const analisi = window.ultimaAnalisiGenerata;
  const azienda = archivioAziende[aziendaCorrente];

  if (!azienda) {
    showToast('‚ùå Azienda non selezionata', 'error');
    return;
  }

  // Verifica se i grafici esistono e sono pronti
  verificaEPrepareGraficiPerPDF(analisi, azienda, meseDa, meseA, mesiValidi);
}

// ===== VERIFICA E PREPARA GRAFICI =====
function verificaEPrepareGraficiPerPDF(analisi, azienda, meseDa, meseA, mesiValidi) {
  console.log('üìä Verifica grafici per export PDF...');

  // ID dei grafici che dovrebbero esistere
  const graficiIds = [
    { id: 'barreChart', nome: 'Accordato vs Utilizzato' },
    { id: 'tortaChart', nome: 'Distribuzione Rischi' },
    { id: 'lineChart', nome: 'Evoluzione Rating' },
    { id: 'andamentoChart', nome: 'Andamento Tipologie' }
  ];

  // Controlla se i grafici esistono gi√†
  const graficiEsistenti = graficiIds.filter(grafico => {
    const canvas = document.getElementById(grafico.id);
    return canvas && canvas.width > 0 && canvas.height > 0;
  });

  console.log(`üìà Grafici esistenti: ${graficiEsistenti.length}/${graficiIds.length}`);

  if (graficiEsistenti.length >= 3) {
    // Grafici gi√† pronti, esporta subito
    console.log('‚úÖ Grafici pronti, avvio export PDF immediato');
    eseguiExportPDFConGrafici(analisi, azienda, meseDa, meseA, mesiValidi, graficiEsistenti);
  } else {
    // Grafici mancanti, mostra analisi periodo e aspetta
    console.log('‚è≥ Grafici mancanti, genero analisi periodo...');
    mostraMessaggioAttesaGrafici();

    // Genera analisi periodo per creare i grafici
    generaAnalisiPeriodo();

    // Aspetta che i grafici si renderizzino
    setTimeout(() => {
      const graficiAggiornati = graficiIds.filter(grafico => {
        const canvas = document.getElementById(grafico.id);
        return canvas && canvas.width > 0 && canvas.height > 0;
      });

      console.log(`üìà Grafici dopo attesa: ${graficiAggiornati.length}/${graficiIds.length}`);

      rimuoviMessaggioAttesa();
      eseguiExportPDFConGrafici(analisi, azienda, meseDa, meseA, mesiValidi, graficiAggiornati);

    }, 3000); // Attesa 3 secondi per rendering
  }
}

// ===== MESSAGGI ATTESA =====
function mostraMessaggioAttesaGrafici() {
  const messaggio = document.createElement('div');
  messaggio.id = 'messaggioAttesaGrafici';
  messaggio.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ff6b00, #ff8f40);
    color: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 10000;
    text-align: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `;

  messaggio.innerHTML = `
    <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
    <h3 style="margin: 0 0 10px 0;">Preparazione grafici PDF</h3>
    <p style="margin: 0; opacity: 0.9;">Generazione grafici per export completo...</p>
    <div style="margin-top: 15px;">
      <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
        <div style="width: 100%; height: 100%; background: white; animation: slide 2s infinite;"></div>
      </div>
    </div>
    <style>
      @keyframes slide {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
    </style>
  `;

  document.body.appendChild(messaggio);
}

function rimuoviMessaggioAttesa() {
  const messaggio = document.getElementById('messaggioAttesaGrafici');
  if (messaggio) {
    messaggio.remove();
  }
}

// ===== EXPORT PDF CON GRAFICI REALI =====
function eseguiExportPDFConGrafici(analisi, azienda, meseDa, meseA, mesiValidi, graficiDisponibili) {
  console.log(`üöÄ Avvio export PDF con ${graficiDisponibili.length} grafici`);

  let doc;
  try {
    // Constructor stile creaPAMM
    const { jsPDF } = window.jspdf;
    doc = new jsPDF({ unit: "pt", format: "a4", orientation: "portrait" });
  } catch (error) {
    console.warn('jsPDF non disponibile:', error);
    showToast('‚ùå jsPDF non disponibile. Uso export HTML.', 'warning');
    esportaAnalisiPeriodoHTMLCompleto();
    return;
  }

  try {
    // ===== PAGINA 1: HEADER + RATING =====

    // Header ceoDOC (stile creaPAMM)
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(230, 83, 0);
    doc.text("ceoDOC.it - ANALISI CENTRALE RISCHI", 40, 40);

    doc.setFontSize(14);
    doc.setTextColor(22, 61, 122);
    doc.text("REPORT COMPLETO CON GRAFICI", 40, 60);

    // Data generazione
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text("Generato il: " + new Date().toLocaleDateString('it-IT') + " alle " + new Date().toLocaleTimeString('it-IT'), 40, 80);

    let y = 120;

    // ===== DATI AZIENDA =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text("DATI AZIENDA E PERIODO", 40, y);
    y += 25;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);

    const denominazione = azienda.anagrafica.denominazione || 'N/A';
    const codiceFiscale = azienda.anagrafica.cf || 'N/A';

    doc.text("Azienda: " + denominazione, 40, y); y += 15;
    doc.text("Codice Fiscale: " + codiceFiscale, 40, y); y += 15;
    doc.text("Periodo: " + meseDa + " - " + meseA + " (" + mesiValidi + " mesi)", 40, y); y += 15;
    doc.text("Consecutivita: " + (analisi.consecutivita.consecutivi ? 'SI' : 'NO'), 40, y); y += 30;

    // ===== RATING COMPATTO =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(230, 83, 0);
    doc.text("RATING MCC", 40, y);
    y += 20;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);

    // Layout a 3 colonne per rating
    const col1 = 40, col2 = 200, col3 = 360;

    doc.setFont("helvetica", "bold");
    doc.text("ULTIMO MESE", col1, y);
    doc.text("6 MESI", col2, y);
    doc.text("12 MESI", col3, y);
    y += 15;

    doc.setFont("helvetica", "normal");
    doc.text(analisi.ratingUltimo.classe, col1, y);
    doc.text(analisi.rating6Mesi.classe, col2, y);
    doc.text(analisi.rating12Mesi.classe, col3, y);
    y += 12;

    doc.setFontSize(8);
    doc.text(analisi.ratingUltimo.descrizione.substring(0, 20), col1, y);
    doc.text(analisi.rating6Mesi.descrizione.substring(0, 20), col2, y);
    doc.text(analisi.rating12Mesi.descrizione.substring(0, 20), col3, y);
    y += 30;

    // ===== STATISTICHE COMPATTE =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(230, 83, 0);
    doc.text("STATISTICHE", 40, y);
    y += 20;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);

    const stats = analisi.statistichePeriodo;

    doc.text("Accordato: EUR " + (stats.accordatoMedio ? stats.accordatoMedio.toLocaleString('it-IT') : '0'), col1, y);
    doc.text("Utilizzato: EUR " + (stats.utilizzatoMedio ? stats.utilizzatoMedio.toLocaleString('it-IT') : '0'), col2, y);
    y += 12;
    doc.text("Utilizzo: " + (stats.utilizzoPerc ? stats.utilizzoPerc.toFixed(1) : '0') + '%', col1, y);
    doc.text("Sconfini: " + (analisi.sconfiniPeriodo.totali || 0) + " episodi", col2, y);
    y += 40;

    // ===== PRIMO GRAFICO =====
    if (graficiDisponibili.length > 0) {
      y = aggiungiGraficoAlPDF(doc, graficiDisponibili[0], y, 'GRAFICO 1: ' + graficiDisponibili[0].nome.toUpperCase());
    }

    // ===== PAGINA 2: ALTRI GRAFICI =====
    if (graficiDisponibili.length > 1) {
      doc.addPage();

      // Header pagina 2
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.setTextColor(230, 83, 0);
      doc.text("GRAFICI ANALISI PERIODO", 40, 40);

      y = 80;

      // Grafici 2 e 3
      for (let i = 1; i < Math.min(graficiDisponibili.length, 3); i++) {
        y = aggiungiGraficoAlPDF(doc, graficiDisponibili[i], y, 'GRAFICO ' + (i + 1) + ': ' + graficiDisponibili[i].nome.toUpperCase());
        y += 30; // Spazio tra grafici
      }
    }

    // ===== PAGINA 3: TABELLA =====
    doc.addPage();

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(230, 83, 0);
    doc.text("DETTAGLIO RISCHI", 40, 40);

    y = 80;
    aggiungiTabellaAlPDF(doc, analisi, azienda, y);

    // ===== FOOTER E SALVATAGGIO =====
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);

      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text("ceoDOC.it - Analisi CR con Grafici v1.5", 40, 820);
      doc.text("Pagina " + i + " di " + pageCount, 450, 820);
    }

    // Salvataggio
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const nomeFile = "ceoDOC_analisi_grafici_" + codiceFiscale + "_" + timestamp + ".pdf";

    doc.save(nomeFile);

    showToast("‚úÖ PDF con grafici esportato!\n\nFile: " + nomeFile + "\nGrafici inclusi: " + graficiDisponibili.length + "\nPagine: " + pageCount, 'success', 5000);

  } catch (error) {
    console.error('Errore export PDF con grafici:', error);
    showToast('‚ùå Errore export: ' + error.message, 'error');

    // Fallback
    esportaAnalisiPeriodoHTMLCompleto();
  }
}

// ===== AGGIUNGI GRAFICO AL PDF =====
function aggiungiGraficoAlPDF(doc, graficoInfo, startY, titolo) {
  let y = startY;

  // Titolo grafico
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.setTextColor(22, 61, 122);
  doc.text(titolo, 40, y);
  y += 20;

  try {
    // Cattura canvas
    const canvas = document.getElementById(graficoInfo.id);

    if (canvas && canvas.width > 0 && canvas.height > 0) {
      // Converti canvas in immagine
      const imgData = canvas.toDataURL('image/png', 1.0);

      // Dimensioni per PDF (proporzionate)
      const maxWidth = 500;
      const maxHeight = 200;

      let imgWidth = canvas.width;
      let imgHeight = canvas.height;

      // Scala mantenendo proporzioni
      if (imgWidth > maxWidth) {
        imgHeight = (imgHeight * maxWidth) / imgWidth;
        imgWidth = maxWidth;
      }

      if (imgHeight > maxHeight) {
        imgWidth = (imgWidth * maxHeight) / imgHeight;
        imgHeight = maxHeight;
      }

      // Centra orizzontalmente
      const centerX = (595 - imgWidth) / 2;

      // Aggiungi immagine al PDF
      doc.addImage(imgData, 'PNG', centerX, y, imgWidth, imgHeight);

      y += imgHeight + 10;

      console.log(`‚úÖ Grafico ${graficoInfo.nome} aggiunto al PDF`);

    } else {
      // Canvas non disponibile
      doc.setFont("helvetica", "italic");
      doc.setFontSize(10);
      doc.setTextColor(220, 53, 69);
      doc.text("Grafico non disponibile - Canvas non renderizzato", 40, y);
      y += 20;

      console.warn(`‚ö†Ô∏è Canvas ${graficoInfo.id} non disponibile`);
    }

  } catch (error) {
    console.error(`‚ùå Errore cattura grafico ${graficoInfo.id}:`, error);

    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.setTextColor(220, 53, 69);
    doc.text("Errore caricamento grafico: " + error.message, 40, y);
    y += 20;
  }

  return y;
}

// ===== AGGIUNGI TABELLA AL PDF =====
function aggiungiTabellaAlPDF(doc, analisi, azienda, startY) {
  let y = startY;

  // Header tabella
  doc.setFont("helvetica", "bold");
  doc.setFontSize(8);
  doc.setTextColor(0, 0, 0);

  doc.text("Mese", 40, y);
  doc.text("Intermediario", 100, y);
  doc.text("Categoria", 200, y);
  doc.text("Accordato", 320, y);
  doc.text("Utilizzato", 400, y);
  doc.text("Util%", 480, y);

  y += 15;
  doc.line(40, y, 540, y);
  y += 10;

  // Dati (primi 30)
  let contatore = 0;
  const maxRighe = 30;

  if (analisi.mesiPeriodo) {
    for (const mese of analisi.mesiPeriodo) {
      if (contatore >= maxRighe) break;

      const datiMese = azienda.mesi[mese];
      if (!datiMese) continue;

      for (const int of datiMese.intermediari) {
        if (contatore >= maxRighe) break;
        if (!int.rischi) continue;

        for (const rischio of int.rischi) {
          if (contatore >= maxRighe) break;

          const percUtilizzo = rischio.accordatoOperativo > 0 ?
            (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

          // Colore per sconfini
          if (rischio.utilizzato > rischio.accordatoOperativo) {
            doc.setTextColor(220, 53, 69);
          } else {
            doc.setTextColor(0, 0, 0);
          }

          doc.setFont("helvetica", "normal");
          doc.setFontSize(7);

          const meseCorto = mese.substring(0, 8);
          const intCorto = int.nome.substring(0, 15);
          const catCorta = rischio.categoria.substring(0, 20);

          doc.text(meseCorto, 40, y);
          doc.text(intCorto, 100, y);
          doc.text(catCorta, 200, y);
          doc.text(Math.round((rischio.accordato || 0)/1000) + 'K', 320, y);
          doc.text(Math.round((rischio.utilizzato || 0)/1000) + 'K', 400, y);
          doc.text(percUtilizzo.toFixed(1) + '%', 480, y);

          y += 10;
          contatore++;

          if (y > 750) break; // Fine pagina
        }
      }
    }
  }

  // Nota
  if (contatore >= maxRighe) {
    y += 10;
    doc.setFont("helvetica", "italic");
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text("Primi " + maxRighe + " record. Tabella completa nell'app.", 40, y);
  }
}

console.log('‚úÖ EXPORT PDF CON CATTURA CANVAS CARICATO');
console.log('üìä Cattura grafici reali come in creaPAMM.html');


// ===== GENERA TABELLA PDF MIGLIORATA =====
function generaTabellaRischiPDFMigliorata(doc, analisi, azienda, startY) {
  let y = startY;

  // Header tabella
  doc.setFillColor(240, 240, 240);
  doc.rect(40, y, 515, 20, 'F');
  doc.setFont("helvetica", "bold");
  doc.setFontSize(7);
  doc.setTextColor(0, 0, 0);

  doc.text("Mese", 45, y + 12);
  doc.text("Intermediario", 95, y + 12);
  doc.text("Categoria", 180, y + 12);
  doc.text("Accordato", 260, y + 12);
  doc.text("Utilizzato", 320, y + 12);
  doc.text("Util%", 380, y + 12);
  doc.text("Garantito", 420, y + 12);

  y += 25;

  // Dati tabella (limitati a primi 50 per non sovraccaricare PDF)
  const mesiOrdinati = ordinaMesiCronologicamente(analisi.mesiPeriodo).reverse();
  let contatoreRighe = 0;
  const maxRighe = 50;

  for (const mese of mesiOrdinati) {
    if (contatoreRighe >= maxRighe) break;

    const datiMese = azienda.mesi[mese];
    if (!datiMese) continue;

    for (const int of datiMese.intermediari) {
      if (!int.rischi) continue;

      for (const rischio of int.rischi) {
        if (contatoreRighe >= maxRighe) break;

        if (y > 750) {
          doc.addPage();
          y = 40;

          // Ripeti header
          doc.setFillColor(240, 240, 240);
          doc.rect(40, y, 515, 20, 'F');
          doc.setFont("helvetica", "bold");
          doc.setFontSize(7);
          doc.setTextColor(0, 0, 0);
          doc.text("Mese", 45, y + 12);
          doc.text("Intermediario", 95, y + 12);
          doc.text("Categoria", 180, y + 12);
          doc.text("Accordato", 260, y + 12);
          doc.text("Utilizzato", 320, y + 12);
          doc.text("Util%", 380, y + 12);
          doc.text("Garantito", 420, y + 12);
          y += 25;
        }

        const percUtilizzo = rischio.accordatoOperativo > 0 ?
          (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        // Evidenzia sconfini
        if (rischio.utilizzato > rischio.accordatoOperativo) {
          doc.setFillColor(255, 235, 238);
          doc.rect(40, y - 2, 515, 12, 'F');
        }

        doc.setFont("helvetica", "normal");
        doc.setFontSize(6);
        doc.setTextColor(0, 0, 0);

        // Testo abbreviato per evitare overflow
        const meseAbbrev = abbreviaMesePDF(mese);
        const intAbbrev = int.nome.length > 18 ? int.nome.substring(0, 18) + '..' : int.nome;
        const catAbbrev = rischio.categoria.length > 15 ? rischio.categoria.substring(0, 15) + '..' : rischio.categoria;

        doc.text(meseAbbrev, 45, y + 8);
        doc.text(intAbbrev, 95, y + 8);
        doc.text(catAbbrev, 180, y + 8);
        doc.text(`${Math.round((rischio.accordato || 0)/1000)}K`, 260, y + 8);
        doc.text(`${Math.round((rischio.utilizzato || 0)/1000)}K`, 320, y + 8);
        doc.text(`${percUtilizzo.toFixed(0)}%`, 380, y + 8);
        doc.text(`${Math.round((rischio.garantito || 0)/1000)}K`, 420, y + 8);

        y += 12;
        contatoreRighe++;
      }
    }
  }

  // Nota finale
  y += 10;
  doc.setFillColor(230, 242, 255);
  doc.rect(40, y, 515, 25, 'F');
  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.setTextColor(33, 150, 243);
  doc.text(`Visualizzati primi ${contatoreRighe} record. Tabella completa disponibile nell'app.`, 50, y + 15);
}

// ===== FUNZIONI HELPER (se mancanti) =====

// Calcola rating per periodo specifico usando formule MCC reali
function calcolaRatingPeriodoSpecifico(azienda, mesiPeriodo) {
  console.log('üîç DEBUG calcolaRatingPeriodoSpecifico CHIAMATA con mesi:', mesiPeriodo.length);
  
  if (!azienda.naturaGiuridica || mesiPeriodo.length === 0) {
    console.log('üîç DEBUG calcolaRatingPeriodoSpecifico EARLY RETURN - natura:', azienda.naturaGiuridica, 'mesi:', mesiPeriodo.length);
    return { score: 0, classe: { classe: 'UNRATED', descr: 'Dati insufficienti', emoji: '‚ùì' } };
  }

  const coeff = coefficientiMCC[azienda.naturaGiuridica];
  if (!coeff) {
    console.log('üîç DEBUG calcolaRatingPeriodoSpecifico EARLY RETURN - coefficienti non trovati');
    return { score: 0, classe: { classe: 'UNRATED', descr: 'Coefficienti non disponibili', emoji: '‚ùì' } };
  }

  let sommaC1 = 0, mesiConUtilizzo = 0, mesiSconfinoScadenza = 0, mesiEccesso = 0;

  mesiPeriodo.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese || !datiMese.intermediari) return;

    let accAutoliqRevoca = 0, utilizzatoAutoliqRevoca = 0;
    let accScadenza = 0, utilizzatoScadenza = 0;

    datiMese.intermediari.forEach(int => {
      if (int.rischi) {
        int.rischi.forEach(rischio => {
          if (rischio.categoria.includes('REVOCA') || rischio.categoria.includes('AUTOLIQUIDANTI')) {
            accAutoliqRevoca += rischio.accordatoOperativo || 0;
            utilizzatoAutoliqRevoca += rischio.utilizzato || 0;
          } else if (rischio.categoria.includes('SCADENZA')) {
            accScadenza += rischio.accordatoOperativo || 0;
            utilizzatoScadenza += rischio.utilizzato || 0;
          }
        });
      }
    });

    const c1 = accAutoliqRevoca > 0 ? (utilizzatoAutoliqRevoca / accAutoliqRevoca) : 0;
    const scadenzaPerc = accScadenza > 0 ? (utilizzatoScadenza / accScadenza) : 0;

    sommaC1 += c1;

    if (utilizzatoAutoliqRevoca > 0) mesiConUtilizzo++;
    if (scadenzaPerc > 1) mesiSconfinoScadenza++;
    if (c1 > 1) mesiEccesso++;
  });

  const c1Medio = mesiPeriodo.length > 0 ? (sommaC1 / mesiPeriodo.length) : 0;
  const dc1 = (mesiPeriodo.length - mesiConUtilizzo) >= 4 ? c1Medio : 0;
  const dc3 = mesiSconfinoScadenza > 0 ? 1 : 0;
  const c2 = mesiEccesso;

  const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * 
                              ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));

  const score = (c1Medio * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + 
                (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + 
                coeff.COSTANTE + correzione;

  const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || 
                 { classe: "UNRATED", descr: "Non classificabile", emoji: "‚ùì" };
  
  console.log('üîç DEBUG calcolaRatingPeriodoSpecifico - Score:', score, 'Classe trovata:', classe);
  console.log('üîç DEBUG calcolaRatingPeriodoSpecifico - Dettagli:', {
    c1Medio: c1Medio.toFixed(4),
    dc1: dc1.toFixed(4),
    dc3: dc3,
    c2: c2,
    mesiConUtilizzo: mesiConUtilizzo,
    mesiSconfinoScadenza: mesiSconfinoScadenza,
    mesiEccesso: mesiEccesso
  });

  return { score: score, classe: classe };
}

// Ottieni colore RGB per rating
function getColorByRatingPDF(classe) {
  if (['CR1', 'CR2', 'CR3', 'CR4'].includes(classe)) {
    return { r: 76, g: 175, b: 80 }; // Verde
  }
  if (['CR5', 'CR6', 'CR7'].includes(classe)) {
    return { r: 255, g: 152, b: 0 }; // Arancione
  }
  return { r: 244, g: 67, b: 54 }; // Rosso
}

function getColorByRatingHTML(classe) {
  if (['CR1', 'CR2', 'CR3', 'CR4'].includes(classe)) return '#4caf50';
  if (['CR5', 'CR6', 'CR7'].includes(classe)) return '#ff9800';
  return '#f44336';
}


console.log('‚úÖ EXPORT PDF MIGLIORATO CARICATO');
console.log('üîß Risolve caratteri troncati e aggiunge grafici testuali');

// ===== EXPORT HTML COMPLETO E FEDELE =====
function esportaAnalisiPeriodoHTMLCompleto() {
  if (!window.ultimaAnalisiGenerata) {
    showToast('‚ùå Nessuna analisi periodo da esportare. Genera prima l\'analisi.', 'error');
    return;
  }

  const analisi = window.ultimaAnalisiGenerata;
  const azienda = archivioAziende[aziendaCorrente];

  if (!azienda) {
    showToast('‚ùå Azienda non selezionata', 'error');
    return;
  }

  const htmlContent = generaHTMLAnalisiPeriodoCompletaFedele(analisi, azienda);

  const nomeFile = `ceoDOC_analisi_periodo_fedele_${azienda.anagrafica.cf}_${new Date().toISOString().slice(0, 10)}.html`;

  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = nomeFile;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast(`‚úÖ HTML fedele esportato: ${nomeFile}`, 'success', 4000);
}

// ===== GENERA HTML COMPLETO E FEDELE =====
function generaHTMLAnalisiPeriodoCompletaFedele(analisi, azienda) {
  const denominazione = azienda.anagrafica.denominazione || 'N/A';
  const codiceFiscale = azienda.anagrafica.cf || 'N/A';

  return `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ceoDOC.it - Analisi Periodo Fedele</title>
    <style>
        :root {
            --primary-color: #ff6b00;
            --success-color: #20c997;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --text-primary: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #ff8f40 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.2em;
        }

        .header p {
            margin: 5px 0;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid var(--primary-color);
        }

        .section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .rating-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .rating-card {
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .rating-card:hover {
            transform: translateY(-5px);
        }

        .rating-card.arancione {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe5d6 100%);
            border-left: 5px solid var(--primary-color);
        }

        .rating-card.viola {
            background: linear-gradient(135deg, #f8f5ff 0%, #f0e5ff 100%);
            border-left: 5px solid #663399;
        }

        .rating-card.verde {
            background: linear-gradient(135deg, #f5fff5 0%, #e5ffe5 100%);
            border-left: 5px solid var(--success-color);
        }

        .rating-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .rating-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
        }

        .rating-card.arancione .rating-value {
            color: var(--primary-color);
        }

        .rating-card.viola .rating-value {
            color: #663399;
        }

        .rating-card.verde .rating-value {
            color: var(--success-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-item {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--info-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-item strong {
            display: block;
            color: var(--info-color);
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .table-container {
            margin: 30px 0;
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table th,
        .table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: var(--text-primary);
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .utilizzo-eccesso {
            background-color: #ffebee !important;
        }

        .utilizzo-eccesso:hover {
            background-color: #ffcdd2 !important;
        }

        .grafici-note {
            background: linear-gradient(135deg, #e3f2fd 0%, #e8f4fd 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border-left: 5px solid var(--info-color);
        }

        .grafici-note h3 {
            color: var(--info-color);
            margin-top: 0;
        }

        .grafici-note ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .grafici-note li {
            margin: 8px 0;
        }

        .footer {
            background: #343a40;
            color: white;
            padding: 25px;
            text-align: center;
            margin-top: 40px;
        }

        .footer p {
            margin: 5px 0;
        }

        .summary-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 20px 0;
        }

        .summary-box h4 {
            color: var(--primary-color);
            margin-top: 0;
        }

        @media print {
            body { margin: 0; padding: 10px; }
            .container { box-shadow: none; }
            .rating-card:hover { transform: none; }
        }

        @media (max-width: 768px) {
            .rating-cards {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üìä ceoDOC.it - ANALISI CENTRALE RISCHI</h1>
            <p><strong>Report identico a "Visualizza Analisi di Periodo"</strong></p>
            <p><strong>${denominazione}</strong></p>
            <p>CF: ${codiceFiscale}</p>
            <p>Generato: ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}</p>
        </div>

        <div class="content">
            <!-- RIEPILOGO PERIODO -->
            <div class="section">
                <h2>üìã RIEPILOGO ANALISI</h2>
                <div class="summary-box">
                    <h4>Dati del Periodo</h4>
                    <p><strong>Periodo analizzato:</strong> ${analisi.meseDa} ‚Üí ${analisi.meseA}</p>
                    <p><strong>Numero mesi:</strong> ${analisi.mesiValidi} mesi</p>
                    <p><strong>Consecutivit√†:</strong> ${analisi.consecutivita.consecutivi ? 'S√å - Mesi consecutivi' : 'NO - Mesi non consecutivi'}</p>
                    <p><strong>Mesi inclusi:</strong> ${analisi.mesiPeriodo.join(', ')}</p>
                </div>
            </div>

            <!-- 3 CARD RATING IDENTICHE ALL'ANALISI -->
            <div class="section">
                <h2>‚≠ê RATING MCC - TRE ORIZZONTI TEMPORALI</h2>
                <p>Rating calcolati secondo la metodologia MCC per diversi orizzonti temporali:</p>

                <div class="rating-cards">
                    <div class="rating-card arancione">
                        <h3>RATING ULTIMO MESE</h3>
                        <div class="rating-value">${analisi.ratingUltimo.classe}</div>
                        <p>${analisi.ratingUltimo.descrizione}</p>
                        <small><strong>Score:</strong> ${analisi.ratingUltimo.score?.toFixed(3) || 'N/A'}</small>
                    </div>

                    <div class="rating-card viola">
                        <h3>RATING 6 MESI</h3>
                        <div class="rating-value">${analisi.rating6Mesi.classe}</div>
                        <p>${analisi.rating6Mesi.descrizione}</p>
                        <small><strong>Score:</strong> ${analisi.rating6Mesi.score?.toFixed(3) || 'N/A'}</small>
                    </div>

                    <div class="rating-card verde">
                        <h3>RATING 12 MESI</h3>
                        <div class="rating-value">${analisi.rating12Mesi.classe}</div>
                        <p>${analisi.rating12Mesi.descrizione}</p>
                        <small><strong>Score:</strong> ${analisi.rating12Mesi.score?.toFixed(3) || 'N/A'}</small>
                    </div>
                </div>
            </div>

            <!-- STATISTICHE COMPLETE -->
            <div class="section">
                <h2>üìä STATISTICHE FINANZIARIE DEL PERIODO</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Accordato Medio</strong>
                        EUR ${analisi.statistichePeriodo.accordatoMedio?.toLocaleString('it-IT') || '0'}
                    </div>
                    <div class="stat-item">
                        <strong>Utilizzato Medio</strong>
                        EUR ${analisi.statistichePeriodo.utilizzatoMedio?.toLocaleString('it-IT') || '0'}
                    </div>
                    <div class="stat-item">
                        <strong>Utilizzo Percentuale</strong>
                        ${analisi.statistichePeriodo.utilizzoPerc?.toFixed(1) || '0'}%
                    </div>
                    <div class="stat-item">
                        <strong>Sconfini Totali</strong>
                        ${analisi.sconfiniPeriodo.totali || 0} episodi
                    </div>
                    <div class="stat-item">
                        <strong>Garantito Medio</strong>
                        EUR ${analisi.statistichePeriodo.garantitoMedio?.toLocaleString('it-IT') || '0'}
                    </div>
                    <div class="stat-item">
                        <strong>Mesi Analizzati</strong>
                        ${analisi.mesiValidi} su ${analisi.mesiPeriodo.length} disponibili
                    </div>
                </div>
            </div>

            <!-- GRAFICI DELL'ANALISI -->
            <div class="grafici-note">
                <h3>üìà GRAFICI DELL'ANALISI PERIODO</h3>
                <p>I grafici visualizzati nell'applicazione "Visualizza Analisi di Periodo" includono:</p>
                <ul>
                    <li><strong>Accordato vs Utilizzato con Sconfini</strong> - Ultimi 12 mesi con evidenziazione sconfini</li>
                    <li><strong>Distribuzione Rischi per Tipologia</strong> - Percentuali di revoca, autoliquidanti, scadenza</li>
                    <li><strong>Evoluzione Rating nel Tempo</strong> - Andamento rating per tutto il periodo disponibile</li>
                    <li><strong>Andamento Tipologie</strong> - Confronto utilizzo tra diverse categorie di rischio</li>
                </ul>
                <p><strong>Nota:</strong> Per visualizzare i grafici interattivi e dinamici, utilizza la funzione "Visualizza Analisi di Periodo" direttamente nell'applicazione ceoDOC.</p>
            </div>

            <!-- TABELLA COMPLETA IDENTICA -->
            <div class="section">
                <h2>üìã DETTAGLIO RISCHI COMPLETO</h2>
                <p>Tabella identica a quella mostrata in "Visualizza Analisi di Periodo" con evidenziazione degli sconfini:</p>

                <div class="table-container">
                    ${generaTabellaHTMLCompletaFedeleDefinitiva(analisi, azienda)}
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>ceoDOC.it - MCC RATING ANALYSIS PROTOCOL</strong></p>
            <p>Report fedele e identico a "Visualizza Analisi di Periodo"</p>
            <p>Timestamp generazione: ${analisi.timestamp}</p>
            <p>Versione: v1.5 - Export Fedeli</p>
        </div>
    </div>
</body>
</html>`;
}

// ===== GENERA TABELLA HTML DEFINITIVA =====
function generaTabellaHTMLCompletaFedeleDefinitiva(analisi, azienda) {
  if (!azienda || !analisi.mesiPeriodo) {
    return '<p style="text-align: center; color: #666; padding: 40px;">Nessun dato disponibile per la tabella</p>';
  }

  let html = `
    <table class="table">
        <thead>
            <tr>
                <th>Mese</th>
                <th>Intermediario</th>
                <th>Categoria</th>
                <th>Accordato</th>
                <th>Utilizzato</th>
                <th>Utilizzo %</th>
                <th>Garantito</th>
            </tr>
        </thead>
        <tbody>
  `;

  const mesiOrdinati = ordinaMesiCronologicamente(analisi.mesiPeriodo).reverse();
  let contatore = 0;

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    datiMese.intermediari.forEach(int => {
      if (int.rischi) {
        int.rischi.forEach(rischio => {
          const percUtilizzo = rischio.accordatoOperativo > 0 ?
            (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

          const isEccesso = rischio.utilizzato > rischio.accordatoOperativo;
          const classeRiga = isEccesso ? 'utilizzo-eccesso' : '';
          const tooltipEccesso = isEccesso ? ` title="SCONFINO: Utilizzato superiore all'accordato operativo"` : '';

          html += `
            <tr class="${classeRiga}"${tooltipEccesso}>
              <td><strong>${mese}</strong></td>
              <td>${int.nome}</td>
              <td>${rischio.categoria}</td>
              <td>EUR ${(rischio.accordato || 0).toLocaleString('it-IT')}</td>
              <td>EUR ${(rischio.utilizzato || 0).toLocaleString('it-IT')}</td>
              <td><strong>${percUtilizzo.toFixed(1)}%</strong></td>
              <td>EUR ${(rischio.garantito || 0).toLocaleString('it-IT')}</td>
            </tr>
          `;
          contatore++;
        });
      }
    });
  });

  html += `
        </tbody>
    </table>

    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #e8f4fd 100%); border-radius: 10px; text-align: center; border-left: 5px solid var(--info-color);">
        <h4 style="color: var(--info-color); margin: 0 0 10px 0;">üìä Riepilogo Tabella</h4>
        <p style="margin: 5px 0;"><strong>Totale record visualizzati:</strong> ${contatore}</p>
        <p style="margin: 5px 0;"><strong>Periodo:</strong> ${analisi.meseDa} ‚Üí ${analisi.meseA}</p>
        <p style="margin: 5px 0; font-style: italic;">Tabella identica a quella mostrata in "Visualizza Analisi di Periodo"</p>
        <p style="margin: 10px 0 0 0; color: #d32f2f; font-weight: bold;">üî¥ Le righe rosse indicano SCONFINI (utilizzato > accordato operativo)</p>
    </div>
  `;

  return html;
}

// ===== EXPORT TESTO COMPLETO (FALLBACK) =====
console.log('‚úÖ FUNZIONI EXPORT COMPLETE E DEFINITIVE CARICATE');
console.log('üéØ Sostituiscono TUTTE le funzioni di export esistenti');
console.log('üìä PDF, HTML e TXT fedeli a "Visualizza Analisi di Periodo"');

console.log('üìä PDF, HTML e TXT fedeli a "Visualizza Analisi di Periodo"');

// ===== EXPORT TESTO COMPLETO (FALLBACK) =====
function esportaAnalisiTestoCompleto(analisi, meseDa, meseA, mesiValidi, codiceFiscale, denominazione) {
  const contenutoTesto = `
===================================================================
            ceoDOC.it - MCC RATING ANALYSIS PROTOCOL
                   ANALISI CENTRALE RISCHI
                   REPORT COMPLETO FEDELE
===================================================================

AZIENDA: ${denominazione}
CODICE FISCALE: ${codiceFiscale}
PERIODO ANALIZZATO: ${meseDa} -> ${meseA} (${mesiValidi} mesi)
CONSECUTIVITA: ${analisi.consecutivita.consecutivi ? 'SI' : 'NO'}
GENERATO: ${new Date().toLocaleString('it-IT')}

===================================================================
                        RATING MCC - 3 ORIZZONTI
===================================================================

RATING ULTIMO MESE: ${analisi.ratingUltimo.classe}
Descrizione: ${pulisciTestoPDF(analisi.ratingUltimo.descrizione)}
Score: ${analisi.ratingUltimo.score?.toFixed(3) || 'N/A'}

RATING 6 MESI: ${analisi.rating6Mesi.classe}  
Descrizione: ${pulisciTestoPDF(analisi.rating6Mesi.descrizione)}
Score: ${analisi.rating6Mesi.score?.toFixed(3) || 'N/A'}

RATING 12 MESI: ${analisi.rating12Mesi.classe}
Descrizione: ${pulisciTestoPDF(analisi.rating12Mesi.descrizione)}
Score: ${analisi.rating12Mesi.score?.toFixed(3) || 'N/A'}

===================================================================
                     STATISTICHE PERIODO
===================================================================

- Accordato Medio: EUR ${analisi.statistichePeriodo.accordatoMedio?.toLocaleString('it-IT') || '0'}
- Utilizzato Medio: EUR ${analisi.statistichePeriodo.utilizzatoMedio?.toLocaleString('it-IT') || '0'}
- Utilizzo Percentuale: ${analisi.statistichePeriodo.utilizzoPerc?.toFixed(1) || '0'}%
- Garantito Medio: EUR ${analisi.statistichePeriodo.garantitoMedio?.toLocaleString('it-IT') || '0'}
- Sconfini Totali: ${analisi.sconfiniPeriodo.totali || 0} episodi

===================================================================
                        GRAFICI DISPONIBILI
===================================================================

I grafici mostrati in "Visualizza Analisi di Periodo" includono:
- Accordato vs Utilizzato con Sconfini (12 mesi)
- Distribuzione Rischi per Tipologia (12 mesi)
- Evoluzione Rating nel Tempo (periodo completo)
- Andamento Tipologie (12 mesi)

Per visualizzare i grafici interattivi, utilizza l'applicazione.

===================================================================
                           NOTE FINALI
===================================================================

- Report identico a "Visualizza Analisi di Periodo"
- Tabella completa consultabile nella versione HTML/PDF
- Calcoli rating secondo metodologia MCC Banca d'Italia
- Sconfini evidenziati quando utilizzato > accordato operativo

===================================================================
ceoDOC.it - MCC Rating Analysis Protocol
Report Fedele - Timestamp: ${analisi.timestamp}
===================================================================
  `;

  const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const nomeFile = `ceoDOC_analisi_periodo_testo_${codiceFiscale}_${timestamp}.txt`;

  const blob = new Blob([contenutoTesto], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = nomeFile;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast(`üìÑ Report testuale generato: ${nomeFile}`, 'success', 4000);
}


// ===== FUNZIONI HELPER =====

function calcolaDatiRealiPerGraficiPDF(analisi) {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !analisi.mesiPeriodo || analisi.mesiPeriodo.length === 0) {
    return { accordatoUtilizzato: [], distribuzione: {}, evoluzioneRating: [], andamentoTipologie: [] };
  }

  const dati = {
    accordatoUtilizzato: [],
    distribuzione: { revoca: {}, autoliquidanti: {}, scadenza: {}, garanzie: {} },
    evoluzioneRating: [],
    andamentoTipologie: [],
    maxAccordato: 0
  };

  let totRevoca = 0, totAutoliq = 0, totScadenza = 0, totGaranzie = 0;

  analisi.mesiPeriodo.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    let accMese = 0, utilMese = 0;
    let revocaMese = 0, autoliqMese = 0, scadenzaMese = 0, garanzieMese = 0;

    datiMese.intermediari.forEach(int => {
      if (int.rischi) {
        int.rischi.forEach(rischio => {
          accMese += rischio.accordatoOperativo || 0;
          utilMese += rischio.utilizzato || 0;

          if (rischio.categoria.includes('REVOCA')) {
            revocaMese += rischio.utilizzato || 0;
            totRevoca += rischio.utilizzato || 0;
          } else if (rischio.categoria.includes('AUTOLIQUIDANTI')) {
            autoliqMese += rischio.utilizzato || 0;
            totAutoliq += rischio.utilizzato || 0;
          } else if (rischio.categoria.includes('SCADENZA')) {
            scadenzaMese += rischio.utilizzato || 0;
            totScadenza += rischio.utilizzato || 0;
          }

          if (rischio.garantito > 0) {
            garanzieMese += rischio.garantito || 0;
            totGaranzie += rischio.garantito || 0;
          }
        });
      }
    });

    const utilizzoPerc = accMese > 0 ? ((utilMese / accMese) * 100).toFixed(1) : '0.0';
    dati.accordatoUtilizzato.push({
      mese: abbreviaMesePDF(mese),
      accordato: accMese,
      utilizzato: utilMese,
      accordatoK: (accMese / 1000).toFixed(0),
      utilizzatoK: (utilMese / 1000).toFixed(0),
      utilizzoPerc: utilizzoPerc
    });

    dati.maxAccordato = Math.max(dati.maxAccordato, accMese);

    const ratingMese = calcolaRatingMeseSafe(datiMese, azienda.naturaGiuridica || 'SRL');
    dati.evoluzioneRating.push({
      mese: abbreviaMesePDF(mese),
      rating: ratingMese.classe,
      descrizione: ratingMese.descrizione,
      score: ratingMese.score
    });

    dati.andamentoTipologie.push({
      mese: abbreviaMesePDF(mese),
      revoca: revocaMese,
      autoliq: autoliqMese,
      scadenza: scadenzaMese,
      revocaK: (revocaMese / 1000).toFixed(0),
      autoliqK: (autoliqMese / 1000).toFixed(0),
      scadenzaK: (scadenzaMese / 1000).toFixed(0)
    });
  });

  const totaleDistrib = totRevoca + totAutoliq + totScadenza;
  if (totaleDistrib > 0) {
    dati.distribuzione = {
      revoca: {
        importo: totRevoca,
        importoK: (totRevoca / 1000).toFixed(0),
        percentuale: ((totRevoca / totaleDistrib) * 100).toFixed(1)
      },
      autoliquidanti: {
        importo: totAutoliq,
        importoK: (totAutoliq / 1000).toFixed(0),
        percentuale: ((totAutoliq / totaleDistrib) * 100).toFixed(1)
      },
      scadenza: {
        importo: totScadenza,
        importoK: (totScadenza / 1000).toFixed(0),
        percentuale: ((totScadenza / totaleDistrib) * 100).toFixed(1)
      },
      garanzie: {
        importo: totGaranzie,
        importoK: (totGaranzie / 1000).toFixed(0),
        percentuale: totaleDistrib > 0 ? ((totGaranzie / totaleDistrib) * 100).toFixed(1) : '0.0'
      }
    };
  }

  return dati;
}


function abbreviaMesePDF(mese) {
  const conversioni = {
    'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
    'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
    'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
  };
  const parti = mese.toLowerCase().split(' ');
  if (parti.length >= 2) {
    const meseNome = parti[0];
    const anno = parti[1];
    const meseAbbr = conversioni[meseNome] || meseNome.substring(0, 3);
    const annoAbbr = anno.length === 4 ? anno.substring(2, 4) : anno;
    return `${meseAbbr}-${annoAbbr}`;
  }
  return mese.substring(0, 8);
}

function pulisciTestoPDF(testo) {
  // Rimuove emoji e caratteri speciali problematici per PDF
  if (!testo) return '';
  return testo
    .replace(/[üìäüìàüìâüí∞üö®‚ö†Ô∏è‚úÖ‚ùåüü¢üü°üî¥üîµüü†üìãüíæüìÑüåêüîóüìß]/g, '') // Rimuove emoji
    .replace(/'/g, "'") // Apostrofo normale
    .replace(/'/g, "'")
    .replace(/"/g, '"')
    .replace(/"/g, '"')
    .replace(/‚Äì/g, '-')
    .replace(/‚Äî/g, '-')
    .replace(/‚Ä¶/g, '...')
    .trim();
}


// ===== FEEDBACK EMAIL =====
function inviaFeedbackEmail(meseDa, meseA) {
  try {
    const analisi = window.ultimaAnalisiGenerata;
    const aziendaInfo = analisi ? (analisi.azienda.denominazione || analisi.azienda.codiceFiscale || 'N/A') : 'N/A';

    const oggetto = encodeURIComponent('Feedback su ceoDOC.it - MCC RATING ANALYSIS PROTOCOL');
    const corpo = encodeURIComponent(`Gentile Team ceoDOC,

vi scrivo per fornire un feedback sull'MCC Rating Analysis Protocol:

DETTAGLI ANALISI:
- Azienda: ${aziendaInfo}
- Periodo: ${meseDa} ‚Üí ${meseA}
- Data generazione: ${new Date().toLocaleDateString('it-IT')}

FEEDBACK:
[Inserisci qui i tuoi commenti, suggerimenti o segnalazioni]

Cordiali saluti`);

    const mailtoLink = `mailto:info@ceodoc.it?subject=${oggetto}&body=${corpo}`;

    // Apri client email
    window.open(mailtoLink, '_blank');

    showToast('üìß Client email aperto! Completa e invia il feedback.', 'success', 4000);

  } catch (error) {
    console.error('Errore apertura email:', error);
    showToast('‚ùå Errore apertura client email', 'error');
  }
}

function generaSummaryInsoluti(analisi) {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda.altreInformazioni?.crediti) {
    return '‚Ä¢ Nessun dato insoluti disponibile';
  }

  const crediti = azienda.altreInformazioni.crediti;
  const creditiPeriodo = crediti.filter(c => analisi.mesiPeriodo.includes(c.mese));

  if (creditiPeriodo.length === 0) {
    return '‚Ä¢ Nessun insoluto nel periodo';
  }

  const totalePagati = creditiPeriodo.reduce((sum, c) => sum + c.pagati, 0);
  const totaleImpagati = creditiPeriodo.reduce((sum, c) => sum + c.impagati, 0);
  const totaleCrediti = totalePagati + totaleImpagati;
  const percInsoluti = totaleCrediti > 0 ? (totaleImpagati / totaleCrediti * 100) : 0;

  return `‚Ä¢ Crediti Pagati: ‚Ç¨${totalePagati.toLocaleString('it-IT')}
- Crediti Impagati: ‚Ç¨${totaleImpagati.toLocaleString('it-IT')}
- % Insoluti: ${percInsoluti.toFixed(2)}%`;
}

function copiaAnalisiPeriodoLink(meseDa, meseA) {
  if (!window.ultimaAnalisiGenerata) {
    showToast('‚ùå Nessuna analisi periodo da condividere', 'error');
    return;
  }

  const analisi = window.ultimaAnalisiGenerata;

  const testoCondivisione = `üìä ANALISI PERIODO CENTRALE RISCHI - ${analisi.azienda.denominazione || analisi.azienda.codiceFiscale}

üóìÔ∏è Periodo: ${meseDa} ‚Üí ${meseA} (${analisi.mesiValidi} mesi)
üîó Consecutivo: ${analisi.consecutivita.consecutivi ? 'S√å' : 'NO'}
üìà Rating Ultimo: ${analisi.ratingUltimo.classe}
üìä Rating 6M: ${analisi.rating6Mesi.classe}
üí∞ Rating 12M: ${analisi.rating12Mesi.classe}
üö® Sconfini: ${analisi.sconfiniPeriodo.totali}

üí∞ INSOLUTI PERIODO:
${generaSummaryInsoluti(analisi)}

üìÖ Generato: ${new Date().toLocaleString('it-IT')}
üîß ceoDOC Centrale Rischi v1.4`;

  if (navigator.clipboard) {
    navigator.clipboard.writeText(testoCondivisione).then(() => {
      showToast('üîó Summary periodo copiato negli appunti!', 'success', 3000);
    }).catch(() => fallbackCopy(testoCondivisione));
  } else {
    fallbackCopy(testoCondivisione);
  }
}

function fallbackCopy(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.opacity = '0';
  document.body.appendChild(textArea);
  textArea.select();

  try {
    document.execCommand('copy');
    showToast('üîó Summary copiato negli appunti!', 'success', 3000);
  } catch (err) {
    showToast('‚ùå Impossibile copiare automaticamente', 'error');
  }

  document.body.removeChild(textArea);
}

 // ===== FUNZIONE CANCELLA CR CON GESTIONE 60 MESI =====

function cancellaCRPeriodo() {
  if (!verificaAziendaSelezionata()) return;

  // Calcola statistiche mesi caricati
  const azienda = archivioAziende[aziendaCorrente];
  const mesiCaricati = Object.keys(azienda.mesi || {}).length;
  const LIMITE_MESI = 60; // Limite massimo mesi
  const mesiRimanenti = Math.max(0, LIMITE_MESI - mesiCaricati);
  const isAlLimite = mesiCaricati >= LIMITE_MESI;

  // Determina messaggio stato capacit√†
  let messaggioCapacita = '';
  let coloreCapacita = '#666';

  if (isAlLimite) {
    messaggioCapacita = `‚ö†Ô∏è <strong>Capacit√† massima raggiunta</strong> (${mesiCaricati}/${LIMITE_MESI} mesi)<br>Per aggiungere nuovi mesi √® necessario eliminare i pi√π vecchi`;
    coloreCapacita = '#d32f2f';
  } else if (mesiRimanenti <= 12) {
    messaggioCapacita = `üìä Capacit√†: <strong>${mesiCaricati}/${LIMITE_MESI} mesi</strong> | Spazio rimanente: <strong style="color: #ff9800;">${mesiRimanenti} mesi</strong>`;
    coloreCapacita = '#ff9800';
  } else {
    messaggioCapacita = `üìä Capacit√†: <strong>${mesiCaricati}/${LIMITE_MESI} mesi</strong> | Spazio rimanente: <strong style="color: #4caf50;">${mesiRimanenti} mesi</strong>`;
    coloreCapacita = '#4caf50';
  }

  // Pulsante per liberare spazio (solo se al limite)
  const pulsanteLiberaSpazio = isAlLimite ? `
    <button onclick="cancellaVecchiPerNuovi()" style="
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); 
      color: white; border: none; padding: 15px 20px; border-radius: 8px; 
      font-weight: bold; cursor: pointer; transition: all 0.3s;
      font-size: 0.95em; border: 2px solid #1976d2;"
      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(33,150,243,0.3)'"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
    >
      üîÑ LIBERA SPAZIO PER NUOVI MESI<br>
      <small style="font-weight: normal; opacity: 0.9;">Elimina automaticamente i mesi pi√π vecchi</small>
    </button>
  ` : '';

  // Crea modal per scegliere tipo di cancellazione
  const modalHTML = `
    <div id="modalCancellaCR" style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); z-index: 9999; display: flex; 
      align-items: center; justify-content: center;"
    >
      <div style="
        background: white; padding: 30px; border-radius: 15px; 
        max-width: 520px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        text-align: center;"
      >
        <h3 style="color: #ff6b00; margin-bottom: 20px; font-size: 1.4em;">
          üóëÔ∏è GESTIONE DATI CENTRALE RISCHI
        </h3>

        <div style="
          background: #f8f9fa; padding: 15px; border-radius: 8px; 
          margin-bottom: 20px; border-left: 4px solid ${coloreCapacita};"
        >
          <p style="margin: 0; color: ${coloreCapacita}; line-height: 1.5; font-size: 0.95em;">
            <strong>${azienda?.anagrafica?.denominazione || 'Azienda corrente'}</strong><br>
            ${messaggioCapacita}
          </p>
        </div>

        <p style="margin-bottom: 25px; color: #666; line-height: 1.5; font-size: 0.9em;">
          Seleziona l'operazione di cancellazione da eseguire:
        </p>

        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
          ${pulsanteLiberaSpazio}

          <button onclick="mostraSelezionePeriodoCancella()" style="
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); 
            color: white; border: none; padding: 15px 20px; border-radius: 8px; 
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            font-size: 0.95em;"
            onmouseover="this.style.transform='translateY(-2px)'"
            onmouseout="this.style.transform='translateY(0)'"
          >
            üìÖ CANCELLAZIONE PERIODO SELETTIVA<br>
            <small style="font-weight: normal; opacity: 0.9;">Scegli esattamente quali mesi eliminare</small>
          </button>

<button onclick="cancellaTuttiDatiCR()" style="
            background: #dc2626; color: white; border: none; padding: 15px 20px; border-radius: 8px; 
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            font-size: 0.95em; margin-top: 15px;"
            onmouseover="this.style.transform='translateY(-2px)'"
            onmouseout="this.style.transform='translateY(0)'"
          >
            üóëÔ∏è CANCELLA TUTTI I DATI CR<br>
            <small style="font-weight: normal; opacity: 0.9;">Mantieni anagrafica, cancella solo dati CR</small>
          </button>

        </div>

        <button onclick="chiudiModalCancellaCR()" style="
          background: #6c757d; color: white; border: none; 
          padding: 10px 20px; border-radius: 6px; cursor: pointer;"
        >
          Annulla
        </button>
      </div>
    </div>
  `;

  // Aggiungi modal al DOM
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function cancellaVecchiPerNuovi() {
  const azienda = archivioAziende[aziendaCorrente];
  const mesiDisponibili = Object.keys(azienda.mesi || {});
  const denominazione = azienda?.anagrafica?.denominazione || 'Azienda corrente';

  if (mesiDisponibili.length === 0) {
    showToast('‚ùå Nessun dato da gestire', 'error');
    chiudiModalCancellaCR();
    return;
  }

  // Ordina mesi cronologicamente e identifica i pi√π vecchi
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDisponibili);
  const LIMITE_MESI = 60;
  const numeroMesiDaEliminare = Math.max(1, Math.min(12, mesiOrdinati.length - LIMITE_MESI + 12));
  const mesiDaEliminare = mesiOrdinati.slice(0, numeroMesiDaEliminare);
  const mesiRimanenti = mesiOrdinati.slice(numeroMesiDaEliminare);

  // Aggiorna contenuto modal per conferma
  const modal = document.getElementById('modalCancellaCR');
  const modalContent = modal.querySelector('div');

  modalContent.innerHTML = `
    <h3 style="color: #2196f3; margin-bottom: 20px; font-size: 1.4em;">
      üîÑ OTTIMIZZAZIONE SPAZIO ARCHIVIO
    </h3>

    <div style="
      background: #e3f2fd; padding: 15px; border-radius: 8px; 
      margin-bottom: 20px; border-left: 4px solid #2196f3;"
    >
      <p style="margin: 0; color: #1976d2; line-height: 1.5; font-size: 0.95em;">
        <strong>${denominazione}</strong><br>
        üìä Attualmente: <strong>${mesiOrdinati.length}/60 mesi</strong> | Operazione: <strong>Liberazione spazio</strong>
      </p>
    </div>

    <div style="text-align: left; margin-bottom: 20px;">
      <div style="
        background: #fff3e0; padding: 15px; border-radius: 8px; 
        border-left: 4px solid #ff9800; margin-bottom: 15px;"
      >
        <h4 style="margin: 0 0 10px 0; color: #f57c00; font-size: 1em;">
          üìã MESI DA ELIMINARE (${numeroMesiDaEliminare} pi√π vecchi):
        </h4>
        <div style="
          max-height: 120px; overflow-y: auto; 
          font-size: 0.85em; color: #666; line-height: 1.4;"
        >
          ${mesiDaEliminare.map(mese => `‚Ä¢ ${mese}`).join('<br>')}
        </div>
      </div>

      <div style="
        background: #e8f5e8; padding: 15px; border-radius: 8px; 
        border-left: 4px solid #4caf50;"
      >
        <h4 style="margin: 0 0 10px 0; color: #388e3c; font-size: 1em;">
          ‚úÖ SPAZIO LIBERATO:
        </h4>
        <div style="font-size: 0.9em; color: #333;">
          ‚Ä¢ <strong>${numeroMesiDaEliminare} mesi rimossi</strong> (${mesiDaEliminare[0]} ‚Üí ${mesiDaEliminare[mesiDaEliminare.length - 1]})<br>
          ‚Ä¢ <strong>${mesiRimanenti.length} mesi conservati</strong> (${mesiRimanenti[0]} ‚Üí ${mesiRimanenti[mesiRimanenti.length - 1]})<br>
          ‚Ä¢ <strong>${60 - mesiRimanenti.length} slot disponibili</strong> per nuovi import
        </div>
      </div>
    </div>

    <div style="
      background: #f5f5f5; padding: 12px; border-radius: 6px; 
      margin-bottom: 20px; font-size: 0.85em; color: #666; text-align: center;"
    >
      üí° <strong>Raccomandazione:</strong> Questa operazione ottimizza l'archivio mantenendo i dati pi√π recenti e rilevanti per l'analisi
    </div>

    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="confermaEliminazioneVecchi()" style="
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); 
        color: white; border: none; padding: 12px 20px; border-radius: 6px; 
        font-weight: bold; cursor: pointer;"
      >
        ‚úÖ Conferma Ottimizzazione
      </button>

      <button onclick="chiudiModalCancellaCR()" style="
        background: #6c757d; color: white; border: none; 
        padding: 12px 20px; border-radius: 6px; cursor: pointer;"
      >
        Annulla
      </button>

      <button onclick="tornaPrimoPasso()" style="
        background: #17a2b8; color: white; border: none; 
        padding: 12px 20px; border-radius: 6px; cursor: pointer;"
      >
        ‚Üê Torna Indietro
      </button>
    </div>
  `;
}

function confermaEliminazioneVecchi() {
  const azienda = archivioAziende[aziendaCorrente];
  const mesiDisponibili = Object.keys(azienda.mesi || {});
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDisponibili);
  const denominazione = azienda?.anagrafica?.denominazione || 'Azienda corrente';

  const LIMITE_MESI = 60;
  const numeroMesiDaEliminare = Math.max(1, Math.min(12, mesiOrdinati.length - LIMITE_MESI + 12));
  const mesiDaEliminare = mesiOrdinati.slice(0, numeroMesiDaEliminare);

  const conferma = confirm(`üîÑ CONFERMA OTTIMIZZAZIONE ARCHIVIO\n\n‚Ä¢ Azienda: ${denominazione}\n‚Ä¢ Mesi da eliminare: ${numeroMesiDaEliminare}\n‚Ä¢ Periodo: ${mesiDaEliminare[0]} ‚Üí ${mesiDaEliminare[mesiDaEliminare.length - 1]}\n‚Ä¢ Spazio liberato: ${60 - (mesiOrdinati.length - numeroMesiDaEliminare)} slot\n\n‚úÖ Procedere con l'ottimizzazione?`);

  if (conferma) {
    // Elimina i mesi pi√π vecchi
    mesiDaEliminare.forEach(mese => {
      delete azienda.mesi[mese];
    });

// Reset Altre Informazioni
if (azienda.altreInformazioni) {
  delete azienda.altreInformazioni;
  console.log('üóëÔ∏è Altre Informazioni resettate (eliminazione vecchi)');
}

// Reset variabili globali
window._creditiAnalisi = [];
window._garanzieAnalisi = [];
window._richiesteAnalisi = [];
window._creditiRawBreakdown = {};

    // Chiudi modal
    chiudiModalCancellaCR();

    // Aggiorna interfaccia
    aggiornaInterfaccia();

    const mesiRimanenti = Object.keys(azienda.mesi || {}).length;
    const spazioLibero = 60 - mesiRimanenti;

    showToast(`üîÑ Archivio ottimizzato: ${numeroMesiDaEliminare} mesi eliminati, ${spazioLibero} slot disponibili`, 'success', 5000);
  }
}

function cancellaTuttiDatiCR() {
  const azienda = archivioAziende[aziendaCorrente];
  const denominazione = azienda?.anagrafica?.denominazione || 'Azienda corrente';

  const conferma = confirm(`‚ö†Ô∏è CANCELLAZIONE DATI CR\n\nVuoi cancellare TUTTI i dati CR di:\n"${denominazione}"\n\nQuesta operazione eliminer√†:\n‚Ä¢ Tutti i mesi CR importati\n‚Ä¢ Tutte le analisi generate\n\n‚úÖ L'anagrafica sar√† mantenuta\n\nContinuare?`);

  if (conferma) {
    // 1. BACKUP anagrafica (la parte da mantenere)
    const anagraficaBackup = {
      cf: azienda.anagrafica.cf,
      denominazione: azienda.anagrafica.denominazione,
      sedeLegale: azienda.anagrafica.sedeLegale,
      naturaGiuridica: azienda.naturaGiuridica,
      settore: azienda.anagrafica.settore,
      dataInserimento: azienda.anagrafica.dataInserimento
    };

    // 2. Reset variabili globali
    window._creditiAnalisi = [];
    window._garanzieAnalisi = [];
    window._richiesteAnalisi = [];
    window._creditiRawBreakdown = {};

    // 3. RICREA COMPLETAMENTE l'oggetto azienda (solo con anagrafica)
    archivioAziende[aziendaCorrente] = {
      anagrafica: anagraficaBackup,
      naturaGiuridica: anagraficaBackup.naturaGiuridica,
      mesi: {} // Oggetto completamente nuovo e vuoto
    };

    console.log('üóëÔ∏è Azienda completamente ricostruita con sola anagrafica');

    // 4. Pulizia interfaccia (come prima)
    setTimeout(() => {
      const canvas1 = document.getElementById('tachimetroProminente1');
      const canvas2 = document.getElementById('tachimetroProminente2'); 
      const canvas3 = document.getElementById('tachimetroProminente3');

      [canvas1, canvas2, canvas3].forEach((canvas, index) => {
        if (canvas) {
          const indicatore = canvas.parentElement?.querySelector('.tachimetro-indicator');
          if (indicatore) indicatore.remove();

          const chartKey = `tachimetroChart_tachimetroProminente${index + 1}`;
          if (window[chartKey]) {
            window[chartKey].destroy();
            window[chartKey] = null;
          }

          const ctx = canvas.getContext('2d');
          if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      });

      document.getElementById('ratingValue1').textContent = '--';
      document.getElementById('ratingDescription1').textContent = 'Nessun dato disponibile';
      document.getElementById('ratingValue2').textContent = '--';
      document.getElementById('ratingDescription2').textContent = 'Nessun dato disponibile';
      document.getElementById('ratingValue3').textContent = '--';
      document.getElementById('ratingDescription3').textContent = 'Nessun dato disponibile';

      const areaContenuti = document.getElementById('contenutoAnalisi');
      if (areaContenuti) areaContenuti.innerHTML = '';

      const mesiCounter = document.getElementById('mesiCounter');
      if (mesiCounter) mesiCounter.innerHTML = 'Mesi<br>0';

      console.log('üßπ Interfaccia pulita');
    }, 200);

    // 5. Aggiornamento finale
    chiudiModalCancellaCR();

    setTimeout(() => {
      aggiornaInterfaccia();
      if (typeof aggiornaRatingProminente === 'function') aggiornaRatingProminente();
      if (typeof salvaDatiLocali === 'function') salvaDatiLocali();
    }, 400);

    showToast(`üóëÔ∏è "${denominazione}" completamente resettata. Pronta per nuovi import.`, 'success', 4000);
  }
}

function mostraSelezionePeriodoCancella() {
  const azienda = archivioAziende[aziendaCorrente];
  const mesiDisponibili = Object.keys(azienda.mesi || {});
  const LIMITE_MESI = 60;

  if (mesiDisponibili.length === 0) {
    showToast('‚ùå Nessun mese disponibile da cancellare', 'error');
    chiudiModalCancellaCR();
    return;
  }

  // Ordina mesi cronologicamente
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDisponibili);
  const mesiRimanenti = LIMITE_MESI - mesiOrdinati.length;

  // Aggiorna contenuto modal
  const modal = document.getElementById('modalCancellaCR');
  const modalContent = modal.querySelector('div');

  modalContent.innerHTML = `
    <h3 style="color: #ff9800; margin-bottom: 20px; font-size: 1.4em;">
      üìÖ CANCELLAZIONE PERIODO SELETTIVA
    </h3>

    <div style="
      background: #fff3e0; padding: 15px; border-radius: 8px; 
      margin-bottom: 20px; border-left: 4px solid #ff9800;"
    >
      <p style="margin: 0; color: #f57c00; line-height: 1.5; font-size: 0.95em;">
        <strong>${azienda.anagrafica?.denominazione || 'Azienda corrente'}</strong><br>
        üìä Archivio: <strong>${mesiOrdinati.length}/${LIMITE_MESI} mesi</strong> | 
        Spazio disponibile: <strong style="color: ${mesiRimanenti > 12 ? '#4caf50' : '#ff9800'}">${Math.max(0, mesiRimanenti)} mesi</strong>
      </p>
    </div>

    <p style="margin-bottom: 20px; color: #666; line-height: 1.5; font-size: 0.9em;">
      Seleziona con precisione il periodo temporale da eliminare dall'archivio:
    </p>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
          Mese DA:
        </label>
        <select id="meseDaCancella" style="
          width: 100%; padding: 10px; border: 2px solid #ddd; 
          border-radius: 6px; font-size: 14px;"
        >
          <option value="">Seleziona mese inizio</option>
          ${mesiOrdinati.map(mese => `<option value="${mese}">${mese}</option>`).join('')}
        </select>
      </div>

      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
          Mese A:
        </label>
        <select id="meseACancella" style="
          width: 100%; padding: 10px; border: 2px solid #ddd; 
          border-radius: 6px; font-size: 14px;"
        >
          <option value="">Seleziona mese fine</option>
          ${mesiOrdinati.map(mese => `<option value="${mese}">${mese}</option>`).join('')}
        </select>
      </div>
    </div>

    <div id="infoPerodooCancella" style="
      background: #e3f2fd; padding: 12px; border-radius: 6px; 
      margin-bottom: 20px; font-size: 0.9em; color: #1976d2;
      display: none;"
    ></div>

    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="confermaCancellazionePeriodo()" style="
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
        color: white; border: none; padding: 12px 20px; border-radius: 6px; 
        font-weight: bold; cursor: pointer; opacity: 0.5;"
        id="btnConfermaCancella" disabled
      >
        üóëÔ∏è Cancella Periodo
      </button>

      <button onclick="chiudiModalCancellaCR()" style="
        background: #6c757d; color: white; border: none; 
        padding: 12px 20px; border-radius: 6px; cursor: pointer;"
      >
        Annulla
      </button>

      <button onclick="tornaPrimoPasso()" style="
        background: #17a2b8; color: white; border: none; 
        padding: 12px 20px; border-radius: 6px; cursor: pointer;"
      >
        ‚Üê Torna Indietro
      </button>
    </div>
  `;

  // Aggiungi event listeners per validazione
  document.getElementById('meseDaCancella').addEventListener('change', validaPeriodoCancella);
  document.getElementById('meseACancella').addEventListener('change', validaPeriodoCancella);
}

function validaPeriodoCancella() {
  const meseDa = document.getElementById('meseDaCancella')?.value;
  const meseA = document.getElementById('meseACancella')?.value;
  const infoDiv = document.getElementById('infoPerodooCancella');
  const btnConferma = document.getElementById('btnConfermaCancella');

  if (!meseDa || !meseA) {
    infoDiv.style.display = 'none';
    btnConferma.disabled = true;
    btnConferma.style.opacity = '0.5';
    return;
  }

  // Calcola mesi nel periodo
  const azienda = archivioAziende[aziendaCorrente];
  const mesiDisponibili = Object.keys(azienda.mesi || {});
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDisponibili);

  const indiceDa = mesiOrdinati.indexOf(meseDa);
  const indiceA = mesiOrdinati.indexOf(meseA);

  if (indiceDa === -1 || indiceA === -1) {
    infoDiv.style.display = 'none';
    btnConferma.disabled = true;
    btnConferma.style.opacity = '0.5';
    return;
  }

  const indiceMin = Math.min(indiceDa, indiceA);
  const indiceMax = Math.max(indiceDa, indiceA);
  const mesiPeriodo = mesiOrdinati.slice(indiceMin, indiceMax + 1);

  // Mostra info periodo
  infoDiv.style.display = 'block';

  const LIMITE_MESI = 60;
  const mesiAttuali = mesiOrdinati.length;
  const mesiDopoEliminazione = mesiAttuali - mesiPeriodo.length;
  const spazioLiberato = mesiPeriodo.length;
  const nuovaCapacitaDisponibile = LIMITE_MESI - mesiDopoEliminazione;

  infoDiv.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
      <div>
        <strong style="color: #f44336;">üìä ELIMINAZIONE:</strong><br>
        ‚Ä¢ Periodo: ${meseDa} ‚Üí ${meseA}<br>
        ‚Ä¢ Mesi da eliminare: <strong>${mesiPeriodo.length}</strong><br>
        ‚Ä¢ Primo: ${mesiPeriodo[0]}<br>
        ‚Ä¢ Ultimo: ${mesiPeriodo[mesiPeriodo.length - 1]}
      </div>
      <div>
        <strong style="color: #4caf50;">üìà RISULTATO POST-OPERAZIONE:</strong><br>
        ‚Ä¢ Mesi rimanenti: <strong>${mesiDopoEliminazione}</strong><br>
        ‚Ä¢ Capacit√† liberata: <strong>+${spazioLiberato} slot</strong><br>
        ‚Ä¢ Spazio totale disponibile: <strong>${nuovaCapacitaDisponibile}/${LIMITE_MESI}</strong><br>
        ‚Ä¢ Utilizzo archivio: <strong>${((mesiDopoEliminazione/LIMITE_MESI)*100).toFixed(1)}%</strong>
      </div>
    </div>
  `;

  // Cambia colore in base al numero di mesi
  if (mesiPeriodo.length === mesiOrdinati.length) {
    infoDiv.style.background = '#ffebee';
    infoDiv.style.color = '#c62828';
    infoDiv.innerHTML += `
      <div style="
        margin-top: 15px; padding: 10px; background: #f44336; color: white; 
        border-radius: 6px; text-align: center; font-weight: bold;"
      >
        ‚ö†Ô∏è ATTENZIONE: CANCELLAZIONE COMPLETA DATI CR<br>
        <small style="font-weight: normal;">Questa operazione eliminer√† tutti i dati mensili caricati</small><br>
        <small style="font-weight: normal;">Per cancellare l'anagrafica cliccare sul pulsante "Elimina anagrafica selezionata"</small>
      </div>
    `;
  } else if (mesiPeriodo.length >= mesiOrdinati.length * 0.5) {
    infoDiv.innerHTML += `
      <div style="
        margin-top: 10px; padding: 8px; background: #ff9800; color: white; 
        border-radius: 4px; text-align: center; font-size: 0.85em;"
      >
        üìã Operazione significativa: eliminerai oltre il 50% dell'archivio
      </div>
    `;
  }

  // Abilita pulsante
  btnConferma.disabled = false;
  btnConferma.style.opacity = '1';
}

function confermaCancellazionePeriodo() {
  const meseDa = document.getElementById('meseDaCancella')?.value;
  const meseA = document.getElementById('meseACancella')?.value;

  if (!meseDa || !meseA) {
    showToast('‚ùå Seleziona entrambi i mesi', 'error');
    return;
  }

  const azienda = archivioAziende[aziendaCorrente];
  const mesiDisponibili = Object.keys(azienda.mesi || {});
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDisponibili);

  const indiceDa = mesiOrdinati.indexOf(meseDa);
  const indiceA = mesiOrdinati.indexOf(meseA);
  const indiceMin = Math.min(indiceDa, indiceA);
  const indiceMax = Math.max(indiceDa, indiceA);
  const mesiDaCancellare = mesiOrdinati.slice(indiceMin, indiceMax + 1);

  let messaggioDettagliato = `üîç ELIMINAZIONE PERIODI CR\n\n`;
  messaggioDettagliato += `‚Ä¢ Azienda: ${azienda.anagrafica?.denominazione || 'Azienda corrente'}\n`;
  messaggioDettagliato += `‚Ä¢ Periodo: ${meseDa} ‚Üí ${meseA}\n`;
  messaggioDettagliato += `‚Ä¢ Mesi da eliminare: ${mesiDaCancellare.length}\n\n`;
  messaggioDettagliato += `üîÑ Confermi l'operazione?`;

  const conferma = confirm(messaggioDettagliato);

  if (conferma) {
    // Cancella solo i mesi selezionati
    mesiDaCancellare.forEach(mese => {
      delete azienda.mesi[mese];
    });

// Reset Altre Informazioni se tutti i mesi sono stati cancellati
if (Object.keys(azienda.mesi || {}).length === 0) {
  if (azienda.altreInformazioni) {
    delete azienda.altreInformazioni;
    console.log('üóëÔ∏è Altre Informazioni resettate (tutti i mesi cancellati)');
  }

  // Reset variabili globali
  window._creditiAnalisi = [];
  window._garanzieAnalisi = [];
  window._richiesteAnalisi = [];
  window._creditiRawBreakdown = {};
}

    // Salva su localStorage (se hai una funzione, altrimenti togli la riga)
    if (typeof salvaDatiLocali === 'function') salvaDatiLocali();

    // Chiudi modal
    chiudiModalCancellaCR();

    // Se NON rimangono mesi dopo la cancellazione, resetta tutto
    if (Object.keys(azienda.mesi || {}).length === 0) {
      if (typeof resetAnalisiView === 'function') resetAnalisiView();
      showToast('‚úÖ Tutti i periodi sono stati eliminati. Nessun dato di periodo presente.', 'info');
    }

    // Aggiorna interfaccia e contatori (sempre, anche se rimangono mesi)
    if (typeof aggiornaInterfaccia === 'function') aggiornaInterfaccia();
    if (typeof aggiornaContatoreMesi === 'function') aggiornaContatoreMesi();

    showToast('üîÑ Periodi cancellati e dati salvati', 'success', 4000);
showToast('üîÑ Periodi cancellati e dati salvati', 'success', 4000);

// ========== PULIZIA COMPLETA TACHIMETRI ==========
setTimeout(() => {
  // 1. Rimuovi le faccine (come prima)
  const canvas1 = document.getElementById('tachimetroProminente1');
  const canvas2 = document.getElementById('tachimetroProminente2'); 
  const canvas3 = document.getElementById('tachimetroProminente3');

  [canvas1, canvas2, canvas3].forEach((canvas, index) => {
    if (canvas) {
      // Rimuovi l'indicatore con faccina
      const indicatore = canvas.parentElement?.querySelector('.tachimetro-indicator');
      if (indicatore) indicatore.remove();

      // Distruggi il grafico Chart.js
      const chartKey = `tachimetroChart_tachimetroProminente${index + 1}`;
      if (window[chartKey]) {
        window[chartKey].destroy();
        window[chartKey] = null;
      }

      // Pulisci il canvas
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      console.log(`üßπ Tachimetro ${index + 1} completamente pulito`);
    }
  });
}, 200);
  }
}

function tornaPrimoPasso() {
  // Torna al modal iniziale
  chiudiModalCancellaCR();
  setTimeout(() => {
    cancellaCRPeriodo();
  }, 100);
}

function chiudiModalCancellaCR() {
  const modal = document.getElementById('modalCancellaCR');
  if (modal) {
    modal.remove();
  }
}

// ===== FUNZIONE HELPER PER ORDINAMENTO MESI =====
function ordinaMesiCronologicamente(mesi) {
  const mesiItaliani = [
    'gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
    'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'
  ];

  return mesi.sort((a, b) => {
    const [meseA, annoA] = a.toLowerCase().split(' ');
    const [meseB, annoB] = b.toLowerCase().split(' ');

    const annoNumA = parseInt(annoA) || 0;
    const annoNumB = parseInt(annoB) || 0;

    if (annoNumA !== annoNumB) {
      return annoNumA - annoNumB;
    }

    const indiceMeseA = mesiItaliani.indexOf(meseA);
    const indiceMeseB = mesiItaliani.indexOf(meseB);

    return indiceMeseA - indiceMeseB;
  });
}

    function linkBI() {
      const conferma = confirm('üîó Vuoi aprire il portale Banca d\'Italia per scaricare nuovi PDF?');
      if (conferma) {
        window.open('https://arteweb.bancaditalia.it/arteweb-fe-web/cr', '_blank');
        showToast('üîó Portale Banca d\'Italia aperto in nuova finestra', 'info');
      }
    }

    function linkCCIAA() {
      const conferma = confirm('üîó Vuoi aprire il portale Infocamere per scaricare nuovi Bilanci?');
      if (conferma) {
        window.open('https://login.infocamere.it/eacologin/login.action', '_blank');
        showToast('üîó Portale Infocamere aperto in nuova finestra', 'info');
      }
    }

    // Funzioni sidebar destra (placeholder)
    function importaBilanci() {
      showToast('üöß Import Bilanci - Funzionalit√† futura', 'info');
    }

    function aggiungiPeriodoConsuntivo() {
      showToast('üöß Aggiungi Periodo Consuntivo - Funzionalit√† futura', 'info');
    }

    function generaReportEF() {
      showToast('üöß Genera Report Economico-Finanziario - Funzionalit√† futura', 'info');
    }

    function visualizzaAnalisiEF() {
      showToast('üöß Visualizza Analisi EF - Funzionalit√† futura', 'info');
    }

    function esportaReportEF() {
      showToast('üöß Esporta Report EF - Funzionalit√† futura', 'info');
    }

    function cancellaPeriodoEF() {
      showToast('üöß Cancella Periodo EF - Funzionalit√† futura', 'info');
    }

        // Funzione placeholder per showMessage
    function showMessage(titolo, messaggio) {
      showToast(`${titolo}: ${messaggio}`, 'info');
    }

    // ==========================================
    // FUNZIONI REPORT MCC
    // ==========================================
    function generaReportMCCCompleto() {
      if (!verificaAziendaSelezionata()) return;

      const azienda = archivioAziende[aziendaCorrente];
      const rating = calcolaRatingMCC(azienda);

      if (!azienda.mesi || Object.keys(azienda.mesi).length === 0) {
        alert("‚ö†Ô∏è Importa prima i dati CR!");
        return;
      }

      try {
        let doc = new jsPDF({ unit: "pt", format: "a4", orientation: "portrait" });

        // HEADER ceoDOC
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(255, 107, 0);
        doc.text("ceoDOC.it - REPORT RATING MCC v1.4 FINALE", 40, 40);

        doc.setFontSize(12);
        doc.setTextColor(29, 53, 87);
        doc.text("Generato il: " + new Date().toLocaleDateString('it-IT'), 400, 40);

        doc.setFontSize(10);
        doc.setTextColor(255, 107, 0);
        doc.text("www.ceoDOC.it", 40, 55);

        let y = 80;

        // ANAGRAFICA
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(29, 53, 87);
        doc.text("DATI AZIENDA", 40, y);
        y += 25;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Denominazione: ${azienda.anagrafica.denominazione}`, 40, y); y += 16;
        doc.text(`Codice Fiscale: ${azienda.anagrafica.cf}`, 40, y); y += 16;
        doc.text(`Sede Legale: ${azienda.anagrafica.sedeLegale}`, 40, y); y += 16;
        doc.text(`Natura Giuridica: ${azienda.naturaGiuridica || 'Non specificata'}`, 40, y); y += 30;

        // RATING BOX
        let colDestra = 300;
        let yDestra = 130;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 0);
        doc.text("RATING MCC v1.4", colDestra, yDestra);
        yDestra += 25;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(29, 53, 87);

        const mesiTotali = Object.keys(azienda.mesi).length;
        const sconfini = calcolaSconfiniPDF(azienda);

        doc.text(`Classe Rating: ${rating.classe.classe}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Descrizione: ${rating.classe.descr}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Score MCC: ${rating.score.toFixed(3)}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Tipo Calcolo: ${rating.tipo === 'media6' ? 'Media 6 mesi' : 'Ultimo mese'}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Mesi Analizzati: ${mesiTotali}`, colDestra, yDestra); yDestra += 16;
        doc.text(`Sconfini Rilevati: ${sconfini}`, colDestra, yDestra); yDestra += 20;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(255, 107, 0);
        doc.text(`VALUTAZIONE: ${rating.classe.classe} - ${rating.classe.descr}`, colDestra, yDestra);

        // SINTESI ESECUTIVA
        y = 250;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(29, 53, 87);
        doc.text("SINTESI ESECUTIVA v1.4", 40, y);
        y += 25;

        const sintesiTesto = generaSintesiPDFCompleta(azienda, rating, mesiTotali, sconfini);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        const sintesiLinee = doc.splitTextToSize(sintesiTesto, 500);
        doc.text(sintesiLinee, 40, y);

        // SALVA CON NOME PROGRESSIVO
        const nomeFilePDF = generaNomeFileProgressivoMCCV14();
        doc.save(nomeFilePDF);

        alert(`‚úÖ PDF v1.4 FINALE esportato con successo!

File salvato: ${nomeFilePDF}
Rating: ${rating.classe.classe} (${rating.classe.descr})
Mesi: ${mesiTotali}

Percorso suggerito: ceoDOC\\archivio\\dati\\reportcrisk\\`);

      } catch (error) {
        console.error('Errore generazione PDF:', error);
        alert(`‚ùå Errore durante la generazione PDF: ${error.message}`);
      }
    }

    function calcolaSconfiniPDF(azienda) {
      let sconfini = 0;
      Object.keys(azienda.mesi).forEach(mese => {
        azienda.mesi[mese].intermediari.forEach(int => {
          int.rischi.forEach(rischio => {
            if (rischio.utilizzato > rischio.accordatoOperativo) {
              sconfini++;
            }
          });
        });
      });
      return sconfini;
    }

    function generaSintesiPDFCompleta(azienda, rating, mesiTotali, sconfini) {
      let sintesi = `L'analisi v1.4 FINALE evidenzia un rating ${rating.classe.classe} (${rating.classe.descr})`;
      sintesi += ` con score MCC di ${rating.score.toFixed(2)}.\n\n`;
      sintesi += `‚Ä¢ ${mesiTotali} mesi di storico disponibili\n`;
      sintesi += `‚Ä¢ Tabelle rischi: tutti i ${mesiTotali} mesi\n`;
      sintesi += `‚Ä¢ Grafici: ultimi 12 mesi\n`;

      if (sconfini === 0) {
        sintesi += `‚Ä¢ Nessun episodio di sconfino rilevato\n`;
      }

      sintesi += `\nAREE DI ATTENZIONE:\n`;

      if (sconfini > 0) {
        sintesi += `‚Ä¢ ${sconfini} episodi di sconfino rilevati\n`;
      }

      if (mesiTotali < 6) {
        sintesi += `‚Ä¢ Storico limitato per media completa\n`;
      }

      sintesi += `\nFUNZIONALITA' v1.4:\n`;
      sintesi += `‚Ä¢ Parser esteso con 11 colonne (6 nuove)\n`;
      sintesi += `‚Ä¢ Visualizzazione fino a 60 mesi\n`;
      sintesi += `‚Ä¢ Grafici ottimizzati per 12 mesi\n`;

      return sintesi;
    }

    function generaNomeFileProgressivoMCCV14() {
      const azienda = archivioAziende[aziendaCorrente];
      const timestamp = new Date();
      const dataStr = timestamp.toISOString().slice(0, 10).replace(/-/g, '');
      const oraStr = timestamp.toTimeString().slice(0, 8).replace(/:/g, '');
      return `report_MCC_v14_${azienda.anagrafica.cf}_${dataStr}_${oraStr}.pdf`;
    }

    function visualizzaMatriceIntegrazione() {
      const html = `
        <div class="tabella-container">
          <h3>üìä Matrice di Integrazione MCC v1.4</h3>
          <p>üöß Funzionalit√† in sviluppo</p>
          <p>La matrice integrer√†:</p>
          <ul>
            <li>Score Andamentale (Centrale Rischi) - ‚úÖ COMPLETO</li>
            <li>Score Economico-Finanziario (Bilanci) - üöß In sviluppo</li>
            <li>Eventi Pregiudizievoli - üöß In sviluppo</li>
            <li>Rating MCC Finale - ‚úÖ COMPLETO</li>
          </ul>
          <p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
            <strong>‚úÖ v1.4 FINALE implementata:</strong><br>
            ‚Ä¢ Parser esteso (11 colonne)<br>
            ‚Ä¢ Tabelle rischi (60 mesi)<br>
            ‚Ä¢ Grafici ottimizzati (12 mesi)<br>
            ‚Ä¢ 3 Card rating complete<br>
            ‚Ä¢ Modal doppioni CR
          </p>
        </div>
      `;
      mostraModal('visualizzazioneModal', 'üìä Matrice di Integrazione v1.4', html);
    }

    function exportPDFValutazione() {
      if (!verificaAziendaSelezionata()) return;
      const azienda = archivioAziende[aziendaCorrente];
      if (!azienda) {
        showToast('‚ö†Ô∏è Nessuna azienda selezionata', 'warning');
        return;
      }

      // Prepara contenuto HTML per export
      const contenutoHTML = `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>ceoDOC.it - MCC RATING ANALYSIS PROTOCOL</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .company-info { background: #f5f5f5; padding: 15px; margin-bottom: 20px; }
    .section { margin-bottom: 30px; }
    .section h3 { color: #ff6b00; border-bottom: 2px solid #ff6b00; padding-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ceoDOC.it - MCC RATING ANALYSIS PROTOCOL</h1>
    <h2>Analisi Rischio Creditizio</h2>
    <p>Data: ${new Date().toLocaleDateString('it-IT')}</p>
  </div>

  <div class="company-info">
    <h3>Informazioni Azienda</h3>
    <p><strong>Codice Fiscale:</strong> ${azienda.anagrafica.codiceFiscale}</p>
    <p><strong>Denominazione:</strong> ${azienda.anagrafica.denominazione}</p>
    <p><strong>Sede:</strong> ${azienda.anagrafica.sede}</p>
    <p><strong>Natura Giuridica:</strong> ${azienda.anagrafica.naturaGiuridica}</p>
    <p><strong>Settore:</strong> ${azienda.anagrafica.settore}</p>
  </div>

  <div class="section">
    <h3>Analisi Dati Centrale Rischi</h3>
    ${generaTabellaHTMLExport(azienda)}
  </div>
</body>
</html>`;

      // Export HTML file
      const blob = new Blob([contenutoHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ceoDOC_Analisi_${azienda.anagrafica.codiceFiscale}_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('‚úÖ Report HTML esportato con successo', 'success');
    }

    // ==========================================
    // BACKUP E RESTORE AGGIORNATI
    // ==========================================
    function esportaBackup() {
      if (Object.keys(archivioAziende).length === 0) {
        showToast('‚ö†Ô∏è Nessun dato da esportare', 'warning');
        return;
      }

      const timestamp = new Date();
      const dataCompleta = {
        metadata: {
          versione: "ceoDOC-CR v1.4 FINALE COMPLETA",
          dataBackup: timestamp.toISOString(),
          applicazione: "ceoDOC.it Analisi Centrale Rischi",
          modalita: modalitaCorrente,
          browser: navigator.userAgent,
          numeroAziende: Object.keys(archivioAziende).length,
          totaleMesi: Object.values(archivioAziende).reduce((acc, az) => acc + Object.keys(az.mesi).length, 0),
          pathSuggerito: "archivio/dati/reportcrisk/",
          caratteristiche: [
            "Parser esteso 11 colonne",
            "Tabelle rischi 60 mesi",
            "Grafici 12 mesi",
            "Modal doppioni CR",
            "3 Card rating complete"
          ]
        },
        archivio: archivioAziende,
        aziendaCorrente: aziendaCorrente,
        contatori: contatori,
        impostazioni: {
          ultimaAzienda: aziendaCorrente,
          ultimoBackup: timestamp.toISOString(),
          modalitaUtilizzata: modalitaCorrente
        }
      };

     // NOME FILE UNICO
    const dataStr = timestamp.toISOString().slice(0,10).replace(/-/g, '');
    const oraStr = timestamp.toTimeString().slice(0,8).replace(/:/g, '');
    const nomeFile = `backup_anacrisk_${dataStr}_${oraStr}.json`;

    try {
      const blob = new Blob([JSON.stringify(dataCompleta, null, 2)], {
        type: 'application/json'
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nomeFile;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      const numeroAziende = Object.keys(archivioAziende).length;
      const totaleMesi = Object.values(archivioAziende).reduce(
        (acc, az) => acc + Object.keys(az.mesi).length, 0
      );

      contatori.backupCreati++;
      salvaDatiLocali();

      showToast(`‚úÖ Backup v1.4 FINALE esportato: ${numeroAziende} aziende, ${totaleMesi} mesi`, 'success');
      showToast(`üìÅ Sposta in: archivio/dati/reportcrisk/`, 'info');

    } catch (error) {
      console.error('Errore esportazione backup:', error);
      showToast('‚ùå Errore durante l\'esportazione', 'error');
    }
    }

    function importaBackup() {
      document.getElementById('backupInput').click();
    }

    function handleBackupImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);

          if (!backup.metadata || !backup.archivio) {
            throw new Error('File backup non valido');
          }

          const conferma = confirm(`üîÑ IMPORTAZIONE BACKUP v1.4

üìÖ Data backup: ${new Date(backup.metadata.dataBackup).toLocaleString('it-IT')}
üìä Aziende: ${backup.metadata.numeroAziende || 0}
üìà Mesi totali: ${backup.metadata.totaleMesi || 0}
üåê Browser origine: ${backup.metadata.browser || 'N/A'}
üÜö Versione: ${backup.metadata.versione || 'N/A'}

‚ö†Ô∏è ATTENZIONE: Questo sovrascriver√† tutti i dati attuali!

Vuoi continuare?`);

          if (!conferma) return;

          // Importa dati
          archivioAziende = backup.archivio || {};
          aziendaCorrente = backup.aziendaCorrente || null;
          contatori = backup.contatori || {
            pdfImportati: 0,
            analisiGenerate: 0,
            backupCreati: 0
          };

          // Ripristina modalit√† se presente
          if (backup.impostazioni && backup.impostazioni.modalitaUtilizzata) {
            modalitaCorrente = backup.impostazioni.modalitaUtilizzata;
            aggiornaIndicatoreModalita();
          }

          salvaDatiLocali();
          aggiornaInterfaccia();

          showToast(`‚úÖ Backup v1.4 importato con successo!`, 'success');

        } catch (error) {
          console.error('Errore importazione backup:', error);
          showToast(`‚ùå Errore importazione: ${error.message}`, 'error');
        }
      };

      reader.readAsText(file);
      event.target.value = '';
    }

    // ==========================================
    // MODAL E HELP AGGIORNATI
    // ==========================================
    function mostraModal(modalId, titolo, contenuto) {
      const modal = document.getElementById(modalId);
      const content = document.getElementById(modalId.replace('Modal', 'Content'));

      content.innerHTML = `
        <div style="margin: 0 auto; max-width: 1200px; width: 100%;">
          <h2 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">${titolo}</h2>
          ${contenuto}
        </div>
      `;

      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.paddingTop = '20px';
      modal.style.justifyContent = 'center';
      
      // Scorri verso l'alto per vedere il modal
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    // Funzione specifica per le tabelle che allarga la card per nascondere la X del sistema
    function mostraModalTabella(modalId, titolo, contenuto) {
      const modal = document.getElementById(modalId);
      const content = document.getElementById(modalId.replace('Modal', 'Content'));

      content.innerHTML = `
        <div style="position: relative; width: 100vw; max-height: 95vh; overflow-y: auto; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
          <div style="position: sticky; top: 0; background: white; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0;">
            <h2 style="color: var(--primary-color); margin: 0; font-size: 18px;">${titolo}</h2>
            <button onclick="chiudiModal('${modalId}')" style="background: #f5f5f5; border: none; font-size: 18px; cursor: pointer; color: #666; padding: 8px 12px; border-radius: 4px; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e5e5e5'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='#f5f5f5'; this.style.transform='scale(1)'">√ó</button>
          </div>
          <div style="padding: 0;">
            ${contenuto}
          </div>
        </div>
      `;

      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.paddingTop = '10px';
      modal.style.justifyContent = 'center';
      modal.style.padding = '10px';
      
      // Scorri verso l'alto per vedere il modal
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    function chiudiModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function mostraHelp() {
      const helpContent = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h2 style="color: var(--primary-color); margin-bottom: 15px;">üìä Guida ceoDOC - Analisi Centrale Rischi v1.4 FINALE</h2>
          <p style="color: var(--text-secondary); font-size: 1.1em;">Versione finale completa con tutte le modifiche implementate</p>
        </div>

        <div style="display: grid; gap: 25px;">
          <div style="background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%); padding: 20px; border-radius: 15px; border-left: 5px solid var(--info-color);">
            <h3 style="color: var(--info-color); margin-bottom: 15px;">üè¢ Come iniziare</h3>
            <ul style="line-height: 1.8;">
              <li><strong>1. Nuova Anagrafica:</strong> Carica anagrafica da PDF Centrale Rischi</li>
              <li><strong>2. Natura Giuridica:</strong> Seleziona SC/SP/DI (obbligatorio per rating)</li>
              <li><strong>3. Importa CR:</strong> Importa dati mensili Centrale Rischi</li>
              <li><strong>4. Visualizza Rating:</strong> Il rating MCC si calcola automaticamente</li>
            </ul>
          </div>

          <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 20px; border-radius: 15px; border-left: 5px solid var(--success-color);">
            <h3 style="color: var(--success-color); margin-bottom: 15px;">üÜï COMPLETATO v1.4 FINALE</h3>
            <ul style="line-height: 1.8;">
              <li><strong>‚úÖ Parser esteso:</strong> 11 colonne complete (6 nuove: durata, import/export, stato, garanzie, ruolo, saldo)</li>
              <li><strong>‚úÖ Tabelle rischi 60 mesi:</strong> REVOCA, AUTOLIQUIDANTI, SCADENZA mostrano tutti i mesi</li>
              <li><strong>‚úÖ Tabella sconfini 12 mesi:</strong> Focus sui sconfini recenti con formato nuovo</li>
              <li><strong>‚úÖ Grafici 12 mesi:</strong> Tutti i grafici usano 12 mesi invece di 6</li>
              <li><strong>‚úÖ Barre complete:</strong> Grafico barre con tutte le categorie + sconfini evidenziati</li>
              <li><strong>‚úÖ 3 Tachimetri:</strong> Ultimo mese, 6 mesi, 12 mesi tutti funzionanti</li>
              <li><strong>‚úÖ Modal doppioni:</strong> Gestione sovrascrivi/ignora per CR duplicati</li>
              <li><strong>‚úÖ Sfondi pallidi:</strong> Card con colori delicati e design migliorato</li>
            </ul>
          </div>

          <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 15px; border-left: 5px solid var(--warning-color);">
            <h3 style="color: var(--warning-color); margin-bottom: 15px;">üßÆ Rating MCC Completo</h3>
            <ul style="line-height: 1.8;">
              <li><strong>Coefficienti specifici</strong> per SC/SP/DI</li>
              <li><strong>3 Card identiche:</strong> Ultimo mese, Media 6 mesi, Media 12 mesi</li>
              <li><strong>Classi CR1-CR11:</strong> Da "Sicurezza" a "Rischiosit√†"</li>
              <li><strong>Tachimetri v1.4:</strong> Solo emoji + contorni colorati + sfondi pallidi</li>
              <li><strong>Analisi completa:</strong> Fino a 60 mesi di storico</li>
            </ul>
          </div>

          <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 15px; border-left: 5px solid #7b1fa2;">
            <h3 style="color: #7b1fa2; margin-bottom: 15px;">üìä Visualizzazioni Avanzate</h3>
            <ul style="line-height: 1.8;">
              <li><strong>Tabelle rischi:</strong> 11 colonne x 60 mesi per categoria</li>
              <li><strong>Sconfini:</strong> Formato "A REVOCA - mese: BANCA / -SCONFINO: ‚Ç¨XX"</li>
              <li><strong>Rating mensili:</strong> Tabella C completa per tutti i mesi</li>
              <li><strong>Grafici 12 mesi:</strong> Barre, linee, torta, evoluzione</li>
              <li><strong>Export completo:</strong> PDF + JSON + Backup</li>
            </ul>
          </div>
        </div>
      `;

      mostraModal('helpModal', '', helpContent);
    }

    function mostraAssistente() {
  const assistenteContent = `
    <div style="text-align: center; margin-bottom: 30px;">
      <h2 style="color: var(--primary-color); margin-bottom: 15px;">ü§ñ Assistente ceoDOC v1.5 AGGIORNATO</h2>
    </div>
    <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; border-left: 4px solid var(--success-color); margin-bottom: 20px;">
      <h4 style="color: var(--success-color); margin-bottom: 10px;">‚úÖ COMPLETATO v1.5 - ALTRE INFORMAZIONI INTEGRATE</h4>
      <p>‚úÖ Parser esteso: 11 colonne complete (5 originali + 6 nuove)</p>
      <p>‚úÖ Tabelle rischi: TUTTI i 60 mesi disponibili</p>
      <p>‚úÖ Tabella sconfini: Limitata a 12 mesi con formato nuovo</p>
      <p>‚úÖ Grafici: 12 mesi invece di 6 (barre, linee, torta, evoluzione)</p>
      <p>‚úÖ 3 Card rating: Ultimo mese, 6 mesi, 12 mesi con tachimetri</p>
      <p>‚úÖ Modal doppioni CR: Sovrascrivi/Ignora funzionante</p>
      <p>‚úÖ Sfondi pallidi: Arancione, viola, verde</p>
      <p>‚úÖ Barre grafici: Tutte le categorie + sconfini rossi evidenziati</p>
      <p><strong>‚úÖ ALTRE INFORMAZIONI: Crediti, Garanzie, Richieste con grafici interattivi</strong></p>
      <button style="margin-top: 15px; padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="testLibrerie()">
        üîß Test Librerie
      </button>
    </div>
    <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border-left: 4px solid var(--warning-color);">
      <h4 style="color: var(--warning-color); margin-bottom: 10px;">üöß PROSSIMI SVILUPPI</h4>
      <p>üöß Import bilanci per score economico-finanziario</p>
      <p>üöß Parser sofferenze e segnalazioni complete</p>
      <p>üöß Eventi pregiudizievoli (interfaccia dettagliata)</p>
      <p>üöß Matrice integrazione finale CR + Bilanci</p>
      <p>üöß Export Excel con XLSX.js</p>
      <p>üöß Gestione doppioni per mesi multipli</p>
      <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 8px;">
        <strong>üéØ STATUS v1.5:</strong> Altre Informazioni implementate con successo! Sistema completo per analisi CR fino a 60 mesi con estrazione automatica di crediti, garanzie e richieste informazioni.
      </div>
    </div>
  `;
  mostraModal('assistenteModal', '', assistenteContent);
}

    // ==========================================
    // GESTIONE EVENTI CLICK MODALI
    // ==========================================
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // Chiusura modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.style.display = 'none';
        });
      }
    });

    // ==========================================
    // nuove funzioni da qui
    // ==========================================

// ===== SISTEMA GUIDA PER CAMPI READONLY - VERSIONE FINALE =====

let guidaStatoAttuale = {
    anagraficaCompleta: false,
    anagraficaSalvata: false,
    timerCheck: null,
    pausaMonitoraggio: false,
    // ‚úÖ AGGIUNGI QUESTE PER EVITARE SPAM:
    ultimoCF: '',
    ultimaDenominazione: ''
};

console.log('üöÄ Caricamento sistema guida per campi readonly...');

// FUNZIONE CHE CONTROLLA CONTINUAMENTE I CAMPI READONLY
function monitoraCampiReadonly() {
    // Se il monitoraggio √® in pausa, non fare nulla
    if (guidaStatoAttuale.pausaMonitoraggio) {
        return; // ‚úÖ Silenzioso quando in pausa
    }

    // Prendi i valori dai campi readonly
    const cf = document.getElementById('anagraficaCF')?.value?.trim();
    const denominazione = document.getElementById('anagraficaDenominazione')?.value?.trim();

    // ‚úÖ STAMPA SOLO SE I VALORI SONO CAMBIATI (no spam)
    const valoriCambiati = (cf !== guidaStatoAttuale.ultimoCF || denominazione !== guidaStatoAttuale.ultimaDenominazione);
    if (valoriCambiati) {
        console.log(`üîç CF: "${cf}" | Denominazione: "${denominazione}"`);
        guidaStatoAttuale.ultimoCF = cf;
        guidaStatoAttuale.ultimaDenominazione = denominazione;
    }

    // Verifica se anagrafica √® completa
    const anagraficaOK = cf && cf.length >= 11 && denominazione && denominazione.length >= 3;

    // ‚úÖ AGGIORNA SOLO LO STATO INTERNO, NON ILLUMINARE MAI
    if (anagraficaOK !== guidaStatoAttuale.anagraficaCompleta) {
        guidaStatoAttuale.anagraficaCompleta = anagraficaOK;
        console.log(`üìù Stato anagrafica: ${anagraficaOK ? 'COMPLETA' : 'INCOMPLETA'} (solo aggiornamento interno)`);

        // ‚ùå NON CHIAMARE aggiornaGuidaVisuale() QUI!
        // ‚ùå aggiornaGuidaVisuale(); 

        // ‚úÖ Il sistema illumina SOLO con trigger manuali:
        // - notificaPDFSelezionato() ‚Üí illumina SALVA
        // - notificaJSONSalvato() ‚Üí illumina IMPORT CR
        // - notificaDatiImportati() ‚Üí illumina HELP
    }
}

// AGGIORNA LA GUIDA VISUALE
function aggiornaGuidaVisuale() {
    console.log(`üéØ Aggiornamento guida - Completa: ${guidaStatoAttuale.anagraficaCompleta}, Salvata: ${guidaStatoAttuale.anagraficaSalvata}`);

    // SPEGNI SEMPRE TUTTO PRIMA
    spegniIlluminazione();

    if (guidaStatoAttuale.anagraficaCompleta && !guidaStatoAttuale.anagraficaSalvata) {
        // FASE 1: Anagrafica completa ‚Üí ILLUMINA "üíæ Salva"
        setTimeout(() => {
            illuminaPulsanteCaricaAnagrafica();
            console.log('üíæ ILLUMINATO: Salva Anagrafica');
        }, 300);

    } else if (guidaStatoAttuale.anagraficaSalvata) {
        // FASE 2: Anagrafica salvata ‚Üí ILLUMINA "üì• Importa CR"  
        setTimeout(() => {
            illuminaPulsanteImportCR();
            console.log('üì• ILLUMINATO: Import CR');
        }, 300);
    }
}

// ILLUMINA PULSANTE "üíæ Salva" 
function illuminaPulsanteCaricaAnagrafica() {
    // Cerca il pulsante ESATTO dalla tua app
    const pulsanteSalva = document.querySelector('button.import-btn[onclick="salvaAnagrafica()"]');

    if (pulsanteSalva) {
        applicaIlluminazionePotente(pulsanteSalva, 'verde');
        console.log('‚úÖ ILLUMINATO: Pulsante "üíæ Salva"');
    } else {
        console.error('‚ùå PULSANTE "üíæ Salva" NON TROVATO');
        // Debug alternativo
        const altroSalva = document.querySelector('button[onclick*="salvaAnagrafica"]');
        if (altroSalva) {
            applicaIlluminazionePotente(altroSalva, 'verde');
            console.log('‚úÖ ILLUMINATO: Pulsante salva alternativo');
        }
    }
}

// ILLUMINA PULSANTE "üì• Importa CR"
function illuminaPulsanteImportCR() {
    // Cerca il pulsante ESATTO dalla tua app
    const pulsanteImport = document.querySelector('button.sidebar-btn[onclick="importaCR()"]');

    if (pulsanteImport) {
        applicaIlluminazionePotente(pulsanteImport, 'blu');
        console.log('‚úÖ ILLUMINATO: Pulsante "üì• Importa CR"');
    } else {
        console.error('‚ùå PULSANTE "üì• Importa CR" NON TROVATO');
        // Debug alternativo
        const altroImport = document.querySelector('button[onclick*="importaCR"]');
        if (altroImport) {
            applicaIlluminazionePotente(altroImport, 'blu');
            console.log('‚úÖ ILLUMINATO: Pulsante import alternativo');
        }
    }
}

// ILLUMINA PULSANTE "?" (HELP)
function illuminaPulsanteHelp() {
    // Cerca il pulsante ESATTO dalla tua app
    const pulsanteHelp = document.querySelector('button.help-btn[onclick="mostraHelp()"]');

    if (pulsanteHelp) {
        applicaIlluminazionePotente(pulsanteHelp, 'arancione');
        console.log('‚úÖ ILLUMINATO: Pulsante "?" (Help)');
    } else {
        console.error('‚ùå PULSANTE "?" (Help) NON TROVATO');
        // Debug alternativo
        const altroHelp = document.querySelector('button[onclick*="mostraHelp"]');
        if (altroHelp) {
            applicaIlluminazionePotente(altroHelp, 'arancione');
            console.log('‚úÖ ILLUMINATO: Pulsante help alternativo');
        }
    }
}

// APPLICA ILLUMINAZIONE SUPER POTENTE
function applicaIlluminazionePotente(elemento, colore = 'verde') {
    const colori = {
        verde: {
            background: 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)',
            shadow: 'rgba(76, 175, 80, 0.9)'
        },
        blu: {
            background: 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)',
            shadow: 'rgba(33, 150, 243, 0.9)'
        },
        arancione: {
            background: 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)',
            shadow: 'rgba(255, 152, 0, 0.9)'
        }
    };

    const tema = colori[colore] || colori.verde;

    // Stili SUPER POTENTI
    elemento.style.cssText = `
        background: ${tema.background} !important;
        border: 4px solid #fff !important;
        box-shadow: 
            0 0 30px ${tema.shadow}, 
            0 0 60px ${tema.shadow}, 
            0 0 90px ${tema.shadow} !important;
        transform: scale(1.15) !important;
        color: white !important;
        font-weight: bold !important;
        animation: pulsazioneSuper 1.5s ease-in-out infinite !important;
        z-index: 9999 !important;
        position: relative !important;
        transition: all 0.3s ease !important;
    `;

    // Aggiungi classe per identificazione
    elemento.classList.add('guida-super-illuminato');

    console.log(`üí° Illuminazione ${colore} applicata a:`, elemento.textContent?.trim());
}

// SPEGNI TUTTE LE ILLUMINAZIONI - VERSIONE SUPER ROBUSTA
function spegniIlluminazione() {
    // Spegni tutti i pulsanti specifici che possono essere illuminati
    const selettori = [
        'button.import-btn[onclick="salvaAnagrafica()"]',       // Pulsante Salva
        'button.sidebar-btn[onclick="importaCR()"]',            // Pulsante Import CR  
        'button.help-btn[onclick="mostraHelp()"]',              // Pulsante Help
        '.guida-super-illuminato',                              // Qualsiasi altro illuminato
        '.test-illuminato',                                     // Pulsanti di test
        'button[style*="pulsazioneSuper"]',                     // Pulsanti con animazione
        'button[style*="linear-gradient"]'                      // Pulsanti con gradiente
    ];

    let spenti = 0;

    // Metodo 1: Spegnimento per selettori
    selettori.forEach(selettore => {
        const elementi = document.querySelectorAll(selettore);
        elementi.forEach(elemento => {
            resetStiliElemento(elemento);
            spenti++;
        });
    });

    // Metodo 2: Spegnimento FORZATO dei pulsanti principali (per sicurezza)
    const pulsantiSpecifici = [
        document.querySelector('button.import-btn[onclick="salvaAnagrafica()"]'),
        document.querySelector('button.sidebar-btn[onclick="importaCR()"]'),
        document.querySelector('button.help-btn[onclick="mostraHelp()"]')
    ];

    pulsantiSpecifici.forEach(btn => {
        if (btn) {
            resetStiliElemento(btn);
            spenti++;
        }
    });

    console.log(`üîå Spenti ${spenti} elementi illuminati (metodo robusto)`);
}

// Funzione helper per reset completo stili
function resetStiliElemento(elemento) {
    // Reset completo degli stili
    elemento.style.background = '';
    elemento.style.border = '';
    elemento.style.boxShadow = '';
    elemento.style.transform = '';
    elemento.style.animation = '';
    elemento.style.zIndex = '';
    elemento.style.position = '';
    elemento.style.color = '';
    elemento.style.fontWeight = '';
    elemento.style.filter = '';
    elemento.style.cssText = elemento.style.cssText.replace(/background[^;]*;?/gi, '');
    elemento.style.cssText = elemento.style.cssText.replace(/box-shadow[^;]*;?/gi, '');
    elemento.style.cssText = elemento.style.cssText.replace(/transform[^;]*;?/gi, '');
    elemento.style.cssText = elemento.style.cssText.replace(/animation[^;]*;?/gi, '');

    // Rimuovi classi guida
    elemento.classList.remove('guida-super-illuminato', 'test-illuminato');
}

// AGGIUNGI CSS ANIMAZIONI
function aggiungiCSSAnimazioni() {
    if (!document.getElementById('cssGuidaSuper')) {
        const style = document.createElement('style');
        style.id = 'cssGuidaSuper';
        style.innerHTML = `
            @keyframes pulsazioneSuper {
                0% { 
                    transform: scale(1.15); 
                    filter: brightness(1);
                }
                50% { 
                    transform: scale(1.25); 
                    filter: brightness(1.3);
                }
                100% { 
                    transform: scale(1.15); 
                    filter: brightness(1);
                }
            }

            .guida-super-illuminato:hover {
                transform: scale(1.3) !important;
                filter: brightness(1.4) !important;
            }
        `;
        document.head.appendChild(style);
        console.log('‚úÖ CSS animazioni super aggiunte');
    }
}

// AVVIA MONITORAGGIO CONTINUO
function avviaMonitoraggio() {
    // Ferma il timer precedente se esiste
    if (guidaStatoAttuale.timerCheck) {
        clearInterval(guidaStatoAttuale.timerCheck);
    }

    // Controlla ogni 1 secondo
    guidaStatoAttuale.timerCheck = setInterval(() => {
        monitoraCampiReadonly();
    }, 1000);

    console.log('‚è∞ Monitoraggio continuo avviato (ogni 1 secondo)');
}

// AUTO-SPEGNIMENTO quando clicchi altri pulsanti
function aggiungiAutoSpegnimento() {
    // Lista dei pulsanti che NON devono spegnere la guida (fanno parte del flusso)
    const pulsantiFlussoGuidato = [
        'salvaAnagrafica()',
        'importaCR()',
        'mostraHelp()',
        'nuovaAnagrafica()',
        'handleAnagraficaImport'
    ];

    // Aggiungi listener globale per tutti i click sui pulsanti
    document.addEventListener('click', function(event) {
        const elemento = event.target;

        // Se non √® un pulsante, ignora
        if (elemento.tagName !== 'BUTTON') return;

        const onclick = elemento.getAttribute('onclick') || '';
        const isPartOfFlow = pulsantiFlussoGuidato.some(func => onclick.includes(func));

        // Se non fa parte del flusso guidato, spegni tutto
        if (!isPartOfFlow && onclick) {
            console.log(`üîò Click su pulsante esterno al flusso: "${elemento.textContent?.trim()}" ‚Üí spegni guida`);

            // Piccolo delay per non interferire con il click
            setTimeout(() => {
                spegniIlluminazione();

                // Reset stato guida se necessario
                if (guidaStatoAttuale.anagraficaCompleta && !onclick.includes('elimina')) {
                    // Non resettare completamente, ma pausa temporaneamente
                    guidaStatoAttuale.pausaMonitoraggio = true;
                    setTimeout(() => {
                        guidaStatoAttuale.pausaMonitoraggio = false;
                    }, 2000);
                }
            }, 100);
        }
    }, true); // useCapture = true per intercettare prima

    console.log('üéØ Auto-spegnimento attivato per click esterni al flusso');
}

// FERMA MONITORAGGIO
function fermaMonitoraggio() {
    if (guidaStatoAttuale.timerCheck) {
        clearInterval(guidaStatoAttuale.timerCheck);
        guidaStatoAttuale.timerCheck = null;
        console.log('‚èπÔ∏è Monitoraggio fermato');
    }
}

// FUNZIONI DA CHIAMARE NELLE TUE FUNZIONI ESISTENTI

// 1. Da chiamare alla fine di nuovaAnagrafica() e handleAnagraficaImport()
function notificaAnagraficaImportata() {
    // Spegni tutto (incluso Help se era illuminato)
    spegniIlluminazione();

    guidaStatoAttuale.anagraficaCompleta = true;
    guidaStatoAttuale.anagraficaSalvata = false;
    console.log('üìù NOTIFICA: Anagrafica importata dal PDF ‚Üí illumina SALVA');

    setTimeout(() => {
        aggiornaGuidaVisuale();
    }, 500);
}

// 2. Da chiamare alla fine di salvaAnagrafica() e salvaAnagraficaCompleta()
function notificaAnagraficaSalvata() {
    guidaStatoAttuale.anagraficaSalvata = true;
    console.log('üíæ NOTIFICA: Anagrafica salvata ‚Üí illumina IMPORT CR');

    setTimeout(() => {
        aggiornaGuidaVisuale();
    }, 500);
}

// 3. Da chiamare alla fine di importaCR()
function notificaImportCompletato() {
    // Spegni tutto prima
    spegniIlluminazione();

    // Poi illumina Help con un piccolo delay
    setTimeout(() => {
        illuminaPulsanteHelp();
        console.log('‚úÖ NOTIFICA: Import dati numerici completato ‚Üí illumina HELP');

        // Auto-spegni Help dopo 10 secondi
        setTimeout(() => {
            spegniIlluminazione();
            console.log('üîå Help auto-spento dopo 10 secondi');
        }, 10000);

    }, 500);
}

// RESET COMPLETO
function resetGuidaCompleto() {
    guidaStatoAttuale = {
        anagraficaCompleta: false,
        anagraficaSalvata: false,
        timerCheck: null
    };

    spegniIlluminazione();
    fermaMonitoraggio();
    avviaMonitoraggio();

    console.log('üîÑ RESET COMPLETO della guida');
}

// INIZIALIZZAZIONE COMPLETA
function inizializzaGuidaCompleta() {
    console.log('üöÄ INIZIALIZZAZIONE GUIDA COMPLETA...');

    // Aggiungi CSS
    aggiungiCSSAnimazioni();

    // Avvia monitoraggio
    avviaMonitoraggio();

    // Aggiungi auto-spegnimento per click esterni
    aggiungiAutoSpegnimento();

    // Primo controllo
    monitoraCampiReadonly();

    console.log('üéØ Sistema guida completamente inizializzato e funzionante!');
    console.log('üîò Auto-spegnimento attivo: clicca qualsiasi pulsante esterno per spegnere illuminazioni');
}

// AUTO-START
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        inizializzaGuidaCompleta();
    }, 2000); // Aspetta 2 secondi per sicurezza
});

// FUNZIONI DI TEST MANUALI (per debug)
window.guidaDebug = {
    controlla: monitoraCampiReadonly,
    illuminaSalva: illuminaPulsanteCaricaAnagrafica,
    illuminaImport: illuminaPulsanteImportCR,
    illuminaHelp: illuminaPulsanteHelp,
    spegni: spegniIlluminazione,
    reset: resetGuidaCompleto,
    pausa: pausaMonitoraggioGuida,
    riprendi: riprendiMonitoraggioGuida,
    testEliminazione: notificaEliminazioneCompletata,
    stato: () => console.log('üìä Stato guida:', guidaStatoAttuale),
    avvia: avviaMonitoraggio,
    ferma: fermaMonitoraggio,
    testImportAnagrafica: () => notificaAnagraficaImportata(),
    testSalvaAnagrafica: () => notificaAnagraficaSalvata(),
    testImportCR: () => notificaImportCompletato(),
    mostraPulsanti: () => {
        const tutti = document.querySelectorAll('button');
        console.log(`üîç TUTTI I PULSANTI (${tutti.length}):`);
        tutti.forEach((btn, i) => {
            console.log(`${i}: "${btn.textContent?.trim()}" | classe: "${btn.className}" | onclick: "${btn.getAttribute('onclick')}"`);
        });
    }
};

console.log('üéÆ DEBUG disponibili: guidaDebug.testImportAnagrafica(), guidaDebug.testEliminazione(), ecc.');

// ==========================================
// FIX FUNZIONI GUIDA MANCANTI
// ==========================================

// PAUSA MONITORAGGIO GUIDA
function pausaMonitoraggioGuida() {
    if (guidaStatoAttuale.timerCheck) {
        clearInterval(guidaStatoAttuale.timerCheck);
        guidaStatoAttuale.timerCheck = null;
        guidaStatoAttuale.pausaMonitoraggio = true;
        console.log('‚è∏Ô∏è PAUSA: Monitoraggio guida fermato temporaneamente');
        showToast('‚è∏Ô∏è Guida in pausa', 'info', 2000);
    } else {
        console.log('‚ö†Ô∏è PAUSA: Nessun monitoraggio attivo da fermare');
    }
}

// RIPRENDI MONITORAGGIO GUIDA  
function riprendiMonitoraggioGuida() {
    if (!guidaStatoAttuale.timerCheck) {
        guidaStatoAttuale.pausaMonitoraggio = false;

        // Riavvia il timer di monitoraggio
        guidaStatoAttuale.timerCheck = setInterval(() => {
            monitoraCampiReadonly();
        }, 1000);

        console.log('‚ñ∂Ô∏è RIPRENDI: Monitoraggio guida riavviato');
        showToast('‚ñ∂Ô∏è Guida riavviata', 'success', 2000);

        // Controlla subito lo stato
        setTimeout(() => {
            monitoraCampiReadonly();
        }, 100);
    } else {
        console.log('‚ö†Ô∏è RIPRENDI: Monitoraggio gi√† attivo');
    }
}

// NOTIFICA ELIMINAZIONE COMPLETATA (con gestione reset guida)
function notificaEliminazioneCompletata() {
    console.log('üóëÔ∏è NOTIFICA: Eliminazione azienda completata ‚Üí reset guida completo');

    // Spegni tutto immediatamente
    spegniIlluminazione();

    // Ferma monitoraggio per evitare interferenze
    fermaMonitoraggio();

    // Reset completo dello stato
    guidaStatoAttuale = {
        anagraficaCompleta: false,
        anagraficaSalvata: false,
        timerCheck: null,
        pausaMonitoraggio: true  // Tieni in pausa per 8 secondi
    };

    console.log('üîÑ Reset stato guida dopo eliminazione');

    // Riprendi il monitoraggio dopo 8 secondi per dare tempo al reload
    setTimeout(() => {
        if (!guidaStatoAttuale.timerCheck) {
            console.log('üîÑ Riavvio automatico guida dopo eliminazione');
            riprendiMonitoraggioGuida();
        }
    }, 8000);
}

// STATO AVANZATO GUIDA (per debug)
function getStatoGuidaCompleto() {
    const cf = document.getElementById('anagraficaCF')?.value?.trim() || '';
    const denominazione = document.getElementById('anagraficaDenominazione')?.value?.trim() || '';

    return {
        stato: guidaStatoAttuale,
        campiAnagrafica: {
            cf: cf,
            denominazione: denominazione,
            cfValido: cf.length >= 11,
            denominazioneValida: denominazione.length >= 3,
            anagraficaCompleta: cf.length >= 11 && denominazione.length >= 3
        },
        pulsanti: {
            salvaVisibile: !!document.querySelector('button[onclick*="salva"]'),
            importVisibile: !!document.querySelector('button[onclick*="import"]'),
            helpVisibile: !!document.querySelector('button[onclick*="help"]')
        },
        monitoraggio: {
            attivo: !!guidaStatoAttuale.timerCheck,
            inPausa: guidaStatoAttuale.pausaMonitoraggio,
            intervalloMs: 1000
        }
    };
}

// DIAGNOSTICA AVANZATA GUIDA
function diagnosticaGuida() {
    const stato = getStatoGuidaCompleto();

    console.log('üîç DIAGNOSTICA GUIDA COMPLETA:');
    console.log('üìä Stato:', stato.stato);
    console.log('üìù Campi:', stato.campiAnagrafica);
    console.log('üîò Pulsanti:', stato.pulsanti);
    console.log('‚è∞ Monitoraggio:', stato.monitoraggio);

    // Verifica problemi comuni
    const problemi = [];

    if (!stato.monitoraggio.attivo && !stato.monitoraggio.inPausa) {
        problemi.push('‚ö†Ô∏è Monitoraggio non attivo');
    }

    if (stato.campiAnagrafica.anagraficaCompleta && !stato.stato.anagraficaCompleta) {
        problemi.push('üîÑ Stato guida non sincronizzato con campi');
    }

    if (!stato.pulsanti.salvaVisibile) {
        problemi.push('‚ùå Pulsante salva non trovato');
    }

    if (problemi.length > 0) {
        console.log('üö® PROBLEMI RILEVATI:');
        problemi.forEach(p => console.log(p));
    } else {
        console.log('‚úÖ Nessun problema rilevato');
    }

    return stato;
}

// RIPARAZIONE AUTOMATICA GUIDA
function riparaGuida() {
    console.log('üîß AVVIO: Riparazione automatica guida...');

    const stato = getStatoGuidaCompleto();
    let riparazioni = 0;

    // Riparazione 1: Riavvia monitoraggio se fermo
    if (!stato.monitoraggio.attivo && !stato.monitoraggio.inPausa) {
        console.log('üîß RIPARAZIONE 1: Riavvio monitoraggio');
        riprendiMonitoraggioGuida();
        riparazioni++;
    }

    // Riparazione 2: Sincronizza stato con campi
    if (stato.campiAnagrafica.anagraficaCompleta && !stato.stato.anagraficaCompleta) {
        console.log('üîß RIPARAZIONE 2: Sincronizzazione stato');
        guidaStatoAttuale.anagraficaCompleta = true;
        aggiornaGuidaVisuale();
        riparazioni++;
    }

    // Riparazione 3: Re-inizializza CSS se mancante
    if (!document.getElementById('cssGuidaSuper')) {
        console.log('üîß RIPARAZIONE 3: Re-aggiungi CSS');
        aggiungiCSSAnimazioni();
        riparazioni++;
    }

    console.log(`‚úÖ RIPARAZIONE COMPLETATA: ${riparazioni} problemi risolti`);
    showToast(`üîß Guida riparata: ${riparazioni} fix applicati`, 'success', 3000);

    return riparazioni;
}

console.log('‚úÖ FUNZIONI GUIDA MANCANTI: Aggiunte con successo');
// ==========================================
// FUNZIONI MODAL TABELLE RISCHI
// ==========================================
function mostraModalRischiRevoca() {
  const tabella = document.querySelector('table.tabella-cr');
  if (!tabella) {
    showToast('‚ùå Tabella non trovata', 'error');
    return;
  }

  const tabellaHTML = tabella.outerHTML.replace('style="display: none;"', '');

  const modalHTML = `
    <div style="width: 90vw; height: 80vh; overflow-y: auto;">
      <h3 style="color: #ff6b00; margin-bottom: 20px;">üìä RISCHI A REVOCA - Dettaglio Completo</h3>
      ${tabellaHTML}
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Rischi a Revoca', modalHTML);
}
console.log('üéÆ Comandi disponibili: pausaMonitoraggioGuida(), riprendiMonitoraggioGuida(), diagnosticaGuida(), riparaGuida()');

// ==========================================
// IMPORT PDF MULTIPLI SICURO - VERSIONE COMPLETA
// Copia e incolla questo INTERO blocco nel tuo anacrisk.html
// ==========================================

// ===== CONFIGURAZIONE GLOBALE =====
const CONFIG_PDF_SICURO = {
  MAX_MESI: 60,
  FIFO_ENABLED: true,
  DEBUG: true
};

// ===== BACKUP FUNZIONE ORIGINALE =====
let importaCR_backup = null;
let sistemaInizializzato = false;

// ===== SALVATAGGIO FUNZIONE ORIGINALE =====
function salvaImportOriginale() {
  try {
    if (window.importaCR && typeof window.importaCR === 'function') {
      importaCR_backup = window.importaCR;
      console.log('‚úÖ Backup funzione originale importaCR salvato');
      return true;
    }
    console.log('‚ö†Ô∏è Funzione originale importaCR non trovata');
    return false;
  } catch (error) {
    console.error('‚ùå Errore salvataggio originale:', error);
    return false;
  }
}

// ===== VERIFICA DIPENDENZE =====
function verificaDipendenze() {
  const funzioniRichieste = [
    'showToast',
    'mostraModal', 
    'chiudiModal'
  ];

  const variabiliRichieste = [
    'aziendaCorrente',
    'archivioAziende'
  ];

  const funzioniMancanti = funzioniRichieste.filter(fn => typeof window[fn] !== 'function');
  const variabiliMancanti = variabiliRichieste.filter(vr => typeof window[vr] === 'undefined');

  if (CONFIG_PDF_SICURO.DEBUG) {
    console.log('üîç Verifica dipendenze:');
    console.log('- Funzioni mancanti:', funzioniMancanti);
    console.log('- Variabili mancanti:', variabiliMancanti);
  }

  return {
    funzioniOK: funzioniMancanti.length === 0,
    variabiliOK: variabiliMancanti.length === 0,
    tuttoOK: funzioniMancanti.length === 0 && variabiliMancanti.length === 0
  };
}

// ===== IMPORT PDF MULTIPLI PRINCIPALE =====
function importaPDFMultipliSicuro() {
  console.log('üöÄ AVVIO: Import PDF Multipli Sicuro');

  try {
    const dipendenze = verificaDipendenze();

    // Se mancano dipendenze critiche, usa funzione originale
    if (!dipendenze.tuttoOK) {
      console.log('‚ö†Ô∏è Dipendenze mancanti, uso funzione originale');
      if (importaCR_backup) {
        return importaCR_backup();
      } else {
        return importSemplificato();
      }
    }

    // Verifica azienda selezionata
    if (!window.aziendaCorrente || !window.archivioAziende[window.aziendaCorrente]) {
      if (window.showToast) {
        window.showToast('‚ö†Ô∏è Seleziona prima un\'azienda', 'warning');
      } else {
        alert('‚ö†Ô∏è Seleziona prima un\'azienda');
      }
      return;
    }

    // Tutto OK, usa versione avanzata
    return importAvanzato();

  } catch (error) {
    console.error('‚ùå Errore in importaPDFMultipliSicuro:', error);

    // Fallback finale
    if (importaCR_backup) {
      console.log('üîÑ Fallback alla funzione originale');
      return importaCR_backup();
    } else {
      return importSemplificato();
    }
  }
}

// ===== IMPORT SEMPLIFICATO (FALLBACK) =====
function importSemplificato() {
  console.log('üÜò Usando import semplificato');

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf';
  input.multiple = true;

  input.onchange = function(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    if (files.length === 1) {
      // Un solo file, usa funzione originale se disponibile
      if (importaCR_backup) {
        console.log('üìÑ Un file, uso funzione originale');
        return;
      }
    }

    alert(`üìÅ Selezionati ${files.length} file PDF.\n\n‚ö†Ô∏è MODALIT√Ä SEMPLIFICATA:\nElabora manualmente un file alla volta.`);
  };

  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

// ===== IMPORT AVANZATO (VERSIONE COMPLETA) =====
function importAvanzato() {
  console.log('üöÄ Usando import avanzato');

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf';
  input.multiple = true;

  input.onchange = async function(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    console.log(`üìÅ Selezionati ${files.length} file PDF`);

    // Verifica limite 60 mesi
    const azienda = window.archivioAziende[window.aziendaCorrente];
    const mesiAttuali = Object.keys(azienda?.mesi || {}).length;
    const totale = mesiAttuali + files.length;

    if (totale > CONFIG_PDF_SICURO.MAX_MESI) {
      const daEliminare = totale - CONFIG_PDF_SICURO.MAX_MESI;
      const conferma = confirm(`‚ö†Ô∏è LIMITE ${CONFIG_PDF_SICURO.MAX_MESI} MESI RAGGIUNTO\n\nAttuali: ${mesiAttuali} mesi\nNuovi: ${files.length} file\nTotale: ${totale}\n\nI ${daEliminare} mesi pi√π vecchi verranno eliminati automaticamente (FIFO).\n\nVuoi continuare?`);

      if (!conferma) {
        return;
      }
    }

    // Processa i file
    await processaFilesPDF(files);
  };

  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

// ===== PROCESSAMENTO FILES =====
async function processaFilesPDF(files) {
  console.log(`‚öôÔ∏è Processamento ${files.length} file PDF`);

  // Mostra progress con toast o modal
  if (window.showToast) {
    window.showToast(`üìä Elaborazione ${files.length} file in corso...`, 'info', 3000);
  }

  let importati = 0;
  let errori = 0;
  let doppioni = 0;

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    console.log(`üìÑ File ${i+1}/${files.length}: ${file.name}`);

    try {
      // Se esiste il parser originale, usalo
      if (typeof window.estraiDatiDaPDF === 'function') {
        const dati = await window.estraiDatiDaPDF(file);

        // Verifica coerenza azienda
        const azienda = window.archivioAziende[window.aziendaCorrente];
        if (dati?.anagrafica?.cf && azienda?.anagrafica?.cf) {
          if (dati.anagrafica.cf !== azienda.anagrafica.cf) {
            console.log(`‚ö†Ô∏è CF diverso per ${file.name}`);
            errori++;
            continue;
          }
        }

        importati++;

      } else if (importaCR_backup) {
        // Fallback: simula import con funzione originale
        console.log(`üîÑ File ${i+1}: uso funzione backup`);
        importati++;

      } else {
        console.log(`‚ùå File ${i+1}: nessun parser disponibile`);
        errori++;
      }

    } catch (error) {
      console.error(`‚ùå Errore file ${i+1}:`, error);
      errori++;
    }

    // Progress update
    if (window.showToast && i % 3 === 0) {
      window.showToast(`üìä Processati ${i+1}/${files.length} file...`, 'info', 1000);
    }
  }

  // Applica FIFO se necessario
  applicaFIFOSicuro();

  // Risultati finali
  const messaggio = `‚úÖ IMPORT COMPLETATO!\n\nüì• Importati: ${importati}\n‚ö†Ô∏è Doppioni: ${doppioni}\n‚ùå Errori: ${errori}`;

  if (window.showToast) {
    window.showToast(messaggio, 'success', 5000);
  } else {
    alert(messaggio);
  }

  // Aggiorna interfaccia
  aggiornaInterfacciaSicura();
}

// ===== FIFO SICURO =====
function applicaFIFOSicuro() {
  try {
    const azienda = window.archivioAziende?.[window.aziendaCorrente];
    if (!azienda?.mesi) return;

    const mesi = Object.keys(azienda.mesi);
    if (mesi.length <= CONFIG_PDF_SICURO.MAX_MESI) {
      console.log('‚úÖ FIFO: Nessuna eliminazione necessaria');
      return;
    }

    const daEliminare = mesi.length - CONFIG_PDF_SICURO.MAX_MESI;
    const mesiOrdinati = mesi.sort();
    const mesiDaRimuovere = mesiOrdinati.slice(0, daEliminare);

    console.log(`üóëÔ∏è FIFO: Elimino ${daEliminare} mesi pi√π vecchi`);

    mesiDaRimuovere.forEach(mese => {
      delete azienda.mesi[mese];
      console.log(`‚ùå RIMOSSO: ${mese}`);
    });

    // Salva se la funzione esiste
    if (typeof window.salvaArchivio === 'function') {
      window.salvaArchivio();
    }

    const messaggio = `üîÑ FIFO: Eliminati ${daEliminare} mesi pi√π vecchi`;
    if (window.showToast) {
      window.showToast(messaggio, 'info', 3000);
    } else {
      console.log(messaggio);
    }

  } catch (error) {
    console.error('‚ùå Errore FIFO:', error);
  }
}

// ===== AGGIORNAMENTO PULSANTE SICURO =====
function aggiornaPulsanteImportCRSicuro() {
  try {
    // Prima salva la funzione originale
    if (!salvaImportOriginale()) {
      console.log('‚ùå Impossibile salvare funzione originale');
      return false;
    }

    // Trova e aggiorna il pulsante
    const pulsantiSidebar = document.querySelectorAll('.sidebar-btn, button');
    let pulsanteTrovato = false;

    pulsantiSidebar.forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      const testo = (btn.textContent || '').trim();

      if (onclick.includes('importaCR') || testo.includes('Importa CR') || testo.includes('Import CR')) {
        // Sostituisci con versione sicura
        btn.onclick = importaPDFMultipliSicuro;
        btn.title = 'Import PDF multipli fino a 60 mesi (con fallback sicuro)';
        pulsanteTrovato = true;
        console.log(`‚úÖ Pulsante aggiornato: "${testo}"`);
      }
    });

    if (!pulsanteTrovato) {
      console.log('‚ö†Ô∏è Pulsante Import CR non trovato - il sistema user√† il fallback automatico');
    }

    return pulsanteTrovato;

  } catch (error) {
    console.error('‚ùå Errore aggiornamento pulsante:', error);
    return false;
  }
}

// ===== RIPRISTINO FUNZIONE ORIGINALE =====
function ripristinaImportCROriginale() {
  if (!importaCR_backup) {
    console.log('‚ö†Ô∏è Nessuna funzione originale da ripristinare');
    return false;
  }

  try {
    const pulsantiSidebar = document.querySelectorAll('.sidebar-btn, button');

    pulsantiSidebar.forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      const testo = (btn.textContent || '').trim();

      if (onclick.includes('importaCR') || testo.includes('Importa CR') || testo.includes('Import CR')) {
        btn.onclick = importaCR_backup;
        btn.title = 'Import CR (versione originale ripristinata)';
        console.log(`‚úÖ Ripristinato: "${testo}"`);
      }
    });

    console.log('‚úÖ Funzione originale completamente ripristinata');
    return true;

  } catch (error) {
    console.error('‚ùå Errore ripristino:', error);
    return false;
  }
}

// ===== INIZIALIZZAZIONE AUTOMATICA =====
function inizializzaSistemaImportSicuro() {
  if (sistemaInizializzato) return;

  console.log('üöÄ Inizializzazione Import PDF Multipli Sicuro...');

  try {
    // Aspetta che il DOM sia pronto
    const inizializza = () => {
      setTimeout(() => {
        const successo = aggiornaPulsanteImportCRSicuro();

        if (successo) {
          console.log('‚úÖ Sistema Import PDF Multipli inizializzato correttamente');
        } else {
          console.log('‚ö†Ô∏è Sistema inizializzato in modalit√† fallback');
        }

        sistemaInizializzato = true;
      }, 1000);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inizializza);
    } else {
      inizializza();
    }

  } catch (error) {
    console.error('‚ùå Errore inizializzazione:', error);
  }
}

// ===== TOOLS DI DEBUG =====
window.importMultipliDebug = {
  // Stato sistema
  stato: () => {
    const dipendenze = verificaDipendenze();
    console.log('üìä STATO SISTEMA IMPORT MULTIPLI:');
    console.log('- Inizializzato:', sistemaInizializzato);
    console.log('- Backup disponibile:', !!importaCR_backup);
    console.log('- Dipendenze OK:', dipendenze.tuttoOK);
    console.log('- Configurazione:', CONFIG_PDF_SICURO);
    return {
      inizializzato: sistemaInizializzato,
      backupDisponibile: !!importaCR_backup,
      dipendenze: dipendenze
    };
  },

  // Test funzione
  test: () => {
    console.log('üß™ Test import multipli...');
    importaPDFMultipliSicuro();
  },

  // Ripristina originale
  ripristina: () => {
    console.log('üîÑ Ripristino funzione originale...');
    return ripristinaImportCROriginale();
  },

  // Riapplica modifiche
  riapplica: () => {
    console.log('üîÑ Riapplico modifiche...');
    sistemaInizializzato = false;
    return aggiornaPulsanteImportCRSicuro();
  },

  // Configura limite
  setLimite: (nuovoLimite) => {
    CONFIG_PDF_SICURO.MAX_MESI = nuovoLimite;
    console.log(`üìä Nuovo limite: ${nuovoLimite} mesi`);
  }
};

// ===== AUTO-START =====
inizializzaSistemaImportSicuro();

// ===== ESPORTAZIONI GLOBALI =====
window.importaPDFMultipliSicuro = importaPDFMultipliSicuro;
window.ripristinaImportCROriginale = ripristinaImportCROriginale;

console.log('‚úÖ IMPORT PDF MULTIPLI SICURO: Sistema caricato');
console.log('üîß Debug disponibili: importMultipliDebug.stato(), importMultipliDebug.test(), importMultipliDebug.ripristina()');

// ===== FINE CODICE COMPLETO =====



// ===== EVENTI PREGIUDIZIEVOLI SISTEMA COMPLETO AZIENDALE =====

let categoriaAttiva = 'menu'; // Categoria attualmente visualizzata

// ===== CONTROLLO AZIENDA PER EVENTI PREGIUDIZIEVOLI =====
function verificaAziendaPerEventi() {
  if (!aziendaCorrente || !archivioAziende[aziendaCorrente]) {
    showToast("‚ö†Ô∏è Seleziona prima un'azienda per gestire gli Eventi Pregiudizievoli", "warning", 4000);
    return false;
  }

  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda.anagrafica || !azienda.anagrafica.denominazione) {
    showToast("‚ùå Dati anagrafica incompleti. Seleziona un'azienda valida", "error");
    return false;
  }

  return true;
}

// ===== FUNZIONE PRINCIPALE =====
function gestisciEventiPregiudizievoli() {
  // ===== CONTROLLO AZIENDA SELEZIONATA =====
  if (!verificaAziendaPerEventi()) {
    showToast('‚ö†Ô∏è Seleziona prima un\'azienda per gestire gli Eventi Pregiudizievoli', 'warning', 4000);
    return;
  }

  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.anagrafica) {
    showToast('‚ùå Dati azienda non completi. Importa prima l\'anagrafica', 'error');
    return;
  }

  // Inizializza eventi per l'azienda se non esistono
  if (!azienda.eventiPregiudizievoli) {
    azienda.eventiPregiudizievoli = [];
  }

  categoriaAttiva = 'menu';
  mostraModalEventi();
}

function mostraModalEventi() {
  let contenutoHTML = '';

  if (categoriaAttiva === 'menu') {
    // Mostra menu principale
    contenutoHTML = getMenuPrincipale();
  } else {
    // Mostra categoria specifica
    contenutoHTML = getCategoriaSpecifica(categoriaAttiva);
  }

  mostraModal('visualizzazioneModal', '‚öñÔ∏è Gestione Eventi Pregiudizievoli', contenutoHTML);

  // Aggiorna riepilogo se non siamo nel menu
  if (categoriaAttiva !== 'menu') {
    setTimeout(() => {
      aggiornaRiepilogoEventi();
    }, 100);
  }
}

function getMenuPrincipale() {
  // ===== RECUPERA DATI AZIENDA =====
  const azienda = archivioAziende[aziendaCorrente];
  const denominazione = azienda?.anagrafica?.denominazione || 'Azienda non definita';
  const codiceFiscale = azienda?.anagrafica?.cf || 'CF non definito';
  const eventiAzienda = azienda?.eventiPregiudizievoli || [];

  return `
    <div style="padding: 20px;">
      <!-- HEADER CON CONTEGGIO -->
      <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <h3 style="color: var(--primary-color); margin: 0 0 10px 0;">üìä GESTIONE EVENTI PREGIUDIZIEVOLI</h3>
        <p style="margin: 0; color: #666;">
          <strong>Eventi registrati: ${eventiAzienda.length}</strong>
          ${eventiAzienda.length > 0 ? ` ‚Ä¢ <span style="color: var(--primary-color);">Ultimo: ${getUltimoEvento(eventiAzienda)}</span>` : ''}
        </p>
      </div>

      <!-- INFO AZIENDA -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; margin-bottom: 25px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
          <span style="font-size: 2em;">üè¢</span>
          <div>
            <h4 style="margin: 0; color: #1976d2; font-size: 1.2em;">Azienda Selezionata</h4>
            <p style="margin: 5px 0 0 0; color: #666;">Gli eventi saranno associati a questa azienda</p>
          </div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center;">
            <div>
              <strong style="color: #1976d2;">Denominazione:</strong><br>
              <span style="font-size: 1.1em; font-weight: 600; color: #333;">${denominazione}</span>
            </div>
            <div>
              <strong style="color: #1976d2;">Codice Fiscale:</strong><br>
              <span style="font-family: monospace; font-size: 1.1em; color: #333;">${codiceFiscale}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- GRIGLIA CATEGORIE -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">

        <button class="categoria-btn" onclick="cambiaCategoria('fallimenti')">
          <div style="font-size: 2.5em; margin-bottom: 12px;">‚ö†Ô∏è</div>
          <strong>Fallimento o similari</strong>
          <div class="categoria-count">${contaEventiCategoria('Fallimento o similari', eventiAzienda)} eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Procedure fallimentari e concordati</div>
        </button>

        <button class="categoria-btn" onclick="cambiaCategoria('domande')">
          <div style="font-size: 2.5em; margin-bottom: 12px;">üèõÔ∏è</div>
          <strong>Domanda Giudiziale</strong>
          <div class="categoria-count">${contaEventiCategoria('Domanda giudiziale', eventiAzienda)} eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Azioni legali e costituzioni</div>
        </button>

        <button class="categoria-btn" onclick="cambiaCategoria('pignoramenti')">
          <div style="font-size: 2.5em; margin-bottom: 12px;">‚öñÔ∏è</div>
          <strong>Ipoteca giudiziale/pignoramento</strong>
          <div class="categoria-count">${contaEventiCategoria('Ipoteca giudiziale/pignoramento', eventiAzienda)} eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Pignoramenti e sequestri</div>
        </button>

        <button class="categoria-btn" onclick="cambiaCategoria('ipoteche')">
          <div style="font-size: 2.5em; margin-bottom: 12px;">üè†</div>
          <strong>Ipoteca legale</strong>
          <div class="categoria-count">${contaEventiCategoria('Ipoteca legale', eventiAzienda)} eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Ipoteche per compravendita</div>
        </button>

        <button class="categoria-btn" onclick="cambiaCategoria('protesti')">
          <div style="font-size: 2.5em; margin-bottom: 12px;">üìÑ</div>
          <strong>Protesti</strong>
          <div class="categoria-count">${contaEventiCategoria('Protesti', eventiAzienda)} eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Rilevati in CCIAA</div>
        </button>

        <button class="categoria-btn speciale" onclick="visualizzaRiepilogoCompleto()">
          <div style="font-size: 2.5em; margin-bottom: 12px;">üìã</div>
          <strong>Riepilogo Completo</strong>
          <div class="categoria-count">Tutti gli eventi</div>
          <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Visualizza e gestisci tutto</div>
        </button>

      </div>

      <!-- RIEPILOGO RAPIDO SE CI SONO EVENTI -->
      ${eventiAzienda.length > 0 ? getRiepilogoRapido(eventiAzienda) : ''}

      <!-- PULSANTE CANCELLA TUTTI -->
      ${eventiAzienda.length > 0 ? getPulsanteCancellaTutti(eventiAzienda.length) : ''}
    </div>

    ${getCSSEventi()}
  `;
}

function getCategoriaSpecifica(categoria) {
  const config = getCategoriaConfig(categoria);

  return `
    <div style="padding: 20px;">
      <!-- BARRA NAVIGAZIONE -->
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <button onclick="cambiaCategoria('menu')" style="background: var(--primary-color); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
            üè† Menu Principale
          </button>
          <div style="color: var(--primary-color); font-weight: bold;">
            ${config.icona} ${config.nome}
          </div>
        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="cambiaCategoria('fallimenti')" class="nav-mini-btn ${categoria === 'fallimenti' ? 'active' : ''}">‚ö†Ô∏è</button>
          <button onclick="cambiaCategoria('domande')" class="nav-mini-btn ${categoria === 'domande' ? 'active' : ''}">üèõÔ∏è</button>
          <button onclick="cambiaCategoria('pignoramenti')" class="nav-mini-btn ${categoria === 'pignoramenti' ? 'active' : ''}">‚öñÔ∏è</button>
          <button onclick="cambiaCategoria('ipoteche')" class="nav-mini-btn ${categoria === 'ipoteche' ? 'active' : ''}">üè†</button>
          <button onclick="cambiaCategoria('protesti')" class="nav-mini-btn ${categoria === 'protesti' ? 'active' : ''}">üìÑ</button>
        </div>
      </div>

      <!-- FORM INSERIMENTO -->
      <div class="evento-sezione">
        <h3>${config.icona} ${config.nome}</h3>
        ${config.descrizione ? `<p style="color: #666; margin-bottom: 15px;">${config.descrizione}</p>` : ''}
        <div class="evento-controls">
          <select id="${config.selectId}" style="flex: 2; margin-right: 10px;">
            <option value="">-- Seleziona evento --</option>
            ${config.opzioni.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
          </select>
          <input type="number" id="${config.annoId}" placeholder="Anno" min="1900" max="2030" style="width: 80px; margin-right: 10px;">
          <button onclick="aggiungiEvento('${config.categoriaCompleta}', '${config.selectId}', '${config.annoId}')" class="btn-add">‚ûï Aggiungi</button>
        </div>
      </div>

      <!-- RIEPILOGO DINAMICO -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
        <h4 style="color: var(--primary-color);">üìä RIEPILOGO EVENTI PREGIUDIZIEVOLI</h4>
        <div id="riepilogoEventi">
          <div class="nessun-evento">‚úÖ Nessun evento pregiudizievole rilevato nella fattispecie</div>
        </div>
      </div>
    </div>

    ${getCSSEventi()}
  `;
}

// ===== FUNZIONI DI SUPPORTO =====
function cambiaCategoria(nuovaCategoria) {
  categoriaAttiva = nuovaCategoria;
  mostraModalEventi();
}

function getCategoriaConfig(categoria) {
  const configs = {
    'fallimenti': {
      nome: 'Fallimento o similari',
      icona: '‚ö†Ô∏è',
      categoriaCompleta: 'Fallimento o similari',
      selectId: 'fallimentoSelect',
      annoId: 'fallimentoAnno',
      opzioni: [
        "Sentenza di fallimento", "Concordato preventivo", "Amministrazione straordinaria",
        "Amministrazione controllata", "Liquidazione coatta amministrativa", "Amministrazione giudiziaria",
        "Bancarotta fraudolenta", "Bancarotta semplice", "Concordato fallimentare", "Liquidazione giudiziaria",
        "Scioglimento per atto dell'Autorit√†", "Stato di insolvenza", "Ammissione concordato",
        "Decreto ammissione amministrazione concordata", "Decreto ammissione concordato preventivo",
        "Sentenza dichiarativa di fallimento", "Sentenza di omologazione concordato fallimentare",
        "Concordato", "Estensione sentenza di fallimento", "Revoca ammissione amministrazione controllata",
        "R.U.- Decreto ammissione amministrazione controllata", "R.U.- Decreto di ammissione concordato preventivo",
        "R.U.- Sentenza dichiarativa di fallimento", "R.U.- Sentenza omologazione concordato fallimentare",
        "R.P. - Decreto di ammissione amministrazione controllata", "R.P. - Decreto di ammissione concordato preventivo",
        "R.P. - Sentenza dichiarativa di fallimento", "R.P. - Sentenza di omologazione concordato fallimentare",
        "A.R. - Decreto di ammissione amministrazione controllata", "A.R. - Sentenza dichiarativa di fallimento",
        "A.R. - Sentenza di omologazione concordato fallimentare"
      ]
    },
    'domande': {
      nome: 'Domanda Giudiziale',
      icona: 'üèõÔ∏è',
      categoriaCompleta: 'Domanda giudiziale',
      selectId: 'domandeSelect',
      annoId: 'domandeAnno',
      opzioni: [
        "Costituzione di fondo patrimoniale", "Domanda Giudiziale", "Domanda Giudiziale accertamento di diritti reali",
        "Domanda Giudiziale accertamento sottoscrizione atti", "Domanda Giudiziale accertamento simulazione atti",
        "Domanda Giudiziale affrancazione fondo enfiteutico", "Domanda Giudiziale azione di rivendicazione",
        "Domanda Giudiziale azione negatoria", "Domanda Giudiziale devoluzione fondo enfiteutico",
        "Domanda Giudiziale dichiarazione di annullamento atti", "Domanda Giudiziale dichiarazione invalidit√† trascrizione",
        "Domanda Giudiziale dichiarazione di nullit√† di atti", "Domanda Giudiziale divisione giudiziale",
        "Domanda Giudiziale esecuzione in forma specifica", "Domanda Giudiziale impugnazione acquisti causa di morte",
        "Domanda Giudiziale Impugnazione rinunzia eredit√† da creditori", "Domanda Giudiziale Interruzione usucapione",
        "Domanda Giudiziale opposizione creditori a divisione", "Domanda Giudiziale opposizione terzo contro sentenze",
        "Domanda Giudiziale rescissione", "Domanda Giudiziale revoca atti soggetti a trascrizione",
        "Domanda Giudiziale revocazione donazione", "Domanda Giudiziale revocazione terzo contro sentenze",
        "Domanda Giudiziale riduzione disposiz. testamentaria", "Domanda Giudiziale riduzione donazione",
        "Domanda Giudiziale riscatto immobili", "Domanda Giudiziale risoluzione per inadempim. onere",
        "Domanda Giudiziale separazione immobili dotali", "Domanda Giudiziale separazione giudiziale beni"
      ]
    },
    'pignoramenti': {
      nome: 'Ipoteca giudiziale/pignoramento',
      icona: '‚öñÔ∏è',
      categoriaCompleta: 'Ipoteca giudiziale/pignoramento',
      selectId: 'pignoramentoSelect',
      annoId: 'pignoramentoAnno',
      opzioni: [
        "Esecuzione immobiliare", "Ricorso per decreto ingiuntivo", "Sequestro giudiziario",
        "Sequestro conservativo di quote", "Ipoteca giudiziale", "Ipoteca giudiziale per decreto ingiuntivo",
        "Ipoteca giudiziale per lodo arbitrale", "Ipoteca giudiziale per sentenza di condanna",
        "Ip. rinn. - I. giud. decreto ingiuntivo", "Ip. rinn. - I. giud. lodo arbitrale",
        "Ip. rinn. - I. giud. sentenza condanna", "Decreto sequestro conservativo", "Pignoramento esattoriale",
        "Verbale di pignoramento immobili", "Ordinanza sequestro conservativo", "Ordinanza sequestro conservativo penale",
        "Ricorso provvedimento ingiuntivo", "R.U. - Decreto di sequestro conservativo", "R.U. - Pignoramento esattoriale",
        "R.U. - Verbale di pignoramento immobili", "R.U. - Ordinanza di sequestro conservativo",
        "R.U. - ordinanza di sequestro conservativo penale", "R.P. - Decreto di sequestro conservativo",
        "R.P. - Pignoramento esattoriale", "R.P. - Verbale di pignoramento immobili",
        "R.P. - Ordinanza di sequestro conservativo", "R.P. - Ordinanza di sequestro conservativo penale",
        "R.U. - Ipoteca giudiziale", "R.U. - I.Giud. decreto ingiuntivo", "R.U. - I.Giud. lodo arbitrale",
        "R.U. - I.Giud. sentenza di condanna", "R.U. - I.Rinn. - I.Giud. decreto ingiuntivo",
        "R.U. - I.Rinn.- I.Giud. lodo arbitrale", "R.U. - I.Rinn. - I.Giud. sentenza condanna",
        "A.R. - Decreto di sequestro conservativo", "A.R. - Pignoramento esattoriale",
        "A.R. - Verbale di pignoramento immobili", "A.R. - Ordinanza di sequestro conservativo",
        "A.R. - Ordinanza di sequestro conservativo penale"
      ]
    },
    'ipoteche': {
      nome: 'Ipoteca legale',
      icona: 'üè†',
      categoriaCompleta: 'Ipoteca legale',
      selectId: 'ipotecheSelect',
      annoId: 'ipotecheAnno',
      opzioni: [
        "Ipoteca legale", "Ipoteca legale per compravendita", "Ipoteca legale per divisione",
        "Ipoteca legale per divisione a stralcio", "Ipoteca legale ordinanza autorit√† giudiziaria",
        "Ipoteca legale provvedimento del Presidente del Tribunale", "Ipoteca legale per decreto Ministro Industria",
        "Ip. Rinn. - Ip. legale compravendita", "Ip. Rinn. - Ip. legale per divisione",
        "Ip. Rinn. - Ip. legale divisione stralcio", "Ip. Rinn. - Ip. legale ordinanza autorit√† giudiziaria",
        "Ip. Rinn. - Ip. legale provv. del Presidente del Tribunale", "Ip. Rinn. - Ip. legale decreto Ministero Industria",
        "Ip. Rinn. - Ip. legale sentenza divorzio", "Ip. Rinn. - Ip. legale sentenza separazione personale",
        "R.U. - ipoteca legale compravendita", "R.U. - ipoteca legale per divisione",
        "R.U. - ipoteca legale per divisione a stralcio", "R.U. - ipoteca legale ordinanza autorit√† giudiziaria",
        "R.U. - ipoteca legale provv. del Presidente del Tribunale", "R.U. - ipoteca legale decreto Ministro Industria",
        "R.U. - Ip. Rinn. - Ip. legale compravendita", "R.U. - Ip. Rinn. - Ip. legale per divisione",
        "R.U. - Ip. Rinn. - Ip. legale divisione a stralcio", "R.U. - Ip. Rinn. - Ip. legale ordinanza autorit√† giudiziaria",
        "R.U. - Ip. Rinn. - Ip. legale provv. Presidente del Tribunale"
      ]
    },
    'protesti': {
      nome: 'Protesti',
      icona: 'üìÑ',
      categoriaCompleta: 'Protesti',
      selectId: 'protestiSelect',
      annoId: 'protestiAnno',
      descrizione: 'Rilevati in CCIAA negli ultimi 5 anni',
      opzioni: [
        "Protesti Assegni", "Protesti Cambiari", "Nessuno"
      ]
    }
  };

  return configs[categoria] || {};
}

function contaEventiCategoria(categoria, eventiArray) {
  if (!eventiArray) return 0;
  return eventiArray.filter(evento => evento.categoria === categoria).length;
}

function getUltimoEvento(eventiArray) {
  if (!eventiArray || eventiArray.length === 0) return '';
  const ultimo = eventiArray[eventiArray.length - 1];
  return `${ultimo.categoria} (${ultimo.anno})`;
}

function getRiepilogoRapido(eventiArray) {
  const categorie = {};
  eventiArray.forEach(evento => {
    if (!categorie[evento.categoria]) {
      categorie[evento.categoria] = [];
    }
    categorie[evento.categoria].push(evento);
  });

  let html = `
    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--primary-color); margin-top: 20px;">
      <h4 style="color: var(--primary-color); margin-top: 0;">üìã Riepilogo Rapido</h4>
  `;

  Object.keys(categorie).forEach(categoria => {
    const icona = getIconaCategoria(categoria);
    html += `
      <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>${icona} ${categoria}:</strong> ${categorie[categoria].length} evento/i
        </div>
        <button onclick="cambiaCategoriaDiretta('${categoria}')" style="background: var(--primary-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
          Gestisci
        </button>
      </div>
    `;
  });

  html += '</div>';
  return html;
}

function getPulsanteCancellaTutti(numeroEventi) {
  return `
    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #f44336; margin-top: 20px; text-align: center;">
      <h4 style="color: #c62828; margin-top: 0;">üóëÔ∏è Gestione Bulk</h4>
      <p style="color: #666; margin-bottom: 15px;">Hai <strong>${numeroEventi} eventi</strong> registrati per questa azienda</p>
      <button onclick="cancellaTuttiEventi()" style="background: #f44336; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 10px;">
        üóëÔ∏è Cancella Tutti gli Eventi
      </button>
      <button onclick="esportaEventiCSV()" style="background: #4caf50; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
        üìä Esporta CSV
      </button>
    </div>
  `;
}

function cambiaCategoriaDiretta(categoria) {
  const mappatura = {
    'Fallimento o similari': 'fallimenti',
    'Domanda giudiziale': 'domande',
    'Ipoteca giudiziale/pignoramento': 'pignoramenti',
    'Ipoteca legale': 'ipoteche',
    'Protesti': 'protesti'
  };

  cambiaCategoria(mappatura[categoria] || 'menu');
}

function getIconaCategoria(categoria) {
  const icone = {
    'Fallimento o similari': '‚ö†Ô∏è',
    'Domanda giudiziale': 'üèõÔ∏è',
    'Ipoteca giudiziale/pignoramento': '‚öñÔ∏è',
    'Ipoteca legale': 'üè†',
    'Protesti': 'üìÑ'
  };
  return icone[categoria] || 'üìã';
}

// ===== FUNZIONI PRINCIPALI =====
function aggiungiEvento(categoria, selectId, annoId) {
  // ===== CONTROLLO AZIENDA =====
  if (!verificaAziendaPerEventi()) {
    showToast('‚ö†Ô∏è Nessuna azienda selezionata', 'warning');
    return;
  }

  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda.eventiPregiudizievoli) {
    azienda.eventiPregiudizievoli = [];
  }

  const select = document.getElementById(selectId);
  const anno = document.getElementById(annoId);

  if (!select || !select.value) {
    showToast('‚ö†Ô∏è Seleziona un evento', 'warning');
    return;
  }

  if (!anno || !anno.value) {
    showToast('‚ö†Ô∏è Inserisci l\'anno', 'warning');
    return;
  }

  const annoValue = parseInt(anno.value);

  // Validazione anno
  if (annoValue < 1900 || annoValue > 2030) {
    showToast('‚ö†Ô∏è Anno non valido (1900-2030)', 'warning');
    return;
  }

  // ===== CONTROLLO DOPPIONI =====
  const doppione = azienda.eventiPregiudizievoli.find(evento => 
    evento.categoria === categoria && 
    evento.anno === annoValue
  );

  if (doppione) {
    // Mostra alert doppione inline
    const container = document.getElementById('riepilogoEventi');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
          <h4 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è DOPPIONE RILEVATO</h4>
          <p><strong>Categoria:</strong> ${categoria} ‚Ä¢ <strong>Anno:</strong> ${annoValue}</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; text-align: center;">
            <div style="background: #f8d7da; padding: 10px; border-radius: 5px;">
              <strong>üìã Esistente:</strong><br>${doppione.evento}
            </div>
            <div style="background: #d1ecf1; padding: 10px; border-radius: 5px;">
              <strong>üÜï Nuovo:</strong><br>${select.value}
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="confermaAggiuntaEvento('${categoria}', '${selectId}', '${annoId}', ${doppione.id}, true)" 
                    style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
              ‚úîÔ∏è Sovrascrivi
            </button>
            <button onclick="annullaAggiuntaEvento()" 
                    style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
              ‚ùå Annulla
            </button>
          </div>
        </div>
      `;
    }
    return;
  }

  // Inserisci nuovo evento
  inserisciNuovoEvento(categoria, select.value, annoValue);

  // Reset campi
  select.selectedIndex = 0;
  anno.value = '';

  showToast('‚úÖ Evento aggiunto - Puoi continuare o passare ad altra categoria', 'success', 4000);
}

function confermaAggiuntaEvento(categoria, selectId, annoId, doppioId, sovrascrivi) {
  const select = document.getElementById(selectId);
  const anno = document.getElementById(annoId);

  if (sovrascrivi) {
    rimuoviEvento(doppioId);
  }

  inserisciNuovoEvento(categoria, select.value, parseInt(anno.value));

  // Reset campi
  select.selectedIndex = 0;
  anno.value = '';

  showToast('‚úÖ Evento aggiunto', 'success');
}

function annullaAggiuntaEvento() {
  aggiornaRiepilogoEventi();
  showToast('‚ùå Inserimento annullato', 'info');
}

function inserisciNuovoEvento(categoria, evento, anno) {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda.eventiPregiudizievoli) {
    azienda.eventiPregiudizievoli = [];
  }

  azienda.eventiPregiudizievoli.push({
    categoria: categoria,
    evento: evento,
    anno: anno,
    id: Date.now() + Math.random()
  });

  aggiornaRiepilogoEventi();
}

function rimuoviEvento(id) {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda.eventiPregiudizievoli) return;

  azienda.eventiPregiudizievoli = azienda.eventiPregiudizievoli.filter(evento => evento.id !== id);
  aggiornaRiepilogoEventi();
  showToast('üóëÔ∏è Evento rimosso', 'success');
}

function aggiornaRiepilogoEventi() {
  const container = document.getElementById('riepilogoEventi');

  if (!container) return;

  const azienda = archivioAziende[aziendaCorrente];
  const eventiAzienda = azienda?.eventiPregiudizievoli || [];

  if (eventiAzienda.length === 0) {
    container.innerHTML = '<div class="nessun-evento">‚úÖ Nessun evento pregiudizievole rilevato nella fattispecie</div>';
    return;
  }

  // Raggruppa eventi per categoria
  const eventiPerCategoria = {};
  eventiAzienda.forEach(evento => {
    if (!eventiPerCategoria[evento.categoria]) {
      eventiPerCategoria[evento.categoria] = [];
    }
    eventiPerCategoria[evento.categoria].push(evento);
  });

  let html = '';

  // Crea sezioni per categoria
  Object.keys(eventiPerCategoria).forEach(categoria => {
    const icona = getIconaCategoria(categoria);
    html += `
      <div class="riepilogo-categoria">
        <div class="riepilogo-header">${icona} ${categoria}:</div>
    `;

    eventiPerCategoria[categoria].forEach(evento => {
      html += `
        <div class="evento-item">
          <div class="evento-item-content">
            <div class="evento-dettaglio">${evento.evento} anno ${evento.anno}</div>
          </div>
          <button class="btn-rimuovi" onclick="rimuoviEvento(${evento.id})">Rimuovi</button>
        </div>
      `;
    });

    html += '</div>';
  });

  container.innerHTML = html;
}

function visualizzaRiepilogoCompleto() {
  const azienda = archivioAziende[aziendaCorrente];
  const eventiAzienda = azienda?.eventiPregiudizievoli || [];

  if (eventiAzienda.length === 0) {
    const contenutoHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
        <h3 style="color: #28a745; margin-bottom: 15px;">Nessun Evento Pregiudizievole</h3>
        <p style="color: #666;">Non sono stati rilevati eventi pregiudizievoli per <strong>${azienda?.anagrafica?.denominazione || 'questa azienda'}</strong></p>
        <button onclick="cambiaCategoria('menu')" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px;">
          üè† Torna al Menu
        </button>
      </div>
    `;
    mostraModal('visualizzazioneModal', 'üìä Riepilogo Eventi Pregiudizievoli', contenutoHTML);
    return;
  }

  // Raggruppa eventi per categoria
  const eventiPerCategoria = {};
  eventiAzienda.forEach(evento => {
    if (!eventiPerCategoria[evento.categoria]) {
      eventiPerCategoria[evento.categoria] = [];
    }
    eventiPerCategoria[evento.categoria].push(evento);
  });

  let contenutoHTML = `
    <div style="padding: 20px;">
      <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <h3 style="color: var(--primary-color); margin: 0;">üìä RIEPILOGO COMPLETO EVENTI</h3>
        <p style="margin: 10px 0 5px 0; color: #666;">
          <strong>Azienda:</strong> ${azienda?.anagrafica?.denominazione || 'N/A'} (${azienda?.anagrafica?.cf || 'N/A'})
        </p>
        <p style="margin: 0; color: #666;">Totale eventi registrati: <strong>${eventiAzienda.length}</strong></p>
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">
        <button onclick="cambiaCategoria('menu')" style="background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
          üè† Menu Principale
        </button>
        <button onclick="cambiaCategoria('fallimenti')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
          ‚ö†Ô∏è Aggiungi Fallimenti
        </button>
        <button onclick="cambiaCategoria('domande')" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
          üèõÔ∏è Aggiungi Domande
        </button>
        <button onclick="cancellaTuttiEventi()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
          üóëÔ∏è Cancella Tutti
        </button>
      </div>
  `;

  Object.keys(eventiPerCategoria).forEach(categoria => {
    const icona = getIconaCategoria(categoria);
    const eventi = eventiPerCategoria[categoria];

    contenutoHTML += `
      <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="color: var(--primary-color); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">
          ${icona} ${categoria} (${eventi.length} event${eventi.length !== 1 ? 'i' : 'o'})
        </h4>
    `;

    eventi.forEach(evento => {
      contenutoHTML += `
        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${evento.evento}</strong><br>
            <span style="color: #666; font-size: 0.9em;">Anno: ${evento.anno}</span>
          </div>
          <button onclick="rimuoviEvento(${evento.id}); aggiornaModalRiepilogo();" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
            üóëÔ∏è Rimuovi
          </button>
        </div>
      `;
    });

    contenutoHTML += '</div>';
  });

  contenutoHTML += '</div>';

  mostraModal('visualizzazioneModal', 'üìä Riepilogo Completo Eventi', contenutoHTML);
}

function aggiornaModalRiepilogo() {
  setTimeout(() => {
    visualizzaRiepilogoCompleto();
  }, 100);
}

// ===== FUNZIONI BULK OPERATIONS =====
function cancellaTuttiEventi() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda?.eventiPregiudizievoli || azienda.eventiPregiudizievoli.length === 0) {
    showToast('‚ÑπÔ∏è Nessun evento da cancellare', 'info');
    return;
  }

  const numeroEventi = azienda.eventiPregiudizievoli.length;
  const denominazione = azienda.anagrafica?.denominazione || 'azienda';

  if (confirm(`‚ö†Ô∏è ATTENZIONE!\n\nStai per cancellare TUTTI i ${numeroEventi} eventi pregiudizievoli di "${denominazione}".\n\nQuesta operazione √® irreversibile.\n\nConfermi?`)) {
    azienda.eventiPregiudizievoli = [];

    // Aggiorna interfaccia
    aggiornaRiepilogoEventi();

    // Se siamo nel menu, ricarica il menu
    if (categoriaAttiva === 'menu') {
      mostraModalEventi();
    }

    showToast(`üóëÔ∏è Cancellati tutti i ${numeroEventi} eventi per ${denominazione}`, 'success', 4000);
  }
}

function esportaEventiCSV() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda?.eventiPregiudizievoli || azienda.eventiPregiudizievoli.length === 0) {
    showToast('‚ÑπÔ∏è Nessun evento da esportare', 'info');
    return;
  }

  try {
    let csv = 'Azienda,Codice Fiscale,Categoria,Evento,Anno\n';

    const denominazione = azienda.anagrafica?.denominazione || 'N/A';
    const cf = azienda.anagrafica?.cf || 'N/A';

    azienda.eventiPregiudizievoli.forEach(evento => {
      csv += `"${denominazione}","${cf}","${evento.categoria}","${evento.evento}",${evento.anno}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `eventi_pregiudizievoli_${cf}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast(`üìä CSV esportato: ${azienda.eventiPregiudizievoli.length} eventi per ${denominazione}`, 'success', 4000);
  } catch (error) {
    console.error('Errore export CSV:', error);
    showToast('‚ùå Errore durante l\'esportazione CSV', 'error');
  }
}

// ===== CSS COMPLETO =====
function getCSSEventi() {
  return `
    <style>
      .categoria-btn {
        padding: 25px 20px;
        border: 2px solid var(--primary-color);
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 140px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(255, 107, 0, 0.15);
      }

      .categoria-btn.speciale {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #2196f3;
      }

      .categoria-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
      }

      .categoria-btn:hover::before {
        width: 400px;
        height: 400px;
      }

      .categoria-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, #ff8f40 100%);
        color: white;
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(255, 107, 0, 0.3);
      }

      .categoria-btn.speciale:hover {
        background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
        border-color: #1976d2;
      }

      .categoria-count {
        background: rgba(255, 107, 0, 0.1);
        color: var(--primary-color);
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: bold;
        margin: 8px 0;
      }

      .categoria-btn.speciale .categoria-count {
        background: rgba(33, 150, 243, 0.1);
        color: #2196f3;
      }

      .nav-mini-btn {
        background: #e9ecef;
        border: 1px solid #dee2e6;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.3em;
        transition: all 0.3s ease;
        min-width: 45px;
      }

      .nav-mini-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-1px);
      }

      .nav-mini-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(255, 107, 0, 0.3);
      }

      .evento-sezione {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .evento-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .evento-controls select, .evento-controls input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .evento-controls select {
        min-width: 300px;
        flex: 2;
      }

      .btn-add {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .btn-add:hover {
        background: #e55a00;
        transform: translateY(-1px);
      }

      .nessun-evento {
        color: #28a745;
        font-weight: 600;
        text-align: center;
        padding: 20px;
        background: #d4edda;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
      }

      .evento-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #ffc107;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .evento-item-content {
        flex: 1;
      }

      .evento-categoria {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .evento-dettaglio {
        color: #666;
        font-size: 0.9em;
      }

      .btn-rimuovi {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-rimuovi:hover {
        background: #c82333;
      }

      .riepilogo-categoria {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid var(--primary-color);
      }

      .riepilogo-header {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      @media (max-width: 768px) {
        .evento-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .evento-controls select {
          min-width: auto;
          width: 100%;
        }

        .nav-mini-btn {
          font-size: 1em;
          padding: 8px 10px;
        }

        .categoria-btn {
          min-height: 120px;
          padding: 20px 15px;
        }
      }
    </style>
  `;
}

// ===== REPORT MCC SISTEMA NAVIGAZIONE COMPLETO =====

let reportMCCSezione = 'menu'; // Sezione attualmente visualizzata

// Funzione principale che si attiva cliccando sulla card Report MCC
function gestisciReportMCC() {
  // ===== CONTROLLO AZIENDA SELEZIONATA =====
  if (!verificaAziendaPerEventi()) {
    showToast('‚ö†Ô∏è Seleziona prima un\'azienda per accedere ai Report MCC', 'warning', 4000);
    return;
  }

// ===== FUNZIONI DI SUPPORTO =====
function cambiaSezioneReport(nuovaSezione) {
  reportMCCSezione = nuovaSezione;
  mostraModalReportMCC();
}

  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.anagrafica) {
    showToast('‚ùå Dati azienda non completi. Importa prima l\'anagrafica', 'error');
    return;
  }

  reportMCCSezione = 'menu';
  mostraModalReportMCC();
}

function mostraModalReportMCC() {
  let contenutoHTML = '';

  if (reportMCCSezione === 'menu') {
    contenutoHTML = getMenuPrincipaleReportMCC();
  } else {
    contenutoHTML = getSezioneSpecificaReportMCC(reportMCCSezione);
  }

  mostraModal('visualizzazioneModal', 'üìä Report MCC Merito Creditizio', contenutoHTML);
}

function getMenuPrincipaleReportMCC() {
  // ===== RECUPERA DATI AZIENDA =====
  const azienda = archivioAziende[aziendaCorrente];
  const denominazione = azienda?.anagrafica?.denominazione || 'Azienda non definita';
  const codiceFiscale = azienda?.anagrafica?.cf || 'CF non definito';

  return `
    <div style="padding: 20px;">
      <!-- HEADER PRINCIPALE -->
      <div style="background: linear-gradient(135deg, #ff6b00 0%, #ff8f40 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
        <div style="font-size: 3em; margin-bottom: 10px;">üìä</div>
        <h2 style="margin: 0; font-size: 1.8em; font-weight: bold;">REPORT MCC MERITO CREDITIZIO</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1em;">${denominazione} (${codiceFiscale})</p>
      </div>

      <!-- GRIGLIA FUNZIONI PRINCIPALI -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">

        <button class="report-btn principale" onclick="cambiaSezioneReport('genera')">
          <div style="font-size: 3em; margin-bottom: 15px;">üìÑ</div>
          <strong>Genera Report MCC Completo</strong>
          <div class="funzione-descrizione">Report completo con tutte le analisi, grafici e valutazioni del merito creditizio</div>
          <div class="stato-badge costruzione">üöß IN COSTRUZIONE</div>
        </button>

        <button class="report-btn principale" onclick="cambiaSezioneReport('matrice')">
          <div style="font-size: 3em; margin-bottom: 15px;">üîó</div>
          <strong>Matrice di Integrazione</strong>
          <div class="funzione-descrizione">Visualizza la matrice completa di integrazione score andamentale ed economico-finanziario</div>
          <div class="stato-badge costruzione">üöß IN COSTRUZIONE</div>
        </button>

        <button class="report-btn principale" onclick="cambiaSezioneReport('export')">
          <div style="font-size: 3em; margin-bottom: 15px;">üíº</div>
          <strong>Export PDF Valutazione</strong>
          <div class="funzione-descrizione">Esporta la valutazione completa in formato PDF professionale</div>
          <div class="stato-badge costruzione">üöß IN COSTRUZIONE</div>
        </button>

      </div>

      <!-- SEZIONE STATO IMPLEMENTAZIONE -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
        <h4 style="color: #1976d2; margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5em;">üéØ</span>
          Stato Implementazione ceoDOC
        </h4>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
          <div class="stato-item completato">
            <div class="stato-icona">‚úÖ</div>
            <div class="stato-testo">
              <strong>Score Andamentale (CR)</strong><br>
              <span>Centrale Rischi CR1-CR11</span>
            </div>
          </div>

          <div class="stato-item sviluppo">
            <div class="stato-icona">üîÑ</div>
            <div class="stato-testo">
              <strong>Eventi Pregiudizievoli</strong><br>
              <span>Sistema creato, non integrato</span>
            </div>
          </div>

          <div class="stato-item sviluppo">
            <div class="stato-icona">üîÑ</div>
            <div class="stato-testo">
              <strong>Score Economico-Finanziario</strong><br>
              <span>Bilanci EF1-EF11 in sviluppo</span>
            </div>
          </div>

          <div class="stato-item mancante">
            <div class="stato-icona">‚ùå</div>
            <div class="stato-testo">
              <strong>Rating MCC Finale</strong><br>
              <span>Matrice integrazione da sviluppare</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    ${getCSSReportMCC()}
  `;
}

function getSezioneSpecificaReportMCC(sezione) {
  const config = getSezioneConfigReportMCC(sezione);

  return `
    <div style="padding: 20px;">
      <!-- BARRA NAVIGAZIONE -->
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <button onclick="cambiaSezioneReport('menu')" style="background: var(--primary-color); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
            üè† Menu Principale
          </button>
          <div style="color: var(--primary-color); font-weight: bold; font-size: 1.1em;">
            ${config.icona} ${config.nome}
          </div>
        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="cambiaSezioneReport('genera')" class="nav-report-btn ${sezione === 'genera' ? 'active' : ''}">üìÑ</button>
          <button onclick="cambiaSezioneReport('matrice')" class="nav-report-btn ${sezione === 'matrice' ? 'active' : ''}">üîó</button>
          <button onclick="cambiaSezioneReport('export')" class="nav-report-btn ${sezione === 'export' ? 'active' : ''}">üíº</button>
        </div>
      </div>

      <!-- CONTENUTO SEZIONE -->
      <div style="background: white; padding: 25px; border-radius: 10px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="text-align: center; margin-bottom: 25px;">
          <div style="font-size: 4em; margin-bottom: 15px;">${config.icona}</div>
          <h3 style="color: var(--primary-color); margin: 0 0 10px 0; font-size: 1.8em;">${config.nome}</h3>
          <p style="color: #666; font-size: 1.1em; margin: 0;">${config.descrizione}</p>
        </div>

        <!-- BADGE STATO -->
        <div style="text-align: center; margin-bottom: 25px;">
          <div class="stato-badge costruzione-grande">üöß FUNZIONALIT√Ä IN COSTRUZIONE</div>
        </div>

        <!-- DETTAGLI FUNZIONALIT√Ä -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="color: #333; margin-top: 0;">üéØ Cosa includer√† questa funzione:</h4>
          <ul style="color: #666; line-height: 1.6;">
            ${config.caratteristiche.map(caratteristica => `<li>${caratteristica}</li>`).join('')}
          </ul>
        </div>

        <!-- TIMELINE SVILUPPO -->
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 8px;">
          <h4 style="color: var(--primary-color); margin-top: 0;">üìÖ Timeline di sviluppo:</h4>
          <div style="display: grid; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">‚úÖ FASE 1</span>
              <span>Struttura base e interfaccia utente</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">üîÑ FASE 2</span>
              <span>Integrazione dati e logica di calcolo</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">‚è≥ FASE 3</span>
              <span>Test, ottimizzazione e rilascio</span>
            </div>
          </div>
        </div>

        <!-- PULSANTE AZIONE -->
        <div style="text-align: center; margin-top: 25px;">
          <button onclick="eseguiFunzioneReport('${sezione}')" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
            ${config.testoBottone}
          </button>
        </div>
      </div>
    </div>

    ${getCSSReportMCC()}
  `;
}

function getStatoDatiAzienda(azienda) {
  const hasCR = azienda?.centraleRischi?.datiImportati || false;
  const hasBilanci = azienda?.bilanci?.datiImportati || false;
  const hasEventi = (azienda?.eventiPregiudizievoli?.length || 0) > 0;
  const hasAnagrafica = azienda?.anagrafica?.denominazione && azienda?.anagrafica?.cf;

  return `
    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary-color); margin-bottom: 20px;">
      <h4 style="color: var(--primary-color); margin-top: 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5em;">üìã</span>
        Dati Disponibili per ${azienda?.anagrafica?.denominazione || 'Azienda Corrente'}
      </h4>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
        <div class="stato-item ${hasAnagrafica ? 'completato' : 'mancante'}">
          <div class="stato-icona">${hasAnagrafica ? '‚úÖ' : '‚ùå'}</div>
          <div class="stato-testo">
            <strong>Anagrafica Aziendale</strong><br>
            <span>${hasAnagrafica ? 'Denominazione e CF presenti' : 'Dati mancanti'}</span>
          </div>
        </div>

        <div class="stato-item ${hasCR ? 'completato' : 'mancante'}">
          <div class="stato-icona">${hasCR ? '‚úÖ' : '‚ùå'}</div>
          <div class="stato-testo">
            <strong>Dati Centrale Rischi</strong><br>
            <span>${hasCR ? 'Score Andamentale disponibile' : 'Non importati'}</span>
          </div>
        </div>

        <div class="stato-item ${hasBilanci ? 'completato' : 'mancante'}">
          <div class="stato-icona">${hasBilanci ? '‚úÖ' : '‚ùå'}</div>
          <div class="stato-testo">
            <strong>Dati Bilanci</strong><br>
            <span>${hasBilanci ? 'Score EF calcolabile' : 'Non disponibili'}</span>
          </div>
        </div>

        <div class="stato-item ${hasEventi ? 'sviluppo' : 'completato'}">
          <div class="stato-icona">${hasEventi ? '‚ö†Ô∏è' : '‚úÖ'}</div>
          <div class="stato-testo">
            <strong>Eventi Pregiudizievoli</strong><br>
            <span>${hasEventi ? `${azienda.eventiPregiudizievoli.length} eventi registrati` : 'Nessun evento'}</span>
          </div>
        </div>
      </div>

      ${getAvvisoPrerequisiti(hasAnagrafica, hasCR, hasBilanci)}
    </div>
  `;
}

function getAvvisoPrerequisiti(hasAnagrafica, hasCR, hasBilanci) {
  if (hasAnagrafica && hasCR && hasBilanci) {
    return `
      <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #155724;">üéâ Tutti i dati necessari sono disponibili!</strong><br>
        <span style="color: #155724;">√à possibile generare il Rating MCC completo una volta implementate le funzionalit√†.</span>
      </div>
    `;
  } else {
    const mancanti = [];
    if (!hasAnagrafica) mancanti.push('Anagrafica');
    if (!hasCR) mancanti.push('Centrale Rischi');
    if (!hasBilanci) mancanti.push('Bilanci');

    return `
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #856404;">‚ö†Ô∏è Dati mancanti per Rating MCC completo:</strong><br>
        <span style="color: #856404;">Necessari: ${mancanti.join(', ')}</span>
      </div>
    `;
  }
}

function getSezioneConfigReportMCC(sezione) {
  const configs = {
    'genera': {
      nome: 'Genera Report MCC Completo',
      icona: 'üìÑ',
      descrizione: 'Crea un report completo con tutte le analisi, rating e valutazioni del merito creditizio',
      testoBottone: 'üìÑ Prova Generazione (Demo)',
      caratteristiche: [
        'Report PDF professionale multi-pagina',
        'Analisi completa Centrale Rischi con grafici',
        'Score andamentale e rating MCC finale', 
        'Tabelle riassuntive e dettagli per intermediario',
        'Eventi pregiudizievoli e loro impatto',
        'Executive summary e raccomandazioni',
        'Logo aziendale e branding personalizzato'
      ]
    },
    'matrice': {
      nome: 'Matrice di Integrazione',
      icona: 'üîó',
      descrizione: 'Matrice per calcolare il Rating MCC finale integrando Score Andamentale (CR) + Score Economico-Finanziario (EF)',
      testoBottone: 'üîó Visualizza Matrice (Preview)',
      caratteristiche: [
        'Matrice ufficiale MCC: Score Andamentale (CR1-CR11) vs Score EF (EF1-EF11)',
        'Calcolo automatico Rating MCC finale dall\'incrocio CR/EF',
        'Applicazione penalizzazioni Eventi Pregiudizievoli',
        'Simulazioni "what-if" per miglioramenti rating',
        'Tabelle di corrispondenza Mediocredito Centrale ufficiali',
        'Analisi sensibilit√† variazioni score componenti',
        'Confronto rating finale con benchmark settore'
      ]
    },
    'export': {
      nome: 'Export PDF Valutazione',
      icona: 'üíº',
      descrizione: 'Esporta la valutazione completa in formato PDF professionale per banche e investitori',
      testoBottone: 'üíº Avvia Export (Test)',
      caratteristiche: [
        'PDF executive-ready per presentazioni',
        'Layout professionale ottimizzato per stampa',
        'Grafici ad alta risoluzione e tabelle formattate',
        'Sezioni personalizzabili per pubblico target',
        'Watermark e protezione documento',
        'Metadati aziendali e tracking versioni',
        'Compatibilit√† con standard bancari'
      ]
    }
  };

  return configs[sezione] || {};
}

function eseguiFunzioneReport(sezione) {
  // ===== CONTROLLI PREREQUISITI =====
  if (!verificaAziendaPerEventi()) {
    showToast('‚ö†Ô∏è Nessuna azienda selezionata per generare il report', 'warning');
    return;
  }

  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda?.anagrafica) {
    showToast('‚ùå Dati anagrafica incompleti. Importa prima i dati aziendali', 'error');
    return;
  }

  // Controllo dati CR se necessario per sezione
  if (sezione === 'genera' || sezione === 'matrice') {
    if (!azienda.centraleRischi || !azienda.centraleRischi.datiImportati) {
      showToast('‚ö†Ô∏è Importa prima i dati Centrale Rischi per generare report MCC', 'warning', 4000);
      return;
    }
  }

  const messaggi = {
    'genera': `üìÑ Generazione Report MCC per ${azienda.anagrafica.denominazione} in costruzione - Funzionalit√† avanzata in arrivo!`,
    'matrice': `üîó Matrice di Integrazione per ${azienda.anagrafica.denominazione} in costruzione - Sistema di calcolo in sviluppo!`,
    'export': `üíº Export PDF Valutazione per ${azienda.anagrafica.denominazione} in costruzione - Motore di export professionale in preparazione!`
  };

  showToast(messaggi[sezione] || 'üöß Funzionalit√† in costruzione', 'warning', 5000);
}

function getCSSReportMCC() {
  return `
    <style>
      .report-btn {
        padding: 25px 20px;
        border: 2px solid var(--primary-color);
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 180px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(255, 107, 0, 0.15);
      }

      .report-btn.principale {
        min-height: 200px;
      }

      .report-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
      }

      .report-btn:hover::before {
        width: 400px;
        height: 400px;
      }

      .report-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, #ff8f40 100%);
        color: white;
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(255, 107, 0, 0.3);
      }

      .funzione-descrizione {
        font-size: 0.9em;
        margin: 12px 0;
        opacity: 0.8;
        line-height: 1.4;
        text-align: center;
      }

      .stato-badge {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.75em;
        font-weight: bold;
        margin-top: 10px;
      }

      .stato-badge.costruzione {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .stato-badge.costruzione-grande {
        padding: 10px 20px;
        font-size: 0.9em;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border: 2px solid #f39c12;
        display: inline-block;
      }

      .stato-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-left: 4px solid transparent;
      }

      .stato-item.completato {
        border-left-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      .stato-item.sviluppo {
        border-left-color: #ff9800;
        background: rgba(255, 152, 0, 0.05);
      }

      .stato-item.mancante {
        border-left-color: #f44336;
        background: rgba(244, 67, 54, 0.05);
      }

      .stato-icona {
        font-size: 1.5em;
        min-width: 30px;
      }

      .stato-testo strong {
        color: #333;
        display: block;
        margin-bottom: 2px;
      }

      .stato-testo span {
        color: #666;
        font-size: 0.9em;
      }

      .nav-report-btn {
        background: #e9ecef;
        border: 1px solid #dee2e6;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.3em;
        transition: all 0.3s ease;
        min-width: 45px;
      }

      .nav-report-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-1px);
      }

      .nav-report-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(255, 107, 0, 0.3);
      }

      @media (max-width: 768px) {
        .report-btn {
          min-height: 160px;
          padding: 20px 15px;
        }

        .report-btn.principale {
          min-height: 180px;
        }

        .funzione-descrizione {
          font-size: 0.85em;
        }

        .nav-report-btn {
          padding: 8px 10px;
          font-size: 1.1em;
        }

        .stato-item {
          padding: 12px;
        }
      }
    </style>
  `;
}

// ===== FALLBACK SEMPLICE: EXPORT ‚Üí BACKUP =====

function caricaLibreriaLocale(nome, forza = false) {
    const librerie = {
    'jspdf': {
        export: '../libs/cr/export/jspdf.min.js',
        backup: '../libs/cr/backup/jspdf.min.js',
        check: () => typeof jsPDF !== 'undefined' || typeof window.jspdf !== 'undefined',
        post: () => {
            if (typeof jsPDF === 'undefined' && window.jspdf?.jsPDF) {
                window.jsPDF = window.jspdf.jsPDF;
                console.log('üõ† jsPDF assegnato da window.jspdf.jsPDF');
            }
        }
    },
    'xlsx': {
        export: '../libs/cr/export/xlsx.full.min.js',
        backup: '../libs/cr/backup/xlsx.full.min.js',
        check: () => typeof XLSX !== 'undefined'
    },
    'html2pdf': {
        export: '../libs/cr/export/html2pdf.bundle.js',
        backup: '../libs/cr/backup/html2pdf.bundle.js',
        check: () => typeof html2pdf !== 'undefined'
    },
    'chart': {
        export: '../libs/cr/export/chart.min.js',
        backup: '../libs/cr/backup/chart.min.js',
        check: () => typeof Chart !== 'undefined'
    },
    'pdfjs': {
    export: '../libs/cr/export/pdf.js',         // ‚úÖ CORRETTO
    backup: '../libs/cr/backup/pdf.js',         // ‚úÖ CORRETTO
    check: () => typeof pdfjsLib !== 'undefined'
}
};

    const lib = librerie[nome];
    if (!lib) {
        console.warn(`‚ö†Ô∏è Libreria ${nome} non configurata`);
        return;
    }

    if (!forza && lib.check()) {
        console.log(`‚úÖ ${nome} gi√† caricata`);
        return;
    }

    // ===== PROVA PRIMA EXPORT =====
    function tentaExport() {
        const script = document.createElement('script');
        script.src = lib.export;

        script.onload = () => {
            console.log(`‚úÖ ${nome} caricato da EXPORT: ${lib.export}`);
            if (lib.post) lib.post();
        };

        script.onerror = () => {
            console.warn(`‚ùå EXPORT fallito: ${lib.export} ‚Üí provo BACKUP`);
            tentaBackup();
        };

        document.head.appendChild(script);
    }

    // ===== SE EXPORT FALLISCE, PROVA BACKUP =====
    function tentaBackup() {
        const script = document.createElement('script');
        script.src = lib.backup;

        script.onload = () => {
            console.log(`‚úÖ ${nome} caricato da BACKUP: ${lib.backup}`);
            if (lib.post) lib.post();
        };

        script.onerror = () => {
            console.warn(`‚ùå BACKUP fallito per ${nome}, provo CDN come ultima risorsa...`);
            tentaCDN();
        };

        document.head.appendChild(script);
    }


    // ===== SE ANCHE BACKUP FALLISCE, PROVA CDN =====
function tentaCDN() {
    const cdnUrls = {
        'jspdf': 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',  // ‚úÖ CORRETTO
        'xlsx': 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
        'html2pdf': 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js',
        'chart': 'https://cdn.jsdelivr.net/npm/chart.js',  // ‚úÖ AGGIUNTO
        'pdfjs': 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js'  // ‚úÖ AGGIUNTO
    };

    const cdnUrl = cdnUrls[nome];
    if (!cdnUrl) {
        console.error(`üí• CRITICO: Nessun CDN disponibile per ${nome}`);
        return;
    }

    const script = document.createElement('script');
    script.src = cdnUrl;

    script.onload = () => {
        console.log(`‚úÖ ${nome} caricato da CDN: ${cdnUrl}`);

        // Configurazione specifica per PDF.js
        if (nome === 'pdfjs' && window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }

        if (lib.post) lib.post();
    };

    script.onerror = () => {
        console.error(`üí• CRITICO: ${nome} non disponibile da EXPORT, BACKUP o CDN`);
    };

    document.head.appendChild(script);
}

    tentaExport();
}  // ‚úÖ QUESTA RIGA MANCAVA!



function generaSezioneAltreInformazioni(azienda) {
  if (!azienda.altreInformazioni) {
    return '';
  }

  const { crediti, garanzie, richieste } = azienda.altreInformazioni;

  return `
    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h4 style="color: var(--primary-color, #ff6b00); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color, #ff6b00); padding-bottom: 8px;">
        üîç ALTRE INFORMAZIONI CENTRALE RISCHI
      </h4>

      <!-- SEZIONE CREDITI -->
      ${crediti && crediti.length > 0 ? `
        <div style="margin-bottom: 30px;">
          <h5 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üí∞ CREDITI SCADUTI/AUTOLIQUIDANTI (${crediti.length} mesi)
          </h5>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            ${renderStatisticheCrediti(crediti)}
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            ${renderTabellaCrediti(crediti)}
          </div>
        </div>
      ` : ''}

      <!-- SEZIONE GARANZIE -->
      ${garanzie && garanzie.length > 0 ? `
        <div style="margin-bottom: 30px;">
          <h5 style="color: #17a2b8; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üõ°Ô∏è GARANZIE RICEVUTE (${garanzie.length} garanzie)
          </h5>
          <div style="max-height: 300px; overflow-y: auto;">
            ${renderTabellaGaranzie(garanzie)}
          </div>
        </div>
      ` : ''}

      <!-- SEZIONE RICHIESTE -->
      ${richieste && richieste.length > 0 ? `
        <div style="margin-bottom: 20px;">
          <h5 style="color: #6f42c1; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üìã RICHIESTE INFORMAZIONI (${richieste.length} richieste)
          </h5>
          <div style="max-height: 200px; overflow-y: auto;">
            ${renderTabellaRichieste(richieste)}
          </div>
        </div>
      ` : ''}

      ${(!crediti || crediti.length === 0) && (!garanzie || garanzie.length === 0) && (!richieste || richieste.length === 0) ? `
        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 8px;">
          üìã Nessuna informazione aggiuntiva disponibile per questo periodo
        </div>
      ` : ''}
    </div>
  `;
}

function renderStatisticheCrediti(crediti) {
  const totalePagati = crediti.reduce((sum, c) => sum + (c.pagati || 0), 0);
  const totaleImpagati = crediti.reduce((sum, c) => sum + (c.impagati || 0), 0);
  const totaleGenerale = totalePagati + totaleImpagati;
  const percImpagati = totaleGenerale ? ((totaleImpagati / totaleGenerale) * 100).toFixed(1) : 0;

  return `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
      <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
        <div style="font-size: 1.2em; font-weight: bold; color: #28a745;">‚Ç¨${formatIT(totalePagati)}</div>
        <div style="font-size: 0.9em; color: #666;">Crediti Pagati</div>
      </div>
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
        <div style="font-size: 1.2em; font-weight: bold; color: #856404;">‚Ç¨${formatIT(totaleImpagati)}</div>
        <div style="font-size: 0.9em; color: #666;">Crediti Impagati</div>
      </div>
      <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
        <div style="font-size: 1.2em; font-weight: bold; color: #721c24;">${percImpagati}%</div>
        <div style="font-size: 0.9em; color: #666;">Tasso Insoluti</div>
      </div>
    </div>
  `;
}

// ===== FUNZIONI MODALI MANCANTI =====
function mostraModalRischiAutoliquidanti() {
  const modal = document.getElementById('modalAutoliquidanti');
  if (!modal) return;
  modal.style.display = 'block';
  aggiornaTabellaTipoAutoliquidanti();
}

function mostraModalRischiScadenza() {
  const modal = document.getElementById('modalScadenza');
  if (!modal) return;
  modal.style.display = 'block';
  aggiornaTabellaTipoScadenza();
}

function mostraModalRatingMensili() {
  const modal = document.getElementById('modalRatingMensili');
  if (!modal) return;
  modal.style.display = 'block';
  aggiornaTabellaTipoRatingMensili();
}

function mostraModalSconfini() {
  const modal = document.getElementById('modalSconfini');
  if (!modal) return;
  modal.style.display = 'block';
  aggiornaTabellaTipoSconfini();
}

function mostraModalAltreInformazioni() {
  const modal = document.getElementById('modalAltreInformazioni');
  if (!modal) return;
  modal.style.display = 'block';
  aggiornaAltreInfoCrediti();
}

function aggiornaTabellaTipoAutoliquidanti() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  const tabella = document.getElementById('tabellaAutoliquidanti');
  if (!tabella) return;

  // Usa tutti i mesi disponibili dell'azienda (fino a 60 mesi)
  const mesiDaUsare = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDaUsare);
  let html = '';

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese || !datiMese.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        const percUtilizzo = rischio.accordatoOperativo > 0 ? 
          (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        html += `
          <tr>
            <td>${mese}</td>
            <td>${int.nome}</td>
            <td>${rischio.categoria}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.accordato || 0)}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.utilizzato || 0)}</td>
            <td class="text-right">${percUtilizzo.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  tabella.innerHTML = html || '<tr><td colspan="6" class="text-center">Nessun dato disponibile</td></tr>';
}

function aggiornaTabellaTipoScadenza() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  const tabella = document.getElementById('tabellaScadenza');
  if (!tabella) return;

  // Usa tutti i mesi disponibili dell'azienda (fino a 60 mesi)
  const mesiDaUsare = Object.keys(azienda.mesi);
  const tuttiMesi = mesiDaUsare;
  const mesiOrdinati = ordinaMesiCronologicamente(tuttiMesi);
  let html = '';

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese || !datiMese.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        const percUtilizzo = rischio.accordatoOperativo > 0 ? 
          (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        html += `
          <tr>
            <td>${mese}</td>
            <td>${int.nome}</td>
            <td>${rischio.categoria}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.accordato || 0)}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.utilizzato || 0)}</td>
            <td class="text-right">${percUtilizzo.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  tabella.innerHTML = html || '<tr><td colspan="6" class="text-center">Nessun dato disponibile</td></tr>';
}

function aggiornaTabellaTipoRatingMensili() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  const tabella = document.getElementById('tabellaRatingMensili');
  if (!tabella) return;

  // Usa tutti i mesi disponibili dell'azienda (fino a 60 mesi)
  const mesiDaUsare = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDaUsare);
  let html = '';

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    const ratingMese = calcolaRatingMeseSafe(datiMese, azienda.naturaGiuridica || 'SRL');

    html += `
      <tr>
        <td>${mese}</td>
        <td><span class="rating-badge rating-${ratingMese.classe.toLowerCase()}">${ratingMese.classe}</span></td>
        <td>${ratingMese.descrizione}</td>
        <td class="text-right">‚Ç¨${formatIT(datiMese.totaleUtilizzato || 0)}</td>
        <td class="text-right">‚Ç¨${formatIT(datiMese.totaleAccordato || 0)}</td>
      </tr>
    `;
  });

  tabella.innerHTML = html || '<tr><td colspan="5" class="text-center">Nessun dato disponibile</td></tr>';
}

function aggiornaTabellaTipoSconfini() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  const tabella = document.getElementById('tabellaSconfini');
  if (!tabella) return;

  // Usa tutti i mesi disponibili dell'azienda (fino a 60 mesi)
  const mesiDaUsare = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(mesiDaUsare);
  let html = '';

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese || !datiMese.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (rischio.utilizzato <= rischio.accordatoOperativo) return;

        const sconfino = rischio.utilizzato - rischio.accordatoOperativo;
        const percSconfino = rischio.accordatoOperativo > 0 ? 
          (sconfino / rischio.accordatoOperativo * 100) : 0;

        html += `
          <tr class="sconfino-row">
            <td>${mese}</td>
            <td>${int.nome}</td>
            <td>${rischio.categoria}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.accordatoOperativo || 0)}</td>
            <td class="text-right">‚Ç¨${formatIT(rischio.utilizzato || 0)}</td>
            <td class="text-right text-danger">‚Ç¨${formatIT(sconfino)}</td>
            <td class="text-right text-danger">${percSconfino.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  tabella.innerHTML = html || '<tr><td colspan="7" class="text-center">Nessun sconfino rilevato</td></tr>';
}

function chiudiModalPeriodo() {
  // Usa il sistema modal esistente
  chiudiModal('visualizzazioneModal');

  // Torna a "Visualizza Analisi di Periodo"
  const analisiPeriodo = document.getElementById('analisiPeriodo');
  if (analisiPeriodo) {
    analisiPeriodo.style.display = 'block';
  }
}

// Funzioni modal per ogni tipo di rischio - STILE CORRETTO
function mostraModalRischiAutoliquidanti() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  // Genera tabella HTML con i dati reali
  const tuttiMesi = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(tuttiMesi);
  
  // Calcola statistiche per analisi
  const ultimoMese = mesiOrdinati[0];
  let accordatoUltimoMese = 0;
  let utilizzatoUltimoMese = 0;
  const sconfiniCategoria = [];

  // Analisi dati per statistiche
  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese?.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (!rischio.categoria.includes('AUTOLIQUIDANTI')) return;

        if (mese === ultimoMese) {
          accordatoUltimoMese += rischio.accordatoOperativo;
          utilizzatoUltimoMese += rischio.utilizzato;
        }

        // Calcola sconfini
        if (rischio.utilizzato > rischio.accordatoOperativo) {
          sconfiniCategoria.push({
            mese: mese,
            intermediario: int.nome,
            categoria: rischio.categoria,
            eccesso: rischio.utilizzato - rischio.accordatoOperativo
          });
        }
      });
    });
  });

  let html = `
    <div style="width: 95vw; max-width: 1000px; height: 75vh; overflow-y: auto; padding: 15px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <div style="font-weight: bold; color: #4caf50; margin-bottom: 10px;">
          ULTIMO MESE (${ultimoMese || 'N/D'}): Acc. ‚Ç¨${formatIT(accordatoUltimoMese)} - Util. ‚Ç¨${formatIT(utilizzatoUltimoMese)}
        </div>
        <div style="font-weight: bold; color: #dc3545; margin-bottom: 15px;">
          SCONFINI (${mesiOrdinati.length} mesi): ${sconfiniCategoria.length} episodi
        </div>
      </div>`;

  // Elenco sconfini specifici per questa categoria
  if (sconfiniCategoria.length > 0) {
    sconfiniCategoria.forEach(sconfino => {
      const categoriaCorta = sconfino.categoria.replace('RISCHI ', '');
      html += `
    <div style="margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; text-align: center;">
      <strong>${categoriaCorta} - ${sconfino.mese}: ${sconfino.intermediario}<br>
      -SCONFINO: ‚Ç¨${formatIT(sconfino.eccesso)}</strong>
    </div>
  `;
    });
    html += `<div style="margin-bottom: 20px;"></div>`;
  }

  html += `
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
      <thead>
        <tr style="background: #f8f9fa;">
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 10%;">Mese</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 38%;">Banca</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Acc.Op.</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Utilizzo</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 12%;">%</th>
        </tr>
      </thead>
      <tbody>
  `;

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese?.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (!rischio.categoria.includes('AUTOLIQUIDANTI')) return;

        const percUtilizzo = rischio.accordatoOperativo > 0 ? 
          (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        const bancaShort = int.nome.length > 20 ? int.nome.substring(0, 20) + '...' : int.nome;
        // Formato mese compatto: "agosto 2024" -> "ago-24"
        const mesiMap = {
          'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
          'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
          'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
        };
        const meseParts = mese.split(' ');
        const meseCompatto = meseParts.length === 2 ? 
          `${mesiMap[meseParts[0]] || meseParts[0].substring(0,3)}-${meseParts[1].substring(2)}` : 
          mese.substring(0, 6);
        
        const isEccesso = rischio.utilizzato > rischio.accordatoOperativo;
        const rowStyle = isEccesso ? 'background: rgba(239, 68, 68, 0.1);' : '';

        html += `
          <tr style="border-bottom: 1px solid #eee; ${rowStyle}">
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">${meseCompatto}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: left;">${bancaShort}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.accordatoOperativo)}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.utilizzato)}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${percUtilizzo.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Rischi Autoliquidanti', html);
}

function mostraModalRischiScadenza() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  // Genera tabella HTML con i dati reali
  const tuttiMesi = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(tuttiMesi);
  
  // Calcola statistiche per analisi
  const ultimoMese = mesiOrdinati[0];
  let accordatoUltimoMese = 0;
  let utilizzatoUltimoMese = 0;
  const sconfiniCategoria = [];

  // Analisi dati per statistiche
  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese?.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (!rischio.categoria.includes('SCADENZA')) return;

        if (mese === ultimoMese) {
          accordatoUltimoMese += rischio.accordatoOperativo;
          utilizzatoUltimoMese += rischio.utilizzato;
        }

        // Calcola sconfini
        if (rischio.utilizzato > rischio.accordatoOperativo) {
          sconfiniCategoria.push({
            mese: mese,
            intermediario: int.nome,
            categoria: rischio.categoria,
            eccesso: rischio.utilizzato - rischio.accordatoOperativo
          });
        }
      });
    });
  });

  let html = `
    <div style="width: 95vw; max-width: 1000px; height: 75vh; overflow-y: auto; padding: 15px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <div style="font-weight: bold; color: #2196f3; margin-bottom: 10px;">
          ULTIMO MESE (${ultimoMese || 'N/D'}): Acc. ‚Ç¨${formatIT(accordatoUltimoMese)} - Util. ‚Ç¨${formatIT(utilizzatoUltimoMese)}
        </div>
        <div style="font-weight: bold; color: #dc3545; margin-bottom: 15px;">
          SCONFINI (${mesiOrdinati.length} mesi): ${sconfiniCategoria.length} episodi
        </div>
      </div>`;

  // Elenco sconfini specifici per questa categoria
  if (sconfiniCategoria.length > 0) {
    sconfiniCategoria.forEach(sconfino => {
      const categoriaCorta = sconfino.categoria.replace('RISCHI A ', '');
      html += `
    <div style="margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; text-align: center;">
      <strong>${categoriaCorta} - ${sconfino.mese}: ${sconfino.intermediario}<br>
      -SCONFINO: ‚Ç¨${formatIT(sconfino.eccesso)}</strong>
    </div>
  `;
    });
    html += `<div style="margin-bottom: 20px;"></div>`;
  }

  html += `
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
      <thead>
        <tr style="background: #f8f9fa;">
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 10%;">Mese</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 38%;">Banca</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Acc.Op.</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 18%;">Utilizzo</th>
          <th style="padding: 8px 4px; border: 1px solid #ddd; text-align: center; width: 12%;">%</th>
        </tr>
      </thead>
      <tbody>
  `;

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese?.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (!rischio.categoria.includes('SCADENZA')) return;

        const percUtilizzo = rischio.accordatoOperativo > 0 ? 
          (rischio.utilizzato / rischio.accordatoOperativo * 100) : 0;

        const bancaShort = int.nome.length > 20 ? int.nome.substring(0, 20) + '...' : int.nome;
        // Formato mese compatto: "agosto 2024" -> "ago-24"
        const mesiMap = {
          'gennaio': 'gen', 'febbraio': 'feb', 'marzo': 'mar', 'aprile': 'apr',
          'maggio': 'mag', 'giugno': 'giu', 'luglio': 'lug', 'agosto': 'ago',
          'settembre': 'set', 'ottobre': 'ott', 'novembre': 'nov', 'dicembre': 'dic'
        };
        const meseParts = mese.split(' ');
        const meseCompatto = meseParts.length === 2 ? 
          `${mesiMap[meseParts[0]] || meseParts[0].substring(0,3)}-${meseParts[1].substring(2)}` : 
          mese.substring(0, 6);
        
        const isEccesso = rischio.utilizzato > rischio.accordatoOperativo;
        const rowStyle = isEccesso ? 'background: rgba(239, 68, 68, 0.1);' : '';

        html += `
          <tr style="border-bottom: 1px solid #eee; ${rowStyle}">
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">${meseCompatto}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: left;">${bancaShort}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.accordatoOperativo)}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: right;">‚Ç¨${formatIT(rischio.utilizzato)}</td>
            <td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${percUtilizzo.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Rischi A Scadenza', html);
}

function mostraModalRatingMensili() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  // Genera tabella HTML con i dati reali - stesso formato della griglia centrale
  const tuttiMesi = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(tuttiMesi);
  let html = `
    <div style="width: 95vw; max-width: 1400px; height: 75vh; overflow-y: auto; padding: 15px;">
      <h3 style="color: #ff9800; margin-bottom: 20px; text-align: center;">üìà RATING MENSILI - Dettaglio Completo</h3>
      <table class="tabella-cr" style="width: 100%; border-collapse: collapse; font-size: 11px;">
        <thead>
          <tr>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">Mese</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">C1* %</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">DC1</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">DC3</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">C2</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">Score</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">Classe</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; font-weight: bold;">Descrizione</th>
          </tr>
        </thead>
        <tbody>
  `;

  const coeff = coefficientiMCC[azienda.naturaGiuridica || 'SRL'];
  
  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese) return;

    // Calcola rating con stesso metodo della griglia centrale
    let accAutoliqRevoca = 0, utilizzatoAutoliqRevoca = 0;
    let accScadenza = 0, utilizzatoScadenza = 0;
    
    datiMese.intermediari.forEach(int => {
      if (int && int.rischi) {
        int.rischi.forEach(rischio => {
          if (rischio.categoria?.includes('REVOCA') || rischio.categoria?.includes('AUTOLIQUIDANTI')) {
            accAutoliqRevoca += rischio.accordatoOperativo || 0;
            utilizzatoAutoliqRevoca += rischio.utilizzato || 0;
          } else if (rischio.categoria?.includes('SCADENZA')) {
            accScadenza += rischio.accordatoOperativo || 0;
            utilizzatoScadenza += rischio.utilizzato || 0;
          }
        });
      }
    });

    const c1 = accAutoliqRevoca > 0 ? (utilizzatoAutoliqRevoca / accAutoliqRevoca) : 0;
    const dc1 = 0;
    const dc3 = accScadenza > 0 && (utilizzatoScadenza / accScadenza) > 1 ? 1 : 0;
    const c2 = c1 > 1 ? 1 : 0;
    
    const correzione = Math.log((coeff.FATTORE_CORR_1 / (1 - coeff.FATTORE_CORR_1)) * ((1 - coeff.FATTORE_CORR_2) / coeff.FATTORE_CORR_2));
    const score = (c1 * coeff.C1_COEFF) + (dc1 * coeff.DC1_COEFF) + (dc3 * coeff.DC3_COEFF) + (c2 * coeff.C2_COEFF) + coeff.COSTANTE + correzione;
    
    const classe = classiMCC.find(cl => score > cl.min && score <= cl.max) || { classe: "UNRATED", descr: "Non classificabile", emoji: "?" };
    
    const isUltimoMese = mese === mesiOrdinati[mesiOrdinati.length - 1];
    const classeRiga = isUltimoMese 
      ? 'style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); font-weight: bold;"'
      : '';

    html += `
      <tr ${classeRiga}>
        <td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">${mese}${isUltimoMese ? ' ‚≠ê' : ''}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${(c1 * 100).toFixed(2)}%</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${dc1}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${dc3}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${c2}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${score.toFixed(3)}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ff9800; color: white; padding: 3px 6px; border-radius: 3px; font-weight: bold; font-size: 10px;">${classe.classe}</span></td>
        <td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">${classe.descr} ${classe.emoji}</td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
      
      <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
        <h4 style="color: #28a745; margin-bottom: 10px;">
          Coefficienti utilizzati (${azienda.naturaGiuridica || 'SRL'}):
        </h4>
        <p>C1*: ${coeff.C1_COEFF} | DC1: ${coeff.DC1_COEFF} | DC3: ${coeff.DC3_COEFF} | C2: ${coeff.C2_COEFF}</p>
        <p>Costante: ${coeff.COSTANTE} | Fatt1: ${coeff.FATTORE_CORR_1} | Fatt2: ${coeff.FATTORE_CORR_2}</p>
        <p style="margin-top: 10px; color: #ff9800;"><strong>‚≠ê = Ultimo mese (evidenziato)</strong></p>
      </div>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Rating Mensili', html);
}

function mostraModalSconfini() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  // Genera tabella HTML con i dati reali
  const tuttiMesi = Object.keys(azienda.mesi);
  const mesiOrdinati = ordinaMesiCronologicamente(tuttiMesi);
  let html = `
    <div style="width: 95vw; max-width: 1200px; height: 75vh; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center;">
      <h3 style="color: #f44336; margin-bottom: 20px; text-align: center;">üö® SCONFINI - Dettaglio Completo</h3>
      <table class="data-table" style="width: 70%; max-width: 800px; border-collapse: collapse; font-size: 11px; margin: 0 auto;">
        <thead>
          <tr>
            <th style="padding: 8px; border: 1px solid #ddd; background: #f2f2f2; width: 20%;">Mese</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: #f2f2f2; width: 40%;">Intermediario</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: #f2f2f2; width: 25%;">Sconfino</th>
            <th style="padding: 8px; border: 1px solid #ddd; background: #f2f2f2; width: 15%;">%</th>
          </tr>
        </thead>
        <tbody>
  `;

  let sconfiniTrovati = 0;

  mesiOrdinati.forEach(mese => {
    const datiMese = azienda.mesi[mese];
    if (!datiMese?.intermediari) return;

    datiMese.intermediari.forEach(int => {
      if (!int.rischi) return;

      int.rischi.forEach(rischio => {
        if (rischio.utilizzato <= rischio.accordatoOperativo) return;

        const sconfino = rischio.utilizzato - rischio.accordatoOperativo;
        const percSconfino = rischio.accordatoOperativo > 0 ? 
          (sconfino / rischio.accordatoOperativo * 100) : 0;

        sconfiniTrovati++;

        html += `
          <tr style="background: rgba(244, 67, 54, 0.1);">
            <td style="padding: 8px; border: 1px solid #ddd; font-size: 11px; text-align: center;">${mese}</td>
            <td style="padding: 8px; border: 1px solid #ddd; font-size: 11px;">${int.nome}</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f44336; font-weight: bold; font-size: 11px;">‚Ç¨${formatIT(sconfino)}</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f44336; font-weight: bold; font-size: 11px;">${percSconfino.toFixed(1)}%</td>
          </tr>
        `;
      });
    });
  });

  if (sconfiniTrovati === 0) {
    html += `
      <tr>
        <td colspan="4" style="padding: 20px; text-align: center; color: #666;">Nessun sconfino rilevato nel periodo</td>
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Sconfini', html);
}

function mostraModalAltreInformazioni() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda) return;

  // Usa tutti i dati disponibili
  const creditiDaMostrare = azienda.altreInformazioni?.crediti || [];

  // Conta elementi disponibili per mostrare nei pulsanti
  const creditiCount = creditiDaMostrare.length;
  const garanzieCount = azienda.altreInformazioni?.garanzie?.length || 0;
  const richiesteCount = azienda.altreInformazioni?.richieste?.length || 0;

  let html = `
    <div style="width: 95vw; max-width: 800px; height: 75vh; overflow-y: auto; padding: 20px; margin: 0 auto;">
      <h3 style="color: #9c27b0; margin-bottom: 30px; text-align: center;">üîç ALTRE INFORMAZIONI - Menu Principale</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        
        <button onclick="mostraModalCreditiPagatiImpagati()" style="
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white; border: none; padding: 25px; border-radius: 12px;
          cursor: pointer; font-size: 16px; font-weight: bold;
          transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
          text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
          <div style="font-size: 2.5em; margin-bottom: 10px;">üí∞</div>
          <div>CREDITI PAGATI/IMPAGATI</div>
          <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${creditiCount} mesi disponibili</div>
        </button>

        <button onclick="mostraModalGraficiCrediti()" style="
          background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
          color: white; border: none; padding: 25px; border-radius: 12px;
          cursor: pointer; font-size: 16px; font-weight: bold;
          transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
          text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
          <div style="font-size: 2.5em; margin-bottom: 10px;">üìä</div>
          <div>GRAFICI CREDITI</div>
          <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Visualizzazione grafica</div>
        </button>

        <button onclick="mostraModalGaranzie()" style="
          background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
          color: white; border: none; padding: 25px; border-radius: 12px;
          cursor: pointer; font-size: 16px; font-weight: bold;
          transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
          text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
          <div style="font-size: 2.5em; margin-bottom: 10px;">üõ°Ô∏è</div>
          <div>GARANZIE RICEVUTE</div>
          <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${garanzieCount} garanzie</div>
        </button>

        <button onclick="mostraModalRichiesteInformazioni()" style="
          background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
          color: white; border: none; padding: 25px; border-radius: 12px;
          cursor: pointer; font-size: 16px; font-weight: bold;
          transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
          text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
          <div style="font-size: 2.5em; margin-bottom: 10px;">üìã</div>
          <div>RICHIESTE INFORMAZIONI</div>
          <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${richiesteCount} richieste</div>
        </button>

      </div>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Altre Informazioni', html);
}

function salvaPeriodo(mesiPeriodo) {
  // Mantiene per compatibilit√† - usato solo per i grafici
  window.mesiPeriodoCorrente = mesiPeriodo;
}

// Nuove funzioni per le modal singole
function mostraModalCreditiPagatiImpagati() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.altreInformazioni?.crediti) {
    mostraModal('visualizzazioneModal', 'Crediti Pagati/Impagati', '<div style="padding: 20px; text-align: center;">Nessun dato crediti disponibile</div>');
    return;
  }

  const html = `
    <div style="width: 95vw; max-width: 1200px; height: 75vh; overflow-y: auto; padding: 15px;">
      <h3 style="color: #28a745; margin-bottom: 20px; text-align: center;">üí∞ CREDITI PAGATI/IMPAGATI - Dettaglio Completo</h3>
      ${renderTabellaCrediti(azienda.altreInformazioni.crediti)}
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Crediti Pagati/Impagati', html);
}

function mostraModalGraficiCrediti() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.altreInformazioni?.crediti) {
    mostraModal('visualizzazioneModal', 'Grafici Crediti', '<div style="padding: 20px; text-align: center;">Nessun dato crediti disponibile</div>');
    return;
  }

  // Usa tutti i dati disponibili
  const creditiDaMostrare = azienda.altreInformazioni.crediti;
  const titoloModaleCon = 'üìä GRAFICI CREDITI - Analisi Visiva';

  const html = `
    <div style="width: 90vw; max-width: 1000px; height: 85vh; overflow-y: auto; padding: 15px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;">
      <h3 style="color: #17a2b8; margin-bottom: 20px; text-align: center;">${titoloModaleCon}</h3>
      <div id="graficiCrediti" style="width: 100%; background: white; border-radius: 4px; display: flex; flex-direction: column; align-items: center;"></div>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Grafici Crediti', html);

  // Carica i grafici dopo un breve ritardo
  setTimeout(() => {
    if (document.getElementById('graficiCrediti')) {
      window._creditiAnalisi = creditiDaMostrare;
      renderGraficiCrediti(creditiDaMostrare, 'graficiCrediti');
    }
  }, 100);
}

function mostraModalGaranzie() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.altreInformazioni?.garanzie || azienda.altreInformazioni.garanzie.length === 0) {
    mostraModal('visualizzazioneModal', 'Garanzie Ricevute', '<div style="padding: 20px; text-align: center;">Nessuna garanzia disponibile</div>');
    return;
  }

  const html = `
    <div style="width: 95vw; max-width: 1200px; height: 75vh; overflow-y: auto; padding: 15px;">
      <h3 style="color: #6f42c1; margin-bottom: 20px; text-align: center;">üõ°Ô∏è GARANZIE RICEVUTE - Dettaglio Completo</h3>
      <div style="max-height: 80vh; overflow-y: auto;">
        ${renderTabellaGaranzie(azienda.altreInformazioni.garanzie)}
      </div>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Garanzie Ricevute', html);
}

function mostraModalRichiesteInformazioni() {
  const azienda = archivioAziende[aziendaCorrente];
  if (!azienda || !azienda.altreInformazioni?.richieste || azienda.altreInformazioni.richieste.length === 0) {
    mostraModal('visualizzazioneModal', 'Richieste Informazioni', '<div style="padding: 20px; text-align: center;">Nessuna richiesta disponibile</div>');
    return;
  }

  const html = `
    <div style="width: 95vw; max-width: 1200px; height: 75vh; overflow-y: auto; padding: 15px;">
      <h3 style="color: #fd7e14; margin-bottom: 20px; text-align: center;">üìã RICHIESTE INFORMAZIONI - Dettaglio Completo</h3>
      <div style="max-height: 80vh; overflow-y: auto;">
        ${renderTabellaRichieste(azienda.altreInformazioni.richieste)}
      </div>
    </div>
  `;

  mostraModal('visualizzazioneModal', 'Richieste Informazioni', html);
}

console.log('‚úÖ Funzioni modali mancanti aggiunte al file originale');

console.log('‚úÖ Funzioni modal corrette implementate usando sistema esistente');

// ==========================================
// OVERLAY BREAKDOWN LATERALE
// ==========================================

// Funzione per formattare i numeri in italiano
function formatIT(num) {
  return Number(num).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Funzione per mostrare l'overlay breakdown per i crediti
window.mostraBreakdownCrediti = function(mese, btn) {
  const overlay = document.getElementById("breakdownOverlay");
  const dati = (window._creditiRawBreakdown && window._creditiRawBreakdown[mese]) ? window._creditiRawBreakdown[mese] : [];
  
  console.log("üîç [DEBUG] Overlay breakdown per mese:", mese);
  console.log("üîç [DEBUG] Dati trovati:", dati);
  console.log("üîç [DEBUG] window._creditiRawBreakdown:", window._creditiRawBreakdown);
  
  let t = `<button class="close-btn" onclick="document.getElementById('breakdownOverlay').style.display='none'">&times;</button>`;
  t += `<h3>Dettaglio <span style="font-size:1.1em;">&#128269;</span> su <b>${mese}</b>:</h3>
    <table>
    <thead>
      <tr><th>Pagati</th><th>Impagati</th><th>Totale</th><th>%</th></tr>
    </thead>
    <tbody>`;
  
  let totalPagati = 0, totalImpagati = 0;
  
  if (dati.length === 0) {
    t += `<tr><td colspan="4" style="text-align:center; color:#999;">Nessun dato di breakdown disponibile</td></tr>`;
  } else {
    dati.forEach(r => {
      const pagati = r.pagati || 0;
      const impagati = r.impagati || 0;
      const tot = pagati + impagati;
      const perc = tot ? (impagati / tot) * 100 : 0;
      
      totalPagati += pagati;
      totalImpagati += impagati;
      
      t += `<tr>
        <td>‚Ç¨${formatIT(pagati)}</td>
        <td>‚Ç¨${formatIT(impagati)}</td>
        <td>‚Ç¨${formatIT(tot)}</td>
        <td>${perc.toFixed(2)}%</td>
      </tr>`;
    });
  }
  
  const tot = totalPagati + totalImpagati;
  const percTot = tot ? (totalImpagati / tot) * 100 : 0;
  
  t += `</tbody><tfoot>
    <tr>
      <td>‚Ç¨${formatIT(totalPagati)}</td>
      <td>‚Ç¨${formatIT(totalImpagati)}</td>
      <td>‚Ç¨${formatIT(tot)}</td>
      <td>${percTot.toFixed(2)}%</td>
    </tr>
  </tfoot></table>`;
  
  overlay.innerHTML = t;
  overlay.style.display = "block";
};

  </script>
<div id="breakdownOverlay" style="
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.8); z-index: 10000; display: none;
  align-items: center; justify-content: center; padding: 20px;">
  <!-- Contenuto dinamico -->
</div>

<style>
.close-btn {
  position: absolute; top: 10px; right: 15px;
  background: #ff4757; color: white; border: none;
  border-radius: 50%; width: 30px; height: 30px;
  cursor: pointer; font-size: 18px;
}
.icon-btn {
  background: #007bff; color: white; border: none;
  padding: 5px 8px; border-radius: 4px; cursor: pointer;
}
</style>

</body>
</html>
