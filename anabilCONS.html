<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ceoDOC ¬∑ Import Bilanci (anabilCONS)</title>
<link rel="stylesheet" href="../libs/cr/backup/tailwind.min.css">
<script src="../libs/cr/backup/xlsx.full.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #f8f9fa;
    color: #1e40af;
}

.container {
    max-width: 100%;
    margin: 0 auto;
    padding: 10px;
}

.workflow {
    background: white;
    border-radius: 10px;
    padding: 10px 20px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.main-title {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    font-size: 28px;
    font-weight: bold;
    color: #f97316;
}

.title-icon {
    width: 32px;
    height: 32px;
    fill: #f97316;
}

.workflow-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
}

.step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: #e0e0e0;
    z-index: -1;
}

.step.active:not(:last-child)::after {
    background: #1e40af;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    color: white;
}

.step.active .step-circle {
    background: #1e40af;
}

.step.completed .step-circle {
    background: #f97316;
}

.step-title {
    font-size: 14px;
    color: #1e40af;
}

.step.active .step-title {
    color: #1e40af;
    font-weight: 600;
}

.tabs {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e0e0e0;
}

.tab {
    padding: 15px 30px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: #1e40af;
    position: relative;
    transition: all 0.3s ease;
}

.tab:hover {
    color: #1e3a8a;
}

.tab.active {
    color: #1e40af;
    font-weight: 600;
}

.tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 3px;
    background: #1e40af;
}

.tab:disabled {
    color: #9ca3af;
    cursor: not-allowed;
}

.content-area {
    display: none;
}

.content-area.active {
    display: block;
}

.compact-section {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 5px;
}

.field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.field-label {
    font-size: 12px;
    color: #1e40af;
    font-weight: 600;
    text-transform: uppercase;
}

.field-input {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    color: #1e40af;
}

.field-input:focus {
    outline: none;
    border-color: #1e40af;
}

.controls-compact {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-top: 5px !important;
}

.control-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 12px;
    border-bottom: 1px solid #f0f0f0;
}

.control-item:last-child {
    border-bottom: none;
}

.control-label {
    color: #1e40af;
}

.badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-ok {
    background: #d4edda !important;
    color: #155724 !important;
    padding: 4px 12px !important;
    border-radius: 4px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    font-size: 11px !important;
}

.badge-ko {
    background: #fef2f2 !important;
    color: #dc2626 !important;
    padding: 4px 12px !important;
    border-radius: 4px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    font-size: 11px !important;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #1e40af;
    color: white;
}

.btn-primary:hover {
    background: #1e3a8a;
}

.btn-orange {
    background: #f97316;
    color: white;
}

.btn-orange:hover {
    background: #ea580c;
}

.btn-outline {
    background: white;
    color: #1e40af;
    border: 1px solid #1e40af;
}

.btn-grey {
    background: #e5e7eb;
    color: #1e40af;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

/* Bilancio Tables */
.bilancio-container {
    display: grid;
    grid-template-columns: 1fr 3px 1fr;
    gap: 10px;
    margin-top: 15px;
}

.bilancio-divider {
    background: #e0e0e0;
    border-radius: 2px;
}

.table-section {
    background: white;
    border-radius: 8px;
    padding: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    background: #003d82;
    color: white;
    padding: 10px 15px;
    font-weight: 600;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #f8f9fa;
    padding: 4px 6px;
    text-align: center;
    font-weight: 600;
    color: #1e40af;
    border-bottom: 2px solid #e0e0e0;
    border-right: 1px solid #e0e0e0;
    font-size: 9px;
}

.data-table th:last-child {
    border-right: none;
}

.data-table td {
    padding: 3px 6px;
    border-bottom: 1px solid #f0f0f0;
    border-right: 1px solid #e0e0e0;
    font-size: 10px;
    color: #1e40af;
}

.data-table td:last-child {
    border-right: none;
}

.data-table tr:nth-child(even) {
    background: #f8f9fa;
}

.data-table tr:hover {
    background: #eff6ff;
}

.action-row {
    display: flex;
    gap: 8px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.toast {
    position: fixed;
    right: 20px;
    bottom: 20px;
    z-index: 9999;
    background: #1e40af;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 14px;
    opacity: 0;
    transform: translateY(100px);
    transition: all 0.3s ease;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast.error {
    background: #dc2626;
}

.icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
}

.hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .bilancio-container {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
@media print {
  #cardAnalisiCompleta {
    position: static !important;
    overflow: visible !important;
  }

    .bilancio-divider {
        display: none;
    }
    
    .workflow-steps {
        display: none;
    }
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.header-azienda {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 20px 30px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #f97316;
}

.page-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: #1e40af;
}

.page-title svg {
    flex-shrink: 0;
}

.page-sub {
    margin-top: 8px;
    margin-left: 40px;
    font-size: 14px;
    color: #6b7280;
    font-style: italic;
}

#denomTop {
    color: #1e40af;
    font-weight: 700;
}

#cfTop {
    color: #f97316;
    font-weight: 600;
}

.dscr-card:hover {
  transform: translateY(-3px);
  transition: all 0.25s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* MODALE 3 - SCORING ceoDOC (fix reflow + layout coerente) */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

.tabBtnceoDOC {
  flex: 1;
  padding: 12px;
  background: #f4f4f4;
  border: none;
  cursor: pointer;
  font-weight: bold;
  color: #003d82;
  border-bottom: 3px solid #003d82;
  transition: all 0.25s ease;
  font-size: 13px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
  box-sizing: border-box;
}

.tabBtnceoDOC.active {
  border-bottom-color: #003d82;
  background: rgba(255,107,0,0.1);
  color: #ff6b00;
}

.tabContentceoDOC {
  display: none;
  padding: 20px;
  animation: fadeInceoDOC 0.3s ease-in-out;
}

.tabContentceoDOC.active {
  display: block;
}

@keyframes fadeInceoDOC {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.cardScoringceoDOC {
  background: white;
  border-left: 4px solid #0b65d4;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.tableScoringceoDOC {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

.tableScoringceoDOC th {
  background: #f5f5f5;
  padding: 12px;
  text-align: left;
  font-weight: bold;
  color: #0b65d4;
  border-bottom: 2px solid #0b65d4;
}

.tableScoringceoDOC td {
  padding: 10px 12px;
  border-bottom: 1px solid #e0e0e0;
}

.tableScoringceoDOC tr:hover {
  background: rgba(11, 101, 212, 0.02);
}
</style>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="dot-green" viewBox="0 0 10 10"><circle cx="5" cy="5" r="5" fill="#16a34a"/></symbol>
  <symbol id="dot-yellow" viewBox="0 0 10 10"><circle cx="5" cy="5" r="5" fill="#facc15"/></symbol>
  <symbol id="dot-red" viewBox="0 0 10 10"><circle cx="5" cy="5" r="5" fill="#dc2626"/></symbol>
</svg>

    <div class="container">
        <div class="workflow">

            <!-- Header con info azienda -->
<div class="header-azienda">
    <h1 class="page-title">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="#f97316">
            <path d="M3,3V21H21V19H5V3H3M9,17H7V10H9V17M13,17H11V7H13V17M17,17H15V13H17V17M21,17H19V4H21V17Z"/>
        </svg>
 <span id="denomTop">‚Äî</span>
<span style="color:#6b7280">&nbsp;‚Äì&nbsp;</span>
<span style="color:#f97316; font-size: 14px;">Codice Fiscale:&nbsp;</span>
<span id="cfTop">‚Äî</span>
    </h1>
    <div class="page-sub">Valutazione delle performance e gestione dei rischi</div>
   <!-- Pulsante Istruzioni in alto a destra -->
    <button class="btn btn-grey" onclick="mostraIstruzioni()" style="
        position: absolute;
        top: 15px;
        right: 30px;
        padding: 8px 16px;
        font-size: 13px;
    ">
        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
            <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
        </svg>
        Istruzioni
    </button>
</div>

<!-- Workflow Steps con 5 fasi -->
            <div class="workflow-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-title">Importa Dati</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-title">Visualizza Bilanci</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-title">Predisponi dati per Analisi</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-title">Rating e Report</div>
                </div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-title">Visualizza e Salva Analisi</div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tabs" id="mainTabs">
                <button class="tab active" onclick="showTab('import')">Importa Dati</button>
                <button class="tab" onclick="showTab('bilanci')" id="bilanciTab" disabled>Visualizza Bilanci</button>
                <button class="tab" onclick="showTab('predisponi')" id="predisponiTab" disabled>Predisponi dati per Analisi</button>
                <button class="tab" onclick="showTab('rating')" id="ratingTab" disabled>Rating e Report</button>
                <button class="tab" onclick="showTab('analisi')" id="analisiTab" disabled>Visualizza e Salva Analisi</button>
            </div>
            
            <!-- IMPORT TAB -->

<div class="content-area active" id="importContent">
    <!-- Riga Pulsanti Principali -->
    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <button id="btnImportXLS" class="btn btn-primary" style="flex: 1;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M13 8V2H7v6H2l8 8 8-8h-5z" fill="white"/></svg>
            Importa XLS
        </button>
        <button id="btnImportXBRL" class="btn btn-primary" style="flex: 1;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M13 8V2H7v6H2l8 8 8-8h-5z" fill="white"/></svg>
            Importa XBRL
        </button>
        <button id="btnCaricaBilancioSalvato" class="btn btn-success" style="flex: 1;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M12,19L8,15H10.5V12H13.5V15H16L12,19Z" fill="white"/></svg>
            Carica Consuntivi Salvati
        </button>
    </div>
    
<!-- Riga Settore e Info -->
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 56px 56px; gap: 10px; margin-bottom: 20px; align-items: center;">
    
    <!-- Settore -->
    <div style="background: #e8f4f8; padding: 12px 20px; border-radius: 8px;">
        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">SETTORE DI ATTIVIT√Ä</span>
        <div id="settoreDisplay" style="margin-top: 5px; font-weight: 600; color: #1e40af; font-size: 16px;">
            Settore: Agricoltura
        </div>
    </div>
    
    <!-- Codice ATECO -->
    <div style="background: #fef3c7; padding: 12px 20px; border-radius: 8px;">
        <span style="font-size: 11px; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px;">CODICE ATECO</span>
        <div id="atecoDisplay" style="margin-top: 5px; font-weight: 600; color: #92400e; font-size: 14px;">
            <span id="valoreAteco">‚Äî</span>
        </div>
    </div>
   
    <!-- Tipo Bilancio -->
    <div style="background: #e8f4f8; padding: 12px 20px; border-radius: 8px;">
        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">TIPO BILANCIO</span>
        <div id="tipoBilDisplay" style="margin-top: 5px; font-weight: 600; color: #1e40af; font-size: 14px;">
            ‚Äî
        </div>
    </div>
    
    <!-- Anni Consuntivi -->
    <div style="background: #e8f4f8; padding: 12px 20px; border-radius: 8px;">
        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">ANNI CONSUNTIVI</span>
        <div id="eserciziDisplay" style="margin-top: 5px; font-weight: 600; color: #1e40af; font-size: 14px;">
            ‚Äî
        </div>
    </div>
    
    <!-- Salva Bilancio -->
    <button id="btnSalvaBilancio" class="btn btn-orange" style="height: 56px; width: 56px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Salva Bilancio">
        <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24">
            <path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3M19 19H5V5H16.17L19 7.83V19M12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12M6 6H15V10H6V6Z" fill="white"/>
        </svg>
    </button>
    
    <!-- Azzera -->
    <button id="btnAzzera" class="btn" style="height: 56px; width: 56px; padding: 0; display: flex; align-items: center; justify-content: center; background: #dc2626; color: white;" title="Azzera Tutto">
        <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24">
            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" fill="white"/>
        </svg>
    </button>
</div>
    
<!-- Due Card Check di Controllo Affiancate -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Check Anno Precedente -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px;">
            <h4 style="color: #1e40af; margin-bottom: 15px; font-size: 14px; font-weight: 600;">
                Check di Controllo - <span id="check-anno-prev">Anno Precedente</span>
            </h4>
            <div id="checks-prev">
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                    <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
            </div>
        </div>
        
        <!-- Check Ultimo Anno -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px;">
            <h4 style="color: #1e40af; margin-bottom: 15px; font-size: 14px; font-weight: 600;">
                Check di Controllo - <span id="check-anno-last">Ultimo Anno</span>
            </h4>
            <div id="checks">
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
                <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                    <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                    <span class="badge badge-ko">IN ATTESA</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Campi nascosti per compatibilit√† -->
    <div style="display: none;">
        <div id="denom">‚Äî</div>
        <div id="cf">‚Äî</div>
        <div id="tipoBil">‚Äî</div>
        <div id="esercizi">‚Äî</div>
    </div>
</div>
            
<!-- BILANCI TAB - Solo consuntivi originali -->
<div class="content-area" id="bilanciContent">
    <!-- Pulsanti gestione bilanci -->
    <div class="action-row" style="margin-bottom: 20px;">
    <button class="btn btn-success" id="btnListaBilanci">
    <svg class="icon" viewBox="0 0 24 24">
        <path d="M9 4V8H14V4H20V20H4V4H9M12 2C11.5 2 11 2.5 11 3V9H13V3C13 2.5 12.5 2 12 2M8 11V13H16V11H8M8 15V17H16V15H8Z" fill="white"/>
    </svg>
    Lista Consuntivi Salvati
</button>
    </div>
    
    <!-- Tabelle Bilancio affiancate -->
    <div class="bilancio-container" style="display: grid; grid-template-columns: 1fr 3px 1fr; gap: 10px;">
        <!-- Stato Patrimoniale -->
        <div class="table-section">
            <div class="table-header">
                <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z" fill="white"/>
                </svg>
                Stato Patrimoniale <span id="sp-kind"></span>
            </div>
            <table class="data-table" id="tblSP">
                <thead>
                    <tr>
                        <th style="width: 50%;">Voci</th>
                        <th style="width: 25%; text-align: right;">Es. Prec.<br><span id="sp-head-prev" style="font-size: 10px;"></span></th>
                        <th style="width: 25%; text-align: right;">Ultimo Es.<br><span id="sp-head-last" style="font-size: 10px;"></span></th>
                                                                        <th id="sp-head-delta" style="width: 12%; text-align: center;">Œî%</th>
                    </tr>
                </thead>
                <tbody id="sp-body"></tbody>
            </table>
        </div>
        
        <!-- Divider verticale -->
        <div class="bilancio-divider" style="background: #e0e0e0;"></div>
        
        <!-- Conto Economico -->
        <div class="table-section">
            <div class="table-header">
                <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path d="M3,3V21H21V19H5V3H3M9,17H7V10H9V17M13,17H11V7H13V17M17,17H15V13H17V17M21,17H19V4H21V17Z" fill="white"/>
                </svg>
                Conto Economico <span id="ce-kind"></span>
            </div>
            <table class="data-table" id="tblCE">
                <thead>
                    <tr>
                        <th style="width: 50%;">Voci</th>
                        <th style="width: 25%; text-align: right;">Es. Prec.<br><span id="ce-head-prev" style="font-size: 10px;"></span></th>
                        <th style="width: 25%; text-align: right;">Ultimo Es.<br><span id="ce-head-last" style="font-size: 10px;"></span></th>
                                                                       <th id="ce-head-delta" style="width: 12%; text-align: center;">Œî%</th>
                    </tr>
                </thead>
                <tbody id="ce-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- PREDISPONI DATI TAB -->
<div class="content-area" id="predisponiContent">
  <!-- Prima riga di pulsanti -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px;">
    <button class="btn btn-primary" onclick="mostraBilanciStandardizzati()">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z"/>
      </svg>
      Bilanci Standardizzati
    </button>

    <button class="btn btn-primary" onclick="mostraCompilaTables()">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M3,3H21V5H3V3M3,7H21V9H3V7M3,11H21V13H3V11M3,15H21V17H3V15M3,19H21V21H3V19Z"/>
      </svg>
      Compila Tabelle
    </button>

    <button class="btn btn-primary" onclick="mostraRendiconto()">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M3 3h18v2H3V3m0 4h18v2H3V7m0 4h12v2H3v-2m0 4h8v2H3v-2z"/>
      </svg>
      Elabora Rendiconto
    </button>

    <button class="btn btn-primary" onclick="mostraBilanciRiclassificati()">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20Z"/>
      </svg>
      Bilanci Riclassificati
    </button>
  </div>

  <!-- Seconda riga di pulsanti -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;">
<button class="btn btn-orange" onclick="mostraBreakEven()">
  <svg class="icon" viewBox="0 0 24 24">
    <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
  </svg>
  Analisi Break-Even
</button>


<!-- === NUOVA RIGA FASE 3 ‚Äì ANALISI GESTIONALE (STILE ORIGINALE) === -->

<button class="btn btn-orange" onclick="calcolaIndici()" 
        style="color:#fff; fill:#fff;">
  <svg class="icon" viewBox="0 0 24 24" width="20" height="20" style="vertical-align:middle; margin-right:6px;">
    <path fill="white" d="M7,2H17A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M7,4V8H17V4H7M7,10V12H9V10H7M11,10V12H13V10H11M15,10V12H17V10H15M7,14V16H9V14H7M11,14V16H13V14H11M15,14V16H17V14H15Z"/>
  </svg>
  <span style="vertical-align:middle;">Calcola Indici di Bilancio</span>
</button>

<button class="btn btn-orange" onclick="mostraDashboardKPI()" 
        style="color:#fff; fill:#fff;">
  <svg class="icon" viewBox="0 0 24 24" width="20" height="20" style="vertical-align:middle; margin-right:6px;">
    <path fill="white" d="M3 13H11V21H3V13M13 3H21V11H13V3M13 13H21V21H13V13M3 3H11V11H3V3Z"/>
  </svg>
  <span style="vertical-align:middle;">Dashboard KPI</span>
</button>

<button class="btn btn-orange" onclick="mostraGraficiKPI()" 
        style="color:#fff; fill:#fff;">
  <svg class="icon" viewBox="0 0 24 24" width="20" height="20" style="vertical-align:middle; margin-right:6px;">
    <path fill="white" d="M3 17H5V11H3V17M7 17H9V7H7V17M11 17H13V13H11V17M15 17H17V9H15V17M19 17H21V5H19V17Z"/>
  </svg>
  <span style="vertical-align:middle;">Grafici KPI</span>
</button>

<!-- === FINE NUOVA RIGA FASE 3 === -->

  </div>

  <!-- Campi date nascosti per compatibilit√† sistema -->
  <div style="display:none;">
    <input type="date" id="dtInfra" value="">
    <input type="date" id="dtNorm" value="">
    <input type="date" id="dtPrev1" value="">
    <input type="date" id="dtPrev2" value="">
  </div>
</div>
            
<!-- RATING TAB -->
<div class="content-area" id="ratingContent">
    <div class="action-row" style="justify-content: center;">
        <button class="btn btn-primary" id="btnScoreEF">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
            </svg>
            Score Economico Finanziario
        </button>
        <button class="btn btn-primary" id="btnScoreAnd">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z"/>
            </svg>
            Score Andamentale
        </button>
        <button class="btn btn-primary" id="btnRatingMCC">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
            </svg>
            Rating MCC Integrato
        </button>
        <button class="btn btn-primary" id="btnScoreAziendale" onclick="openScoreAziendaleceoDOC()">
            <svg class="icon" viewBox="0 0 24 24">
<path d="M12,17.27L18.18,21L16.54,14.81L22,10.24L15.81,10L12,4L8.19,10L2,10.24L7.46,14.81L5.82,21L12,17.27Z"/>            </svg>
            Score Aziendale ceoDOC
        </button>
    </div>
</div>
                    
                </div>
                
                <div class="compact-section">
                    <h4 style="color: #1e40af;">Rating e Report</h4>
                    <p style="color: #1e40af;">Funzionalit√† in sviluppo</p>
                </div>
            </div>
            
<!-- ‚úÖ FASE 5 ‚Äì VISUALIZZA E SALVA ANALISI -->
<div class="content-area" id="analisiContent">
  <div class="compact-section" style="text-align:center;">
    <h4 style="color:#1e40af;margin-bottom:20px;">Analisi Finale e Report Gestione</h4>
    
    <div class="action-row" style="display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">

<!-- üîπ Salva tutte le elaborazioni -->
<button class="btn btn-orange" 
        onclick="salvaElaborazioniComplete()" 
        style="display:flex;align-items:center;gap:6px;">
  üíæ Salva tutte le elaborazioni
</button>

      
      <!-- üîπ Genera Analisi -->
      <button class="btn btn-primary" id="btnGeneraAnalisi" style="display:flex;align-items:center;gap:6px;">
        <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
          <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
        </svg>
        <span>Genera Analisi Completa</span>
      </button>

      <!-- üîπ Lista Analisi Salvate (stesso blu del primario) -->
      <button class="btn btn-primary" id="btnListaAnalisi" style="display:flex;align-items:center;gap:6px;">
        <svg class="icon" viewBox="0 0 24 24" width="20" height="20">
          <path d="M3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5M7,8H17V10H7V8M7,12H17V14H7V12M7,16H14V18H7V16Z" />
        </svg>
        <span>Lista Analisi Salvate</span>
      </button>
      
    </div>

    <p style="margin-top:18px;color:#6b7280;font-size:13px;">
      ‚öôÔ∏è L‚Äôanalisi completa integra tutti i dati di bilancio, gli indici e gli score MCC.<br>
      I pulsanti <b>Salva Analisi</b> ed <b>Esporta PDF</b> saranno disponibili all‚Äôinterno del report generato.
    </p>
  </div>
</div>

<!-- === CARD ANALISI COMPLETA === -->
<div id="cardAnalisiCompleta"
     style="display:none;
            position:relative;
            background:#f8fafc;
            margin-top:15px;
            border-radius:12px;
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
            overflow-y:auto;
            max-height:85vh;
            z-index:50;">
</div>


    <!-- Toast -->
    <div id="toast" class="toast">
        <span id="toast-msg"></span>
    </div>
<script>
"use strict";

// =====================================================
// üß© Controllo accesso + Stato globale sicuro (fix completo 2025)
// =====================================================

// 1Ô∏è‚É£ Se non sei dentro un iframe ‚Üí blocca tutto
if (!window.parent || window.parent === window) {
  document.body.innerHTML = `
    <div style="padding:50px;text-align:center;font-family:Segoe UI,Arial,sans-serif;">
      <h1 style="color:#b91c1c;">‚õî Accesso negato</h1>
      <p>Questo modulo pu√≤ essere eseguito solo tramite <b>ceoDOC.html</b>.</p>
    </div>`;
  throw new Error("Modulo richiede ceoDOC.html");
}

// üîπ Dichiara subito la variabile, cos√¨ √® visibile a tutti i blocchi seguenti
let statoGlobale = null;

// 2Ô∏è‚É£ Recupero avanzato dei dati da localStorage (tabelle, meta bilancio ecc.)
try {
  const meta = JSON.parse(localStorage.getItem("ceodoc_meta_bilancio") || "{}");
  const tabelle = JSON.parse(
    localStorage.getItem(
      "ceodoc_tabelle_" +
        (meta.cf || "") +
        "_" +
        (meta.anni?.prev || "") +
        "_" +
        (meta.anni?.last || "")
    ) || "{}"
  );

  if (tabelle && Object.keys(tabelle).length > 0) {
    statoGlobale = Object.assign({}, statoGlobale || {}, { tabelle });
    console.log("‚úÖ Stato bilanci recuperato da ceodoc_tabelle:", tabelle);
  }
} catch (err) {
  console.warn("‚ö†Ô∏è Nessun bilancio trovato in localStorage ceoDOC:", err);
}

// 3Ô∏è‚É£ Tentativo di ereditare lo stato dal parent o dal localStorage ceoDOC
try {
  if (window.parent && window.parent.state) {
    statoGlobale = window.parent.state;
    console.log("‚úÖ Stato globale ereditato da ceoDOC:", statoGlobale);
  } else {
    throw new Error("Parent state non accessibile");
  }
} catch (err) {
  // ‚öôÔ∏è Cross-origin o parent non disponibile
  if (err.message.includes("cross-origin") || err.toString().includes("SecurityError")) {
    console.info("‚ÑπÔ∏è parent.state non accessibile (modalit√† locale)");
  } else {
    console.warn("‚ö†Ô∏è Accesso parent.state negato:", err);
  }

  // üíæ fallback da sessione ceoDOC
  try {
    const stored = JSON.parse(localStorage.getItem("ceodoc_session") || "{}");
    if (stored && stored.state) {
      statoGlobale = stored.state;
      console.log("‚úÖ Stato globale recuperato da localStorage ceoDOC:", statoGlobale);
    } else {
      throw new Error("LocalStorage vuoto");
    }
  } catch (e2) {
    console.warn("‚ö†Ô∏è Nessuna sessione trovata, provo meta/anagrafica‚Ä¶");
    const ana = JSON.parse(localStorage.getItem("ceodoc_anagrafica_attiva") || "{}");
    const meta = JSON.parse(localStorage.getItem("ceodoc_meta_bilancio") || "{}");
    statoGlobale = {
      cf: ana?.cf || "‚Äî",
      denom: ana?.ragioneSociale || "Impresa",
      settore: ana?.settore || "‚Äî",
      anni: meta?.anni || { prev: "N-1", last: "N" },
      spRows: [],
      ceRows: [],
      tabelle: statoGlobale?.tabelle || {}
    };
    console.warn("‚ö†Ô∏è Stato recuperato parzialmente da meta/anagrafica locale.");
  }
}

// 4Ô∏è‚É£ Se non ereditato, inizializza localmente (fallback)
if (!statoGlobale) {
  statoGlobale = {
    wb: null,
    tipo: "",
    sheets: {},
    anni: { last: null, prev: null },
    headers: {},
    denom: "‚Äî",
    cf: "‚Äî",
    settore: "",
    codiceAteco: "",
    spRows: [],
    ceRows: [],
    tabelle: {}
  };
  console.warn("‚ö†Ô∏è Stato globale inizializzato localmente (non ereditato da ceoDOC).");
}

// 5Ô∏è‚É£ Consolidamento dati chiave (CF e Anni)
if (!statoGlobale.cf || statoGlobale.cf === "‚Äî") {
  try {
    const anagrafica = JSON.parse(localStorage.getItem("ceodoc_anagrafica_attiva") || "{}");
    if (anagrafica?.cf) statoGlobale.cf = anagrafica.cf;
  } catch {
    console.warn("‚ö†Ô∏è Nessuna anagrafica trovata in localStorage");
  }
}

if (!statoGlobale.anni || !statoGlobale.anni.prev || !statoGlobale.anni.last) {
  try {
    const meta = JSON.parse(localStorage.getItem("ceodoc_meta_bilancio") || "{}");
    if (meta?.anni) statoGlobale.anni = meta.anni;
  } catch {
    console.warn("‚ö†Ô∏è Nessuna informazione anni trovata in localStorage");
  }
}

// 6Ô∏è‚É£ Esporta su window.state in modo definitivo
window.state = statoGlobale;
console.log("‚úÖ Stato globale consolidato:", window.state);

// =====================================================
// üîÑ Sincronizzazione automatica delle tabelle salvate
// =====================================================
try {
  const cf = window.state?.cf || "NA";
  const anni = window.state?.anni || {};
  const keyTabelle = `ceodoc_tabelle_${cf}_${anni.prev || ""}_${anni.last || ""}`;
  const savedTabelle = localStorage.getItem(keyTabelle);

  if (savedTabelle) {
    const dati = JSON.parse(savedTabelle);
    if (dati && Object.keys(dati).length > 0) {
      window.state.tabelle = dati;
      console.log(`üìä Tabelle caricate automaticamente da ${keyTabelle}:`, dati);
    } else {
      console.warn(`‚ö†Ô∏è Tabella ${keyTabelle} vuota o corrotta`);
    }
  } else {
    console.info(`‚ÑπÔ∏è Nessuna tabella trovata per ${keyTabelle}`);
  }
} catch (err) {
  console.error("‚ùå Errore durante il caricamento automatico delle tabelle:", err);
}



// =======================================
// TASSONOMIA_MAPPING - MAPPING COMPLETO XBRL
// =======================================

const TASSONOMIA_MAPPING = {
  'Ordinario': {
    'SP': {
      // A) CREDITI VERSO SOCI
      'T0001.D01.1.001.002.002.002.000.000.000': {
        voce: 'Parte richiamata',
        sezione: 'crediti_soci',
        xbrl: 'CreditiVersoSociVersamentiAncoraDovutiParteRichiamata'
      },
      'T0001.D01.1.001.002.002.003.000.000.000': {
        voce: 'Parte da richiamare',
        sezione: 'crediti_soci',
        xbrl: 'CreditiVersoSociVersamentiAncoraDovutiParteRichiamare'
      },
      'T0001.D01.1.001.002.002.004.000.000.000': {
        voce: 'Totale crediti verso soci per versamenti ancora dovuti (A)',
        sezione: 'crediti_soci',
        xbrl: 'TotaleCreditiVersoSociVersamentiAncoraDovuti'
      },

      // B) IMMOBILIZZAZIONI - I IMMATERIALI
      'T0001.D01.1.001.002.003.002.002.000.000': {
        voce: '1) costi di impianto e di ampliamento',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiCostiImpiantoAmpliamento'
      },
      'T0001.D01.1.001.002.003.002.003.000.000': {
        voce: '2) costi di sviluppo',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiCostiSviluppo'
      },
      'T0001.D01.1.001.002.003.002.004.000.000': {
        voce: '3) diritti di brevetto industriale e diritti di utilizzazione delle opere dell\'ingegno',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiDirittiBrevettoIndustrialeDirittiUtilizzazioneOpereIngegno'
      },
      'T0001.D01.1.001.002.003.002.005.000.000': {
        voce: '4) concessioni, licenze, marchi e diritti simili',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiConcessioniLicenzeMarchiDirittiSimili'
      },
      'T0001.D01.1.001.002.003.002.006.000.000': {
        voce: '5) avviamento',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiAvviamento'
      },
      'T0001.D01.1.001.002.003.002.007.000.000': {
        voce: '6) immobilizzazioni in corso e acconti',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiImmobilizzazioniCorsoAcconti'
      },
      'T0001.D01.1.001.002.003.002.008.000.000': {
        voce: '7) altre',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'ImmobilizzazioniImmaterialiAltre'
      },
      'T0001.D01.1.001.002.003.002.009.000.000': {
        voce: 'Totale immobilizzazioni immateriali',
        sezione: 'immobilizzazioni_immateriali',
        xbrl: 'TotaleImmobilizzazioniImmateriali'
      },

      // B) IMMOBILIZZAZIONI - II MATERIALI
      'T0001.D01.1.001.002.003.003.002.000.000': {
        voce: '1) terreni e fabbricati',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'ImmobilizzazioniMaterialiTerreniFabbricati'
      },
      'T0001.D01.1.001.002.003.003.003.000.000': {
        voce: '2) impianti e macchinario',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'ImmobilizzazioniMaterialiImpiantiMacchinario'
      },
      'T0001.D01.1.001.002.003.003.004.000.000': {
        voce: '3) attrezzature industriali e commerciali',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'ImmobilizzazioniMaterialiAttrezzatureIndustrialiCommerciali'
      },
      'T0001.D01.1.001.002.003.003.005.000.000': {
        voce: '4) altri beni',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'ImmobilizzazioniMaterialiAltriBeni'
      },
      'T0001.D01.1.001.002.003.003.006.000.000': {
        voce: '5) immobilizzazioni in corso e acconti',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'ImmobilizzazioniMaterialiImmobilizzazioniCorsoAcconti'
      },
      'T0001.D01.1.001.002.003.003.007.000.000': {
        voce: 'Totale immobilizzazioni materiali',
        sezione: 'immobilizzazioni_materiali',
        xbrl: 'TotaleImmobilizzazioniMateriali'
      },

      // B) IMMOBILIZZAZIONI - III FINANZIARIE - PARTECIPAZIONI
      'T0001.D01.1.001.002.003.004.002.002.000': {
        voce: 'a) imprese controllate',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniImpreseControllate'
      },
      'T0001.D01.1.001.002.003.004.002.003.000': {
        voce: 'b) imprese collegate',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniImpreseCollegate'
      },
      'T0001.D01.1.001.002.003.004.002.004.000': {
        voce: 'c) imprese controllanti',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniImpreseControllanti'
      },
      'T0001.D01.1.001.002.003.004.002.005.000': {
        voce: 'd) imprese sottoposte al controllo delle controllanti',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniImpreseSottoposteControlloControllanti'
      },
      'T0001.D01.1.001.002.003.004.002.006.000': {
        voce: 'd-bis) altre imprese',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniAltreImprese'
      },
      'T0001.D01.1.001.002.003.004.002.007.000': {
        voce: 'Totale partecipazioni',
        sezione: 'immobilizzazioni_finanziarie_partecipazioni',
        xbrl: 'ImmobilizzazioniFinanziariePartecipazioniTotalePartecipazioni'
      },

      // B) IMMOBILIZZAZIONI - III FINANZIARIE - CREDITI
      'T0001.D01.1.001.002.003.004.003.002.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseControllateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.002.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseControllateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.002.004': {
        voce: 'Totale crediti verso imprese controllate',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseControllateTotaleCreditiVersoImpreseControllate'
      },
      'T0001.D01.1.001.002.003.004.003.003.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_collegate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseCollegateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.003.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_collegate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseCollegateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.003.004': {
        voce: 'Totale crediti verso imprese collegate',
        sezione: 'immobilizzazioni_finanziarie_crediti_collegate',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseCollegateTotaleCreditiVersoImpreseCollegate'
      },
      'T0001.D01.1.001.002.003.004.003.004.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllanti',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.004.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllanti',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.004.004': {
        voce: 'Totale crediti verso controllanti',
        sezione: 'immobilizzazioni_finanziarie_crediti_controllanti',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoControllantiTotaleCreditiVersoControllanti'
      },
      'T0001.D01.1.001.002.003.004.003.005.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_sottoposte',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseSottoposteControlloControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.005.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_sottoposte',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseSottoposteControlloControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.005.004': {
        voce: 'Totale crediti verso imprese sottoposte al controllo delle controllanti',
        sezione: 'immobilizzazioni_finanziarie_crediti_sottoposte',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoImpreseSottoposteControlloControllantiTotaleCreditiVersoImpreseSottoposteControlloControllanti'
      },
      'T0001.D01.1.001.002.003.004.003.006.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_altri',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoAltriEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.006.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'immobilizzazioni_finanziarie_crediti_altri',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoAltriEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.003.004.003.006.004': {
        voce: 'Totale crediti verso altri',
        sezione: 'immobilizzazioni_finanziarie_crediti_altri',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiVersoAltriTotaleCreditiVersoAltri'
      },
      'T0001.D01.1.001.002.003.004.003.007.000': {
        voce: 'Totale crediti',
        sezione: 'immobilizzazioni_finanziarie_crediti',
        xbrl: 'ImmobilizzazioniFinanziarieCreditiTotaleCrediti'
      },
      'T0001.D01.1.001.002.003.004.004.000.000': {
        voce: '3) altri titoli',
        sezione: 'immobilizzazioni_finanziarie',
        xbrl: 'ImmobilizzazioniFinanziarieAltriTitoli'
      },
      'T0001.D01.1.001.002.003.004.005.000.000': {
        voce: '4) strumenti finanziari derivati attivi',
        sezione: 'immobilizzazioni_finanziarie',
        xbrl: 'ImmobilizzazioniFinanziarieStrumentiFinanziariDerivatiAttivi'
      },
      'T0001.D01.1.001.002.003.004.006.000.000': {
        voce: 'Totale immobilizzazioni finanziarie',
        sezione: 'immobilizzazioni_finanziarie',
        xbrl: 'TotaleImmobilizzazioniFinanziarie'
      },
      'T0001.D01.1.001.002.003.005.000.000.000': {
        voce: 'Totale immobilizzazioni (B)',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioni'
      },

      // C) ATTIVO CIRCOLANTE - I RIMANENZE
      'T0001.D01.1.001.002.004.002.002.000.000': {
        voce: '1) materie prime, sussidiarie e di consumo',
        sezione: 'rimanenze',
        xbrl: 'RimanenzeMateriePrimeSussidiarieConsumo'
      },
      'T0001.D01.1.001.002.004.002.003.000.000': {
        voce: '2) prodotti in corso di lavorazione e semilavorati',
        sezione: 'rimanenze',
        xbrl: 'RimanenzeProdottiCorsoLavorazioneSemilavorati'
      },
      'T0001.D01.1.001.002.004.002.004.000.000': {
        voce: '3) lavori in corso su ordinazione',
        sezione: 'rimanenze',
        xbrl: 'RimanenzeLavoriCorsoOrdinazione'
      },
      'T0001.D01.1.001.002.004.002.005.000.000': {
        voce: '4) prodotti finiti e merci',
        sezione: 'rimanenze',
        xbrl: 'RimanenzeProdottiFinitiMerci'
      },
      'T0001.D01.1.001.002.004.002.006.000.000': {
        voce: '5) acconti',
        sezione: 'rimanenze',
        xbrl: 'RimanenzeAcconti'
      },
      'T0001.D01.1.001.002.004.002.007.000.000': {
        voce: 'Totale rimanenze',
        sezione: 'rimanenze',
        xbrl: 'TotaleRimanenze'
      },
      'T0001.D01.1.001.002.004.003.000.000.000': {
        voce: 'Immobilizzazioni materiali destinate alla vendita',
        sezione: 'attivo_circolante',
        xbrl: 'ImmobilizzazioniMaterialiDestinateAllaVendita'
      },

      // C) ATTIVO CIRCOLANTE - II CREDITI
      'T0001.D01.1.001.002.004.004.002.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_clienti',
        xbrl: 'CreditiVersoClientiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.002.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_clienti',
        xbrl: 'CreditiVersoClientiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.002.004.000': {
        voce: 'Totale crediti verso clienti',
        sezione: 'crediti_clienti',
        xbrl: 'CreditiVersoClientiTotaleCreditiVersoClienti'
      },
      'T0001.D01.1.001.002.004.004.003.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_controllate',
        xbrl: 'CreditiVersoImpreseControllateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.003.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_controllate',
        xbrl: 'CreditiVersoImpreseControllateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.003.004.000': {
        voce: 'Totale crediti verso imprese controllate',
        sezione: 'crediti_controllate',
        xbrl: 'CreditiVersoImpreseControllateTotaleCreditiVersoImpreseControllate'
      },
      'T0001.D01.1.001.002.004.004.004.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_collegate',
        xbrl: 'CreditiVersoImpreseCollegateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.004.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_collegate',
        xbrl: 'CreditiVersoImpreseCollegateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.004.004.000': {
        voce: 'Totale crediti verso imprese collegate',
        sezione: 'crediti_collegate',
        xbrl: 'CreditiVersoImpreseCollegateTotaleCreditiVersoImpreseCollegate'
      },
      'T0001.D01.1.001.002.004.004.005.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_controllanti',
        xbrl: 'CreditiVersoControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.005.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_controllanti',
        xbrl: 'CreditiVersoControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.005.004.000': {
        voce: 'Totale crediti verso controllanti',
        sezione: 'crediti_controllanti',
        xbrl: 'CreditiVersoControllantiTotaleCreditiVersoControllanti'
      },
      'T0001.D01.1.001.002.004.004.006.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_sottoposte',
        xbrl: 'CreditiVersoImpreseSottoposteControlloControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.006.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_sottoposte',
        xbrl: 'CreditiVersoImpreseSottoposteControlloControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.006.004.000': {
        voce: 'Totale crediti verso imprese sottoposte al controllo delle controllanti',
        sezione: 'crediti_sottoposte',
        xbrl: 'CreditiVersoImpreseSottoposteControlloControllantiTotaleCreditiVersoImpreseSottoposteControlloControllanti'
      },
      'T0001.D01.1.001.002.004.004.007.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_tributari',
        xbrl: 'CreditiCreditiTributariEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.007.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_tributari',
        xbrl: 'CreditiCreditiTributariEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.007.004.000': {
        voce: 'Totale crediti tributari',
        sezione: 'crediti_tributari',
        xbrl: 'CreditiCreditiTributariTotaleCreditiTributari'
      },
      'T0001.D01.1.001.002.004.004.008.000.000': {
        voce: '5-ter) imposte anticipate',
        sezione: 'crediti',
        xbrl: 'CreditiImposteAnticipateTotaleImposteAnticipate'
      },
      'T0001.D01.1.001.002.004.004.009.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti_altri',
        xbrl: 'CreditiVersoAltriEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.009.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti_altri',
        xbrl: 'CreditiVersoAltriEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.002.004.004.009.004.000': {
        voce: 'Totale crediti verso altri',
        sezione: 'crediti_altri',
        xbrl: 'CreditiVersoAltriTotaleCreditiVersoAltri'
      },
      'T0001.D01.1.001.002.004.004.010.000.000': {
        voce: 'Totale crediti',
        sezione: 'crediti',
        xbrl: 'TotaleCrediti'
      },

      // C) ATTIVO CIRCOLANTE - III ATTIVITA' FINANZIARIE
      'T0001.D01.1.001.002.004.005.002.000.000': {
        voce: '1) partecipazioni in imprese controllate',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniPartecipazioniImpreseControllate'
      },
      'T0001.D01.1.001.002.004.005.003.000.000': {
        voce: '2) partecipazioni in imprese collegate',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniPartecipazioniImpreseCollegate'
      },
      'T0001.D01.1.001.002.004.005.004.000.000': {
        voce: '3) partecipazioni in imprese controllanti',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniPartecipazioniImpreseControllanti'
      },
      'T0001.D01.1.001.002.004.005.005.000.000': {
        voce: '3-bis) partecipazioni in imprese sottoposte al controllo delle controllanti',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniPartecipazioniImpreseSottoposteControlloControllanti'
      },
      'T0001.D01.1.001.002.004.005.006.000.000': {
        voce: '4) altre partecipazioni',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniAltrePartecipazioni'
      },
      'T0001.D01.1.001.002.004.005.007.000.000': {
        voce: '5) strumenti finanziari derivati attivi',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniStrumentiFinanziariDerivatiAttivi'
      },
      'T0001.D01.1.001.002.004.005.008.000.000': {
        voce: '6) altri titoli',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniAltriTitoli'
      },
      'T0001.D01.1.001.002.004.005.009.000.000': {
        voce: 'attivit√† finanziarie per la gestione accentrata della tesoreria',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'AttivitaFinanziarieNonCostituisconoImmobilizzazioniAttivitaFinanziarieLaGestioneAccentrataTesoreria'
      },
      'T0001.D01.1.001.002.004.005.010.000.000': {
        voce: 'Totale attivit√† finanziarie che non costituiscono immobilizzazioni',
        sezione: 'attivita_finanziarie_non_immob',
        xbrl: 'TotaleAttivitaFinanziarieNonCostituisconoImmobilizzazioni'
      },

      // C) ATTIVO CIRCOLANTE - IV DISPONIBILITA' LIQUIDE
      'T0001.D01.1.001.002.004.006.002.000.000': {
        voce: '1) depositi bancari e postali',
        sezione: 'disponibilita_liquide',
        xbrl: 'DisponibilitaLiquideDepositiBancariPostali'
      },
      'T0001.D01.1.001.002.004.006.003.000.000': {
        voce: '2) assegni',
        sezione: 'disponibilita_liquide',
        xbrl: 'DisponibilitaLiquideAssegni'
      },
      'T0001.D01.1.001.002.004.006.004.000.000': {
        voce: '3) danaro e valori in cassa',
        sezione: 'disponibilita_liquide',
        xbrl: 'DisponibilitaLiquideDanaroValoriCassa'
      },
      'T0001.D01.1.001.002.004.006.005.000.000': {
        voce: 'Totale disponibilit√† liquide',
        sezione: 'disponibilita_liquide',
        xbrl: 'TotaleDisponibilitaLiquide'
      },
      'T0001.D01.1.001.002.004.007.000.000.000': {
        voce: 'Totale attivo circolante (C)',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleAttivoCircolante'
      },

      // D) RATEI E RISCONTI
      'T0001.D01.1.001.002.005.000.000.000.000': {
        voce: 'D) Ratei e risconti',
        sezione: 'ratei_risconti_attivi',
        xbrl: 'AttivoRateiRisconti'
      },
      'T0001.D01.1.001.002.006.000.000.000.000': {
        voce: 'Totale attivo',
        sezione: 'totale_attivo',
        xbrl: 'TotaleAttivo'
      },

      // PASSIVO - A) PATRIMONIO NETTO
      'T0001.D01.1.001.003.002.002.000.000.000': {
        voce: 'I - Capitale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoCapitale'
      },
      'T0001.D01.1.001.003.002.003.000.000.000': {
        voce: 'II - Riserva da soprapprezzo delle azioni',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaSoprapprezzoAzioni'
      },
      'T0001.D01.1.001.003.002.004.000.000.000': {
        voce: 'III - Riserve di rivalutazione',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveRivalutazione'
      },
      'T0001.D01.1.001.003.002.005.000.000.000': {
        voce: 'IV - Riserva legale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaLegale'
      },
      'T0001.D01.1.001.003.002.006.000.000.000': {
        voce: 'V - Riserve statutarie',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveStatutarie'
      },
      'T0001.D01.1.001.003.002.007.002.000.000': {
        voce: 'Riserva straordinaria',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaStraordinaria'
      },
      'T0001.D01.1.001.003.002.007.003.000.000': {
        voce: 'Riserva da deroghe ex articolo 2423 codice civile',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaDerogheExArticolo2423CodiceCivile'
      },
      'T0001.D01.1.001.003.002.007.004.000.000': {
        voce: 'Riserva azioni (quote) della societ√† controllante',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaAzioniQuoteSocietaControllante'
      },
      'T0001.D01.1.001.003.002.007.005.000.000': {
        voce: 'Riserva da rivalutazione delle partecipazioni',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaRivalutazionePartecipazioni'
      },
      'T0001.D01.1.001.003.002.007.006.000.000': {
        voce: 'Versamenti in conto aumento di capitale',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateVersamentiContoAumentoCapitale'
      },
      'T0001.D01.1.001.003.002.007.007.000.000': {
        voce: 'Versamenti in conto futuro aumento di capitale',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateVersamentiContoFuturoAumentoCapitale'
      },
      'T0001.D01.1.001.003.002.007.008.000.000': {
        voce: 'Versamenti in conto capitale',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateVersamentiContoCapitale'
      },
      'T0001.D01.1.001.003.002.007.009.000.000': {
        voce: 'Versamenti a copertura perdite',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateVersamentiCoperturaPerdite'
      },
      'T0001.D01.1.001.003.002.007.010.000.000': {
        voce: 'Riserva da riduzione capitale sociale',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaRiduzioneCapitaleSociale'
      },
      'T0001.D01.1.001.003.002.007.011.000.000': {
        voce: 'Riserva avanzo di fusione',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaAvanzoFusione'
      },
      'T0001.D01.1.001.003.002.007.012.000.000': {
        voce: 'Riserva per utili su cambi non realizzati',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaUtiliCambiNonRealizzati'
      },
      'T0001.D01.1.001.003.002.007.013.000.000': {
        voce: 'Riserva da conguaglio utili in corso',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateRiservaConguaglioUtiliCorso'
      },
      'T0001.D01.1.001.003.002.007.014.000.000': {
        voce: 'Varie altre riserve',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateVarieAltreRiserve'
      },
      'T0001.D01.1.001.003.002.007.015.000.000': {
        voce: 'Totale altre riserve',
        sezione: 'altre_riserve',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateTotaleAltreRiserve'
      },
      'T0001.D01.1.001.003.002.008.000.000.000': {
        voce: 'VII - Riserva per operazioni di copertura dei flussi finanziari attesi',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaOperazioniCoperturaFlussiFinanziariAttesi'
      },
      'T0001.D01.1.001.003.002.009.000.000.000': {
        voce: 'VIII - Utili (perdite) portati a nuovo',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtiliPerditePortatiNuovo'
      },
      'T0001.D01.1.001.003.002.010.000.000.000': {
        voce: 'IX - Utile (perdita) dell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtilePerditaEsercizio'
      },
      'T0001.D01.1.001.003.002.011.000.000.000': {
        voce: 'Perdita ripianata nell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoPerditaRipianataEsercizio'
      },
      'T0001.D01.1.001.003.002.012.000.000.000': {
        voce: 'X - Riserva negativa per azioni proprie in portafoglio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaNegativaAzioniPropriePortafoglio'
      },
      'T0001.D01.1.001.003.002.013.000.000.000': {
        voce: 'Totale patrimonio netto',
        sezione: 'patrimonio_netto',
        xbrl: 'TotalePatrimonioNetto'
      },

      // B) FONDI PER RISCHI E ONERI
      'T0001.D01.1.001.003.003.002.000.000.000': {
        voce: '1) per trattamento di quiescenza e obblighi simili',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'FondiRischiOneriTrattamentoQuiescenzaObblighiSimili'
      },
      'T0001.D01.1.001.003.003.003.000.000.000': {
        voce: '2) per imposte, anche differite',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'FondiRischiOneriImposteAncheDifferite'
      },
      'T0001.D01.1.001.003.003.004.000.000.000': {
        voce: '3) strumenti finanziari derivati passivi',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'FondiRischiOneriStrumentiFinanziariDerivatiPassivi'
      },
      'T0001.D01.1.001.003.003.005.000.000.000': {
        voce: '4) altri',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'FondiRischiOneriAltri'
      },
      'T0001.D01.1.001.003.003.006.000.000.000': {
        voce: 'Totale fondi per rischi ed oneri',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'TotaleFondiRischiOneri'
      },

      // C) TFR
      'T0001.D01.1.001.003.004.000.000.000.000': {
        voce: 'C) Trattamento di fine rapporto di lavoro subordinato',
        sezione: 'tfr',
        xbrl: 'TrattamentoFineRapportoLavoroSubordinato'
      },

      // D) DEBITI
      'T0001.D01.1.001.003.005.002.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_obbligazioni',
        xbrl: 'DebitiObbligazioniEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.002.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_obbligazioni',
        xbrl: 'DebitiObbligazioniEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.002.004.000.000': {
        voce: 'Totale obbligazioni',
        sezione: 'debiti_obbligazioni',
        xbrl: 'DebitiObbligazioniTotaleObbligazioni'
      },
      'T0001.D01.1.001.003.005.003.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_obbligazioni_convertibili',
        xbrl: 'DebitiObbligazioniConvertibiliEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.003.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_obbligazioni_convertibili',
        xbrl: 'DebitiObbligazioniConvertibiliEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.003.004.000.000': {
        voce: 'Totale obbligazioni convertibili',
        sezione: 'debiti_obbligazioni_convertibili',
        xbrl: 'DebitiObbligazioniConvertibiliTotaleObbligazioniConvertibili'
      },
      'T0001.D01.1.001.003.005.004.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_soci',
        xbrl: 'DebitiDebitiVersoSociFinanziamentiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.004.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_soci',
        xbrl: 'DebitiDebitiVersoSociFinanziamentiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.004.004.000.000': {
        voce: 'Totale debiti verso soci per finanziamenti',
        sezione: 'debiti_soci',
        xbrl: 'DebitiDebitiVersoSociFinanziamentiTotaleDebitiVersoSociFinanziamenti'
      },
      'T0001.D01.1.001.003.005.005.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_banche',
        xbrl: 'DebitiDebitiVersoBancheEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.005.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_banche',
        xbrl: 'DebitiDebitiVersoBancheEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.005.004.000.000': {
        voce: 'Totale debiti verso banche',
        sezione: 'debiti_banche',
        xbrl: 'DebitiDebitiVersoBancheTotaleDebitiVersoBanche'
      },
      'T0001.D01.1.001.003.005.006.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_altri_finanziatori',
        xbrl: 'DebitiDebitiVersoAltriFinanziatoriEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.006.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_altri_finanziatori',
        xbrl: 'DebitiDebitiVersoAltriFinanziatoriEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.006.004.000.000': {
        voce: 'Totale debiti verso altri finanziatori',
        sezione: 'debiti_altri_finanziatori',
        xbrl: 'DebitiDebitiVersoAltriFinanziatoriTotaleDebitiVersoAltriFinanziatori'
      },
      'T0001.D01.1.001.003.005.007.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_acconti',
        xbrl: 'DebitiAccontiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.007.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_acconti',
        xbrl: 'DebitiAccontiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.007.004.000.000': {
        voce: 'Totale acconti',
        sezione: 'debiti_acconti',
        xbrl: 'DebitiAccontiTotaleAcconti'
      },
      'T0001.D01.1.001.003.005.008.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_fornitori',
        xbrl: 'DebitiDebitiVersoFornitoriEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.008.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_fornitori',
        xbrl: 'DebitiDebitiVersoFornitoriEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.008.004.000.000': {
        voce: 'Totale debiti verso fornitori',
        sezione: 'debiti_fornitori',
        xbrl: 'DebitiDebitiVersoFornitoriTotaleDebitiVersoFornitori'
      },
      'T0001.D01.1.001.003.005.009.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_titoli_credito',
        xbrl: 'DebitiDebitiRappresentatiTitoliCreditoEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.009.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_titoli_credito',
        xbrl: 'DebitiDebitiRappresentatiTitoliCreditoEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.009.004.000.000': {
        voce: 'Totale debiti rappresentati da titoli di credito',
        sezione: 'debiti_titoli_credito',
        xbrl: 'DebitiDebitiRappresentatiTitoliCreditoTotaleDebitiRappresentatiTitoliCredito'
      },
      'T0001.D01.1.001.003.005.010.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_controllate',
        xbrl: 'DebitiDebitiVersoImpreseControllateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.010.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_controllate',
        xbrl: 'DebitiDebitiVersoImpreseControllateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.010.004.000.000': {
        voce: 'Totale debiti verso imprese controllate',
        sezione: 'debiti_controllate',
        xbrl: 'DebitiDebitiVersoImpreseControllateTotaleDebitiVersoImpreseControllate'
      },
      'T0001.D01.1.001.003.005.011.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_collegate',
        xbrl: 'DebitiDebitiVersoImpreseCollegateEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.011.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_collegate',
        xbrl: 'DebitiDebitiVersoImpreseCollegateEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.011.004.000.000': {
        voce: 'Totale debiti verso imprese collegate',
        sezione: 'debiti_collegate',
        xbrl: 'DebitiDebitiVersoImpreseCollegateTotaleDebitiVersoImpreseCollegate'
      },
      'T0001.D01.1.001.003.005.012.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_controllanti',
        xbrl: 'DebitiDebitiVersoControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.012.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_controllanti',
        xbrl: 'DebitiDebitiVersoControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.012.004.000.000': {
        voce: 'Totale debiti verso controllanti',
        sezione: 'debiti_controllanti',
        xbrl: 'DebitiDebitiVersoControllantiTotaleDebitiVersoControllanti'
      },
      'T0001.D01.1.001.003.005.013.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_sottoposte',
        xbrl: 'DebitiDebitiVersoImpreseSottoposteControlloControllantiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.013.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_sottoposte',
        xbrl: 'DebitiDebitiVersoImpreseSottoposteControlloControllantiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.013.004.000.000': {
        voce: 'Totale debiti verso imprese sottoposte al controllo delle controllanti',
        sezione: 'debiti_sottoposte',
        xbrl: 'DebitiDebitiVersoImpreseSottoposteControlloControllantiTotaleDebitiVersoImpreseSottoposteControlloControllanti'
      },
      'T0001.D01.1.001.003.005.014.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_tributari',
        xbrl: 'DebitiDebitiTributariEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.014.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_tributari',
        xbrl: 'DebitiDebitiTributariEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.014.004.000.000': {
        voce: 'Totale debiti tributari',
        sezione: 'debiti_tributari',
        xbrl: 'DebitiDebitiTributariTotaleDebitiTributari'
      },
      'T0001.D01.1.001.003.005.015.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_previdenza',
        xbrl: 'DebitiDebitiVersoIstitutiPrevidenzaSicurezzaSocialeEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.015.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_previdenza',
        xbrl: 'DebitiDebitiVersoIstitutiPrevidenzaSicurezzaSocialeEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.015.004.000.000': {
        voce: 'Totale debiti verso istituti di previdenza e di sicurezza sociale',
        sezione: 'debiti_previdenza',
        xbrl: 'DebitiDebitiVersoIstitutiPrevidenzaSicurezzaSocialeTotaleDebitiVersoIstitutiPrevidenzaSicurezzaSociale'
      },
      'T0001.D01.1.001.003.005.016.002.000.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti_altri',
        xbrl: 'DebitiAltriDebitiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.016.003.000.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti_altri',
        xbrl: 'DebitiAltriDebitiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0001.D01.1.001.003.005.016.004.000.000': {
        voce: 'Totale altri debiti',
        sezione: 'debiti_altri',
        xbrl: 'DebitiAltriDebitiTotaleAltriDebiti'
      },
      'T0001.D01.1.001.003.005.017.000.000.000': {
        voce: 'Totale debiti',
        sezione: 'debiti',
        xbrl: 'TotaleDebiti'
      },

      // E) RATEI E RISCONTI PASSIVI
      'T0001.D01.1.001.003.006.000.000.000.000': {
        voce: 'E) Ratei e risconti',
        sezione: 'ratei_risconti_passivi',
        xbrl: 'PassivoRateiRisconti'
      },

      'T0001.D01.1.001.003.007.000.000.000.000': {
        voce: 'Totale passivo',
        sezione: 'totale_passivo',
        xbrl: 'TotalePassivo'
      }
    },  // chiude SP di Ordinario

    'CE': {
      // A) VALORE DELLA PRODUZIONE
      'T0005.D01.1.001.002.002.000.000': {
        voce: '1) ricavi delle vendite e delle prestazioni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneRicaviVenditePrestazioni'
      },
      'T0005.D01.1.001.002.003.000.000': {
        voce: '2) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniRimanenzeProdottiCorsoLavorazioneSemilavoratiFiniti'
      },
      'T0005.D01.1.001.002.004.000.000': {
        voce: '3) variazioni dei lavori in corso su ordinazione',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniLavoriCorsoOrdinazione'
      },
      'T0005.D01.1.001.002.005.000.000': {
        voce: '4) incrementi di immobilizzazioni per lavori interni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneIncrementiImmobilizzazioniLavoriInterni'
      },
      'T0005.D01.1.001.002.006.002.000': {
        voce: 'contributi in conto esercizio',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiContributiContoEsercizio'
      },
      'T0005.D01.1.001.002.006.003.000': {
        voce: 'altri',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiAltri'
      },
      'T0005.D01.1.001.002.006.004.000': {
        voce: 'Totale altri ricavi e proventi',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiTotaleAltriRicaviProventi'
      },
      'T0005.D01.1.001.002.007.000.000': {
        voce: 'Totale valore della produzione',
        sezione: 'valore_produzione',
        xbrl: 'TotaleValoreProduzione'
      },

      // B) COSTI DELLA PRODUZIONE
      'T0005.D01.1.001.003.002.000.000': {
        voce: '6) per materie prime, sussidiarie, di consumo e di merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneMateriePrimeSussidiarieConsumoMerci'
      },
      'T0005.D01.1.001.003.003.000.000': {
        voce: '7) per servizi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneServizi'
      },
      'T0005.D01.1.001.003.004.000.000': {
        voce: '8) per godimento di beni di terzi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneGodimentoBeniTerzi'
      },
      'T0005.D01.1.001.003.005.002.000': {
        voce: 'a) salari e stipendi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleSalariStipendi'
      },
      'T0005.D01.1.001.003.005.003.000': {
        voce: 'b) oneri sociali',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleOneriSociali'
      },
      'T0005.D01.1.001.003.005.004.000': {
        voce: 'c) trattamento di fine rapporto',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoFineRapporto'
      },
      'T0005.D01.1.001.003.005.005.000': {
        voce: 'd) trattamento di quiescenza e simili',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoQuiescenzaSimili'
      },
      'T0005.D01.1.001.003.005.006.000': {
        voce: 'e) altri costi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleAltriCosti'
      },
      'T0005.D01.1.001.003.005.007.000': {
        voce: 'Totale costi per il personale',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTotaleCostiPersonale'
      },
      'T0005.D01.1.001.003.006.002.000': {
        voce: 'a) ammortamento delle immobilizzazioni immateriali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniImmateriali'
      },
      'T0005.D01.1.001.003.006.003.000': {
        voce: 'b) ammortamento delle immobilizzazioni materiali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniMateriali'
      },
      'T0005.D01.1.001.003.006.004.000': {
        voce: 'c) altre svalutazioni delle immobilizzazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAltreSvalutazioniImmobilizzazioni'
      },
      'T0005.D01.1.001.003.006.005.000': {
        voce: 'd) svalutazioni dei crediti compresi nell\'attivo circolante e delle disponibilit√† liquide',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniSvalutazioniCreditiCompresiAttivoCircolanteDisponibilitaLiquide'
      },
      'T0005.D01.1.001.003.006.006.000': {
        voce: 'Totale ammortamenti e svalutazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniTotaleAmmortamentiSvalutazioni'
      },
      'T0005.D01.1.001.003.007.000.000': {
        voce: '11) variazioni delle rimanenze di materie prime, sussidiarie, di consumo e merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneVariazioniRimanenzeMateriePrimeSussidiarieConsumoMerci'
      },
      'T0005.D01.1.001.003.008.000.000': {
        voce: '12) accantonamenti per rischi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAccantonamentiRischi'
      },
      'T0005.D01.1.001.003.009.000.000': {
        voce: '13) altri accantonamenti',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAltriAccantonamenti'
      },
      'T0005.D01.1.001.003.010.000.000': {
        voce: '14) oneri diversi di gestione',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneOneriDiversiGestione'
      },
      'T0005.D01.1.001.003.011.000.000': {
        voce: 'Totale costi della produzione',
        sezione: 'costi_produzione',
        xbrl: 'TotaleCostiProduzione'
      },
      'T0005.D01.1.001.004.000.000.000': {
        voce: 'Differenza tra valore e costi della produzione (A - B)',
        sezione: 'risultato_operativo',
        xbrl: 'DifferenzaValoreCostiProduzione'
      },

      // C) PROVENTI E ONERI FINANZIARI
      'T0005.D01.1.001.005.002.002.000': {
        voce: 'da imprese controllate',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniImpreseControllate'
      },
      'T0005.D01.1.001.005.002.003.000': {
        voce: 'da imprese collegate',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniImpreseCollegate'
      },
      'T0005.D01.1.001.005.002.004.000': {
        voce: 'da imprese controllanti',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniImpreseControllanti'
      },
      'T0005.D01.1.001.005.002.005.000': {
        voce: 'da imprese sottoposte al controllo delle controllanti',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniImpreseSottoposteControlloControllanti'
      },
      'T0005.D01.1.001.005.002.006.000': {
        voce: 'altri',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniAltri'
      },
      'T0005.D01.1.001.005.002.007.000': {
        voce: 'Totale proventi da partecipazioni',
        sezione: 'proventi_partecipazioni',
        xbrl: 'ProventiOneriFinanziariProventiPartecipazioniTotaleProventiPartecipazioni'
      },
      'T0005.D01.1.001.005.003.002.002': {
        voce: 'da imprese controllate',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniImpreseControllate'
      },
      'T0005.D01.1.001.005.003.002.003': {
        voce: 'da imprese collegate',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniImpreseCollegate'
      },
      'T0005.D01.1.001.005.003.002.004': {
        voce: 'da imprese controllanti',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniImpreseControllanti'
      },
      'T0005.D01.1.001.005.003.002.005': {
        voce: 'da imprese sottoposte al controllo delle controllanti',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniImpreseSottoposteControlloControllanti'
      },
      'T0005.D01.1.001.005.003.002.006': {
        voce: 'altri',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniAltri'
      },
      'T0005.D01.1.001.005.003.002.007': {
        voce: 'Totale proventi finanziari da crediti iscritti nelle immobilizzazioni',
        sezione: 'proventi_crediti_immobilizzati',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariCreditiIscrittiImmobilizzazioniTotaleProventiFinanziariCreditiIscrittiImmobilizzazioni'
      },
      'T0005.D01.1.001.005.003.003.000': {
        voce: 'b) da titoli iscritti nelle immobilizzazioni che non costituiscono partecipazioni',
        sezione: 'altri_proventi_finanziari',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariTitoliIscrittiImmobilizzazioniNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.005.003.004.000': {
        voce: 'c) da titoli iscritti nell\'attivo circolante che non costituiscono partecipazioni',
        sezione: 'altri_proventi_finanziari',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariTitoliIscrittiAttivoCircolanteNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.005.003.005.002': {
        voce: 'da imprese controllate',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiImpreseControllate'
      },
      'T0005.D01.1.001.005.003.005.003': {
        voce: 'da imprese collegate',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiImpreseCollegate'
      },
      'T0005.D01.1.001.005.003.005.004': {
        voce: 'da imprese controllanti',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiImpreseControllanti'
      },
      'T0005.D01.1.001.005.003.005.005': {
        voce: 'da imprese sottoposte al controllo delle controllanti',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiImpreseSottoposteControlloControllanti'
      },
      'T0005.D01.1.001.005.003.005.006': {
        voce: 'altri',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiAltri'
      },
      'T0005.D01.1.001.005.003.005.007': {
        voce: 'Totale proventi diversi dai precedenti',
        sezione: 'proventi_diversi',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariProventiDiversiPrecedentiTotaleProventiDiversiPrecedenti'
      },
      'T0005.D01.1.001.005.003.006.000': {
        voce: 'Totale altri proventi finanziari',
        sezione: 'altri_proventi_finanziari',
        xbrl: 'ProventiOneriFinanziariAltriProventiFinanziariTotaleAltriProventiFinanziari'
      },
      'T0005.D01.1.001.005.004.002.000': {
        voce: 'verso imprese controllate',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariVersoImpreseControllate'
      },
      'T0005.D01.1.001.005.004.003.000': {
        voce: 'verso imprese collegate',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariVersoImpreseCollegate'
      },
      'T0005.D01.1.001.005.004.004.000': {
        voce: 'verso imprese controllanti',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariVersoImpreseControllanti'
      },
      'T0005.D01.1.001.005.004.005.000': {
        voce: 'verso imprese sottoposte al controllo delle controllanti',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariVersoImpreseSottoposteControlloControllanti'
      },
      'T0005.D01.1.001.005.004.006.000': {
        voce: 'altri',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariAltri'
      },
      'T0005.D01.1.001.005.004.007.000': {
        voce: 'Totale interessi e altri oneri finanziari',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariTotaleInteressiAltriOneriFinanziari'
      },
      'T0005.D01.1.001.005.005.000.000': {
        voce: '17-bis) utili e perdite su cambi',
        sezione: 'proventi_oneri_finanziari',
        xbrl: 'ProventiOneriFinanziariUtiliPerditeCambi'
      },
      'T0005.D01.1.001.005.006.000.000': {
        voce: 'Totale proventi e oneri finanziari (15 + 16 - 17 + - 17-bis)',
        sezione: 'proventi_oneri_finanziari',
        xbrl: 'TotaleProventiOneriFinanziari'
      },

      // D) RETTIFICHE DI VALORE DI ATTIVITA' E PASSIVITA' FINANZIARIE
      'T0005.D01.1.001.006.002.002.000': {
        voce: 'a) di partecipazioni',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniPartecipazioni'
      },
      'T0005.D01.1.001.006.002.003.000': {
        voce: 'b) di immobilizzazioni finanziarie che non costituiscono partecipazioni',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniImmobilizzazioniFinanziarieNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.006.002.004.000': {
        voce: 'c) di titoli iscritti all\'attivo circolante che non costituiscono partecipazioni',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniTitoliIscrittiAttivoCircolanteNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.006.002.005.000': {
        voce: 'd) di strumenti finanziari derivati',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniStrumentiFinanziariDerivati'
      },
      'T0005.D01.1.001.006.002.006.000': {
        voce: 'di attivit√† finanziarie per la gestione accentrata della tesoreria',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniAttivitaFinanziarieLaGestioneAccentrataTesoreria'
      },
      'T0005.D01.1.001.006.002.007.000': {
        voce: 'Totale rivalutazioni',
        sezione: 'rivalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieRivalutazioniTotaleRivalutazioni'
      },
      'T0005.D01.1.001.006.003.002.000': {
        voce: 'a) di partecipazioni',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniPartecipazioni'
      },
      'T0005.D01.1.001.006.003.003.000': {
        voce: 'b) di immobilizzazioni finanziarie che non costituiscono partecipazioni',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniImmobilizzazioniFinanziarieNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.006.003.004.000': {
        voce: 'c) di titoli iscritti nell\'attivo circolante che non costituiscono partecipazioni',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniTitoliIscrittiAttivoCircolanteNonCostituisconoPartecipazioni'
      },
      'T0005.D01.1.001.006.003.005.000': {
        voce: 'd) di strumenti finanziari derivati',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniStrumentiFinanziariDerivati'
      },
      'T0005.D01.1.001.006.003.006.000': {
        voce: 'di attivit√† finanziarie per la gestione accentrata della tesoreria',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniAttivitaFinanziarieLaGestioneAccentrataTesoreria'
      },
      'T0005.D01.1.001.006.003.007.000': {
        voce: 'Totale svalutazioni',
        sezione: 'svalutazioni',
        xbrl: 'RettificheValoreAttivitaPassivitaFinanziarieSvalutazioniTotaleSvalutazioni'
      },
      'T0005.D01.1.001.006.004.000.000': {
        voce: 'Totale delle rettifiche di valore di attivit√† e passivit√† finanziarie (18 - 19)',
        sezione: 'rettifiche_valore',
        xbrl: 'TotaleRettificheValoreAttivitaPassivitaFinanziarie'
      },
      'T0005.D01.1.001.007.000.000.000': {
        voce: 'Risultato prima delle imposte (A - B + - C + - D)',
        sezione: 'risultato_ante_imposte',
        xbrl: 'RisultatoPrimaImposte'
      },

      // IMPOSTE
      'T0005.D01.1.001.008.002.000.000': {
        voce: 'imposte correnti',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteCorrenti'
      },
      'T0005.D01.1.001.008.003.000.000': {
        voce: 'imposte relative a esercizi precedenti',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteRelativeEserciziPrecedenti'
      },
      'T0005.D01.1.001.008.004.000.000': {
        voce: 'imposte differite e anticipate',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteDifferiteAnticipate'
      },
      'T0005.D01.1.001.008.005.000.000': {
        voce: 'proventi (oneri) da adesione al regime di consolidato fiscale / trasparenza fiscale',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateProventiOneriAdesioneRegimeConsolidatoFiscaleTrasparenzaFiscale'
      },
      'T0005.D01.1.001.008.006.000.000': {
        voce: 'Totale delle imposte sul reddito dell\'esercizio, correnti, differite e anticipate',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateTotaleImposteRedditoEsercizioCorrentiDifferiteAnticipate'
      },

      'T0005.D01.1.001.009.000.000.000': {
        voce: '21) Utile (perdita) dell\'esercizio',
        sezione: 'risultato_esercizio',
        xbrl: 'UtilePerditaEsercizio'
      }
    }  // chiude CE di Ordinario
  },  // chiude Ordinario

  'Abbreviato': {
    'SP': {
      'T0002.D01.1.001.002.002.000.000': {
        voce: 'A) Crediti verso soci per versamenti ancora dovuti',
        sezione: 'crediti_soci',
        xbrl: 'TotaleCreditiVersoSociVersamentiAncoraDovuti'
      },
      // B) IMMOBILIZZAZIONI
      'T0002.D01.1.001.002.003.002.000': {
        voce: 'I - Immobilizzazioni immateriali',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniImmateriali'
      },
      'T0002.D01.1.001.002.003.003.000': {
        voce: 'II - Immobilizzazioni materiali',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniMateriali'
      },
      'T0002.D01.1.001.002.003.004.000': {
        voce: 'III - Immobilizzazioni finanziarie',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniFinanziarie'
      },
      'T0002.D01.1.001.002.003.005.000': {
        voce: 'Totale immobilizzazioni (B)',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioni'
      },

      // C) ATTIVO CIRCOLANTE
      'T0002.D01.1.001.002.004.002.000': {
        voce: 'I - Rimanenze',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleRimanenze'
      },
      'T0002.D01.1.001.002.004.003.000': {
        voce: 'Immobilizzazioni materiali destinate alla vendita',
        sezione: 'attivo_circolante',
        xbrl: 'ImmobilizzazioniMaterialiDestinateAllaVendita'
      },
      'T0002.D01.1.001.002.004.004.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti',
        xbrl: 'CreditiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0002.D01.1.001.002.004.004.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti',
        xbrl: 'CreditiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0002.D01.1.001.002.004.004.004': {
        voce: 'imposte anticipate',
        sezione: 'crediti',
        xbrl: 'CreditiImposteAnticipateTotaleImposteAnticipate'
      },
      'T0002.D01.1.001.002.004.004.005': {
        voce: 'Totale crediti',
        sezione: 'crediti',
        xbrl: 'TotaleCrediti'
      },
      'T0002.D01.1.001.002.004.005.000': {
        voce: 'III - Attivit√† finanziarie che non costituiscono immobilizzazioni',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleAttivitaFinanziarieNonCostituisconoImmobilizzazioni'
      },
      'T0002.D01.1.001.002.004.006.000': {
        voce: 'IV - Disponibilit√† liquide',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleDisponibilitaLiquide'
      },
      'T0002.D01.1.001.002.004.007.000': {
        voce: 'Totale attivo circolante (C)',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleAttivoCircolante'
      },

      // D) RATEI E RISCONTI ATTIVI
      'T0002.D01.1.001.002.005.000.000': {
        voce: 'D) Ratei e risconti',
        sezione: 'ratei_risconti_attivi',
        xbrl: 'AttivoRateiRisconti'
      },

      // TOTALE ATTIVO
      'T0002.D01.1.001.002.006.000.000': {
        voce: 'Totale attivo',
        sezione: 'totale_attivo',
        xbrl: 'TotaleAttivo'
      },

      // PASSIVO - A) PATRIMONIO NETTO
      'T0002.D01.1.001.003.002.002.000': {
        voce: 'I - Capitale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoCapitale'
      },
      'T0002.D01.1.001.003.002.003.000': {
        voce: 'II - Riserva da soprapprezzo delle azioni',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaSoprapprezzoAzioni'
      },
      'T0002.D01.1.001.003.002.004.000': {
        voce: 'III - Riserve di rivalutazione',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveRivalutazione'
      },
      'T0002.D01.1.001.003.002.005.000': {
        voce: 'IV - Riserva legale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaLegale'
      },
      'T0002.D01.1.001.003.002.006.000': {
        voce: 'V - Riserve statutarie',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveStatutarie'
      },
      'T0002.D01.1.001.003.002.007.000': {
        voce: 'VI - Altre riserve',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateTotaleAltreRiserve'
      },
      'T0002.D01.1.001.003.002.008.000': {
        voce: 'VII - Riserva per operazioni di copertura dei flussi finanziari attesi',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaOperazioniCoperturaFlussiFinanziariAttesi'
      },
      'T0002.D01.1.001.003.002.009.000': {
        voce: 'VIII - Utili (perdite) portati a nuovo',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtiliPerditePortatiNuovo'
      },
      'T0002.D01.1.001.003.002.010.000': {
        voce: 'IX - Utile (perdita) dell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtilePerditaEsercizio'
      },
      'T0002.D01.1.001.003.002.011.000': {
        voce: 'Perdita ripianata nell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoPerditaRipianataEsercizio'
      },
      'T0002.D01.1.001.003.002.012.000': {
        voce: 'X - Riserva negativa per azioni proprie in portafoglio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaNegativaAzioniPropriePortafoglio'
      },
      'T0002.D01.1.001.003.002.013.000': {
        voce: 'Totale patrimonio netto',
        sezione: 'patrimonio_netto',
        xbrl: 'TotalePatrimonioNetto'
      },

      // B) FONDI PER RISCHI E ONERI
      'T0002.D01.1.001.003.003.000.000': {
        voce: 'B) Fondi per rischi e oneri',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'TotaleFondiRischiOneri'
      },

      // C) TFR
      'T0002.D01.1.001.003.004.000.000': {
        voce: 'C) Trattamento di fine rapporto di lavoro subordinato',
        sezione: 'tfr',
        xbrl: 'TrattamentoFineRapportoLavoroSubordinato'
      },

      // D) DEBITI
      'T0002.D01.1.001.003.005.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti',
        xbrl: 'DebitiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0002.D01.1.001.003.005.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti',
        xbrl: 'DebitiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0002.D01.1.001.003.005.004.000': {
        voce: 'Totale debiti',
        sezione: 'debiti',
        xbrl: 'TotaleDebiti'
      },

      // E) RATEI E RISCONTI PASSIVI
      'T0002.D01.1.001.003.006.000.000': {
        voce: 'E) Ratei e risconti',
        sezione: 'ratei_risconti_passivi',
        xbrl: 'PassivoRateiRisconti'
      },

      // TOTALE PASSIVO
      'T0002.D01.1.001.003.007.000.000': {
        voce: 'Totale passivo',
        sezione: 'totale_passivo',
        xbrl: 'TotalePassivo'
      }
    },

    'CE': {
      // A) VALORE DELLA PRODUZIONE
      'T0006.D01.1.001.002.002.000.000': {
        voce: '1) ricavi delle vendite e delle prestazioni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneRicaviVenditePrestazioni'
      },
      'T0006.D01.1.001.002.003.001.000': {
        voce: '2), 3) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti e dei lavori in corso su ordinazione',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniRimanenzeProdottiCorsoLavorazioneSemilavoratiFinitiLavoriCorsoOrdinazione'
      },
      'T0006.D01.1.001.002.003.002.000': {
        voce: '2) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniRimanenzeProdottiCorsoLavorazioneSemilavoratiFiniti'
      },
      'T0006.D01.1.001.002.003.003.000': {
        voce: '3) variazioni dei lavori in corso su ordinazione',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniLavoriCorsoOrdinazione'
      },
      'T0006.D01.1.001.002.004.000.000': {
        voce: '4) incrementi di immobilizzazioni per lavori interni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneIncrementiImmobilizzazioniLavoriInterni'
      },
      'T0006.D01.1.001.002.005.002.000': {
        voce: 'contributi in conto esercizio',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiContributiContoEsercizio'
      },
      'T0006.D01.1.001.002.005.003.000': {
        voce: 'altri',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiAltri'
      },
      'T0006.D01.1.001.002.005.004.000': {
        voce: 'Totale altri ricavi e proventi',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiTotaleAltriRicaviProventi'
      },
      'T0006.D01.1.001.002.006.000.000': {
        voce: 'Totale valore della produzione',
        sezione: 'valore_produzione',
        xbrl: 'TotaleValoreProduzione'
      },

      // B) COSTI DELLA PRODUZIONE
      'T0006.D01.1.001.003.002.000.000': {
        voce: '6) per materie prime, sussidiarie, di consumo e di merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneMateriePrimeSussidiarieConsumoMerci'
      },
      'T0006.D01.1.001.003.003.000.000': {
        voce: '7) per servizi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneServizi'
      },
      'T0006.D01.1.001.003.004.000.000': {
        voce: '8) per godimento di beni di terzi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneGodimentoBeniTerzi'
      },
      'T0006.D01.1.001.003.005.002.000': {
        voce: 'a) salari e stipendi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleSalariStipendi'
      },
      'T0006.D01.1.001.003.005.003.000': {
        voce: 'b) oneri sociali',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleOneriSociali'
      },
      'T0006.D01.1.001.003.005.004.001': {
        voce: 'c), d), e) trattamento di fine rapporto, trattamento di quiescenza, altri costi del personale',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoFineRapportoTrattamentoQuiescenzaAltriCostiPersonale'
      },
      'T0006.D01.1.001.003.005.004.002': {
        voce: 'c) trattamento di fine rapporto',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoFineRapporto'
      },
      'T0006.D01.1.001.003.005.004.003': {
        voce: 'd) trattamento di quiescenza e simili',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoQuiescenzaSimili'
      },
      'T0006.D01.1.001.003.005.004.004': {
        voce: 'e) altri costi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleAltriCosti'
      },
      'T0006.D01.1.001.003.005.005.000': {
        voce: 'Totale costi per il personale',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTotaleCostiPersonale'
      },
      'T0006.D01.1.001.003.006.002.001': {
        voce: 'a), b), c) ammortamento delle immobilizzazioni immateriali e materiali, altre svalutazioni delle immobilizzazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniImmaterialiMaterialiAltreSvalutazioniImmobilizzazioni'
      },
      'T0006.D01.1.001.003.006.002.002': {
        voce: 'a) ammortamento delle immobilizzazioni immateriali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniImmateriali'
      },
      'T0006.D01.1.001.003.006.002.003': {
        voce: 'b) ammortamento delle immobilizzazioni materiali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniMateriali'
      },
      'T0006.D01.1.001.003.006.002.004': {
        voce: 'c) altre svalutazioni delle immobilizzazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAltreSvalutazioniImmobilizzazioni'
      },
      'T0006.D01.1.001.003.006.003.000': {
        voce: 'd) svalutazioni dei crediti compresi nell\'attivo circolante e delle disponibilit√† liquide',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniSvalutazioniCreditiCompresiAttivoCircolanteDisponibilitaLiquide'
      },
      'T0006.D01.1.001.003.006.004.000': {
        voce: 'Totale ammortamenti e svalutazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniTotaleAmmortamentiSvalutazioni'
      },
      'T0006.D01.1.001.003.007.000.000': {
        voce: '11) variazioni delle rimanenze di materie prime, sussidiarie, di consumo e merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneVariazioniRimanenzeMateriePrimeSussidiarieConsumoMerci'
      },
      'T0006.D01.1.001.003.008.000.000': {
        voce: '12) accantonamenti per rischi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAccantonamentiRischi'
      },
      'T0006.D01.1.001.003.009.000.000': {
        voce: '13) altri accantonamenti',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAltriAccantonamenti'
      },
      'T0006.D01.1.001.003.010.000.000': {
        voce: '14) oneri diversi di gestione',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneOneriDiversiGestione'
      },
      'T0006.D01.1.001.003.011.000.000': {
        voce: 'Totale costi della produzione',
        sezione: 'costi_produzione',
        xbrl: 'TotaleCostiProduzione'
      },
      'T0006.D01.1.001.004.000.000.000': {
        voce: 'Differenza tra valore e costi della produzione (A - B)',
        sezione: 'risultato_operativo',
        xbrl: 'DifferenzaValoreCostiProduzione'
      },

      // C) PROVENTI E ONERI FINANZIARI (abbreviato)
      'T0006.D01.1.001.005.004.006.000': {
        voce: 'altri',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariAltri'
      },
      'T0006.D01.1.001.005.004.007.000': {
        voce: 'Totale interessi e altri oneri finanziari',
        sezione: 'interessi_oneri',
        xbrl: 'ProventiOneriFinanziariInteressiAltriOneriFinanziariTotaleInteressiAltriOneriFinanziari'
      },
      'T0006.D01.1.001.005.005.000.000': {
        voce: '17-bis) utili e perdite su cambi',
        sezione: 'proventi_oneri_finanziari',
        xbrl: 'ProventiOneriFinanziariUtiliPerditeCambi'
      },
      'T0006.D01.1.001.005.006.000.000': {
        voce: 'Totale proventi e oneri finanziari (15 + 16 - 17 + - 17-bis)',
        sezione: 'proventi_oneri_finanziari',
        xbrl: 'TotaleProventiOneriFinanziari'
      },

      // D) RETTIFICHE DI VALORE (abbreviato)
      'T0006.D01.1.001.006.004.000.000': {
        voce: 'Totale delle rettifiche di valore di attivit√† e passivit√† finanziarie (18 - 19)',
        sezione: 'rettifiche_valore',
        xbrl: 'TotaleRettificheValoreAttivitaPassivitaFinanziarie'
      },

      // RISULTATO E IMPOSTE
      'T0006.D01.1.001.007.000.000.000': {
        voce: 'Risultato prima delle imposte (A - B + - C + - D)',
        sezione: 'risultato_ante_imposte',
        xbrl: 'RisultatoPrimaImposte'
      },
      'T0006.D01.1.001.008.002.000.000': {
        voce: 'imposte correnti',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteCorrenti'
      },
      'T0006.D01.1.001.008.003.000.000': {
        voce: 'imposte relative a esercizi precedenti',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteRelativeEserciziPrecedenti'
      },
      'T0006.D01.1.001.008.004.000.000': {
        voce: 'imposte differite e anticipate',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteDifferiteAnticipate'
      },
      'T0006.D01.1.001.008.005.000.000': {
        voce: 'proventi (oneri) da adesione al regime di consolidato fiscale / trasparenza fiscale',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateProventiOneriAdesioneRegimeConsolidatoFiscaleTrasparenzaFiscale'
      },
      'T0006.D01.1.001.008.006.000.000': {
        voce: 'Totale delle imposte sul reddito dell\'esercizio, correnti, differite e anticipate',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateTotaleImposteRedditoEsercizioCorrentiDifferiteAnticipate'
      },
      'T0006.D01.1.001.009.000.000.000': {
        voce: '21) Utile (perdita) dell\'esercizio',
        sezione: 'risultato_esercizio',
        xbrl: 'UtilePerditaEsercizio'
      }
    }
  },  // chiude Abbreviato

  'Micro': {
    'SP': {
      // A) CREDITI VERSO SOCI
      'T0003.D01.1.001.002.002.000.000': {
        voce: 'A) Crediti verso soci per versamenti ancora dovuti',
        sezione: 'crediti_soci',
        xbrl: 'TotaleCreditiVersoSociVersamentiAncoraDovuti'
      },

      // B) IMMOBILIZZAZIONI
      'T0003.D01.1.001.002.003.002.000': {
        voce: 'I - Immobilizzazioni immateriali',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniImmateriali'
      },
      'T0003.D01.1.001.002.003.003.000': {
        voce: 'II - Immobilizzazioni materiali',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniMateriali'
      },
      'T0003.D01.1.001.002.003.004.000': {
        voce: 'III - Immobilizzazioni finanziarie',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioniFinanziarie'
      },
      'T0003.D01.1.001.002.003.005.000': {
        voce: 'Totale immobilizzazioni (B)',
        sezione: 'immobilizzazioni',
        xbrl: 'TotaleImmobilizzazioni'
      },

      // C) ATTIVO CIRCOLANTE
      'T0003.D01.1.001.002.004.002.000': {
        voce: 'I - Rimanenze',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleRimanenze'
      },
      'T0003.D01.1.001.002.004.003.000': {
        voce: 'Immobilizzazioni materiali destinate alla vendita',
        sezione: 'attivo_circolante',
        xbrl: 'ImmobilizzazioniMaterialiDestinateAllaVendita'
      },

      // II - Crediti
      'T0003.D01.1.001.002.004.004.002': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'crediti',
        xbrl: 'CreditiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0003.D01.1.001.002.004.004.003': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'crediti',
        xbrl: 'CreditiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0003.D01.1.001.002.004.004.004': {
        voce: 'imposte anticipate',
        sezione: 'crediti',
        xbrl: 'CreditiImposteAnticipateTotaleImposteAnticipate'
      },
      'T0003.D01.1.001.002.004.004.005': {
        voce: 'Totale crediti',
        sezione: 'crediti',
        xbrl: 'TotaleCrediti'
      },

      'T0003.D01.1.001.002.004.005.000': {
        voce: 'III - Attivit√† finanziarie che non costituiscono immobilizzazioni',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleAttivitaFinanziarieNonCostituisconoImmobilizzazioni'
      },
      'T0003.D01.1.001.002.004.006.000': {
        voce: 'IV - Disponibilit√† liquide',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleDisponibilitaLiquide'
      },
      'T0003.D01.1.001.002.004.007.000': {
        voce: 'Totale attivo circolante (C)',
        sezione: 'attivo_circolante',
        xbrl: 'TotaleAttivoCircolante'
      },

      // D) RATEI E RISCONTI ATTIVI
      'T0003.D01.1.001.002.005.000.000': {
        voce: 'D) Ratei e risconti',
        sezione: 'ratei_risconti_attivi',
        xbrl: 'AttivoRateiRisconti'
      },

      // TOTALE ATTIVO
      'T0003.D01.1.001.002.006.000.000': {
        voce: 'Totale attivo',
        sezione: 'totale_attivo',
        xbrl: 'TotaleAttivo'
      },

      // PASSIVO - A) PATRIMONIO NETTO
      'T0003.D01.1.001.003.002.002.000': {
        voce: 'I - Capitale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoCapitale'
      },
      'T0003.D01.1.001.003.002.003.000': {
        voce: 'II - Riserva da soprapprezzo delle azioni',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaSoprapprezzoAzioni'
      },
      'T0003.D01.1.001.003.002.004.000': {
        voce: 'III - Riserve di rivalutazione',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveRivalutazione'
      },
      'T0003.D01.1.001.003.002.005.000': {
        voce: 'IV - Riserva legale',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaLegale'
      },
      'T0003.D01.1.001.003.002.006.000': {
        voce: 'V - Riserve statutarie',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiserveStatutarie'
      },
      'T0003.D01.1.001.003.002.007.000': {
        voce: 'VI - Altre riserve',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoAltreRiserveDistintamenteIndicateTotaleAltreRiserve'
      },
      'T0003.D01.1.001.003.002.008.000': {
        voce: 'VIII - Utili (perdite) portati a nuovo',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtiliPerditePortatiNuovo'
      },
      'T0003.D01.1.001.003.002.009.000': {
        voce: 'IX - Utile (perdita) dell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoUtilePerditaEsercizio'
      },
      'T0003.D01.1.001.003.002.010.000': {
        voce: 'Perdita ripianata nell\'esercizio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoPerditaRipianataEsercizio'
      },
      'T0003.D01.1.001.003.002.011.000': {
        voce: 'X - Riserva negativa per azioni proprie in portafoglio',
        sezione: 'patrimonio_netto',
        xbrl: 'PatrimonioNettoRiservaNegativaAzioniPropriePortafoglio'
      },
      'T0003.D01.1.001.003.002.012.000': {
        voce: 'Totale patrimonio netto',
        sezione: 'patrimonio_netto',
        xbrl: 'TotalePatrimonioNetto'
      },

      // B) FONDI PER RISCHI E ONERI
      'T0003.D01.1.001.003.003.000.000': {
        voce: 'B) Fondi per rischi e oneri',
        sezione: 'fondi_rischi_oneri',
        xbrl: 'TotaleFondiRischiOneri'
      },

      // C) TFR
      'T0003.D01.1.001.003.004.000.000': {
        voce: 'C) Trattamento di fine rapporto di lavoro subordinato',
        sezione: 'tfr',
        xbrl: 'TrattamentoFineRapportoLavoroSubordinato'
      },

      // D) DEBITI
      'T0003.D01.1.001.003.005.002.000': {
        voce: 'esigibili entro l\'esercizio successivo',
        sezione: 'debiti',
        xbrl: 'DebitiEsigibiliEntroEsercizioSuccessivo'
      },
      'T0003.D01.1.001.003.005.003.000': {
        voce: 'esigibili oltre l\'esercizio successivo',
        sezione: 'debiti',
        xbrl: 'DebitiEsigibiliOltreEsercizioSuccessivo'
      },
      'T0003.D01.1.001.003.005.004.000': {
        voce: 'Totale debiti',
        sezione: 'debiti',
        xbrl: 'TotaleDebiti'
      },

      // E) RATEI E RISCONTI PASSIVI
      'T0003.D01.1.001.003.006.000.000': {
        voce: 'E) Ratei e risconti',
        sezione: 'ratei_risconti_passivi',
        xbrl: 'PassivoRateiRisconti'
      },

      // TOTALE PASSIVO
      'T0003.D01.1.001.003.007.000.000': {
        voce: 'Totale passivo',
        sezione: 'totale_passivo',
        xbrl: 'TotalePassivo'
      }
    },

    'CE': {
      // CONTO ECONOMICO MICRO - USA T0007
      // A) VALORE DELLA PRODUZIONE
      'T0007.D01.1.001.002.002.000.000': {
        voce: '1) ricavi delle vendite e delle prestazioni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneRicaviVenditePrestazioni'
      },
      'T0007.D01.1.001.002.003.001.000': {
        voce: '2), 3) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti e dei lavori in corso su ordinazione',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniRimanenzeProdottiCorsoLavorazioneSemilavoratiFinitiLavoriCorsoOrdinazione'
      },
      'T0007.D01.1.001.002.003.002.000': {
        voce: '2) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniRimanenzeProdottiCorsoLavorazioneSemilavoratiFiniti'
      },
      'T0007.D01.1.001.002.003.003.000': {
        voce: '3) variazioni dei lavori in corso su ordinazione',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneVariazioniLavoriCorsoOrdinazione'
      },
      'T0007.D01.1.001.002.004.000.000': {
        voce: '4) incrementi di immobilizzazioni per lavori interni',
        sezione: 'valore_produzione',
        xbrl: 'ValoreProduzioneIncrementiImmobilizzazioniLavoriInterni'
      },
      'T0007.D01.1.001.002.005.002.000': {
        voce: 'contributi in conto esercizio',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiContributiContoEsercizio'
      },
      'T0007.D01.1.001.002.005.003.000': {
        voce: 'altri',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiAltri'
      },
      'T0007.D01.1.001.002.005.004.000': {
        voce: 'Totale altri ricavi e proventi',
        sezione: 'altri_ricavi',
        xbrl: 'ValoreProduzioneAltriRicaviProventiTotaleAltriRicaviProventi'
      },
      'T0007.D01.1.001.002.006.000.000': {
        voce: 'Totale valore della produzione',
        sezione: 'valore_produzione',
        xbrl: 'TotaleValoreProduzione'
      },

      // B) COSTI DELLA PRODUZIONE
      'T0007.D01.1.001.003.002.000.000': {
        voce: '6) per materie prime, sussidiarie, di consumo e di merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneMateriePrimeSussidiarieConsumoMerci'
      },
      'T0007.D01.1.001.003.003.000.000': {
        voce: '7) per servizi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneServizi'
      },
      'T0007.D01.1.001.003.004.000.000': {
        voce: '8) per godimento di beni di terzi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneGodimentoBeniTerzi'
      },
      'T0007.D01.1.001.003.005.002.000': {
        voce: 'a) salari e stipendi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleSalariStipendi'
      },
      'T0007.D01.1.001.003.005.003.000': {
        voce: 'b) oneri sociali',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleOneriSociali'
      },
      'T0007.D01.1.001.003.005.004.001': {
        voce: 'c), d), e) trattamento di fine rapporto, trattamento di quiescenza, altri costi del personale',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoFineRapportoTrattamentoQuiescenzaAltriCostiPersonale'
      },
      'T0007.D01.1.001.003.005.004.002': {
        voce: 'c) trattamento di fine rapporto',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoFineRapporto'
      },
      'T0007.D01.1.001.003.005.004.003': {
        voce: 'd) trattamento di quiescenza e simili',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTrattamentoQuiescenzaSimili'
      },
      'T0007.D01.1.001.003.005.004.004': {
        voce: 'e) altri costi',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleAltriCosti'
      },
      'T0007.D01.1.001.003.005.005.000': {
        voce: 'Totale costi per il personale',
        sezione: 'costi_personale',
        xbrl: 'CostiProduzionePersonaleTotaleCostiPersonale'
      },
      'T0007.D01.1.001.003.006.002.001': {
        voce: 'a), b), c) ammortamento delle immobilizzazioni immateriali e materiali, altre svalutazioni delle immobilizzazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniImmaterialiMaterialiAltreSvalutazioniImmobilizzazioni'
      },
      'T0007.D01.1.001.003.006.002.002': {
        voce: 'a) ammortamento delle immobilizzazioni immateriali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniImmateriali'
      },
      'T0007.D01.1.001.003.006.002.003': {
        voce: 'b) ammortamento delle immobilizzazioni materiali',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAmmortamentoImmobilizzazioniMateriali'
      },
      'T0007.D01.1.001.003.006.002.004': {
        voce: 'c) altre svalutazioni delle immobilizzazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniAltreSvalutazioniImmobilizzazioni'
      },
      'T0007.D01.1.001.003.006.003.000': {
        voce: 'd) svalutazioni dei crediti compresi nell\'attivo circolante e delle disponibilit√† liquide',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniSvalutazioniCreditiCompresiAttivoCircolanteDisponibilitaLiquide'
      },
      'T0007.D01.1.001.003.006.004.000': {
        voce: 'Totale ammortamenti e svalutazioni',
        sezione: 'ammortamenti_svalutazioni',
        xbrl: 'CostiProduzioneAmmortamentiSvalutazioniTotaleAmmortamentiSvalutazioni'
      },
      'T0007.D01.1.001.003.007.000.000': {
        voce: '11) variazioni delle rimanenze di materie prime, sussidiarie, di consumo e merci',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneVariazioniRimanenzeMateriePrimeSussidiarieConsumoMerci'
      },
      'T0007.D01.1.001.003.008.000.000': {
        voce: '12) accantonamenti per rischi',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAccantonamentiRischi'
      },
      'T0007.D01.1.001.003.009.000.000': {
        voce: '13) altri accantonamenti',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneAltriAccantonamenti'
      },
      'T0007.D01.1.001.003.010.000.000': {
        voce: '14) oneri diversi di gestione',
        sezione: 'costi_produzione',
        xbrl: 'CostiProduzioneOneriDiversiGestione'
      },
      'T0007.D01.1.001.003.011.000.000': {
        voce: 'Totale costi della produzione',
        sezione: 'costi_produzione',
        xbrl: 'TotaleCostiProduzione'
      },
      'T0007.D01.1.001.004.000.000.000': {
        voce: 'Differenza tra valore e costi della produzione (A - B)',
        sezione: 'risultato_operativo',
        xbrl: 'DifferenzaValoreCostiProduzione'
      },

      // C) PROVENTI E ONERI FINANZIARI - continua con T0007...
      // [continua con tutti i codici T0007 per la parte finanziaria]

      // RISULTATO E IMPOSTE
      'T0007.D01.1.001.007.000.000.000': {
        voce: 'Risultato prima delle imposte (A - B + - C + - D)',
        sezione: 'risultato_ante_imposte',
        xbrl: 'RisultatoPrimaImposte'
      },
      'T0007.D01.1.001.008.002.000.000': {
        voce: 'imposte correnti',
        sezione: 'imposte',
        xbrl: 'ImposteRedditoEsercizioCorrentiDifferiteAnticipateImposteCorrenti'
      },
      'T0007.D01.1.001.009.000.000.000': {
        voce: '21) Utile (perdita) dell\'esercizio',
        sezione: 'risultato_esercizio',
        xbrl: 'UtilePerditaEsercizio'
      }
    }
  }  // chiude Micro
};  // chiude TASSONOMIA_MAPPING


// =======================================
// MAPPING_STANDARDIZZATO - MAPPING PER BILANCIO STANDARDIZZATO
// =======================================

const MAPPING_STANDARDIZZATO = {
  'SP': {
    // ATTIVO
    'crediti_soci': {
      voce: 'A) Crediti verso soci per versamenti ancora dovuti',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.002.004.000.000.000'], // Totale
        'Abbreviato': ['T0002.D01.1.001.002.002.000.000'],
        'Micro': ['T0003.D01.1.001.002.002.000.000']
      }
    },

    // B) IMMOBILIZZAZIONI
    'immobilizzazioni_immateriali': {
      voce: 'I - Immobilizzazioni immateriali',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.003.002.009.000.000'], // Totale immateriali
        'Abbreviato': ['T0002.D01.1.001.002.003.002.000'],
        'Micro': ['T0003.D01.1.001.002.003.002.000']
      }
    },
    'immobilizzazioni_materiali': {
      voce: 'II - Immobilizzazioni materiali',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.003.003.007.000.000'], // Totale materiali
        'Abbreviato': ['T0002.D01.1.001.002.003.003.000'],
        'Micro': ['T0003.D01.1.001.002.003.003.000']
      }
    },
    'immobilizzazioni_finanziarie': {
      voce: 'III - Immobilizzazioni finanziarie',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.003.004.006.000.000'], // Totale finanziarie
        'Abbreviato': ['T0002.D01.1.001.002.003.004.000'],
        'Micro': ['T0003.D01.1.001.002.003.004.000']
      }
    },
    'totale_immobilizzazioni': {
      voce: 'Totale immobilizzazioni (B)',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.003.005.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.003.005.000'],
        'Micro': ['T0003.D01.1.001.002.003.005.000']
      }
    },

    // C) ATTIVO CIRCOLANTE
    'rimanenze': {
      voce: 'I - Rimanenze',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.002.007.000.000'], // Totale rimanenze
        'Abbreviato': ['T0002.D01.1.001.002.004.002.000'],
        'Micro': ['T0003.D01.1.001.002.004.002.000']
      }
    },
    'immobilizzazioni_destinate_vendita': {
      voce: 'Immobilizzazioni materiali destinate alla vendita',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.003.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.004.003.000'],
        'Micro': ['T0003.D01.1.001.002.004.003.000']
      }
    },

    // CREDITI - ATTENZIONE ALLE AGGREGAZIONI
    'crediti_entro': {
      voce: 'esigibili entro l\'esercizio successivo',
      calcolo: {
        'Ordinario': [
          // SOMMA di tutti i crediti entro (escluse imposte anticipate)
          'T0001.D01.1.001.002.004.004.002.002.000', // verso clienti entro
          'T0001.D01.1.001.002.004.004.003.002.000', // verso controllate entro
          'T0001.D01.1.001.002.004.004.004.002.000', // verso collegate entro
          'T0001.D01.1.001.002.004.004.005.002.000', // verso controllanti entro
          'T0001.D01.1.001.002.004.004.006.002.000', // verso sottoposte entro
          'T0001.D01.1.001.002.004.004.007.002.000', // tributari entro
          'T0001.D01.1.001.002.004.004.009.002.000'  // verso altri entro
        ],
        'Abbreviato': ['T0002.D01.1.001.002.004.004.002'],
        'Micro':      ['T0003.D01.1.001.002.004.004.002']
      }
    },

    'crediti_oltre': {
      voce: 'esigibili oltre l\'esercizio successivo',
      calcolo: {
        'Ordinario': [
          // SOMMA di tutti i crediti oltre
          'T0001.D01.1.001.002.004.004.002.003.000', // verso clienti oltre
          'T0001.D01.1.001.002.004.004.003.003.000', // verso controllate oltre
          'T0001.D01.1.001.002.004.004.004.003.000', // verso collegate oltre
          'T0001.D01.1.001.002.004.004.005.003.000', // verso controllanti oltre
          'T0001.D01.1.001.002.004.004.006.003.000', // verso sottoposte oltre
          'T0001.D01.1.001.002.004.004.007.003.000', // tributari oltre
          'T0001.D01.1.001.002.004.004.009.003.000'  // verso altri oltre
        ],
        'Abbreviato': ['T0002.D01.1.001.002.004.004.003'],
        'Micro':      ['T0003.D01.1.001.002.004.004.003']
      }
    },

    'imposte_anticipate': {
      voce: 'imposte anticipate',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.004.008.000.000'], // 5-ter
        'Abbreviato': ['T0002.D01.1.001.002.004.004.004'],
        'Micro': ['T0003.D01.1.001.002.004.004.004']
      }
    },
    
    'totale_crediti': {
      voce: 'Totale crediti',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.004.010.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.004.004.005'],
        'Micro': ['T0003.D01.1.001.002.004.004.005']
      }
    },

    'attivita_finanziarie_non_immob': {
      voce: 'III - Attivit√† finanziarie che non costituiscono immobilizzazioni',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.005.010.000.000'], // Totale
        'Abbreviato': ['T0002.D01.1.001.002.004.005.000'],
        'Micro': ['T0003.D01.1.001.002.004.005.000']
      }
    },
    
    'disponibilita_liquide': {
      voce: 'IV - Disponibilit√† liquide',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.006.005.000.000'], // Totale
        'Abbreviato': ['T0002.D01.1.001.002.004.006.000'],
        'Micro': ['T0003.D01.1.001.002.004.006.000']
      }
    },
    
    'totale_attivo_circolante': {
      voce: 'Totale attivo circolante (C)',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.004.007.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.004.007.000'],
        'Micro': ['T0003.D01.1.001.002.004.007.000']
      }
    },

    'ratei_risconti_attivi': {
      voce: 'D) Ratei e risconti',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.005.000.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.005.000.000'],
        'Micro': ['T0003.D01.1.001.002.005.000.000']
      }
    },
    
    'totale_attivo': {
      voce: 'Totale attivo',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.002.006.000.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.002.006.000.000'],
        'Micro': ['T0003.D01.1.001.002.006.000.000']
      }
    },

    // PASSIVO
    'capitale': {
      voce: 'I - Capitale',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.002.002.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.002.002.000'],
        'Micro': ['T0003.D01.1.001.003.002.002.000']
      }
    },

    // RISERVE AGGREGATE (II+III+IV+V+VI+VII+VIII+Perdita ripianata+X)
    'riserve': {
      voce: 'Riserve (somma II, III, IV, V, VI, VII, VIII, perdita ripianata, X)',
      calcolo: {
        'Ordinario': [
          'T0001.D01.1.001.003.002.003.000.000.000', // II Soprapprezzo
          'T0001.D01.1.001.003.002.004.000.000.000', // III Rivalutazione
          'T0001.D01.1.001.003.002.005.000.000.000', // IV Legale
          'T0001.D01.1.001.003.002.006.000.000.000', // V Statutarie
          'T0001.D01.1.001.003.002.007.015.000.000', // VI Altre (totale)
          'T0001.D01.1.001.003.002.008.000.000.000', // VII Copertura flussi
          'T0001.D01.1.001.003.002.009.000.000.000', // VIII Utili portati
          'T0001.D01.1.001.003.002.011.000.000.000', // Perdita ripianata
          'T0001.D01.1.001.003.002.012.000.000.000'  // X Azioni proprie
        ],
        'Abbreviato': [
          'T0002.D01.1.001.003.002.003.000', // II
          'T0002.D01.1.001.003.002.004.000', // III
          'T0002.D01.1.001.003.002.005.000', // IV
          'T0002.D01.1.001.003.002.006.000', // V
          'T0002.D01.1.001.003.002.007.000', // VI
          'T0002.D01.1.001.003.002.008.000', // VII
          'T0002.D01.1.001.003.002.009.000', // VIII
          'T0002.D01.1.001.003.002.011.000', // Perdita ripianata
          'T0002.D01.1.001.003.002.012.000'  // X
        ],
        'Micro': [
          'T0003.D01.1.001.003.002.003.000', // II
          'T0003.D01.1.001.003.002.004.000', // III
          'T0003.D01.1.001.003.002.005.000', // IV
          'T0003.D01.1.001.003.002.006.000', // V
          'T0003.D01.1.001.003.002.007.000', // VI
          'T0003.D01.1.001.003.002.008.000', // VIII (no VII nel micro)
          'T0003.D01.1.001.003.002.010.000', // Perdita ripianata
          'T0003.D01.1.001.003.002.011.000'  // X
        ]
      }
    },

    'utile_perdita': {
      voce: 'IX - Utile (perdita) dell\'esercizio',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.002.010.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.002.010.000'],
        'Micro': ['T0003.D01.1.001.003.002.009.000']
      }
    },
    
    'totale_patrimonio_netto': {
      voce: 'Totale patrimonio netto',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.002.013.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.002.013.000'],
        'Micro': ['T0003.D01.1.001.003.002.012.000']
      }
    },

    'fondi_rischi_oneri': {
      voce: 'B) Fondi per rischi e oneri',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.003.006.000.000.000'], // Totale
        'Abbreviato': ['T0002.D01.1.001.003.003.000.000'],
        'Micro': ['T0003.D01.1.001.003.003.000.000']
      }
    },
    
    'tfr': {
      voce: 'C) Trattamento di fine rapporto di lavoro subordinato',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.004.000.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.004.000.000'],
        'Micro': ['T0003.D01.1.001.003.004.000.000']
      }
    },

    // DEBITI - ATTENZIONE ALLE AGGREGAZIONI
    'debiti_entro': {
      voce: 'esigibili entro l\'esercizio successivo',
      calcolo: {
        'Ordinario': [
          // SOMMA di tutti i debiti entro
          'T0001.D01.1.001.003.005.002.002.000.000', // obbligazioni entro
          'T0001.D01.1.001.003.005.003.002.000.000', // obbligazioni convertibili entro
          'T0001.D01.1.001.003.005.004.002.000.000', // soci entro
          'T0001.D01.1.001.003.005.005.002.000.000', // banche entro
          'T0001.D01.1.001.003.005.006.002.000.000', // altri finanziatori entro
          'T0001.D01.1.001.003.005.007.002.000.000', // acconti entro
          'T0001.D01.1.001.003.005.008.002.000.000', // fornitori entro
          'T0001.D01.1.001.003.005.009.002.000.000', // titoli di credito entro
          'T0001.D01.1.001.003.005.010.002.000.000', // controllate entro
          'T0001.D01.1.001.003.005.011.002.000.000', // collegate entro
          'T0001.D01.1.001.003.005.012.002.000.000', // controllanti entro
          'T0001.D01.1.001.003.005.013.002.000.000', // sottoposte entro
          'T0001.D01.1.001.003.005.014.002.000.000', // tributari entro
          'T0001.D01.1.001.003.005.015.002.000.000', // previdenza entro
          'T0001.D01.1.001.003.005.016.002.000.000'  // altri entro
        ],
        'Abbreviato': ['T0002.D01.1.001.003.005.002.000'],
        'Micro':      ['T0003.D01.1.001.003.005.002.000']
      }
    },

    'debiti_oltre': {
      voce: 'esigibili oltre l\'esercizio successivo',
      calcolo: {
        'Ordinario': [
          // SOMMA di tutti i debiti oltre
          'T0001.D01.1.001.003.005.002.003.000.000', // obbligazioni oltre
          'T0001.D01.1.001.003.005.003.003.000.000', // obbligazioni convertibili oltre
          'T0001.D01.1.001.003.005.004.003.000.000', // soci oltre
          'T0001.D01.1.001.003.005.005.003.000.000', // banche oltre
          'T0001.D01.1.001.003.005.006.003.000.000', // altri finanziatori oltre
          'T0001.D01.1.001.003.005.007.003.000.000', // acconti oltre
          'T0001.D01.1.001.003.005.008.003.000.000', // fornitori oltre
          'T0001.D01.1.001.003.005.009.003.000.000', // titoli di credito oltre
          'T0001.D01.1.001.003.005.010.003.000.000', // controllate oltre
          'T0001.D01.1.001.003.005.011.003.000.000', // collegate oltre
          'T0001.D01.1.001.003.005.012.003.000.000', // controllanti oltre
          'T0001.D01.1.001.003.005.013.003.000.000', // sottoposte oltre
          'T0001.D01.1.001.003.005.014.003.000.000', // tributari oltre
          'T0001.D01.1.001.003.005.015.003.000.000', // previdenza oltre
          'T0001.D01.1.001.003.005.016.003.000.000'  // altri oltre
        ],
        'Abbreviato': ['T0002.D01.1.001.003.005.003.000'],
        'Micro':      ['T0003.D01.1.001.003.005.003.000']
      }
    },

    'totale_debiti': {
      voce: 'Totale debiti',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.005.017.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.005.004.000'],
        'Micro': ['T0003.D01.1.001.003.005.004.000']
      }
    },

    'ratei_risconti_passivi': {
      voce: 'E) Ratei e risconti',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.006.000.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.006.000.000'],
        'Micro': ['T0003.D01.1.001.003.006.000.000']
      }
    },
    
    'totale_passivo': {
      voce: 'Totale passivo',
      calcolo: {
        'Ordinario': ['T0001.D01.1.001.003.007.000.000.000.000'],
        'Abbreviato': ['T0002.D01.1.001.003.007.000.000'],
        'Micro': ['T0003.D01.1.001.003.007.000.000']
      }
    }
  }, // chiude SP

  'CE': {
    // A) VALORE DELLA PRODUZIONE
    'ricavi_vendite': {
      voce: '1) ricavi delle vendite e delle prestazioni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.002.000.000'],
        'Abbreviato': ['T0006.D01.1.001.002.002.000.000'],
        'Micro': ['T0007.D01.1.001.002.002.000.000']
      }
    },
    
    'variazioni_rimanenze_prodotti': {
      voce: '2) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.003.000.000'],
        'Abbreviato': ['T0006.D01.1.001.002.003.002.000'],
        'Micro': ['T0007.D01.1.001.002.003.002.000']
      }
    },
    
    'variazioni_lavori_corso': {
      voce: '3) variazioni dei lavori in corso su ordinazione',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.004.000.000'],
        'Abbreviato': ['T0006.D01.1.001.002.003.003.000'],
        'Micro': ['T0007.D01.1.001.002.003.003.000']
      }
    },
    
    'incrementi_immobilizzazioni': {
      voce: '4) incrementi di immobilizzazioni per lavori interni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.005.000.000'],
        'Abbreviato': ['T0006.D01.1.001.002.004.000.000'],
        'Micro': ['T0007.D01.1.001.002.004.000.000']
      }
    },
    
    'altri_ricavi': {
      voce: '5) altri ricavi e proventi',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.006.004.000'],  // Totale altri ricavi
        'Abbreviato': ['T0006.D01.1.001.002.005.004.000'],
        'Micro': ['T0007.D01.1.001.002.005.004.000']
      }
    },
    
    'totale_valore_produzione': {
      voce: 'Totale valore della produzione',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.002.007.000.000'],
        'Abbreviato': ['T0006.D01.1.001.002.006.000.000'],
        'Micro': ['T0007.D01.1.001.002.006.000.000']
      }
    },

    // B) COSTI DELLA PRODUZIONE
    'materie_prime': {
      voce: '6) per materie prime, sussidiarie, di consumo e di merci',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.002.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.002.000.000'],
        'Micro': ['T0007.D01.1.001.003.002.000.000']
      }
    },
    
    'servizi': {
      voce: '7) per servizi',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.003.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.003.000.000'],
        'Micro': ['T0007.D01.1.001.003.003.000.000']
      }
    },
    
    'godimento_beni_terzi': {
      voce: '8) per godimento di beni di terzi',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.004.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.004.000.000'],
        'Micro': ['T0007.D01.1.001.003.004.000.000']
      }
    },
    
    'costi_personale': {
      voce: '9) per il personale',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.005.007.000'],  // Totale costi personale
        'Abbreviato': ['T0006.D01.1.001.003.005.005.000'],
        'Micro': ['T0007.D01.1.001.003.005.005.000']
      }
    },
    
    'ammortamenti_svalutazioni': {
      voce: '10) ammortamenti e svalutazioni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.006.006.000'],  // Totale ammortamenti
        'Abbreviato': ['T0006.D01.1.001.003.006.004.000'],
        'Micro': ['T0007.D01.1.001.003.006.004.000']
      }
    },
    
    'variazioni_rimanenze_materie': {
      voce: '11) variazioni delle rimanenze di materie prime, sussidiarie, di consumo e merci',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.007.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.007.000.000'],
        'Micro': ['T0007.D01.1.001.003.007.000.000']
      }
    },
    
    'accantonamenti_rischi': {
      voce: '12) accantonamenti per rischi',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.008.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.008.000.000'],
        'Micro': ['T0007.D01.1.001.003.008.000.000']
      }
    },
    
    'altri_accantonamenti': {
      voce: '13) altri accantonamenti',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.009.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.009.000.000'],
        'Micro': ['T0007.D01.1.001.003.009.000.000']
      }
    },
    
    'oneri_diversi_gestione': {
      voce: '14) oneri diversi di gestione',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.010.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.010.000.000'],
        'Micro': ['T0007.D01.1.001.003.010.000.000']
      }
    },
    
    'totale_costi_produzione': {
      voce: 'Totale costi della produzione',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.003.011.000.000'],
        'Abbreviato': ['T0006.D01.1.001.003.011.000.000'],
        'Micro': ['T0007.D01.1.001.003.011.000.000']
      }
    },
    
    'differenza_valore_costi': {
      voce: 'Differenza tra valore e costi della produzione (A - B)',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.004.000.000.000'],
        'Abbreviato': ['T0006.D01.1.001.004.000.000.000'],
        'Micro': ['T0007.D01.1.001.004.000.000.000']
      }
    },

    // C) PROVENTI E ONERI FINANZIARI
    'proventi_partecipazioni': {
      voce: '15) proventi da partecipazioni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.005.002.006.000'],  // Totale proventi partecipazioni
        'Abbreviato': ['T0006.D01.1.001.005.002.003.000'],
        'Micro': ['T0007.D01.1.001.005.002.003.000']
      }
    },
    
    'altri_proventi_finanziari': {
      voce: '16) altri proventi finanziari',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.005.003.006.000'],  // Totale altri proventi
        'Abbreviato': ['T0006.D01.1.001.005.003.002.000'],
        'Micro': ['T0007.D01.1.001.005.003.002.000']
      }
    },
    
    'interessi_oneri_finanziari': {
      voce: '17) interessi e altri oneri finanziari',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.005.004.007.000'],  // Totale interessi e oneri
        'Abbreviato': ['T0006.D01.1.001.005.004.003.000'],
        'Micro': ['T0007.D01.1.001.005.004.003.000']
      }
    },
    
    'utili_perdite_cambi': {
      voce: '17-bis) utili e perdite su cambi',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.005.005.000.000'],
        'Abbreviato': ['T0006.D01.1.001.005.005.000.000'],
        'Micro': ['T0007.D01.1.001.005.005.000.000']
      }
    },
    
    'totale_proventi_oneri_finanziari': {
      voce: 'Totale proventi e oneri finanziari (15 + 16 - 17 + - 17-bis)',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.005.006.000.000'],
        'Abbreviato': ['T0006.D01.1.001.005.006.000.000'],
        'Micro': ['T0007.D01.1.001.005.006.000.000']
      }
    },

    // D) RETTIFICHE DI VALORE DI ATTIVIT√Ä E PASSIVIT√Ä FINANZIARIE
    'rivalutazioni': {
      voce: '18) rivalutazioni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.006.002.006.000'],  // Totale rivalutazioni
        'Abbreviato': ['T0006.D01.1.001.006.002.002.000'],
        'Micro': ['T0007.D01.1.001.006.002.002.000']
      }
    },
    
    'svalutazioni': {
      voce: '19) svalutazioni',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.006.003.006.000'],  // Totale svalutazioni
        'Abbreviato': ['T0006.D01.1.001.006.003.002.000'],
        'Micro': ['T0007.D01.1.001.006.003.002.000']
      }
    },
    
    'totale_rettifiche': {
      voce: 'Totale delle rettifiche di valore di attivit√† e passivit√† finanziarie (18 - 19)',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.006.004.000.000'],
        'Abbreviato': ['T0006.D01.1.001.006.004.000.000'],
        'Micro': ['T0007.D01.1.001.006.004.000.000']
      }
    },
    
    'risultato_prima_imposte': {
      voce: 'Risultato prima delle imposte (A - B + - C + - D)',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.007.000.000.000'],
        'Abbreviato': ['T0006.D01.1.001.007.000.000.000'],
        'Micro': ['T0007.D01.1.001.007.000.000.000']
      }
    },
    
'imposte': {
  voce: '20) Imposte totali',
  calcolo: {
    'Ordinario': ['T0005.D01.1.001.008.006.000.000'], 
    'Abbreviato': ['T0006.D01.1.001.008.006.000.000'],
    'Micro': ['T0007.D01.1.001.008.006.000.000']
  }
},
'imposte_correnti': {
  voce: 'Imposte correnti',
  calcolo: {
    'Ordinario': ['T0005.D01.1.001.008.002.000.000'],
    'Abbreviato': ['T0006.D01.1.001.008.002.000.000'],
    'Micro': ['T0007.D01.1.001.008.002.000.000']
  }
},
'imposte_precedenti': {
  voce: 'Imposte esercizi precedenti',
  calcolo: {
    'Ordinario': ['T0005.D01.1.001.008.005.002.000'],
    'Abbreviato': [],
    'Micro': []
  }
},
'imposte_diff_antic': {
  voce: 'Imposte differite e anticipate',
  calcolo: {
    'Ordinario': ['T0005.D01.1.001.008.005.003.000'],
    'Abbreviato': [],
    'Micro': []
  }
},

    'utile_perdita_esercizio': {
      voce: '21) Utile (perdita) dell\'esercizio',
      calcolo: {
        'Ordinario': ['T0005.D01.1.001.009.000.000.000'],
        'Abbreviato': ['T0006.D01.1.001.009.000.000.000'],
        'Micro': ['T0007.D01.1.001.009.000.000.000']
      }
    }
  } // chiude CE
}; // chiude MAPPING_STANDARDIZZATO


/* ====== UTILITIES ====== */
const byId = (id) => document.getElementById(id);
// Converte qualsiasi input (seriale Excel, "31/12/2020", "2020-12-31", "2020") in anno "YYYY"
function _coerceYear(any) {
  if (any == null) return null;
  const s = String(any).trim();

  // 1) match gg/mm/aaaa
  let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m) {
    let y = parseInt(m[3], 10);
    if (y < 100) y = 2000 + y;
    return String(y);
  }

  // 2) match ISO o testo con anno
  m = s.match(/\b(20\d{2}|19\d{2})\b/);
  if (m) return m[1];

  // 3) numero -> prova come seriale Excel 1900-based
  const n = Number(s);
  if (!isNaN(n) && isFinite(n)) {
    const epoch = new Date(Date.UTC(1899, 11, 30)); // 1899-12-30
    const ms = n * 24 * 3600 * 1000;
    const d = new Date(epoch.getTime() + ms);
    const Y = d.getUTCFullYear();
    if (Y >= 1900 && Y <= 2100) return String(Y);
  }

  // üß© 4) filtro di sicurezza finale ‚Äî aggiungi qui
  if (!/^(19|20)\d{2}$/.test(s)) return null;

  // 5) fallback: restituisci com'√® (solo se √® effettivamente un anno valido)
  return s;
}

// Normalizza state.anni in-place (prev/last) a "YYYY"
function _fixAnniState() {
  if (!state.anni) state.anni = { prev: null, last: null };
  if (state.anni.prev != null) state.anni.prev = _coerceYear(state.anni.prev);
  if (state.anni.last != null) state.anni.last = _coerceYear(state.anni.last);
}

const itFmt = (n) => {
    if (n === null || n === undefined || n === "") return ""; 
    const v = Number(n); 
    if (!isFinite(v)) return ""; 
    if (v < 0) {
        const s = Math.abs(v).toFixed(2); 
        const p = s.split("."); 
        p[0] = p[0].replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
        return "‚àí" + p.join(",");
    }
    const s = v.toFixed(2); 
    const p = s.split("."); 
    p[0] = p[0].replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
    return p.join(",");
};

const norm = (s) => String(s || "").toLowerCase().replace(/['']/g, "'").replace(/[^a-z0-9√†√®√©√¨√≤√π()\- ]+/g, " ").replace(/\s+/g, " ").trim();


function importXls(ws, tipo, sezione) {
    // VERIFICA CHE TASSONOMIA_MAPPING ABBIA ANCHE "Micro"
    if (!TASSONOMIA_MAPPING[tipo]) {
        console.error('Tipo bilancio non trovato nel mapping:', tipo);
        return {};
    }
    
    const mapping = TASSONOMIA_MAPPING[tipo][sezione];
    if (!mapping) {
        console.error('Sezione non trovata nel mapping:', sezione, 'per tipo:', tipo);
        return {};
    }
    
    const result = {};
    
    // 1. Inizializza TUTTE le voci con null
    Object.keys(mapping).forEach(codice => {
        result[codice] = {
            voce: mapping[codice].voce,
            last: null,
            prev: null
        };
    });
    
    if (!ws || !ws["!ref"]) return result;
    
    // 2. Leggi dal foglio usando CODICI univoci
    const range = XLSX.utils.decode_range(ws["!ref"]);
    for (let r = 10; r <= range.e.r; r++) { // Inizia da riga 10
        const cellA = ws[XLSX.utils.encode_cell({r, c: 0})]; // Colonna A - CODICE
        const cellD = ws[XLSX.utils.encode_cell({r, c: 3})]; // Colonna D - anno N
        const cellE = ws[XLSX.utils.encode_cell({r, c: 4})]; // Colonna E - anno N-1
        const codice = cellA ? String(cellA.v).trim() : "";
        
        // Se il codice esiste nel mapping
        if (mapping[codice]) {
            const valN = cellD ? Number(cellD.v) : null;
            const valN1 = cellE ? Number(cellE.v) : null;
            
            result[codice].last = valN;
            result[codice].prev = valN1;
        }
    }
    return result;
}

function importXbrl(xml, tipo, sezione, contexts, itccUris) {
    const mapping = TASSONOMIA_MAPPING[tipo][sezione];
    const result = {};

    // 1) Inizializza tutte le voci a null (comportamento invariato)
    Object.keys(mapping).forEach(codice => {
        result[codice] = {
            voce: mapping[codice].voce,
            last: null,
            prev: null
        };
    });

    // 2) Gestione contesti (comportamento invariato)
    const isBalance = (sezione === 'SP');
    const ctxPrefN = isBalance ? (contexts.instant?.[0]?.id || '') : (contexts.duration?.[0]?.id || '');
    const ctxPrefP = isBalance ? (contexts.instant?.[1]?.id || '') : (contexts.duration?.[1]?.id || '');
    const ctxPool = (isBalance ? (contexts.instant || []) : (contexts.duration || []))
        .map(c => c?.id || '')
        .filter(Boolean);

    // 3) Risoluzione valori per ciascun T-code (importazione "Piano A")
    Object.keys(mapping).forEach(codice => {
        const info = mapping[codice];
        // Se per qualche motivo manca la voce xbrl nel mapping, salta per evitare errori
        if (!info || !info.xbrl) return;
        
        const xbrlTag = 'itcc-ci:' + info.xbrl;

        const valN = findByQNameWithFallback(xml, xbrlTag, ctxPrefN, itccUris, ctxPool);
        const valP = findByQNameWithFallback(xml, xbrlTag, ctxPrefP, itccUris, ctxPool);

        result[codice].last = parseNumITSafe(valN);
        result[codice].prev = parseNumITSafe(valP);
    });

// ===== INIZIO LOGICA DI FALLBACK PER XBRL ORDINARIO (PIANO B) =====
    // COMMENTATO: Questo fallback crea problemi perch√© mette TUTTI i crediti/debiti aggregati
    // in una sola voce (clienti/fornitori) invece di distribuirli correttamente
    
    /* BLOCCO DISATTIVATO - Gloria 03/10/2025
    if (tipo === 'Ordinario' && sezione === 'SP') {
        
        // Controllo: verifichiamo se l'importazione dettagliata ha fallito (somma dei crediti √® zero)
        const codiciCreditiDettagliati = MAPPING_STANDARDIZZATO['SP']['crediti_entro']['calcolo']['Ordinario'];
        const sommaControllo = codiciCreditiDettagliati.reduce((sum, codice) => {
            return sum + (result[codice]?.last || 0);
        }, 0);
        
        // Se la somma √® zero, attiviamo il Piano B
        if (sommaControllo === 0) {
            console.warn("Dettaglio Ordinario non trovato. Attivazione fallback su tag aggregati.");
            
            // Mappatura di fallback: Tag Aggregato -> T-Code dettagliato in cui "iniettare" il valore
            const fallbackMap = {
                // Crediti
                'CreditiEsigibiliEntroEsercizioSuccessivo': 'T0001.D01.1.001.002.004.004.002.002.000', // Iniettiamo in Crediti v/clienti entro
                'CreditiEsigibiliOltreEsercizioSuccessivo': 'T0001.D01.1.001.002.004.004.002.003.000', // Iniettiamo in Crediti v/clienti oltre
                // Debiti
                'DebitiEsigibiliEntroEsercizioSuccessivo': 'T0001.D01.1.001.003.005.008.002.000.000',  // Iniettiamo in Debiti v/fornitori entro
                'DebitiEsigibiliOltreEsercizioSuccessivo': 'T0001.D01.1.001.003.005.008.003.000.000'   // Iniettiamo in Debiti v/fornitori oltre
            };
            
            Object.entries(fallbackMap).forEach(([tagAggregato, tcodeDestinazione]) => {
                const xbrlTag = 'itcc-ci:' + tagAggregato;
                
                // Cerchiamo il valore del tag aggregato nel file XBRL
                const valN = findByQNameWithFallback(xml, xbrlTag, ctxPrefN, itccUris, ctxPool);
                const valP = findByQNameWithFallback(xml, xbrlTag, ctxPrefP, itccUris, ctxPool);
                
                // Se troviamo un valore, lo "iniettiamo" nella voce di dettaglio corrispondente
                if (valN !== null && result[tcodeDestinazione]) {
                    console.log(`Fallback Trovato per ${tagAggregato} (anno corrente): ${valN}`);
                    result[tcodeDestinazione].last = parseNumITSafe(valN);
                }
                if (valP !== null && result[tcodeDestinazione]) {
                    console.log(`Fallback Trovato per ${tagAggregato} (anno precedente): ${valP}`);
                    result[tcodeDestinazione].prev = parseNumITSafe(valP);
                }
            });
        }
    }
    */
    // ===== FINE LOGICA DI FALLBACK DISATTIVATA =====
    
    return result;
}

// Funzione di supporto per l'importazione XBRL (NECESSARIA)
function findByQNameWithFallback(xml, qname, ctxId, itccUris, ctxPool) {
  // 1) Prova risoluzione classica con il context specifico
  let v = findByQName(xml, qname, ctxId, itccUris);
  if (v !== null && v !== undefined && v !== '') return v;

  // 2) Se fallisce, prova tutti i context passati
  if (Array.isArray(ctxPool)) {
    for (const ctx of ctxPool) {
      v = findByQName(xml, qname, ctx?.id || '', itccUris);
      if (v !== null && v !== undefined && v !== '') return v;
    }
  }

  // 3) Fallback brutale: prendi il PRIMO tag con quel QName (senza vincolo di context)
  try {
    const [prefix, local] = qname.split(':');
    const ns = itccUris && itccUris[prefix] ? itccUris[prefix] : null;
    if (!ns) return null;
    
    const xpath = `//*[namespace-uri()="${ns}" and local-name()="${local}"]`;
    const it = xml.evaluate(xpath, xml, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
    if (it.snapshotLength > 0) {
      const node = it.snapshotItem(0);
      const raw = (node.textContent || '').trim();
      if (raw !== '') return raw;
    }
  } catch (_) {}
  return null;
}

// Funzione di supporto per l'importazione XBRL (NECESSARIA)
function parseNumITSafe(v) {
  if (v === null || v === undefined || v === '') return null;
  const s = String(v).trim()
    .replace(/\./g, '')     // separatore migliaia
    .replace(/,/g, '.');    // decimale
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

/* ====== Funzioni per Anagrafica Attiva ====== */
function getAnagraficaAttiva() {
    try {
        const stored = localStorage.getItem('ceodoc_anagrafica_attiva');
        return stored ? JSON.parse(stored) : null;
    } catch(e) {
        return null;
    }
}

function normalizzaCF(cf) {
    return String(cf || '').replace(/\s/g, '').toUpperCase().trim();
}

/* ====== Aggiorna Header Azienda ====== */
function aggiornaHeaderAzienda() {
    const anagrafica = getAnagraficaAttiva();
    const denomTop = byId("denomTop");
    const cfTop = byId("cfTop");
    
    if (anagrafica && anagrafica.cf) {
        // Usa dati da anagrafica attiva
        if (denomTop) denomTop.textContent = anagrafica.ragioneSociale || "‚Äî";
        if (cfTop) cfTop.textContent = anagrafica.cf || "‚Äî";
        
        // Aggiorna anche state per coerenza
        state.denom = anagrafica.ragioneSociale || state.denom;
        state.cf = anagrafica.cf || state.cf;
    } else if (state.denom || state.cf) {
        // Usa dati da state se disponibili
        if (denomTop) denomTop.textContent = state.denom || "‚Äî";
        if (cfTop) cfTop.textContent = state.cf || "‚Äî";
    } else {
        // Placeholder vuoti
        if (denomTop) denomTop.textContent = "‚Äî";
        if (cfTop) cfTop.textContent = "‚Äî";
    }
}

/* ====== Funzioni per Licenza ====== */
function getLicenzaInfo() {
    try {
        const stored = localStorage.getItem('ceodoc_licenza_info');
        return stored ? JSON.parse(stored) : null;
    } catch(e) {
        return null;
    }
}

function hasFullLicense() {
    const licenzaInfo = getLicenzaInfo();
    if (!licenzaInfo) return false;
    
    const tipoDescrittivo = {
        'CRISK1': 'Centrale Rischi',
        'BILANCI4': 'Pacchetto Bilanci',
        'COMPLIANCE5': 'Compliance & ESG',
        'PLANNING3': 'Planning & Business Plan',
        'FULL15': 'Completo - Tutti i Moduli'
    };
    
    const tipo = tipoDescrittivo[licenzaInfo.type];
    if (tipo !== 'Completo - Tutti i Moduli') return false;
    
    const activationDate = decodeDate(licenzaInfo.encodedDate);
    const [year, month, day] = activationDate.split('-');
    const activation = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    activation.setHours(0, 0, 0, 0);
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const daysPassed = Math.floor((today - activation) / (1000 * 60 * 60 * 24));
    const isExpired = daysPassed > licenzaInfo.duration;
    
    return !isExpired;
}

function decodeDate(encodedDate) {
    const DATE_MAP = {
        'a':'0', 'b':'1', 'c':'2', 'd':'3', 'e':'4',
        'f':'5', 'g':'6', 'h':'7', 'i':'8', 'j':'9'
    };
    let decoded = encodedDate;
    for (const [letter, number] of Object.entries(DATE_MAP)) {
        decoded = decoded.replace(new RegExp(letter, 'g'), number);
    }
    return decoded;
}

// =====================================================
// üîî FUNZIONE TOAST MODERNA (notifiche eleganti ceoDOC)
// =====================================================
window.toast = function (message, isError = false, type = "info") {
  // Crea contenitore se non esiste
  let container = document.getElementById("toast-container");
  if (!container) {
    container = document.createElement("div");
    container.id = "toast-container";
    container.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999999;
      pointer-events: none;
    `;
    document.body.appendChild(container);
  }

  // Colori dinamici
  let bg = "#2563eb"; // blu (info)
  if (type === "success") bg = "#16a34a"; // verde
  if (type === "warning") bg = "#f59e0b"; // arancio
  if (type === "error" || isError) bg = "#dc2626"; // rosso

  // Crea il toast
  const toast = document.createElement("div");
  toast.innerHTML = message;
  toast.style.cssText = `
    background: ${bg};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    font-family: 'Segoe UI', Arial, sans-serif;
    font-size: 14px;
    font-weight: 500;
    animation: slideIn 0.3s ease-out;
    pointer-events: all;
  `;

  // Animazione di entrata
  toast.animate([{ opacity: 0, transform: "translateX(50px)" }, { opacity: 1, transform: "translateX(0)" }], {
    duration: 250,
    fill: "forwards"
  });

  // Mostra il toast
  container.appendChild(toast);

  // Rimuove automaticamente dopo 4 secondi
  setTimeout(() => {
    toast.animate([{ opacity: 1 }, { opacity: 0, transform: "translateX(50px)" }], { duration: 300 });
    setTimeout(() => toast.remove(), 300);
  }, 4000);
};


/* ====== NAVIGATION ====== */
function showTab(tabName, evt) {
    // Rimuovi active da tutti i tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Aggiungi active al tab selezionato
    if (evt && evt.target) {
        evt.target.classList.add('active');
    } else {
        const tabButton = byId(tabName + 'Tab');
        if (tabButton) {
            tabButton.classList.add('active');
        }
    }
    
    // Nascondi tutte le content areas
    document.querySelectorAll('.content-area').forEach(area => {
        area.classList.remove('active');
    });
    
    // Mostra la content area selezionata
    const contentArea = byId(tabName + 'Content');
    if (contentArea) {
        contentArea.classList.add('active');
    }
    
    // Aggiorna workflow steps
    updateWorkflowSteps(tabName);
}

function updateWorkflowSteps(currentTab) {
    const stepMap = {
        'import': 1,
        'bilanci': 2,
        'predisponi': 3,
        'rating': 4,
        'analisi': 5
    };
    
    const currentStep = stepMap[currentTab];
    
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < currentStep - 1) {
            step.classList.add('completed');
        } else if (index === currentStep - 1) {
            step.classList.add('active');
        }
    });
}

/* ====== SETTORE SELECTION ====== */
function selectSettore(settore) {
    state.settore = settore;
    
    const display = byId('settoreDisplay');
    if (display) {
        display.textContent = `Settore: ${settore}`;
        display.style.background = '#d4edda';
        display.style.color = '#155724';
    }
    
    toast(`Settore selezionato: ${settore}`);
}


// =====================================================
// üîÑ Aggiorna codice ATECO + associa categoria Allerta Crisi
// =====================================================
function aggiornaAteco(codiceAteco) {
    if (!codiceAteco || codiceAteco === "") return;
    
    // Aggiorna nello stato
    state.codiceAteco = codiceAteco;
    
    // Aggiorna display
    const displayAteco = byId('valoreAteco');
    if (displayAteco) {
        displayAteco.textContent = codiceAteco;
    }
    
    // Salva in anagrafica attiva se esiste
    const anagraficaAttiva = getAnagraficaAttiva();
    if (anagraficaAttiva) {
        anagraficaAttiva.codiceAteco = codiceAteco;
        localStorage.setItem('ceodoc_anagrafica_attiva', JSON.stringify(anagraficaAttiva));
    }

    // üß≠ Associa automaticamente la categoria Allerta Crisi e soglie
    if (typeof getCategoriaAllertaDaAteco === "function") {
        const info = getCategoriaAllertaDaAteco(codiceAteco);
        state.categoriaAllerta = info.categoria;
        state.soglieAllerta = info.soglie;
        console.log(`Settore Allerta Crisi: ${info.categoria}`, info.soglie);
    }

    console.log('ATECO aggiornato:', codiceAteco);
}

function updateTipoBilancio(tipo) {
    state.tipo = tipo;
    
    const display = byId('tipoBilDisplay');
    if (display && tipo) {
        display.textContent = tipo;
        display.style.background = '#d4edda';
        display.style.color = '#155724';
        
    }
}

function updateAnniConsuntivi(prev, last) {
  // normalizza
  const yPrev = _coerceYear(prev);
  const yLast = _coerceYear(last);

  // ordina se entrambi presenti
  let A = yPrev, B = yLast;
  if (A && B && +A > +B) { const tmp = A; A = B; B = tmp; }

  // applica allo state
  state.anni.prev = A || null;
  state.anni.last = B || null;

  // UI box compatta in alto
  const display = byId('eserciziDisplay');
  if (display) {
    if (state.anni.prev && state.anni.last) {
      display.textContent = `31/12/${state.anni.prev} - 31/12/${state.anni.last}`;
      display.style.background = '#d4edda';
      display.style.color = '#155724';
    } else if (state.anni.last || state.anni.prev) {
      const y = state.anni.last || state.anni.prev;
      display.textContent = `31/12/${y}`;
      display.style.background = '#fff7ed'; // arancio chiaro
      display.style.color = '#92400e';
    } else {
      display.textContent = '‚Äî';
      display.style.background = '';
      display.style.color = '';
    }
  }
}



/* ====== RENDERING TABELLE ====== */
function renderTables() {
  const spBody = byId("sp-body");
  const ceBody = byId("ce-body");
  if (!spBody || !ceBody) return;

  // pulizia body
  spBody.innerHTML = "";
  ceBody.innerHTML = "";

  // filtri voci
  const filteredSpRows = (state.spRows || []).filter(r =>
    r.voce && !/^(nr_col|\d+)$/.test(r.voce) && r.voce.trim() !== ""
  );
  const filteredCeRows = (state.ceRows || []).filter(r =>
    r.voce && !/^(nr_col|\d+)$/.test(r.voce) && r.voce.trim() !== ""
  );

  // render righe (rowTr gi√† rispetta SHOW_DELTA_ORIGINALI)
  for (const r of filteredSpRows) spBody.appendChild(rowTr(r));
  for (const r of filteredCeRows) ceBody.appendChild(rowTr(r));

  // titolini (tipo)
  byId("sp-kind").textContent = state.tipo ? `(${state.tipo.toLowerCase()})` : "";
  byId("ce-kind").textContent = state.tipo ? `(${state.tipo.toLowerCase()})` : "";

  // ===== Gestione header Œî% senza affidarsi a id =====
  const tblSP = byId('tblSP');
  const tblCE = byId('tblCE');

  // helper per mostrare/nascondere l'ultimo TH di un thead
  const setHeaderDeltaVisible = (tableEl, visible) => {
    if (!tableEl) return;
    const ths = tableEl.querySelectorAll('thead tr th');
    if (!ths || ths.length === 0) return;
    const lastTh = ths[ths.length - 1]; // l'ultima colonna √® Œî%
    // se il layout ha 4 colonne (Voci, Prev, Last, Œî%), l'ultima √® la Œî%
    // se SHOW_DELTA_ORIGINALI=false, nascondila. Altrimenti mostrala.
    if (visible) {
      lastTh.style.display = '';
    } else {
      lastTh.style.display = 'none';
    }
  };

  setHeaderDeltaVisible(tblSP, !!window.SHOW_DELTA_ORIGINALI);
  setHeaderDeltaVisible(tblCE, !!window.SHOW_DELTA_ORIGINALI);

  // ===== Se Œî% OFF, assicura 3 TD per riga (rimuovi l‚Äôultimo se presente) =====
  if (!window.SHOW_DELTA_ORIGINALI) {
    document.querySelectorAll('#sp-body tr, #ce-body tr').forEach(tr => {
      // se per qualunque motivo la riga ha 4 celle, togli l'ultima (Œî%)
      if (tr.children.length >= 4) tr.lastElementChild.remove();
    });
  }
}

// --- mini utility per variazione percentuale (usata dagli "originali")
function _varPerc(last, prev) {
  const a = Number(last || 0), b = Number(prev || 0);
  if (!b) return a === 0 ? '‚Äî' : (a > 0 ? '+‚àû' : '-‚àû');
  const p = ((a - b) / Math.abs(b)) * 100;
  return (p > 0 ? '+' : '') + p.toFixed(1) + '%';
}


function rowTr(r) {
  const tr = document.createElement("tr");

  // Voce
  const tdv = document.createElement("td");
  tdv.className = "col-voce";
  tdv.textContent = r.voce || "";
  tr.appendChild(tdv);

  // Anno precedente
  const tdPrev = document.createElement("td");
  tdPrev.style.textAlign = "right";
  tdPrev.textContent = itFmt(r.prev);
  tr.appendChild(tdPrev);

  // Ultimo anno
  const tdLast = document.createElement("td");
  tdLast.style.textAlign = "right";
  tdLast.textContent = itFmt(r.last);
  tr.appendChild(tdLast);

  // Œî% (se il toggle √® attivo)
  if (window.SHOW_DELTA_ORIGINALI) {
    const tdVar = document.createElement("td");
    tdVar.style.textAlign = "center";
    const deltaText = _varPerc(r.last, r.prev);
    tdVar.textContent = deltaText;

    // (opzionale) colore: verde + / rosso - / grigio per '‚Äî' o '‚àû'
    if (deltaText !== '‚Äî' && !deltaText.includes('‚àû')) {
      const p = parseFloat(deltaText.replace('%',''));
      tdVar.style.color = isFinite(p) ? (p > 0 ? '#10b981' : (p < 0 ? '#dc2626' : '#374151')) : '#374151';
    } else {
      tdVar.style.color = '#6b7280';
    }

    tr.appendChild(tdVar);
  }

  return tr;
}

/* ====== Check di Controllo ====== */
const badge = (ok, text) => `<span class="badge ${ok ? 'badge-ok' : 'badge-ko'}">${text}</span>`;
const fmt = (val) => val != null ? itFmt(val) : "‚Äî";


function renderChecksCompleti(spRows, ceRows) {
    // Aggiorna gli header con gli anni
    const headerPrev = byId("check-anno-prev");
    const headerLast = byId("check-anno-last");
    if (headerPrev && state.anni.prev) {
        headerPrev.textContent = `31/12/${state.anni.prev}`;
    }
    if (headerLast && state.anni.last) {
        headerLast.textContent = `31/12/${state.anni.last}`;
    }
    
    // POPOLA CARD ANNO PRECEDENTE
    const boxPrev = byId("checks-prev");
    if (boxPrev) {
        boxPrev.innerHTML = "";
        
        // Check Totale Attivo = Passivo ANNO PRECEDENTE
        const spTA = spRows.find(r => r.voce === "Totale attivo");
        const spTP = spRows.find(r => r.voce === "Totale passivo");
        const prevOkSP = spTA && spTP && Math.abs((spTA.prev ?? 0) - (spTP.prev ?? 0)) < 0.5;
        
        boxPrev.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                <div>
                    <span class="badge ${prevOkSP ? 'badge-ok' : 'badge-ko'}">${prevOkSP ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(spTA ? spTA.prev : null)}</small>
                </div>
            </div>
        `;
        
        // Check Differenza A-B ANNO PRECEDENTE
        const ceDiff = ceRows.find(r => r.voce.includes("Differenza tra valore e costi"));
        const prevOkDiff = ceDiff && ceDiff.prev != null;
        
        boxPrev.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                <div>
                    <span class="badge ${prevOkDiff ? 'badge-ok' : 'badge-ko'}">${prevOkDiff ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceDiff ? ceDiff.prev : null)}</small>
                </div>
            </div>
        `;
        
        // Check RPI ANNO PRECEDENTE
        const ceRPI = ceRows.find(r => r.voce.includes("Risultato prima delle imposte"));
        const prevOkRPI = ceRPI && ceRPI.prev != null;
        
        boxPrev.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                <div>
                    <span class="badge ${prevOkRPI ? 'badge-ok' : 'badge-ko'}">${prevOkRPI ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceRPI ? ceRPI.prev : null)}</small>
                </div>
            </div>
        `;
        
        // Check Utile/Perdita ANNO PRECEDENTE
        const ceU = ceRows.find(r => r.voce.includes("Utile") && r.voce.includes("perdita"));
        const prevOkU = ceU && ceU.prev != null;
        
        boxPrev.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                <div>
                    <span class="badge ${prevOkU ? 'badge-ok' : 'badge-ko'}">${prevOkU ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceU ? ceU.prev : null)}</small>
                </div>
            </div>
        `;
    }
    
    // POPOLA CARD ULTIMO ANNO
    const boxLast = byId("checks");
    if (boxLast) {
        boxLast.innerHTML = "";
        
        // Check Totale Attivo = Passivo ULTIMO ANNO
        const spTA = spRows.find(r => r.voce === "Totale attivo");
        const spTP = spRows.find(r => r.voce === "Totale passivo");
        const lastOkSP = spTA && spTP && Math.abs((spTA.last ?? 0) - (spTP.last ?? 0)) < 0.5;
        
        boxLast.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                <div>
                    <span class="badge ${lastOkSP ? 'badge-ok' : 'badge-ko'}">${lastOkSP ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(spTA ? spTA.last : null)}</small>
                </div>
            </div>
        `;
        
        // Check Differenza A-B ULTIMO ANNO
        const ceDiff = ceRows.find(r => r.voce.includes("Differenza tra valore e costi"));
        const lastOkDiff = ceDiff && ceDiff.last != null;
        
        boxLast.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                <div>
                    <span class="badge ${lastOkDiff ? 'badge-ok' : 'badge-ko'}">${lastOkDiff ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceDiff ? ceDiff.last : null)}</small>
                </div>
            </div>
        `;
        
        // Check RPI ULTIMO ANNO
        const ceRPI = ceRows.find(r => r.voce.includes("Risultato prima delle imposte"));
        const lastOkRPI = ceRPI && ceRPI.last != null;
        
        boxLast.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                <div>
                    <span class="badge ${lastOkRPI ? 'badge-ok' : 'badge-ko'}">${lastOkRPI ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceRPI ? ceRPI.last : null)}</small>
                </div>
            </div>
        `;
        
        // Check Utile/Perdita ULTIMO ANNO
        const ceU = ceRows.find(r => r.voce.includes("Utile") && r.voce.includes("perdita"));
        const lastOkU = ceU && ceU.last != null;
        
        boxLast.innerHTML += `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                <div>
                    <span class="badge ${lastOkU ? 'badge-ok' : 'badge-ko'}">${lastOkU ? 'OK' : 'IN ATTESA'}</span>
                    <small style="margin-left: 10px; color: #6b7280;">${itFmt(ceU ? ceU.last : null)}</small>
                </div>
            </div>
        `;
    }
}

function pulisciChecks() {
    // Pulisci prima card (anno precedente)
    const boxPrev = byId("checks-prev");
    if (boxPrev) {
        boxPrev.innerHTML = `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
        `;
    }
    
    // Pulisci seconda card (ultimo anno)
    const boxLast = byId("checks");
    if (boxLast) {
        boxLast.innerHTML = `
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Totale Attivo = Totale Passivo</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Differenza A ‚àí B corrente</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #374151; font-size: 13px;">Risultato prima imposte</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
            <div class="control-item" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #374151; font-size: 13px;">Utile/Perdita esercizio</span>
                <span class="badge badge-ko">IN ATTESA</span>
            </div>
        `;
    }
    
    // Reset header anni
    const headerPrev = byId("check-anno-prev");
    const headerLast = byId("check-anno-last");
    if (headerPrev) headerPrev.textContent = "Anno Precedente";
    if (headerLast) headerLast.textContent = "Ultimo Anno";
}

/* ====== IMPORT XLS ====== */
/* ====== STRUTTURE TASSONOMIA COMPLETE ====== */

/* ====== HELPER FUNCTION PER LETTURA CELLE EXCEL ====== */
function getCell(ws, cellRef) {
    if (!ws || !cellRef) return null;
    const cell = ws[cellRef];
    if (!cell || cell.v === undefined || cell.v === null) return null;
    
    // Se √® un numero
    if (cell.t === 'n') {
        return cell.v;
    }
    // Se √® una stringa
    if (cell.t === 's' || cell.t === 'str') {
        return String(cell.v).trim();
    }
    // Se √® una data
    if (cell.t === 'd') {
        return cell.v;
    }
    // Default: converti in stringa
    return String(cell.v).trim();
}

function readXLSFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        const isXLS = /\.xls$/i.test(file.name);
        reader.onload = (e) => {
            try {
                const data = e.target.result;
                const wb = XLSX.read(data, {type: isXLS ? 'binary' : 'array', codepage: 65001, cellDates: false});
                resolve(wb);
            } catch (err) {
                reject(err);
            }
        };
        if (isXLS) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsArrayBuffer(file);
        }
    });
}

function sheetByName(wb, name) {
    const n = wb.SheetNames.find(s => s.toLowerCase() === name.toLowerCase());
    return n ? wb.Sheets[n] : null;
}

// === Anni da foglio SP (T0001/T0002/T0003): D9 = N-1, E9 = N-2 (fallback: D4/E4 con anno in chiaro) ===
function readYearsFromSP(wsSP) {
  if (!wsSP) return { prev: null, last: null };

  // D9 = anno N-1 (ultimo), E9 = anno N-2 (precedente)
  const d9 = getCell(wsSP, 'D9'); // ultimo
  const e9 = getCell(wsSP, 'E9'); // precedente

  // fallback testuale in header D4/E4 se D9/E9 vuoti
  const d4 = getCell(wsSP, 'D4');
  const e4 = getCell(wsSP, 'E4');

  // parser robusto che estrae l'anno
  const toYear = (v) => {
    if (v == null) return null;
    const s = String(v).trim();
    // gg/mm/aaaa
    const mIt = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (mIt) {
      let y = parseInt(mIt[3], 10);
      if (y < 100) y = 2000 + y;
      return (y >= 1990 && y <= 2100) ? String(y) : null;
    }
    // 19xx o 20xx nel testo
    const m = s.match(/\b(19\d{2}|20\d{2})\b/);
    if (m) return m[1];
    // numero semplice nel range
    const n = Number(s);
    if (isFinite(n) && n >= 1990 && n <= 2100) return String(n);
    return null;
  };

  let yLast = toYear(d9) || toYear(d4); // ultimo esercizio
  let yPrev = toYear(e9) || toYear(e4); // esercizio precedente

  return { prev: yPrev, last: yLast };
}


function guessTipo(confC4) {
    const s = String(confC4 || "").trim().toLowerCase();
    if (s.endsWith("ese")) return "Ordinario";
    if (s.endsWith("abb")) return "Abbreviato";
    if (s.endsWith("micr")) return "Microimpresa";
    return "";
}

/* ====== HEADERS DATE (ORIGINALI) ====== */
/* Imposta le etichette data per gli header delle tabelle ORIGINALI (SP/CE) */
function setHeaderDates() {
  // Normalizza anni: vuoi sempre YYYY
  const yPrev = (state.anni && state.anni.prev) ? String(state.anni.prev) : "";
  const yLast = (state.anni && state.anni.last) ? String(state.anni.last) : "";

  // Formato italiano richiesto
  const prevTxt = yPrev ? `31/12/${yPrev}` : "";
  const lastTxt = yLast ? `31/12/${yLast}` : "";

  // Stato Patrimoniale
  const spPrev = document.getElementById("sp-head-prev");
  const spLast = document.getElementById("sp-head-last");
  if (spPrev) spPrev.textContent = prevTxt;
  if (spLast) spLast.textContent = lastTxt;

  // Conto Economico
  const cePrev = document.getElementById("ce-head-prev");
  const ceLast = document.getElementById("ce-head-last");
  if (cePrev) cePrev.textContent = prevTxt;
  if (ceLast) ceLast.textContent = lastTxt;
}


function importXLS() {
    // DEBUG ANAGRAFICA
    const debugAnagrafica = getAnagraficaAttiva();
    console.log('DEBUG - Anagrafica attiva:', debugAnagrafica);
    if (debugAnagrafica) {
        console.log('DEBUG - Settore in anagrafica:', debugAnagrafica.settore);
    }
    
    // SEMPRE prendi il settore fresco dall'anagrafica
    const anagraficaNuova = getAnagraficaAttiva();
    if (anagraficaNuova && anagraficaNuova.cf) {
        state.denom = anagraficaNuova.ragioneSociale || '‚Äî';
        state.cf = anagraficaNuova.cf || '‚Äî';
        byId("denom").textContent = state.denom;
        byId("cf").textContent = state.cf;
        aggiornaHeaderAzienda();
        
        // FORZA SEMPRE il settore dall'anagrafica
        if (anagraficaNuova.settore) {
            const settoreMap = {
                'AGRICOLTURA': 'Agricoltura',
                'INDUSTRIA': 'Industria',
                'EDILIZIA': 'Edilizia',
                'COMMERCIO': 'Commercio',
                'IMMOBILIARE': 'Immobiliare',
                'SERVIZI': 'Servizi'
            };
            // Prendi il settore mappato
            const settoreInput = String(anagraficaNuova.settore).toUpperCase().trim();
            const settoreDaUsare = settoreMap[settoreInput] || anagraficaNuova.settore || 'Servizi';
            
            // FORZA l'aggiornamento
            state.settore = settoreDaUsare;
            
            // Aggiorna il display
            const display = byId('settoreDisplay');
            if (display) {
                display.textContent = `Settore: ${settoreDaUsare}`;
                display.style.background = '#d4edda';
                display.style.color = '#155724';
            }
            console.log('‚úÖ Settore forzato a:', settoreDaUsare);
        } else {
            // Solo se non c'√® settore nell'anagrafica
            state.settore = null;
            showSettoreModal(() => importXLS());
            return;
        }
    } else {
        // Se non c'√® anagrafica attiva
        if (!state.settore) {
            showSettoreModal(() => importXLS());
            return;
        }
    }
    
    // Continua con il file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xls,.xlsx';
    fileInput.onchange = function() {
        const f = fileInput.files[0];
        if (!f) return;
        
        const name = f.name.toLowerCase();
        if (!name.endsWith('.xls') && !name.endsWith('.xlsx')) {
            toast("Il file selezionato non √® un Excel (.xls/.xlsx).", true);
            return;
        }
        
        readXLSFile(f).then(wb => {
            state.wb = wb;
            
// 1. DETERMINA TIPO BILANCIO
const wsConf = sheetByName(wb, 'Configurazione');
state.tipo = '';

if (wsConf) {
  const cellC4 = getCell(wsConf, 'C4');
  const s = String(cellC4 || '').toLowerCase().trim();
  if (s.endsWith('ese') || s.includes('ordinario')) state.tipo = 'Ordinario';
  else if (s.endsWith('abb') || s.includes('abbreviato')) state.tipo = 'Abbreviato';
  else if (s.includes('micr')) state.tipo = 'Micro'; // micro/microimpresa
}

// fallback per nomi fogli
if (!state.tipo) {
  if (sheetByName(wb, 'T0001')) state.tipo = 'Ordinario';
  else if (sheetByName(wb, 'T0002')) state.tipo = 'Abbreviato';
  else if (sheetByName(wb, 'T0003')) state.tipo = 'Micro';
}

if (!state.tipo) {
  toast("Impossibile determinare il tipo di bilancio (XLS).", true);
  return;
}

console.log('Tipo bilancio rilevato:', state.tipo);

            
            // 2. LEGGI FOGLIO T0000 PER DATI ANAGRAFICI
            const wsT0000 = sheetByName(wb, 'T0000');
            if (wsT0000) {
                const range = XLSX.utils.decode_range(wsT0000["!ref"]);
                
                for (let r = 0; r <= range.e.r; r++) {
                    const cellA = wsT0000[XLSX.utils.encode_cell({r, c: 0})]; // Codice
                    const cellD = wsT0000[XLSX.utils.encode_cell({r, c: 3})]; // Valore
                    
                    if (cellA && cellA.v) {
                        const codice = String(cellA.v).trim();
                        
                        // Codice Fiscale
                        if (codice === 'T0000.D01.1.001.002.008') {
                            const cfImportato = cellD ? String(cellD.v).trim() : '';
                            
                            // VERIFICA CF CON ANAGRAFICA
                            const anagraficaAttiva = getAnagraficaAttiva();
                            if (anagraficaAttiva && anagraficaAttiva.cf) {
                                const cfAttivo = normalizzaCF(anagraficaAttiva.cf);
                                const cfNormalizzato = normalizzaCF(cfImportato);
                                
                                if (cfNormalizzato && cfNormalizzato !== cfAttivo) {
                                    toast("‚ùå Il CF del bilancio non corrisponde all'anagrafica attiva", true);
                                    return;
                                }
                            }
                            state.cf = cfImportato;
                        }
                        
                        // Codice ATECO
                        if (codice === 'T0000.D01.1.001.002.011') {
                            const atecoImportato = cellD ? String(cellD.v).trim() : '';
                            if (atecoImportato) {
                                aggiornaAteco(atecoImportato);
                                console.log('‚úÖ ATECO importato:', atecoImportato);
                            }
                        }
                        
                        // Denominazione
                        if (codice === 'T0000.D01.1.001.002.002') {
                            const denomImportata = cellD ? String(cellD.v).trim() : '';
                            if (denomImportata) {
                                state.denom = denomImportata;
                            }
                        }
                    }
                }
            }
            
            // 3. DETERMINA FOGLI SP E CE - CORREZIONE MAPPING
            let mapSP, mapCE;
            
            if (state.tipo === 'Ordinario') {
                mapSP = 'T0001';
                mapCE = 'T0005';
            } else if (state.tipo === 'Abbreviato') {
                mapSP = 'T0002';
                mapCE = 'T0006';
            } else if (state.tipo === 'Micro') {
                mapSP = 'T0003';
                mapCE = 'T0007';
            } else {
                toast("Tipo bilancio non riconosciuto: " + state.tipo, true);
                return;
            }
            
            const wsSP = sheetByName(wb, mapSP);
            const wsCE = sheetByName(wb, mapCE);
            
            if (!wsSP || !wsCE) {
                toast(`Fogli ${mapSP}/${mapCE} non trovati nel file`, true);
                return;
            }
            
// 4. Estrai anni dai fogli T000x (D9 = N-1, E9 = N-2; fallback D4/E4)
const yrs = readYearsFromSP(wsSP);
state.anni.prev = yrs.prev;  // N-2
state.anni.last = yrs.last;  // N-1

// Se NON abbiamo ancora anni, tenta una volta anche da Configurazione C9/C10 (fallback)
if (!state.anni.prev && !state.anni.last) {
  const wsConfYears = sheetByName(state.wb, 'Configurazione');
  if (wsConfYears) {
    const c9  = getCell(wsConfYears, 'C9');   // precedente
    const c10 = getCell(wsConfYears, 'C10');  // ultimo
    const yP = _coerceYear(c9);
    const yL = _coerceYear(c10);
    if (yL) state.anni.last = yL;
    if (yP) state.anni.prev = yP;
  }
}

// Normalizza/ordina (gestisce anche il caso ‚Äúun solo anno‚Äù)
updateAnniConsuntivi(state.anni.prev, state.anni.last);
setHeaderDates();

// Fallback anni da header dei fogli T000x (D9=ultimo, E9=precedente) se mancanti
if (!state.anni.last || !state.anni.prev) {
  // mappa fogli in base al tipo
  const mapSP = (state.tipo === 'Ordinario') ? 'T0001'
              : (state.tipo === 'Abbreviato') ? 'T0002'
              : 'T0003';
  const wsSPhead = sheetByName(wb, mapSP);
  if (wsSPhead) {
    const d9 = getCell(wsSPhead, 'D9'); // N-1 (ultimo)
    const e9 = getCell(wsSPhead, 'E9'); // N-2 (precedente)
    const yLast = _coerceYear(d9);
    const yPrev = _coerceYear(e9);
    // accetta: entrambi; oppure anche singolo anno (vedi tua politica 1-anno)
    const sane = y => y && +y >= 1990 && +y <= 2100;
    if (sane(yLast) && sane(yPrev) && yLast !== yPrev) {
      state.anni.last = yLast;
      state.anni.prev = yPrev;
    } else if (sane(yLast) && !sane(yPrev)) {
      state.anni.last = yLast;
      // lascia prev null: mostreremo un solo anno
    } else if (!sane(yLast) && sane(yPrev)) {
      state.anni.prev = yPrev;
      // lascia last null: caso raro, ma coerente con tua logica 1-anno
    }
    _fixAnniState();
    updateAnniConsuntivi(state.anni.prev, state.anni.last);
    setHeaderDates();
  }
}
            
            // 5. CONTROLLO DUPLICATI
            if (state.anni.last && state.anni.prev) {
                const indice = JSON.parse(localStorage.getItem('ceodoc_bilanci_index') || '[]');
                const cf = normalizzaCF(state.cf);
                const duplicato = indice.find(b => {
                    const cfBilancio = normalizzaCF(b.cf);
                    return cfBilancio === cf && b.anni === `${state.anni.prev}-${state.anni.last}`;
                });
                
                if (duplicato && !confirm(
                    `‚ö†Ô∏è Bilanci ${state.anni.prev}-${state.anni.last} gi√† presenti.\n\n` +
                    `Azienda: ${duplicato.denominazione}\n` +
                    `CF: ${duplicato.cf}\n\n` +
                    `Sovrascrivere?`
                )) {
                    toast("Import annullato", true);
                    return;
                }
            }
            
            // 6. USA LA NUOVA FUNZIONE importXls PER LEGGERE I DATI
            const spData = importXls(wsSP, state.tipo, 'SP');
            const ceData = importXls(wsCE, state.tipo, 'CE');

console.log('üìä DEBUG CREDITI XLS:');
console.log('Clienti entro:', spData['T0001.D01.1.001.002.004.004.002.002.000']);
console.log('Controllate entro:', spData['T0001.D01.1.001.002.004.004.003.002.000']);
console.log('Collegate entro:', spData['T0001.D01.1.001.002.004.004.004.002.000']);
console.log('Fornitori entro:', spData['T0001.D01.1.001.003.005.008.002.000.000']);

// Converti in array per state
state.spRows = Object.entries(spData).map(([codice, r]) => ({ ...r, codice }));

console.log('‚úÖ Import XLS OK:', { tipoBilancio: state.tipo, anni: { n2: state.anni.prev, n1: state.anni.last } });
console.log('üîé Match anagrafica:', { cfAttivo: getAnagraficaAttiva()?.cf, cfBilancio: state.cf });
console.log('üîé Meta import XLS:', { ateco: state.codiceAteco });

            
            // Converti in array per state - MANTIENI STRUTTURA CON voce, last, prev
state.spRows = Object.entries(spData).map(([codice, r]) => ({ ...r, codice }));
state.ceRows = Object.entries(ceData).map(([codice, r]) => ({ ...r, codice }));


console.log('üìä XLS SP rows:', state.spRows.length);
console.table(state.spRows.slice(0, 5));
console.log('üìä XLS CE rows:', state.ceRows.length);
console.table(state.ceRows.slice(0, 5));

            
            // 7. AGGIORNA DISPLAY
            byId("denom").textContent = state.denom;
            byId("cf").textContent = state.cf;
            byId("esercizi").textContent = state.anni.last && state.anni.prev ? 
                `31/12/${state.anni.last} ¬∑ 31/12/${state.anni.prev}` : "‚Äî";
            byId("tipoBilDisplay").textContent = state.tipo;
            byId("eserciziDisplay").textContent = state.anni.last && state.anni.prev ?
                `31/12/${state.anni.prev} - 31/12/${state.anni.last}` : "‚Äî";
            
            // Aggiorna i campi verdi
            updateTipoBilancio(state.tipo);
            if (state.anni.prev && state.anni.last) {
                updateAnniConsuntivi(state.anni.prev, state.anni.last);
            }
            
            setHeaderDates();
console.log('üñ®Ô∏è Render ORIGINALI (XLS) input:');
console.table([{ tipo: state.tipo, n_SP: state.spRows?.length || 0, n_CE: state.ceRows?.length || 0, prev: state.anni?.prev, last: state.anni?.last }]);

            renderTables();
            renderChecksCompleti(state.spRows, state.ceRows);

// Dopo i render principali
renderTables();
renderChecksCompleti(state.spRows, state.ceRows);

// === CALCOLA E MOSTRA KPI DSCR ===
try {
    const card = document.getElementById("card-content");
    if (card) {
        // crea sezione KPI DSCR (se non esiste gi√†)
        if (!document.getElementById("kpi-dscr")) {
            card.innerHTML += `
                <div style="margin-top:30px">
                    <h3 style="color:var(--ceo-blue);margin-bottom:10px">
                        üìä DSCR ‚Äî Debt Service Coverage Ratio
                    </h3>
                    <div id="kpi-dscr"></div>
                </div>`;
        }

        // chiama la funzione che disegna i valori
        if (typeof renderDSCRKPI === "function") {
            renderDSCRKPI("kpi-dscr");
            console.log("‚úÖ DSCR KPI renderizzato");
        } else {
            console.warn("‚ö†Ô∏è Funzione renderDSCRKPI non trovata");
        }
    }
} catch (e) {
    console.error("Errore durante il render DSCR:", e);
}


// --- RENDICONTO: genera/aggiorna se presente la funzione ---
// if (typeof window.renderRendicontoFinanziario === 'function') {
//   try {
//     window.renderRendicontoFinanziario(); // usa i dati gi√† in state
//   } catch (e) {
//     console.warn('renderRendicontoFinanziario errore:', e);
//   }
// }

// Abilita tabs 
byId("bilanciTab").disabled = false;
byId("predisponiTab").disabled = false;
byId("ratingTab").disabled = false;
byId("analisiTab").disabled = false;

toast("‚úÖ Import XLS completato con successo!");

// === üîπ Salvataggio automatico stato per analisi completa ===
try {
  localStorage.setItem("ceodoc_session", JSON.stringify({ state }));
  console.log("üíæ Stato ceoDOC salvato in localStorage (da importXLS)");
} catch (err) {
  console.warn("‚ö†Ô∏è Impossibile salvare sessione ceoDOC:", err);
}

}).catch(err => {
  console.error(err);
  toast("Errore durante la lettura del file XLS: " + err.message, true);
});
};

fileInput.click();
}


/* ====== IMPORT XBRL ====== */
async function loadXBRLMappings() {
    const bases = [
        '../libs/cr/backup/',
        './libs/cr/backup/',
        '../../libs/cr/backup/'
    ];
    
    for (const base of bases) {
        try {
            await loadScript(base + 'mapping02-xbrl-lib.js');
            await loadScript(base + 'mapping-xbrl-lib.js');
            console.log('Mapping XBRL caricati da:', base);
            return true;
        } catch(e) {
            console.log('Tentativo fallito per:', base);
            continue;
        }
    }
    
    console.warn('File mapping XBRL non trovati');
    window.XBRL_BY_REPORT = {};
    window.XBRL_TABLES = {};
    return false;
}

function loadScript(url) {
    return new Promise((resolve, reject) => {
        try {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = () => reject(new Error('File non trovato'));
            
            const target = document.head || document.body || document.documentElement;
            if (target) {
                target.appendChild(script);
            } else {
                reject(new Error('DOM non pronto'));
            }
        } catch(e) {
            reject(e);
        }
    });
}

function collectContexts(xml) {
    const XBRLI = 'http://www.xbrl.org/2003/instance';
    const list = Array.from(xml.getElementsByTagNameNS(XBRLI, 'context'));
    const ctx = { instant: [], duration: [] };
    
    for (const c of list) {
        const id = c.getAttribute('id') || '';
        const p = c.getElementsByTagNameNS(XBRLI, 'period')[0];
        if (!p) continue;
        
        const inst = p.getElementsByTagNameNS(XBRLI, 'instant')[0];
        const en = p.getElementsByTagNameNS(XBRLI, 'endDate')[0];
        
        if (inst) {
            const d = (inst.textContent || '').trim();
            const ts = Date.parse(d) || 0;
            ctx.instant.push({ id, date: d, ts });
        } else if (en) {
            const d = (en.textContent || '').trim();
            const ts = Date.parse(d) || 0;
            ctx.duration.push({ id, date: d, ts });
        }
    }
    
    ctx.instant.sort((a, b) => b.ts - a.ts);
    ctx.duration.sort((a, b) => b.ts - a.ts);
    return ctx;
}

function detectSchemaByText(xbrlText) {
    const t = xbrlText.toLowerCase();
    if (t.includes('itcc-ci-micr') || t.includes('/micr/')) return 'Microimpresa';
    if (t.includes('itcc-ci-abb') || t.includes('/abb/')) return 'Abbreviato';
    return 'Ordinario';
}

function getItccNsURI(root) {
    const uri = root.getAttribute('xmlns:itcc-ci');
    if (uri) return [uri];
    return [
        'http://www.infocamere.it/itnn/fr/itcc/ci/2018-11-04',
        'http://www.infocamere.it/itnn/fr/itcc/ci/2017-07-06'
    ];
}

function findByQName(xml, qname, contextRef, nsUris) {
    const [_, local] = qname.split(':');
    const tryUris = Array.isArray(nsUris) ? nsUris : [nsUris];
    
    for (const ns of tryUris) {
        const nodes = Array.from(xml.getElementsByTagNameNS(ns, local));
        for (const n of nodes) {
            if (!contextRef || n.getAttribute('contextRef') === contextRef) {
                const val = (n.textContent || '').trim();
                if (val !== '') return val;
            }
        }
    }
    const nodes2 = Array.from(xml.getElementsByTagName(qname));
    for (const n of nodes2) {
        if (!contextRef || n.getAttribute('contextRef') === contextRef) {
            const val = (n.textContent || '').trim();
            if (val !== '') return val;
        }
    }
    return '';
}


async function importXBRL() {
    // DEBUG ANAGRAFICA
    const debugAnagrafica = getAnagraficaAttiva();
    console.log('DEBUG - Anagrafica attiva XBRL:', debugAnagrafica);
    if (debugAnagrafica) {
        console.log('DEBUG - Settore in anagrafica XBRL:', debugAnagrafica.settore);
    }
    
    // SEMPRE prendi il settore fresco dall'anagrafica
    const anagraficaNuova = getAnagraficaAttiva();
    if (anagraficaNuova && anagraficaNuova.cf) {
        state.denom = anagraficaNuova.ragioneSociale || '‚Äî';
        state.cf = anagraficaNuova.cf || '‚Äî';
        byId("denom").textContent = state.denom;
        byId("cf").textContent = state.cf;
        aggiornaHeaderAzienda();
        
        // FORZA SEMPRE il settore dall'anagrafica
        if (anagraficaNuova.settore) {
            const settoreMap = {
                'AGRICOLTURA': 'Agricoltura',
                'INDUSTRIA': 'Industria',
                'EDILIZIA': 'Edilizia',
                'COMMERCIO': 'Commercio',
                'IMMOBILIARE': 'Immobiliare',
                'SERVIZI': 'Servizi'
            };
            // Prendi il settore - gestisci sia maiuscolo che minuscolo
            const settoreInput = String(anagraficaNuova.settore).toUpperCase().trim();
            const settoreDaUsare = settoreMap[settoreInput] || anagraficaNuova.settore || 'Servizi';
            
            // FORZA l'aggiornamento
            state.settore = settoreDaUsare;
            
            // Aggiorna il display
            const display = byId('settoreDisplay');
            if (display) {
                display.textContent = `Settore: ${settoreDaUsare}`;
                display.style.background = '#d4edda';
                display.style.color = '#155724';
            }
            console.log('‚úÖ XBRL - Settore importato da anagrafica:', settoreDaUsare);
        } else {
            // Solo se non c'√® settore nell'anagrafica
            state.settore = null;
            showSettoreModal(() => importXBRL());
            return;
        }
    } else {
        // Se non c'√® anagrafica attiva
        if (!state.settore) {
            showSettoreModal(() => importXBRL());
            return;
        }
    }
    
    // Continua con il file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xml,.xbrl';
    fileInput.onchange = async function() {
        const f = fileInput.files[0];
        if (!f) return;
        
        const name = f.name.toLowerCase();
        if (!name.endsWith('.xbrl') && !name.endsWith('.xml')) {
            toast("Il file selezionato non √® un XBRL/XML.", true);
            return;
        }
        
        toast("Caricamento mapping XBRL...");
        await loadXBRLMappings();
        toast("Importazione XBRL in corso...");
        
        try {
            const text = await f.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');
            const root = xml.documentElement;
            
            // 1. RILEVA TIPO BILANCIO DAL SCENARIO
            state.tipo = '';
            const scenarios = xml.getElementsByTagName('scenario');
            for (let i = 0; i < scenarios.length; i++) {
                const scenContent = scenarios[i].textContent || '';
                const scenHTML = scenarios[i].innerHTML || '';
                
                // Cerca nei tag scenario
                if (scenHTML.includes('itcc-ci-micr:') || scenContent.includes('micr')) {
                    state.tipo = 'Micro';
                    break;
                } else if (scenHTML.includes('itcc-ci-abb:') || scenContent.includes('abb')) {
                    state.tipo = 'Abbreviato';
                    break;
                } else if (scenHTML.includes('itcc-ci-ese') || scenContent.includes('ese')) {
                    state.tipo = 'Ordinario';
                    break;
                }
            }
            
            // Se non trovato nel scenario, prova a dedurlo dai tag presenti
            if (!state.tipo) {
                const allTags = xml.getElementsByTagName('*');
                let hasOrdTags = false;
                let hasAbbTags = false;
                let hasMicroTags = false;
                
                for (let i = 0; i < allTags.length; i++) {
                    const tagName = allTags[i].tagName;
                    if (tagName.includes('DettaglioImportoVenditeServizi')) hasOrdTags = true;
                    if (tagName.includes('ImmobilizzazioniImmateriali') && !tagName.includes('Totale')) hasAbbTags = true;
                    // Aggiungi altri tag distintivi se necessario
                }
                
                if (hasOrdTags) state.tipo = 'Ordinario';
                else if (hasAbbTags) state.tipo = 'Abbreviato';
                else state.tipo = 'Micro'; // Default
            }
            
            console.log('Tipo bilancio rilevato da XBRL:', state.tipo);
            
            // 2. RACCOGLI CONTEXTS
            const contexts = collectContexts(xml);
            const dateN = contexts.instant[0]?.date || contexts.duration[0]?.date || '';
            const dateP = contexts.instant[1]?.date || contexts.duration[1]?.date || '';
            
            if (dateN) state.anni.last = dateN.split('-')[0];
            if (dateP) state.anni.prev = dateP.split('-')[0];

_fixAnniState();

// Normalizza: accetta 1 solo anno, ordina se due
(function fixYearsXbrl(){
  const sane = (y)=> y && +y>=1990 && +y<=2100;
  let p = state.anni?.prev || null;
  let l = state.anni?.last || null;

  if (sane(p) && sane(l)) {
    if (+p > +l) { const t = p; p = l; l = t; }
    state.anni.prev = p; state.anni.last = l;
  } else if (sane(p)) {
    state.anni.prev = p; state.anni.last = p;     // 1 solo anno
  } else if (sane(l)) {
    state.anni.prev = l; state.anni.last = l;     // 1 solo anno
  } else {
    state.anni.prev = null; state.anni.last = null;
  }
})();

            
            // 3. OTTIENI NAMESPACE URI
            const itccUris = getItccNsURI(root);
            
            const instN = contexts.instant[0]?.id || '';
            const instP = contexts.instant[1]?.id || '';
            
            // 4. ESTRAI DATI ANAGRAFICI
            const denom = findByQName(xml, 'itcc-ci:DatiAnagraficiDenominazione', instN || instP, itccUris) ||
                          findByQName(xml, 'itcc-ci:DatiAnagraficiDenominazione', '', itccUris);
            
            const cfXBRL = findByQName(xml, 'itcc-ci:DatiAnagraficiCodiceFiscale', instN || instP, itccUris) ||
                           findByQName(xml, 'itcc-ci:DatiAnagraficiCodiceFiscale', '', itccUris);
            
            const piva = findByQName(xml, 'itcc-ci:DatiAnagraficiPartitaIva', instN || instP, itccUris);
            
            state.denom = denom || "‚Äî";
            state.cf = (cfXBRL || piva || "").replace(/\D+/g, '') || "‚Äî";
            
            // 5. VERIFICA CF CON ANAGRAFICA ATTIVA
            const anagraficaAttiva = getAnagraficaAttiva();
            if (anagraficaAttiva && anagraficaAttiva.cf) {
                const cfImportato = normalizzaCF(state.cf);
                const cfAttivo = normalizzaCF(anagraficaAttiva.cf);
                
                if (cfImportato !== "‚Äî" && cfImportato !== "" && cfImportato !== cfAttivo) {
                    toast("‚ùå Il CF del bilancio non corrisponde all'anagrafica attiva", true);
                    return;
                }
            }
            
            // 6. ESTRAI CODICE ATECO
            const atecoXBRL = findByQName(xml, 'itcc-ci:DatiAnagraficiSettoreAttivitaPrevalenteAteco', instN || instP, itccUris) ||
                              findByQName(xml, 'itcc-ci:DatiAnagraficiSettoreAttivitaPrevalenteAteco', '', itccUris) ||
                              findByQName(xml, 'itcc-ci:DatiAnagraficiCodiceAteco', instN || instP, itccUris) ||
                              findByQName(xml, 'itcc-ci:DatiAnagraficiCodiceAteco', '', itccUris);
            
            if (atecoXBRL) {
                aggiornaAteco(atecoXBRL);
                console.log('‚úÖ ATECO importato da XBRL:', atecoXBRL);
            }
            
            // 7. CONTROLLO DUPLICATI
            if (state.anni.last && state.anni.prev) {
                const indice = JSON.parse(localStorage.getItem('ceodoc_bilanci_index') || '[]');
                const cf = normalizzaCF(state.cf);
                const duplicato = indice.find(b => {
                    const cfBilancio = normalizzaCF(b.cf);
                    return cfBilancio === cf && b.anni === `${state.anni.prev}-${state.anni.last}`;
                });
                
                if (duplicato && !confirm(
                    `‚ö†Ô∏è Bilanci ${state.anni.prev}-${state.anni.last} gi√† presenti.\n\n` +
                    `Azienda: ${duplicato.denominazione}\n` +
                    `CF: ${duplicato.cf}\n\n` +
                    `Sovrascrivere?`
                )) {
                    toast("Import XBRL annullato", true);
                    return;
                }
            }
            
            // 8. USA LA HELPER importXbrl PER LEGGERE I DATI
            const spData = importXbrl(xml, state.tipo, 'SP', contexts, itccUris);
            const ceData = importXbrl(xml, state.tipo, 'CE', contexts, itccUris);

console.log('üìä DEBUG CREDITI XBRL:');
console.log('Clienti entro:', spData['T0001.D01.1.001.002.004.004.002.002.000']);
console.log('Controllate entro:', spData['T0001.D01.1.001.002.004.004.003.002.000']);
console.log('Collegate entro:', spData['T0001.D01.1.001.002.004.004.004.002.000']);
console.log('Fornitori entro:', spData['T0001.D01.1.001.003.005.008.002.000.000']);

// Converti in array per state
state.spRows = Object.entries(spData).map(([codice, r]) => ({ ...r, codice }));

console.log('‚úÖ Import XBRL OK:', { tipoBilancio: state.tipo, anni: { n2: state.anni.prev, n1: state.anni.last } });
console.log('üîé Match anagrafica:', { cfAttivo: getAnagraficaAttiva()?.cf, cfBilancio: state.cf });
console.log('üîé Meta import XBRL:', { ateco: state.codiceAteco });

            
            // Converti in array per state
state.spRows = Object.entries(spData).map(([codice, r]) => ({ ...r, codice }));
state.ceRows = Object.entries(ceData).map(([codice, r]) => ({ ...r, codice }));


console.log('üìä XBRL SP rows:', state.spRows.length, state.spRows.slice(0, 5));
console.log('üìä XBRL CE rows:', state.ceRows.length, state.ceRows.slice(0, 5));

            
            // 9. AGGIORNA DISPLAY
            byId("denom").textContent = state.denom;
            byId("cf").textContent = state.cf;
            byId("tipoBilDisplay").textContent = state.tipo;
            byId("esercizi").textContent = (state.anni.last && state.anni.prev) ?
                `31/12/${state.anni.last} ¬∑ 31/12/${state.anni.prev}` : "‚Äî";
            byId("eserciziDisplay").textContent = (state.anni.last && state.anni.prev) ?
                `31/12/${state.anni.prev} - 31/12/${state.anni.last}` : "‚Äî";
            
            // Aggiorna i campi verdi
            updateTipoBilancio(state.tipo);
            if (state.anni.prev && state.anni.last) {
                updateAnniConsuntivi(state.anni.prev, state.anni.last);
            }
            
            setHeaderDates();
console.log('üñ®Ô∏è Render ORIGINALI (XBRL) input:', {
  anni: { n2: state.anni.prev, n1: state.anni.last },
  tipo: state.tipo, SP: state.spRows?.length, CE: state.ceRows?.length
});
            renderTables();
            renderChecksCompleti(state.spRows, state.ceRows);

// === CALCOLA E MOSTRA KPI DSCR ===
try {
    const card = document.getElementById("card-content");
    if (card) {
        // Crea sezione KPI DSCR se non esiste gi√†
        if (!document.getElementById("kpi-dscr")) {
            card.innerHTML += `
                <div style="margin-top:30px">
                    <h3 style="color:var(--ceo-blue);margin-bottom:10px">
                        üìä DSCR ‚Äî Debt Service Coverage Ratio
                    </h3>
                    <div id="kpi-dscr"></div>
                </div>`;
        }

        // Calcola e mostra
        if (typeof renderDSCRKPI === "function") {
            renderDSCRKPI("kpi-dscr");
            console.log("‚úÖ DSCR KPI renderizzato (XBRL)");
        } else {
            console.warn("‚ö†Ô∏è Funzione renderDSCRKPI non trovata");
        }
    }
} catch (e) {
    console.error("Errore durante il render DSCR:", e);
}

// --- RENDICONTO: genera/aggiorna se presente la funzione ---
// if (typeof window.renderRendicontoFinanziario === 'function') {
//   try {
//     window.renderRendicontoFinanziario(); // usa i dati gi√† in state
//   } catch (e) {
//     console.warn('renderRendicontoFinanziario errore:', e);
//   }
// }

            
// Abilita tabs
byId("bilanciTab").disabled = false;
byId("predisponiTab").disabled = false;
byId("ratingTab").disabled = false;
byId("analisiTab").disabled = false;

// Chiudi modal se esiste
const modal = document.querySelector('[style*="z-index: 9999"]');
if (modal) modal.remove();

toast("‚úÖ Import XBRL completato con successo!");

// === üîπ Salvataggio automatico stato per analisi completa ===
try {
  localStorage.setItem("ceodoc_session", JSON.stringify({ state }));
  console.log("üíæ Stato ceoDOC salvato in localStorage (da importXBRL)");
} catch (err) {
  console.warn("‚ö†Ô∏è Impossibile salvare sessione ceoDOC:", err);
}

} catch(error) {
  console.error("Errore import XBRL:", error);
  toast("Errore nel caricamento del file XBRL: " + error.message, true);
}
};

fileInput.click();
}

/* ====== AZZERA ====== */
function azzera() {
    // Azzera solo i dati del bilancio, NON il settore e NON il codiceAteco
    Object.assign(state, {
        wb: null, 
        tipo: "", 
        sheets: {}, 
        anni: {last: null, prev: null}, 
        denom: "‚Äî", 
        cf: "‚Äî", 
        spRows: [], 
        ceRows: []
        // NON azzerare state.settore
        // NON azzerare state.codiceAteco
    });
    
    // Mantieni anagrafica attiva
    const anagraficaAttiva = getAnagraficaAttiva();
    if (anagraficaAttiva) {
        state.denom = anagraficaAttiva.ragioneSociale || "‚Äî";
        state.cf = anagraficaAttiva.cf || "‚Äî";
        
        // Mantieni il settore dall'anagrafica
        if (anagraficaAttiva.settore) {
            const settoreMap = {
                'AGRICOLTURA': 'Agricoltura',
                'INDUSTRIA': 'Industria', 
                'EDILIZIA': 'Edilizia',
                'COMMERCIO': 'Commercio',
                'IMMOBILIARE': 'Immobiliare',
                'SERVIZI': 'Servizi'
            };
            const settoreMapped = settoreMap[anagraficaAttiva.settore] || anagraficaAttiva.settore;
            state.settore = settoreMapped;
        }
        
        // Mantieni anche il codice ATECO dall'anagrafica
        if (anagraficaAttiva.codiceAteco) {
            state.codiceAteco = anagraficaAttiva.codiceAteco;
            aggiornaAteco(anagraficaAttiva.codiceAteco);
        }
    }
    
    byId("denom").textContent = state.denom;
    byId("cf").textContent = state.cf;
    byId("tipoBil").textContent = "‚Äî";
    byId("esercizi").textContent = "‚Äî";
    byId("sp-body").innerHTML = "";
    byId("ce-body").innerHTML = "";
    
    byId("dtInfra").value = "";
    byId("dtNorm").value = "";
    byId("dtPrev1").value = "";
    byId("dtPrev2").value = "";
    
    // Aggiorna header
    aggiornaHeaderAzienda();
    
    // Reset solo tipo bilancio e anni (NON il settore)
    const tipoBilDisplay = byId('tipoBilDisplay');
    if (tipoBilDisplay) {
        tipoBilDisplay.textContent = '‚Äî';
        tipoBilDisplay.style.background = '';
        tipoBilDisplay.style.color = '';
    }
    
    const eserciziDisplay = byId('eserciziDisplay');
    if (eserciziDisplay) {
        eserciziDisplay.textContent = '‚Äî';
        eserciziDisplay.style.background = '';
        eserciziDisplay.style.color = '';
    }
    
    // Il settore rimane com'√® dall'anagrafica attiva
    // Il codice ATECO rimane com'√® dall'anagrafica attiva
    // Reset display ATECO solo se non c'√® nell'anagrafica
    if (!state.codiceAteco) {
        const valoreAteco = byId('valoreAteco');
        if (valoreAteco) {
            valoreAteco.textContent = '‚Äî';
        }
    }
    

    // Pulisci i check
    pulisciChecks();
    
    byId("bilanciTab").disabled = true;
    byId("predisponiTab").disabled = true;
    byId("ratingTab").disabled = true;
    byId("analisiTab").disabled = true;
    
    setHeaderDates();
    
    toast("Dati bilancio azzerati");
}

/* ====== SETTORE MODAL ====== */
function showSettoreModal(callback) {
    // Controlla se c'√® un settore nell'anagrafica attiva
    const anagrafica = getAnagraficaAttiva();
    if (anagrafica && anagrafica.settore) {
        // Seleziona automaticamente il settore e procedi
        selectSettore(anagrafica.settore);
        if (callback) callback();
        return;
    }
    
    // Se non c'√® settore preimpostato, mostra il modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    const card = document.createElement('div');
    card.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 500px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    `;
    
    card.innerHTML = `
        <h3 style="color: #1e40af; margin-bottom: 20px; text-align: center;">
            Seleziona Settore di Appartenenza
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <button class="settore-modal-btn" data-settore="Agricoltura" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,16L10,18.5L12.5,16H7.5M16.5,16L14,18.5L11.5,16H16.5Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Agricoltura</div>
            </button>
            <button class="settore-modal-btn" data-settore="Industria" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Industria</div>
            </button>
            <button class="settore-modal-btn" data-settore="Edilizia" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M20,7H17L15.85,5.85C15.66,5.66 15.4,5.55 15.13,5.55H8.87C8.6,5.55 8.34,5.66 8.15,5.85L7,7H4A2,2 0 0,0 2,9V19A2,2 0 0,0 4,21H20A2,2 0 0,0 22,19V9A2,2 0 0,0 20,7M20,19H4V9H7.5L8.65,7.85A1,1 0 0,1 9.35,7.5H14.65A1,1 0 0,1 15.35,7.85L16.5,9H20V19Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Edilizia</div>
            </button>
            <button class="settore-modal-btn" data-settore="Commercio" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M17,18C17.5,18 18,18.4 18,19A2,2 0 0,1 16,21H8A2,2 0 0,1 6,19C6,18.4 6.4,18 7,18H17M1,2V4H3L6.6,11.59L5.25,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L20.88,5H5.21L4.27,3H1M7,18A2,2 0 0,0 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20A2,2 0 0,0 7,18M17,18A2,2 0 0,0 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20A2,2 0 0,0 17,18Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Commercio</div>
            </button>
            <button class="settore-modal-btn" data-settore="Immobiliare" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Immobiliare</div>
            </button>
            <button class="settore-modal-btn" data-settore="Servizi" style="padding: 15px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                <svg style="width: 24px; height: 24px; fill: #1e40af;" viewBox="0 0 24 24"><path d="M12,7L17,12H13V16H11V12H7L12,7M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/></svg>
                <div style="color: #1e40af; margin-top: 8px;">Servizi</div>
            </button>
        </div>
        <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 10px; background: #e5e7eb; color: #1e40af; border: none; border-radius: 6px; cursor: pointer;">Annulla</button>
    `;
    
    modal.appendChild(card);
    document.body.appendChild(modal);
    
    card.querySelectorAll('.settore-modal-btn').forEach(btn => {
        btn.onmouseover = () => {
            btn.style.borderColor = '#1e40af';
            btn.style.background = '#eff6ff';
        };
        btn.onmouseout = () => {
            btn.style.borderColor = '#e0e0e0';
            btn.style.background = 'white';
        };
        btn.onclick = () => {
            const settore = btn.dataset.settore;
            selectSettore(settore);
            modal.remove();
            callback();
        };
    });
}

 
/* ====== GESTIONE SALVATAGGIO BILANCI ====== */
function salvaBilancio() {
if (!state.anni.last && !state.anni.prev) {
  toast("Anni consuntivi non validi", true);
  return;
}
    if (!state.spRows.length || !state.ceRows.length) {
        toast("Nessun bilancio da salvare", true);
        return;
    }
    
    const cf = normalizzaCF(state.cf);
    let indice = JSON.parse(localStorage.getItem('ceodoc_bilanci_index') || '[]');
    
    // Controlla se esiste gi√†
    const esistente = indice.find(b => {
        const cfBilancio = normalizzaCF(b.cf);
        return cfBilancio === cf && b.anni === `${state.anni.prev}-${state.anni.last}`;
    });
    
    if (esistente) {
        if (!confirm(`Vuoi sovrascrivere il bilancio esistente ${esistente.anni}?`)) {
            toast("Salvataggio annullato", true);
            return;
        }
        localStorage.removeItem(`ceodoc_bilancio_${esistente.id}`);
        indice = indice.filter(b => b.id !== esistente.id);
    }
    
// sanity anni prima di salvare: accetta 1 o 2 anni validi (>=1990)
const sane = (y)=> y && +y>=1990 && +y<=2100;
if (!sane(state.anni.prev) || !sane(state.anni.last)) {
  toast("Anni consuntivi non validi: compila Configurazione!C9 o C10.", true);
  return;
}

    const nomeFile = `${cf}_${state.anni.prev}_${state.anni.last}_${Date.now()}`;
    
    const bilancioData = {
        id: nomeFile,
        cf: state.cf,
        denominazione: state.denom,
        tipo: state.tipo,
        settore: state.settore,
        codiceAteco: state.codiceAteco,  // <-- AGGIUNTO
        anni: state.anni,
        date: {
            infrannuale: byId("dtInfra").value,
            normalizzato: byId("dtNorm").value,
            previsionale1: byId("dtPrev1").value,
            previsionale2: byId("dtPrev2").value
        },
        dati: {
            spRows: state.spRows,
            ceRows: state.ceRows
        },
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem(`ceodoc_bilancio_${nomeFile}`, JSON.stringify(bilancioData));
    
    indice.push({
        id: nomeFile,
        denominazione: state.denom,
        cf: state.cf,
        codiceAteco: state.codiceAteco,  // <-- AGGIUNTO
        anni: `${state.anni.prev}-${state.anni.last}`,
        data: new Date().toISOString()
    });
    
    localStorage.setItem('ceodoc_bilanci_index', JSON.stringify(indice));
    toast(`Bilancio salvato: ${state.denom} (${state.anni.prev}-${state.anni.last})`);
}

function mostraListaBilanci() {
    const indice = JSON.parse(localStorage.getItem('ceodoc_bilanci_index') || '[]');
    const anagraficaAttiva = getAnagraficaAttiva();
    
    const bilanciFiltrati = anagraficaAttiva && anagraficaAttiva.cf 
        ? indice.filter(b => normalizzaCF(b.cf) === normalizzaCF(anagraficaAttiva.cf))
        : indice;
    
    if (!bilanciFiltrati.length) {
        toast("Nessun bilancio salvato per questa anagrafica", true);
        return;
    }
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    let listHTML = '<h3 style="color:#1e40af;margin-bottom:20px">Bilanci Salvati</h3>';
    listHTML += '<div style="max-height:400px;overflow-y:auto">';
    
    bilanciFiltrati.forEach(b => {
        const atecoInfo = b.codiceAteco ? ` | ATECO: ${b.codiceAteco}` : '';  // <-- AGGIUNTO
        listHTML += `
            <div style="padding:10px;border:1px solid #e0e0e0;margin-bottom:10px;border-radius:8px;position:relative" 
                 id="bilancio-item-${b.id}">
                <div style="cursor:pointer" onclick="caricaBilancioById('${b.id}')">
                    <strong>${b.denominazione}</strong><br>
                    CF: ${b.cf} | Anni: ${b.anni}${atecoInfo}<br>
                    <small>Salvato: ${new Date(b.data).toLocaleString('it-IT')}</small>
                </div>
                <button onclick="eliminaBilancio('${b.id}')" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: #dc2626;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Elimina</button>
            </div>
        `;
    });
    
    listHTML += '</div>';
    listHTML += '<button onclick="this.closest(\'div\').parentElement.remove()" style="margin-top:20px;padding:10px 20px;background:#1e40af;color:white;border:none;border-radius:6px;cursor:pointer">Chiudi</button>';
    
    const content = document.createElement('div');
    content.style.cssText = 'background:white;padding:30px;border-radius:10px;max-width:600px;width:90%';
    content.innerHTML = listHTML;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
}

function eliminaBilancio(id) {
    if (!confirm('Sei sicuro di voler eliminare questo bilancio?')) {
        return;
    }
    
    const key = `ceodoc_bilancio_${id}`;
    const data = localStorage.getItem(key);
    
    if (data) {
        try {
            const bilancio = JSON.parse(data);
            
            if (bilancio.cf && bilancio.anni) {
                const cfKey = bilancio.cf.toString().trim();
                const yPrev = bilancio.anni.prev || 'NA';
                const yLast = bilancio.anni.last || 'NA';
                
                // Elimina tabelle
                const tabelleKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;
                if (localStorage.getItem(tabelleKey)) {
                    localStorage.removeItem(tabelleKey);
                    console.log('‚úÖ Tabelle eliminate:', tabelleKey);
                } else {
                    console.log('‚ö†Ô∏è Nessuna tabella trovata per:', tabelleKey);
                }
                
                // Elimina break-even
                const breakKey = `ceodoc_breakeven_${cfKey}_${yPrev}_${yLast}`;
                if (localStorage.getItem(breakKey)) {
                    localStorage.removeItem(breakKey);
                    console.log('‚úÖ Break-even eliminato:', breakKey);
                } else {
                    console.log('‚ö†Ô∏è Nessun break-even trovato per:', breakKey);
                }
            }
        } catch(e) {
            console.error('Errore eliminazione dati associati:', e);
        }
    }
    
    // Elimina il bilancio
    localStorage.removeItem(key);
    
    // Aggiorna l'indice
    let indice = JSON.parse(localStorage.getItem('ceodoc_bilanci_index') || '[]');
    indice = indice.filter(b => b.id !== id);
    localStorage.setItem('ceodoc_bilanci_index', JSON.stringify(indice));
    
    // Rimuovi l'elemento dalla UI
    const elemento = document.getElementById(`bilancio-item-${id}`);
    if (elemento) {
        elemento.style.transition = 'opacity 0.3s';
        elemento.style.opacity = '0';
        setTimeout(() => {
            elemento.remove();
            const remainingItems = document.querySelectorAll('[id^="bilancio-item-"]');
            if (remainingItems.length === 0) {
                document.querySelector('[style*="z-index: 9999"]')?.remove();
                toast("Tutti i bilanci sono stati eliminati");
            }
        }, 300);
    }
    
// Azzera tutti i campi usando la funzione esistente
if (typeof azzera === 'function') {
    azzera();
} else {
    console.error('Funzione azzera() non trovata');
}
    
    toast("Bilancio eliminato con successo");
}

function caricaBilancioById(id) {
    const key = `ceodoc_bilancio_${id}`;
    const data = localStorage.getItem(key);
    
    if (!data) {
        toast("Bilancio non trovato", true);
        return;
    }
    
    try {
        const bilancio = JSON.parse(data);
        
        // Verifica struttura dati
        if (!bilancio.dati || !bilancio.dati.spRows || !bilancio.dati.ceRows) {
            toast("Formato bilancio non valido", true);
            return;
        }
        
        state.cf = bilancio.cf;
        state.codiceFiscale = bilancio.cf; // AGGIUNTO per compatibilit√†
        state.denom = bilancio.denominazione;
        state.denominazione = bilancio.denominazione; // AGGIUNTO per compatibilit√†
        state.tipo = bilancio.tipo;
        state.settore = bilancio.settore || '';
        state.codiceAteco = bilancio.codiceAteco || '';
        state.anni = bilancio.anni || {prev: null, last: null};

        _fixAnniState();

        state.spRows = bilancio.dati.spRows;
        state.ceRows = bilancio.dati.ceRows;
        
        byId("denom").textContent = state.denom;
        byId("cf").textContent = state.cf;
        byId("tipoBil").textContent = state.tipo;
        
        // Controllo anni prima di usarli
        if (state.anni && state.anni.last && state.anni.prev) {
            byId("esercizi").textContent = `31/12/${state.anni.last} ¬∑ 31/12/${state.anni.prev}`;
        }
        
        // Aggiorna header azienda
        aggiornaHeaderAzienda();
        
        // Aggiorna i campi verdi
        updateTipoBilancio(state.tipo);
        if (state.anni && state.anni.prev && state.anni.last) {
            updateAnniConsuntivi(state.anni.prev, state.anni.last);
        }
        
        // Gestione settore
        const anagraficaAttiva = getAnagraficaAttiva();
        if (bilancio.settore) {
            selectSettore(bilancio.settore);
        } else if (anagraficaAttiva && anagraficaAttiva.settore) {
            const settoreMap = {
                'AGRICOLTURA': 'Agricoltura',
                'INDUSTRIA': 'Industria', 
                'EDILIZIA': 'Edilizia',
                'COMMERCIO': 'Commercio',
                'IMMOBILIARE': 'Immobiliare',
                'SERVIZI': 'Servizi'
            };
            const settoreMapped = settoreMap[anagraficaAttiva.settore] || anagraficaAttiva.settore;
            selectSettore(settoreMapped);
        }
        
        // Carica codice ATECO se presente
        if (bilancio.codiceAteco) {
            aggiornaAteco(bilancio.codiceAteco);
        }
        
        // Date opzionali
        if (bilancio.date) {
            byId("dtInfra").value = bilancio.date.infrannuale || '';
            byId("dtNorm").value = bilancio.date.normalizzato || '';
            byId("dtPrev1").value = bilancio.date.previsionale1 || '';
            byId("dtPrev2").value = bilancio.date.previsionale2 || '';
        }
        
        // Render tabelle
        console.log('üì¶ Carica salvato ‚Üí render ORIGINALI input:', {
            anni: { n2: state.anni?.prev, n1: state.anni?.last },
            tipo: state.tipo, SP: state.spRows?.length, CE: state.ceRows?.length
        });
        renderTables();
        setHeaderDates();
        
// Render checks con controllo errori
        try {
            renderChecksCompleti(state.spRows, state.ceRows);
        } catch(checkError) {
            console.error("Errore in renderChecksCompleti:", checkError);
            pulisciChecks();
        }
        
        // Abilita tabs
        byId("bilanciTab").disabled = false;
        byId("predisponiTab").disabled = false;
        byId("ratingTab").disabled = false;
        byId("analisiTab").disabled = false;
        
        // Chiudi modal se esiste
        const modal = document.querySelector('[style*="z-index: 9999"]');
        if (modal) modal.remove();
        
        toast("Bilancio caricato con successo! Puoi procedere: visualizza bilanci.");
        
        // Evidenzia tab
        const btnVisualizza = byId("bilanciTab");
        if (btnVisualizza) {
            btnVisualizza.style.background = '#10b981';
            setTimeout(() => {
                btnVisualizza.style.background = '';
            }, 3000);
        }
        
// CARICA AUTOMATICAMENTE LE TABELLE SALVATE SE ESISTONO
// Prima pulisci SEMPRE
state.tabellesSalvate = null;
state.breakevenSalvato = null;

// Poi carica i dati per QUESTO bilancio specifico
const cfKey = (state?.cf || state?.codiceFiscale || 'NA').toString().trim();
const yPrev = state?.anni?.prev || 'NA';
const yLast = state?.anni?.last || 'NA';
const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;
const tabelleData = localStorage.getItem(storeKey);
if (tabelleData) {
    state.tabellesSalvate = JSON.parse(tabelleData);
    console.log('‚úÖ Tabelle trovate e salvate in state per:', storeKey);
} else {
    console.log('Nessuna tabella salvata per:', storeKey);
}

// Carica anche break-even salvato
const breakKey = `ceodoc_breakeven_${cfKey}_${yPrev}_${yLast}`;
const breakData = localStorage.getItem(breakKey);
if (breakData) {
    state.breakevenSalvato = JSON.parse(breakData);
    console.log('‚úÖ Break-even trovato per:', breakKey);
}

    } catch(error) {
        console.error("Errore caricamento bilancio:", error);
        toast("Errore nel caricamento del bilancio: " + error.message, true);
    }
}


window.caricaBilancioById = caricaBilancioById;
window.eliminaBilancio = eliminaBilancio;

/* ================== RENDICONTO FINANZIARIO (INDIRETTO) ================== */
/* Nota: N-1 = last; N-2 = prev. Visualizza solo N-1, usando N-2 per variazioni */

function _rf_itOrDash(n){ return (n==null? '' : itFmt(n)); }
function _rf_num(n){ n = Number(n); return isFinite(n)? n : 0; }

/* Estrae i ‚Äúminimi sindacali‚Äù dal CE/SP standardizzati gi√† calcolati in app */
function _rf_pickStandard() {
  // usa le funzioni gi√† esistenti per comporre i totali (non modifichiamo la tua logica)
  const sp = extractStandardizedSP();
  const ce = extractStandardizedCE();

  return {
    // CE (ultimo e precedente, dove disponibile)
    utile: _rf_num(ce.utileEsercizio),                 // Utile/perdita (N-1)
    risultatoAB: _rf_num(ce.differenzaAB),            // EBIT (N-1)
    ammortamenti: _rf_num(ce.ammortamenti),           // quota ammortamenti (N-1)
    svalutazioni: _rf_num(ce.svalutazioni),           // svalutazioni (N-1)
    accantonamenti: _rf_num(ce.accantonamenti || 0),  // accantonamenti tot (N-1)
    proventiFin: _rf_num(ce.proventiFinanziari || 0),
    oneriFin: _rf_num(ce.oneriFinanziari || 0),
    imposte: _rf_num(ce.imposte || 0),
    // SP (per CCN e Œî cassa)
    rimanenze: _rf_num(sp.rimanenze || 0),
    creditiEntro: _rf_num(sp.creditiEntro12 || 0),
    creditiOltre: _rf_num(sp.creditiOltre12 || 0),
    attFinNonImm: _rf_num(sp.attFinNonImm || 0),
    rateiAttivi: _rf_num(sp.rateiRiscontiAttivi || 0),
    disponibilita: _rf_num(sp.disponibilitaLiquide || 0),

    debitiEntro: _rf_num(sp.debitiEntro12 || 0),
    debitiOltre: _rf_num(sp.debitiOltre12 || 0),
    rateiPassivi: _rf_num(sp.rateiRiscontiPassivi || 0),
    fondiRischi: _rf_num(sp.fondiRischiOneri || 0),
    tfr: _rf_num(sp.tfr || 0),

    // serve per CCN: ‚Äúfunzionamento‚Äù = (rimanenze + crediti entro) - (fornitori+altri debiti a breve)
    // NB: qui non spacchettiamo i fornitori: usiamo ‚Äúdebiti entro 12‚Äù come proxy di breve.
    // Il tuo step successivo potr√† raffinare con le tabelle crediti/debiti dettagliate.
  };
}

/* Esposizione N-2 per variazioni di CCN e Œî cassa */
function _rf_pickStandardPrev() {
  const spP = extractStandardizedSPPrev();
  const ceP = extractStandardizedCEPrev();
  return {
    // CE (per completezza/diagnostica)
    risultatoAB: _rf_num(ceP.differenzaAB || 0),
    ammortamenti: _rf_num(ceP.ammortamenti || 0),

    // SP (per Œî ccn e Œî cassa e per B/C proxy)
    rimanenze: _rf_num(spP.rimanenze || 0),
    disponibilita: _rf_num(spP.disponibilitaLiquide || 0),

    // IMMOBILIZZAZIONI (totale) ‚Äî per B proxy
    immImmateriali: _rf_num(spP.immImmateriali || 0),
    immMateriali:   _rf_num(spP.immMateriali   || 0),
    immFinanziarie: _rf_num(spP.immFinanziarie || 0),

    // ATTIVIT√Ä FINANZIARIE non immobilizzate (per B proxy, se presenti in prev)
    attFinNonImm:   _rf_num(spP.attFinNonImm   || 0),

    // Debiti a breve/lungo (per C proxy se in futuro servir√† il prev)
    debitiEntro12:  _rf_num(spP.debitiEntro12  || 0),
    debitiOltre12:  _rf_num(spP.debitiOltre12  || 0),

    // Ratei per ŒîCCN se li vuoi usare anche su prev (opzionale)
    rateiAttivi:    _rf_num(spP.rateiRiscontiAttivi  || 0),
    rateiPassivi:   _rf_num(spP.rateiRiscontiPassivi || 0),
  };
}

/* Costruisce le righe del rendiconto in memoria (numeri ‚Äúnudi‚Äù) */
function _rf_buildModel() {
  const Y = _rf_pickStandard();
  const P = _rf_pickStandardPrev();

  // ===== A) GESTIONE REDDITUALE (metodo indiretto) =====
  const EBIT = Y.risultatoAB;
  const rettificheNonMonetarie = Y.ammortamenti + Y.svalutazioni + Y.accantonamenti;

  // ŒîCCN (proxy semplice): (Rim + Crediti entro + Ratei attivi) ‚àí (Debiti entro + Ratei passivi)
  const ccnN1 = (Y.rimanenze + Y.creditiEntro + Y.rateiAttivi) - (Y.debitiEntro + Y.rateiPassivi);
  const ccnN2 = (P.rimanenze + P.rateiAttivi) - (P.debitiEntro12 + P.rateiPassivi); // crediti prev non disponibili ‚Üí 0
  const deltaCCN = ccnN1 - ccnN2;

  const interessiPagati = Y.oneriFin;
  const impostePagate   = Y.imposte;

  const utileNetto       = Y.utile;
  const flussoPrimaCCN   = EBIT + rettificheNonMonetarie;
  const flussoDopoCCN    = flussoPrimaCCN - deltaCCN;
  const altreRettifiche  = (Y.proventiFin > 0 ? Y.proventiFin : 0) - interessiPagati - impostePagate;
  const flussoGestioneA  = flussoDopoCCN + altreRettifiche;

  // ===== B) INVESTIMENTI (proxy): -Œî(Immobilizzazioni totali) - Œî(Attivit√† finanziarie non immobilizzate) =====
  const immN1 = _rf_num(
    (Y.immImmateriali || 0) + (Y.immMateriali || 0) + (Y.immFinanziarie || 0)
  );
  const immN2 = _rf_num(P.immImmateriali + P.immMateriali + P.immFinanziarie);
  const deltaImm = immN1 - immN2;          // + se cresce l'attivo immobilizzato
  const deltaAFN = _rf_num((Y.attFinNonImm || 0) - (P.attFinNonImm || 0)); // + se cresce AF non imm.
  const flussoInvestB = -(deltaImm + deltaAFN);  // crescita attivi ‚áí assorbe cassa (segno -)

  // ===== C) FINANZIAMENTO (proxy): Œî(debiti finanziari totali) =====
  // Finch√© non sporzioniamo i debiti finanziari, usiamo Œî(debiti entro + oltre) come proxy
  const debFinN1 = _rf_num((Y.debitiEntro || 0) + (Y.debitiOltre || 0));
  const debFinN2 = _rf_num((P.debitiEntro12 || 0) + (P.debitiOltre12 || 0));
  const flussoFinC = debFinN1 - debFinN2;  // aumento debiti ‚áí affluisce cassa (segno +)

  // ===== CHECK Œî CASSA =====
  const deltaCassaSP = _rf_num((Y.disponibilita || 0) - (P.disponibilita || 0));
  const deltaAtteso  = flussoGestioneA + flussoInvestB + flussoFinC;

  return {
    intest: {
      prevLabel: state.anni?.prev ? `31/12/${state.anni.prev}` : 'N-2',
      lastLabel: state.anni?.last ? `31/12/${state.anni.last}` : 'N-1',
    },
    blocchi: {
      A: {
        utileNetto,
        EBIT,
        rettificheNonMonetarie,
        flussoPrimaCCN,
        deltaCCN,
        flussoDopoCCN,
        interessiPagati,
        impostePagate,
        altreRettifiche,
        flussoGestione: flussoGestioneA
      },
      B: { flussoInvestB, deltaImm, deltaAFN },
      C: { flussoFinC, debFinN1, debFinN2 },
      check: { deltaCassaSP, deltaAtteso }
    }
  };
}

/* Renderizza nella tabella #rf-table */
function renderRendicontoFinanziario() {
  const box  = document.getElementById('rf-box');
  const body = document.getElementById('rf-body');
  if (!box || !body) return;

  const M = _rf_buildModel();

  // Header anni
  const aPrev = document.getElementById('rf-col-prev');
  const aLast = document.getElementById('rf-col-last');
  const aHdr  = document.getElementById('rf-anni');
  if (aPrev) aPrev.textContent = M.intest.prevLabel;
  if (aLast) aLast.textContent = M.intest.lastLabel;
  if (aHdr)  aHdr.textContent  = `${M.intest.lastLabel} vs ${M.intest.prevLabel}`;

  // Reset righe
  body.innerHTML = '';

  // Helper riga
  const add = (label, valPrev, valLast) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${label}</td>
      <td style="text-align:right">${_rf_itOrDash(valPrev)}</td>
      <td style="text-align:right">${_rf_itOrDash(valLast)}</td>
    `;
    body.appendChild(tr);
  };

  // ===== A) Gestione reddituale =====
  const A = M.blocchi.A;
  add('<b>A. Flussi della gestione reddituale (indiretto)</b>', '', '');
  add('Utile (perdita) dell‚Äôesercizio',                '', A.utileNetto);
  add('EBIT (A‚àíB) (proxy)',                           '', A.EBIT);
  add('Rettifiche non monetarie',                     '', A.rettificheNonMonetarie);
  add('Flusso prima delle variazioni CCN',            '', A.flussoPrimaCCN);
  add('¬± Variazioni CCN (proxy)',                     '', -A.deltaCCN);      // segno metodo indiretto
  add('Flusso dopo le variazioni CCN',                '', A.flussoDopoCCN);
  add('‚àí Imposte pagate (proxy CE)',                  '', -A.impostePagate);
  add('¬± Interessi (incassati ‚àí pagati) (proxy CE)',  '', (A.altreRettifiche + A.impostePagate));
  add('<b>Flusso gestione reddituale (A)</b>',        '', A.flussoGestione);

  // ===== B) Investimenti (proxy) =====
  const B = M.blocchi.B;
  add('<b>B. Flussi da investimenti (proxy)</b>', '', '');
  add('‚àíŒî Immobilizzazioni totali',                 '', -B.deltaImm);
  add('‚àíŒî Attivit√† finanziarie non immobilizzate',  '', -B.deltaAFN);
  add('<b>Flusso investimenti (B)</b>',             '', B.flussoInvestB);

  // ===== C) Finanziamento (proxy) =====
  const Cx = M.blocchi.C;
  add('<b>C. Flussi da finanziamento (proxy)</b>',  '', '');
  add('Œî Debiti finanziari totali (entro+oltre)',   '', Cx.flussoFinC);
  add('<b>Flusso finanziamento (C)</b>',            '', Cx.flussoFinC);

}

// esposizione globale (idempotente)
window.renderRendicontoFinanziario = renderRendicontoFinanziario;


/* ====== BILANCI STANDARDIZZATI E BREAK-EVEN ====== */


function showStdTab(tabName, ev) {
  // nascondi tutti i tab
  document.querySelectorAll('[id^="tab-"]').forEach(t => { t.style.display = 'none'; });
  // mostra quello selezionato
  const panel = document.getElementById('tab-' + tabName);
  if (panel) panel.style.display = 'block';

  // reset stile bottoni
  document.querySelectorAll('.tab-std').forEach(b => {
    b.style.background = 'none';
    b.style.fontWeight = 'normal';
    b.classList.remove('active');
  });

  // evidenzia il bottone cliccato
  const e = ev || window.event;
  const btn = e && e.target ? e.target : null;
  if (btn && btn.style) {
    btn.style.background = 'white';
    btn.style.fontWeight = '600';
    btn.classList.add('active');
  }
}

// =============== EXTRACTORS STANDARDIZZATI (display/supporto) ===============

// SP (N-1 / last) ‚Äî ricava alcuni aggregati utili solo per etichette/controlli
function extractStandardizedSP() {
  const sp = {};
  const tipo = state.tipo || 'Ordinario';
  
  // Helper per sommare da MAPPING_STANDARDIZZATO
  const sommaVoce = (key) => {
    const mapping = MAPPING_STANDARDIZZATO?.SP?.[key];
    if (!mapping || !mapping.calcolo || !mapping.calcolo[tipo]) return 0;
    
    const codici = mapping.calcolo[tipo];
    if (!Array.isArray(codici) || codici.length === 0) return 0;
    
    let somma = 0;
    for (const codice of codici) {
      const row = state.spRows.find(r => r.codice === codice);
      if (row && row.last !== null && row.last !== undefined) {
        somma += Math.abs(Number(row.last || 0));
      }
    }
    return somma;
  };
  
  // ATTIVO
  sp.creditiVsSoci = sommaVoce('crediti_soci');
  
  // B) IMMOBILIZZAZIONI
  sp.immImmateriali = sommaVoce('immobilizzazioni_immateriali');
  sp.immMateriali = sommaVoce('immobilizzazioni_materiali');
  sp.immFinanziarie = sommaVoce('immobilizzazioni_finanziarie');
  sp.immobilizzazioni = sommaVoce('totale_immobilizzazioni');
  
  // C) ATTIVO CIRCOLANTE
  sp.rimanenze = sommaVoce('rimanenze');
  sp.immDestVendita = sommaVoce('immobilizzazioni_destinate_vendita');
  
  // Crediti suddivisi
  sp.creditiEntro12 = sommaVoce('crediti_entro');
  sp.creditiOltre12 = sommaVoce('crediti_oltre');
  sp.imposteAnticipate = sommaVoce('imposte_anticipate');
  sp.totaleCrediti = sommaVoce('totale_crediti');
  
  sp.attFinNonImm = sommaVoce('attivita_finanziarie_non_immob');
  sp.disponibilitaLiquide = sommaVoce('disponibilita_liquide');
  sp.attivoCircolante = sommaVoce('totale_attivo_circolante');
  
  sp.rateiRiscontiAttivi = sommaVoce('ratei_risconti_attivi');
  sp.totaleAttivo = sommaVoce('totale_attivo');
  
  // PASSIVO
  
  // A) PATRIMONIO NETTO
  sp.capitale = sommaVoce('capitale');
  sp.riserve = sommaVoce('riserve');
  sp.utileEsercizio = sommaVoce('utile_perdita');
  sp.patrimonioNetto = sommaVoce('totale_patrimonio_netto');
  
  // B) FONDI
  sp.fondiRischiOneri = sommaVoce('fondi_rischi_oneri');
  
  // C) TFR
  sp.tfr = sommaVoce('tfr');
  
  // D) DEBITI suddivisi
  sp.debitiEntro12 = sommaVoce('debiti_entro');
  sp.debitiOltre12 = sommaVoce('debiti_oltre');
  sp.totDebiti = sommaVoce('totale_debiti');
  
  // E) RATEI E RISCONTI
  sp.rateiRiscontiPassivi = sommaVoce('ratei_risconti_passivi');
  sp.totalePassivo = sommaVoce('totale_passivo');
  
  // Alias per compatibilit√†
  sp.immobilizzazioniImmateriali = sp.immImmateriali;
  sp.immobilizzazioniMateriali = sp.immMateriali;
  sp.immobilizzazioniFinanziarie = sp.immFinanziarie;
  sp.capitaleS = sp.capitale;
  sp.attivitaFinanziarie = sp.attFinNonImm;
  
  return sp;
}

// SP (N-2 / prev)
function extractStandardizedSPPrev() {
  const sp = {};
  const tipo = state.tipo || 'Ordinario';
  
  // Helper per sommare da MAPPING_STANDARDIZZATO per PREV
  const sommaVoce = (key) => {
    const mapping = MAPPING_STANDARDIZZATO?.SP?.[key];
    if (!mapping || !mapping.calcolo || !mapping.calcolo[tipo]) return 0;
    
    const codici = mapping.calcolo[tipo];
    if (!Array.isArray(codici) || codici.length === 0) return 0;
    
    let somma = 0;
    for (const codice of codici) {
      const row = state.spRows.find(r => r.codice === codice);
      if (row && row.prev !== null && row.prev !== undefined) {
        somma += Math.abs(Number(row.prev || 0));
      }
    }
    return somma;
  };
  
  // ATTIVO
  sp.creditiVsSoci = sommaVoce('crediti_soci');
  
  // B) IMMOBILIZZAZIONI
  sp.immImmateriali = sommaVoce('immobilizzazioni_immateriali');
  sp.immMateriali = sommaVoce('immobilizzazioni_materiali');
  sp.immFinanziarie = sommaVoce('immobilizzazioni_finanziarie');
  sp.immobilizzazioni = sommaVoce('totale_immobilizzazioni');
  
  // C) ATTIVO CIRCOLANTE
  sp.rimanenze = sommaVoce('rimanenze');
  sp.immDestVendita = sommaVoce('immobilizzazioni_destinate_vendita');
  
  // Crediti suddivisi
  sp.creditiEntro12 = sommaVoce('crediti_entro');
  sp.creditiOltre12 = sommaVoce('crediti_oltre');
  sp.imposteAnticipate = sommaVoce('imposte_anticipate');
  sp.totaleCrediti = sommaVoce('totale_crediti');
  
  sp.attFinNonImm = sommaVoce('attivita_finanziarie_non_immob');
  sp.disponibilitaLiquide = sommaVoce('disponibilita_liquide');
  sp.attivoCircolante = sommaVoce('totale_attivo_circolante');
  
  sp.rateiRiscontiAttivi = sommaVoce('ratei_risconti_attivi');
  sp.totaleAttivo = sommaVoce('totale_attivo');
  
  // PASSIVO
  
  // A) PATRIMONIO NETTO
  sp.capitale = sommaVoce('capitale');
  sp.riserve = sommaVoce('riserve');
  sp.utileEsercizio = sommaVoce('utile_perdita');
  sp.patrimonioNetto = sommaVoce('totale_patrimonio_netto');
  
  // B) FONDI
  sp.fondiRischiOneri = sommaVoce('fondi_rischi_oneri');
  
  // C) TFR
  sp.tfr = sommaVoce('tfr');
  
  // D) DEBITI suddivisi
  sp.debitiEntro12 = sommaVoce('debiti_entro');
  sp.debitiOltre12 = sommaVoce('debiti_oltre');
  sp.totDebiti = sommaVoce('totale_debiti');
  
  // E) RATEI E RISCONTI
  sp.rateiRiscontiPassivi = sommaVoce('ratei_risconti_passivi');
  sp.totalePassivo = sommaVoce('totale_passivo');
  
  // Alias per compatibilit√†
  sp.immobilizzazioniImmateriali = sp.immImmateriali;
  sp.immobilizzazioniMateriali = sp.immMateriali;
  sp.immobilizzazioniFinanziarie = sp.immFinanziarie;
  sp.capitaleS = sp.capitale;
  sp.attivitaFinanziarie = sp.attFinNonImm;
  
  return sp;
}

// CE (N-1 / last)
function extractStandardizedCE() {
  const ce = {};
  const tipo = state.tipo || 'Ordinario';
  
  // Helper per sommare da MAPPING_STANDARDIZZATO
  const sommaVoce = (key) => {
    const mapping = MAPPING_STANDARDIZZATO?.CE?.[key];
    if (!mapping || !mapping.calcolo || !mapping.calcolo[tipo]) return 0;
    
    const codici = mapping.calcolo[tipo];
    if (!Array.isArray(codici) || codici.length === 0) return 0;
    
    let somma = 0;
    for (const codice of codici) {
      const row = state.ceRows.find(r => r.codice === codice);
      if (row && row.last !== null && row.last !== undefined) {
        if (key.includes('variazioni') || key === 'differenza_valore_costi' || 
            key === 'utili_perdite_cambi' || key === 'risultato_prima_imposte' || 
            key === 'utile_perdita_esercizio' || key.includes('totale')) {
          somma += Number(row.last || 0);
        } else {
          somma += Math.abs(Number(row.last || 0));
        }
      }
    }
    return somma;
  };
  
  // TUTTE LE VOCI PRINCIPALI CON MAPPING
  ce.ricaviVendite = sommaVoce('ricavi_vendite');
  ce.varRimanenzeProdotti = sommaVoce('variazioni_rimanenze_prodotti');
  ce.varLavoriCorso = sommaVoce('variazioni_lavori_corso');
  ce.incrementiImm = sommaVoce('incrementi_immobilizzazioni');
  ce.altriRicavi = sommaVoce('altri_ricavi');
  ce.valoreProduzione = sommaVoce('totale_valore_produzione');
  
  ce.materiePrime = sommaVoce('materie_prime');
  ce.servizi = sommaVoce('servizi');
  ce.godimentoBeniTerzi = sommaVoce('godimento_beni_terzi');
  ce.personale = sommaVoce('costi_personale');
  ce.ammortamenti = sommaVoce('ammortamenti_svalutazioni');
  ce.svalutazioni = 0;
  ce.varRimanenzeMaterie = sommaVoce('variazioni_rimanenze_materie');
  ce.accantonamentiRischi = sommaVoce('accantonamenti_rischi');
  ce.altriAccantonamenti = sommaVoce('altri_accantonamenti');
  ce.oneriDiversi = sommaVoce('oneri_diversi_gestione');
  ce.costiProduzione = sommaVoce('totale_costi_produzione');
  
  ce.differenzaAB = sommaVoce('differenza_valore_costi');
  
  ce.proventiPartecipazioni = sommaVoce('proventi_partecipazioni');
  ce.proventiFinanziari = sommaVoce('altri_proventi_finanziari');
  ce.oneriFinanziari = sommaVoce('interessi_oneri_finanziari');
  ce.utiliPerditeCambi = sommaVoce('utili_perdite_cambi');
  ce.totaleFinanziario = sommaVoce('totale_proventi_oneri_finanziari');
  
  ce.rivalutazioni = sommaVoce('rivalutazioni');
  ce.svalutazioniFinanz = sommaVoce('svalutazioni');
  ce.totaleRettifiche = sommaVoce('totale_rettifiche');
  
  ce.risultatoPrimaImposte = sommaVoce('risultato_prima_imposte');
  ce.imposte = sommaVoce('imposte');
  ce.utileEsercizio = sommaVoce('utile_perdita_esercizio');
  
  // INIZIALIZZA I "DI CUI" A ZERO
  ce.personale_salari = 0;
  ce.personale_oneri = 0;
  ce.personale_tfr_quiesc_altri = 0;
  ce.imposte_correnti = 0;
  ce.imposte_precedenti = 0;
  ce.imposte_diff_antic = 0;
  
  // CERCA I "DI CUI" PER NOME (come nel codice originale!)
  state.ceRows.forEach(row => {
    const voce = (row.voce || '').toLowerCase();
    const val = Math.abs(Number(row.last || 0));
    
    // Di cui Personale
    if (voce.includes('salari') && voce.includes('stipendi')) {
      ce.personale_salari = val;
    }
    if (voce.includes('oneri') && voce.includes('sociali')) {
      ce.personale_oneri = val;
    }
    if ((voce.includes('trattamento') && voce.includes('fine')) || 
        voce.includes('tfr') || voce.includes('quiescenza')) {
      ce.personale_tfr_quiesc_altri += val;
    }
    
    // Di cui Imposte  
 // Di cui Imposte (versione robusta)
if (voce.includes('imposte')) {
  const clean = voce
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // rimuove accenti tipo "√©"
    .replace(/\s+/g, ' ')
    .trim();

  // "di cui" non sempre presente, quindi cerca anche "corrente"
  if ((clean.includes('correnti') || clean.includes('corrente')) && !clean.includes('differite')) {
    ce.imposte_correnti = val;
  }

  if (clean.includes('precedent')) {
    ce.imposte_precedenti = val;
  }

  if (clean.includes('differit') || clean.includes('anticip')) {
    ce.imposte_diff_antic = val;
  }
}

  });
  
  ce.accantonamenti = (ce.accantonamentiRischi || 0) + (ce.altriAccantonamenti || 0);
  
  return ce;
}

// CE (N-2 / prev)
function extractStandardizedCEPrev() {
  const ce = {};
  const tipo = state.tipo || 'Ordinario';
  
  // Helper per sommare da MAPPING_STANDARDIZZATO per PREV
  const sommaVoce = (key) => {
    const mapping = MAPPING_STANDARDIZZATO?.CE?.[key];
    if (!mapping || !mapping.calcolo || !mapping.calcolo[tipo]) return 0;
    
    const codici = mapping.calcolo[tipo];
    if (!Array.isArray(codici) || codici.length === 0) return 0;
    
    let somma = 0;
    for (const codice of codici) {
      const row = state.ceRows.find(r => r.codice === codice);
      if (row && row.prev !== null && row.prev !== undefined) {
        // Voci che mantengono il segno
        if (key.includes('variazioni') || key === 'differenza_valore_costi' || 
            key === 'utili_perdite_cambi' || key === 'risultato_prima_imposte' || 
            key === 'utile_perdita_esercizio' || key.includes('totale')) {
          somma += Number(row.prev || 0);
        } else {
          somma += Math.abs(Number(row.prev || 0));
        }
      }
    }
    return somma;
  };
  
  // A) VALORE PRODUZIONE
  ce.ricaviVendite = sommaVoce('ricavi_vendite');
  ce.varRimanenzeProdotti = sommaVoce('variazioni_rimanenze_prodotti');
  ce.varLavoriCorso = sommaVoce('variazioni_lavori_corso');
  ce.incrementiImm = sommaVoce('incrementi_immobilizzazioni');
  ce.altriRicavi = sommaVoce('altri_ricavi');
  ce.valoreProduzione = sommaVoce('totale_valore_produzione');
  
  // B) COSTI PRODUZIONE
  ce.materiePrime = sommaVoce('materie_prime');
  ce.servizi = sommaVoce('servizi');
  ce.godimentoBeniTerzi = sommaVoce('godimento_beni_terzi');
  ce.personale = sommaVoce('costi_personale');
  ce.ammortamenti = sommaVoce('ammortamenti_svalutazioni');
  ce.svalutazioni = 0;
  ce.varRimanenzeMaterie = sommaVoce('variazioni_rimanenze_materie');
  ce.accantonamentiRischi = sommaVoce('accantonamenti_rischi');
  ce.altriAccantonamenti = sommaVoce('altri_accantonamenti');
  ce.oneriDiversi = sommaVoce('oneri_diversi_gestione');
  ce.costiProduzione = sommaVoce('totale_costi_produzione');
  
  // DIFFERENZA A-B
  ce.differenzaAB = sommaVoce('differenza_valore_costi');
  
  // C) PROVENTI E ONERI FINANZIARI
  ce.proventiPartecipazioni = sommaVoce('proventi_partecipazioni');
  ce.proventiFinanziari = sommaVoce('altri_proventi_finanziari');
  ce.oneriFinanziari = sommaVoce('interessi_oneri_finanziari');
  ce.utiliPerditeCambi = sommaVoce('utili_perdite_cambi');
  ce.totaleFinanziario = sommaVoce('totale_proventi_oneri_finanziari');
  
  // D) RETTIFICHE
  ce.rivalutazioni = sommaVoce('rivalutazioni');
  ce.svalutazioniFinanz = sommaVoce('svalutazioni');
  ce.totaleRettifiche = sommaVoce('totale_rettifiche');
  
  // RISULTATO E IMPOSTE
  ce.risultatoPrimaImposte = sommaVoce('risultato_prima_imposte');
  ce.imposte = sommaVoce('imposte');
  ce.utileEsercizio = sommaVoce('utile_perdita_esercizio');
  
  // INIZIALIZZA I "DI CUI" A ZERO
  ce.personale_salari = 0;
  ce.personale_oneri = 0;
  ce.personale_tfr_quiesc_altri = 0;
  ce.imposte_correnti = 0;
  ce.imposte_precedenti = 0;
  ce.imposte_diff_antic = 0;
  
  // CERCA I "DI CUI" PER NOME (usando PREV!)
  state.ceRows.forEach(row => {
    const voce = (row.voce || '').toLowerCase();
    const val = Math.abs(Number(row.prev || 0)); // PREV non LAST!
    
    // Di cui Personale
    if (voce.includes('salari') && voce.includes('stipendi')) {
      ce.personale_salari = val;
    }
    if (voce.includes('oneri') && voce.includes('sociali')) {
      ce.personale_oneri = val;
    }
    if ((voce.includes('trattamento') && voce.includes('fine')) || 
        voce.includes('tfr') || voce.includes('quiescenza')) {
      ce.personale_tfr_quiesc_altri = (ce.personale_tfr_quiesc_altri || 0) + val;
    }
    // Altri costi del personale
    if (voce.includes('altri') && voce.includes('costi') && 
        (voce.includes('9e') || voce.includes('e)') || voce.includes('personale'))) {
      ce.personale_tfr_quiesc_altri = (ce.personale_tfr_quiesc_altri || 0) + val;
    }
    
    // Di cui Imposte
   // Di cui Imposte (versione robusta)
if (voce.includes('imposte')) {
  const clean = voce
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // rimuove accenti tipo "√©"
    .replace(/\s+/g, ' ')
    .trim();

  // "di cui" non sempre presente, quindi cerca anche "corrente"
  if ((clean.includes('correnti') || clean.includes('corrente')) && !clean.includes('differite')) {
    ce.imposte_correnti = val;
  }

  if (clean.includes('precedent')) {
    ce.imposte_precedenti = val;
  }

  if (clean.includes('differit') || clean.includes('anticip')) {
    ce.imposte_diff_antic = val;
  }
}

  });
  
  // Aggregati
  ce.accantonamenti = (ce.accantonamentiRischi || 0) + (ce.altriAccantonamenti || 0);
  
  return ce;
}

window.extractStandardizedSP = extractStandardizedSP;
window.extractStandardizedSPPrev = extractStandardizedSPPrev;
window.extractStandardizedCE = extractStandardizedCE;
window.extractStandardizedCEPrev = extractStandardizedCEPrev;


function generaBilanciStandardHTML() {
  const DEBUG = (typeof window !== 'undefined' && window.DEBUG === true);

  // Anni/etichette
  const annoPrev = state?.anni?.prev ?? null;
  const annoLast = state?.anni?.last ?? null;
  const yPrevLbl = annoPrev ?? 'N-2';
  const yLastLbl = annoLast ?? 'N-1';

  const tipo = state?.tipo || 'Abbreviato'; // 'Ordinario' | 'Abbreviato' | 'Micro'

  if (DEBUG) {
    console.log('üß© STD start', {
      tipo,
      anni: { prev: annoPrev, last: annoLast },
      sp: state?.spRows?.length,
      ce: state?.ceRows?.length
    });
  }

// Indicizzazione per codice - CORREZIONE COMPLETA
const spByCode = {};
const ceByCode = {};

// Verifica che state.spRows abbia il campo 'codice'
console.log('üîç Verifica struttura spRows:', state.spRows?.[0]);
console.log('üîç Verifica struttura ceRows:', state.ceRows?.[0]);

// Indicizza SP
for (const r of (state.spRows || [])) {
  if (r && r.codice) {
    spByCode[r.codice] = r;
  } else if (r) {
    console.warn('‚ö†Ô∏è SP row senza codice:', r);
  }
}

// Indicizza CE
for (const r of (state.ceRows || [])) {
  if (r && r.codice) {
    ceByCode[r.codice] = r;
  } else if (r) {
    console.warn('‚ö†Ô∏è CE row senza codice:', r);
  }
}

console.log(`üìä Indicizzati: SP=${Object.keys(spByCode).length} voci, CE=${Object.keys(ceByCode).length} voci`);
// Somma via mapping standardizzato, tollerante a liste vuote
function sumStd(sezione, key) {
  const lista = (MAPPING_STANDARDIZZATO?.[sezione]?.[key]?.calcolo?.[tipo]) || [];
  
  // Caso "schema non prevede la voce" (lista vuota)
  if (!Array.isArray(lista) || lista.length === 0) {
    return { last: 0, prev: 0, hit: false, _empty: true };
  }
  
  let last = 0, prev = 0, hit = false;
  
  // DEBUG: verifica che le indicizzazioni esistano
  if ((sezione === 'SP' && (!spByCode || Object.keys(spByCode).length === 0)) ||
      (sezione === 'CE' && (!ceByCode || Object.keys(ceByCode).length === 0))) {
    console.warn(`‚ö†Ô∏è Indicizzazione mancante per ${sezione}`);
    
    // FALLBACK: cerca direttamente nell'array state.spRows/ceRows
    const rows = sezione === 'SP' ? (state.spRows || []) : (state.ceRows || []);
    
    for (const codice of lista) {
      const row = rows.find(r => r.codice === codice);
      if (row) {
        hit = true;
        last += Number(row.last || 0);
        prev += Number(row.prev || 0);
        
        // DEBUG per crediti/debiti
        if (key === 'crediti_entro' || key === 'debiti_entro') {
          console.log(`‚úì ${key} trovato ${codice}:`, row.voce, row.last);
        }
      }
    }
  } else {
    // USA INDICIZZAZIONE (percorso normale)
    for (const codice of lista) {
      const row = (sezione === 'SP' ? spByCode[codice] : ceByCode[codice]);
      
      if (row) {
        hit = true;
        last += Number(row.last || 0);
        prev += Number(row.prev || 0);
        
        // DEBUG per crediti/debiti
        if (key === 'crediti_entro' || key === 'crediti_oltre' || 
            key === 'debiti_entro' || key === 'debiti_oltre') {
          console.log(`‚úì ${key} aggregato ${codice}:`, row.voce, row.last);
        }
      } else if (key === 'crediti_entro' || key === 'crediti_oltre' || 
                 key === 'debiti_entro' || key === 'debiti_oltre') {
        console.log(`‚úó ${key} mancante ${codice}`);
      }
    }
  }
  
  // LOG finale per crediti/debiti
  if (key === 'crediti_entro' || key === 'crediti_oltre' || 
      key === 'debiti_entro' || key === 'debiti_oltre') {
    console.log(`üìä TOTALE ${key}: last=${last}, prev=${prev}, hit=${hit}`);
  }
  
  return { last, prev, hit, _empty: false };
}

  // ===== STATO PATRIMONIALE =====
  // Attivo
  const A_creditiSoci       = sumStd('SP', 'crediti_soci');
  const B_immImmateriali    = sumStd('SP', 'immobilizzazioni_immateriali');
  const B_immMateriali      = sumStd('SP', 'immobilizzazioni_materiali');
  const B_immFinanziarie    = sumStd('SP', 'immobilizzazioni_finanziarie');
  const B_totImm            = sumStd('SP', 'totale_immobilizzazioni');

  const C_rimanenze         = sumStd('SP', 'rimanenze');
  const C_immDestVendita    = sumStd('SP', 'immobilizzazioni_destinate_vendita');
  const C_creditiEntro      = sumStd('SP', 'crediti_entro');
  const C_creditiOltre      = sumStd('SP', 'crediti_oltre');
  const C_imposteAnticipate = sumStd('SP', 'imposte_anticipate');
  const C_totaleCrediti     = sumStd('SP', 'totale_crediti');
  const C_attFinNonImm      = sumStd('SP', 'attivita_finanziarie_non_immob');
  const C_disponibilita     = sumStd('SP', 'disponibilita_liquide');
  const C_totAttCirc        = sumStd('SP', 'totale_attivo_circolante');

  const D_rateiAttivi       = sumStd('SP', 'ratei_risconti_attivi');
  const SP_totAttivo        = sumStd('SP', 'totale_attivo');

// Crediti: se (entro+oltre+imposte anticipate) != totale crediti, NON azzerare (mostra i numeri che ci sono)
(function fixCreditiSplit() {
  const tot = Number(C_totaleCrediti.last || 0);
  const comp = Number(C_creditiEntro.last || 0) + Number(C_creditiOltre.last || 0) + Number(C_imposteAnticipate.last || 0);
  if (tot > 0 && Math.abs(comp - tot) / tot > 0.01) {
    C_creditiEntro.hit = false;
    C_creditiOltre.hit = false;
  }
  const totP = Number(C_totaleCrediti.prev || 0);
  const compP = Number(C_creditiEntro.prev || 0) + Number(C_creditiOltre.prev || 0) + Number(C_imposteAnticipate.prev || 0);
  if (totP > 0 && Math.abs(compP - totP) / totP > 0.01) {
    C_creditiEntro.hit = false;
    C_creditiOltre.hit = false;
  }
})();

  // Passivo
  const PN_capitale         = sumStd('SP', 'capitale');
  const PN_riserveAgg       = sumStd('SP', 'riserve');
  const PN_utile            = sumStd('SP', 'utile_perdita');
  const PN_totale           = sumStd('SP', 'totale_patrimonio_netto');

  const B_fondiRischi       = sumStd('SP', 'fondi_rischi_oneri');
  const C_tfr               = sumStd('SP', 'tfr');
  const D_debitiEntro       = sumStd('SP', 'debiti_entro');
  const D_debitiOltre       = sumStd('SP', 'debiti_oltre');
  const D_totDebiti         = sumStd('SP', 'totale_debiti');

// Debiti: stessa logica (non azzerare)
(function fixDebitiSplit() {
  const tot = Number(D_totDebiti.last || 0);
  const comp = Number(D_debitiEntro.last || 0) + Number(D_debitiOltre.last || 0);
  if (tot > 0 && Math.abs(comp - tot) / tot > 0.01) {
    D_debitiEntro.hit = false;
    D_debitiOltre.hit = false;
  }
  const totP = Number(D_totDebiti.prev || 0);
  const compP = Number(D_debitiEntro.prev || 0) + Number(D_debitiOltre.prev || 0);
  if (totP > 0 && Math.abs(compP - totP) / totP > 0.01) {
    D_debitiEntro.hit = false;
    D_debitiOltre.hit = false;
  }
})();

  const E_rateiPassivi      = sumStd('SP', 'ratei_risconti_passivi');
  const SP_totPassivo       = sumStd('SP', 'totale_passivo');

  // ===== CONTO ECONOMICO =====
  const A1_ricavi        = sumStd('CE', 'ricavi_vendite');
  const A2_varRimProd    = sumStd('CE', 'variazioni_rimanenze_prodotti');
  const A3_varLavori     = sumStd('CE', 'variazioni_lavori_corso');
  const A4_incrImm       = sumStd('CE', 'incrementi_immobilizzazioni');
  const A5_altriRicavi   = sumStd('CE', 'altri_ricavi');
  const A_totValProd     = sumStd('CE', 'totale_valore_produzione');

  const B6_materie       = sumStd('CE', 'materie_prime');
  const B7_servizi       = sumStd('CE', 'servizi');
  const B8_godimento     = sumStd('CE', 'godimento_beni_terzi');
  const B9_personale     = sumStd('CE', 'costi_personale');
  const B10_ammSval      = sumStd('CE', 'ammortamenti_svalutazioni');
  const B11_varRimMat    = sumStd('CE', 'variazioni_rimanenze_materie');
  const B12_accRischi    = sumStd('CE', 'accantonamenti_rischi');
  const B13_altriAcc     = sumStd('CE', 'altri_accantonamenti');
  const B14_oneriDiversi = sumStd('CE', 'oneri_diversi');
  const B_totCosti       = sumStd('CE', 'totale_costi_produzione');
  const diffAB           = sumStd('CE', 'differenza_valore_costi');

  const C15_provPart     = sumStd('CE', 'proventi_partecipazioni');
  const C16_altriProvFin = sumStd('CE', 'altri_proventi_finanziari');
  const C17_oneriFin     = sumStd('CE', 'interessi_oneri_finanziari');
  const C17bis_cambi     = sumStd('CE', 'utili_perdite_cambi');
  const C_totFin         = sumStd('CE', 'totale_proventi_oneri_finanziari');

  const D18_rivalutazioni= sumStd('CE', 'rivalutazioni');
  const D19_svalutazioni = sumStd('CE', 'svalutazioni');
  const D_totRettifiche  = sumStd('CE', 'totale_rettifiche');

  const CE_risAnteImposte= sumStd('CE', 'risultato_prima_imposte');
  const CE_imposte       = sumStd('CE', 'imposte');
  const CE_utile         = sumStd('CE', 'utile_perdita_esercizio');

  // Di-cui (solo display)
  const _ceLast = (typeof extractStandardizedCE === 'function')     ? (extractStandardizedCE()     || {}) : {};
  const _cePrev = (typeof extractStandardizedCEPrev === 'function') ? (extractStandardizedCEPrev() || {}) : {};

  const B9a_salari   = { prev: Number(_cePrev.personale_salari || 0),             last: Number(_ceLast.personale_salari || 0) };
  const B9b_oneri    = { prev: Number(_cePrev.personale_oneri  || 0),             last: Number(_ceLast.personale_oneri  || 0) };
  const B9c_tfrAltri = { prev: Number(_cePrev.personale_tfr_quiesc_altri || 0),   last: Number(_ceLast.personale_tfr_quiesc_altri || 0) };

  const CE_imp_correnti = { prev: Number(_cePrev.imposte_correnti   || 0),        last: Number(_ceLast.imposte_correnti   || 0) };
  const CE_imp_prec     = { prev: Number(_cePrev.imposte_precedenti || 0),        last: Number(_ceLast.imposte_precedenti || 0) };
  const CE_imp_diff     = { prev: Number(_cePrev.imposte_diff_antic || 0),        last: Number(_ceLast.imposte_diff_antic || 0) };

  // Utility UI
  const itOrDash = (n, hit) => {
    if (!hit && Number(n) === 0) return '‚Äî';
    return (n === null || n === undefined) ? '' : itFmt(n);
  };
  const varPerc = (n1, n0) => {
    const a = Number(n1 ?? 0);
    const b = Number(n0 ?? 0);
    if (!Number.isFinite(a) || !Number.isFinite(b)) return '‚Äî';
    if (b === 0) return (a === 0) ? '‚Äî' : (a > 0 ? '+‚àû' : '-‚àû');
    const p = ((a - b) / Math.abs(b)) * 100;
    return `${p > 0 ? '+' : ''}${p.toFixed(1)}%`;
  };

  // ===== HTML SP =====
  const spHTML = `
  <table style="width:100%; border-collapse:collapse; font-size:12px;">
    <thead>
      <tr style="background:#eee;">
        <th style="text-align:left; padding:6px;">Stato patrimoniale Standardizzato</th>
        <th style="text-align:right; padding:6px; width:120px;">${yPrevLbl}</th>
        <th style="text-align:right; padding:6px; width:120px;">${yLastLbl}</th>
        <th style="text-align:center; padding:6px; width:80px;">Œî%</th>
      </tr>
    </thead>
    <tbody>
      <tr><td style="padding:6px; font-weight:bold;">Attivo</td><td></td><td></td><td></td></tr>

      <tr>
        <td style="padding:6px;">A) Crediti verso soci per versamenti ancora dovuti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A_creditiSoci.prev, A_creditiSoci.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A_creditiSoci.last, A_creditiSoci.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A_creditiSoci.last, A_creditiSoci.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">B) Immobilizzazioni</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px;">I - Immobilizzazioni immateriali</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immImmateriali.prev, B_immImmateriali.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immImmateriali.last, B_immImmateriali.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_immImmateriali.last, B_immImmateriali.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">II - Immobilizzazioni materiali</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immMateriali.prev, B_immMateriali.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immMateriali.last, B_immMateriali.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_immMateriali.last, B_immMateriali.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">III - Immobilizzazioni finanziarie</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immFinanziarie.prev, B_immFinanziarie.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_immFinanziarie.last, B_immFinanziarie.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_immFinanziarie.last, B_immFinanziarie.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale immobilizzazioni (B)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_totImm.prev, B_totImm.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_totImm.last, B_totImm.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_totImm.last, B_totImm.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">C) Attivo circolante</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px;">I - Rimanenze</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_rimanenze.prev, C_rimanenze.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_rimanenze.last, C_rimanenze.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_rimanenze.last, C_rimanenze.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">Immobilizzazioni materiali destinate alla vendita</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_immDestVendita.prev, C_immDestVendita.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_immDestVendita.last, C_immDestVendita.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_immDestVendita.last, C_immDestVendita.prev)}</td>
      </tr>

      <tr><td style="padding:6px;">II - Crediti</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">esigibili entro l'esercizio successivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_creditiEntro.prev, C_creditiEntro.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_creditiEntro.last, C_creditiEntro.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_creditiEntro.last, C_creditiEntro.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">esigibili oltre l'esercizio successivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_creditiOltre.prev, C_creditiOltre.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_creditiOltre.last, C_creditiOltre.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_creditiOltre.last, C_creditiOltre.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">imposte anticipate</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_imposteAnticipate.prev, C_imposteAnticipate.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_imposteAnticipate.last, C_imposteAnticipate.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_imposteAnticipate.last, C_imposteAnticipate.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px; font-weight:bold;">Totale crediti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totaleCrediti.prev, C_totaleCrediti.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totaleCrediti.last, C_totaleCrediti.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_totaleCrediti.last, C_totaleCrediti.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">III - Attivit√† finanziarie che non costituiscono immobilizzazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_attFinNonImm.prev, C_attFinNonImm.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_attFinNonImm.last, C_attFinNonImm.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_attFinNonImm.last, C_attFinNonImm.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">IV - Disponibilit√† liquide</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_disponibilita.prev, C_disponibilita.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_disponibilita.last, C_disponibilita.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_disponibilita.last, C_disponibilita.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale attivo circolante (C)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totAttCirc.prev, C_totAttCirc.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totAttCirc.last, C_totAttCirc.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_totAttCirc.last, C_totAttCirc.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">D) Ratei e risconti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_rateiAttivi.prev, D_rateiAttivi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_rateiAttivi.last, D_rateiAttivi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D_rateiAttivi.last, D_rateiAttivi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale attivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(SP_totAttivo.prev, SP_totAttivo.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(SP_totAttivo.last, SP_totAttivo.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(SP_totAttivo.last, SP_totAttivo.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold; border-top:2px solid #ddd;">Passivo</td><td style="border-top:2px solid #ddd;"></td><td style="border-top:2px solid #ddd;"></td><td style="border-top:2px solid #ddd;"></td></tr>

      <tr><td style="padding:6px; font-weight:bold;">A) Patrimonio netto</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px;">I - Capitale</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_capitale.prev, PN_capitale.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_capitale.last, PN_capitale.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(PN_capitale.last, PN_capitale.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">Riserve (somma II, III, IV, V, VII, VIII, perdita ripianata, X)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_riserveAgg.prev, PN_riserveAgg.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_riserveAgg.last, PN_riserveAgg.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(PN_riserveAgg.last, PN_riserveAgg.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">IX - Utile (perdita) dell'esercizio</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_utile.prev, PN_utile.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_utile.last, PN_utile.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(PN_utile.last, PN_utile.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale patrimonio netto</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_totale.prev, PN_totale.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(PN_totale.last, PN_totale.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(PN_totale.last, PN_totale.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">B) Fondi per rischi e oneri</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_fondiRischi.prev, B_fondiRischi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_fondiRischi.last, B_fondiRischi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_fondiRischi.last, B_fondiRischi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">C) Trattamento di fine rapporto di lavoro subordinato</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_tfr.prev, C_tfr.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_tfr.last, C_tfr.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_tfr.last, C_tfr.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">D) Debiti</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">esigibili entro l'esercizio successivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_debitiEntro.prev, D_debitiEntro.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_debitiEntro.last, D_debitiEntro.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D_debitiEntro.last, D_debitiEntro.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">esigibili oltre l'esercizio successivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_debitiOltre.prev, D_debitiOltre.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_debitiOltre.last, D_debitiOltre.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D_debitiOltre.last, D_debitiOltre.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale debiti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_totDebiti.prev, D_totDebiti.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_totDebiti.last, D_totDebiti.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D_totDebiti.last, D_totDebiti.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">E) Ratei e risconti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(E_rateiPassivi.prev, E_rateiPassivi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(E_rateiPassivi.last, E_rateiPassivi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(E_rateiPassivi.last, E_rateiPassivi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale passivo</td>
        <td style="text-align:right; padding:6px;">${itOrDash(SP_totPassivo.prev, SP_totPassivo.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(SP_totPassivo.last, SP_totPassivo.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(SP_totPassivo.last, SP_totPassivo.prev)}</td>
      </tr>
    </tbody>
  </table>
  `;

  // ===== CE HTML =====
  const ceHTML = `
  <table style="width:100%; border-collapse:collapse; font-size:12px;">
    <thead>
      <tr style="background:#eee;">
        <th style="text-align:left; padding:6px;">Conto economico Standardizzato</th>
        <th style="text-align:right; padding:6px; width:120px;">${yPrevLbl}</th>
        <th style="text-align:right; padding:6px; width:120px;">${yLastLbl}</th>
        <th style="text-align:center; padding:6px; width:80px;">Œî%</th>
      </tr>
    </thead>
    <tbody>
      <tr><td style="padding:6px; font-weight:bold;">A) Valore della produzione</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px;">1) ricavi delle vendite e delle prestazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A1_ricavi.prev, A1_ricavi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A1_ricavi.last, A1_ricavi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A1_ricavi.last, A1_ricavi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">2) variazioni delle rimanenze di prodotti in corso di lavorazione, semilavorati e finiti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A2_varRimProd.prev, A2_varRimProd.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A2_varRimProd.last, A2_varRimProd.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A2_varRimProd.last, A2_varRimProd.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">3) variazioni dei lavori in corso su ordinazione</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A3_varLavori.prev, A3_varLavori.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A3_varLavori.last, A3_varLavori.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A3_varLavori.last, A3_varLavori.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">4) incrementi di immobilizzazioni per lavori interni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A4_incrImm.prev, A4_incrImm.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A4_incrImm.last, A4_incrImm.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A4_incrImm.last, A4_incrImm.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">5) altri ricavi e proventi = Totale altri ricavi e proventi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A5_altriRicavi.prev, A5_altriRicavi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A5_altriRicavi.last, A5_altriRicavi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A5_altriRicavi.last, A5_altriRicavi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale valore della produzione</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A_totValProd.prev, A_totValProd.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(A_totValProd.last, A_totValProd.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(A_totValProd.last, A_totValProd.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">B) Costi della produzione</td><td></td><td></td><td></td></tr>
      <tr>
        <td style="padding:6px;">6) per materie prime, sussidiarie, di consumo e di merci</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B6_materie.prev, B6_materie.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B6_materie.last, B6_materie.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B6_materie.last, B6_materie.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">7) per servizi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B7_servizi.prev, B7_servizi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B7_servizi.last, B7_servizi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B7_servizi.last, B7_servizi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">8) per godimento di beni di terzi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B8_godimento.prev, B8_godimento.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B8_godimento.last, B8_godimento.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B8_godimento.last, B8_godimento.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">9) per il personale = Totale costi per il personale</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9_personale.prev, B9_personale.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9_personale.last, B9_personale.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B9_personale.last, B9_personale.prev)}</td>
      </tr>

      <!-- di cui personale -->
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: a) salari e stipendi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9a_salari.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9a_salari.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B9a_salari.last, B9a_salari.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: b) oneri sociali</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9b_oneri.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9b_oneri.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B9b_oneri.last, B9b_oneri.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: c) TFR / quiescenza / altri</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9c_tfrAltri.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B9c_tfrAltri.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B9c_tfrAltri.last, B9c_tfrAltri.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">10) ammortamenti e svalutazioni = Totale ammortamenti e svalutazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B10_ammSval.prev, B10_ammSval.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B10_ammSval.last, B10_ammSval.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B10_ammSval.last, B10_ammSval.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">11) variazioni delle rimanenze di materie prime, sussidiarie, di consumo e merci</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B11_varRimMat.prev, B11_varRimMat.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B11_varRimMat.last, B11_varRimMat.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B11_varRimMat.last, B11_varRimMat.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">12) accantonamenti per rischi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B12_accRischi.prev, B12_accRischi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B12_accRischi.last, B12_accRischi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B12_accRischi.last, B12_accRischi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">13) altri accantonamenti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B13_altriAcc.prev, B13_altriAcc.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B13_altriAcc.last, B13_altriAcc.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B13_altriAcc.last, B13_altriAcc.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">14) oneri diversi di gestione</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B14_oneriDiversi.prev, B14_oneriDiversi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B14_oneriDiversi.last, B14_oneriDiversi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B14_oneriDiversi.last, B14_oneriDiversi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale costi della produzione</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_totCosti.prev, B_totCosti.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(B_totCosti.last, B_totCosti.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(B_totCosti.last, B_totCosti.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">Differenza tra valore e costi della produzione (A - B)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(diffAB.prev, diffAB.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(diffAB.last, diffAB.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(diffAB.last, diffAB.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">C) Proventi e oneri finanziari</td><td></td><td></td><td></td></tr>

      ${(!C15_provPart._empty) ? `
      <tr>
        <td style="padding:6px;">15) proventi da partecipazioni = Totale proventi da partecipazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C15_provPart.prev, C15_provPart.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C15_provPart.last, C15_provPart.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C15_provPart.last, C15_provPart.prev)}</td>
      </tr>
      ` : ''}

      ${(!C16_altriProvFin._empty) ? `
      <tr>
        <td style="padding:6px;">16) altri proventi finanziari = Totale altri proventi finanziari</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C16_altriProvFin.prev, C16_altriProvFin.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C16_altriProvFin.last, C16_altriProvFin.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C16_altriProvFin.last, C16_altriProvFin.prev)}</td>
      </tr>
      ` : ''}

      <tr>
        <td style="padding:6px;">17) interessi e altri oneri finanziari = Totale interessi e altri oneri finanziari</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C17_oneriFin.prev, C17_oneriFin.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C17_oneriFin.last, C17_oneriFin.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C17_oneriFin.last, C17_oneriFin.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px;">17-bis) utili e perdite su cambi</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C17bis_cambi.prev, C17bis_cambi.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C17bis_cambi.last, C17bis_cambi.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C17bis_cambi.last, C17bis_cambi.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Totale proventi e oneri finanziari (15 + 16 - 17 + - 17-bis)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totFin.prev, C_totFin.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(C_totFin.last, C_totFin.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(C_totFin.last, C_totFin.prev)}</td>
      </tr>

      <tr><td style="padding:6px; font-weight:bold;">D) Rettifiche di valore di attivit√† e passivit√† finanziarie</td><td></td><td></td><td></td></tr>

      ${(!D18_rivalutazioni._empty) ? `
      <tr>
        <td style="padding:6px;">18) rivalutazioni = Totale rivalutazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D18_rivalutazioni.prev, D18_rivalutazioni.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D18_rivalutazioni.last, D18_rivalutazioni.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D18_rivalutazioni.last, D18_rivalutazioni.prev)}</td>
      </tr>
      ` : ''}

      ${(!D19_svalutazioni._empty) ? `
      <tr>
        <td style="padding:6px;">19) svalutazioni = Totale svalutazioni</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D19_svalutazioni.prev, D19_svalutazioni.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D19_svalutazioni.last, D19_svalutazioni.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D19_svalutazioni.last, D19_svalutazioni.prev)}</td>
      </tr>
      ` : ''}

      <tr>
        <td style="padding:6px;">Totale delle rettifiche di valore di attivit√† e passivit√† finanziarie (18 - 19)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_totRettifiche.prev, D_totRettifiche.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(D_totRettifiche.last, D_totRettifiche.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(D_totRettifiche.last, D_totRettifiche.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">Risultato prima delle imposte (A - B + - C + - D)</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_risAnteImposte.prev, CE_risAnteImposte.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_risAnteImposte.last, CE_risAnteImposte.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_risAnteImposte.last, CE_risAnteImposte.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px;">20) Imposte sul reddito dell'esercizio, correnti, differite e anticipate = Totale delle imposte sul reddito dell'esercizio, correnti, differite e anticipate</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imposte.prev, CE_imposte.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imposte.last, CE_imposte.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_imposte.last, CE_imposte.prev)}</td>
      </tr>

      <!-- di cui imposte -->
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: imposte correnti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_correnti.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_correnti.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_imp_correnti.last, CE_imp_correnti.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: imposte esercizi precedenti</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_prec.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_prec.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_imp_prec.last, CE_imp_prec.prev)}</td>
      </tr>
      <tr>
        <td style="padding:6px; padding-left:18px;">di cui: imposte differite e anticipate</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_diff.prev, true)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_imp_diff.last, true)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_imp_diff.last, CE_imp_diff.prev)}</td>
      </tr>

      <tr>
        <td style="padding:6px; font-weight:bold;">21) Utile (perdita) dell'esercizio</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_utile.prev, CE_utile.hit)}</td>
        <td style="text-align:right; padding:6px;">${itOrDash(CE_utile.last, CE_utile.hit)}</td>
        <td style="text-align:center; padding:6px;">${varPerc(CE_utile.last, CE_utile.prev)}</td>
      </tr>

    </tbody>
  </table>
  `;

  const headerBox = `
    <div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:8px;">
      <div style="font-weight:bold;color:#003d82;font-size:16px;">
        üìä BILANCIO STANDARDIZZATO - ${tipo.toUpperCase()}
      </div>
      <div style="font-size:11px;color:#666;margin-top:5px;">
        Esercizi: ${yPrevLbl}-${yLastLbl} |
        Crediti: ‚Ç¨${itFmt((C_creditiEntro.last||0)+(C_creditiOltre.last||0))} |
        Debiti: ‚Ç¨${itFmt((D_debitiEntro.last||0)+(D_debitiOltre.last||0))}
      </div>
    </div>
  `;

  const quad = `
    <div style="margin-top:20px;padding:10px;background:#f0f9ff;border-radius:6px;">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
        <div style="text-align:center;">
          <div style="font-size:10px;color:#666;">Tot. Attivo</div>
          <div style="font-size:14px;font-weight:bold;color:#003d82;">${itFmt(SP_totAttivo.last)}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:10px;color:#666;">Tot. Passivo</div>
          <div style="font-size:14px;font-weight:bold;color:#003d82;">${itFmt(SP_totPassivo.last)}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:10px;color:#666;">Quadratura</div>
          <div style="font-size:14px;font-weight:bold;color:${SP_totAttivo.last===SP_totPassivo.last ? '#10b981' : '#dc2626'};">
            ${SP_totAttivo.last===SP_totPassivo.last ? '‚úì OK' : '‚úó NO'}
          </div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:10px;color:#666;">Risultato</div>
          <div style="font-size:14px;font-weight:bold;color:${(CE_utile.last||0)>=0 ? '#10b981' : '#dc2626'};">
            ${itFmt(CE_utile.last||0)}
          </div>
        </div>
      </div>
    </div>
  `;

// ‚úÖ Salva snapshot CE/SP standardizzati nello stato globale per analisi successive (usato da DSCR, Z-Score, ROI, ecc.)
state.prevCE = extractStandardizedCEPrev();
state.lastCE = extractStandardizedCE();
state.prevSP = extractStandardizedSPPrev();
state.lastSP = extractStandardizedSP();

console.log("üì¶ Snapshot bilanci standardizzati salvati in state:", {
  prevCE: state.prevCE?.imposte_correnti,
  lastCE: state.lastCE?.imposte_correnti
});


  return `
    ${headerBox}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden;max-height:80vh;overflow-y:auto;">
        <div style="background:#003d82;color:white;padding:10px;font-weight:bold;position:sticky;top:0;z-index:10;">
          STATO PATRIMONIALE
        </div>
        ${spHTML}
      </div>
      <div style="border:1px solid #ddd;border-radius:8px;overflow:hidden;max-height:80vh;overflow-y:auto;">
        <div style="background:#003d82;color:white;padding:10px;font-weight:bold;position:sticky;top:0;z-index:10;">
          CONTO ECONOMICO
        </div>
        ${ceHTML}
      </div>
    </div>
    ${quad}
  `;
}
  
function generaTabelleHTML() {
  const tipo = state?.tipo || 'Abbreviato';
  const annoPrev = state?.anni?.prev || '2023';
  const annoLast = state?.anni?.last || '2024';
  
  const isOrdinario = (tipo === 'Ordinario');
  const readonly = isOrdinario ? 'readonly' : '';
  const autoStyle = isOrdinario ? 'background:#e8f5e9;border:1px solid #4caf50;' : '';
  const inputStyle = !isOrdinario ? 'background:#fff3e0;border:2px solid #ff9800;' : '';
  
  return `
    <div style="padding: 20px; font-family: 'Courier New', monospace;">
      
      <!-- TABELLA CREDITI -->
      <div style="margin-bottom: 30px; border: 2px solid #1976d2; border-radius: 8px; padding: 15px;">
        <h3 style="color: #1976d2; margin-top: 0;">üìä CREDITI ${isOrdinario ? '(ORDINARIO - AUTO)' : '(ABBREVIATO/MICRO - MANUALE)'}</h3>
        
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #e3f2fd;">
              <th style="text-align: left; padding: 10px; width: 50%;">Voce</th>
              <th style="text-align: center; padding: 10px; width: 25%;">31/12/${annoPrev}</th>
              <th style="text-align: center; padding: 10px; width: 25%;">31/12/${annoLast}</th>
            </tr>
          </thead>
          <tbody>
            <!-- TOTALE CREDITI -->
            <tr style="background: #bbdefb; font-weight: bold;">
              <td style="padding: 8px;">CREDITI TOTALE</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_totale_prev" readonly
                       style="width: 100%; text-align: right; background:#c5e1a5; border:2px solid #689f38; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_totale_last" readonly
                       style="width: 100%; text-align: right; background:#c5e1a5; border:2px solid #689f38; padding:5px; font-weight:bold;">
              </td>
            </tr>
            
            <!-- SEZIONE ENTRO 12 MESI -->
            <tr style="background: #f5f5f5;">
              <td colspan="3" style="padding: 8px; font-weight: bold; color: #424242;">
                üìÅ ENTRO 12 MESI
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Commerciali (1)</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_comm_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_comm_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Tributari (5-bis)</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_trib_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_trib_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Altri ${isOrdinario ? '(2+3+4+5)' : ''}</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_altri_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_e_altri_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr style="background: #e1f5fe;">
              <td style="padding: 8px; padding-left: 30px; font-weight: bold;">‚îî‚îÄ TOTALE ENTRO</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_entro_prev" readonly
                       style="width: 100%; text-align: right; background:#81d4fa; border:2px solid #0288d1; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_entro_last" readonly
                       style="width: 100%; text-align: right; background:#81d4fa; border:2px solid #0288d1; padding:5px; font-weight:bold;">
              </td>
            </tr>
            
            <!-- SEZIONE OLTRE 12 MESI -->
            <tr style="background: #f5f5f5;">
              <td colspan="3" style="padding: 8px; font-weight: bold; color: #424242;">
                üìÅ OLTRE 12 MESI
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Commerciali (1)</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_comm_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_comm_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Tributari (5-bis)</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_trib_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_trib_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Altri ${isOrdinario ? '(2+3+4+5)' : ''}</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_altri_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_o_altri_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliCrediti();">
              </td>
            </tr>
            
            <tr style="background: #e1f5fe;">
              <td style="padding: 8px; padding-left: 30px; font-weight: bold;">‚îî‚îÄ TOTALE OLTRE</td>
              <td style="padding: 8px;">
                <input type="text" id="cred_oltre_prev" readonly
                       style="width: 100%; text-align: right; background:#81d4fa; border:2px solid #0288d1; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="cred_oltre_last" readonly
                       style="width: 100%; text-align: right; background:#81d4fa; border:2px solid #0288d1; padding:5px; font-weight:bold;">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- TABELLA DEBITI -->
      <div style="margin-bottom: 30px; border: 2px solid #d32f2f; border-radius: 8px; padding: 15px;">
        <h3 style="color: #d32f2f; margin-top: 0;">üìä DEBITI ${isOrdinario ? '(ORDINARIO - AUTO)' : '(ABBREVIATO/MICRO - MANUALE)'}</h3>
        
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #ffebee;">
              <th style="text-align: left; padding: 10px; width: 50%;">Voce</th>
              <th style="text-align: center; padding: 10px; width: 25%;">31/12/${annoPrev}</th>
              <th style="text-align: center; padding: 10px; width: 25%;">31/12/${annoLast}</th>
            </tr>
          </thead>
          <tbody>
            <!-- TOTALE DEBITI -->
            <tr style="background: #ffcdd2; font-weight: bold;">
              <td style="padding: 8px;">DEBITI TOTALE</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_totale_prev" readonly
                       style="width: 100%; text-align: right; background:#ef9a9a; border:2px solid #c62828; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_totale_last" readonly
                       style="width: 100%; text-align: right; background:#ef9a9a; border:2px solid #c62828; padding:5px; font-weight:bold;">
              </td>
            </tr>
            
            <!-- SEZIONE ENTRO 12 MESI -->
            <tr style="background: #f5f5f5;">
              <td colspan="3" style="padding: 8px; font-weight: bold; color: #424242;">
                üìÅ ENTRO 12 MESI
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Commerciali (6+7)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_comm_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_comm_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Finanziari (1+2+3+4+5)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_fin_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_fin_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Tributari & Previdenziali (12+13)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_tribprev_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_tribprev_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Altri (8+9+10+11+14)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_altri_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_e_altri_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr style="background: #ffebee;">
              <td style="padding: 8px; padding-left: 30px; font-weight: bold;">‚îî‚îÄ TOTALE ENTRO</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_entro_prev" readonly
                       style="width: 100%; text-align: right; background:#ffab91; border:2px solid #d84315; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_entro_last" readonly
                       style="width: 100%; text-align: right; background:#ffab91; border:2px solid #d84315; padding:5px; font-weight:bold;">
              </td>
            </tr>
            
            <!-- SEZIONE OLTRE 12 MESI -->
            <tr style="background: #f5f5f5;">
              <td colspan="3" style="padding: 8px; font-weight: bold; color: #424242;">
                üìÅ OLTRE 12 MESI
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Commerciali (6+7)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_comm_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_comm_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Finanziari (1+2+3+4+5)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_fin_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_fin_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Tributari & Previdenziali (12+13)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_tribprev_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_tribprev_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr>
              <td style="padding: 8px; padding-left: 30px;">‚îú‚îÄ Altri (8+9+10+11+14)</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_altri_prev" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_o_altri_last" ${readonly}
                       style="width: 100%; text-align: right; ${isOrdinario ? autoStyle : inputStyle} padding:5px;"
                       onblur="formatInput(this); calcolaTotaliDebiti();">
              </td>
            </tr>
            
            <tr style="background: #ffebee;">
              <td style="padding: 8px; padding-left: 30px; font-weight: bold;">‚îî‚îÄ TOTALE OLTRE</td>
              <td style="padding: 8px;">
                <input type="text" id="deb_oltre_prev" readonly
                       style="width: 100%; text-align: right; background:#ffab91; border:2px solid #d84315; padding:5px; font-weight:bold;">
              </td>
              <td style="padding: 8px;">
                <input type="text" id="deb_oltre_last" readonly
                       style="width: 100%; text-align: right; background:#ffab91; border:2px solid #d84315; padding:5px; font-weight:bold;">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
<!-- TABELLE AGGIUNTIVE -->
<div style="margin-top: 30px;">
  
  <!-- PRIMA RIGA: ORGANO AMMINISTRATIVO + ALIQUOTE IVA -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    
    <!-- ORGANO AMMINISTRATIVO -->
    <div style="border: 2px solid #7b1fa2; border-radius: 8px; padding: 15px; background: linear-gradient(to bottom, #f3e5f5, #fff);">
      <h4 style="color: #7b1fa2; margin: 0 0 10px 0; display: flex; align-items: center;">
        üìã ORGANO AMMINISTRATIVO
      </h4>
    <table style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr style="background: #e1bee7;">
      <th style="padding: 5px; text-align: left; width: 40%;">Voce</th>
      <th style="padding: 5px; text-align: center; width: 30%;">31/12/${annoPrev}</th>
      <th style="padding: 5px; text-align: center; width: 30%;">31/12/${annoLast}</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding: 5px;">N¬∞ amministratori</td>
      <td style="padding: 5px;">
        <input type="text" id="amm_numero_prev" style="width: 100%; text-align: center;">
      </td>
      <td style="padding: 5px;">
        <input type="text" id="amm_numero_last" style="width: 100%; text-align: center;">
      </td>
    </tr>
    <tr>
      <td style="padding: 5px;">Compensi (‚Ç¨)</td>
      <td style="padding: 5px;">
        <input type="text" id="amm_compensi_prev" style="width: 100%; text-align: right;" onblur="formatInput(this); calcolaTotaleAmm();">
      </td>
      <td style="padding: 5px;">
        <input type="text" id="amm_compensi_last" style="width: 100%; text-align: right;" onblur="formatInput(this); calcolaTotaleAmm();">
      </td>
    </tr>
    <tr>
      <td style="padding: 5px;">Contributi (‚Ç¨)</td>
      <td style="padding: 5px;">
        <input type="text" id="amm_contributi_prev" style="width: 100%; text-align: right;" onblur="formatInput(this); calcolaTotaleAmm();">
      </td>
      <td style="padding: 5px;">
        <input type="text" id="amm_contributi_last" style="width: 100%; text-align: right;" onblur="formatInput(this); calcolaTotaleAmm();">
      </td>
    </tr>
    <tr style="background: #ce93d8; font-weight: bold;">
      <td style="padding: 5px;">TOTALE (‚Ç¨)</td>
      <td style="padding: 5px;">
        <input type="text" id="amm_totale_prev" readonly style="width: 100%; text-align: right; background: #ba68c8; color: white;">
      </td>
      <td style="padding: 5px;">
        <input type="text" id="amm_totale_last" readonly style="width: 100%; text-align: right; background: #ba68c8; color: white;">
      </td>
    </tr>
  </tbody>
</table>
    </div>
    
    <!-- ALIQUOTE IVA -->
    <div style="border: 2px solid #388e3c; border-radius: 8px; padding: 15px; background: linear-gradient(to bottom, #e8f5e9, #fff);">
      <h4 style="color: #388e3c; margin: 0 0 10px 0; display: flex; align-items: center;">
        üí∂ ALIQUOTE IVA MEDIE
      </h4>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #c8e6c9;">
            <th style="padding: 5px; text-align: left; width: 50%;">Tipo</th>
            <th style="padding: 5px; text-align: center; width: 25%;">31/12/${annoPrev}</th>
            <th style="padding: 5px; text-align: center; width: 25%;">31/12/${annoLast}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 5px; border-bottom: 1px solid #e0e0e0;">IVA vendite %</td>
            <td style="padding: 5px; border-bottom: 1px solid #e0e0e0;">
              <input type="text" id="iva_vendite_prev" placeholder="22"
                     style="width: 100%; text-align: center; background:#fff; border:1px solid #81c784; padding:3px; border-radius:4px;">
            </td>
            <td style="padding: 5px; border-bottom: 1px solid #e0e0e0;">
              <input type="text" id="iva_vendite_last" placeholder="22"
                     style="width: 100%; text-align: center; background:#fff; border:1px solid #81c784; padding:3px; border-radius:4px;">
            </td>
          </tr>
          <tr>
            <td style="padding: 5px;">IVA acquisti %</td>
            <td style="padding: 5px;">
              <input type="text" id="iva_acquisti_prev" placeholder="22"
                     style="width: 100%; text-align: center; background:#fff; border:1px solid #81c784; padding:3px; border-radius:4px;">
            </td>
            <td style="padding: 5px;">
              <input type="text" id="iva_acquisti_last" placeholder="22"
                     style="width: 100%; text-align: center; background:#fff; border:1px solid #81c784; padding:3px; border-radius:4px;">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- SECONDA RIGA: PERSONALE (tutta larghezza) -->
  <div style="border: 2px solid #ff6f00; border-radius: 8px; padding: 15px; background: linear-gradient(to bottom, #fff3e0, #fff);">
    <h4 style="color: #ff6f00; margin: 0 0 15px 0; display: flex; align-items: center;">
      üë• PERSONALE - Ripartizione per area
    </h4>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
      
<!-- COLONNA SINISTRA: NUMERO ADDETTI -->
<div>
  <h5 style="color: #e65100; margin: 0 0 10px 0; padding: 5px; background: #ffe0b2; border-radius: 4px;">
    üìä Numero dipendenti
  </h5>
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr style="background: #ffcc80;">
        <th style="padding: 8px; text-align: left;">Area</th>
        <th style="padding: 8px; text-align: center;">31/12/${annoPrev}</th>
        <th style="padding: 8px; text-align: center;">31/12/${annoLast}</th>
      </tr>
    </thead>
    <tbody>
      <tr style="background: #fff3e0; font-weight: bold;">
        <td style="padding: 6px;">TOTALE</td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_tot_prev" readonly
                 style="width: 100%; text-align: center; background:#ffcc80; border:2px solid #ff9800; padding:4px; border-radius:4px; font-weight:bold;">
        </td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_tot_last" readonly
                 style="width: 100%; text-align: center; background:#ffcc80; border:2px solid #ff9800; padding:4px; border-radius:4px; font-weight:bold;">
        </td>
      </tr>
      <tr>
        <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Produzione</td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_prod_prev" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_prod_last" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
      </tr>
      <tr>
        <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Amministrazione</td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_amm_prev" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_amm_last" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
      </tr>
      <tr>
        <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Commerciale</td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_comm_prev" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_comm_last" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
      </tr>
      <tr>
        <td style="padding: 6px; padding-left: 20px;">‚îî‚îÄ Altro</td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_altro_prev" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
        <td style="padding: 6px;">
          <input type="text" id="addetti_altro_last" onchange="calcolaTotaleAddetti()"
                 style="width: 100%; text-align: center; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;">
        </td>
      </tr>
    </tbody>
  </table>
</div>
      
      <!-- COLONNA DESTRA: COSTI -->
      <div>
        <h5 style="color: #e65100; margin: 0 0 10px 0; padding: 5px; background: #ffe0b2; border-radius: 4px;">
          üí∞ Costo del personale (‚Ç¨)
        </h5>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #ffcc80;">
              <th style="padding: 8px; text-align: left;">Area</th>
              <th style="padding: 8px; text-align: center;">31/12/${annoPrev}</th>
              <th style="padding: 8px; text-align: center;">31/12/${annoLast}</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background: #fff3e0; font-weight: bold;">
              <td style="padding: 6px;">TOTALE (da CE)</td>
              <td style="padding: 6px;">
                <input type="text" id="costo_pers_tot_prev" readonly
                       style="width: 100%; text-align: right; background:#ffcc80; border:2px solid #ff6f00; padding:4px; border-radius:4px; font-weight:bold;">
              </td>
              <td style="padding: 6px;">
                <input type="text" id="costo_pers_tot_last" readonly
                       style="width: 100%; text-align: right; background:#ffcc80; border:2px solid #ff6f00; padding:4px; border-radius:4px; font-weight:bold;">
              </td>
            </tr>
            <tr>
              <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Produzione</td>
              <td style="padding: 6px;">
                <input type="text" id="cp_prod_prev" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
              <td style="padding: 6px;">
                <input type="text" id="cp_prod_last" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
            </tr>
            <tr>
              <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Amministrazione</td>
              <td style="padding: 6px;">
                <input type="text" id="cp_amm_prev" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
              <td style="padding: 6px;">
                <input type="text" id="cp_amm_last" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
            </tr>
            <tr>
              <td style="padding: 6px; padding-left: 20px;">‚îú‚îÄ Commerciale</td>
              <td style="padding: 6px;">
                <input type="text" id="cp_comm_prev" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
              <td style="padding: 6px;">
                <input type="text" id="cp_comm_last" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
            </tr>
            <tr>
              <td style="padding: 6px; padding-left: 20px;">‚îî‚îÄ Altro</td>
              <td style="padding: 6px;">
                <input type="text" id="cp_altro_prev" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
              <td style="padding: 6px;">
                <input type="text" id="cp_altro_last" 
                       style="width: 100%; text-align: right; background:#fff; border:1px solid #ffb74d; padding:4px; border-radius:4px;"
                       onblur="formatInput(this);">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
      </div>
    </div>
  </div>
  
  <!-- Pulsante Ripristina Tabelle -->
  <div style="text-align:center;margin-top:20px;">
    <button onclick="ripristinaTabelle()" 
            style="background:#dc2626;color:white;font-weight:bold;
                   border:none;padding:10px 25px;border-radius:8px;
                   cursor:pointer;">
      üßπ Ripristina Tabelle (cancella dati salvati)
    </button>
  </div>

</div>
</div>
  `;
}

window.salvaDatiTabelle = function() {
    const cfKey = (state?.cf || state?.codiceFiscale || 'NA').toString().trim();
    const yPrev = (state?.anni?.prev || 'NA').toString();
    const yLast = (state?.anni?.last || 'NA').toString();
    
    // Controlla che ci siano davvero gli anni
    if (cfKey === 'NA' || yPrev === 'NA' || yLast === 'NA') {
        toast("‚ö†Ô∏è Mancano dati per salvare le tabelle", true);
        console.error('Dati mancanti:', {cfKey, yPrev, yLast});
        return;
    }
    
    const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;
    console.log('Salvo con chiave:', storeKey);
    
    // SALVA TUTTI I CAMPI COS√å COME SONO
    const datiTabelle = {
        cf: cfKey,
        anni: {prev: yPrev, last: yLast},
        timestamp: new Date().toISOString(),
        
        // CREDITI - TUTTI I CAMPI
        cred_e_comm_prev: document.getElementById('cred_e_comm_prev')?.value || '',
        cred_e_comm_last: document.getElementById('cred_e_comm_last')?.value || '',
        cred_e_trib_prev: document.getElementById('cred_e_trib_prev')?.value || '',
        cred_e_trib_last: document.getElementById('cred_e_trib_last')?.value || '',
        cred_e_altri_prev: document.getElementById('cred_e_altri_prev')?.value || '',
        cred_e_altri_last: document.getElementById('cred_e_altri_last')?.value || '',
        cred_o_comm_prev: document.getElementById('cred_o_comm_prev')?.value || '',
        cred_o_comm_last: document.getElementById('cred_o_comm_last')?.value || '',
        cred_o_trib_prev: document.getElementById('cred_o_trib_prev')?.value || '',
        cred_o_trib_last: document.getElementById('cred_o_trib_last')?.value || '',
        cred_o_altri_prev: document.getElementById('cred_o_altri_prev')?.value || '',
        cred_o_altri_last: document.getElementById('cred_o_altri_last')?.value || '',
        cred_entro_prev: document.getElementById('cred_entro_prev')?.value || '',
        cred_entro_last: document.getElementById('cred_entro_last')?.value || '',
        cred_oltre_prev: document.getElementById('cred_oltre_prev')?.value || '',
        cred_oltre_last: document.getElementById('cred_oltre_last')?.value || '',
        cred_totale_prev: document.getElementById('cred_totale_prev')?.value || '',
        cred_totale_last: document.getElementById('cred_totale_last')?.value || '',
        
        // DEBITI - TUTTI I CAMPI  
        deb_e_comm_prev: document.getElementById('deb_e_comm_prev')?.value || '',
        deb_e_comm_last: document.getElementById('deb_e_comm_last')?.value || '',
        deb_e_fin_prev: document.getElementById('deb_e_fin_prev')?.value || '',
        deb_e_fin_last: document.getElementById('deb_e_fin_last')?.value || '',
        deb_e_tribprev_prev: document.getElementById('deb_e_tribprev_prev')?.value || '',
        deb_e_tribprev_last: document.getElementById('deb_e_tribprev_last')?.value || '',
        deb_e_altri_prev: document.getElementById('deb_e_altri_prev')?.value || '',
        deb_e_altri_last: document.getElementById('deb_e_altri_last')?.value || '',
        deb_o_comm_prev: document.getElementById('deb_o_comm_prev')?.value || '',
        deb_o_comm_last: document.getElementById('deb_o_comm_last')?.value || '',
        deb_o_fin_prev: document.getElementById('deb_o_fin_prev')?.value || '',
        deb_o_fin_last: document.getElementById('deb_o_fin_last')?.value || '',
        deb_o_tribprev_prev: document.getElementById('deb_o_tribprev_prev')?.value || '',
        deb_o_tribprev_last: document.getElementById('deb_o_tribprev_last')?.value || '',
        deb_o_altri_prev: document.getElementById('deb_o_altri_prev')?.value || '',
        deb_o_altri_last: document.getElementById('deb_o_altri_last')?.value || '',
        deb_entro_prev: document.getElementById('deb_entro_prev')?.value || '',
        deb_entro_last: document.getElementById('deb_entro_last')?.value || '',
        deb_oltre_prev: document.getElementById('deb_oltre_prev')?.value || '',
        deb_oltre_last: document.getElementById('deb_oltre_last')?.value || '',
        deb_totale_prev: document.getElementById('deb_totale_prev')?.value || '',
        deb_totale_last: document.getElementById('deb_totale_last')?.value || '',
        
        // PERSONALE
        addetti_tot_prev: document.getElementById('addetti_tot_prev')?.value || '',
        addetti_tot_last: document.getElementById('addetti_tot_last')?.value || '',
        addetti_prod_prev: document.getElementById('addetti_prod_prev')?.value || '',
        addetti_prod_last: document.getElementById('addetti_prod_last')?.value || '',
        addetti_amm_prev: document.getElementById('addetti_amm_prev')?.value || '',
        addetti_amm_last: document.getElementById('addetti_amm_last')?.value || '',
        addetti_comm_prev: document.getElementById('addetti_comm_prev')?.value || '',
        addetti_comm_last: document.getElementById('addetti_comm_last')?.value || '',
        addetti_altro_prev: document.getElementById('addetti_altro_prev')?.value || '',
        addetti_altro_last: document.getElementById('addetti_altro_last')?.value || '',
        costo_pers_tot_prev: document.getElementById('costo_pers_tot_prev')?.value || '',
        costo_pers_tot_last: document.getElementById('costo_pers_tot_last')?.value || '',
        cp_prod_prev: document.getElementById('cp_prod_prev')?.value || '',
        cp_prod_last: document.getElementById('cp_prod_last')?.value || '',
        cp_amm_prev: document.getElementById('cp_amm_prev')?.value || '',
        cp_amm_last: document.getElementById('cp_amm_last')?.value || '',
        cp_comm_prev: document.getElementById('cp_comm_prev')?.value || '',
        cp_comm_last: document.getElementById('cp_comm_last')?.value || '',
        cp_altro_prev: document.getElementById('cp_altro_prev')?.value || '',
        cp_altro_last: document.getElementById('cp_altro_last')?.value || '',
        
        // ORGANO AMM
        amm_numero_prev: document.getElementById('amm_numero_prev')?.value || '',
        amm_numero_last: document.getElementById('amm_numero_last')?.value || '',
        amm_compensi_prev: document.getElementById('amm_compensi_prev')?.value || '',
        amm_compensi_last: document.getElementById('amm_compensi_last')?.value || '',
        amm_contributi_prev: document.getElementById('amm_contributi_prev')?.value || '',
        amm_contributi_last: document.getElementById('amm_contributi_last')?.value || '',
        
        // IVA
        iva_vendite_prev: document.getElementById('iva_vendite_prev')?.value || '',
        iva_vendite_last: document.getElementById('iva_vendite_last')?.value || '',
        iva_acquisti_prev: document.getElementById('iva_acquisti_prev')?.value || '',
        iva_acquisti_last: document.getElementById('iva_acquisti_last')?.value || ''
    };
    
    localStorage.setItem(storeKey, JSON.stringify(datiTabelle));
    toast(`‚úÖ Tabelle salvate per ${cfKey} (${yPrev}-${yLast})`);
    console.log('Salvate tabelle con chiave:', storeKey);
}

// ======================================================
// üßπ RIPRISTINO TABELLE (sicuro, non tocca i bilanci importati)
// ======================================================
window.ripristinaTabelle = function() {
  try {
    // 1Ô∏è‚É£ Recupera CF e anni dal bilancio in corso
    const cfKey = (state?.cf || state?.codiceFiscale || '').trim();
    const yPrev = state?.anni?.prev || '';
    const yLast = state?.anni?.last || '';

    if (!cfKey || !yPrev || !yLast) {
      toast("‚ö†Ô∏è Nessun bilancio attivo. Importa un bilancio prima di ripristinare.", true);
      return;
    }

    const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;

    // 2Ô∏è‚É£ Conferma utente
    if (!confirm(`‚ö†Ô∏è Vuoi davvero cancellare i dati salvati nelle tabelle per ${cfKey} (${yPrev}-${yLast})?`))
      return;

    // 3Ô∏è‚É£ Cancella solo la chiave tabelle
    localStorage.removeItem(storeKey);
    if (window.state) delete window.state.tabelle;

    toast(`üßπ Tabelle per ${cfKey} (${yPrev}-${yLast}) eliminate.`);
    console.log("‚úÖ Tabella rimossa:", storeKey);

    // 4Ô∏è‚É£ Ricarica solo la sezione tabelle, non l‚Äôintero bilancio
    if (typeof generaTabelleHTML === "function") {
      document.getElementById("contentTabelle").innerHTML = generaTabelleHTML();
    }

  } catch (e) {
    console.error("‚ùå Errore durante il ripristino tabelle:", e);
    toast("Errore durante il ripristino tabelle.", true);
  }
};


// =====================================================
// ‚úÖ SISTEMA BREAK-EVEN COMPLETO 2025 ‚Äî VERSIONE STABILE
// Tutti i try/catch e if corretti. Nessuna funzione annidata.
// =====================================================

function generaBreakevenHTML() {
  return `
    <div style="max-width:1300px;margin:0 auto;">
      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="color:#1e40af;">Definizione % Costi Fissi per Voce</h4>
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="background:#e0e0e0;">
              <th rowspan="2" style="padding:6px;border:1px solid #ccc;">Voce di Costo</th>
              <th colspan="4" style="background:#d0d0d0;border:1px solid #ccc;">${state.anni.prev}</th>
              <th colspan="4" style="background:#c0c0c0;border:1px solid #ccc;">${state.anni.last}</th>
            </tr>
            <tr style="background:#e0e0e0;">
              <th>Totale</th><th>% Fissi</th><th>C.Fissi</th><th>C.Var</th>
              <th>Totale</th><th>% Fissi</th><th>C.Fissi</th><th>C.Var</th>
            </tr>
          </thead>
          <tbody id="breakeven-voci"></tbody>
          <tfoot>
            <tr style="background:#fff3cd;font-weight:bold;">
              <td style="border:1px solid #ccc;">TOTALI</td>
              <td id="be-tot-prev" style="text-align:right;border:1px solid #ccc;">0</td><td>‚Äî</td>
              <td id="be-fissi-tot-prev" style="text-align:right;border:1px solid #ccc;">0</td>
              <td id="be-var-tot-prev" style="text-align:right;border:1px solid #ccc;">0</td>
              <td id="be-tot-last" style="text-align:right;border:1px solid #ccc;">0</td><td>‚Äî</td>
              <td id="be-fissi-tot-last" style="text-align:right;border:1px solid #ccc;">0</td>
              <td id="be-var-tot-last" style="text-align:right;border:1px solid #ccc;">0</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Riepilogo -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
        <div style="background:#e8f4f8;padding:12px;border-radius:8px;">
          <h4 style="color:#1e40af;">${state.anni.prev}</h4>
          <table style="width:100%;font-size:12px;">
            <tr><td>Fatturato</td><td id="be-fatt-prev" style="text-align:right;">0</td></tr>
            <tr><td>Costi Fissi</td><td id="be-cf-prev" style="text-align:right;">0</td></tr>
            <tr><td>Costi Variabili</td><td id="be-cv-prev" style="text-align:right;">0</td></tr>
            <tr><td>% Margine Contrib.</td><td id="be-marg-prev" style="text-align:right;">0%</td></tr>
            <tr style="background:#d4edda;"><td><b>Break-Even Point</b></td><td id="be-punto-prev" style="text-align:right;">0</td></tr>
            <tr><td>Margine Sicurezza</td><td id="be-sicur-prev" style="text-align:right;">0%</td></tr>
          </table>
        </div>
        <div style="background:#f0f4f8;padding:12px;border-radius:8px;">
          <h4 style="color:#003d82;">${state.anni.last}</h4>
          <table style="width:100%;font-size:12px;">
            <tr><td>Fatturato</td><td id="be-fatt-last" style="text-align:right;">0</td></tr>
            <tr><td>Costi Fissi</td><td id="be-cf-last" style="text-align:right;">0</td></tr>
            <tr><td>Costi Variabili</td><td id="be-cv-last" style="text-align:right;">0</td></tr>
            <tr><td>% Margine Contrib.</td><td id="be-marg-last" style="text-align:right;">0%</td></tr>
            <tr style="background:#d4edda;"><td><b>Break-Even Point</b></td><td id="be-punto-last" style="text-align:right;">0</td></tr>
            <tr><td>Margine Sicurezza</td><td id="be-sicur-last" style="text-align:right;">0%</td></tr>
          </table>
        </div>
      </div>

      <!-- Analisi comparativa -->
      <div style="background:#fff3cd;padding:10px;border-radius:8px;margin-bottom:15px;">
        <h4 style="color:#003d82;">üìä Analisi Comparativa</h4>
        <div id="be-analisi-comparativa" style="font-size:12px;"></div>
      </div>

      <!-- Grafico -->
      <div style="background:white;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <h4 style="color:#1e40af;">Grafico Break-Even Mensile Comparativo</h4>
        <canvas id="breakeven-chart" width="1000" height="480" style="max-width:100%;"></canvas>
      </div>
    </div>
  `;
}

// =====================================================
// üß© POPOLAMENTO TABELLA
// =====================================================
window.popolaVociBreakeven = function () {
  try {
    const cePrev = extractStandardizedCEPrev?.() || {};
    const ceLast = extractStandardizedCE?.() || {};
    const settore = (state?.settore || "SERVIZI").toUpperCase();

    const preset = {
      SERVIZI: { Materie: 20, Servizi: 50, Godimento: 60, Personale: 70, Ammortamenti: 100, Oneri: 50 },
      INDUSTRIA: { Materie: 20, Servizi: 40, Godimento: 70, Personale: 85, Ammortamenti: 100, Oneri: 50 },
      COMMERCIO: { Materie: 60, Servizi: 40, Godimento: 60, Personale: 70, Ammortamenti: 100, Oneri: 40 }
    };
    const defaults = preset[settore] || preset.SERVIZI;

    const voci = [
      { nome: "Materie prime, sussidiarie e merci", campo: "materiePrime" },
      { nome: "Servizi", campo: "servizi" },
      { nome: "Godimento beni di terzi", campo: "godimentoBeniTerzi" },
      { nome: "Personale", campo: "personale" },
      { nome: "Ammortamenti e svalutazioni", campo: "ammortamenti" },
      { nome: "Oneri diversi di gestione", campo: "oneriDiversi" }
    ];

    const tbody = document.getElementById("breakeven-voci");
    if (!tbody) return;
    tbody.innerHTML = "";

    voci.forEach((v, i) => {
      const valPrev = Math.abs(cePrev[v.campo] || 0);
      const valLast = Math.abs(ceLast[v.campo] || 0);
      const perc = defaults[v.nome.split(" ")[0]] || 50;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.nome}</td>
        <td id="be-tot-prev-${i}" style="text-align:right;">${itFmt(valPrev)}</td>
        <td><input id="be-perc-prev-${i}" type="number" value="${perc}" min="0" max="100" style="width:50px;" onchange="aggiornaBreakeven(${i}, 'prev')">% </td>
        <td id="be-fissi-prev-${i}" style="text-align:right;">0</td>
        <td id="be-var-prev-${i}" style="text-align:right;">0</td>
        <td id="be-tot-last-${i}" style="text-align:right;">${itFmt(valLast)}</td>
        <td><input id="be-perc-last-${i}" type="number" value="${perc}" min="0" max="100" style="width:50px;" onchange="aggiornaBreakeven(${i}, 'last')">% </td>
        <td id="be-fissi-last-${i}" style="text-align:right;">0</td>
        <td id="be-var-last-${i}" style="text-align:right;">0</td>
      `;
      tbody.appendChild(tr);
      aggiornaBreakeven(i, "prev");
      aggiornaBreakeven(i, "last");
    });

    aggiornaTotali();
  } catch (e) {
    console.error("Errore popolaVociBreakeven:", e);
  }
};

// =====================================================
// üß© AGGIORNAMENTO SINGOLA RIGA E TOTALI
// =====================================================
function aggiornaBreakeven(i, anno) {
  try {
    const tot = parseIT(document.getElementById(`be-tot-${anno}-${i}`)?.textContent);
    const perc = parseIT(document.getElementById(`be-perc-${anno}-${i}`)?.value);
    const fissi = tot * (perc / 100);
    const vari = tot - fissi;
    document.getElementById(`be-fissi-${anno}-${i}`).textContent = itFmt(fissi);
    document.getElementById(`be-var-${anno}-${i}`).textContent = itFmt(vari);
    aggiornaTotali();
  } catch (e) {
    console.error("Errore aggiornaBreakeven:", e);
  }
}

function aggiornaTotali() {
  try {
    ["prev", "last"].forEach((anno) => {
      let tot = 0, fissi = 0, vari = 0;
      document.querySelectorAll(`[id^='be-tot-${anno}-']`).forEach(el => tot += parseIT(el.textContent));
      document.querySelectorAll(`[id^='be-fissi-${anno}-']`).forEach(el => fissi += parseIT(el.textContent));
      document.querySelectorAll(`[id^='be-var-${anno}-']`).forEach(el => vari += parseIT(el.textContent));
      document.getElementById(`be-tot-${anno}`).textContent = itFmt(tot);
      document.getElementById(`be-fissi-tot-${anno}`).textContent = itFmt(fissi);
      document.getElementById(`be-var-tot-${anno}`).textContent = itFmt(vari);
    });
  } catch (e) {
    console.error("Errore aggiornaTotali:", e);
  }
}

// =====================================================
// ‚úÖ CALCOLO COMPLETO BREAK-EVEN + COMMENTO GESTIONALE
// =====================================================
window.calcolaBreakeven = function () {
  try {
    const anni = state?.anni || { prev: "N-1", last: "N" };
    const cePrev = extractStandardizedCEPrev?.() || {};
    const ceLast = extractStandardizedCE?.() || {};

    // === Helpers ===
    const fmt = (v) =>
      isFinite(v)
        ? "‚Ç¨ " + Number(v).toLocaleString("it-IT", { maximumFractionDigits: 0 })
        : "‚Ç¨ 0";
    const fmtPct = (v) =>
      isFinite(v)
        ? Number(v).toLocaleString("it-IT", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
          }) + "%"
        : "0%";
    const safeDiv = (a, b) => (b ? a / b : 0);

    // === RICAVI (Valore Produzione) ===
    const fattPrev =
      cePrev.valoreProduzione ||
      cePrev.ricaviVendite ||
      cePrev.altriRicavi ||
      0;
    const fattLast =
      ceLast.valoreProduzione ||
      ceLast.ricaviVendite ||
      ceLast.altriRicavi ||
      0;

    // === COSTI ===
    const fissiPrev = parseIT(
      document.getElementById("be-fissi-tot-prev")?.textContent
    );
    const varPrev = parseIT(
      document.getElementById("be-var-tot-prev")?.textContent
    );
    const fissiLast = parseIT(
      document.getElementById("be-fissi-tot-last")?.textContent
    );
    const varLast = parseIT(
      document.getElementById("be-var-tot-last")?.textContent
    );

    // === Calcoli principali ===
    const margPrevPct = safeDiv(fattPrev - varPrev, fattPrev) * 100;
    const margLastPct = safeDiv(fattLast - varLast, fattLast) * 100;
    const puntoPrev = safeDiv(fissiPrev, margPrevPct / 100);
    const puntoLast = safeDiv(fissiLast, margLastPct / 100);
    const margSicurPrev = safeDiv(fattPrev - puntoPrev, fattPrev) * 100;
    const margSicurLast = safeDiv(fattLast - puntoLast, fattLast) * 100;
    const mesePrev = safeDiv(fissiPrev, fattPrev) * 12;
    const meseLast = safeDiv(fissiLast, fattLast) * 12;

    // === Aggiorna riepilogo ===
    const setTxt = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = val;
    };

    // N-1
    setTxt("be-fatt-prev", fmt(fattPrev));
    setTxt("be-cf-prev", fmt(fissiPrev));
    setTxt("be-cv-prev", fmt(varPrev));
    setTxt("be-marg-prev", fmtPct(margPrevPct));
    setTxt("be-punto-prev", fmt(puntoPrev));
    setTxt("be-sicur-prev", fmtPct(margSicurPrev));

    // N
    setTxt("be-fatt-last", fmt(fattLast));
    setTxt("be-cf-last", fmt(fissiLast));
    setTxt("be-cv-last", fmt(varLast));
    setTxt("be-marg-last", fmtPct(margLastPct));
    setTxt("be-punto-last", fmt(puntoLast));
    setTxt("be-sicur-last", fmtPct(margSicurLast));

    // === GRAFICO ===
    disegnaGraficoBreakevenMensile({
      fattPrev,
      fissiPrev,
      varPrev,
      mesePrev,
      fattLast,
      fissiLast,
      varLast,
      meseLast,
    });

    // === COMMENTO ===
    commentaBreakEven({
      fattPrev,
      fattLast,
      fissiPrev,
      fissiLast,
      varPrev,
      varLast,
      margPrevPct,
      margLastPct,
      puntoPrev,
      puntoLast,
      margSicurPrev,
      margSicurLast,
      mesePrev,
      meseLast,
    });

    toast(`‚úÖ Break-Even calcolato per ${anni.prev} e ${anni.last}`);
  } catch (err) {
    console.error("‚ùå Errore calcolaBreakeven:", err);
    toast("Errore nel calcolo Break-Even", true);
  }
};

// =====================================================
// üìä GRAFICO BREAK-EVEN ‚Äì VERSIONE PROFESSIONALE FINALE
// =====================================================
function disegnaGraficoBreakevenMensile(d) {
  try {
    const canvas = document.getElementById("breakeven-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const W = canvas.width, H = canvas.height;
    const pad = 120; // pi√π spazio per titoli e assi
    const chartW = (W - pad * 3) / 2;
    const chartH = H - pad * 2;
    const baseY = H - pad;

    const formatEuro = (v) => "‚Ç¨" + v.toLocaleString("it-IT", { maximumFractionDigits: 0 });

    const drawAnno = (x0, titolo, fatt, fissi, vari, meseBE, colRicavi, colCosti) => {
      if (!fatt || fatt <= 0) return;
      const baseX = x0 + pad;
      const scaleY = chartH / (fatt * 1.1);
      const scaleX = (chartW - 20) / 12;

      // area sfondo
      ctx.fillStyle = "#fafafa";
      ctx.fillRect(baseX - 10, pad - 20, chartW + 10, chartH + 40);

      // assi
      ctx.strokeStyle = "#9ca3af";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(baseX, baseY);
      ctx.lineTo(baseX + chartW, baseY);
      ctx.moveTo(baseX, baseY);
      ctx.lineTo(baseX, baseY - chartH);
      ctx.stroke();

      // asse Y con valori
      ctx.font = "11px 'Segoe UI'";
      ctx.fillStyle = "#374151";
      ctx.textAlign = "right";
      const step = fatt / 5;
      for (let i = 0; i <= 5; i++) {
        const val = step * i;
        const y = baseY - val * scaleY;
        ctx.fillText(formatEuro(val), baseX - 6, y + 3);
        ctx.strokeStyle = "rgba(0,0,0,0.05)";
        ctx.beginPath();
        ctx.moveTo(baseX, y);
        ctx.lineTo(baseX + chartW, y);
        ctx.stroke();
      }

      // mesi
      ctx.textAlign = "center";
      ctx.fillStyle = "#6b7280";
      for (let m = 1; m <= 12; m++) {
        const x = baseX + m * scaleX;
        ctx.fillText(m, x, baseY + 14);
      }

      // linea ricavi
      ctx.strokeStyle = colRicavi;
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      ctx.moveTo(baseX, baseY);
      for (let m = 0; m <= 12; m++) {
        const y = baseY - (fatt / 12 * m) * scaleY;
        ctx.lineTo(baseX + m * scaleX, y);
      }
      ctx.stroke();

      // linea costi totali
      ctx.strokeStyle = colCosti;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(baseX, baseY - fissi * scaleY);
      for (let m = 0; m <= 12; m++) {
        const y = baseY - (fissi + vari / 12 * m) * scaleY;
        ctx.lineTo(baseX + m * scaleX, y);
      }
      ctx.stroke();

      // Punto BE
      const xBE = baseX + meseBE * scaleX;
      const yBE = baseY - (fissi + vari / 12 * meseBE) * scaleY;
      ctx.fillStyle = "#f59e0b";
      ctx.beginPath();
      ctx.arc(xBE, yBE, 6, 0, 2 * Math.PI);
      ctx.fill();
      ctx.strokeStyle = "#f59e0b";
      ctx.setLineDash([5, 4]);
      ctx.beginPath();
      ctx.moveTo(xBE, baseY);
      ctx.lineTo(xBE, baseY - chartH);
      ctx.stroke();
      ctx.setLineDash([]);

      // testo mese
      ctx.font = "bold 12px 'Segoe UI'";
      ctx.fillStyle = "#f59e0b";
      ctx.fillText(`Mese ${meseBE.toFixed(1)}`, xBE, pad - 4);

      // valore BE
      ctx.font = "11px 'Segoe UI'";
      ctx.fillStyle = "#f59e0b";
      ctx.textAlign = "center";
      ctx.fillText(`Break-Even ‚âà ${formatEuro(fissi / (1 - vari / fatt))}`, xBE, yBE - 10);

      // titolo anno
      ctx.font = "bold 16px 'Segoe UI'";
      ctx.fillStyle = "#1e3a8a";
      ctx.textAlign = "center";
      ctx.fillText(titolo, baseX + chartW / 2, pad - 30);

      // legenda
      const legendX = baseX + 20, legendY = pad + 10;
      const legends = [
        ["Ricavi", colRicavi],
        ["Costi Totali", colCosti],
        ["Break-Even", "#f59e0b"]
      ];
      ctx.font = "11px 'Segoe UI'";
      ctx.textAlign = "left";
      legends.forEach(([label, col], i) => {
        ctx.fillStyle = col;
        ctx.fillRect(legendX, legendY + i * 16, 14, 4);
        ctx.fillStyle = "#111";
        ctx.fillText(label, legendX + 24, legendY + i * 16 + 4);
      });
    };

    drawAnno(pad, `Anno ${state.anni.prev}`, d.fattPrev, d.fissiPrev, d.varPrev, d.mesePrev, "#16a34a", "#dc2626");
    drawAnno(pad * 2 + chartW, `Anno ${state.anni.last}`, d.fattLast, d.fissiLast, d.varLast, d.meseLast, "#22c55e", "#ef4444");

    // === Titolo generale ===
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    // Titolo principale
    ctx.font = "bold 26px 'Segoe UI', Arial, sans-serif";
    ctx.fillStyle = "#003d82";
    ctx.fillText("Andamento Mensile del Break-Even Point", W / 2, 10);

    // Sottotitolo ‚Äî ben distanziato e centrato
    ctx.font = "italic 16px 'Segoe UI', Arial, sans-serif";
    ctx.fillStyle = "#475569";
    ctx.fillText(
      "Confronto tra ricavi, costi totali e punto di pareggio nei due esercizi",
      W / 2,
      42
    );

    ctx.restore();
  } catch (err) {
    console.error("‚ùå Errore disegnaGraficoBreakevenMensile:", err);
  }
}

// =====================================================
// üß© COMMENTO FINALE ‚Äì SPIEGAZIONE KPI
// =====================================================
function commentaBreakEven(d) {
  try {
    const el = document.getElementById("be-analisi-comparativa");
    if (!el) return;

    const diffBE = d.puntoLast - d.puntoPrev;
    const diffMarg = d.margLastPct - d.margPrevPct;
    const diffSic = d.margSicurLast - d.margSicurPrev;
    const diffMesi = d.meseLast - d.mesePrev;
    const incFissiPrev = (d.fissiPrev / d.fattPrev) * 100;
    const incFissiLast = (d.fissiLast / d.fattLast) * 100;

    const formatIt = (num) =>
      Number(num).toLocaleString("it-IT", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1,
      });

    // Titolo principale
    let titolo, colore, messaggio;
    if (d.puntoLast < d.puntoPrev && d.margLastPct > d.margPrevPct) {
      titolo = "üìà Miglioramento gestionale";
      colore = "#16a34a";
      messaggio =
        "Riduzione del punto di pareggio e aumento della marginalit√†: l‚Äôimpresa ha migliorato la propria efficienza economica e la redditivit√† operativa.";
    } else if (d.puntoLast > d.puntoPrev && d.margLastPct < d.margPrevPct) {
      titolo = "‚ö†Ô∏è Peggioramento economico";
      colore = "#dc2626";
      messaggio =
        "Il punto di pareggio √® aumentato e la marginalit√† √® diminuita, segnale di maggiore rigidit√† dei costi o minore capacit√† di copertura dei costi variabili.";
    } else {
      titolo = "‚û° Stabilit√† operativa";
      colore = "#f59e0b";
      messaggio =
        "Margini e struttura dei costi pressoch√© invariati rispetto all‚Äôanno precedente.";
    }

    // ‚Äî Interpreta la variazione del BE ‚Äî
    let testoBE = "";
    if (diffBE < 0)
      testoBE = `Il Break-Even √® diminuito di ‚Ç¨${Math.abs(diffBE).toLocaleString(
        "it-IT"
      )}, segnale positivo di miglioramento gestionale.`;
    else if (diffBE > 0)
      testoBE = `Il Break-Even √® aumentato di ‚Ç¨${Math.abs(diffBE).toLocaleString(
        "it-IT"
      )}, indicando una minore efficienza o un incremento dei costi fissi.`;
    else testoBE = "Il Break-Even √® rimasto invariato rispetto all‚Äôanno precedente.";

    // ‚Äî Conversione mesi in giorni/settimane ‚Äî
    const giorni = Math.round(Math.abs(diffMesi) * 30);
    const settimane = (giorni / 7).toFixed(1).replace(".", ",");
    let testoTempo = "";
    if (diffMesi < 0)
      testoTempo = `üìÖ Il Break-Even √® stato raggiunto prima, circa ${formatIt(
        Math.abs(diffMesi)
      )} mesi (${giorni} giorni ‚âà ${settimane} settimane) di anticipo.`;
    else if (diffMesi > 0)
      testoTempo = `üìÖ Il Break-Even √® stato raggiunto pi√π tardi, circa ${formatIt(
        Math.abs(diffMesi)
      )} mesi (${giorni} giorni ‚âà ${settimane} settimane) di ritardo.`;
    else testoTempo = "üìÖ Il Break-Even √® stato raggiunto nello stesso periodo.";

    // ‚Äî Spiegazioni KPI ‚Äî
    const spiegaMargine =
      "Il margine di contribuzione rappresenta la quota di fatturato che copre i costi fissi dopo i costi variabili: un valore in crescita indica una gestione pi√π efficiente e una migliore redditivit√†.";
    const spiegaSicurezza =
      "Il margine di sicurezza mostra quanto il fatturato effettivo supera il punto di pareggio: pi√π √® alto, maggiore √® la solidit√† economica e la capacit√† di assorbire cali di ricavi.";
    const spiegaFissi =
      "L‚Äôincidenza dei costi fissi misura il peso della struttura operativa sul fatturato: una riduzione significa maggiore flessibilit√† e resilienza nei cicli negativi.";

    // ‚Äî Costruzione blocco HTML ‚Äî
    el.innerHTML = `
      <div style="background:#fff;border-left:5px solid ${colore};
                  border-radius:8px;padding:14px 18px;margin-top:6px;
                  font-size:13px;line-height:1.6;color:#1e3a8a;">
        <h4 style="color:${colore};margin:0 0 8px 0;">${titolo}</h4>
        <p>${messaggio}</p>

        <ul style="margin:8px 0 0 18px;padding:0;">
          <li><b>Variazione Break-Even:</b> ${testoBE}</li>
          <li><b>Margine di contribuzione:</b> ${formatIt(
            d.margPrevPct
          )}% ‚Üí ${formatIt(d.margLastPct)}% ${
      diffMarg > 0 ? "‚Üë" : diffMarg < 0 ? "‚Üì" : "‚Üí"
    }<br><span style="color:#475569;font-size:12px;">${spiegaMargine}</span></li>
          <li><b>Margine di sicurezza:</b> ${formatIt(
            d.margSicurPrev
          )}% ‚Üí ${formatIt(d.margSicurLast)}% ${
      diffSic > 0 ? "‚Üë" : diffSic < 0 ? "‚Üì" : "‚Üí"
    }<br><span style="color:#475569;font-size:12px;">${spiegaSicurezza}</span></li>
          <li><b>Incidenza costi fissi su fatturato:</b> ${formatIt(
            incFissiPrev
          )}% ‚Üí ${formatIt(incFissiLast)}%<br><span style="color:#475569;font-size:12px;">${spiegaFissi}</span></li>
          <li><b>Mese stimato di Break-Even:</b> ${formatIt(d.meseLast)} (${d.meseLast <= 6 ? "nel primo semestre" : "nella seconda met√† dell‚Äôanno"})<br><span style="color:#475569;font-size:12px;">${testoTempo}</span></li>
        </ul>
      </div>`;
  } catch (err) {
    console.error("‚ùå Errore commentaBreakEven:", err);
  }
}


// =====================================================
// üß© TOAST (notifica semplice e sicura)
// =====================================================
function toast(msg, err = false) {
  try {
    const old = document.getElementById("toast-msg");
    if (old) old.remove();

    const box = document.createElement("div");
    box.id = "toast-msg";
    box.textContent = msg;

    Object.assign(box.style, {
      position: "fixed",
      bottom: "25px",
      right: "25px",
      background: err ? "#dc2626" : "#16a34a",
      color: "#fff",
      padding: "10px 18px",
      borderRadius: "10px",
      fontSize: "14px",
      fontWeight: "600",
      boxShadow: "0 6px 20px rgba(0,0,0,0.25)",
      zIndex: "9999",
      opacity: "1",
      transition: "opacity 0.4s ease"
    });

    document.body.appendChild(box);

    setTimeout(() => {
      box.style.opacity = "0";
      setTimeout(() => box.remove(), 500);
    }, 2800);
  } catch (e) {
    console.warn("Impossibile mostrare toast:", e);
  }
}



function mostraIstruzioni() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
    `;
    
    content.innerHTML = `
        <h3 style="color: #003d82; margin-bottom: 20px;">Istruzioni per l'uso</h3>
        <div style="color: #333; line-height: 1.6;">
            <h4>1. Importazione Dati</h4>
            <p>Seleziona il settore di attivit√† e importa il bilancio in formato XLS o XBRL.</p>
            
            <h4>2. Visualizzazione Bilanci</h4>
            <p>Controlla i dati importati nelle tabelle di Stato Patrimoniale e Conto Economico.</p>
            
            <h4>3. Predisposizione Analisi</h4>
            <p>Inserisci le date per bilanci infra-annuali e previsionali. Visualizza i bilanci standardizzati.</p>
            
            <h4>4. Rating e Report</h4>
            <p>Calcola gli score economico-finanziari e andamentali per il rating aziendale.</p>
            
            <h4>5. Salvataggio</h4>
            <p>Salva e esporta le analisi in formato PDF.</p>
        </div>
        <button onclick="this.closest('div').parentElement.remove()" class="btn btn-primary" style="margin-top: 20px; width: 100%;">Chiudi</button>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
}

// ========== GESTIONE DATI TABELLE ==========
window.getDatiTabelle = function() {
    // Prima cerca in state
    if (state.tabellesSalvate) {
        return state.tabellesSalvate;
    }
    
    const cfKey = (state?.cf || state?.codiceFiscale || 'NA').toString().trim();
    const yPrev = (state?.anni?.prev || 'NA').toString();
    const yLast = (state?.anni?.last || 'NA').toString();
    
    if (cfKey === 'NA' || yPrev === 'NA' || yLast === 'NA') {
        console.warn('getDatiTabelle: dati mancanti per chiave');
        
        // Prova a leggere direttamente dal DOM se il modal √® aperto
        const result = {};
        document.querySelectorAll('[id^="deb_"], [id^="cred_"]').forEach(input => {
            if (input.id && input.value) {
                const val = input.value.replace(/\./g, '').replace(',', '.');
                result[input.id] = parseFloat(val) || 0;
            }
        });
        return result;
    }
    
    const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;
    console.log('getDatiTabelle cerca con chiave:', storeKey);
    
    const saved = localStorage.getItem(storeKey);
    if (saved) {
        const dati = JSON.parse(saved);
        const result = {};
        
        Object.keys(dati).forEach(key => {
            if (key !== 'cf' && key !== 'anni' && key !== 'timestamp') {
                const val = dati[key].toString().replace(/\./g, '').replace(',', '.');
                result[key] = parseFloat(val) || 0;
            }
        });
        
        state.tabellesSalvate = result;
        console.log('Tabelle caricate:', result);
// üîÑ Copia i bilanci anche nello state principale per compatibilit√† ceoDOC
if (dati.spRows && dati.spRows.length) state.spRows = dati.spRows;
if (dati.ceRows && dati.ceRows.length) state.ceRows = dati.ceRows;
if (dati.anni) state.anni = dati.anni;
console.log("‚úÖ Bilanci copiati in state:", state);

        return result;
    }
    
    console.warn(`Tabelle non trovate in localStorage per ${storeKey}`);
    return {};
};

// AGGIUNGI ANCHE QUESTA PER CARICARE AL MOMENTO GIUSTO:
window.caricaTabelleSeEsistono = function() {
    const tabelle = getDatiTabelle();
    if (tabelle && Object.keys(tabelle).length > 0) {
        // Popola i campi del modal se √® aperto
        Object.keys(tabelle).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                el.value = tabelle[key].toLocaleString('it-IT', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
        console.log('Tabelle caricate da localStorage');
        
        // Ricalcola i totali
        if (typeof calcolaTotaliCrediti === 'function') calcolaTotaliCrediti();
        if (typeof calcolaTotaliDebiti === 'function') calcolaTotaliDebiti();
        if (typeof calcolaTotaleAddetti === 'function') calcolaTotaleAddetti();
        if (typeof calcolaTotaleAmm === 'function') calcolaTotaleAmm();
    }
}

// Funzioni per accesso diretto senza modal con tab
window.mostraBilanciStandardizzati = function() {
    window.DEBUG_STATE = state;
    window.DEBUG_SP = state.spRows;
    window.DEBUG_CE = state.ceRows;
    
    if (!state.spRows.length || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'modalBilanciStandard';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 95%;
        max-width: 1600px;
        height: 90vh;
        border-radius: 12px;
        overflow-y: auto;
        padding: 20px;
    `;
    
    container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #003d82;">Bilanci Standardizzati</h2>
            <button onclick="document.getElementById('modalBilanciStandard').remove()" 
                    style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Chiudi
            </button>
        </div>
        ${generaBilanciStandardHTML()}
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);
};

// === FUNZIONI GLOBALI PER CALCOLO TOTALI E FORMATTAZIONE ===
// Queste devono essere disponibili per gli eventi onblur nel generaTabelleHTML

window.formatInput = function(input) {
    let value = input.value.replace(/\./g, '').replace(',', '.');
    let num = parseFloat(value);
    if (!isNaN(num)) {
        input.value = num.toLocaleString('it-IT', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
};

window.mostraCompilaTables = function() {
    // Verifica dati disponibili
    if (!state || !state.spRows || !state.spRows.length || !state.ceRows || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return;
    }

    // Modal wrapper
    const modal = document.createElement('div');
    modal.id = 'modalTabelle';
    modal.style.cssText = `
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.7);
        z-index: 10000; 
        display: flex; 
        align-items: center; 
        justify-content: center;
    `;

    // Container
    const container = document.createElement('div');
    container.style.cssText = `
        background: #fff; 
        width: 95%; 
        max-width: 1400px; 
        height: 90vh;
        border-radius: 12px; 
        overflow-y: auto; 
        padding: 20px; 
        box-shadow: 0 20px 60px rgba(0,0,0,.3);
    `;

    // Contenuto HTML
    container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #e5e7eb;">
            <h2 style="color:#1e40af; margin:0;">üìä Compila Tabelle Dettaglio</h2>
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="btn btn-success" onclick="salvaDatiTabelle()" 
                        style="padding:10px 25px; font-size:15px; font-weight:bold;">
                    üíæ SALVA TABELLE
                </button>
                <div style="font-size:12px; color:#666; border-left:2px solid #ddd; padding-left:15px;">
                    <div><strong>Azienda:</strong> ${state.denominazione || state.denom || 'N/D'}</div>
                    <div><strong>CF:</strong> ${state.codiceFiscale || state.cf || 'N/D'} | <strong>Anni:</strong> ${state.anni?.prev}-${state.anni?.last}</div>
                </div>
                <button onclick="document.getElementById('modalTabelle').remove()"
                        style="background:#dc2626;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
                    Chiudi
                </button>
            </div>
        </div>
        ${generaTabelleHTML()}
    `;

    modal.appendChild(container);
    document.body.appendChild(modal);

    // === AUTOCOMPILAZIONE DOPO CHE IL DOM √à PRONTO ===
    setTimeout(() => {
        try {
            const tipo = (state.tipo || 'Ordinario');
            const isOrdinario = (tipo === 'Ordinario');
            
            // === HELPER FUNCTIONS ===
            const sumByCode = (codes, period = 'last') => {
                let sum = 0;
                codes.forEach(code => {
                    const row = state.spRows.find(r => r.codice === code);
                    if (row && row[period]) {
                        sum += Math.abs(parseFloat(row[period]) || 0);
                    }
                });
                return sum;
            };
            
            const setIfEmpty = (id, value) => {
                const el = document.getElementById(id);
                if (el && !el.value && value) {
                    el.value = value.toLocaleString('it-IT', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                }
            };
            
            // === 1. COSTO PERSONALE TOTALE ===
            const costoPersonale = state.ceRows.find(r => {
                const voce = (r.voce || '').toLowerCase();
                return (voce.includes('personale') && 
                       (voce.includes('9)') || voce.includes('totale costi per il personale')));
            });
            
            if (costoPersonale) {
                setIfEmpty('costo_pers_tot_prev', Math.abs(costoPersonale.prev || 0));
                setIfEmpty('costo_pers_tot_last', Math.abs(costoPersonale.last || 0));
            }
            
            // === TOTALI CREDITI E DEBITI DAL BILANCIO ===
            const totaleCrediti = state.spRows.find(r => {
                const voce = (r.voce || '').toLowerCase();
                return voce.includes('totale crediti');
            });
            
            if (totaleCrediti) {
                setIfEmpty('cred_totale_prev', Math.abs(totaleCrediti.prev || 0));
                setIfEmpty('cred_totale_last', Math.abs(totaleCrediti.last || 0));
                const elPrev = document.getElementById('cred_totale_prev');
                const elLast = document.getElementById('cred_totale_last');
                if (elPrev) elPrev.setAttribute('data-bilancio', Math.abs(totaleCrediti.prev || 0));
                if (elLast) elLast.setAttribute('data-bilancio', Math.abs(totaleCrediti.last || 0));
            }
            
            const totaleDebiti = state.spRows.find(r => {
                const voce = (r.voce || '').toLowerCase();
                return voce.includes('totale debiti');
            });
            
            if (totaleDebiti) {
                setIfEmpty('deb_totale_prev', Math.abs(totaleDebiti.prev || 0));
                setIfEmpty('deb_totale_last', Math.abs(totaleDebiti.last || 0));
                const elPrev = document.getElementById('deb_totale_prev');
                const elLast = document.getElementById('deb_totale_last');
                if (elPrev) elPrev.setAttribute('data-bilancio', Math.abs(totaleDebiti.prev || 0));
                if (elLast) elLast.setAttribute('data-bilancio', Math.abs(totaleDebiti.last || 0));
            }
            
            // === 2. AUTOCOMPILAZIONE CREDITI/DEBITI (solo per Ordinario) ===
            if (isOrdinario) {
                // CREDITI ENTRO
                setIfEmpty('cred_e_comm_prev', sumByCode(['T0001.D01.1.001.002.004.004.002.002.000'], 'prev'));
                setIfEmpty('cred_e_comm_last', sumByCode(['T0001.D01.1.001.002.004.004.002.002.000'], 'last'));
                setIfEmpty('cred_e_trib_prev', sumByCode(['T0001.D01.1.001.002.004.004.007.002.000'], 'prev'));
                setIfEmpty('cred_e_trib_last', sumByCode(['T0001.D01.1.001.002.004.004.007.002.000'], 'last'));
                
                // CREDITI OLTRE  
                setIfEmpty('cred_o_comm_prev', sumByCode(['T0001.D01.1.001.002.004.004.002.003.000'], 'prev'));
                setIfEmpty('cred_o_comm_last', sumByCode(['T0001.D01.1.001.002.004.004.002.003.000'], 'last'));
                setIfEmpty('cred_o_trib_prev', sumByCode(['T0001.D01.1.001.002.004.004.007.003.000'], 'prev'));
                setIfEmpty('cred_o_trib_last', sumByCode(['T0001.D01.1.001.002.004.004.007.003.000'], 'last'));
                
                // DEBITI ENTRO
                setIfEmpty('deb_e_comm_prev', sumByCode(['T0001.D01.1.001.003.005.008.002.000.000', 'T0001.D01.1.001.003.005.007.002.000.000'], 'prev'));
                setIfEmpty('deb_e_comm_last', sumByCode(['T0001.D01.1.001.003.005.008.002.000.000', 'T0001.D01.1.001.003.005.007.002.000.000'], 'last'));
                setIfEmpty('deb_e_fin_prev', sumByCode(['T0001.D01.1.001.003.005.005.002.000.000'], 'prev'));
                setIfEmpty('deb_e_fin_last', sumByCode(['T0001.D01.1.001.003.005.005.002.000.000'], 'last'));
                
                // DEBITI OLTRE
                setIfEmpty('deb_o_comm_prev', sumByCode(['T0001.D01.1.001.003.005.008.003.000.000', 'T0001.D01.1.001.003.005.007.003.000.000'], 'prev'));
                setIfEmpty('deb_o_comm_last', sumByCode(['T0001.D01.1.001.003.005.008.003.000.000', 'T0001.D01.1.001.003.005.007.003.000.000'], 'last'));
                setIfEmpty('deb_o_fin_prev', sumByCode(['T0001.D01.1.001.003.005.005.003.000.000'], 'prev'));
                setIfEmpty('deb_o_fin_last', sumByCode(['T0001.D01.1.001.003.005.005.003.000.000'], 'last'));
            }
            
            // === CALCOLA TOTALI ===
            calcolaTotaliCrediti();
            calcolaTotaliDebiti();
            
// === CARICA DATI SALVATI SE ESISTONO ===
            if (state.tabellesSalvate) {
                setTimeout(() => {
                    Object.keys(state.tabellesSalvate).forEach(key => {
                        const el = document.getElementById(key);
                        if (el && state.tabellesSalvate[key]) {
                            el.value = state.tabellesSalvate[key];
                        }
                    });
                    console.log('Tabelle caricate dai dati salvati');
                    
                    // Ricalcola i totali
                    calcolaTotaliCrediti();
                    calcolaTotaliDebiti();
                    calcolaTotaleAddetti();
                    calcolaTotaleAmm();
                }, 200);
            }
            
        } catch (e) {
            console.error('Errore autocompilazione tabelle:', e);
        }
    }, 100);

    // üîÅ Dopo creazione modale, carica i dati salvati se esistono
    setTimeout(() => {
      if (typeof window.caricaDatiTabelle === "function") {
        window.caricaDatiTabelle();
      }
    }, 300);
}


// === FUNZIONI DI CALCOLO TOTALI ===
function calcolaTotaliCrediti() {
    ['prev', 'last'].forEach(period => {
        const comm_e = parseFloat(document.getElementById(`cred_e_comm_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const trib_e = parseFloat(document.getElementById(`cred_e_trib_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const altri_e = parseFloat(document.getElementById(`cred_e_altri_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const totale_entro = comm_e + trib_e + altri_e;
        
        const comm_o = parseFloat(document.getElementById(`cred_o_comm_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const trib_o = parseFloat(document.getElementById(`cred_o_trib_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const altri_o = parseFloat(document.getElementById(`cred_o_altri_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const totale_oltre = comm_o + trib_o + altri_o;
        
        const entroEl = document.getElementById(`cred_entro_${period}`);
        const oltreEl = document.getElementById(`cred_oltre_${period}`);
        const totaleEl = document.getElementById(`cred_totale_${period}`);
        
        if (entroEl) entroEl.value = totale_entro.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (oltreEl) oltreEl.value = totale_oltre.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (totaleEl) totaleEl.value = (totale_entro + totale_oltre).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    });
}

function calcolaTotaliDebiti() {
    ['prev', 'last'].forEach(period => {
        const comm_e = parseFloat(document.getElementById(`deb_e_comm_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const fin_e = parseFloat(document.getElementById(`deb_e_fin_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const trib_e = parseFloat(document.getElementById(`deb_e_tribprev_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const altri_e = parseFloat(document.getElementById(`deb_e_altri_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const totale_entro = comm_e + fin_e + trib_e + altri_e;
        
        const comm_o = parseFloat(document.getElementById(`deb_o_comm_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const fin_o = parseFloat(document.getElementById(`deb_o_fin_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const trib_o = parseFloat(document.getElementById(`deb_o_tribprev_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const altri_o = parseFloat(document.getElementById(`deb_o_altri_${period}`)?.value?.replace(/\./g, '').replace(',', '.')) || 0;
        const totale_oltre = comm_o + fin_o + trib_o + altri_o;
        
        const entroEl = document.getElementById(`deb_entro_${period}`);
        const oltreEl = document.getElementById(`deb_oltre_${period}`);
        const totaleEl = document.getElementById(`deb_totale_${period}`);
        
        if (entroEl) entroEl.value = totale_entro.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (oltreEl) oltreEl.value = totale_oltre.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (totaleEl) totaleEl.value = (totale_entro + totale_oltre).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    });
}

function calcolaTotaleAddetti() {
    const prod_prev = parseInt(document.getElementById('addetti_prod_prev')?.value) || 0;
    const amm_prev = parseInt(document.getElementById('addetti_amm_prev')?.value) || 0;
    const comm_prev = parseInt(document.getElementById('addetti_comm_prev')?.value) || 0;
    const altro_prev = parseInt(document.getElementById('addetti_altro_prev')?.value) || 0;
    
    const prod_last = parseInt(document.getElementById('addetti_prod_last')?.value) || 0;
    const amm_last = parseInt(document.getElementById('addetti_amm_last')?.value) || 0;
    const comm_last = parseInt(document.getElementById('addetti_comm_last')?.value) || 0;
    const altro_last = parseInt(document.getElementById('addetti_altro_last')?.value) || 0;
    
    const el_prev = document.getElementById('addetti_tot_prev');
    const el_last = document.getElementById('addetti_tot_last');
    
    if (el_prev) el_prev.value = prod_prev + amm_prev + comm_prev + altro_prev || '';
    if (el_last) el_last.value = prod_last + amm_last + comm_last + altro_last || '';
}

function calcolaTotaleAmm() {
    const compensi_prev = parseFloat(document.getElementById('amm_compensi_prev')?.value?.replace(/\./g, '').replace(',', '.')) || 0;
    const contributi_prev = parseFloat(document.getElementById('amm_contributi_prev')?.value?.replace(/\./g, '').replace(',', '.')) || 0;
    
    const compensi_last = parseFloat(document.getElementById('amm_compensi_last')?.value?.replace(/\./g, '').replace(',', '.')) || 0;
    const contributi_last = parseFloat(document.getElementById('amm_contributi_last')?.value?.replace(/\./g, '').replace(',', '.')) || 0;
    
    const el_prev = document.getElementById('amm_totale_prev');
    const el_last = document.getElementById('amm_totale_last');
    
    if (el_prev) el_prev.value = (compensi_prev + contributi_prev).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    if (el_last) el_last.value = (compensi_last + contributi_last).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// ================= NUOVE FUNZIONI RENDICONTO MODAL =================
window.mostraRendiconto = function() {
if (window.SILENT_MODE) return; // üü¶ non mostrare la modale durante il salvataggio

    if (!state || !state.spRows || !state.spRows.length || !state.ceRows || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return;
    }

    // Modal wrapper
    const modal = document.createElement('div');
    modal.id = 'modalRendiconto';
    modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    // Container
    const container = document.createElement('div');
    container.style.cssText = `
        background: #fff;
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        border-radius: 12px;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,.3);
    `;

    // Calcola rendiconto
    const rendiconto = calcolaRendicontoCorretto();
    
    container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:#003d82; margin:0;">Rendiconto Finanziario (Metodo Indiretto)</h2>
            <button onclick="document.getElementById('modalRendiconto').remove()"
                    style="background:#dc2626; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
                Chiudi
            </button>
        </div>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
            <strong>Periodo:</strong> 31/12/${state.anni.prev} ‚Üí 31/12/${state.anni.last}<br>
            <strong>Œî Liquidit√† effettiva:</strong> <span style="color:#10b981; font-size:1.2em;">
                ‚Ç¨${rendiconto.deltaLiquidita.toLocaleString('it-IT', {minimumFractionDigits: 2})}
            </span>
        </div>
        
        ${generaHTMLRendiconto(rendiconto)}
    `;

    modal.appendChild(container);
    document.body.appendChild(modal);
};

function calcolaRendicontoCorretto() {
    // Trova voci dai bilanci standardizzati
    const findSP = (text) => {
        const searchText = text.toLowerCase();
        return state.spRows.find(r => (r.voce || '').toLowerCase().includes(searchText));
    };
    
    const findCE = (text) => {
        const searchText = text.toLowerCase();
        return state.ceRows.find(r => (r.voce || '').toLowerCase().includes(searchText));
    };
    
    // === DATI BASE ===
    
    // LIQUIDIT√Ä
    const rowLiquidita = findSP('iv - disponibilit√† liquide') || findSP('disponibilit√† liquide');
    const liquiditaPrev = parseFloat(rowLiquidita?.prev || 0);
    const liquiditaLast = parseFloat(rowLiquidita?.last || 0);
    const deltaLiquidita = liquiditaLast - liquiditaPrev;
    
    // UTILE
    const rowUtile = findCE('21) utile') || findCE('utile (perdita)');
    const utile = parseFloat(rowUtile?.last || 0);
    
    // AMMORTAMENTI (voce 10)
    const rowAmm = findCE('10) ammortamenti') || findCE('ammortamenti e svalutazioni');
    const ammortamenti = parseFloat(rowAmm?.last || 0);
    
    // ACCANTONAMENTI
    const rowAccRischi = findCE('12) accantonamenti per rischi');
    const rowAccAltri = findCE('13) altri accantonamenti');
    const accantonamenti = parseFloat(rowAccRischi?.last || 0) + parseFloat(rowAccAltri?.last || 0);
    
    // TFR
    const rowTFR = findSP('c) trattamento di fine rapporto') || findSP('tfr');
    const tfrPrev = parseFloat(rowTFR?.prev || 0);
    const tfrLast = parseFloat(rowTFR?.last || 0);
    const deltaTFR = tfrLast - tfrPrev;
    
    // === VARIAZIONI CCN ===
    
    // RIMANENZE (da SP)
    const rowRimanenze = findSP('i - rimanenze');
    const rimanenzePrev = parseFloat(rowRimanenze?.prev || 0);
    const rimanenzeLast = parseFloat(rowRimanenze?.last || 0);
    const deltaRimanenze = rimanenzeLast - rimanenzePrev;
    
    // CREDITI E DEBITI - LEGGI DALLE TABELLE HTML!
    let deltaCredComm = 0;
    let deltaCredAltri = 0;
    let deltaDebComm = 0;
    let deltaDebFin = 0;
    let deltaDebAltri = 0;
    
    // Prova a leggere dalle tabelle HTML se esistono
    if (typeof document !== 'undefined') {
        // Crediti commerciali (entro + oltre)
        const credCommEntPrev = parseFloat(document.getElementById('cred_e_comm_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const credCommEntLast = parseFloat(document.getElementById('cred_e_comm_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const credCommOltPrev = parseFloat(document.getElementById('cred_o_comm_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const credCommOltLast = parseFloat(document.getElementById('cred_o_comm_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        deltaCredComm = (credCommEntLast + credCommOltLast) - (credCommEntPrev + credCommOltPrev);
        
        // Altri crediti (tributari + altri + imposte anticipate)
        const credTotPrev = parseFloat(document.getElementById('cred_totale_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const credTotLast = parseFloat(document.getElementById('cred_totale_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        deltaCredAltri = (credTotLast - credTotPrev) - deltaCredComm;
        
        // Debiti commerciali (entro + oltre)
        const debCommEntPrev = parseFloat(document.getElementById('deb_e_comm_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debCommEntLast = parseFloat(document.getElementById('deb_e_comm_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debCommOltPrev = parseFloat(document.getElementById('deb_o_comm_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debCommOltLast = parseFloat(document.getElementById('deb_o_comm_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        deltaDebComm = (debCommEntLast + debCommOltLast) - (debCommEntPrev + debCommOltPrev);
        
        // Debiti finanziari (entro + oltre)
        const debFinEntPrev = parseFloat(document.getElementById('deb_e_fin_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debFinEntLast = parseFloat(document.getElementById('deb_e_fin_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debFinOltPrev = parseFloat(document.getElementById('deb_o_fin_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debFinOltLast = parseFloat(document.getElementById('deb_o_fin_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        deltaDebFin = (debFinEntLast + debFinOltLast) - (debFinEntPrev + debFinOltPrev);
        
        // Altri debiti
        const debTotPrev = parseFloat(document.getElementById('deb_totale_prev')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        const debTotLast = parseFloat(document.getElementById('deb_totale_last')?.value?.replace(/\./g, '').replace(',', '.') || 0);
        deltaDebAltri = (debTotLast - debTotPrev) - deltaDebComm - deltaDebFin;
    }
    
    // Se non ci sono tabelle, usa i totali da SP
    if (deltaCredComm === 0 && deltaCredAltri === 0) {
        const rowCrediti = findSP('totale crediti');
        const creditiPrev = parseFloat(rowCrediti?.prev || 0);
        const creditiLast = parseFloat(rowCrediti?.last || 0);
        deltaCredAltri = creditiLast - creditiPrev;
    }
    
    if (deltaDebComm === 0 && deltaDebAltri === 0 && deltaDebFin === 0) {
        const rowDebiti = findSP('totale debiti');
        const debitiPrev = parseFloat(rowDebiti?.prev || 0);
        const debitiLast = parseFloat(rowDebiti?.last || 0);
        deltaDebAltri = debitiLast - debitiPrev;
    }
    
    // RATEI E RISCONTI
    const rowRateiAtt = findSP('d) ratei e risconti');
    const rateiAttPrev = parseFloat(rowRateiAtt?.prev || 0);
    const rateiAttLast = parseFloat(rowRateiAtt?.last || 0);
    const deltaRateiAtt = rateiAttLast - rateiAttPrev;
    
    const rowRateiPass = findSP('e) ratei e risconti');
    const rateiPassPrev = parseFloat(rowRateiPass?.prev || 0);
    const rateiPassLast = parseFloat(rowRateiPass?.last || 0);
    const deltaRateiPass = rateiPassLast - rateiPassPrev;
    
    // IMPOSTE PAGATE (stima: correnti anno precedente)
    const rowImposteCorrenti = findCE('imposte correnti');
    const impostePagate = parseFloat(rowImposteCorrenti?.prev || 0);
    
    // ONERI FINANZIARI
    const rowOneri = findCE('17) interessi') || findCE('oneri finanziari');
    const oneriFinanziari = parseFloat(rowOneri?.last || 0);
    
    // === CALCOLO FLUSSI ===
    
    // Flusso prima delle variazioni CCN
    const flussoPrimaCCN = utile + ammortamenti + accantonamenti + deltaTFR;
    
    // Variazioni CCN teoriche
    const variazioneCCNTeorica = -deltaRimanenze - deltaCredComm - deltaCredAltri + 
                                  deltaDebComm + deltaDebAltri - deltaRateiAtt + deltaRateiPass;
    
    // Flusso gestione teorico
    const flussoGestioneTeorico = flussoPrimaCCN + variazioneCCNTeorica - impostePagate - oneriFinanziari;
    
    // B) INVESTIMENTI
    const rowImm = findSP('totale immobilizzazioni');
    const immPrev = parseFloat(rowImm?.prev || 0);
    const immLast = parseFloat(rowImm?.last || 0);
    const deltaImm = immLast - immPrev;
    const investimenti = -(deltaImm + ammortamenti);
    
    // C) FINANZIAMENTO
    const rowPN = findSP('totale patrimonio netto');
    const pnPrev = parseFloat(rowPN?.prev || 0);
    const pnLast = parseFloat(rowPN?.last || 0);
    const deltaPN = pnLast - pnPrev - utile;
    
    const flussoFinanziamento = deltaDebFin + deltaPN;
    
    // TOTALE TEORICO
    const flussoTotaleTeorico = flussoGestioneTeorico + investimenti + flussoFinanziamento;
    
    // ALTRI MOVIMENTI CCN (voce di quadratura)
    const altriMovimentiCCN = deltaLiquidita - flussoTotaleTeorico;
    
    // Flusso gestione finale (con quadratura)
    const flussoGestioneReddituale = flussoGestioneTeorico + altriMovimentiCCN;
    
    // Flusso totale finale
    const flussoTotale = flussoGestioneReddituale + investimenti + flussoFinanziamento;
    
    return {
        deltaLiquidita,
        utile,
        ammortamenti,
        accantonamenti,
        deltaTFR,
        deltaRimanenze,
        deltaCrediti: deltaCredComm + deltaCredAltri,
        deltaDebitiForn: deltaDebComm,
        variazioneCCN: variazioneCCNTeorica + altriMovimentiCCN,
        altriMovimentiCCN,  // Voce di quadratura
        imposte: impostePagate,
        oneriFinanziari,
        flussoGestioneReddituale,
        investimenti,
        deltaDebitiFinanziari: deltaDebFin,
        deltaPN,
        flussoFinanziamento,
        flussoTotale,
        quadratura: Math.abs(flussoTotale - deltaLiquidita) < 1
    };
}

function generaHTMLRendiconto(r) {
    const fmt = (v) => v.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    return `
    <table style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="background:#e3f2fd;">
                <th style="text-align:left; padding:10px; border:1px solid #ddd;">Voce</th>
                <th style="text-align:right; padding:10px; border:1px solid #ddd;">Importo</th>
            </tr>
        </thead>
        <tbody>
            <tr style="background:#fff3e0;">
                <td colspan="2" style="padding:10px; font-weight:bold;">A) FLUSSI GESTIONE REDDITUALE</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">Utile (perdita) dell'esercizio</td>
                <td style="text-align:right; padding:8px;">${fmt(r.utile)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">+ Ammortamenti e svalutazioni</td>
                <td style="text-align:right; padding:8px;">${fmt(r.ammortamenti)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">+ Accantonamenti</td>
                <td style="text-align:right; padding:8px;">${fmt(r.accantonamenti)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione TFR</td>
                <td style="text-align:right; padding:8px;">${fmt(r.deltaTFR)}</td>
            </tr>
            <tr style="background:#f5f5f5;">
                <td style="padding:8px; font-weight:bold;">Flusso prima delle variazioni CCN</td>
                <td style="text-align:right; padding:8px; font-weight:bold;">${fmt(r.utile + r.ammortamenti + r.accantonamenti + r.deltaTFR)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione rimanenze</td>
                <td style="text-align:right; padding:8px; color:${r.deltaRimanenze > 0 ? 'red' : 'green'};">${fmt(-r.deltaRimanenze)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione crediti</td>
                <td style="text-align:right; padding:8px; color:${r.deltaCrediti > 0 ? 'red' : 'green'};">${fmt(-r.deltaCrediti)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione debiti commerciali</td>
                <td style="text-align:right; padding:8px; color:${r.deltaDebitiForn > 0 ? 'green' : 'red'};">${fmt(r.deltaDebitiForn)}</td>
            </tr>
            ${r.altriMovimentiCCN !== 0 ? `
            <tr style="background:#fff9c4;">
                <td style="padding:8px; padding-left:20px; font-style:italic;">¬± Altri movimenti CCN (*)</td>
                <td style="text-align:right; padding:8px;">${fmt(r.altriMovimentiCCN)}</td>
            </tr>
            ` : ''}
            <tr>
                <td style="padding:8px; padding-left:20px;">- Imposte pagate (stima)</td>
                <td style="text-align:right; padding:8px; color:red;">${fmt(-r.imposte)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">- Oneri finanziari</td>
                <td style="text-align:right; padding:8px; color:red;">${fmt(-r.oneriFinanziari)}</td>
            </tr>
            <tr style="background:#e8f5e9;">
                <td style="padding:10px; font-weight:bold;">FLUSSO GESTIONE REDDITUALE (A)</td>
                <td style="text-align:right; padding:10px; font-weight:bold;">${fmt(r.flussoGestioneReddituale)}</td>
            </tr>
            
            <tr style="background:#fff3e0;">
                <td colspan="2" style="padding:10px; font-weight:bold;">B) FLUSSI DA INVESTIMENTI</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">(Investimenti) / Disinvestimenti netti</td>
                <td style="text-align:right; padding:8px; color:${r.investimenti < 0 ? 'red' : 'green'};">${fmt(r.investimenti)}</td>
            </tr>
            <tr style="background:#ffebee;">
                <td style="padding:10px; font-weight:bold;">FLUSSO INVESTIMENTI (B)</td>
                <td style="text-align:right; padding:10px; font-weight:bold;">${fmt(r.investimenti)}</td>
            </tr>
            
            <tr style="background:#fff3e0;">
                <td colspan="2" style="padding:10px; font-weight:bold;">C) FLUSSI DA FINANZIAMENTO</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione debiti finanziari</td>
                <td style="text-align:right; padding:8px;">${fmt(r.deltaDebitiFinanziari)}</td>
            </tr>
            <tr>
                <td style="padding:8px; padding-left:20px;">¬± Variazione patrimonio netto</td>
                <td style="text-align:right; padding:8px;">${fmt(r.deltaPN)}</td>
            </tr>
            <tr style="background:#e3f2fd;">
                <td style="padding:10px; font-weight:bold;">FLUSSO FINANZIAMENTO (C)</td>
                <td style="text-align:right; padding:10px; font-weight:bold;">${fmt(r.flussoFinanziamento)}</td>
            </tr>
            
            <tr style="background:#263238; color:white;">
                <td style="padding:12px; font-weight:bold; font-size:1.1em;">FLUSSO TOTALE (A+B+C)</td>
                <td style="text-align:right; padding:12px; font-weight:bold; font-size:1.1em;">${fmt(r.flussoTotale)}</td>
            </tr>
            <tr style="background:#c8e6c9;">
                <td style="padding:10px;">Œî Liquidit√† da SP</td>
                <td style="text-align:right; padding:10px;">${fmt(r.deltaLiquidita)}</td>
            </tr>
            <tr style="background:#c8e6c9;">
                <td style="padding:10px;">Quadratura</td>
                <td style="text-align:right; padding:10px; font-weight:bold;">‚úì SEMPRE OK</td>
            </tr>
        </tbody>
    </table>
    
    ${r.altriMovimentiCCN !== 0 ? `
    <div style="margin-top:15px; padding:10px; background:#fff9c4; border-radius:6px; font-size:11px;">
        <strong>(*) Nota:</strong> La voce include  differenze tra imposte pagate e di competenza, TFR liquidato nell'esercizio, utilizzo fondi rischi, 
        plusvalenze/minusvalenze da cessioni, e altri movimenti non desumibili dal bilancio.
    </div>
    ` : ''}
    
    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 8px; border-left: 4px solid #1976d2;">
        <h4 style="color: #0d47a1; margin: 0 0 10px 0;">üìà ANALISI GENERAZIONE/ASSORBIMENTO LIQUIDIT√Ä</h4>
        
        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <strong>Gestione Reddituale (A):</strong> 
            <span style="color: ${r.flussoGestioneReddituale > 0 ? '#2e7d32' : '#c62828'}; font-weight: bold;">
                ${r.flussoGestioneReddituale > 0 ? '‚úì GENERA' : '‚úó ASSORBE'} CASSA
            </span> 
            per ‚Ç¨${Math.abs(r.flussoGestioneReddituale).toLocaleString('it-IT', {minimumFractionDigits: 0})}
            ${r.flussoGestioneReddituale > 0 ? 
                '‚Üí L\'attivit√† operativa produce liquidit√†' : 
                '‚Üí L\'attivit√† operativa consuma liquidit√† (situazione critica)'}
        </div>
        
        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <strong>Investimenti (B):</strong> 
            <span style="color: ${r.investimenti > 0 ? '#2e7d32' : '#c62828'}; font-weight: bold;">
                ${r.investimenti > 0 ? '‚úì GENERA' : '‚úó ASSORBE'} CASSA
            </span> 
            per ‚Ç¨${Math.abs(r.investimenti).toLocaleString('it-IT', {minimumFractionDigits: 0})}
            ${r.investimenti < 0 ? 
                '‚Üí L\'azienda sta investendo in crescita' : 
                '‚Üí L\'azienda sta disinvestendo'}
        </div>
        
        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
            <strong>Finanziamento (C):</strong> 
            <span style="color: ${r.flussoFinanziamento > 0 ? '#2e7d32' : '#c62828'}; font-weight: bold;">
                ${r.flussoFinanziamento > 0 ? '‚úì GENERA' : '‚úó ASSORBE'} CASSA
            </span> 
            per ‚Ç¨${Math.abs(r.flussoFinanziamento).toLocaleString('it-IT', {minimumFractionDigits: 0})}
            ${r.flussoFinanziamento > 0 ? 
                '‚Üí Aumento indebitamento o capitale' : 
                '‚Üí Rimborso debiti o distribuzione dividendi'}
        </div>
        
        <div style="background: ${r.deltaLiquidita > 0 ? '#c8e6c9' : '#ffcdd2'}; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 18px; font-weight: bold; color: ${r.deltaLiquidita > 0 ? '#1b5e20' : '#b71c1c'};">
                ${r.deltaLiquidita > 0 ? 'üí∞ L\'AZIENDA CREA CASSA' : 'üî• L\'AZIENDA BRUCIA CASSA'}
            </div>
            <div style="font-size: 24px; margin: 10px 0;">
                ${r.deltaLiquidita > 0 ? '+' : ''}‚Ç¨${r.deltaLiquidita.toLocaleString('it-IT', {minimumFractionDigits: 0})}
            </div>
            <div style="font-size: 12px; color: #555;">
                ${r.deltaLiquidita > 0 ? 
                    'La liquidit√† √® aumentata: situazione positiva' : 
                    'La liquidit√† √® diminuita: monitorare attentamente'}
            </div>
        </div>
        
        ${Math.abs(r.flussoGestioneReddituale) > Math.abs(r.investimenti) && r.flussoGestioneReddituale > 0 ?
            '<div style="margin-top:10px; padding:8px; background:#e8f5e9; border-radius:4px; font-size:12px;">‚úÖ <strong>Situazione ottimale:</strong> La gestione operativa genera abbastanza cassa per finanziare gli investimenti.</div>' :
            ''}
        
        ${r.flussoGestioneReddituale < 0 ?
            '<div style="margin-top:10px; padding:8px; background:#ffebee; border-radius:4px; font-size:12px;">‚ö†Ô∏è <strong>Attenzione:</strong> La gestione reddituale negativa indica problemi operativi da risolvere urgentemente.</div>' :
            ''}
    </div>`;
}

// ========== MOSTRA MODAL BREAK-EVEN AGGIORNATO ==========
window.mostraBreakEven = function() {
    if (!state.spRows.length || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'modalBreakEven';
    modal.style.cssText = `
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: #fff;
        width: 95%; max-width: 1400px; height: 90vh;
        border-radius: 12px; overflow-y: auto; padding: 20px;
    `;
    
    container.innerHTML = `
        <div style="
            position: sticky; top: 0;
            z-index: 10003;
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; margin: -20px -20px 20px -20px;
            background: #ffffff; border-bottom: 1px solid #e5e7eb;
            border-radius: 12px 12px 0 0;">
            <h2 style="color:#003d82; margin:0;">Analisi Break-Even - ${state.anni.prev} vs ${state.anni.last}</h2>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-success" onclick="salvaBreakeven()">
                    üíæ Salva Configurazione
                </button>
                <button class="btn btn-primary" onclick="calcolaBreakeven()">
                    üìä Calcola Break-Even
                </button>
                <button onclick="document.getElementById('modalBreakEven').remove()"
                        style="background:#dc2626; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
                    Chiudi
                </button>
            </div>
        </div>
        ${generaBreakevenHTML()}
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);
    
    // Popola dopo che il DOM √® pronto
    setTimeout(() => {
        try {
            if (typeof popolaVociBreakeven === 'function') {
                popolaVociBreakeven();
            }
        } catch (e) {
            console.warn('BreakEven populate:', e);
        }
    }, 100);
};

// ========== RIORGANIZZAZIONE PULSANTI FASE 3 ==========

// 1. BILANCI RICLASSIFICATI - Menu con sottopulsanti
window.mostraBilanciRiclassificati = function() {
    if (!state.spRows.length || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'modalRiclassificazioni';
    modal.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 95%; max-width: 1400px; height: 90vh;
        border-radius: 12px;
        display: flex; flex-direction: column;
        overflow: hidden;
    `;
    
    // Tab persistenti in alto
    container.innerHTML = `
        <div style="background: #003d82; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: white; margin: 0;">Riclassificazioni Bilancio</h2>
            <button onclick="document.getElementById('modalRiclassificazioni').remove()"
                    style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Chiudi
            </button>
        </div>
        
        <div style="display: flex; background: #f0f4f8; border-bottom: 2px solid #003d82;">
            <button class="tab-riclass active" onclick="showRiclassTab('va')" 
                    style="padding: 12px 20px; background: white; border: none; cursor: pointer; border-bottom: 3px solid #003d82;">
                Valore Aggiunto
            </button>
            <button class="tab-riclass" onclick="showRiclassTab('cev')"
                    style="padding: 12px 20px; background: none; border: none; cursor: pointer;">
                Costo del Venduto
            </button>
            <button class="tab-riclass" onclick="showRiclassTab('margini')"
                    style="padding: 12px 20px; background: none; border: none; cursor: pointer;">
                Margini di Contribuzione
            </button>
            <button class="tab-riclass" onclick="showRiclassTab('spfin')"
                    style="padding: 12px 20px; background: none; border: none; cursor: pointer;">
                SP Finanziario
            </button>
        </div>
        
        <div style="flex: 1; overflow-y: auto; padding: 20px;">
            <div id="tab-content-va">
                ${generaTabValoreAggiunto()}
            </div>
            <div id="tab-content-cev" style="display: none;">
                ${generaTabCostoVenduto()}
            </div>
            <div id="tab-content-margini" style="display: none;">
                ${generaTabMargini()}
            </div>
            <div id="tab-content-spfin" style="display: none;">
                ${generaTabSPFinanziario()}
            </div>
        </div>
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);
};

// Aggiungi DOPO la funzione riclassificazioneCEV
window.debugRiclassificazioni = function() {
    console.log("=== DEBUG RICLASSIFICAZIONI ===");
    
    // Mostra cosa trova CEV
    const cev = riclassificazioneCEV();
    console.log("CEV trovato:", cev);
    
    // Mostra cosa trova Valore Aggiunto
    const va = riclassificazioneValoreAggiunto();
    console.log("VA trovato:", va);
    
    // Mostra i primi 5 elementi SP e CE per capire la struttura
    console.log("Prime 5 righe SP:", state.spRows.slice(0, 5));
    console.log("Prime 5 righe CE:", state.ceRows.slice(0, 5));
    
    // Mostra quali voci cerca di trovare
    console.log("Ricavi vendite cercati:", state.ceRows.find(r => r.voce.includes("ricavi")));
    console.log("Acquisti cercati:", state.ceRows.find(r => r.voce.includes("acquisti") || r.voce.includes("materie")));
};

window.showRiclassTab = function(tab) {
    // Nascondi tutti
    document.querySelectorAll('[id^="tab-content-"]').forEach(el => {
        el.style.display = 'none';
    });
    
    // Rimuovi active da tutti i tab
    document.querySelectorAll('.tab-riclass').forEach(el => {
        el.classList.remove('active');
        el.style.background = 'none';
        el.style.borderBottom = 'none';
    });
    
    // Mostra il tab selezionato
    document.getElementById(`tab-content-${tab}`).style.display = 'block';
    
    // Attiva il pulsante
    event.target.classList.add('active');
    event.target.style.background = 'white';
    event.target.style.borderBottom = '3px solid #003d82';
};

// ========== GENERATORI CONTENUTO TAB RICLASSIFICAZIONI ==========
function generaTabValoreAggiunto() {
  const ce = extractStandardizedCE();
  const cePrev = extractStandardizedCEPrev();

  // ‚úÖ Funzione di calcolo robusta delle variazioni %
  const deltaPerc = (valPrev, valLast) => {
    const nPrev = parseFloat(String(valPrev).replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
    const nLast = parseFloat(String(valLast).replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;

    if (nPrev === 0 && nLast === 0) return "‚Äî";
    if (nPrev === 0) return nLast > 0 ? "+‚àû" : "-‚àû";

    const delta = ((nLast - nPrev) / Math.abs(nPrev)) * 100;
    const color = delta > 0 ? "green" : delta < 0 ? "red" : "#444";
    const arrow = delta > 0 ? "‚Üë" : delta < 0 ? "‚Üì" : "‚è∏Ô∏è";
    return `<span style="color:${color};font-weight:600;">${arrow} ${delta.toFixed(1)}%</span>`;
  };

  // === Calcoli intermedi ===
  const consPrev = cePrev.materiePrime + cePrev.servizi + cePrev.godimentoBeniTerzi;
  const consLast = ce.materiePrime + ce.servizi + ce.godimentoBeniTerzi;

  const VAprev = cePrev.valoreProduzione - consPrev;
  const VAlast = ce.valoreProduzione - consLast;

  const MOLprev = VAprev - cePrev.personale;
  const MOLlast = VAlast - ce.personale;

  return `
    <h3 style="color: #003d82;">Riclassificazione a Valore Aggiunto</h3>
    <table style="width: 80%; margin: 20px auto; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f4f8;">
          <th style="padding: 10px; text-align: left;">Voce</th>
          <th style="padding: 10px; text-align: right;">${state.anni.prev}</th>
          <th style="padding: 10px; text-align: right;">${state.anni.last}</th>
          <th style="padding: 10px; text-align: right;">Œî%</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 8px;"><strong>Valore della Produzione</strong></td>
          <td style="text-align: right;">${itFmt(cePrev.valoreProduzione)}</td>
          <td style="text-align: right;">${itFmt(ce.valoreProduzione)}</td>
          <td style="text-align: right;">${deltaPerc(cePrev.valoreProduzione, ce.valoreProduzione)}</td>
        </tr>

        <tr>
          <td style="padding: 8px;">- Consumi esterni</td>
          <td style="text-align: right; color: red;">-${itFmt(consPrev)}</td>
          <td style="text-align: right; color: red;">-${itFmt(consLast)}</td>
          <td style="text-align: right;">${deltaPerc(consPrev, consLast)}</td>
        </tr>

        <tr style="background: #e8f5e9;">
          <td style="padding: 8px;"><strong>= VALORE AGGIUNTO</strong></td>
          <td style="text-align: right;"><strong>${itFmt(VAprev)}</strong></td>
          <td style="text-align: right;"><strong>${itFmt(VAlast)}</strong></td>
          <td style="text-align: right;"><strong>${deltaPerc(VAprev, VAlast)}</strong></td>
        </tr>

        <tr>
          <td style="padding: 8px;">- Costo del personale</td>
          <td style="text-align: right; color: red;">-${itFmt(cePrev.personale)}</td>
          <td style="text-align: right; color: red;">-${itFmt(ce.personale)}</td>
          <td style="text-align: right;">${deltaPerc(cePrev.personale, ce.personale)}</td>
        </tr>

        <tr style="background: #fff3cd;">
          <td style="padding: 8px;"><strong>= MOL / EBITDA</strong></td>
          <td style="text-align: right;"><strong>${itFmt(MOLprev)}</strong></td>
          <td style="text-align: right;"><strong>${itFmt(MOLlast)}</strong></td>
          <td style="text-align: right;"><strong>${deltaPerc(MOLprev, MOLlast)}</strong></td>
        </tr>

        <tr>
          <td style="padding: 8px;">- Ammortamenti</td>
          <td style="text-align: right; color: red;">-${itFmt(cePrev.ammortamenti)}</td>
          <td style="text-align: right; color: red;">-${itFmt(ce.ammortamenti)}</td>
          <td style="text-align: right;">${deltaPerc(cePrev.ammortamenti, ce.ammortamenti)}</td>
        </tr>

        <tr style="background: #fef2f2;">
          <td style="padding: 8px;"><strong>= EBIT</strong></td>
          <td style="text-align: right;"><strong>${itFmt(cePrev.differenzaAB)}</strong></td>
          <td style="text-align: right;"><strong>${itFmt(ce.differenzaAB)}</strong></td>
          <td style="text-align: right;"><strong>${deltaPerc(cePrev.differenzaAB, ce.differenzaAB)}</strong></td>
        </tr>
      </tbody>
    </table>
  `;
}

function generaTabCostoVenduto() {
    return `
        <h3 style="color: #003d82;">Riclassificazione Costo del Venduto</h3>
        <p style="color: #666;">Per calcolare il Costo del Venduto √® necessario specificare le percentuali di produzione per ogni voce di costo.</p>
        
        <div style="margin: 20px auto; width: 80%;">
            <button onclick="mostraInputCostoVenduto()" 
                    style="background: #003d82; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer;">
                üìä Configura Percentuali e Calcola
            </button>
        </div>
        
        <div id="risultatiCEV" style="margin-top: 20px;"></div>
    `;
}

function generaTabMargini() {
    // Leggi da localStorage le percentuali break-even se esistono
    const breakeven = JSON.parse(localStorage.getItem(`breakeven_${state.cf}_${state.anni.last}`) || '{}');
    
    if (!breakeven.costiFissi) {
        return `
            <h3 style="color: #003d82;">Riclassificazione Margine di Contribuzione</h3>
            <p style="color: #666;">Per calcolare i margini di contribuzione √® necessario prima configurare l'analisi break-even.</p>
            <div style="margin: 20px auto; width: 80%;">
                <button onclick="mostraBreakEven()" 
                        style="background: #003d82; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer;">
                    üìà Configura Break-Even
                </button>
            </div>
        `;
    }
    
    const ce = extractStandardizedCE();
    const margineContribuzione = ce.ricaviVendite - breakeven.costiVariabili;
    const marginePerc = (margineContribuzione / ce.ricaviVendite) * 100;
    
    return `
        <h3 style="color: #003d82;">Riclassificazione Margine di Contribuzione</h3>
        <table style="width: 70%; margin: 20px auto; border-collapse: collapse;">
            <tr>
                <td style="padding: 10px;">Ricavi di vendita</td>
                <td style="text-align: right;">${itFmt(ce.ricaviVendite)}</td>
            </tr>
            <tr>
                <td style="padding: 10px;">- Costi Variabili</td>
                <td style="text-align: right; color: red;">-${itFmt(breakeven.costiVariabili)}</td>
            </tr>
            <tr style="background: #e8f5e9;">
                <td style="padding: 10px;"><strong>= MARGINE DI CONTRIBUZIONE</strong></td>
                <td style="text-align: right;"><strong>${itFmt(margineContribuzione)} (${marginePerc.toFixed(1)}%)</strong></td>
            </tr>
            <tr>
                <td style="padding: 10px;">- Costi Fissi</td>
                <td style="text-align: right; color: red;">-${itFmt(breakeven.costiFissi)}</td>
            </tr>
            <tr style="background: #fff3cd;">
                <td style="padding: 10px;"><strong>= RISULTATO OPERATIVO</strong></td>
                <td style="text-align: right;"><strong>${itFmt(margineContribuzione - breakeven.costiFissi)}</strong></td>
            </tr>
            <tr style="background: #f0f4f8;">
                <td style="padding: 10px;"><strong>Break-Even Point</strong></td>
                <td style="text-align: right;"><strong>${itFmt(breakeven.costiFissi / (marginePerc / 100))}</strong></td>
            </tr>
        </table>
    `;
}

function generaTabSPFinanziario() {
    const sp = extractStandardizedSP();
    const spPrev = extractStandardizedSPPrev();
    
    // Include i ratei e risconti nell'attivo corrente
    const attivoCorrenteLast = sp.attivoCircolante + sp.rateiRiscontiAttivi;
    const attivoCorrentePrev = spPrev.attivoCircolante + spPrev.rateiRiscontiAttivi;
    
    return `
        <h3 style="color: #003d82;">Stato Patrimoniale Riclassificato - Criterio Finanziario</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- IMPIEGHI -->
            <div>
                <h4 style="color: #003d82; border-bottom: 2px solid #003d82;">IMPIEGHI</h4>
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f0f4f8;">
                            <th style="padding: 8px; text-align: left;">Voce</th>
                            <th style="padding: 8px; text-align: right;">${state.anni.prev}</th>
                            <th style="padding: 8px; text-align: right;">${state.anni.last}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="font-weight: bold;">
                            <td>Attivo Fisso</td>
                            <td style="text-align: right;">${itFmt(spPrev.immobilizzazioni)}</td>
                            <td style="text-align: right;">${itFmt(sp.immobilizzazioni)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Imm. Immateriali</td>
                            <td style="text-align: right;">${itFmt(spPrev.immImmateriali)}</td>
                            <td style="text-align: right;">${itFmt(sp.immImmateriali)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Imm. Materiali</td>
                            <td style="text-align: right;">${itFmt(spPrev.immMateriali)}</td>
                            <td style="text-align: right;">${itFmt(sp.immMateriali)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Imm. Finanziarie</td>
                            <td style="text-align: right;">${itFmt(spPrev.immFinanziarie)}</td>
                            <td style="text-align: right;">${itFmt(sp.immFinanziarie)}</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td>Attivo Corrente</td>
                            <td style="text-align: right;">${itFmt(attivoCorrentePrev)}</td>
                            <td style="text-align: right;">${itFmt(attivoCorrenteLast)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Rimanenze</td>
                            <td style="text-align: right;">${itFmt(spPrev.rimanenze)}</td>
                            <td style="text-align: right;">${itFmt(sp.rimanenze)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Crediti</td>
                            <td style="text-align: right;">${itFmt(spPrev.totaleCrediti)}</td>
                            <td style="text-align: right;">${itFmt(sp.totaleCrediti)}</td>
                        </tr>
                        <tr style="font-size: 12px;">
                            <td style="padding-left: 20px;">Liquidit√†</td>
                            <td style="text-align: right;">${itFmt(spPrev.disponibilitaLiquide)}</td>
                            <td style="text-align: right;">${itFmt(sp.disponibilitaLiquide)}</td>
                        </tr>
                        <tr style="background: #003d82; color: white; font-weight: bold;">
                            <td>TOTALE IMPIEGHI</td>
                            <td style="text-align: right;">${itFmt(spPrev.totaleAttivo)}</td>
                            <td style="text-align: right;">${itFmt(sp.totaleAttivo)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- FONTI -->
            <div>
                <h4 style="color: #003d82; border-bottom: 2px solid #003d82;">FONTI</h4>
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f0f4f8;">
                            <th style="padding: 8px; text-align: left;">Voce</th>
                            <th style="padding: 8px; text-align: right;">${state.anni.prev}</th>
                            <th style="padding: 8px; text-align: right;">${state.anni.last}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="font-weight: bold;">
                            <td>Patrimonio Netto</td>
                            <td style="text-align: right;">${itFmt(spPrev.patrimonioNetto)}</td>
                            <td style="text-align: right;">${itFmt(sp.patrimonioNetto)}</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td>Passivit√† Consolidate</td>
                            <td style="text-align: right;">${itFmt(spPrev.fondiRischiOneri + spPrev.tfr + spPrev.debitiOltre12)}</td>
                            <td style="text-align: right;">${itFmt(sp.fondiRischiOneri + sp.tfr + sp.debitiOltre12)}</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td>Passivit√† Correnti</td>
                            <td style="text-align: right;">${itFmt(spPrev.debitiEntro12 + spPrev.rateiRiscontiPassivi)}</td>
                            <td style="text-align: right;">${itFmt(sp.debitiEntro12 + sp.rateiRiscontiPassivi)}</td>
                        </tr>
                        <tr style="background: #003d82; color: white; font-weight: bold;">
                            <td>TOTALE FONTI</td>
                            <td style="text-align: right;">${itFmt(spPrev.totalePassivo)}</td>
                            <td style="text-align: right;">${itFmt(sp.totalePassivo)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: ${Math.abs(sp.totaleAttivo - sp.totalePassivo) < 100 ? '#d4edda' : '#f8d7da'}; border-radius: 8px;">
            <strong>Controllo Quadratura:</strong> 
            ${Math.abs(sp.totaleAttivo - sp.totalePassivo) < 100 ? 
                `‚úÖ OK - Differenza: ‚Ç¨${Math.abs(sp.totaleAttivo - sp.totalePassivo).toFixed(0)}` : 
                `‚ö†Ô∏è ATTENZIONE - Differenza: ‚Ç¨${Math.abs(sp.totaleAttivo - sp.totalePassivo).toLocaleString('it-IT')}`}
        </div>
    `;
}

// =====================================================
// üìä MODALE CALCOLA INDICI DI BILANCIO (NUOVA STRUTTURA)
// =====================================================
window.calcolaIndici = function () {
  if (!state.spRows?.length || !state.ceRows?.length) {
    toast("‚ö†Ô∏è Prima importa un bilancio", true);
    return;
  }

  const anni = state.anni || { prev: "N-1", last: "N" };
  const indiciPrev = window.calcolaIndiciComplessiviPrev();
  const indiciLast = window.calcolaIndiciComplessivi();

  // === CREA MODALE ===
  const modal = document.createElement("div");
  modal.id = "modalIndici";
  modal.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,0.7);
    z-index:10000; display:flex; align-items:center; justify-content:center;
  `;

  const container = document.createElement("div");
  container.style.cssText = `
    background:#fff; width:95%; max-width:1400px; height:90vh;
    border-radius:12px; display:flex; flex-direction:column; overflow:hidden;
  `;

  // === HEADER ===
  container.innerHTML = `
    <div style="background:#003d82; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
      <h2 style="color:white; margin:0;">Analisi Indici di Bilancio ${anni.prev} ‚Üí ${anni.last}</h2>
      <button onclick="document.getElementById('modalIndici').remove()" 
              style="background:#dc2626; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
        Chiudi ‚úñ
      </button>
    </div>

    <!-- TABS PRINCIPALI -->
    <div style="display:flex; background:#f0f4f8; border-bottom:2px solid #003d82;">
      <button class="tab-indici active" onclick="showIndiciTab('economici')" id="tabbtn-economici"
              style="padding:12px 20px; background:white; border:none; cursor:pointer; border-bottom:3px solid #003d82;">Economici</button>
      <button class="tab-indici" onclick="showIndiciTab('finanziari')" id="tabbtn-finanziari"
              style="padding:12px 20px; background:none; border:none; cursor:pointer;">Finanziari</button>
      <button class="tab-indici" onclick="showIndiciTab('patrimoniali')" id="tabbtn-patrimoniali"
              style="padding:12px 20px; background:none; border:none; cursor:pointer;">Patrimoniali</button>
      <button class="tab-indici" onclick="showIndiciTab('produttivita')" id="tabbtn-produttivita"
              style="padding:12px 20px; background:none; border:none; cursor:pointer;">Produttivit√†</button>
      <button class="tab-indici" onclick="showIndiciTab('allerta')" id="tabbtn-allerta"
              style="padding:12px 20px; background:none; border:none; cursor:pointer;">‚ö†Ô∏è Allerta Crisi</button>
    </div>

    <!-- CONTENUTO TAB -->
    <div style="flex:1; overflow-y:auto; padding:20px;">
      <div id="tab-indici-economici">${generaTabIndiciEconomici(indiciPrev, indiciLast)}</div>
      <div id="tab-indici-finanziari" style="display:none;">${generaTabIndiciFinanziari(indiciPrev, indiciLast)}</div>
      <div id="tab-indici-patrimoniali" style="display:none;">${generaTabIndiciPatrimoniali(indiciPrev, indiciLast)}</div>
      <div id="tab-indici-produttivita" style="display:none;">${generaTabIndiciProduttivita(indiciPrev, indiciLast)}</div>
      
      <!-- ‚ö†Ô∏è ALLERTA CRISI con SOTTO-TABS -->
      <div id="tab-indici-allerta" style="display:none;">
        <div style="display:flex; background:#fff7ed; border-bottom:2px solid #f59e0b; padding:8px 0; margin-bottom:15px;">
          <button class="subtab-indici active" onclick="showSubTab('allerta-crisi')" id="subbtn-allerta"
                  style="padding:8px 15px; background:#fff; border:none; cursor:pointer; border-bottom:3px solid #f59e0b;">Allerta Crisi</button>
          <button class="subtab-indici" onclick="showSubTab('dscr')" id="subbtn-dscr"
                  style="padding:8px 15px; background:none; border:none; cursor:pointer;">DSCR</button>
          <button class="subtab-indici" onclick="showSubTab('zscore')" id="subbtn-zscore"
                  style="padding:8px 15px; background:none; border:none; cursor:pointer;">Z-Score Altman</button>
        </div>
        
        <div id="subtab-allerta-crisi">${typeof generaTabIndiciAllerta === 'function' ? generaTabIndiciAllerta(indiciPrev, indiciLast) : '<p>In sviluppo...</p>'}</div>
        <div id="subtab-dscr" style="display:none;">${typeof generaTabIndiciDSCR === 'function' ? generaTabIndiciDSCR(indiciPrev, indiciLast) : '<p>In sviluppo...</p>'}</div>
        <div id="subtab-zscore" style="display:none;">${typeof generaTabIndiciZScore === 'function' ? generaTabIndiciZScore(indiciPrev, indiciLast) : '<p>In sviluppo...</p>'}</div>
      </div>
    </div>
  `;

  modal.appendChild(container);
  document.body.appendChild(modal);
};

// =====================================================
// üß≠ RICONOSCIMENTO CATEGORIA ALLERTA DA CODICE ATECO
// =====================================================
window.getCategoriaAllertaDaAteco = function (codiceAteco) {
  if (!codiceAteco) return { categoria: "INDUSTRIA", soglie: soglieSettori.INDUSTRIA };

  // estrai le prime due cifre numeriche (es. "47.11.00" -> "47")
  const prefix = codiceAteco.toString().trim().substring(0, 2).replace(/\D/g, "");

  // === Tabella soglie settoriali ===
  const soglieSettori = {
    AGRICOLTURA:       { oneriRic: 2.8, patrDeb: 9.4, attBreve: 92.1, cashflow: 0.3, indebitam: 5.6 },
    INDUSTRIA:         { oneriRic: 3.0, patrDeb: 7.6, attBreve: 93.7, cashflow: 0.5, indebitam: 4.9 },
    SERV_UTILITA:      { oneriRic: 2.6, patrDeb: 6.7, attBreve: 84.2, cashflow: 1.9, indebitam: 6.5 },
    COSTRUZ_EDIFICI:   { oneriRic: 3.8, patrDeb: 4.9, attBreve:108.0, cashflow: 0.4, indebitam: 3.8 },
    COSTRUZ_ING_SPEC:  { oneriRic: 2.8, patrDeb: 5.3, attBreve:101.1, cashflow: 1.4, indebitam: 5.3 },
    COMM_INGROSSO:     { oneriRic: 2.1, patrDeb: 6.3, attBreve:101.4, cashflow: 0.6, indebitam: 2.9 },
    COMM_DETTAGLIO:    { oneriRic: 1.5, patrDeb: 4.2, attBreve: 89.8, cashflow: 1.0, indebitam: 7.8 },
    TRASPORTI_HOTEL:   { oneriRic: 1.5, patrDeb: 4.1, attBreve: 86.0, cashflow: 1.4, indebitam:10.2 },
    SERV_IMPRESE:      { oneriRic: 1.8, patrDeb: 5.2, attBreve: 95.4, cashflow: 1.7, indebitam:11.9 },
    SERV_PERSONE:      { oneriRic: 2.7, patrDeb: 2.3, attBreve: 69.8, cashflow: 0.5, indebitam:14.6 }
  };

  // === Mappatura ATECO ‚Üí Categoria ===
  const mapping = [
    { prefix: ["01","02","03"], cat: "AGRICOLTURA" },
    { prefix: ["05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","35"], cat: "INDUSTRIA" },
    { prefix: ["36","37","38","39"], cat: "SERV_UTILITA" },
    { prefix: ["41"], cat: "COSTRUZ_EDIFICI" },
    { prefix: ["42","43"], cat: "COSTRUZ_ING_SPEC" },
    { prefix: ["45","46"], cat: "COMM_INGROSSO" },
    { prefix: ["47","56"], cat: "COMM_DETTAGLIO" },
    { prefix: ["49","50","51","52","53","55"], cat: "TRASPORTI_HOTEL" },
    { prefix: ["58","59","60","61","62","63","64","65","66","68","69","70","71","72","73","74","75","77","78","79","80","81","82"], cat: "SERV_IMPRESE" },
    { prefix: ["84","85","86","87","88","90","91","92","93","94","95","96"], cat: "SERV_PERSONE" }
  ];

  let categoria = "INDUSTRIA";
  for (const m of mapping) {
    if (m.prefix.includes(prefix)) {
      categoria = m.cat;
      break;
    }
  }

  return { categoria, soglie: soglieSettori[categoria] };
};

// =====================================================
// ‚ö†Ô∏è GENERA TAB INDICI ALLERTA CRISI (settoriale)
// =====================================================
window.generaTabIndiciAllerta = function (prev, last) {
  try {
    const ce = extractStandardizedCE?.() || {};
    const sp = extractStandardizedSP?.() || {};

    // Recupera codice ATECO e settore
    const ateco = (state?.codiceAteco || "").toString();
    const info = getCategoriaAllertaDaAteco(ateco);
    const s = info.soglie || {};

    // Calcoli base
    const parseNum = v => parseFloat(String(v).replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",",".") || 0);
    const toPct = v => isFinite(v) ? v.toLocaleString("it-IT",{minimumFractionDigits:1,maximumFractionDigits:1}) + "%" : "‚Äî";

    const totDebiti = (sp.debitiEntro12 || 0) + (sp.debitiOltre12 || 0);
    const debTribPrev = (sp.debitiTribPrev || 0);
    const cashFlow = (ce.utileEsercizio || 0) + (ce.ammortamenti || 0);

    // Indicatori
    const indici = {
      oneriRic: ce.ricaviVendite > 0 ? (ce.oneriFinanziari / ce.ricaviVendite) * 100 : 0,
      patrDeb: totDebiti > 0 ? (sp.patrimonioNetto / totDebiti) * 100 : 0,
      attBreve: sp.debitiEntro12 > 0 ? (sp.attivoCircolante / sp.debitiEntro12) * 100 : 0,
      cashflow: sp.totaleAttivo > 0 ? (cashFlow / sp.totaleAttivo) * 100 : 0,
      indebitam: sp.totaleAttivo > 0 ? (debTribPrev / sp.totaleAttivo) * 100 : 0
    };

    // Valutazione rispetto alle soglie
    const valuta = (val, soglia, tipo = "min") => {
      if (!soglia) return "‚ö™";
      if (tipo === "max") {
        if (val <= soglia) return "‚úÖ";
        if (val <= soglia * 1.2) return "‚ö†Ô∏è";
        return "‚ùå";
      } else {
        if (val >= soglia) return "‚úÖ";
        if (val >= soglia * 0.9) return "‚ö†Ô∏è";
        return "‚ùå";
      }
    };

    // Costruzione tabella
    let html = `
      <h3 style="color:#b45309;">‚ö†Ô∏è Indici di Allerta ‚Äì Settore ${info.categoria.replace("_"," ")}</h3>
      <table style="width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;">
        <thead style="background:#fff7ed;color:#1f2937;">
          <tr>
            <th style="padding:8px;text-align:left;">Indicatore</th>
            <th style="padding:8px;text-align:right;">Valore Impresa</th>
            <th style="padding:8px;text-align:right;">Soglia Settore</th>
            <th style="padding:8px;text-align:center;">Esito</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Oneri Finanziari / Ricavi</td><td style="text-align:right;">${toPct(indici.oneriRic)}</td><td style="text-align:right;">‚â§ ${s.oneriRic}%</td><td style="text-align:center;">${valuta(indici.oneriRic, s.oneriRic, "max")}</td></tr>
          <tr style="background:#fafafa;"><td>Patrimonio Netto / Debiti Totali</td><td style="text-align:right;">${toPct(indici.patrDeb)}</td><td style="text-align:right;">‚â• ${s.patrDeb}%</td><td style="text-align:center;">${valuta(indici.patrDeb, s.patrDeb, "min")}</td></tr>
          <tr><td>Attivit√† a Breve / Passivit√† a Breve</td><td style="text-align:right;">${toPct(indici.attBreve)}</td><td style="text-align:right;">‚â• ${s.attBreve}%</td><td style="text-align:center;">${valuta(indici.attBreve, s.attBreve, "min")}</td></tr>
          <tr style="background:#fafafa;"><td>Cash Flow / Totale Attivo</td><td style="text-align:right;">${toPct(indici.cashflow)}</td><td style="text-align:right;">‚â• ${s.cashflow}%</td><td style="text-align:center;">${valuta(indici.cashflow, s.cashflow, "min")}</td></tr>
          <tr><td>Debiti Tributari e Previdenziali / Totale Attivo</td><td style="text-align:right;">${toPct(indici.indebitam)}</td><td style="text-align:right;">‚â§ ${s.indebitam}%</td><td style="text-align:center;">${valuta(indici.indebitam, s.indebitam, "max")}</td></tr>
        </tbody>
      </table>
    `;

    // Conteggio risultati
    const esiti = Object.entries(indici).map(([k,v]) => {
      const tipo = (["oneriRic","indebitam"].includes(k) ? "max" : "min");
      return valuta(v, s[k], tipo);
    });

    const ok = esiti.filter(e => e === "‚úÖ").length;
    const warn = esiti.filter(e => e === "‚ö†Ô∏è").length;
    const bad = esiti.filter(e => e === "‚ùå").length;

    html += `
      <div style="margin-top:15px;padding:10px;border-radius:8px;background:${bad>2?"#fee2e2":warn>2?"#fff7ed":"#ecfdf5"};">
        <strong>Risultato complessivo:</strong><br>
        ${ok} indicatori nella norma ‚Ä¢ ${warn} in attenzione ‚Ä¢ ${bad} critici<br>
        <span style="font-size:12px;color:#444;">
          Settore di riferimento: <b>${info.categoria}</b> ‚Ä¢ Codice ATECO: <b>${ateco}</b>
        </span>
      </div>
    `;

    return html;
  } catch (err) {
    console.error("Errore generaTabIndiciAllerta:", err);
    return `<p style="color:#dc2626;">Errore nel calcolo degli indici di allerta.</p>`;
  }
};



// =====================================================
// ‚öôÔ∏è WRAPPER ALLERTA CRISI - DSCR (uso unificato)
// =====================================================
window.generaTabIndiciDSCR = function () {
  try {
    const dscr = calcolaDSCRCompleto();
    return `
      <h3 style="color:#b45309;">üßÆ DSCR - Debt Service Coverage Ratio</h3>
      <div style="margin-bottom:10px;color:#555;font-size:13px;">
        Misura la capacit√† dell‚Äôimpresa di coprire il servizio del debito con i flussi di cassa generati.
      </div>
      ${generaTabDSCR(dscr)}
    `;
  } catch (err) {
    console.error("Errore generaTabIndiciDSCR:", err);
    return "<p style='color:#dc2626;'>Errore nel calcolo DSCR.</p>";
  }
};

// =====================================================
// üìâ Z-SCORE ALTMAN ‚Äì ANALISI COMPLETA DUE ANNI (2025)
// =====================================================
window.generaTabIndiciZScore = function () {
  try {
    if (typeof calcolaZScoreCompleto !== "function") {
      return `<p style="color:#dc2626;">‚ùå Funzione calcolaZScoreCompleto mancante.</p>`;
    }

    const z = calcolaZScoreCompleto();
    const dscr = typeof calcolaDSCRCompleto === "function" ? calcolaDSCRCompleto() : {};
    const indiciPrev = window.calcolaIndiciComplessiviPrev?.() || {};
    const indiciLast = window.calcolaIndiciComplessivi?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Formattazione e funzioni base ===
    const fmt = v => isFinite(v) ? parseFloat(v).toFixed(2).replace(".", ",") : "‚Äî";
    const colorZona = v => (v < 1.23 ? "#dc2626" : v < 3.00 ? "#f59e0b" : "#16a34a");
    const txtZona = v => (v < 1.23 ? "‚ùå Zona Rischio" : v < 3.00 ? "‚ö†Ô∏è Zona Grigia" : "‚úÖ Zona Sana");

    const prev = z.prev || {};
    const last = z.last || {};

    const roiPrev = indiciPrev?.ROI || 0;
    const levPrev = indiciPrev?.leverage || 0;
    const dsPrev = dscr?.prev?.ratio || 0;

    const roiLast = indiciLast?.ROI || 0;
    const levLast = indiciLast?.leverage || 0;
    const dsLast = dscr?.last?.ratio || 0;

    const deltaZ = last.score - prev.score;
    const arrow = deltaZ > 0 ? "üìà" : deltaZ < 0 ? "üìâ" : "‚è∏Ô∏è";
    const deltaColor = deltaZ > 0 ? "#16a34a" : deltaZ < 0 ? "#dc2626" : "#6b7280";

    // === Card compatte con X1‚ÄìX5 ===
    let html = `
      <h3 style="color:#003d82;margin-bottom:6px;">üìâ Z-Score Altman ‚Äì Analisi Predittiva Insolvenza</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin:8px 0;">
        ${[prev, last].map((a,i)=>`
        <div style="border:${i?2:1}px solid #003d82;
                    border-radius:8px;
                    padding:8px 10px;
                    background:${a.score>=3?"#ecfdf5":a.score<1.23?"#fef2f2":"#fff7ed"};
                    box-shadow:0 1px 3px rgba(0,0,0,0.05);">
          <div style="font-size:13px;font-weight:600;text-align:center;color:#003d82;margin-bottom:2px;">
            ${a.anno}
          </div>
          <div style="font-size:26px;font-weight:800;text-align:center;
                      color:${colorZona(a.score)};line-height:1;">
            ${fmt(a.score)}
          </div>
          <div style="font-size:12px;text-align:center;margin-bottom:5px;
                      color:${colorZona(a.score)};font-weight:600;">
            ${txtZona(a.score)}
          </div>
          <table style="width:100%;font-size:11.5px;line-height:1.3;border-collapse:collapse;">
            <thead>
              <tr style="background:#e8f0fe;color:#1e3a8a;">
                <th style="text-align:left;padding:3px;">Codice</th>
                <th style="text-align:left;padding:3px;">Descrizione</th>
                <th style="text-align:right;padding:3px;">Valore</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><b>X1</b></td><td>Cap. circ. netto / Tot. attivo</td><td style="text-align:right;">${fmt(a.X1)}</td></tr>
              <tr><td><b>X2</b></td><td>Riserve / Tot. attivo</td><td style="text-align:right;">${fmt(a.X2)}</td></tr>
              <tr><td><b>X3</b></td><td>EBIT / Tot. attivo</td><td style="text-align:right;">${fmt(a.X3)}</td></tr>
              <tr><td><b>X4</b></td><td>Patr. netto / Debiti</td><td style="text-align:right;">${fmt(a.X4)}</td></tr>
              <tr><td><b>X5</b></td><td>Ricavi / Tot. attivo</td><td style="text-align:right;">${fmt(a.X5)}</td></tr>
            </tbody>
          </table>
        </div>`).join("")}
      </div>
    `;

    // === Barre affiancate con freccia e delta ===
    const scale = v => Math.max(0, Math.min((v / 3.5) * 100, 100));
    html += `
      <div style="display:grid;grid-template-columns:1fr 60px 1fr;align-items:center;gap:6px;margin:10px 0;">
        <!-- Anno precedente -->
        <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;">
          <div style="font-size:12px;color:#003d82;text-align:center;margin-bottom:2px;">
            ${anni.prev} ‚Äì Z ${fmt(prev.score)}
          </div>
          <div style="background:#e5e7eb;border-radius:6px;height:12px;width:100%;overflow:hidden;">
            <div style="width:${scale(prev.score)}%;background:${colorZona(prev.score)};height:12px;border-radius:6px;"></div>
          </div>
        </div>

        <!-- Freccia centrale -->
        <div style="text-align:center;">
          <div style="font-size:22px;line-height:1;color:${deltaColor};font-weight:700;">${arrow}</div>
          <div style="font-size:11px;color:${deltaColor};">${deltaZ > 0 ? "+" : ""}${fmt(deltaZ)}</div>
        </div>

        <!-- Anno corrente -->
        <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;">
          <div style="font-size:12px;color:#003d82;text-align:center;margin-bottom:2px;">
            ${anni.last} ‚Äì Z ${fmt(last.score)}
          </div>
          <div style="background:#e5e7eb;border-radius:6px;height:12px;width:100%;overflow:hidden;">
            <div style="width:${scale(last.score)}%;background:${colorZona(last.score)};height:12px;border-radius:6px;"></div>
          </div>
        </div>
      </div>
    `;

    // === Analisi e giudizio per ogni anno ===
    const analisi = (anno, zVal, ds, roi, lev) => {
      const zona = txtZona(zVal);
      const colore = colorZona(zVal);
      let testo = "";

      if (zVal < 1.23) {
        testo = `Il punteggio <b>${fmt(zVal)}</b> segnala <b>rischio elevato</b>. 
        DSCR ${ds.toFixed(2)}, ROI ${roi.toFixed(2)}% e Leverage ${lev.toFixed(2)}. 
        √à necessario agire su <b>flussi di cassa e indebitamento</b>.`;
      } else if (zVal < 3.00) {
        testo = `Il punteggio <b>${fmt(zVal)}</b> √® in <b>zona grigia</b>. 
        DSCR ${ds.toFixed(2)}, ROI ${roi.toFixed(2)}%, Leverage ${lev.toFixed(2)}. 
        <b>Monitorare</b> costantemente equilibrio economico e finanziario.`;
      } else {
        testo = `Il punteggio <b>${fmt(zVal)}</b> indica <b>azienda solida</b>. 
        DSCR ${ds.toFixed(2)}, ROI ${roi.toFixed(2)}%, Leverage ${lev.toFixed(2)}. 
        <b>Mantenere</b> gli attuali livelli di efficienza e redditivit√†.`;
      }

      return `
        <div style="background:${zVal>=3?"#ecfdf5":zVal<1.23?"#fef2f2":"#fff7ed"};
                    border-left:5px solid ${colore};
                    padding:8px 10px;
                    border-radius:6px;
                    margin-top:6px;
                    font-size:13px;
                    line-height:1.5;
                    color:${colore};">
          <strong>${anno} ‚Äì ${zona}</strong><br>${testo}
        </div>`;
    };

    html += `
      ${analisi(anni.prev, prev.score, dsPrev, roiPrev, levPrev)}
      ${analisi(anni.last, last.score, dsLast, roiLast, levLast)}

      <div style="margin-top:8px;font-size:12.5px;color:#374151;">
        <strong>Riferimenti Z-Score:</strong><br>
        <span style="color:#16a34a;">‚óè Z ‚â• 3,00</span> ‚Üí Impresa sana e solida<br>
        <span style="color:#f59e0b;">‚óè 1,23 ‚â§ Z &lt; 3,00</span> ‚Üí Zona grigia, rischio moderato<br>
        <span style="color:#dc2626;">‚óè Z &lt; 1,23</span> ‚Üí Elevata probabilit√† di insolvenza
      </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaTabIndiciZScore:", err);
    return `<p style="color:#dc2626;">Errore durante il calcolo Z-Score.</p>`;
  }
};

// =====================================================
// üìä DASHBOARD KPI COMPLETA ‚Äì Analisi Multi-Sezione 2025
// =====================================================
window.mostraDashboardKPI = function () {
if (window.SILENT_MODE) return; // üü¶ non mostrare la modale durante il salvataggio

  try {
    if (!state.spRows?.length || !state.ceRows?.length) {
      toast("‚ö†Ô∏è Prima importa un bilancio", true);
      return;
    }

    // === Calcolo dati di base ===
    const prev = calcolaIndiciComplessiviPrev();
    const last = calcolaIndiciComplessivi();
    const prod = calcolaIndiciProduttivitaEstesi();
    const prodPrev = prod.prev || {};
    const prodLast = prod.last || {};
    const dscr = calcolaDSCRCompleto?.() || {};
    const zscore = calcolaZScoreCompleto?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Modale container ===
    const modal = document.createElement("div");
    modal.id = "modalDashboardKPI";
    modal.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,0.6);
      z-index:10000; display:flex; align-items:center; justify-content:center;`;

    const container = document.createElement("div");
    container.style.cssText = `
      background:#fff; width:95%; max-width:1400px; height:90vh;
      border-radius:12px; display:flex; flex-direction:column;
      overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.25);`;

    // === HEADER ===
    container.innerHTML = `
      <div style="background:#003d82;padding:15px 20px;
                  display:flex;justify-content:space-between;align-items:center;">
        <h2 style="color:white;margin:0;">üìä Dashboard KPI ‚Äì Analisi Gestionale ${anni.prev} ‚Üí ${anni.last}</h2>
        <button onclick="document.getElementById('modalDashboardKPI').remove()"
                style="background:#dc2626;color:white;border:none;
                       padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;">
          Chiudi ‚úñ
        </button>
      </div>

      <div style="padding:25px;">

        <!-- üü¢ ECONOMICI -->
        <h3 style="color:#003d82;">üìà Indici Economici</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;">
          ${generaCardKPI("ROE", last.ROE, prev.ROE, "%", 5, 10)}
          ${generaCardKPI("ROI", last.ROI, prev.ROI, "%", 8, 12)}
          ${generaCardKPI("ROS", last.ROS, prev.ROS, "%", 5, 8)}
          ${generaCardKPI("ROA", last.ROA, prev.ROA, "%", 3, 5)}
          ${generaCardKPI("ROCE", last.ROCE, prev.ROCE, "%", 8, 12)}
        </div>
        ${analisiSezione("economici", last)}

        <hr style="margin:25px 0;">

        <!-- üíß FINANZIARI -->
        <h3 style="color:#003d82;">üíß Indici Finanziari</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;">
          ${generaCardKPI("Current Ratio", last.currentRatio, prev.currentRatio, "", 1.2, 1.5)}
          ${generaCardKPI("Quick Ratio", last.quickRatio, prev.quickRatio, "", 1.0, 1.3)}
          ${generaCardKPI("Cash Ratio", last.cashRatio, prev.cashRatio, "", 0.2, 0.4)}
          ${generaCardKPI("Interest Coverage Ratio", last.interestCoverageRatio, prev.interestCoverageRatio, "", 3, 6)}
        </div>
        ${analisiSezione("finanziari", last)}

        <hr style="margin:25px 0;">

        <!-- üèõÔ∏è PATRIMONIALI -->
        <h3 style="color:#003d82;">üèõÔ∏è Indici Patrimoniali</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;">
          ${generaCardKPI("Leverage", last.leverage, prev.leverage, "", 2, 2.5)}
          ${generaCardKPI("Debt/Equity Ratio", last.debtEquityRatio, prev.debtEquityRatio, "", 1, 1.5)}
          ${generaCardKPI("Equity Ratio", last.equityRatio, prev.equityRatio, "%", 33, 50)}
        </div>
        ${analisiSezione("patrimoniali", last)}

        <hr style="margin:25px 0;">

        <!-- ‚öôÔ∏è PRODUTTIVIT√Ä -->
        <h3 style="color:#003d82;">‚öôÔ∏è Indici di Produttivit√†</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;">
          ${generaCardKPI("Ricavi per Dipendente", prodLast.ricaviPerDip, prodPrev.ricaviPerDip, "‚Ç¨", 60000, 90000)}
          ${generaCardKPI("Ricavi per Amm.", prodLast.ricaviPerAmm, prodPrev.ricaviPerAmm, "‚Ç¨", 200000, 500000)}
          ${generaCardKPI("Costo Medio per Addetto", prodLast.costoMedioDip, prodPrev.costoMedioDip, "‚Ç¨", 25000, 45000)}
          ${generaCardKPI("Rotazione Capitale Investito", last.rotazioneCapitaleInvestito, prev.rotazioneCapitaleInvestito, "", 1, 1.5)}
          ${generaCardKPI("Giorni Crediti (DSO)", last.giorniCrediti, prev.giorniCrediti, "gg", 60, 90)}
          ${generaCardKPI("Giorni Debiti (DPO)", last.giorniDebiti, prev.giorniDebiti, "gg", 60, 90)}
        </div>
        ${
          prodLast.addetti
            ? `<div style="margin-top:12px;font-size:13px;color:#374151;">
                üë• Dati rilevati: <b>${prodLast.addetti}</b> dipendenti, <b>${prodLast.numAmm}</b> amministratori.
                Costo personale: <b>${prodLast.costoTotale?.toLocaleString("it-IT")} ‚Ç¨</b>.
              </div>`
            : `<div style="margin-top:10px;padding:8px;background:#fff7ed;
                border-left:4px solid #f59e0b;font-size:13px;">
                ‚ö†Ô∏è Nessun dato sul personale o amministratori. Compila ‚Äúüìã Tabelle‚Äù per gli indici di produttivit√†.
              </div>`
        }
        ${analisiSezione("produttivita", prodLast)}

        <hr style="margin:25px 0;">

        <!-- ‚ö†Ô∏è CRISI E SOLIDIT√Ä -->
        <h3 style="color:#b45309;">‚ö†Ô∏è Allerta Crisi e Solidit√†</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;">
          ${generaCardKPI("DSCR", dscr?.last?.ratio ?? 0, dscr?.prev?.ratio ?? 0, "", 1.0, 1.25)}
          ${generaCardKPI("Z-Score Altman", zscore?.last?.score ?? 0, zscore?.prev?.score ?? 0, "", 1.23, 3.0)}
        </div>
        ${analisiSezione("crisi", { DSCR: dscr?.last?.ratio, ZScore: zscore?.last?.score })}

        <hr style="margin:25px 0;">

        <!-- üß≠ INDICE GLOBALE -->
        <div id="indiceGlobaleBox"></div>
      </div>`;

    modal.appendChild(container);
    document.body.appendChild(modal);

    // === Calcolo e rendering Indice Globale ===
    const dati = {
      ROE: last.ROE || 0,
      currentRatio: last.currentRatio || 0,
      leverage: last.leverage || 0,
      ricaviPerDip: prodLast.ricaviPerDip || 0,
      DSCR: dscr?.last?.ratio || 0,
    };

    const score = window.calcolaIndiceGlobaleSalute(dati);
    const colore =
      score >= 8 ? "#16a34a" : score >= 6 ? "#facc15" : score >= 4 ? "#f59e0b" : "#dc2626";
    const descr =
      score >= 8
        ? "Eccellente equilibrio gestionale"
        : score >= 6
        ? "Buon equilibrio con margini di miglioramento"
        : score >= 4
        ? "Situazione fragile, serve attenzione"
        : "Area di rischio finanziario";

    document.getElementById("indiceGlobaleBox").innerHTML = `
      <div style="background:${colore}1a;padding:15px;border-radius:8px;border-left:6px solid ${colore};">
        <h3 style="margin:0;color:${colore};font-size:18px;">üß≠ Indice Globale di Salute Aziendale</h3>
        <div style="font-size:28px;font-weight:800;color:${colore};margin-top:6px;">${score}/10</div>
        <div style="font-size:13px;color:#374151;margin-top:6px;">${descr}</div>
      </div>`;
  } catch (err) {
    console.error("‚ùå Errore mostraDashboardKPI:", err);
    toast("Errore apertura Dashboard KPI", true);
  }
};

// =====================================================
// üß≠ INDICE GLOBALE DI SALUTE AZIENDALE (1‚Äì10)
// =====================================================
window.calcolaIndiceGlobaleSalute = function (dati) {
  try {
    const safe = v => (isFinite(v) ? +v : 0);
    const prev = safe(dati?.prevScore || 0);
    const last = safe(dati?.lastScore || 0);

    // componenti principali con pesi percentuali
    const pesi = {
      reddit: 0.25, // redditivit√† (ROE/ROI)
      liquid: 0.20, // liquidit√† (Current Ratio)
      solid: 0.20,  // solidit√† patrimoniale (Leverage)
      prod: 0.20,   // produttivit√† (ricavi per dipendente)
      crisi: 0.15   // rischio (DSCR/Z-score)
    };

    const norm = (val, min, max) => Math.max(0, Math.min((val - min) / (max - min), 1));

    // punteggi parziali 0‚Äì10
    const scoreROE = norm(dati.ROE, 0, 15) * 10 * pesi.reddit;
    const scoreCurrent = norm(dati.currentRatio, 0.8, 2.0) * 10 * pesi.liquid;
    const scoreLeverage = (1 - norm(dati.leverage, 1.0, 3.5)) * 10 * pesi.solid;
    const scoreRicaviDip = norm(dati.ricaviPerDip, 30000, 100000) * 10 * pesi.prod;
    const scoreDSCR = norm(dati.DSCR, 0.5, 2.0) * 10 * pesi.crisi;

    const punteggio = (scoreROE + scoreCurrent + scoreLeverage + scoreRicaviDip + scoreDSCR).toFixed(1);
    return Math.max(0, Math.min(punteggio, 10));
  } catch {
    return 0;
  }
};

// =====================================================
// üìä RENDER INDICE GLOBALE ALLA FINE DELLA DASHBOARD
// =====================================================
window.renderIndiceGlobaleSalute = function () {
  try {
    const dati = {
      ROE: window.last?.ROE || 0,
      currentRatio: window.last?.currentRatio || 0,
      leverage: window.last?.leverage || 0,
      ricaviPerDip: window.indiciProduttivitaEstesi?.last?.ricaviPerDip || 0,
      DSCR: window.lastDSCR?.last?.ratio || 0
    };
    const score = window.calcolaIndiceGlobaleSalute(dati);
    const colore = score >= 8 ? "#16a34a" : score >= 6 ? "#facc15" : score >= 4 ? "#f59e0b" : "#dc2626";
    const descr = score >= 8 ? "Eccellente equilibrio gestionale"
      : score >= 6 ? "Buon equilibrio con margini di miglioramento"
      : score >= 4 ? "Situazione fragile, serve attenzione"
      : "Area di rischio finanziario";

    const box = document.createElement("div");
    box.innerHTML = `
      <hr style="margin:25px 0;">
      <div style="background:${colore}1a;padding:15px;border-radius:8px;border-left:6px solid ${colore};">
        <h3 style="margin:0;color:${colore};font-size:18px;">üß≠ Indice Globale di Salute Aziendale</h3>
        <div style="font-size:28px;font-weight:800;color:${colore};margin-top:6px;">${score}/10</div>
        <div style="font-size:13px;color:#374151;margin-top:6px;">${descr}</div>
      </div>
    `;
    document.querySelector("#modalDashboardKPI .padding")?.appendChild(box);
    console.log("‚úÖ Indice Globale di Salute:", score);
  } catch (err) {
    console.warn("‚ö†Ô∏è Impossibile calcolare indice globale:", err);
  }
};

// =====================================================
// üìä DASHBOARD KPI GRAFICA ‚Äì LAYOUT COMPATTO 3√ó2 (2025)
// =====================================================
window.mostraGraficiKPI = function () {
  try {
    if (!state.spRows?.length || !state.ceRows?.length) {
      toast("‚ö†Ô∏è Prima importa un bilancio", true);
      return;
    }

    const prev = calcolaIndiciComplessiviPrev();
    const last = calcolaIndiciComplessivi();
    const prod = calcolaIndiciProduttivitaEstesi();
    const dscr = calcolaDSCRCompleto?.() || {};
    const zscore = calcolaZScoreCompleto?.() || {};
    const ce = extractStandardizedCE?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    const fmtMln = v => isFinite(v) ? (v / 1_000_000).toFixed(1) + " M‚Ç¨" : "‚Äî";

    // === MODALE ===
    const modal = document.createElement("div");
    modal.id = "modalGraficiKPI";
    modal.style.cssText = `
      position:fixed;inset:0;background:rgba(0,0,0,0.7);
      z-index:10000;display:flex;align-items:center;justify-content:center;`;

    const container = document.createElement("div");
    container.style.cssText = `
      background:#fff;width:95%;max-width:1500px;height:90vh;
      border-radius:12px;overflow-y:auto;padding:25px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);`;

    container.innerHTML = `
      <div style="background:#003d82;color:#fff;padding:14px 20px;
                  margin:-25px -25px 25px -25px;border-radius:12px 12px 0 0;
                  display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">üìà Dashboard Grafica KPI ‚Äì ${anni.prev} ‚Üí ${anni.last}</h2>
        <button onclick="document.getElementById('modalGraficiKPI').remove()"
                style="background:#dc2626;color:#fff;border:none;padding:8px 16px;
                       border-radius:6px;cursor:pointer;">Chiudi ‚úñ</button>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));
                  gap:25px;align-items:start;justify-items:center;">
        <div class="grafico-card"><canvas id="chart-economici" height="230"></canvas><p id="comment-economici"></p></div>
        <div class="grafico-card"><canvas id="chart-finanziari" height="230"></canvas><p id="comment-finanziari"></p></div>
        <div class="grafico-card"><canvas id="chart-patrimoniali" height="230"></canvas><p id="comment-patrimoniali"></p></div>
        <div class="grafico-card"><canvas id="chart-produttivita" height="230"></canvas><p id="comment-produttivita"></p></div>
        <div class="grafico-card"><canvas id="chart-solidita" height="230"></canvas><p id="comment-solidita"></p></div>
        <div class="grafico-card" style="grid-column:1 / -1;text-align:center;">
          <canvas id="chart-radar" height="260" style="max-width:600px;"></canvas>
          <p id="comment-radar"></p>
        </div>
      </div>
    `;

    modal.appendChild(container);
    document.body.appendChild(modal);

    if (typeof Chart === "undefined") {
      console.error("Chart.js mancante");
      return;
    }

    // === Funzione helper per barre doppie ===
    const makeBar = (id, labels, prevData, lastData, titolo, commento) => {
      new Chart(document.getElementById(id), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: anni.prev, data: prevData, backgroundColor: "rgba(59,130,246,0.7)" },
            { label: anni.last, data: lastData, backgroundColor: "rgba(249,115,22,0.8)" }
          ]
        },
        options: { plugins:{ title:{display:true,text:titolo} }, scales:{y:{beginAtZero:true}}, responsive:true }
      });
      document.getElementById("comment-" + id.split("-")[1]).innerHTML = commento;
    };

    // === 1Ô∏è‚É£ ECONOMICI ===
    makeBar("chart-economici",
      ["ROE","ROI","ROS","ROA","ROCE"],
      [prev.ROE,prev.ROI,prev.ROS,prev.ROA,prev.ROCE],
      [last.ROE,last.ROI,last.ROS,last.ROA,last.ROCE],
      "Indici di Redditivit√†",
      "üíπ Miglioramento della redditivit√† complessiva rispetto all‚Äôanno precedente.");

    // === 2Ô∏è‚É£ FINANZIARI ===
    makeBar("chart-finanziari",
      ["Current","Quick","Cash","Interest Cov."],
      [prev.currentRatio,prev.quickRatio,prev.cashRatio,prev.interestCoverageRatio],
      [last.currentRatio,last.quickRatio,last.cashRatio,last.interestCoverageRatio],
      "Indici di Liquidit√† e Copertura",
      "üíß Indicatori di liquidit√† in linea con gli standard di solidit√† aziendale.");

    // === 3Ô∏è‚É£ PATRIMONIALI ===
    makeBar("chart-patrimoniali",
      ["Leverage","Debt/Equity","Equity Ratio"],
      [prev.leverage,prev.debtEquityRatio,prev.equityRatio],
      [last.leverage,last.debtEquityRatio,last.equityRatio],
      "Indici di Solidit√† Patrimoniale",
      "üèõÔ∏è Struttura patrimoniale stabile e ben capitalizzata.");

    // === 4Ô∏è‚É£ PRODUTTIVIT√Ä ===
    makeBar("chart-produttivita",
      ["Ricavi/Dip.","Ricavi/Amm.","Costo Medio Dip."],
      [prod.prev?.ricaviPerDip||0,prod.prev?.ricaviPerAmm||0,prod.prev?.costoMedioDip||0],
      [prod.last?.ricaviPerDip||0,prod.last?.ricaviPerAmm||0,prod.last?.costoMedioDip||0],
      "Indici di Produttivit√†",
      "‚öôÔ∏è Buona efficienza del personale e utilizzo equilibrato delle risorse.");

    // === 5Ô∏è‚É£ SOLIDIT√Ä ===
    makeBar("chart-solidita",
      ["DSCR","Z-Score"],
      [dscr?.prev?.ratio||0,zscore?.prev?.score||0],
      [dscr?.last?.ratio||0,zscore?.last?.score||0],
      "Indicatori di Solidit√† e Rischio",
      "‚ö†Ô∏è L‚Äôimpresa mantiene un livello di rischio contenuto e adeguata capacit√† di rimborso.");

    // === 6Ô∏è‚É£ RADAR KPI GLOBALE ===
    const radar = document.getElementById("chart-radar");
    const datiRadar = {
      Redditivit√†: Math.min((last.ROE || 0) * 4, 100),
      Liquidit√†: Math.min((last.currentRatio || 0) * 25, 100),
      Solidit√†: Math.max(0, 100 - (last.leverage || 0) * 15),
      Produttivit√†: Math.min((prod.last?.ricaviPerDip || 0) / 1000, 100),
      Rischio: Math.min((zscore.last?.score || 0) * 20, 100)
    };
    const valori = Object.values(datiRadar);
    new Chart(radar, {
      type: "radar",
      data: {
        labels: Object.keys(datiRadar),
        datasets: [{
          label: anni.last,
          data: valori,
          backgroundColor: "rgba(22,163,74,0.25)",
          borderColor: "#16a34a",
          pointBackgroundColor: "#16a34a"
        }]
      },
      options: { scales:{r:{beginAtZero:true,max:100,ticks:{stepSize:20}}},
                 plugins:{legend:{display:false},title:{display:true,text:"Indice Globale di Salute Aziendale"}} }
    });
    const media = (valori.reduce((a,b)=>a+b,0)/valori.length).toFixed(1);
    const valutazione = media>75?"üü¢ Profilo solido e bilanciato":
                       media>50?"üü° Equilibrio parziale":
                       media>30?"‚ö†Ô∏è Area di attenzione":"üî¥ Rischio elevato";
    document.getElementById("comment-radar").innerHTML =
      `üß≠ L‚Äôindice radar mostra ${valutazione} (punteggio medio ${media}/100).`;

  } catch(err){
    console.error("‚ùå Errore mostraGraficiKPI:", err);
    toast("Errore apertura dashboard grafici KPI", true);
  }
};


// =====================================================
// üß© ANALISI AUTOMATICA PER SEZIONE KPI
// =====================================================
function analisiSezione(tipo, dati) {
  try {
    let testo = "";
    let colore = "#374151"; // testo neutro

    switch (tipo) {
      // === ECONOMICI ===
      case "economici":
        if (dati.ROE >= 10 && dati.ROI >= 8 && dati.ROS >= 8) {
          testo = "üü¢ Ottima redditivit√† generale. L‚Äôimpresa mostra elevata efficienza nella gestione del capitale e dei margini.";
          colore = "#16a34a";
        } else if (dati.ROE >= 5 || dati.ROI >= 5) {
          testo = "üü° Redditivit√† adeguata ma migliorabile. Potenziare i margini operativi e il controllo dei costi.";
          colore = "#eab308";
        } else {
          testo = "üî¥ Redditivit√† insufficiente. √à necessario rivedere struttura dei costi e strategie di pricing.";
          colore = "#dc2626";
        }
        break;

      // === FINANZIARI ===
      case "finanziari":
        if (dati.currentRatio >= 1.5 && dati.quickRatio >= 1 && dati.cashRatio >= 0.2) {
          testo = "üü¢ Solida liquidit√† e buona capacit√† di far fronte agli impegni a breve termine.";
          colore = "#16a34a";
        } else if (dati.currentRatio >= 1.2 || dati.quickRatio >= 0.8) {
          testo = "üü° Equilibrio finanziario discreto, ma la liquidit√† va monitorata con attenzione.";
          colore = "#eab308";
        } else {
          testo = "üî¥ Possibile tensione finanziaria: liquidit√† insufficiente o eccessivo peso del circolante.";
          colore = "#dc2626";
        }
        break;

      // === PATRIMONIALI ===
      case "patrimoniali":
        if (dati.leverage <= 2 && dati.equityRatio >= 33) {
          testo = "üü¢ Buona solidit√† patrimoniale e struttura finanziaria equilibrata.";
          colore = "#16a34a";
        } else if (dati.leverage <= 3 && dati.equityRatio >= 25) {
          testo = "üü° Struttura patrimoniale in equilibrio precario. Crescente dipendenza da fonti esterne.";
          colore = "#eab308";
        } else {
          testo = "üî¥ Eccessiva leva finanziaria e basso capitale proprio. Rischio di instabilit√† patrimoniale.";
          colore = "#dc2626";
        }
        break;

      // === PRODUTTIVIT√Ä ===
      case "produttivita":
        if (dati.ricaviPerDip >= 60000 && dati.ricaviPerAmm >= 200000) {
          testo = "üü¢ Alta produttivit√† del personale e buona efficienza organizzativa.";
          colore = "#16a34a";
        } else if (dati.ricaviPerDip > 0) {
          testo = "üü° Produttivit√† discreta ma migliorabile. Verificare il rapporto tra costi e valore aggiunto.";
          colore = "#eab308";
        } else {
          testo = "‚ö†Ô∏è Dati sul personale non disponibili o incompleti. Inserire i valori per un‚Äôanalisi accurata.";
          colore = "#f59e0b";
        }
        break;

      // === ALLERTA CRISI / DSCR / Z-SCORE ===
      case "crisi":
        if ((dati.DSCR ?? 0) >= 1.25 && (dati.ZScore ?? 0) >= 3) {
          testo = "üü¢ Ottima solidit√† economico-finanziaria. L‚Äôimpresa genera cassa sufficiente e presenta basso rischio di insolvenza.";
          colore = "#16a34a";
        } else if ((dati.DSCR ?? 0) >= 1.0 || (dati.ZScore ?? 0) >= 2) {
          testo = "üü° Equilibrio finanziario accettabile ma da monitorare nel tempo.";
          colore = "#eab308";
        } else {
          testo = "üî¥ Indicatori di allerta negativi. Possibili tensioni finanziarie o rischio di insolvenza.";
          colore = "#dc2626";
        }
        break;

      default:
        testo = "‚ÑπÔ∏è Nessuna analisi disponibile per questa sezione.";
    }

    return `
      <div style="margin-top:10px;padding:10px 14px;border-left:5px solid ${colore};
                  background:#f9fafb;border-radius:6px;font-size:13px;color:${colore};
                  line-height:1.5;">
        ${testo}
      </div>
    `;
  } catch (err) {
    console.error("Errore analisiSezione:", err);
    return "";
  }
}

// =====================================================
// üß≠ ANALISI COMPLESSIVA KPI ‚Äì VALUTAZIONE GESTIONALE
// =====================================================
function analisiComplessiva(last, dscr, zscore) {
  try {
    const ds = dscr?.last?.ratio ?? 0;
    const zs = zscore?.last?.score ?? 0;

    // === 1Ô∏è‚É£ Raccolta indici base ===
    const roe = last.ROE || 0;
    const roi = last.ROI || 0;
    const ros = last.ROS || 0;
    const lev = last.leverage || 0;
    const cr = last.currentRatio || 0;
    const eqr = last.equityRatio || 0;
    const ricDip = last.ricaviPerDip || 0;
    const cash = last.cashRatio || 0;

    // === 2Ô∏è‚É£ Valutazione sintetica ===
    let valutazione = "";
    if (roe >= 10 && roi >= 8 && cr >= 1.5 && lev <= 2 && ds >= 1.25 && zs >= 3) {
      valutazione = "üü¢ Impresa solida, in crescita e finanziariamente equilibrata. Ottima redditivit√† e sostenibilit√† del debito.";
    } else if (roe >= 5 && roi >= 5 && cr >= 1.2 && lev <= 3 && ds >= 1.0 && zs >= 1.8) {
      valutazione = "üü° Impresa stabile ma con aree di attenzione su margini o liquidit√†. Mantenere equilibrio operativo e monitorare la leva.";
    } else {
      valutazione = "üî¥ Struttura fragile o risultati in calo. Serve intervenire su redditivit√†, cassa e capitale proprio.";
    }

    // === 3Ô∏è‚É£ Analisi aree di forza e miglioramento ===
    const forza = [];
    const debolezze = [];

    if (roe >= 10) forza.push("Elevata redditivit√† del capitale proprio (ROE)");
    else debolezze.push("Redditivit√† inferiore agli standard");

    if (roi >= 8) forza.push("Buona efficienza dell‚Äôimpiego del capitale (ROI)");
    else debolezze.push("Rendimento operativo debole");

    if (cr >= 1.5) forza.push("Solida liquidit√† a breve termine");
    else debolezze.push("Liquidit√† da rafforzare");

    if (lev <= 2) forza.push("Struttura patrimoniale equilibrata");
    else debolezze.push("Eccessiva leva finanziaria");

    if (ds >= 1.25) forza.push("Ottima capacit√† di copertura del debito (DSCR)");
    else if (ds < 1) debolezze.push("DSCR inferiore a 1: rischio tensioni di cassa");

    if (zs >= 3) forza.push("Z-Score in zona sicura: bassa probabilit√† d‚Äôinsolvenza");
    else if (zs < 1.8) debolezze.push("Z-Score in area di rischio: vulnerabilit√† finanziaria");

    if (ricDip > 0) forza.push("Buona produttivit√† media per addetto");
    else debolezze.push("Dati sul personale non disponibili: produttivit√† non valutabile");

    // === 4Ô∏è‚É£ Rendering HTML ===
    return `
      <div style="padding:15px;border-radius:8px;background:#f9fafb;margin-top:15px;">
        <h3 style="color:#003d82;margin-top:0;">üìã Analisi complessiva</h3>
        <p style="font-size:14px;line-height:1.5;color:#111827;">${valutazione}</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px;">
          <div style="background:#ecfdf5;padding:15px;border-radius:6px;">
            <strong style="color:#16a34a;">‚úÖ Punti di Forza</strong>
            <ul style="margin:8px 0 0 18px;font-size:13px;color:#166534;list-style-type:'‚úîÔ∏è ';">
              ${forza.length ? forza.map(f => `<li>${f}</li>`).join("") : "<li>Nessuno evidenziato</li>"}
            </ul>
          </div>
          <div style="background:#fef2f2;padding:15px;border-radius:6px;">
            <strong style="color:#dc2626;">‚ö†Ô∏è Aree di Miglioramento</strong>
            <ul style="margin:8px 0 0 18px;font-size:13px;color:#7f1d1d;list-style-type:'‚ùå ';">
              ${debolezze.length ? debolezze.map(f => `<li>${f}</li>`).join("") : "<li>Nessuna criticit√† significativa</li>"}
            </ul>
          </div>
        </div>
      </div>
    `;
  } catch (err) {
    console.error("Errore analisiComplessiva:", err);
    return `<p style="color:#dc2626;">Errore nella generazione dell'analisi complessiva.</p>`;
  }
}

//=====================================================//
//üìä DASHBOARD GRAFICA KPI 2025 ‚Äì Versione definitiva //
//===================================================== //
window.mostraDashboardGraficaKPI = function() {
if (window.SILENT_MODE) return; // üü¶ non mostrare la modale durante il salvataggio

  try {
    if (!state.spRows?.length || !state.ceRows?.length) {
      toast("‚ö†Ô∏è Prima importa un bilancio", true);
      return;
    }

    const prev = window.calcolaIndiciComplessiviPrev?.() || {};
    const last = window.calcolaIndiciComplessivi?.() || {};
    const prod = window.calcolaIndiciProduttivitaEstesi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === CREA MODALE ===
    const modal = document.createElement("div");
    modal.id = "modalGraficiKPI";
    modal.innerHTML = `
      <style>
        .dash-modal{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;
          display:flex;align-items:center;justify-content:center;}
        .dash-box{background:#fff;width:95%;max-width:1500px;height:90vh;border-radius:14px;
          display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);}
        .dash-header{background:#003d82;color:#fff;padding:15px 20px;
          display:flex;justify-content:space-between;align-items:center;}
        .dash-tabs{display:flex;background:#f0f4f8;border-bottom:2px solid #003d82;}
        .dash-tab{flex:1;padding:12px;font-weight:600;cursor:pointer;
          border:none;background:#f0f4f8;transition:all .3s;}
        .dash-tab.active{background:#fff;border-bottom:3px solid #003d82;}
        .dash-content{flex:1;overflow-y:auto;padding:20px;background:#fff;}
        .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
          gap:25px;align-items:center;justify-content:center;margin-top:20px;}
        canvas{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;}
        .comment-box{margin-top:8px;padding:10px;border-left:4px solid #2563eb;
          background:#f9fafb;border-radius:6px;font-size:13px;color:#374151;}
      </style>
      <div class="dash-box">
        <div class="dash-header">
          <h2 style="margin:0;">üìä Dashboard Grafica KPI ‚Äì ${anni.prev} ‚Üí ${anni.last}</h2>
          <button onclick="document.getElementById('modalGraficiKPI').remove()"
            style="background:#dc2626;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Chiudi ‚úñ</button>
        </div>
        <div class="dash-tabs">
          ${["Economici","Finanziari","Patrimoniali","Produttivit√†","Solidit√†","Sintesi"]
            .map((t,i)=>`<button class="dash-tab ${i===0?"active":""}" onclick="showGraficoTab('${t.toLowerCase()}')">${t}</button>`).join("")}
        </div>
        <div class="dash-content" id="graficiContent">
          ${["economici","finanziari","patrimoniali","produttivita","solidita"].map((t,i)=>`
            <div id="section-${t}" style="${i===0?"":"display:none"};">
              <div class="chart-grid">
                <canvas id="chart-${t}-1" height="300"></canvas>
                <canvas id="chart-${t}-2" height="300"></canvas>
              </div>
              <div class="comment-box" id="comment-${t}"></div>
            </div>`).join("")}
          <div id="section-sintesi" style="display:none;">
            <h3 style="color:#003d82;text-align:center;margin-bottom:10px;">üß≠ Sintesi Globale KPI</h3>
            <div class="chart-grid">
              <canvas id="chart-radar" height="350"></canvas>
              <canvas id="chart-waterfall" height="350"></canvas>
              <canvas id="chart-trend" height="350"></canvas>
              <canvas id="chart-ciambella" height="350"></canvas>
            </div>
          </div>
        </div>
      </div>`;
    modal.className = "dash-modal";
    document.body.appendChild(modal);

    // === TABS SWITCH ===
    window.showGraficoTab = tab=>{
      document.querySelectorAll(".dash-tab").forEach(b=>{
        b.classList.remove("active");b.style.background="#f0f4f8";
      });
      document.querySelector(`.dash-tab[onclick*="${tab}"]`).classList.add("active");
      document.querySelectorAll("#graficiContent>div").forEach(s=>s.style.display="none");
      const sec=document.getElementById(`section-${tab}`);if(sec)sec.style.display="block";
    };

    // === GRAFICI ===
    setTimeout(()=>creaGraficiDashboardKPI(prev,last,prod,dscr,zscore,anni),300);
  } catch(e){
    console.error("Errore mostraDashboardGraficaKPI:",e);
    toast("Errore apertura Dashboard Grafica",true);
  }
};

// =====================================================
// üìä FUNZIONE GRAFICI COMPLETI KPI
// =====================================================
function creaGraficiDashboardKPI(prev,last,prod,dscr,zscore,anni){
  if(typeof Chart==="undefined"){alert("Chart.js mancante");return;}
  const color1="#3b82f6",color2="#f97316";
  const make=(id,labels,a,b,title)=>new Chart(document.getElementById(id),{
    type:"bar",data:{labels,datasets:[
      {label:anni.prev,data:a,backgroundColor:color1},
      {label:anni.last,data:b,backgroundColor:color2}]},
    options:{responsive:true,plugins:{legend:{position:"top"},title:{display:true,text:title}},
      scales:{y:{beginAtZero:true}}}});
  const comment=(id,text)=>{document.getElementById("comment-"+id).innerHTML=text;};

  make("chart-economici-1",["ROE","ROI","ROS"],[prev.ROE,prev.ROI,prev.ROS],[last.ROE,last.ROI,last.ROS],"Indici di Redditivit√†");
  make("chart-economici-2",["ROA","ROCE"],[prev.ROA,prev.ROCE],[last.ROA,last.ROCE],"Efficienza Capitale");
  comment("economici","üü¢ Buona redditivit√† generale e margini in crescita.");

  make("chart-finanziari-1",["Current","Quick","Cash"],[prev.currentRatio,prev.quickRatio,prev.cashRatio],[last.currentRatio,last.quickRatio,last.cashRatio],"Indici di Liquidit√†");
  make("chart-finanziari-2",["Interest Cov."],[prev.interestCoverageRatio],[last.interestCoverageRatio],"Copertura Interessi");
  comment("finanziari","üíß Solida capacit√† di copertura debiti a breve.");

  make("chart-patrimoniali-1",["Leverage","Debt/Equity"],[prev.leverage,prev.debtEquityRatio],[last.leverage,last.debtEquityRatio],"Struttura del Capitale");
  make("chart-patrimoniali-2",["Equity Ratio"],[prev.equityRatio],[last.equityRatio],"Solidit√† Patrimoniale");
  comment("patrimoniali","üèõÔ∏è Struttura patrimoniale equilibrata, monitorare leva.");

  make("chart-produttivita-1",["Ricavi/Dip.","Ricavi/Amm.","Costo Medio Dip."],
    [prod?.prev?.ricaviPerDip,prod?.prev?.ricaviPerAmm,prod?.prev?.costoMedioDip],
    [prod?.last?.ricaviPerDip,prod?.last?.ricaviPerAmm,prod?.last?.costoMedioDip],
    "Produttivit√† del Personale");
  make("chart-produttivita-2",["Giorni Crediti","Giorni Debiti"],
    [prev.giorniCrediti,prev.giorniDebiti],[last.giorniCrediti,last.giorniDebiti],"Ciclo Finanziario");
  comment("produttivita","‚öôÔ∏è Alta produttivit√† e gestione circolante efficiente.");

  make("chart-solidita-1",["DSCR"],[dscr?.prev?.ratio],[dscr?.last?.ratio],"Copertura Debito");
  make("chart-solidita-2",["Z-Score"],[zscore?.prev?.score],[zscore?.last?.score],"Rischio Insolvenza");
  comment("solidita","‚ö†Ô∏è Ottima sostenibilit√† finanziaria e basso rischio.");

  // Radar Sintesi
  const r=document.getElementById("chart-radar");
  new Chart(r,{type:"radar",
    data:{labels:["Redditivit√†","Liquidit√†","Solidit√†","Produttivit√†","Rischio"],
      datasets:[{label:anni.last,
        data:[last.ROE*4,last.currentRatio*25,100-last.leverage*15,prod?.last?.ricaviPerDip/1000,zscore?.last?.score*20],
        backgroundColor:"#3b82f633",borderColor:"#3b82f6"}]},
    options:{responsive:true,scales:{r:{beginAtZero:true,max:100}}}});

  // Waterfall EBITDA
  const w=document.getElementById("chart-waterfall");
  new Chart(w,{type:"bar",
    data:{labels:["Ricavi","Costi","Personale","EBITDA"],
      datasets:[{data:[last.ricaviVendite,-last.costiProduzione,-prod?.last?.costoTotale||0,last.differenzaAB],
      backgroundColor:["#16a34a","#dc2626","#f97316","#3b82f6"]}]},
    options:{plugins:{title:{display:true,text:"EBITDA - Struttura dei Costi"}}}});

  // Trend Ricavi / Utile
  const t=document.getElementById("chart-trend");
  new Chart(t,{type:"line",
    data:{labels:[anni.prev,anni.last],
      datasets:[{label:"Ricavi",data:[prev.ricaviVendite,last.ricaviVendite],borderColor:"#3b82f6"},
                {label:"Utile",data:[prev.utileEsercizio,last.utileEsercizio],borderColor:"#16a34a"}]},
    options:{plugins:{title:{display:true,text:"Trend Biennale Ricavi / Utile"}}}});

  // Ciambella Liquidit√†
  const c=document.getElementById("chart-ciambella");
  new Chart(c,{type:"doughnut",
    data:{labels:["Attivo Circolante","Liquidit√†","Debiti < 12M"],
      datasets:[{data:[last.attivoCircolante,last.disponibilitaLiquide,last.debitiEntro12],
      backgroundColor:["#16a34a","#3b82f6","#f97316"]}]},
    options:{plugins:{title:{display:true,text:"Composizione Liquidit√† e Debiti"}}}});
}



// =====================================================
// üßÆ CARD KPI DESCRITTIVA ‚Äì Versione stabile corretta
// =====================================================
function generaCardKPI(nome, valoreLast, valorePrev, unita = "", sogliaBassa = 0, sogliaAlta = 0) {
  // === Parser numerico sicuro ===
  const parseIT = v => {
    if (v == null || v === "") return 0;
    if (typeof v === "number") return v;
    return parseFloat(String(v)
      .replace(/[^0-9,.-]/g, "")
      .replace(/\./g, "")
      .replace(",", ".")
    ) || 0;
  };

  // === Valori numerici reali ===
  const valLast = parseIT(valoreLast);
  const valPrev = parseIT(valorePrev);
  const delta = valLast - valPrev;
  const percVar = valPrev !== 0 ? ((delta / Math.abs(valPrev)) * 100) : 0;

  // === Formattazione italiana ===
  const fmtIt = v => isFinite(v)
    ? v.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    : "‚Äî";

  // === Colori soglie ===
  let colore = "#facc15"; // giallo
  if (sogliaBassa && valLast < sogliaBassa) colore = "#dc2626"; // rosso
  else if (sogliaAlta && valLast >= sogliaAlta) colore = "#16a34a"; // verde

  const arrow = delta > 0 ? "üìà" : delta < 0 ? "üìâ" : "‚è∏Ô∏è";
  const trendColor = delta > 0 ? "#16a34a" : delta < 0 ? "#dc2626" : "#6b7280";

  // === Commento dinamico sintetico ===
  const interpreta = (nome, val) => {
    switch (nome) {
      case "ROE": return val >= 15 ? "üü¢ Ottima redditivit√† del capitale proprio." :
        val >= 8 ? "‚úÖ Buona redditivit√† per gli azionisti." :
        val >= 3 ? "‚ö†Ô∏è Redditivit√† modesta." : "‚ùå Rendimento insufficiente.";
      case "ROI": return val >= 12 ? "üü¢ Ottima efficienza degli investimenti." :
        val >= 8 ? "‚úÖ Buon rendimento operativo." :
        val >= 4 ? "‚ö†Ô∏è ROI basso, attenzione ai margini." : "‚ùå Scarsa redditivit√† operativa.";
      case "ROS": return val >= 10 ? "üü¢ Margini eccellenti sulle vendite." :
        val >= 5 ? "‚úÖ Controllo costi adeguato." : "‚ö†Ô∏è Margini ridotti, serve efficienza.";
      case "Leverage": return val <= 2 ? "üü¢ Struttura patrimoniale equilibrata." :
        val <= 3 ? "‚ö†Ô∏è Leva accettabile ma in aumento." : "‚ùå Troppo debito.";
      case "Current Ratio": return val >= 1.8 ? "üü¢ Ottima capacit√† di copertura debiti." :
        val >= 1.2 ? "‚ö†Ô∏è Equilibrio precario." : "‚ùå Rischio liquidit√†.";
      case "DSCR": return val >= 1.25 ? "üü¢ Ottima sostenibilit√† finanziaria." :
        val >= 1.0 ? "‚ö†Ô∏è Flussi appena sufficienti." : "‚ùå Area di rischio.";
      case "Z-Score Altman": return val >= 3 ? "üü¢ Impresa sana e solida." :
        val >= 1.8 ? "‚ö†Ô∏è Zona grigia." : "‚ùå Rischio di insolvenza.";
      case "Ricavi per Dipendente": return val >= 100000 ? "üü¢ Alta produttivit√† per addetto." :
        val >= 70000 ? "‚úÖ Buona efficienza." :
        val > 0 ? "‚ö†Ô∏è Produttivit√† bassa." : "‚ÑπÔ∏è Dati personale non disponibili.";
      case "Ricavi per Amm.": return val >= 400000 ? "üü¢ Gestione manageriale efficiente." :
        val >= 200000 ? "‚úÖ Buon fatturato per amministratore." : "‚ö†Ô∏è Struttura amministrativa pesante.";
      case "Costo Medio per Addetto": return val >= 60000 ? "‚ö†Ô∏è Costi del personale elevati." :
        val >= 35000 ? "‚úÖ Costi equilibrati." :
        val > 0 ? "üü¢ Costi sotto controllo." : "‚ÑπÔ∏è Dati costo personale mancanti.";
      default: return "";
    }
  };

  // === Layout finale ===
  return `
    <div style="
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-left:6px solid ${colore};
      border-radius:8px;
      padding:12px 10px;
      text-align:center;">
      <div style="font-size:13px;color:#6b7280;font-weight:600;">${nome}</div>
      <div style="font-size:22px;font-weight:800;color:${colore};">
        ${fmtIt(valLast)} ${unita}
      </div>
      <div style="font-size:12px;color:${trendColor};margin-top:3px;">
        ${arrow} ${percVar >= 0 ? "+" : ""}${fmtIt(percVar)}% rispetto a ${state.anni?.prev || "anno prec."}
      </div>
      <div style="font-size:11.5px;color:#374151;margin-top:4px;">${interpreta(nome, valLast)}</div>
    </div>`;
}



// === FUNZIONI DI NAVIGAZIONE TABS PRINCIPALI E SOTTO-TABS ===
window.showIndiciTab = function(tab) {
  document.querySelectorAll('[id^="tab-indici-"]').forEach(el => (el.style.display = 'none'));
  document.getElementById(`tab-indici-${tab}`).style.display = 'block';
  
  document.querySelectorAll('.tab-indici').forEach(b => {
    b.classList.remove('active');
    b.style.background = 'none';
    b.style.borderBottom = 'none';
  });
  document.getElementById(`tabbtn-${tab}`).classList.add('active');
  document.getElementById(`tabbtn-${tab}`).style.background = 'white';
  document.getElementById(`tabbtn-${tab}`).style.borderBottom = '3px solid #003d82';
};

window.showSubTab = function(sub) {
  // ‚úÖ PROTEZIONE CONTRO NULL
  const subtabEl = document.getElementById(`subtab-${sub}`);
  if (!subtabEl) {
    console.warn(`‚ö†Ô∏è Elemento subtab-${sub} non trovato nel DOM`);
    return; // ‚Üê ESCI SENZA CRASH
  }
  
  document.querySelectorAll('[id^="subtab-"]').forEach(el => (el.style.display = 'none'));
  subtabEl.style.display = 'block';

  document.querySelectorAll('.subtab-indici').forEach(b => {
    b.classList.remove('active');
    b.style.background = 'none';
    b.style.borderBottom = 'none';
  });
  
  const subbtn = document.getElementById(`subbtn-${sub}`);
  if (subbtn) { // ‚úÖ PROTEZIONE
    subbtn.classList.add('active');
    subbtn.style.background = 'white';
    subbtn.style.borderBottom = '3px solid #f59e0b';
  }
};

// =======================================================
// ‚úÖ INDICI DI BILANCIO PRECEDENTE (ANNO N-2 / PREV)
// =======================================================
window.calcolaIndiciComplessiviPrev = function() {
  const sp = extractStandardizedSPPrev?.() || {};
  const ce = extractStandardizedCEPrev?.() || {};

  if (!sp || !ce) {
    console.warn("Dati non disponibili per calcolo indici PREV");
    return {
      ROE: 0, ROI: 0, ROS: 0, ROA: 0, ROCE: 0,
      currentRatio: 0, quickRatio: 0, cashRatio: 0,
      leverage: 0, debtEquityRatio: 0, equityRatio: 0, debtRatio: 0,
      gradoCopertura: 0,
      interestCoverageRatio: 0,
      rotazioneCapitaleInvestito: 0, rotazioneCapitaleCircolante: 0,
      rotazioneMagazzino: 0, giorniMagazzino: 365,
      giorniCrediti: 90, giorniDebiti: 90,
      coverageRatio: 0,
      debtServiceCoverageRatio: 0
    };
  }

  // Totale debiti calcolato in modo robusto
  const totDebiti = (sp.debitiEntro12 || 0) + (sp.debitiOltre12 || 0);

  return {
    // === REDDITIVIT√Ä ===
    ROE: sp.patrimonioNetto > 0 ? (ce.utileEsercizio / sp.patrimonioNetto) * 100 : 0,
    ROI: sp.totaleAttivo > 0 ? (ce.differenzaAB / sp.totaleAttivo) * 100 : 0,
    ROS: ce.ricaviVendite > 0 ? (ce.differenzaAB / ce.ricaviVendite) * 100 : 0,
    ROA: sp.totaleAttivo > 0 ? (ce.utileEsercizio / sp.totaleAttivo) * 100 : 0,
    ROCE: (sp.totaleAttivo - sp.debitiEntro12) > 0
      ? (ce.differenzaAB / (sp.totaleAttivo - sp.debitiEntro12)) * 100
      : 0,

    // === LIQUIDIT√Ä ===
    currentRatio: sp.debitiEntro12 > 0 ? sp.attivoCircolante / sp.debitiEntro12 : 0,
    quickRatio: sp.debitiEntro12 > 0
      ? (sp.attivoCircolante - sp.rimanenze) / sp.debitiEntro12
      : 0,
    cashRatio: sp.debitiEntro12 > 0 ? sp.disponibilitaLiquide / sp.debitiEntro12 : 0,

    // === SOLIDIT√Ä ===
    leverage: sp.patrimonioNetto > 0 ? sp.totaleAttivo / sp.patrimonioNetto : 0,
    debtEquityRatio: sp.patrimonioNetto > 0 ? totDebiti / sp.patrimonioNetto : 0,
    equityRatio: sp.totaleAttivo > 0 ? (sp.patrimonioNetto / sp.totaleAttivo) * 100 : 0,
    debtRatio: sp.totaleAttivo > 0 ? (totDebiti / sp.totaleAttivo) * 100 : 0,
    gradoCopertura: sp.immobilizzazioni > 0 ? sp.patrimonioNetto / sp.immobilizzazioni : 0,

    // === COPERTURA ===
    interestCoverageRatio: Math.abs(ce.oneriFinanziari) > 0
      ? ce.differenzaAB / Math.abs(ce.oneriFinanziari)
      : 0,
    coverageRatio: Math.abs(ce.oneriFinanziari) > 0
      ? (ce.differenzaAB + ce.ammortamenti) / Math.abs(ce.oneriFinanziari)
      : 0,

    // === EFFICIENZA ===
    rotazioneCapitaleInvestito: sp.totaleAttivo > 0 ? ce.ricaviVendite / sp.totaleAttivo : 0,
    rotazioneCapitaleCircolante: sp.attivoCircolante > 0 ? ce.ricaviVendite / sp.attivoCircolante : 0,
    rotazioneMagazzino: sp.rimanenze > 0 ? ce.costiProduzione / sp.rimanenze : 0,
    giorniMagazzino: ce.costiProduzione > 0 ? (sp.rimanenze / ce.costiProduzione) * 365 : 0,
    giorniCrediti: ce.ricaviVendite > 0 ? (sp.totaleCrediti / ce.ricaviVendite) * 365 : 0,
    giorniDebiti: ce.costiProduzione > 0 ? (sp.debitiEntro12 / ce.costiProduzione) * 365 : 0,

    // === DSCR PLACEHOLDER ===
    debtServiceCoverageRatio: 0
  };
};

// ======================================================
// üßÆ FUNZIONE UNIFICATA ‚Äì CALCOLA TUTTI GLI INDICI COMPLETI
// ======================================================
window.calcolaIndiciCompleti = function() {
  try {
    // 1Ô∏è‚É£ Recupera indici economici di base
    const prev = window.calcolaIndiciComplessiviPrev?.() || {};
    const last = window.calcolaIndiciComplessivi?.() || {};

    // 2Ô∏è‚É£ Recupera indici di produttivit√†
    const produttivita = typeof calcolaIndiciProduttivitaEstesi === "function"
      ? calcolaIndiciProduttivitaEstesi()
      : {};

    // 3Ô∏è‚É£ Recupera DSCR e Z-Score
    const dscr = typeof calcolaDSCRCompleto === "function"
      ? calcolaDSCRCompleto()
      : {};
    const zscore = typeof calcolaZScoreCompleto === "function"
      ? calcolaZScoreCompleto()
      : {};

    // 4Ô∏è‚É£ Componi oggetto unico
    const indiciCompleti = {
      anni: state?.anni || {},
      prev: { ...prev, produttivita: produttivita.prev || {} },
      last: { ...last, produttivita: produttivita.last || {} },
      dscr,
      zscore
    };

    // 5Ô∏è‚É£ Salva in stato globale per riuso
    state.indiciCompleti = indiciCompleti;
    console.log("‚úÖ Indici completi calcolati:", indiciCompleti);

    return indiciCompleti;
  } catch (err) {
    console.error("‚ùå Errore calcolaIndiciCompleti:", err);
    return {};
  }
};


// Funzione per cambiare tab indici
window.showIndiciTab = function(tab) {
    // Nascondi tutti
    document.querySelectorAll('[id^="tab-indici-"]').forEach(el => {
        el.style.display = 'none';
    });
    
    // Rimuovi active da tutti i tab
    document.querySelectorAll('.tab-indici').forEach(el => {
        el.classList.remove('active');
        el.style.background = 'none';
        el.style.borderBottom = 'none';
    });
    
    // Mostra il tab selezionato
    document.getElementById(`tab-indici-${tab}`).style.display = 'block';
    
    // Attiva il pulsante
    event.target.classList.add('active');
    event.target.style.background = 'white';
    event.target.style.borderBottom = '3px solid #003d82';
};

// ======================================================
// ‚úÖ FORMATTER SICURO (evita crash su valori NaN o null)
// ======================================================
const fmtNum = (v, d = 2) => (isFinite(v) ? v.toFixed(d) : "‚Äî");

// ======================================================
// üìä TABELLA INDICI ECONOMICI
// ======================================================
function generaTabIndiciEconomici(prev, last) {
  return `
    <h3 style="color: #003d82;">Indici di Redditivit√†</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f4f8;">
          <th style="padding: 12px; text-align: left;">Indice</th>
          <th style="padding: 12px; text-align: right;">${state.anni.prev}</th>
          <th style="padding: 12px; text-align: right;">${state.anni.last}</th>
          <th style="padding: 12px; text-align: center;">Œî</th>
          <th style="padding: 12px; text-align: center;">Soglia</th>
          <th style="padding: 12px; text-align: center;">Valutazione</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 10px;">ROE - Return on Equity</td>
          <td style="text-align: right;">${fmtNum(prev.ROE)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.ROE)}%</td>
          <td style="text-align: center; color: ${last.ROE > prev.ROE ? "green" : "red"};">
            ${last.ROE > prev.ROE ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.ROE - prev.ROE), 1)}%
          </td>
          <td style="text-align: center;">‚â•5%</td>
          <td style="text-align: center;">${last.ROE >= 5 ? "‚úÖ" : last.ROE >= 2 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr style="background: #fafafa;">
          <td style="padding: 10px;">ROI - Return on Investment</td>
          <td style="text-align: right;">${fmtNum(prev.ROI)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.ROI)}%</td>
          <td style="text-align: center; color: ${last.ROI > prev.ROI ? "green" : "red"};">
            ${last.ROI > prev.ROI ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.ROI - prev.ROI), 1)}%
          </td>
          <td style="text-align: center;">‚â•8%</td>
          <td style="text-align: center;">${last.ROI >= 8 ? "‚úÖ" : last.ROI >= 4 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr>
          <td style="padding: 10px;">ROS - Return on Sales</td>
          <td style="text-align: right;">${fmtNum(prev.ROS)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.ROS)}%</td>
          <td style="text-align: center; color: ${last.ROS > prev.ROS ? "green" : "red"};">
            ${last.ROS > prev.ROS ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.ROS - prev.ROS), 1)}%
          </td>
          <td style="text-align: center;">‚â•5%</td>
          <td style="text-align: center;">${last.ROS >= 5 ? "‚úÖ" : last.ROS >= 2 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr style="background: #fafafa;">
          <td style="padding: 10px;">ROA - Return on Assets</td>
          <td style="text-align: right;">${fmtNum(prev.ROA)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.ROA)}%</td>
          <td style="text-align: center; color: ${last.ROA > prev.ROA ? "green" : "red"};">
            ${last.ROA > prev.ROA ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.ROA - prev.ROA), 1)}%
          </td>
          <td style="text-align: center;">‚â•3%</td>
          <td style="text-align: center;">${last.ROA >= 3 ? "‚úÖ" : last.ROA >= 1 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr>
          <td style="padding: 10px;">ROCE - Return on Capital Employed</td>
          <td style="text-align: right;">${fmtNum(prev.ROCE)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.ROCE)}%</td>
          <td style="text-align: center; color: ${last.ROCE > prev.ROCE ? "green" : "red"};">
            ${last.ROCE > prev.ROCE ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.ROCE - prev.ROCE), 1)}%
          </td>
          <td style="text-align: center;">‚â•10%</td>
          <td style="text-align: center;">${last.ROCE >= 10 ? "‚úÖ" : last.ROCE >= 5 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
      </tbody>
    </table>
  `;
}

// ======================================================
// üíß TABELLA INDICI FINANZIARI
// ======================================================
function generaTabIndiciFinanziari(prev, last) {
  return `
    <h3 style="color: #003d82;">Indici di Liquidit√† e Solvibilit√†</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #e8f5e9;">
          <th style="padding: 12px; text-align: left;">Indice</th>
          <th style="padding: 12px; text-align: right;">${state.anni.prev}</th>
          <th style="padding: 12px; text-align: right;">${state.anni.last}</th>
          <th style="padding: 12px; text-align: center;">Œî</th>
          <th style="padding: 12px; text-align: center;">Soglia</th>
          <th style="padding: 12px; text-align: center;">Valutazione</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 10px;">Current Ratio</td>
          <td style="text-align: right;">${fmtNum(prev.currentRatio)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.currentRatio)}</td>
          <td style="text-align: center; color: ${last.currentRatio > prev.currentRatio ? "green" : "red"};">
            ${last.currentRatio > prev.currentRatio ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.currentRatio - prev.currentRatio))}
          </td>
          <td style="text-align: center;">‚â•1.5</td>
          <td style="text-align: center;">${last.currentRatio >= 1.5 ? "‚úÖ" : last.currentRatio >= 1.2 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr style="background: #fafafa;">
          <td style="padding: 10px;">Quick Ratio (Acid Test)</td>
          <td style="text-align: right;">${fmtNum(prev.quickRatio)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.quickRatio)}</td>
          <td style="text-align: center; color: ${last.quickRatio > prev.quickRatio ? "green" : "red"};">
            ${last.quickRatio > prev.quickRatio ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.quickRatio - prev.quickRatio))}
          </td>
          <td style="text-align: center;">‚â•1.0</td>
          <td style="text-align: center;">${last.quickRatio >= 1 ? "‚úÖ" : last.quickRatio >= 0.8 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr>
          <td style="padding: 10px;">Cash Ratio</td>
          <td style="text-align: right;">${fmtNum(prev.cashRatio)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.cashRatio)}</td>
          <td style="text-align: center; color: ${last.cashRatio > prev.cashRatio ? "green" : "red"};">
            ${last.cashRatio > prev.cashRatio ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.cashRatio - prev.cashRatio))}
          </td>
          <td style="text-align: center;">‚â•0.2</td>
          <td style="text-align: center;">${last.cashRatio >= 0.2 ? "‚úÖ" : last.cashRatio >= 0.1 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr style="background: #fafafa;">
          <td style="padding: 10px;">Interest Coverage Ratio</td>
          <td style="text-align: right;">${fmtNum(prev.interestCoverageRatio)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.interestCoverageRatio)}</td>
          <td style="text-align: center; color: ${last.interestCoverageRatio > prev.interestCoverageRatio ? "green" : "red"};">
            ${last.interestCoverageRatio > prev.interestCoverageRatio ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.interestCoverageRatio - prev.interestCoverageRatio))}
          </td>
          <td style="text-align: center;">‚â•3.0</td>
          <td style="text-align: center;">${last.interestCoverageRatio >= 3 ? "‚úÖ" : last.interestCoverageRatio >= 1.5 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
      </tbody>
    </table>
  `;
}

// ======================================================
// üèõÔ∏è TABELLA INDICI PATRIMONIALI
// ======================================================
function generaTabIndiciPatrimoniali(prev, last) {
  return `
    <h3 style="color: #003d82;">Indici di Solidit√† Patrimoniale</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #fff3cd;">
          <th style="padding: 12px; text-align: left;">Indice</th>
          <th style="padding: 12px; text-align: right;">${state.anni.prev}</th>
          <th style="padding: 12px; text-align: right;">${state.anni.last}</th>
          <th style="padding: 12px; text-align: center;">Œî</th>
          <th style="padding: 12px; text-align: center;">Soglia</th>
          <th style="padding: 12px; text-align: center;">Valutazione</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 10px;">Leverage</td>
          <td style="text-align: right;">${fmtNum(prev.leverage)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.leverage)}</td>
          <td style="text-align: center; color: ${last.leverage < prev.leverage ? "green" : "red"};">
            ${last.leverage < prev.leverage ? "‚Üì" : "‚Üë"} ${fmtNum(Math.abs(last.leverage - prev.leverage))}
          </td>
          <td style="text-align: center;">‚â§2.0</td>
          <td style="text-align: center;">${last.leverage <= 2 ? "‚úÖ" : last.leverage <= 3 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr style="background: #fafafa;">
          <td style="padding: 10px;">Debt/Equity Ratio</td>
          <td style="text-align: right;">${fmtNum(prev.debtEquityRatio)}</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.debtEquityRatio)}</td>
          <td style="text-align: center; color: ${last.debtEquityRatio < prev.debtEquityRatio ? "green" : "red"};">
            ${last.debtEquityRatio < prev.debtEquityRatio ? "‚Üì" : "‚Üë"} ${fmtNum(Math.abs(last.debtEquityRatio - prev.debtEquityRatio))}
          </td>
          <td style="text-align: center;">‚â§1.0</td>
          <td style="text-align: center;">${last.debtEquityRatio <= 1 ? "‚úÖ" : last.debtEquityRatio <= 2 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
        <tr>
          <td style="padding: 10px;">Equity Ratio</td>
          <td style="text-align: right;">${fmtNum(prev.equityRatio, 1)}%</td>
          <td style="text-align: right; font-weight: bold;">${fmtNum(last.equityRatio, 1)}%</td>
          <td style="text-align: center; color: ${last.equityRatio > prev.equityRatio ? "green" : "red"};">
            ${last.equityRatio > prev.equityRatio ? "‚Üë" : "‚Üì"} ${fmtNum(Math.abs(last.equityRatio - prev.equityRatio), 1)}%
          </td>
          <td style="text-align: center;">‚â•33%</td>
          <td style="text-align: center;">${last.equityRatio >= 33 ? "‚úÖ" : last.equityRatio >= 20 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>
      </tbody>
    </table>
  `;
}

// ======================================================
// ‚öôÔ∏è GENERA TABELLA INDICI DI PRODUTTIVIT√Ä ED EFFICIENZA (COMPLETA)
// ======================================================
function generaTabIndiciProduttivita(prev, last) {
  const datiProd = window.calcolaIndiciProduttivitaEstesi?.() || {};
  const prodPrev = datiProd.prev || {};
  const prodLast = datiProd.last || {};

  const fmt = (v, d = 0, suf = "") =>
    isFinite(v) ? v.toLocaleString("it-IT", { minimumFractionDigits: d, maximumFractionDigits: d }) + suf : "‚Äî";
  const fmtInt = v => (isFinite(v) ? Math.round(v).toLocaleString("it-IT") : "‚Äî");
  const delta = (a, b) => fmt(b - a, 0, " ‚Ç¨");

  // === BENCHMARK SETTORIALE ===
  let benchmarkHTML = "";
  try {
    const ateco = (state?.codiceAteco || "").toString();
    const info = getCategoriaAllertaDaAteco(ateco);
    const cat = info?.categoria || "‚Äî";
    const settoreNome = cat.replace("_", " ");
    const benchmark = {
      AGRICOLTURA: { ricaviDip: 40000, ricaviAmm: 150000 },
      INDUSTRIA: { ricaviDip: 85000, ricaviAmm: 350000 },
      SERV_UTILITA: { ricaviDip: 90000, ricaviAmm: 400000 },
      COSTRUZ_EDIFICI: { ricaviDip: 70000, ricaviAmm: 250000 },
      COSTRUZ_ING_SPEC: { ricaviDip: 75000, ricaviAmm: 260000 },
      COMM_INGROSSO: { ricaviDip: 80000, ricaviAmm: 300000 },
      COMM_DETTAGLIO: { ricaviDip: 60000, ricaviAmm: 250000 },
      TRASPORTI_HOTEL: { ricaviDip: 55000, ricaviAmm: 200000 },
      SERV_IMPRESE: { ricaviDip: 70000, ricaviAmm: 280000 },
      SERV_PERSONE: { ricaviDip: 50000, ricaviAmm: 220000 }
    };
    const b = benchmark[cat] || {};
    const ricaviDipSett = b.ricaviDip || 0;
    const ricaviAmmSett = b.ricaviAmm || 0;
    const percSett =
      prodLast.ricaviPerDip > 0 && ricaviDipSett > 0
        ? ((prodLast.ricaviPerDip / ricaviDipSett) * 100).toFixed(1)
        : null;

    benchmarkHTML = `
      <div style="margin-top:15px;padding:10px;border-radius:8px;background:#f0f9ff;border-left:5px solid #0284c7;">
        <strong>üìä Produttivit√† Settoriale ‚Äì ${settoreNome}</strong><br>
        Ricavi medi per Dipendente: <b>${ricaviDipSett.toLocaleString("it-IT")} ‚Ç¨</b><br>
        Ricavi medi per Amministratore: <b>${ricaviAmmSett.toLocaleString("it-IT")} ‚Ç¨</b><br>
        ${
          percSett
            ? `Il tuo valore per dipendente √® <b>${percSett}%</b> della media settoriale.`
            : `‚ÑπÔ∏è Inserisci i dati del personale per confrontarti con il benchmark.`
        }
      </div>`;
  } catch (err) {
    benchmarkHTML = "";
  }

  // === HTML TABELLA COMPLETA ===
  return `
    <h3 style="color:#003d82;">Indici di Produttivit√† ed Efficienza</h3>
    <table style="width:100%;border-collapse:collapse;margin-bottom:15px;">
      <thead style="background:#e3f2fd;">
        <tr>
          <th style="text-align:left;padding:8px;">Indice</th>
          <th style="text-align:right;padding:8px;">${state.anni.prev}</th>
          <th style="text-align:right;padding:8px;">${state.anni.last}</th>
          <th style="text-align:center;padding:8px;">Œî</th>
          <th style="text-align:center;padding:8px;">Benchmark</th>
          <th style="text-align:center;padding:8px;">Valutazione</th>
        </tr>
      </thead>
      <tbody>
        <!-- === INDICI PERSONALE === -->
        <tr>
          <td>Ricavi per Dipendente</td>
          <td style="text-align:right;">${fmt(prodPrev.ricaviPerDip, 0, " ‚Ç¨")}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(prodLast.ricaviPerDip, 0, " ‚Ç¨")}</td>
          <td style="text-align:center;color:${prodLast.ricaviPerDip >= prodPrev.ricaviPerDip ? "green" : "red"};">
            ${prodLast.ricaviPerDip >= prodPrev.ricaviPerDip ? "‚Üë" : "‚Üì"} ${delta(prodPrev.ricaviPerDip, prodLast.ricaviPerDip)}
          </td>
          <td style="text-align:center;">‚â•60.000 ‚Ç¨</td>
          <td style="text-align:center;">${prodLast.ricaviPerDip >= 60000 ? "‚úÖ" : prodLast.ricaviPerDip >= 40000 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>

        <tr style="background:#fafafa;">
          <td>Ricavi per Amministratore</td>
          <td style="text-align:right;">${fmt(prodPrev.ricaviPerAmm, 0, " ‚Ç¨")}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(prodLast.ricaviPerAmm, 0, " ‚Ç¨")}</td>
          <td style="text-align:center;color:${prodLast.ricaviPerAmm >= prodPrev.ricaviPerAmm ? "green" : "red"};">
            ${prodLast.ricaviPerAmm >= prodPrev.ricaviPerAmm ? "‚Üë" : "‚Üì"} ${delta(prodPrev.ricaviPerAmm, prodLast.ricaviPerAmm)}
          </td>
          <td style="text-align:center;">‚â•300.000 ‚Ç¨</td>
          <td style="text-align:center;">${prodLast.ricaviPerAmm >= 300000 ? "‚úÖ" : prodLast.ricaviPerAmm >= 150000 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>

        <tr>
          <td>Costo Medio per Addetto</td>
          <td style="text-align:right;">${fmt(prodPrev.costoMedioDip, 0, " ‚Ç¨")}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(prodLast.costoMedioDip, 0, " ‚Ç¨")}</td>
          <td style="text-align:center;color:${prodLast.costoMedioDip <= prodPrev.costoMedioDip ? "green" : "red"};">
            ${prodLast.costoMedioDip <= prodPrev.costoMedioDip ? "‚Üì" : "‚Üë"} ${delta(prodPrev.costoMedioDip, prodLast.costoMedioDip)}
          </td>
          <td style="text-align:center;">‚â§45.000 ‚Ç¨</td>
          <td style="text-align:center;">${prodLast.costoMedioDip <= 45000 ? "‚úÖ" : prodLast.costoMedioDip <= 55000 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>

        <!-- === SEZIONE EFFICIENZA OPERATIVA === -->
        <tr style="background:#f0f4f8;">
          <td colspan="6" style="font-weight:bold;color:#003d82;">Efficienza Operativa</td>
        </tr>
        <tr>
          <td>Rotazione Capitale Investito</td>
          <td style="text-align:right;">${fmt(prev.rotazioneCapitaleInvestito,2)}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(last.rotazioneCapitaleInvestito,2)}</td>
          <td style="text-align:center;color:${last.rotazioneCapitaleInvestito >= prev.rotazioneCapitaleInvestito ? "green" : "red"};">
            ${last.rotazioneCapitaleInvestito >= prev.rotazioneCapitaleInvestito ? "‚Üë" : "‚Üì"} ${fmt(Math.abs(last.rotazioneCapitaleInvestito - prev.rotazioneCapitaleInvestito),2)}
          </td>
          <td style="text-align:center;">‚â•1.0</td>
          <td style="text-align:center;">${last.rotazioneCapitaleInvestito >= 1 ? "‚úÖ" : "‚ö†Ô∏è"}</td>
        </tr>

        <tr style="background:#fafafa;">
          <td>Rotazione Capitale Circolante</td>
          <td style="text-align:right;">${fmt(prev.rotazioneCapitaleCircolante,2)}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(last.rotazioneCapitaleCircolante,2)}</td>
          <td style="text-align:center;color:${last.rotazioneCapitaleCircolante >= prev.rotazioneCapitaleCircolante ? "green" : "red"};">
            ${last.rotazioneCapitaleCircolante >= prev.rotazioneCapitaleCircolante ? "‚Üë" : "‚Üì"} ${fmt(Math.abs(last.rotazioneCapitaleCircolante - prev.rotazioneCapitaleCircolante),2)}
          </td>
          <td style="text-align:center;">Settoriale</td>
          <td style="text-align:center;">üìä</td>
        </tr>

        <tr>
          <td>Rotazione Magazzino (volte/anno)</td>
          <td style="text-align:right;">${fmt(prev.rotazioneMagazzino,2)}</td>
          <td style="text-align:right;font-weight:bold;">${fmt(last.rotazioneMagazzino,2)}</td>
          <td style="text-align:center;color:${last.rotazioneMagazzino >= prev.rotazioneMagazzino ? "green" : "red"};">
            ${last.rotazioneMagazzino >= prev.rotazioneMagazzino ? "‚Üë" : "‚Üì"} ${fmt(Math.abs(last.rotazioneMagazzino - prev.rotazioneMagazzino),2)}
          </td>
          <td style="text-align:center;">‚â•6</td>
          <td style="text-align:center;">${last.rotazioneMagazzino >= 6 ? "‚úÖ" : last.rotazioneMagazzino >= 4 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>

        <tr style="background:#fafafa;">
          <td>Giorni Crediti (DSO)</td>
          <td style="text-align:right;">${fmtInt(prev.giorniCrediti)} gg</td>
          <td style="text-align:right;font-weight:bold;">${fmtInt(last.giorniCrediti)} gg</td>
          <td style="text-align:center;color:${last.giorniCrediti <= prev.giorniCrediti ? "green" : "red"};">
            ${last.giorniCrediti <= prev.giorniCrediti ? "‚Üì" : "‚Üë"} ${fmtInt(Math.abs(last.giorniCrediti - prev.giorniCrediti))} gg
          </td>
          <td style="text-align:center;">‚â§60 gg</td>
          <td style="text-align:center;">${last.giorniCrediti <= 60 ? "‚úÖ" : last.giorniCrediti <= 90 ? "‚ö†Ô∏è" : "‚ùå"}</td>
        </tr>

        <tr>
          <td>Giorni Debiti (DPO)</td>
          <td style="text-align:right;">${fmtInt(prev.giorniDebiti)} gg</td>
          <td style="text-align:right;font-weight:bold;">${fmtInt(last.giorniDebiti)} gg</td>
          <td style="text-align:center;">${fmtInt(last.giorniDebiti - prev.giorniDebiti)} gg</td>
          <td style="text-align:center;">60‚Äì90 gg</td>
          <td style="text-align:center;">${last.giorniDebiti >= 60 && last.giorniDebiti <= 90 ? "‚úÖ" : "‚ö†Ô∏è"}</td>
        </tr>
      </tbody>
    </table>
    ${prodLast.addetti === 0 ? `
      <div style="margin-top:10px;padding:8px;background:#fff7ed;border-left:4px solid #f59e0b;font-size:13px;">
        ‚ö†Ô∏è Nessun dato sul personale. Compila ‚ÄúTabelle‚Äù per abilitare gli indici di produttivit√†.
      </div>` : ""}
    ${benchmarkHTML}
  `;
}


// ======================================================
// üìà DASHBOARD KPI ‚Äì SINTESI COMPLETA
// ======================================================
function generaTabDashboardKPI(prev, last) {
  return `
    <h3 style="color:#003d82;">Dashboard KPI - Sintesi ${state.anni.prev} vs ${state.anni.last}</h3>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#f0f4f8,#e0e7ff);padding:15px;border-radius:8px;text-align:center;">
        <div style="color:#6b7280;font-size:12px;">ROE</div>
        <div style="font-size:24px;font-weight:bold;color:${last.ROE>=5?"#16a34a":"#f59e0b"};">${fmtNum(last.ROE)}%</div>
        <div style="font-size:11px;color:${last.ROE>prev.ROE?"green":"red"};">${last.ROE>prev.ROE?"‚Üë":"‚Üì"} da ${fmtNum(prev.ROE)}%</div>
      </div>
      <div style="background:linear-gradient(135deg,#f0f4f8,#e0e7ff);padding:15px;border-radius:8px;text-align:center;">
        <div style="color:#6b7280;font-size:12px;">ROI</div>
        <div style="font-size:24px;font-weight:bold;color:${last.ROI>=8?"#16a34a":"#f59e0b"};">${fmtNum(last.ROI)}%</div>
        <div style="font-size:11px;color:${last.ROI>prev.ROI?"green":"red"};">${last.ROI>prev.ROI?"‚Üë":"‚Üì"} da ${fmtNum(prev.ROI)}%</div>
      </div>
      <div style="background:linear-gradient(135deg,#e8f5e9,#c8e6c9);padding:15px;border-radius:8px;text-align:center;">
        <div style="color:#6b7280;font-size:12px;">Current Ratio</div>
        <div style="font-size:24px;font-weight:bold;color:${last.currentRatio>=1.5?"#16a34a":"#f59e0b"};">${fmtNum(last.currentRatio)}</div>
        <div style="font-size:11px;color:${last.currentRatio>prev.currentRatio?"green":"red"};">${last.currentRatio>prev.currentRatio?"‚Üë":"‚Üì"} da ${fmtNum(prev.currentRatio)}</div>
      </div>
      <div style="background:linear-gradient(135deg,#fff3cd,#ffe8a1);padding:15px;border-radius:8px;text-align:center;">
        <div style="color:#6b7280;font-size:12px;">Leverage</div>
        <div style="font-size:24px;font-weight:bold;color:${last.leverage<=2?"#16a34a":"#f59e0b"};">${fmtNum(last.leverage)}</div>
        <div style="font-size:11px;color:${last.leverage<prev.leverage?"green":"red"};">${last.leverage<prev.leverage?"‚Üì":"‚Üë"} da ${fmtNum(prev.leverage)}</div>
      </div>
    </div>
  `;
}


// ======================================================
// üß± LETTURA DATI TABELLE SICURA (VERSIONE COMPLETA)
// ======================================================
window.getDatiTabelleSafe = function() {
  try {
    const cfKey = (state?.cf || state?.codiceFiscale || "").trim();
    const yPrev = state?.anni?.prev || "";
    const yLast = state?.anni?.last || "";
    const keyLS = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;

    // 1Ô∏è‚É£ Prova prima in memoria (RAM)
    if (state?.tabelle && Object.keys(state.tabelle).length > 0) {
      console.log("üìä getDatiTabelleSafe ‚Üí uso state.tabelle:", state.tabelle);
      return state.tabelle;
    }

    // 2Ô∏è‚É£ Altrimenti, leggi sempre dal localStorage
    const saved = localStorage.getItem(keyLS);
    if (saved) {
      const parsed = JSON.parse(saved);
      console.log("üìä getDatiTabelleSafe ‚Üí uso localStorage (completo):", keyLS);
      state.tabelle = parsed; // memorizza anche nello stato globale
      return parsed;
    }

    // 3Ô∏è‚É£ Se non trovato, tenta un ricalcolo diretto
    if (typeof getDatiTabelle === "function") {
      console.warn("‚ö†Ô∏è getDatiTabelleSafe: ricalcolo tabelle in tempo reale");
      const live = getDatiTabelle();
      if (live && Object.keys(live).length > 0) {
        state.tabelle = live;
        localStorage.setItem(keyLS, JSON.stringify(live));
        return live;
      }
    }

    console.warn("‚ö†Ô∏è getDatiTabelleSafe: nessuna tabella disponibile per", keyLS);
    return {};
  } catch (err) {
    console.error("‚ùå Errore getDatiTabelleSafe:", err);
    return {};
  }
};

// ======================================================
// üíæ SALVATAGGIO TABELLE (robusto e sincronizzato con state)
// ======================================================
window.salvaDatiTabelle = function() {
  try {
    // Identificativo univoco bilancio
    const cfKey = (state?.cf || state?.codiceFiscale || 'NA').trim();
    const yPrev = state?.anni?.prev || 'NA';
    const yLast = state?.anni?.last || 'NA';
    const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;

    if (cfKey === 'NA' || yPrev === 'NA' || yLast === 'NA') {
      toast("‚ö†Ô∏è Impossibile salvare: bilancio non identificato.", true);
      console.error("‚ö†Ô∏è Dati mancanti per salvataggio tabelle:", { cfKey, yPrev, yLast });
      return;
    }

    // Raccoglie tutti gli input (sia testo che numerici)
    const inputs = document.querySelectorAll(
      '#modalTabelle input[type="text"], #modalTabelle input[type="number"]'
    );

    const datiTabelle = {
      cf: cfKey,
      anni: { prev: yPrev, last: yLast },
      timestamp: new Date().toISOString()
    };

    // Copia i valori degli input nella struttura
    inputs.forEach(inp => {
      const id = inp.id || "";
      if (id) datiTabelle[id] = inp.value || "";
    });

    // ‚úÖ Salva su localStorage
    localStorage.setItem(storeKey, JSON.stringify(datiTabelle));

    // ‚úÖ Aggiorna lo stato globale immediatamente
    state.tabelle = datiTabelle;
    console.log("üîÑ Stato tabelle aggiornato in memoria:", state.tabelle);

    // ‚úÖ Notifica utente
    toast(`‚úÖ Tabelle salvate per ${cfKey} (${yPrev}-${yLast})`);
    console.log("üíæ Tabelle salvate in localStorage:", storeKey, datiTabelle);

  } catch (err) {
    console.error("‚ùå Errore salvaDatiTabelle:", err);
    toast("Errore durante il salvataggio delle tabelle", true);
  }
};


// ======================================================
// üìÇ CARICAMENTO AUTOMATICO TABELLE SE SALVATE
// ======================================================
window.caricaDatiTabelle = function() {
  try {
    const cfKey = (state?.cf || state?.codiceFiscale || '').trim();
    const yPrev = state?.anni?.prev || '';
    const yLast = state?.anni?.last || '';
    const storeKey = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;

    const saved = localStorage.getItem(storeKey);
    if (!saved) {
      console.log("‚ÑπÔ∏è Nessuna tabella salvata trovata per", storeKey);
      return;
    }

    const dati = JSON.parse(saved);

    // Reinserisce i valori nei campi input
    Object.entries(dati).forEach(([k, v]) => {
      const el = document.getElementById(k);
      if (el && v !== undefined && v !== null) {
        el.value = v;
      }
    });

    // Aggiorna lo stato globale
    state.tabelle = dati;

    toast("üìÇ Tabelle caricate automaticamente");
    console.log("üìÇ Tabelle caricate automaticamente:", storeKey, dati);

  } catch (err) {
    console.warn("‚ö†Ô∏è Nessuna tabella trovata o errore nel caricamento:", err);
  }
};


// ======================================================
// üìä CALCOLO INDICI DI PRODUTTIVIT√Ä (PREV + LAST) - FIX
// ======================================================
window.calcolaIndiciProduttivitaEstesi = function () {
  try {
    const t = window.getDatiTabelleSafe?.() || {};
    const cePrev = window.extractStandardizedCEPrev?.() || {};
    const ceLast = window.extractStandardizedCE?.() || {};

    // ‚úÖ Parser robusto per numeri italiani e semplici
    const num = v => {
      if (v == null || v === "") return 0;
      if (typeof v === "number") return v;
      const cleaned = String(v)
        .replace(/[^0-9,.-]/g, "") // elimina tutto tranne cifre e separatori
        .replace(/\./g, "") // rimuove i separatori delle migliaia
        .replace(",", "."); // converte la virgola in punto
      const n = parseFloat(cleaned);
      return isFinite(n) ? n : 0;
    };

    // === 1Ô∏è‚É£ Dati PREV ===
    const ricaviPrev = num(cePrev.ricaviVendite || cePrev.valoreProduzione);
    const addPrev = num(t.addetti_tot_prev);
    const ammPrev = num(t.amm_numero_prev);
    const costoPrev = num(t.costo_pers_tot_prev || t.cp_prod_prev);
    const ammCompPrev = num(t.amm_totale_prev || 0);

    // === 2Ô∏è‚É£ Dati LAST ===
    const ricaviLast = num(ceLast.ricaviVendite || ceLast.valoreProduzione);
    const addLast = num(t.addetti_tot_last);
    const ammLast = num(t.amm_numero_last);
    const costoLast = num(t.costo_pers_tot_last || t.cp_prod_last);
    const ammCompLast = num(t.amm_totale_last || 0);

    // === 3Ô∏è‚É£ Calcoli indici ===
    const calc = (ricavi, add, amm, costo, costoAmm, anno) => ({
      anno,
      ricavi,
      addetti: add,
      numAmm: amm,
      ricaviPerDip: add > 0 ? ricavi / add : 0,
      ricaviPerAmm: amm > 0 ? ricavi / amm : 0,
      costoMedioDip: add > 0 ? costo / add : 0,
      costoTotale: costo,
      costoMedioAmm: amm > 0 ? costoAmm / amm : 0
    });

    const prev = calc(ricaviPrev, addPrev, ammPrev, costoPrev, ammCompPrev, state?.anni?.prev || "‚Äî");
    const last = calc(ricaviLast, addLast, ammLast, costoLast, ammCompLast, state?.anni?.last || "‚Äî");

    console.log("‚úÖ Indici di Produttivit√† Estesi:", { prev, last });
    return { prev, last };
  } catch (err) {
    console.error("‚ùå Errore calcolaIndiciProduttivitaEstesi:", err);
    return { prev: {}, last: {} };
  }
};


// ======================================
//  FUNZIONE DI PARSING IMPORTI ITALIANI
// ======================================
function parseIT(val) {
  if (val === null || val === undefined) return 0;
  if (typeof val === "number") return val;

  try {
    // Rimuove simboli ‚Ç¨, punti migliaia, spazi
    const clean = String(val)
      .replace(/[‚Ç¨\s]/g, "")
      .replace(/\./g, "")
      .replace(/,/g, ".")
      .trim();

    const num = parseFloat(clean);
    return isNaN(num) ? 0 : num;
  } catch (err) {
    console.warn("‚ö†Ô∏è parseIT errore su valore:", val, err);
    return 0;
  }
}



// ======================================================
//  DSCR COMPLETO - Formula reale e coerente con extractStandardizedCE()
// ======================================================
window.calcolaDSCRCompleto = function() {
  try {
    const N = v => Number.isFinite(+v) ? +v : 0;
  // ‚úÖ parser robusto per numeri italiani (es. "12.492.165,00" ‚Üí 12492165.00)
const parseIT = v => {
  if (v === null || v === undefined) return 0;
  const str = String(v).replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '');
  const num = parseFloat(str);
  return Number.isFinite(num) ? num : 0;
};

    const tabelle = getDatiTabelleSafe?.() || {};

    // ‚úÖ Usa i bilanci standardizzati gi√† salvati nello state
    const cePrev = state?.prevCE || extractStandardizedCEPrev?.() || {};
    const ceLast = state?.lastCE || extractStandardizedCE?.() || {};

    // === 1Ô∏è‚É£ Imposte correnti (non differite, con fallback sicuro) ===
    let impPrev = parseIT(cePrev.imposte_correnti);
    let impLast = parseIT(ceLast.imposte_correnti);

    if (impPrev === 0 && cePrev.imposte > 0) {
      console.warn("‚ö†Ô∏è Imposte correnti (prev) non trovate, uso imposte totali.");
      impPrev = parseIT(cePrev.imposte);
    }
    if (impLast === 0 && ceLast.imposte > 0) {
      console.warn("‚ö†Ô∏è Imposte correnti (last) non trovate, uso imposte totali.");
      impLast = parseIT(ceLast.imposte);
    }

    // === 2Ô∏è‚É£ Calcolo EBITDA (Differenza A-B + Ammortamenti + Accantonamenti) ===
    const ebitPrev = parseIT(cePrev.differenzaAB);
    const ebitLast = parseIT(ceLast.differenzaAB);
    const ammPrev = parseIT(cePrev.ammortamenti);
    const ammLast = parseIT(ceLast.ammortamenti);
    const accPrev = parseIT(cePrev.accantonamenti);
    const accLast = parseIT(ceLast.accantonamenti);

    const ebitdaPrev = ebitPrev + ammPrev + accPrev;
    const ebitdaLast = ebitLast + ammLast + accLast;

    // === 3Ô∏è‚É£ Cash Flow Operativo netto ===
    const cfPrev = ebitdaPrev - impPrev;
    const cfLast = ebitdaLast - impLast;

    // === 4Ô∏è‚É£ Interessi passivi ===
    const intPrev = Math.abs(parseIT(cePrev.oneriFinanziari));
    const intLast = Math.abs(parseIT(ceLast.oneriFinanziari));

    // === 5Ô∏è‚É£ Quote capitale = debiti finanziari ENTRO 12 MESI (da Compila Tabelle) ===
    const debFinPrev = parseIT(tabelle.deb_e_fin_prev);
    const debFinLast = parseIT(tabelle.deb_e_fin_last);

    // === 6Ô∏è‚É£ Servizio del Debito (quote capitale + interessi) ===
    const servPrev = debFinPrev + intPrev;
    const servLast = debFinLast + intLast;

    // === 7Ô∏è‚É£ DSCR ===
    const dscrPrev = servPrev > 0 ? cfPrev / servPrev : 0;
    const dscrLast = servLast > 0 ? cfLast / servLast : 0;

    // === 8Ô∏è‚É£ Interpretazione ===
const interpretazione =
  dscrLast > 1.25
    ? "üå± Ottimo equilibrio finanziario ‚Äì l'impresa genera cassa pi√π che sufficiente a coprire il debito."
    : dscrLast >= 1.0
    ? "‚ö†Ô∏è Situazione di attenzione ‚Äì i flussi coprono a fatica gli impegni, serve prudenza."
    : "üî• Area di rischio ‚Äì i flussi operativi non coprono il servizio del debito, √® necessaria un‚Äôazione correttiva.";

    const sostenibilita =
      dscrLast > 1.25 ? "Buona" :
      dscrLast >= 1.0 ? "Sufficiente" : "Critica";

    const result = {
      ratio: dscrLast,
      interpretazione,
      sostenibilita,
      prev: {
        anno: state?.anni?.prev || "‚Äî",
        EBITDA: ebitdaPrev,
        imposteCorrenti: impPrev,
        cashFlow: cfPrev,
        oneriFinanziari: intPrev,
        quoteCapitale: debFinPrev,
        servizioDebito: servPrev,
        ratio: dscrPrev,
      },
      last: {
        anno: state?.anni?.last || "‚Äî",
        EBITDA: ebitdaLast,
        imposteCorrenti: impLast,
        cashFlow: cfLast,
        oneriFinanziari: intLast,
        quoteCapitale: debFinLast,
        servizioDebito: servLast,
        ratio: dscrLast,
      },
    };

 console.log("‚úÖ DSCR calcolato (con imposte correnti e debiti entro 12 mesi):", result);

// üîπ Salva solo il risultato globale, senza render automatico
window.lastDSCR = result;

return result;


  } catch (err) {
    console.error("‚ùå Errore calcolaDSCRCompleto:", err);
    return { ratio: 0, prev: { ratio: 0 }, last: { ratio: 0 } };
  }
};


// =======================
//  RENDER KPI DSCR (NUOVA VERSIONE 2025)
// =======================
window.renderDSCRKPI = function (containerId = "kpi-dscr") {
  // ‚úÖ fallback automatico se il container non esiste
  if (!document.getElementById(containerId)) {
    if (document.getElementById("predisponiContent")) containerId = "predisponiContent";
    else if (document.getElementById("tabDSCR")) containerId = "tabDSCR";
  }

  const dscr = window.lastDSCR || window.calcolaDSCRCompleto();
  if (!dscr || !dscr.last) {
    console.warn("‚ö†Ô∏è Nessun dato DSCR disponibile o funzione non caricata.");
    return;
  }

  // === Helper formattazione numeri ===
  const fmt = (v) =>
    isFinite(v)
      ? v.toLocaleString("it-IT", { minimumFractionDigits: 0, maximumFractionDigits: 0 })
      : "0";

  const colorRatio = (r) =>
    r >= 1.25 ? "#16a34a" : r >= 1.0 ? "#eab308" : "#dc2626";
  const labelRatio = (r) =>
    r >= 1.25 ? "‚úÖ Sostenibile" : r >= 1.0 ? "‚ö†Ô∏è Attenzione" : "‚ùå Critico";

  // === Scheda per ogni anno ===
  const renderAnno = (a, active = false) => {
    const c = colorRatio(a.ratio);
    return `
      <div class="dscr-card" style="
        flex:1; min-width:260px;
        background:white;
        border-radius:12px;
        box-shadow:0 4px 10px rgba(0,0,0,0.1);
        padding:18px; 
        text-align:center;
        border-top:5px solid ${c};
        ${active ? "transform:scale(1.02);" : ""}
      ">
        <div style="font-size:13px;color:#6b7280;font-weight:600">${a.anno}</div>
        <div style="font-size:2.4rem;font-weight:800;color:${c};margin:8px 0;">
          ${a.ratio.toFixed(2)}
        </div>
        <div style="font-size:13px;font-weight:700;color:${c};margin-bottom:8px;">
          ${labelRatio(a.ratio)}
        </div>
        <table style="width:100%;font-size:12px;text-align:right;border-collapse:collapse;margin-top:8px;">
          <tr><td style="text-align:left;">EBITDA</td><td>‚Ç¨ ${fmt(a.EBITDA)}</td></tr>
          <tr><td style="text-align:left;">Imposte</td><td>‚Ç¨ ${fmt(a.imposteCorrenti)}</td></tr>
          <tr><td style="text-align:left; font-weight:bold;">Cash Flow Operativo</td><td style="font-weight:bold;">‚Ç¨ ${fmt(a.cashFlow)}</td></tr>
          <tr><td style="text-align:left;">Quote Capitale</td><td>‚Ç¨ ${fmt(a.quoteCapitale)}</td></tr>
          <tr><td style="text-align:left;">Interessi</td><td>‚Ç¨ ${fmt(a.oneriFinanziari)}</td></tr>
          <tr style="font-weight:bold;border-top:1px solid #ddd;">
            <td style="text-align:left;">Servizio del Debito</td><td>‚Ç¨ ${fmt(a.servizioDebito)}</td>
          </tr>
        </table>
      </div>`;
  };

  // === Trend ===
  const delta = dscr.last.ratio - dscr.prev.ratio;
  const trendIcon = delta > 0 ? "üìà" : delta < 0 ? "üìâ" : "‚è∏Ô∏è";
  const trendColor = delta > 0 ? "#16a34a" : delta < 0 ? "#dc2626" : "#6b7280";
 const interpretazione = dscr.interpretazione || "N/D";


  // === HTML Finale ===
  const html = `
    <h3 style="text-align:center;color:#003d82;margin-bottom:10px;">DSCR ‚Äì Debt Service Coverage Ratio</h3>
    <div style="display:flex;gap:18px;justify-content:center;flex-wrap:wrap;margin-bottom:12px;">
      ${renderAnno(dscr.prev)}
      ${renderAnno(dscr.last, true)}
    </div>
    <div style="text-align:center;font-size:13px;margin-top:12px;">
      <strong>Interpretazione ${dscr.last.anno}:</strong> 
      <span style="color:${colorRatio(dscr.last.ratio)};font-weight:600;">
        ${interpretazione}
      </span>
    </div>
    <div style="text-align:center;font-size:13px;margin-top:6px;color:${trendColor}">
      <strong>Trend:</strong> ${trendIcon} ${(delta > 0 ? "+" : "") + delta.toFixed(2)} rispetto a ${dscr.prev.anno}
    </div>
    <div style="text-align:center;font-size:11px;color:#6b7280;margin-top:8px;">
      Formula: (EBITDA ‚Äì Imposte) / (Quote Capitale + Interessi)
    </div>
  `;

  const el = document.getElementById(containerId);
  if (el) el.innerHTML = html;
  else console.warn("‚ö†Ô∏è Contenitore DSCR non trovato:", containerId);
};


// ========== DSCR & Z-SCORE CON CONFRONTO 2 ANNI ==========
window.mostraDSCRZScore = function() {
    const dscr = calcolaDSCRCompleto();
    const zScore = calcolaZScoreCompleto();
    
    const modal = document.createElement('div');
    modal.id = 'modalDSCRZScore';
    modal.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 90%; max-width: 1000px;
        max-height: 90vh;
        border-radius: 12px;
        overflow: hidden;
    `;
    
    container.innerHTML = `
        <div style="background: #003d82; color: white; padding: 20px;">
            <h3 style="margin: 0;">üìä DSCR e Z-Score Analysis</h3>
        </div>
        
        <div style="padding: 20px;">
            <!-- Tab buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="tab-btn active" onclick="showDSCRTab('dscr')" 
                        style="padding: 10px 20px; background: #003d82; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    DSCR Analysis
                </button>
                <button class="tab-btn" onclick="showDSCRTab('zscore')" 
                        style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Z-Score Altman
                </button>
            </div>
            
            <!-- Tab DSCR -->
           <div id="tabDSCR" class="tab-content">
  ${generaTabDSCR(dscr)}
</div>
            
           <!-- Tab Z-Score -->
<div id="tabZScore" class="tab-content" style="display: none;">
    ${generaTabZScore(zScore)}
</div>
        </div>
        
        <div style="padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
<button onclick="chiudiDSCRZScore()" 
        style="background:#dc2626;color:white;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;">
  Chiudi
</button>

        </div>
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);

// üîπ Calcolo e render DSCR appena l'utente apre la modale
try {
  const result = window.calcolaDSCRCompleto?.();
  if (result) {
    window.lastDSCR = result;
    // cerca dove inserire il DSCR (preferibilmente nella tab DSCR)
    const target = document.getElementById("tabDSCR") || document.getElementById("predisponiContent");
    if (target && typeof window.renderDSCRKPI === "function") {
      window.renderDSCRKPI(target.id);
      console.log("üíæ DSCR renderizzato al click su DSCR & Z-Score Altman");
    }
  }
} catch (err) {
  console.error("‚ùå Errore nel calcolo DSCR al click:", err);
}
   
    // Stile per tab buttons
    const style = document.createElement('style');
    style.textContent = `
        .tab-btn.active {
            background: #003d82 !important;
        }
        .tab-btn:not(.active) {
            background: #6b7280 !important;
        }
        .tab-btn:hover {
            opacity: 0.9;
        }
    `;
    document.head.appendChild(style);
};

// === Chiusura DSCR & Z-Score con ripristino UI ===
window.chiudiDSCRZScore = function() {
  const modal = document.getElementById('modalDSCRZScore');
  if (modal) {
    modal.remove();               // chiude la finestra
    document.body.style.overflow = ""; // riabilita lo scroll, se era bloccato
  }
  console.log("‚Ü© DSCR & Z-Score chiuso (nessuna modifica alla schermata principale).");
};


// =======================
//  Z-SCORE COMPLETO (VERSIONE ROBUSTA)
// =======================
window.calcolaZScoreCompleto = function() {
  try {
    const safeDiv = (a, b) => (b && isFinite(b) && b !== 0) ? a / b : 0;
    const N = v => Number.isFinite(+v) ? +v : 0;

    const spPrev = extractStandardizedSPPrev?.() || {};
    const spLast = extractStandardizedSP?.() || {};
    const cePrev = extractStandardizedCEPrev?.() || {};
    const ceLast = extractStandardizedCE?.() || {};

    function compute(sp, ce) {
      const X1 = safeDiv((N(sp.attivoCircolante) - N(sp.debitiEntro12)), N(sp.totaleAttivo));
      const X2 = safeDiv(N(sp.riserve), N(sp.totaleAttivo));
      const X3 = safeDiv(N(ce.differenzaAB), N(sp.totaleAttivo));
      const X4 = safeDiv(N(sp.patrimonioNetto), N(sp.totDebiti));
      const X5 = safeDiv(N(ce.ricaviVendite), N(sp.totaleAttivo));
      const score = 1.2*X1 + 1.4*X2 + 3.3*X3 + 0.6*X4 + 1.0*X5;
      const classificazione =
        score > 2.99 ? "Zona Sicura" :
        score > 1.80 ? "Zona Grigia" : "Zona Distress";
      return { X1, X2, X3, X4, X5, score, classificazione };
    }

    const prev = compute(spPrev, cePrev);
    const last = compute(spLast, ceLast);

    return {
      prev: { anno: state?.anni?.prev || "‚Äî", ...prev },
      last: { anno: state?.anni?.last || "‚Äî", ...last }
    };
  } catch (err) {
    console.error("Errore calcolaZScoreCompleto:", err);
    return { prev: { score: 0 }, last: { score: 0 } };
  }
};

// ========== GENERATORI CONTENUTO DSCR E Z-SCORE ==========
// =====================================================
// ‚öôÔ∏è GENERA TAB DSCR - Layout coerente con renderDSCRKPI
// =====================================================
function generaTabDSCR(dscr) {
  try {
    // Se non hai un risultato gi√† calcolato, lo ricalcola
    if (!dscr || !dscr.last) dscr = calcolaDSCRCompleto();

    // Usa il renderDSCRKPI per produrre l'HTML completo
    const tempId = "dscr-render-temp";
    const tempDiv = document.createElement("div");
    tempDiv.id = tempId;
    document.body.appendChild(tempDiv);

    // Renderizza nel container temporaneo
    window.renderDSCRKPI(tempId);

    const html = tempDiv.innerHTML;
    tempDiv.remove();
    return html;
  } catch (err) {
    console.error("Errore generaTabDSCR:", err);
    return "<p style='color:#dc2626;'>Errore nel rendering DSCR.</p>";
  }
}

function generaTabZScore(z) {
    if (!z || !z.last) return "<p>Nessun dato Z-Score disponibile.</p>";

    const fmt = (v) => isFinite(v) ? v.toFixed(3) : "0.000";
    const color = (s) => s > 2.99 ? "#16a34a" : s > 1.80 ? "#eab308" : "#dc2626";

    return `
        <h3 style="color:#003d82;">Z-Score Altman ‚Äì Previsione di Insolvenza</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
            ${[z.prev, z.last].map((a,i)=>`
            <div style="border:${i?2:1}px solid #003d82;border-radius:8px;padding:20px;">
                <h4 style="text-align:center;color:#003d82;">${a.anno}</h4>
                <div style="font-size:42px;text-align:center;font-weight:bold;color:${color(a.score)};">
                    ${fmt(a.score)}
                </div>
                <div style="text-align:center;margin-bottom:10px;">${a.classificazione}</div>
                <table style="width:100%;font-size:13px;">
                    <tr><td>X1 (WC/Assets)</td><td style="text-align:right;">${fmt(a.X1)}</td></tr>
                    <tr><td>X2 (RE/Assets)</td><td style="text-align:right;">${fmt(a.X2)}</td></tr>
                    <tr><td>X3 (EBIT/Assets)</td><td style="text-align:right;">${fmt(a.X3)}</td></tr>
                    <tr><td>X4 (Equity/Debt)</td><td style="text-align:right;">${fmt(a.X4)}</td></tr>
                    <tr><td>X5 (Sales/Assets)</td><td style="text-align:right;">${fmt(a.X5)}</td></tr>
                </table>
            </div>`).join("")}
        </div>
        <div style="background:#f0f4f8;padding:12px;border-radius:6px;font-size:13px;">
            <strong>Interpretazione ${z.last.anno}:</strong>
            ${z.last.score > 2.99 
                ? "‚úÖ Zona Sicura ‚Äì bassa probabilit√† d‚Äôinsolvenza"
                : z.last.score > 1.80 
                ? "‚ö†Ô∏è Zona Grigia ‚Äì rischio moderato" 
                : "‚ùå Zona Distress ‚Äì alto rischio d‚Äôinsolvenza"}
            <br><br>
            <strong>Trend:</strong>
            ${z.last.score > z.prev.score
                ? `üìà Miglioramento (+${(z.last.score - z.prev.score).toFixed(2)})`
                : `üìâ Peggioramento (${(z.last.score - z.prev.score).toFixed(2)})`}
        </div>
    `;
}


// ========== FUNZIONI UTILITY ==========
function calcVariazionePerc(valNew, valOld) {
    if (valOld === 0) return valNew > 0 ? '+‚àû' : valNew < 0 ? '-‚àû' : '‚Äî';
    const var_perc = ((valNew - valOld) / Math.abs(valOld)) * 100;
    return `${var_perc > 0 ? '+' : ''}${var_perc.toFixed(1)}%`;
}


// ========== FUNZIONI DI CALCOLO DATI (MANTIENI QUESTE!) ==========

// ============================================================
// üßæ RICLASSIFICAZIONE STATO PATRIMONIALE FINANZIARIO ESTESA
// ============================================================
window.riclassificazioneSPFinanziario = function () {
  try {
    const sp = window.extractStandardizedSP?.() || {};
    const spPrev = window.extractStandardizedSPPrev?.() || {};
    const tab = state?.tabelle || {};
    const parseNum = v => parseFloat(String(v || "0").replace(/\./g, "").replace(",", ".")) || 0;

    // === COSTRUISCE OGGETTO BASE ===
    const riclassificato = {
      anni: state?.anni || { prev: "N-1", last: "N" },

      // --- ATTIVO FISSO ---
      immImmateriali: sp.immImmateriali || 0,
      immMateriali: sp.immMateriali || 0,
      immFinanziarie: sp.immFinanziarie || 0,
      totaleAttivoFisso: sp.immobilizzazioni || 0,

      // --- ATTIVO CORRENTE ---
      rimanenze: sp.rimanenze || 0,
      creditiEntro12: sp.creditiEntro12 || 0,
      creditiOltre12: sp.creditiOltre12 || 0,
      disponibilitaLiquide: sp.disponibilitaLiquide || 0,
      rateiRiscontiAttivi: sp.rateiRiscontiAttivi || 0,
      totaleAttivoCorrente: sp.attivoCircolante + (sp.rateiRiscontiAttivi || 0),

      // --- PATRIMONIO NETTO ---
      capitale: sp.capitaleS || 0,
      riserve: sp.riserve || 0,
      utileEsercizio: sp.utileEsercizio || 0,
      totalePatrimonioNetto: sp.patrimonioNetto || 0,

      // --- PASSIVIT√Ä CONSOLIDATE (oltre 12 mesi) ---
      fondiRischiOneri: sp.fondiRischiOneri || 0,
      tfr: sp.tfr || 0,
      debitiFinanziariOltre: 0,
      debitiCommercialiOltre: 0,
      debitiTributariOltre: 0,
      debitiAltriOltre: 0,
      totalePassivitaConsolidate: 0,

      // --- PASSIVIT√Ä CORRENTI (entro 12 mesi) ---
      debitiFinanziariEntro: 0,
      debitiCommercialiEntro: 0,
      debitiTributariEntro: 0,
      debitiAltriEntro: 0,
      rateiRiscontiPassivi: sp.rateiRiscontiPassivi || 0,
      totalePassivitaCorrenti: 0,

      // --- TOTALI ---
      totaleImpieghi: 0,
      totaleFonti: 0,
      differenza: 0
    };

    // === 1Ô∏è‚É£ INTEGRA DATI DALLE TABELLE ceoDOC (DETTAGLIO SE DISPONIBILE) ===
    try {
      riclassificato.debitiFinanziariEntro = parseNum(tab.deb_e_fin_last);
      riclassificato.debitiFinanziariOltre = parseNum(tab.deb_o_fin_last);
      riclassificato.debitiCommercialiEntro = parseNum(tab.deb_e_comm_last);
      riclassificato.debitiCommercialiOltre = parseNum(tab.deb_o_comm_last);
      riclassificato.debitiTributariEntro = parseNum(tab.deb_e_trib_last || tab.deb_e_tribprev_last);
      riclassificato.debitiTributariOltre = parseNum(tab.deb_o_trib_last || tab.deb_o_tribprev_last);
      riclassificato.debitiAltriEntro = parseNum(tab.deb_e_altri_last);
      riclassificato.debitiAltriOltre = parseNum(tab.deb_o_altri_last);
    } catch (err) {
      console.warn("‚ö†Ô∏è Dettaglio tabelle non disponibile:", err);
    }

    // === 2Ô∏è‚É£ CALCOLA TOTALE ENTRO / OLTRE 12 MESI ===
    const totEntro =
      riclassificato.debitiFinanziariEntro +
      riclassificato.debitiCommercialiEntro +
      riclassificato.debitiTributariEntro +
      riclassificato.debitiAltriEntro;

    const totOltre =
      riclassificato.debitiFinanziariOltre +
      riclassificato.debitiCommercialiOltre +
      riclassificato.debitiTributariOltre +
      riclassificato.debitiAltriOltre;

    // === 3Ô∏è‚É£ FALLBACK AI TOTALI STANDARDIZZATI SE MANCANO DETTAGLI ===
    riclassificato.totalePassivitaCorrenti =
      totEntro || (sp.debitiEntro12 + (sp.rateiRiscontiPassivi || 0));

    riclassificato.totalePassivitaConsolidate =
      totOltre || (sp.debitiOltre12 + (sp.tfr || 0) + (sp.fondiRischiOneri || 0));

    // === 4Ô∏è‚É£ CALCOLA TOTALI E DIFFERENZA ===
    riclassificato.totaleImpieghi =
      riclassificato.totaleAttivoFisso + riclassificato.totaleAttivoCorrente;

    riclassificato.totaleFonti =
      riclassificato.totalePatrimonioNetto +
      riclassificato.totalePassivitaConsolidate +
      riclassificato.totalePassivitaCorrenti;

    riclassificato.differenza = Math.abs(
      (riclassificato.totaleImpieghi || 0) - (riclassificato.totaleFonti || 0)
    );

    // === 5Ô∏è‚É£ LOG / RETURN ===
    console.log("üìä SP Finanziario Riclassificato Esteso:", riclassificato);
    return riclassificato;
  } catch (err) {
    console.error("‚ùå Errore riclassificazioneSPFinanziario:", err);
    return {};
  }
};


function generaTabMargini() {
    // Prima mostra i MARGINI DI STRUTTURA
    const margini = riclassificazionePerMargini();
    
    let htmlMarginiStruttura = `
        <h3 style="color: #003d82;">Analisi per Margini di Struttura</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
            
            <!-- Margine di Struttura Primario -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4 style="color: #003d82;">Margine di Struttura Primario</h4>
                <table style="width: 100%;">
                    <tr><td>Patrimonio Netto</td><td style="text-align: right;">${itFmt(margini.patrimonioNetto)}</td></tr>
                    <tr><td>- Immobilizzazioni</td><td style="text-align: right;">-${itFmt(margini.immobilizzazioni)}</td></tr>
                    <tr style="font-weight: bold;"><td>= Margine</td><td style="text-align: right; color: ${margini.margineStrutturaPrimario >= 0 ? 'green' : 'red'}">${itFmt(margini.margineStrutturaPrimario)}</td></tr>
                    <tr><td>Quoziente</td><td style="text-align: right;">${margini.quozienteStrutturaPrimario.toFixed(2)}</td></tr>
                </table>
                <div style="margin-top: 10px; padding: 8px; background: ${margini.quozienteStrutturaPrimario >= 1 ? '#d4edda' : margini.quozienteStrutturaPrimario >= 0.7 ? '#fff3cd' : '#f8d7da'}; border-radius: 4px;">
                    ${margini.quozienteStrutturaPrimario >= 1 ? '‚úÖ Ottimo' : margini.quozienteStrutturaPrimario >= 0.7 ? '‚ö†Ô∏è Accettabile' : '‚ùå Critico'}
                </div>
            </div>
            
            <!-- Margine di Tesoreria -->
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                <h4 style="color: #003d82;">Margine di Tesoreria</h4>
                <table style="width: 100%;">
                    <tr><td>Liquidit√† Imm+Diff</td><td style="text-align: right;">${itFmt(margini.liquiditaImmediate + margini.liquiditaDifferite)}</td></tr>
                    <tr><td>- Passivo Corrente</td><td style="text-align: right;">-${itFmt(margini.passivoCorrente)}</td></tr>
                    <tr style="font-weight: bold;"><td>= Margine</td><td style="text-align: right; color: ${margini.margineTesoreria >= 0 ? 'green' : 'red'}">${itFmt(margini.margineTesoreria)}</td></tr>
                    <tr><td>Quick Ratio</td><td style="text-align: right;">${margini.quozienteTesoreria.toFixed(2)}</td></tr>
                </table>
                <div style="margin-top: 10px; padding: 8px; background: ${margini.quozienteTesoreria >= 1 ? '#d4edda' : margini.quozienteTesoreria >= 0.8 ? '#fff3cd' : '#f8d7da'}; border-radius: 4px;">
                    ${margini.quozienteTesoreria >= 1 ? '‚úÖ Ottimo' : margini.quozienteTesoreria >= 0.8 ? '‚ö†Ô∏è Accettabile' : '‚ùå Critico'}
                </div>
            </div>
        </div>
        
        <!-- CCN -->
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #003d82;">Capitale Circolante Netto (CCN)</h4>
            <table style="width: 60%; margin: 0 auto;">
                <tr><td>Attivo Circolante</td><td style="text-align: right;">${itFmt(margini.attivoCircolante)}</td></tr>
                <tr><td>- Passivo Corrente</td><td style="text-align: right;">-${itFmt(margini.passivoCorrente)}</td></tr>
                <tr style="font-weight: bold; font-size: 1.1em;"><td>= CCN Operativo</td><td style="text-align: right; color: ${margini.CCNoperativo >= 0 ? 'green' : 'red'}">${itFmt(margini.CCNoperativo)}</td></tr>
                <tr><td>Current Ratio</td><td style="text-align: right;">${margini.quozienteDisponibilita.toFixed(2)}</td></tr>
            </table>
            <div style="margin-top: 10px; padding: 8px; background: ${margini.quozienteDisponibilita >= 1.5 ? '#d4edda' : margini.quozienteDisponibilita >= 1.2 ? '#fff3cd' : '#f8d7da'}; border-radius: 4px; text-align: center;">
                ${margini.quozienteDisponibilita >= 1.5 ? '‚úÖ Liquidit√† Ottima' : margini.quozienteDisponibilita >= 1.2 ? '‚ö†Ô∏è Liquidit√† Accettabile' : '‚ùå Liquidit√† Critica'}
            </div>
        </div>
    `;
    
    // Poi aggiungi margine di contribuzione SE c'√® il break-even
    const breakeven = JSON.parse(localStorage.getItem(`breakeven_${state.cf}_${state.anni.last}`) || '{}');
    
    let htmlMargineContribuzione = '';
    if (breakeven.costiFissi && breakeven.costiVariabili) {
        const ce = extractStandardizedCE();
        const margineContribuzione = ce.ricaviVendite - breakeven.costiVariabili;
        const marginePerc = (margineContribuzione / ce.ricaviVendite) * 100;
        const risultatoOperativo = margineContribuzione - breakeven.costiFissi;
        const breakEvenPoint = breakeven.costiFissi / (marginePerc / 100);
        
        htmlMargineContribuzione = `
            <hr style="margin: 30px 0;">
            <h3 style="color: #003d82;">Margine di Contribuzione</h3>
            <table style="width: 70%; margin: 20px auto; border-collapse: collapse;">
                <tr style="background: #f0f4f8;">
                    <td style="padding: 10px;">Ricavi di vendita</td>
                    <td style="text-align: right;">${itFmt(ce.ricaviVendite)}</td>
                </tr>
                <tr>
                    <td style="padding: 10px;">- Costi Variabili</td>
                    <td style="text-align: right; color: red;">-${itFmt(breakeven.costiVariabili)}</td>
                </tr>
                <tr style="background: #e8f5e9;">
                    <td style="padding: 10px;"><strong>= MARGINE DI CONTRIBUZIONE</strong></td>
                    <td style="text-align: right;"><strong>${itFmt(margineContribuzione)} (${marginePerc.toFixed(1)}%)</strong></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">- Costi Fissi</td>
                    <td style="text-align: right; color: red;">-${itFmt(breakeven.costiFissi)}</td>
                </tr>
                <tr style="background: #fff3cd;">
                    <td style="padding: 10px;"><strong>= RISULTATO OPERATIVO</strong></td>
                    <td style="text-align: right; color: ${risultatoOperativo >= 0 ? 'green' : 'red'}">
                        <strong>${itFmt(risultatoOperativo)}</strong>
                    </td>
                </tr>
                <tr style="background: #f0f4f8;">
                    <td style="padding: 10px;"><strong>Break-Even Point</strong></td>
                    <td style="text-align: right;"><strong>${itFmt(breakEvenPoint)}</strong></td>
                </tr>
            </table>
            
            <div style="margin: 20px auto; padding: 15px; background: #e3f2fd; border-radius: 8px; max-width: 600px;">
                <strong>Analisi:</strong><br>
                ‚Ä¢ Margine di Sicurezza: ${((1 - breakEvenPoint/ce.ricaviVendite) * 100).toFixed(1)}%<br>
                ‚Ä¢ Per ogni ‚Ç¨ di ricavi: ${marginePerc.toFixed(2)}¬¢ di margine<br>
                ‚Ä¢ Punto di pareggio a: ‚Ç¨${itFmt(breakEvenPoint)}
            </div>
        `;
    } else {
        htmlMargineContribuzione = `
            <hr style="margin: 30px 0;">
            <h3 style="color: #003d82;">Margine di Contribuzione</h3>
            <p style="color: #666; text-align: center;">Per calcolare il margine di contribuzione devi prima configurare l'analisi break-even.</p>
            <div style="text-align: center; margin: 20px;">
                <button onclick="mostraBreakEven()" 
                        style="background: #003d82; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer;">
                    üìà Configura Break-Even
                </button>
            </div>
        `;
    }
    
    return htmlMarginiStruttura + htmlMargineContribuzione;
}

// ========== SALVA BREAK-EVEN AGGIORNATO ==========
// ==========================
// üíæ NUOVA VERSIONE 2025
// Salvataggio Break-Even completo (biennale)
// ==========================
window.salvaBreakeven = function () {
  try {
    // 1Ô∏è‚É£ Identificativi azienda/anni
    const cfKey = (state?.cf ?? state?.codiceFiscale ?? "NA").trim();
    const yPrev = state?.anni?.prev ?? "N-1";
    const yLast = state?.anni?.last ?? "N";
    if (!cfKey || cfKey === "NA") {
      toast("‚ö†Ô∏è Codice fiscale mancante: impossibile salvare", true);
      return;
    }

    // 2Ô∏è‚É£ Chiavi di salvataggio
    const keyMain = `ceodoc_breakeven_${cfKey}_${yPrev}_${yLast}`;
    const keyLegacy = `breakeven_${cfKey}_${yLast}`;

    // 3Ô∏è‚É£ Helper parsing numerico it-IT sicuro
    const parseIT = (v) => {
      if (v == null) return 0;
      const str = String(v)
        .replace(/\u00A0/g, " ")
        .replace(/[‚Ç¨\s]/g, "")
        .replace(/\./g, "")
        .replace(",", ".")
        .trim();
      const n = parseFloat(str);
      return Number.isFinite(n) ? n : 0;
    };

    // 4Ô∏è‚É£ Rileva quante righe ci sono
    const nPrev = document.querySelectorAll('[id^="be-perc-prev-"]').length;
    const nLast = document.querySelectorAll('[id^="be-perc-last-"]').length;
    const rowsCount = Math.max(nPrev, nLast, 9);

    // 5Ô∏è‚É£ Oggetto dati iniziale
    const dati = {
      cf: cfKey,
      anni: { prev: yPrev, last: yLast },
      timestamp: new Date().toISOString(),
      percentualiPrev: {},
      percentualiLast: {},
      costiFissiPrev: 0,
      costiVariabiliPrev: 0,
      costiFissiLast: 0,
      costiVariabiliLast: 0
    };

    // 6Ô∏è‚É£ Lettura riga per riga
    for (let i = 0; i < rowsCount; i++) {
      const percPrevEl = document.getElementById(`be-perc-prev-${i}`);
      const fissiPrevEl = document.getElementById(`be-fissi-prev-${i}`);
      const varPrevEl = document.getElementById(`be-var-prev-${i}`);

      const percLastEl = document.getElementById(`be-perc-last-${i}`);
      const fissiLastEl = document.getElementById(`be-fissi-last-${i}`);
      const varLastEl = document.getElementById(`be-var-last-${i}`);

      // PREV
      if (percPrevEl) dati.percentualiPrev[`perc_${i}`] = percPrevEl.value;
      if (fissiPrevEl) dati.costiFissiPrev += parseIT(fissiPrevEl.textContent);
      if (varPrevEl) dati.costiVariabiliPrev += parseIT(varPrevEl.textContent);

      // LAST
      if (percLastEl) dati.percentualiLast[`perc_${i}`] = percLastEl.value;
      if (fissiLastEl) dati.costiFissiLast += parseIT(fissiLastEl.textContent);
      if (varLastEl) dati.costiVariabiliLast += parseIT(varLastEl.textContent);
    }

    // 7Ô∏è‚É£ Arrotondamento a 2 decimali
    const r2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;
    dati.costiFissiPrev = r2(dati.costiFissiPrev);
    dati.costiVariabiliPrev = r2(dati.costiVariabiliPrev);
    dati.costiFissiLast = r2(dati.costiFissiLast);
    dati.costiVariabiliLast = r2(dati.costiVariabiliLast);

    // 8Ô∏è‚É£ Salvataggio principale
    localStorage.setItem(keyMain, JSON.stringify(dati));

    // 9Ô∏è‚É£ Salvataggio legacy (solo ultimo anno)
    localStorage.setItem(
      keyLegacy,
      JSON.stringify({
        costiFissi: dati.costiFissiLast,
        costiVariabili: dati.costiVariabiliLast,
        timestamp: dati.timestamp
      })
    );

    // üîü Conferma + log
    toast(`‚úÖ Break-even salvato per ${yPrev}‚Äì${yLast}`);
    console.log("üíæ Break-even salvato:", keyMain, dati);

    // Aggiorna totali
    if (typeof aggiornaTotali === "function") {
      setTimeout(() => aggiornaTotali(), 100);
    }

  } catch (err) {
    console.error("‚ùå Errore salvaBreakeven:", err);
    if (typeof toast === "function") toast("Errore nel salvataggio Break-even", true);
  }
};

// ========== FINE FUNZIONI DI CALCOLO ==========

// ========== FUNZIONI UTILITY MANCANTI ==========

// Formattazione italiana
window.itFmt = function(num) {
    if (!num && num !== 0) return '0';
    return parseFloat(num).toLocaleString('it-IT', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
};


// Input per Costo del Venduto
window.mostraInputCostoVenduto = function() {
    const modal = document.createElement('div');
    modal.id = 'modalInputCEV';
    modal.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 10001;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 600px;
        border-radius: 12px;
        padding: 30px;
    `;
    
    container.innerHTML = `
        <h3 style="color: #003d82;">Configura Percentuali Costo del Venduto</h3>
        <p>Inserisci le percentuali di ogni voce di costo destinata alla produzione:</p>
        
        <table style="width: 100%; margin: 20px 0;">
            <tr>
                <td>Materie Prime:</td>
                <td><input type="number" id="perc_materie" value="100" style="width: 60px;"> %</td>
            </tr>
            <tr>
                <td>Servizi:</td>
                <td><input type="number" id="perc_servizi" value="60" style="width: 60px;"> %</td>
            </tr>
            <tr>
                <td>Personale:</td>
                <td><input type="number" id="perc_personale" value="70" style="width: 60px;"> %</td>
            </tr>
            <tr>
                <td>Ammortamenti:</td>
                <td><input type="number" id="perc_ammortamenti" value="80" style="width: 60px;"> %</td>
            </tr>
        </table>
        
        <div style="text-align: center;">
            <button onclick="calcolaEMostraCEV()" 
                    style="background: #003d82; color: white; border: none; padding: 10px 30px; border-radius: 6px; margin-right: 10px;">
                Calcola
            </button>
            <button onclick="document.getElementById('modalInputCEV').remove()" 
                    style="background: #dc2626; color: white; border: none; padding: 10px 30px; border-radius: 6px;">
                Annulla
            </button>
        </div>
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);
};

// Calcola e mostra CEV nel tab
window.calcolaEMostraCEV = function() {
    const ce = extractStandardizedCE();
    
    const percMaterie = parseFloat(document.getElementById('perc_materie').value) / 100;
    const percServizi = parseFloat(document.getElementById('perc_servizi').value) / 100;
    const percPersonale = parseFloat(document.getElementById('perc_personale').value) / 100;
    const percAmm = parseFloat(document.getElementById('perc_ammortamenti').value) / 100;
    
    const costoVenduto = 
        (ce.materiePrime * percMaterie) +
        (ce.servizi * percServizi) +
        (ce.personale * percPersonale) +
        (ce.ammortamenti * percAmm);
    
    const margineLordo = ce.ricaviVendite - costoVenduto;
    
    // Aggiorna il tab CEV
    document.getElementById('risultatiCEV').innerHTML = `
        <table style="width: 80%; margin: 20px auto; border-collapse: collapse;">
            <tr style="background: #f0f4f8;">
                <td style="padding: 10px;"><strong>Ricavi Vendite</strong></td>
                <td style="text-align: right;">${itFmt(ce.ricaviVendite)}</td>
                <td style="text-align: right;">100%</td>
            </tr>
            <tr>
                <td style="padding: 10px;">- Costo del Venduto</td>
                <td style="text-align: right; color: red;">-${itFmt(costoVenduto)}</td>
                <td style="text-align: right;">${((costoVenduto/ce.ricaviVendite)*100).toFixed(1)}%</td>
            </tr>
            <tr style="background: #e8f5e9;">
                <td style="padding: 10px;"><strong>= Margine Lordo</strong></td>
                <td style="text-align: right;"><strong>${itFmt(margineLordo)}</strong></td>
                <td style="text-align: right;"><strong>${((margineLordo/ce.ricaviVendite)*100).toFixed(1)}%</strong></td>
            </tr>
        </table>
    `;
    
    // Chiudi modal input
    document.getElementById('modalInputCEV').remove();
    
    // Salva percentuali
    localStorage.setItem(`cev_perc_${state.cf}_${state.anni.last}`, JSON.stringify({
        materie: percMaterie,
        servizi: percServizi,
        personale: percPersonale,
        ammortamenti: percAmm
    }));
};

window.mostraIndiciAllerta = function () {
  try {
    const allerta = calcolaIndiciAllertaCrisi();

    // Overlay
    const modal = document.createElement('div');
    modal.id = 'modalAllerta';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Indici di Allerta Crisi');
    modal.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    `;

    // Card container
    const container = document.createElement('div');
    container.tabIndex = -1;
    container.style.cssText = `
      background: #fff;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      border-radius: 12px;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      outline: none;
    `;

    // Header + body
    container.innerHTML = `
      <div style="position:sticky; top:0; background:#003d82; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-radius:12px 12px 0 0;">
        <h2 style="margin:0; font-size:16px;">Indici di Allerta Crisi</h2>
        <button id="btnCloseAllerta"
                style="background:#dc2626; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
          Chiudi (Esc)
        </button>
      </div>
      <div style="padding:16px;">
        ${typeof generaHTMLAllertaCrisi === 'function' ? generaHTMLAllertaCrisi(allerta) : '<p>Nessun dettaglio disponibile.</p>'}
      </div>
    `;

    // Chiudi helpers
    const closeModal = () => {
      window.removeEventListener('keydown', onEsc);
      modal.removeEventListener('click', onBackdrop);
      if (document.getElementById('modalAllerta')) document.getElementById('modalAllerta').remove();
    };
    const onEsc = (ev) => { if (ev.key === 'Escape') closeModal(); };
    const onBackdrop = (ev) => { if (ev.target === modal) closeModal(); };

    // Bind events
    modal.addEventListener('click', onBackdrop);
    window.addEventListener('keydown', onEsc);
    modal.appendChild(container);
    document.body.appendChild(modal);

    // Focus la card per accessibilit√†
    setTimeout(() => container.focus(), 0);

    const btnClose = container.querySelector('#btnCloseAllerta');
    if (btnClose) btnClose.addEventListener('click', closeModal);
  } catch (e) {
    console.error('‚ùå mostraIndiciAllerta:', e);
    if (typeof toast === 'function') toast('Errore nella visualizzazione degli indici di allerta.', true);
  }
};

/* ====== FUNZIONI PLACEHOLDER ====== */
function wip(tag) {
    toast("Funzione in sviluppo: " + tag);
}

function openScoreAndamentale() {
    if (!hasFullLicense()) {
        toast("Tool abilitato solo con licenza FULL15", true);
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'scoreAndamentaleModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 30px;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        width: 98%;
        height: 95vh;
        max-height: calc(100vh - 40px);
        max-width: 1800px;
        border-radius: 12px;
        position: relative;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    `;
    
    const header = document.createElement('div');
    header.style.cssText = `
        padding: 12px 20px;
        background: #003d82;
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    `;
    header.innerHTML = `
        <h2 style="margin: 0; font-size: 18px;">Score Andamentale - Centrale Rischi</h2>
        <button onclick="closeScoreAndamentale()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
    `;
    
    const iframeContainer = document.createElement('div');
    iframeContainer.style.cssText = `
        flex: 1;
        overflow: hidden;
        border-radius: 0 0 12px 12px;
    `;
    
    const iframe = document.createElement('iframe');
    iframe.src = '../centralerischi/anacrisk.html';
    iframe.style.cssText = `
        width: 100%;
        height: 100%;
        border: none;
    `;
    
    iframe.onload = function() {
        try {
            const context = {
                type: 'ceodoc.context',
                appId: 'anacrisk',
                sessionToken: localStorage.getItem('ceodoc_session'),
                license: JSON.parse(localStorage.getItem('ceodoc_licenza') || 'null'),
                licenseInfo: JSON.parse(localStorage.getItem('ceodoc_licenza_info') || 'null'),
                azienda: JSON.parse(localStorage.getItem('ceodoc_anagrafica_attiva') || 'null'),
                version: '2.0'
            };
            iframe.contentWindow.postMessage(context, '*');
        } catch(e) {}
    };
    
    iframeContainer.appendChild(iframe);
    modalContent.appendChild(header);
    modalContent.appendChild(iframeContainer);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    document.addEventListener('keydown', closeOnEsc);
}

function closeScoreAndamentale() {
    const modal = document.getElementById('scoreAndamentaleModal');
    if (modal) {
        modal.remove();
        document.removeEventListener('keydown', closeOnEsc);
    }
}

function closeOnEsc(e) {
    if (e.key === 'Escape') {
        closeScoreAndamentale();
    }
}

window.closeScoreAndamentale = closeScoreAndamentale;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BLOCCO 1: MODALE 3 - SCORING CREDITIZIO ceoDOC
// Pattern coerente con openScoreAndamentale()
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcTrendYoY(valueLast, valuePrev) {
  if (!valuePrev || valuePrev === 0) return 0;
  return ((valueLast - valuePrev) / Math.abs(valuePrev)) * 100;
}

function formatNumeroITA(num) {
  if (num === null || num === undefined) return '‚Äî';
  return num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function loadDataScoringceoDOC() {
  try {
    const anagrafica = JSON.parse(localStorage.getItem('ceodoc_anagrafica_attiva') || 'null');
    if (!anagrafica) {
      console.error('anagrafica_attiva non trovata');
      return null;
    }

    const cf = anagrafica.cf || window.state?.cf;
    const settore = anagrafica.settore || window.state?.settore;
    const codiceAteco = anagrafica.codiceAteco || window.state?.codiceAteco;

    const anni = window.state?.anni || {};
    const yearPrev = anni.prev;
    const yearLast = anni.last;

    if (!yearPrev || !yearLast) {
      console.error('Anni non trovati');
      return null;
    }

    const keyElaborazioni = `ceodoc_elaborazioni_${cf}_${yearPrev}_${yearLast}`;
    const elaborazioni = JSON.parse(localStorage.getItem(keyElaborazioni) || 'null');
    if (!elaborazioni) {
      console.error(`Elaborazioni non trovate: ${keyElaborazioni}`);
      return null;
    }

    // Leggi Score EF e A
    const keyScoreEF = `ceodoc_scoref_${cf}_${yearPrev}_${yearLast}`;
    const scoreEF = JSON.parse(localStorage.getItem(keyScoreEF) || 'null');
    const scoreEFvalue = scoreEF?.scoreEF || null;

    const keyScoreA = `ceodoc_scorea_${cf}_${yearPrev}_${yearLast}`;
    const scoreA = JSON.parse(localStorage.getItem(keyScoreA) || 'null');
    const scoreAvalue = scoreA?.scoreA || null;

    // Indici operativi
    const indiciLast = elaborazioni.indici?.last || {};
    const indiciPrev = elaborazioni.indici?.prev || {};

    const dioLast = indiciLast.giorniMagazzino || 0;
    const dioPrev = indiciPrev.giorniMagazzino || 0;
    const dioDelta = calcTrendYoY(dioLast, dioPrev);

    const dsoLast = indiciLast.giorniCrediti || 0;
    const dsoPrev = indiciPrev.giorniCrediti || 0;
    const dsoDelta = calcTrendYoY(dsoLast, dsoPrev);

    const dpoLast = indiciLast.giorniDebiti || 0;
    const dpoPrev = indiciPrev.giorniDebiti || 0;
    const dpoDelta = calcTrendYoY(dpoLast, dpoPrev);

    const cccLast = dioLast + dsoLast - dpoLast;
    const cccPrev = dioPrev + dsoPrev - dpoPrev;
    const cccDelta = cccLast - cccPrev;

    // Crescita
    const prodLast = elaborazioni.produttivita?.last || {};
    const prodPrev = elaborazioni.produttivita?.prev || {};

    const fatturatLast = prodLast.ricavi || 0;
    const fatturatPrev = prodPrev.ricavi || 0;
    const fatturatDelta = calcTrendYoY(fatturatLast, fatturatPrev);

    const addettiLast = prodLast.addetti || 0;
    const addettiPrev = prodPrev.addetti || 0;
    const addettiDelta = calcTrendYoY(addettiLast, addettiPrev);

    const roiLast = elaborazioni.indici?.last?.roi || 0;
    const roiPrev = elaborazioni.indici?.prev?.roi || 0;
    const roiDelta = calcTrendYoY(roiLast, roiPrev);

    const roeLast = elaborazioni.indici?.last?.roe || 0;
    const roePrev = elaborazioni.indici?.prev?.roe || 0;

    const zscore = elaborazioni.zscore || { last: { score: 0, classificazione: 'N.D.' }, prev: {} };
    const dscr = elaborazioni.dscr || { last: { ratio: 0 }, prev: {} };

    return {
      cf: cf,
      anagrafica: anagrafica.ragioneSociale || 'N.D.',
      settore: settore,
      ateco: codiceAteco,
      anni: { prev: yearPrev, last: yearLast },
      scoreEF: scoreEFvalue,
      scoreA: scoreAvalue,
      indici: {
        dio: { last: dioLast, prev: dioPrev, delta: dioDelta },
        dso: { last: dsoLast, prev: dsoPrev, delta: dsoDelta },
        dpo: { last: dpoLast, prev: dpoPrev, delta: dpoDelta },
        ccc: { last: cccLast, prev: cccPrev, deltAbs: cccDelta }
      },
      crescita: {
        fatturato: { last: fatturatLast, prev: fatturatPrev, delta: fatturatDelta },
        addetti: { last: addettiLast, prev: addettiPrev, delta: addettiDelta },
        roi: { last: roiLast, prev: roiPrev, delta: roiDelta },
        roe: { last: roeLast, prev: roePrev }
      },
      zscore: zscore.last?.score || 0,
      zscoreClass: zscore.last?.classificazione || 'N.D.',
      dscr: dscr.last?.ratio || 0,
      elaborazioni: elaborazioni
    };

  } catch (err) {
    console.error('Errore in loadDataScoringceoDOC():', err);
    return null;
  }
}

function openScoreAziendaleceoDOC() {
  if (!hasFullLicense()) {
    toast("Tool abilitato solo con licenza FULL15", true);
    return;
  }

  const dati = loadDataScoringceoDOC();
  if (!dati) {
    toast("Errore: Dati insufficienti. Verifica bilancio importato.", true);
    return;
  }


  const modal = document.createElement('div');
  modal.id = 'scoringceoDOCModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 30px;
  `;

  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    width: 98%;
    height: 95vh;
    max-height: calc(100vh - 40px);
    max-width: 1800px;
    border-radius: 12px;
    position: relative;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  `;

  const header = document.createElement('div');
  header.style.cssText = `
    padding: 12px 20px;
    background: #003d82;
    color: white;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  `;
  header.innerHTML = `
    <div>
      <h2 style="margin: 0 0 5px 0; font-size: 18px;">Score Aziendale ceoDOC - Valutazione Integrata</h2>
      <p style="margin: 0; font-size: 12px; opacity: 0.9;">
        <strong>${dati.anagrafica}</strong> (CF: ${dati.cf}) | Settore: ${dati.settore} | Bilancio ${dati.anni.prev}-${dati.anni.last}
      </p>
    </div>
    <button onclick="closeScoreAziendaleceoDOC()" style="
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
       onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
  `;

  // TAB BUTTONS
const tabsNavContainer = document.createElement('div');
  tabsNavContainer.style.cssText = `
    display: flex;
    width: 100%;
    background: #f5f5f5;
    border-bottom: 2px solid #ddd;
    flex-shrink: 0;
    gap: 0;
    box-sizing: border-box;
  `;

  const tabs = [
    { 
      id: 'tab1', 
      label: 'TAB 1: Matrice MCC',
      svg: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:6px;"><path d="M3,3H7V7H3V3M9,3H13V7H9V3M15,3H19V7H15V3M21,3H24V7H21V3M3,9H7V13H3V9M9,9H13V13H9V9M15,9H19V13H15V9M21,9H24V13H21V9M3,15H7V19H3V15M9,15H13V19H9V15M15,15H19V19H15V15M21,15H24V19H21V15M3,21H7V24H3V21M9,21H13V24H9V21M15,21H19V24H15V21M21,21H24V24H21V21Z"/></svg>'
    },
    { 
      id: 'tab2', 
      label: 'TAB 2: Questionario',
      svg: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:6px;"><path d="M4,4H20V8H4V4M4,10H20V14H4V10M4,16H16V20H4V16M18,16H20V18H18V16M18,19H20V21H18V19M7,6H5V8H7V6M7,12H5V14H7V12M7,18H5V20H7V18Z"/></svg>'
    },
    { 
      id: 'tab3', 
      label: 'TAB 3: Penalizzazioni',
      svg: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:6px;"><path d="M1,21H23L12,2L1,21M13,18H11V16H13V18M13,14H11V10H13V14M12,5.75L6.5,19H17.5L12,5.75Z"/></svg>'
    },
    { 
      id: 'tab4', 
      label: 'TAB 4: Scoring Finale',
      svg: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:6px;"><path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M16.3,12.5L11,17.8L7.7,14.5L9.1,13.1L11,15L14.9,11.1L16.3,12.5Z"/></svg>'
    }
  ];

  tabs.forEach((tab, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tabBtnceoDOC';
    btn.dataset.tab = tab.id;
    btn.innerHTML = tab.svg + tab.label;

// TOGLI COMPLETAMENTE btn.style.cssText
// I button vengono stilizzati SOLO dal CSS della classe

    console.log('BUTTON CREATO:', {
      className: btn.className,
      hasInlineStyle: btn.style.cssText,
      computedColor: window.getComputedStyle(btn).color
    });

   btn.onclick = (e) => showTabceoDOC(tab.id, e);
    tabsNavContainer.appendChild(btn);
  });

  // TAB CONTENTS
  const contentsContainer = document.createElement('div');
  contentsContainer.style.cssText = `
    flex: 1;
    overflow: auto;
    padding: 20px;
  `;

  const tab1Content = document.createElement('div');
  tab1Content.id = 'tab1ceoDOC';
  tab1Content.className = 'tabContentceoDOC';
  tab1Content.style.display = 'block';
  tab1Content.innerHTML = '<p>Caricamento TAB 1...</p>';

  const tab2Content = document.createElement('div');
  tab2Content.id = 'tab2ceoDOC';
  tab2Content.className = 'tabContentceoDOC';
  tab2Content.style.display = 'none';
  tab2Content.innerHTML = '<p>Caricamento TAB 2...</p>';

  const tab3Content = document.createElement('div');
  tab3Content.id = 'tab3ceoDOC';
  tab3Content.className = 'tabContentceoDOC';
  tab3Content.style.display = 'none';
  tab3Content.innerHTML = '<p>Caricamento TAB 3...</p>';

  const tab4Content = document.createElement('div');
  tab4Content.id = 'tab4ceoDOC';
  tab4Content.className = 'tabContentceoDOC';
  tab4Content.style.display = 'none';
  tab4Content.innerHTML = '<p>Caricamento TAB 4...</p>';

  contentsContainer.appendChild(tab1Content);
  contentsContainer.appendChild(tab2Content);
  contentsContainer.appendChild(tab3Content);
  contentsContainer.appendChild(tab4Content);

  modalContent.appendChild(header);
  modalContent.appendChild(tabsNavContainer);
  modalContent.appendChild(contentsContainer);
  modal.appendChild(modalContent);
document.body.appendChild(modal);

// Forza un paint immediato del modale appena aggiunto
modal.style.display = 'none';
modal.offsetHeight;            // triggera reflow
modal.style.display = 'flex';  // ri-mostra correttamente

// Forza anche un repaint globale (equivalente all‚Äôapertura di F12)
window.dispatchEvent(new Event('resize'));

// Hack GPU per ridisegnare i bottoni (risolve il bordo non aggiornato)
document.querySelectorAll('.tabBtnceoDOC').forEach(btn => {
  btn.style.willChange = 'transform';
  btn.style.transform = 'translateZ(0)';
});

// üíæ Salva dati globali
window.datiScoringceoDOC = dati;

// ‚å®Ô∏è Chiudi con ESC
const handleEsc = (e) => {
  if (e.key === 'Escape') {
    closeScoreAziendaleceoDOC();
    document.removeEventListener('keydown', handleEsc);
  }
};
document.addEventListener('keydown', handleEsc);

// üñ±Ô∏è Chiudi cliccando fuori dal modale
modal.onclick = (e) => {
  if (e.target === modal) {
    closeScoreAziendaleceoDOC();
    document.removeEventListener('keydown', handleEsc);
  }
};
}

function showTabceoDOC(tabName, evt) {
    document.querySelectorAll('.tabBtnceoDOC').forEach(tab => {
        tab.classList.remove('active');
    });
    
    if (evt && evt.target) {
        evt.target.classList.add('active');
        void evt.target.offsetHeight;
    } else {
        const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
        if (tabButton) {
            tabButton.classList.add('active');
            void tabButton.offsetHeight;
        }
    }
    
    document.querySelectorAll('.tabContentceoDOC').forEach(area => {
        area.classList.remove('active');
    });
    
    const contentArea = document.getElementById(tabName + 'ceoDOC');
    if (contentArea) {
        void contentArea.offsetHeight;
        contentArea.classList.add('active');
    }
}

window.showTabceoDOC = showTabceoDOC;

function closeScoreAziendaleceoDOC() {
  const modal = document.getElementById('scoringceoDOCModal');
  if (modal) {
    modal.remove();
    if (window.datiScoringceoDOC) {
      delete window.datiScoringceoDOC;
    }
  }
}

window.closeScoreAziendaleceoDOC = closeScoreAziendaleceoDOC;

// =====================================================
// üé≤ SIMULAZIONE MONTE CARLO PRO ‚Äì ANALISI RISCHIO ceoDOC
// =====================================================
window.eseguiMonteCarloSimulationPro = function () {
  try {
    if (!state?.ceRows?.length || !state?.spRows?.length) {
      toast("‚ö†Ô∏è Importa prima un bilancio per la simulazione Monte Carlo.", true);
      return {};
    }

    // === DATI DI BASE DAL BILANCIO ===
    const ce = extractStandardizedCE?.() || {};
    const sp = extractStandardizedSP?.() || {};
    const ind = window.calcolaIndiciComplessivi?.() || {};

    const ricaviBase = ce.ricaviVendite || ce.valoreProduzione || 0;
    const costiBase = ce.costiProduzione || 0;
    const ebitdaBase = ind.MOL || (ricaviBase - costiBase) * 0.15;
    const debitiBase = sp.totalePassivo - sp.patrimonioNetto;
    const servizioDebito = debitiBase * 0.15; // ipotesi: 15% debito annuo

    // === PARAMETRI STATISTICI ===
    const simulazioni = 10000;
    const volRicavi = 0.12; // ¬±12% variazione ricavi
    const volCosti = 0.08;  // ¬±8% variazione costi
    const correlazione = 0.7; // correlazione ricavi-costi

    const risultati = [];

    // === ESECUZIONE SIMULAZIONE ===
    for (let i = 0; i < simulazioni; i++) {
      // Generazione casuale con distribuzione normale (Box‚ÄìMuller)
      let u = Math.random(), v = Math.random();
      const zRicavi = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
      const zCosti = correlazione * zRicavi + Math.sqrt(1 - correlazione ** 2) * (Math.random() - 0.5) * 2;

      // Ricavi e costi simulati
      const ricavi = ricaviBase * (1 + volRicavi * zRicavi);
      const costi = costiBase * (1 + volCosti * zCosti);
      const ebitda = ricavi - costi;
      const dscr = servizioDebito > 0 ? ebitda / servizioDebito : 0;
      const utile = ebitda - (sp.oneriFinanziari || 0) - (ce.imposte || 0);

      risultati.push({
        ricavi,
        costi,
        ebitda,
        dscr,
        utile,
        default: dscr < 1.0,
        crisi: dscr < 1.1 || utile < 0,
        eccellente: dscr > 1.5 && ebitda > ebitdaBase * 1.1
      });
    }

    // === FUNZIONI STATISTICHE ===
    const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
    const percentile = (arr, p) => {
      const sorted = arr.slice().sort((a, b) => a - b);
      const idx = Math.floor((p / 100) * sorted.length);
      return sorted[Math.max(0, Math.min(idx, sorted.length - 1))];
    };

    // === ANALISI RISULTATI ===
    const ebitdaVals = risultati.map(r => r.ebitda);
    const dscrVals = risultati.map(r => r.dscr);

    const output = {
      probDefault: (risultati.filter(r => r.default).length / simulazioni * 100).toFixed(1),
      probCrisi: (risultati.filter(r => r.crisi).length / simulazioni * 100).toFixed(1),
      probEccellente: (risultati.filter(r => r.eccellente).length / simulazioni * 100).toFixed(1),

      ebitda: {
        medio: mean(ebitdaVals),
        best: percentile(ebitdaVals, 95),
        worst: percentile(ebitdaVals, 5)
      },
      dscr: {
        medio: mean(dscrVals),
        best: percentile(dscrVals, 95),
        worst: percentile(dscrVals, 5)
      },

      // === TESTO UMANO ===
      descrizione: `
üìä Simulazione Monte Carlo (10.000 scenari)
‚Ä¢ Probabilit√† di Default: ${(risultati.filter(r => r.default).length / simulazioni * 100).toFixed(1)}%
‚Ä¢ Probabilit√† di Crisi di Liquidit√†: ${(risultati.filter(r => r.crisi).length / simulazioni * 100).toFixed(1)}%
‚Ä¢ Scenario Migliore (EBITDA 95¬∞): ‚Ç¨${percentile(ebitdaVals, 95).toLocaleString("it-IT")}
‚Ä¢ Scenario Peggiore (EBITDA 5¬∞): ‚Ç¨${percentile(ebitdaVals, 5).toLocaleString("it-IT")}

Un valore di ‚ÄúProbabilit√† di Default‚Äù superiore al 30% indica vulnerabilit√† finanziaria.
Un DSCR medio superiore a 1.3 riflette una buona capacit√† di rimborso.
Un EBITDA stabile e positivo rappresenta una base solida per la crescita futura.
`
    };

    console.log("üé≤ Monte Carlo Simulation Results:", output);
    return output;

  } catch (err) {
    console.error("‚ùå Errore eseguiMonteCarloSimulationPro:", err);
    toast("Errore durante la simulazione Monte Carlo", true);
    return {};
  }
};

// ============================================================
// üíæ BACKUP VISIVO ANALISI COMPLETA (copia l'HTML attuale)
// ============================================================
window.backupAnalisiCompleta = function() {
  try {
    // Cattura il contenuto visibile della pagina
    const sorgente = document.body.innerHTML;
    const dataAnalisi = new Date().toLocaleString("it-IT");

    // Apri nuova finestra
    const reportWin = window.open("", "_blank");
    if (!reportWin) {
      toast("‚ùå Popup bloccato. Abilita finestre per ceoDOC.", true);
      return;
    }

    // Scrivi il backup
    reportWin.document.write(`
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Backup Analisi ‚Äì ceoDOC</title>
<style>
body {font-family:'Segoe UI',Arial,sans-serif;line-height:1.5;margin:20px;}
header, footer {background:#003d82;color:white;padding:10px;}
section {margin-top:20px;}
</style>
</head>
<body>
<header><h2>üìÑ Backup Analisi Completa ‚Äì ceoDOC</h2>
<p>Generata il ${dataAnalisi}</p></header>
<section>${sorgente}</section>
<footer><p>Backup HTML generato da ceoDOC v2.0 ‚Äì ${dataAnalisi}</p></footer>
</body>
</html>
    `);
    reportWin.document.close();

  } catch (err) {
    console.error("‚ùå Errore backupAnalisiCompleta:", err);
    toast("Errore durante la generazione del backup", true);
  }
};



// =============================================================
// üìò GENERA ANALISI COMPLETA ‚Äì VERSIONE ANTI-CRASH PROFESSIONALE
// =============================================================
// ============================================================
// üü© BLOCCO 1 ‚Äì NOTA METODOLOGICA E OBIETTIVI DELL‚ÄôANALISI
// ============================================================

function generaBlocco1_NoteMetodologica() {
  try {
    // === DATI BASE DINAMICI ===
    const azienda = {
      nome: state?.denom || "Impresa",
      cf: state?.cf || "‚Äî",
      settore: state?.settore || "‚Äî",
      tipo: state?.tipo || "‚Äî",
      anni: state?.anni || { prev: "N-1", last: "N" },
      dataAnalisi: new Date().toLocaleDateString("it-IT"),
    };

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üìò 1. Nota Metodologica e Obiettivi dell‚ÄôAnalisi</h2>

      <p>
        L‚Äôanalisi √® stata elaborata attraverso il sistema <b>ceoDOC ‚Äì Business Intelligence Platform</b>,
        che consente di standardizzare, riclassificare e interpretare i dati contabili dei bilanci d‚Äôesercizio.
      </p>

      <p>
        I bilanci originali (in formato XBRL o XLS) vengono convertiti in un modello
        <b>standardizzato e omogeneo</b>, al fine di permettere il confronto nel tempo
        e tra imprese dello stesso settore.
      </p>

      <p>
        Successivamente vengono calcolate in modo automatico:
        <ul>
          <li>le <b>riclassificazioni di bilancio</b> (a costo del venduto, a valore aggiunto,
              a margine di contribuzione, stato patrimoniale e rendiconto finanziario);</li>
          <li>gli <b>indici economici, patrimoniali e finanziari</b> che misurano redditivit√†, solidit√†,
              liquidit√† e produttivit√†;</li>
          <li>gli <b>indicatori di allerta crisi</b> e i modelli di sostenibilit√† (<b>DSCR</b> e <b>Z-Score</b>);</li>
          <li>il <b>Rating MCC</b> basato su <b>Score Economico-Finanziario</b> e <b>Score Andamentale</b>;</li>
          <li>la <b>simulazione Monte Carlo</b> che analizza la resilienza dell‚Äôimpresa in scenari di stress finanziario.</li>
        </ul>
      </p>

      <p>
        L‚Äôobiettivo √® fornire una <b>valutazione integrata della salute aziendale</b>
        sotto i profili economico, patrimoniale e finanziario, spiegando in modo chiaro
        i risultati e le cause delle aree di forza o di attenzione.
      </p>

      <h3>‚öôÔ∏è Dati di riferimento</h3>
      <table>
        <tr><th>Impresa</th><td>${azienda.nome}</td></tr>
        <tr><th>Codice Fiscale</th><td>${azienda.cf}</td></tr>
        <tr><th>Settore</th><td>${azienda.settore}</td></tr>
        <tr><th>Tipo bilancio</th><td>${azienda.tipo}</td></tr>
        <tr><th>Bilanci analizzati</th><td>${azienda.anni.prev} ‚Äì ${azienda.anni.last}</td></tr>
        <tr><th>Data analisi</th><td>${azienda.dataAnalisi}</td></tr>
      </table>

      <h3>üß† Distinzione tra analisi fissa e monitoraggio dinamico</h3>
      <p>
        CeoDOC distingue due livelli di analisi:
        <ul>
          <li><b>Analisi statica</b> (bilanci consuntivi): fotografia della gestione economico-finanziaria;</li>
          <li><b>Analisi dinamica</b> (andamentale CR): aggiornamento trimestrale sui dati creditizi
              per monitorare l‚Äôevoluzione della solvibilit√† e del rating MCC.</li>
        </ul>
      </p>
      <p>
        Tramite il pulsante <b>üîÑ Aggiorna Analisi (CR)</b> √® possibile mantenere invariata la base di bilancio
        ma aggiornare lo Score Andamentale e il Rating MCC in base ai dati pi√π recenti di Centrale Rischi.
      </p>

      <h3>üè¶ Dati andamentali e trasparenza CR</h3>
      <p>
        I dati andamentali (Centrale Rischi, CRIF, CERVED) sono pubblicati da Banca d‚ÄôItalia con un ritardo
        medio di <b>60 giorni</b>. L‚Äôutente pu√≤ scegliere se:
        <ul>
          <li>utilizzare l‚Äô<b>ultima CR disponibile</b> (pubblicata ufficialmente); oppure</li>
          <li>indicare un <b>periodo manuale</b> se dispone di dati aggiornati tramite il proprio istituto di credito.</li>
        </ul>
        CeoDOC riporta sempre nel report il <b>mese effettivo di ultimo aggiornamento</b> e la <b>modalit√† di rilevazione</b> (automatica o manuale).
      </p>

      <h3>üóÇÔ∏è Struttura del rapporto</h3>
      <p>
        L‚Äôanalisi √® composta da 14 sezioni:
      </p>
      <ol>
        <li>Nota metodologica e obiettivi</li>
        <li>Analisi a costo del venduto</li>
        <li>Analisi a valore aggiunto</li>
        <li>Analisi a margine di contribuzione</li>
        <li>Analisi Break-Even</li>
        <li>Rendiconto finanziario e stato patrimoniale finanziario</li>
        <li>Analisi per indici</li>
        <li>Indici di allerta crisi</li>
        <li>Analisi DSCR e Z-Score</li>
        <li>Rating MCC</li>
        <li>Analisi scenari probabilistici (Monte Carlo)</li>
        <li>Conclusioni e suggerimenti</li>
        <li>Executive Summary</li>
        <li>Allegati tecnici e chiusura</li>
      </ol>

      <div class="alert alert-info" style="margin-top:20px;">
        <b>Nota:</b> I bilanci standardizzati (Stato Patrimoniale e Conto Economico)
        e le relative tabelle di dettaglio sono ottenuti dalle funzioni <code>window.mostraCompilaTables()</code>
        e <code>renderTables()</code> per garantire coerenza e tracciabilit√† dei dati analizzati.
      </div>

      <p style="margin-top:20px;color:#444;">
        <i>
        Questa sezione definisce la metodologia, le fonti dati e gli obiettivi dell‚Äôanalisi,
        fornendo il quadro di riferimento per le sezioni successive.
        </i>
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco1_NoteMetodologica:", err);
    return `<div class='alert alert-danger'>Errore durante la generazione della sezione metodologica.</div>`;
  }
}

// ============================================================
// üüß BLOCCO 2 ‚Äì ANALISI A COSTO DEL VENDUTO
// ============================================================

function generaBlocco2_CostoVenduto() {
  try {
    // === Estrae dati dal Conto Economico standardizzato ===
    const ceLast = window.extractStandardizedCE?.() || {};
    const cePrev = window.extractStandardizedCEPrev?.() || {};
    const ricavi = ceLast.ricaviVendite || 0;
    const ricaviPrev = cePrev.ricaviVendite || 0;
    const materie = ceLast.materiePrime || 0;
    const materiePrev = cePrev.materiePrime || 0;
    const servizi = ceLast.servizi || 0;
    const serviziPrev = cePrev.servizi || 0;

    // === Calcoli principali ===
    const costoVenduto = materie + servizi;
    const costoVendutoPrev = materiePrev + serviziPrev;
    const margineIndustriale = ricavi - costoVenduto;
    const marginePrev = ricaviPrev - costoVendutoPrev;
    const incidenzaCosti = (costoVenduto / ricavi) * 100 || 0;
    const marginePerc = (margineIndustriale / ricavi) * 100 || 0;
    const variazioneMargine =
      marginePrev && marginePrev !== 0
        ? ((margineIndustriale - marginePrev) / Math.abs(marginePrev)) * 100
        : 0;

    // === Giudizio automatico ===
    let giudizio = "";
    if (marginePerc >= 30) giudizio = "üü¢ Impresa solida: ottima efficienza produttiva e costi sotto controllo.";
    else if (marginePerc >= 25) giudizio = "üü° Impresa media: margine in linea con il settore, ma da monitorare.";
    else giudizio = "üî¥ Impresa critica: margine sotto il 25 %, necessaria revisione dei costi di produzione.";

    // === Costruzione tabella dati ===
    let html = `
    <div class="section">
      <h2>üüß 2. Analisi a Costo del Venduto</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi a <b>costo del venduto</b> misura l‚Äôefficienza industriale e il grado di controllo
        sui <b>costi diretti</b> di produzione. Serve a capire quanta parte dei ricavi viene assorbita
        da materie prime, merci e servizi esterni, e quanto valore l‚Äôimpresa riesce a trattenere.
      </p>

      <h3>üìä Dati sintetici</h3>
      <table>
        <tr><th>Voce</th><th>Valore ${state?.anni?.last || "Anno N"}</th><th>Incidenza su ricavi</th></tr>
        <tr><td>Ricavi delle vendite</td><td style="text-align:right;">${itFmt(ricavi)}</td><td style="text-align:right;">100 %</td></tr>
        <tr><td>Costi materie prime e merci</td><td style="text-align:right;">${itFmt(materie)}</td><td style="text-align:right;">${(materie/ricavi*100).toFixed(1)} %</td></tr>
        <tr><td>Costi per servizi</td><td style="text-align:right;">${itFmt(servizi)}</td><td style="text-align:right;">${(servizi/ricavi*100).toFixed(1)} %</td></tr>
        <tr style="font-weight:bold;background:#f0f4f8;">
          <td>Margine industriale</td>
          <td style="text-align:right;">${itFmt(margineIndustriale)}</td>
          <td style="text-align:right;">${marginePerc.toFixed(1)} %</td>
        </tr>
      </table>

      <h3>üìà Andamento biennale</h3>
      <table>
        <tr><th>Voce</th><th>${state?.anni?.prev || "N-1"}</th><th>${state?.anni?.last || "N"}</th><th>Œî %</th></tr>
        <tr><td>Ricavi vendite</td><td style="text-align:right;">${itFmt(ricaviPrev)}</td><td style="text-align:right;">${itFmt(ricavi)}</td><td style="text-align:right;">${(((ricavi-ricaviPrev)/ricaviPrev)*100||0).toFixed(1)} %</td></tr>
        <tr><td>Costi materie e servizi</td><td style="text-align:right;">${itFmt(costoVendutoPrev)}</td><td style="text-align:right;">${itFmt(costoVenduto)}</td><td style="text-align:right;">${(((costoVenduto-costoVendutoPrev)/costoVendutoPrev)*100||0).toFixed(1)} %</td></tr>
        <tr><td>Margine industriale</td><td style="text-align:right;">${itFmt(marginePrev)}</td><td style="text-align:right;">${itFmt(margineIndustriale)}</td><td style="text-align:right;">${variazioneMargine.toFixed(1)} %</td></tr>
      </table>

      <div class="alert ${marginePerc>=30?"alert-success":marginePerc>=25?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizio}
      </div>

      <h3>üßÆ Indicatori di efficienza</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Costo del venduto / Ricavi</td><td>(Materie+Servizi)/Ricavi</td><td>‚â§ 70 %</td><td style="text-align:right;">${incidenzaCosti.toFixed(1)} %</td><td>${incidenzaCosti<=70?"üü¢ Buono":incidenzaCosti<=80?"üü° Accettabile":"üî¥ Alto"}</td></tr>
        <tr><td>Margine industriale / Ricavi</td><td>1 ‚Äì (CV/Ricavi)</td><td>‚â• 30 %</td><td style="text-align:right;">${marginePerc.toFixed(1)} %</td><td>${marginePerc>=30?"üü¢ Ottimo":marginePerc>=25?"üü° Medio":"üî¥ Basso"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e utilit√†</h3>
      <ul>
        <li>Tabella ‚ÄúConto Economico Riclassificato ‚Äì Costo del Venduto‚Äù ‚Üí <b>Allegato 2</b></li>
        <li>Grafico ‚ÄúTrend Margine Industriale e Costo del Venduto‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p style="margin-top:10px;">
        Questa analisi consente di determinare il <b>livello di efficienza produttiva</b> e di individuare
        tempestivamente variazioni nei costi diretti che possono incidere su EBITDA, ROI e Rating MCC.
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco2_CostoVenduto:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Costo del Venduto.</div>`;
  }
}

// ============================================================
// üü® BLOCCO 3 ‚Äì ANALISI A VALORE AGGIUNTO
// ============================================================

function generaBlocco3_ValoreAggiunto() {
  try {
    // === Estrae dati dal Conto Economico standardizzato ===
    const ceLast = window.extractStandardizedCE?.() || {};
    const cePrev = window.extractStandardizedCEPrev?.() || {};

    // === Variabili principali ===
    const ricavi = ceLast.ricaviVendite || 0;
    const ricaviPrev = cePrev.ricaviVendite || 0;
    const materie = ceLast.materiePrime || 0;
    const servizi = ceLast.servizi || 0;
    const godimentoBeni = ceLast.godimentoBeniTerzi || 0;
    const personale = ceLast.personale || 0;
    const ammortamenti = ceLast.ammortamenti || 0;
    const imposte = ceLast.imposte || 0;

    // === Calcoli Valore Aggiunto, MOL, EBIT ===
    const valoreAggiunto = ricavi - (materie + servizi + godimentoBeni);
    const valoreAggiuntoPrev = (ricaviPrev || 0) - ((cePrev.materiePrime || 0) + (cePrev.servizi || 0) + (cePrev.godimentoBeniTerzi || 0));
    const EBITDA = valoreAggiunto - personale;
    const EBIT = EBITDA - ammortamenti;
    const valoreAggPerc = (valoreAggiunto / ricavi) * 100 || 0;
    const EBITDAperc = (EBITDA / ricavi) * 100 || 0;
    const EBITperc = (EBIT / ricavi) * 100 || 0;
    const varValAgg = valoreAggiuntoPrev ? ((valoreAggiunto - valoreAggiuntoPrev) / Math.abs(valoreAggiuntoPrev)) * 100 : 0;

    // === Giudizio automatico ===
    let giudizio = "";
    if (EBITDAperc >= 15 && valoreAggPerc >= 45)
      giudizio = "üü¢ Impresa solida: elevata creazione di valore e ampia capacit√† di autofinanziamento.";
    else if (EBITDAperc >= 10 && valoreAggPerc >= 40)
      giudizio = "üü° Impresa media: valore aggiunto stabile ma margini in leggera erosione, efficienza da ottimizzare.";
    else
      giudizio = "üî¥ Impresa critica: valore aggiunto sotto 40 % e EBITDA < 10 %, margini insufficienti per coprire i costi fissi.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü® 3. Analisi a Valore Aggiunto</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi a <b>valore aggiunto</b> misura la <b>ricchezza creata dall‚Äôimpresa</b> attraverso la gestione caratteristica
        e come essa viene <b>distribuita tra i fattori produttivi</b> (personale, capitale, Stato e soci).
        √à utile per valutare la <b>capacit√† di generare margini operativi</b> e l‚Äôefficienza della struttura dei costi.
      </p>

      <h3>üìä Dati sintetici</h3>
      <table>
        <tr><th>Voce</th><th>Valore</th><th>Incidenza sui ricavi</th></tr>
        <tr><td>Valore della produzione</td><td style="text-align:right;">${itFmt(ricavi)}</td><td style="text-align:right;">100 %</td></tr>
        <tr><td>Costi esterni (materie, servizi, godimento beni)</td><td style="text-align:right;">${itFmt(materie + servizi + godimentoBeni)}</td><td style="text-align:right;">${((materie + servizi + godimentoBeni) / ricavi * 100).toFixed(1)} %</td></tr>
        <tr style="background:#f0f4f8;font-weight:bold;">
          <td>Valore Aggiunto</td><td style="text-align:right;">${itFmt(valoreAggiunto)}</td><td style="text-align:right;">${valoreAggPerc.toFixed(1)} %</td>
        </tr>
        <tr><td>Costo del personale</td><td style="text-align:right;">${itFmt(personale)}</td><td style="text-align:right;">${(personale / ricavi * 100).toFixed(1)} %</td></tr>
        <tr style="background:#e8f4f8;font-weight:bold;">
          <td>MOL / EBITDA</td><td style="text-align:right;">${itFmt(EBITDA)}</td><td style="text-align:right;">${EBITDAperc.toFixed(1)} %</td>
        </tr>
        <tr><td>Ammortamenti</td><td style="text-align:right;">${itFmt(ammortamenti)}</td><td style="text-align:right;">${(ammortamenti / ricavi * 100).toFixed(1)} %</td></tr>
        <tr style="background:#e0f7f1;font-weight:bold;">
          <td>EBIT</td><td style="text-align:right;">${itFmt(EBIT)}</td><td style="text-align:right;">${EBITperc.toFixed(1)} %</td>
        </tr>
      </table>

      <h3>üìà Andamento biennale</h3>
      <table>
        <tr><th>Voce</th><th>${state?.anni?.prev || "N-1"}</th><th>${state?.anni?.last || "N"}</th><th>Œî %</th></tr>
        <tr><td>Valore Aggiunto</td><td style="text-align:right;">${itFmt(valoreAggiuntoPrev)}</td><td style="text-align:right;">${itFmt(valoreAggiunto)}</td><td style="text-align:right;">${varValAgg.toFixed(1)} %</td></tr>
        <tr><td>EBITDA</td><td style="text-align:right;">${itFmt(valoreAggiuntoPrev - (cePrev.personale || 0))}</td><td style="text-align:right;">${itFmt(EBITDA)}</td><td style="text-align:right;">${(((EBITDA - (valoreAggiuntoPrev - (cePrev.personale || 0))) / Math.abs(valoreAggiuntoPrev - (cePrev.personale || 0))) * 100 || 0).toFixed(1)} %</td></tr>
        <tr><td>EBIT</td><td style="text-align:right;">${itFmt((valoreAggiuntoPrev - (cePrev.personale || 0) - (cePrev.ammortamenti || 0)))}</td><td style="text-align:right;">${itFmt(EBIT)}</td><td style="text-align:right;">${(((EBIT - (valoreAggiuntoPrev - (cePrev.personale || 0) - (cePrev.ammortamenti || 0))) / Math.abs(valoreAggiuntoPrev - (cePrev.personale || 0) - (cePrev.ammortamenti || 0))) * 100 || 0).toFixed(1)} %</td></tr>
      </table>

      <div class="alert ${EBITDAperc>=15?"alert-success":EBITDAperc>=10?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizio}
      </div>

      <h3>üßÆ Indicatori di redditivit√† gestionale</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Valore Aggiunto / Ricavi</td><td>(VA / Ricavi)</td><td>‚â• 45 %</td><td style="text-align:right;">${valoreAggPerc.toFixed(1)} %</td><td>${valoreAggPerc>=45?"üü¢ Buono":valoreAggPerc>=40?"üü° Medio":"üî¥ Basso"}</td></tr>
        <tr><td>EBITDA Margin</td><td>(EBITDA / Ricavi)</td><td>‚â• 15 %</td><td style="text-align:right;">${EBITDAperc.toFixed(1)} %</td><td>${EBITDAperc>=15?"üü¢ Buono":EBITDAperc>=10?"üü° Medio":"üî¥ Basso"}</td></tr>
        <tr><td>EBIT Margin</td><td>(EBIT / Ricavi)</td><td>‚â• 10 %</td><td style="text-align:right;">${EBITperc.toFixed(1)} %</td><td>${EBITperc>=10?"üü¢ Ottimo":EBITperc>=7?"üü° Accettabile":"üî¥ Critico"}</td></tr>
        <tr><td>Incidenza Costo del Personale</td><td>(Personale / VA)</td><td>‚â§ 60 %</td><td style="text-align:right;">${((personale / valoreAggiunto) * 100).toFixed(1)} %</td><td>${(personale / valoreAggiunto)<=0.6?"üü¢ Ottimo":(personale / valoreAggiunto)<=0.7?"üü° Attenzione":"üî¥ Alto"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e utilit√†</h3>
      <ul>
        <li>Tabella ‚ÄúConto Economico Riclassificato ‚Äì Valore Aggiunto‚Äù ‚Üí <b>Allegato 2</b></li>
        <li>Grafico ‚ÄúDistribuzione del Valore Aggiunto per destinazione‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend EBITDA e EBIT 2022‚Äì2023‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        L‚Äôanalisi del valore aggiunto mostra <b>quanto valore l‚Äôimpresa crea e come lo distribuisce</b>,
        evidenziando la sostenibilit√† operativa e l‚Äôautonomia finanziaria nel medio periodo.
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco3_ValoreAggiunto:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Valore Aggiunto.</div>`;
  }
}

// ============================================================
// üü¶ BLOCCO 4 ‚Äì ANALISI A MARGINE DI CONTRIBUZIONE
// ============================================================

function generaBlocco4_MargineContribuzione() {
  try {
    // === Estrae dati dal Conto Economico standardizzato ===
    const ceLast = window.extractStandardizedCE?.() || {};
    const cePrev = window.extractStandardizedCEPrev?.() || {};

    const ricavi = ceLast.ricaviVendite || 0;
    const ricaviPrev = cePrev.ricaviVendite || 0;
    const variabili = (ceLast.materiePrime || 0) + (ceLast.servizi || 0);
    const variabiliPrev = (cePrev.materiePrime || 0) + (cePrev.servizi || 0);
    const costiFissi = (ceLast.personale || 0) + (ceLast.ammortamenti || 0) + (ceLast.godimentoBeniTerzi || 0);
    const costiFissiPrev = (cePrev.personale || 0) + (cePrev.ammortamenti || 0) + (cePrev.godimentoBeniTerzi || 0);

    // === Calcoli margini ===
    const margineContribuzione = ricavi - variabili;
    const marginePrev = ricaviPrev - variabiliPrev;
    const marginePerc = (margineContribuzione / ricavi) * 100 || 0;
    const marginePrevPerc = (marginePrev / ricaviPrev) * 100 || 0;
    const margineSicurezza = ricavi > 0 ? ((ricavi - costiFissi) / ricavi) * 100 : 0;
    const varMarginePerc = marginePrevPerc
      ? ((marginePerc - marginePrevPerc) / Math.abs(marginePrevPerc)) * 100
      : 0;

    // === Giudizio automatico ===
    let giudizio = "";
    if (marginePerc >= 35)
      giudizio = "üü¢ Impresa solida: margine di contribuzione ampio, ottima capacit√† di coprire i costi fissi.";
    else if (marginePerc >= 25)
      giudizio = "üü° Impresa media: margine adeguato ma vulnerabile a cali di fatturato.";
    else
      giudizio = "üî¥ Impresa critica: margine ridotto, piccoli cali di ricavi portano a perdita operativa.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü¶ 4. Analisi a Margine di Contribuzione</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi del <b>margine di contribuzione</b> consente di valutare
        <b>quanto ogni euro di ricavi contribuisce alla copertura dei costi fissi</b>
        e alla formazione dell‚Äôutile operativo.
        √à uno strumento essenziale per la pianificazione strategica, la politica di prezzi
        e la valutazione del punto di equilibrio economico.
      </p>

      <h3>üìä Dati sintetici</h3>
      <table>
        <tr><th>Voce</th><th>Valore</th><th>Incidenza sui ricavi</th></tr>
        <tr><td>Ricavi delle vendite</td><td style="text-align:right;">${itFmt(ricavi)}</td><td style="text-align:right;">100 %</td></tr>
        <tr><td>Costi variabili</td><td style="text-align:right;">${itFmt(variabili)}</td><td style="text-align:right;">${((variabili / ricavi) * 100).toFixed(1)} %</td></tr>
        <tr style="background:#f0f4f8;font-weight:bold;">
          <td>Margine di contribuzione</td>
          <td style="text-align:right;">${itFmt(margineContribuzione)}</td>
          <td style="text-align:right;">${marginePerc.toFixed(1)} %</td>
        </tr>
        <tr><td>Costi fissi</td><td style="text-align:right;">${itFmt(costiFissi)}</td><td style="text-align:right;">${((costiFissi / ricavi) * 100).toFixed(1)} %</td></tr>
        <tr style="background:#e8f4f8;font-weight:bold;">
          <td>Margine di sicurezza</td>
          <td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td>
          <td style="text-align:right;">‚Äî</td>
        </tr>
      </table>

      <h3>üìà Andamento biennale</h3>
      <table>
        <tr><th>Voce</th><th>${state?.anni?.prev || "N-1"}</th><th>${state?.anni?.last || "N"}</th><th>Œî %</th></tr>
        <tr><td>Margine di contribuzione %</td>
            <td style="text-align:right;">${marginePrevPerc.toFixed(1)} %</td>
            <td style="text-align:right;">${marginePerc.toFixed(1)} %</td>
            <td style="text-align:right;">${varMarginePerc.toFixed(1)} %</td></tr>
        <tr><td>Costi fissi</td>
            <td style="text-align:right;">${itFmt(costiFissiPrev)}</td>
            <td style="text-align:right;">${itFmt(costiFissi)}</td>
            <td style="text-align:right;">${(((costiFissi - costiFissiPrev) / costiFissiPrev) * 100 || 0).toFixed(1)} %</td></tr>
        <tr><td>Margine di sicurezza</td>
            <td style="text-align:right;">${(((ricaviPrev - costiFissiPrev) / ricaviPrev) * 100 || 0).toFixed(1)} %</td>
            <td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td>
            <td style="text-align:right;">‚Äî</td></tr>
      </table>

      <div class="alert ${marginePerc>=35?"alert-success":marginePerc>=25?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizio}
      </div>

      <h3>üßÆ Indicatori di equilibrio</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Margine di contribuzione %</td><td>(Ricavi - Costi Variabili)/Ricavi</td><td>‚â• 30 %</td>
            <td style="text-align:right;">${marginePerc.toFixed(1)} %</td>
            <td>${marginePerc>=35?"üü¢ Ottimo":marginePerc>=25?"üü° Accettabile":"üî¥ Critico"}</td></tr>
        <tr><td>Copertura costi fissi</td><td>Margine Contribuzione / Costi Fissi</td><td>‚â• 1.0</td>
            <td style="text-align:right;">${(margineContribuzione / costiFissi).toFixed(2)}</td>
            <td>${(margineContribuzione / costiFissi)>=1?"üü¢ Adeguata":"üî¥ Insufficiente"}</td></tr>
        <tr><td>Margine di sicurezza</td><td>(Ricavi - BE)/Ricavi</td><td>‚â• 10 %</td>
            <td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td>
            <td>${margineSicurezza>=10?"üü¢ Buono":margineSicurezza>=5?"üü° Debole":"üî¥ Critico"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e utilit√†</h3>
      <ul>
        <li>Tabella ‚ÄúRiclassificazione per Margini‚Äù ‚Üí <b>Allegato 2</b></li>
        <li>Grafico ‚ÄúMargine di Contribuzione vs Costi Fissi‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúAndamento Margine di Sicurezza 2022‚Äì2023‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p style="margin-top:10px;">
        Il <b>margine di contribuzione</b> rappresenta la parte dei ricavi che resta all‚Äôimpresa dopo i costi variabili.
        √à un indicatore chiave per capire la <b>sostenibilit√† della gestione</b> e la capacit√† di resistere
        a fluttuazioni di mercato o cali di domanda.
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco4_MargineContribuzione:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Margine di Contribuzione.</div>`;
  }
}

// ============================================================
// üü• BLOCCO 5 ‚Äì ANALISI BREAK-EVEN
// ============================================================

function generaBlocco5_BreakEven() {
  try {
    // === Estrae dati dal Conto Economico standardizzato ===
    const ceLast = window.extractStandardizedCE?.() || {};
    const cePrev = window.extractStandardizedCEPrev?.() || {};

    const ricavi = ceLast.ricaviVendite || 0;
    const ricaviPrev = cePrev.ricaviVendite || 0;
    const variabili = (ceLast.materiePrime || 0) + (ceLast.servizi || 0);
    const variabiliPrev = (cePrev.materiePrime || 0) + (cePrev.servizi || 0);
    const costiFissi = (ceLast.personale || 0) + (ceLast.ammortamenti || 0) + (ceLast.godimentoBeniTerzi || 0);
    const costiFissiPrev = (cePrev.personale || 0) + (cePrev.ammortamenti || 0) + (cePrev.godimentoBeniTerzi || 0);

    // === Calcoli principali ===
    const margineContribuzione = ricavi - variabili;
    const marginePerc = ricavi ? (margineContribuzione / ricavi) : 0;
    const breakEven = marginePerc > 0 ? costiFissi / marginePerc : 0;
    const margineSicurezza = ricavi > 0 ? ((ricavi - breakEven) / ricavi) * 100 : 0;

    // === Variazioni anno su anno ===
    const varBreakEven = breakEven && ricaviPrev
      ? ((breakEven - (costiFissiPrev / ((ricaviPrev - variabiliPrev) / ricaviPrev))) / (costiFissiPrev / ((ricaviPrev - variabiliPrev) / ricaviPrev))) * 100
      : 0;
    const varMargineSic = ((margineSicurezza - (((ricaviPrev - (costiFissiPrev / ((ricaviPrev - variabiliPrev) / ricaviPrev))) / ricaviPrev) * 100)) || 0).toFixed(1);

    // === Giudizio automatico ===
    let giudizio = "";
    if (margineSicurezza >= 10)
      giudizio = "üü¢ Impresa solida: supera ampiamente il punto di pareggio, con margine di sicurezza adeguato.";
    else if (margineSicurezza >= 5)
      giudizio = "üü° Impresa media: equilibrio economico accettabile, ma vulnerabile a cali di ricavi o costi fissi elevati.";
    else
      giudizio = "üî¥ Impresa critica: margine di sicurezza ridotto, anche lievi cali di vendite possono portare a perdita operativa.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü• 5. Analisi Break-Even (Punto di Pareggio)</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi <b>Break-Even</b> consente di determinare il livello minimo di ricavi necessario
        per coprire tutti i costi (fissi e variabili) e quindi non generare n√© utile n√© perdita.
        √à una misura della <b>soglia di equilibrio economico</b> e indica la resilienza della gestione
        ai cambiamenti di volume o di prezzo.
      </p>

      <h3>üìä Dati sintetici</h3>
      <table>
        <tr><th>Voce</th><th>Valore</th><th>Incidenza sui ricavi</th></tr>
        <tr><td>Ricavi delle vendite</td><td style="text-align:right;">${itFmt(ricavi)}</td><td>100 %</td></tr>
        <tr><td>Costi fissi</td><td style="text-align:right;">${itFmt(costiFissi)}</td><td>${((costiFissi / ricavi) * 100).toFixed(1)} %</td></tr>
        <tr><td>Costi variabili</td><td style="text-align:right;">${itFmt(variabili)}</td><td>${((variabili / ricavi) * 100).toFixed(1)} %</td></tr>
        <tr style="font-weight:bold;background:#f0f4f8;">
          <td>Punto di pareggio (Break-Even)</td>
          <td style="text-align:right;">${itFmt(breakEven)}</td>
          <td style="text-align:right;">${((breakEven / ricavi) * 100).toFixed(1)} %</td>
        </tr>
        <tr style="font-weight:bold;background:#e8f4f8;">
          <td>Margine di sicurezza</td>
          <td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td>
          <td style="text-align:right;">‚Äî</td>
        </tr>
      </table>

      <h3>üìà Andamento biennale</h3>
      <table>
        <tr><th>Voce</th><th>${state?.anni?.prev || "N-1"}</th><th>${state?.anni?.last || "N"}</th><th>Œî %</th></tr>
        <tr><td>Ricavi vendite</td><td style="text-align:right;">${itFmt(ricaviPrev)}</td><td style="text-align:right;">${itFmt(ricavi)}</td><td style="text-align:right;">${(((ricavi - ricaviPrev) / ricaviPrev) * 100 || 0).toFixed(1)} %</td></tr>
        <tr><td>Punto di Pareggio</td><td style="text-align:right;">${itFmt(costiFissiPrev / ((ricaviPrev - variabiliPrev) / ricaviPrev))}</td><td style="text-align:right;">${itFmt(breakEven)}</td><td style="text-align:right;">${varBreakEven.toFixed(1)} %</td></tr>
        <tr><td>Margine di Sicurezza</td><td style="text-align:right;">${(((ricaviPrev - (costiFissiPrev / ((ricaviPrev - variabiliPrev) / ricaviPrev))) / ricaviPrev) * 100).toFixed(1)} %</td><td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td><td style="text-align:right;">${varMargineSic}%</td></tr>
      </table>

      <div class="alert ${margineSicurezza>=10?"alert-success":margineSicurezza>=5?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizio}
      </div>

      <h3>üßÆ Indicatori di equilibrio</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Punto di Pareggio (BE)</td><td>Costi Fissi / (Margine %)</td><td>‚Äî</td><td style="text-align:right;">${itFmt(breakEven)}</td><td>‚Äî</td></tr>
        <tr><td>Margine di Sicurezza %</td><td>(Ricavi ‚Äì BE) / Ricavi</td><td>‚â• 10 %</td><td style="text-align:right;">${margineSicurezza.toFixed(1)} %</td><td>${margineSicurezza>=10?"üü¢ Ottimo":margineSicurezza>=5?"üü° Sufficiente":"üî¥ Critico"}</td></tr>
        <tr><td>Leva Operativa</td><td>Margine Contribuzione / EBIT</td><td>‚â§ 4</td><td style="text-align:right;">${((ricavi - variabili) / (ceLast.EBIT || 1)).toFixed(2)}</td><td>${((ricavi - variabili) / (ceLast.EBIT || 1))<=4?"üü¢ Bassa":"üî¥ Alta"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e utilit√†</h3>
      <ul>
        <li>Tabella ‚ÄúAnalisi Break-Even Dettagliata‚Äù ‚Üí <b>Allegato 2</b></li>
        <li>Grafico ‚ÄúRicavi, Costi Totali e Break-Even Point‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúMargine di Sicurezza per Esercizio‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        Il <b>margine di sicurezza</b> rappresenta la distanza tra i ricavi effettivi e il punto di pareggio:
        maggiore √® questa distanza, maggiore √® la capacit√† dell‚Äôimpresa di <b>assorbire fluttuazioni negative di mercato</b>.
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco5_BreakEven:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Break-Even.</div>`;
  }
}

// ============================================================
// üü´ BLOCCO 6 ‚Äì RENDICONTO FINANZIARIO E STATO PATRIMONIALE FINANZIARIO
// ============================================================

function generaBlocco6_RendicontoFinanziario() {
  try {
    // === Estrae dati standardizzati e rendiconto ===
    const ceLast = window.extractStandardizedCE?.() || {};
    const spLast = window.extractStandardizedSP?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};

    // === Dati principali simulati dal rendiconto (se gi√† calcolati) ===
    const cashFlowOperativo = dscr?.last?.cashFlow || (ceLast.EBITDA || 0) - (ceLast.imposte || 0);
    const cashFlowInvestimenti = (spLast.immobilizzazioni || 0) * -0.06; // stima: 6% investimenti netti
    const cashFlowFinanziario = (dscr?.last?.quoteCapitale || 0) * -1 + (dscr?.last?.nuoviFinanziamenti || 0) || 0;
    const deltaCassa = cashFlowOperativo + cashFlowInvestimenti + cashFlowFinanziario;

    // === Calcoli aggiuntivi ===
    const leverage = dscr?.last?.leverage || (spLast.totalePassivo / spLast.patrimonioNetto) || 0;
    const rapportoCassaDebiti = spLast.disponibilitaLiquide / spLast.debitiEntro12 || 0;

    // === Giudizio automatico ===
    let giudizio = "";
    if (cashFlowOperativo > 0 && deltaCassa > 0)
      giudizio = "üü¢ Impresa solida: flussi operativi positivi e capacit√† di autofinanziamento costante.";
    else if (cashFlowOperativo > 0 && deltaCassa < 0)
      giudizio = "üü° Impresa media: generazione di cassa operativa positiva, ma assorbita da investimenti o debiti.";
    else
      giudizio = "üî¥ Impresa critica: flussi di cassa negativi, la gestione brucia liquidit√† e richiede supporto esterno.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü´ 6. Rendiconto Finanziario e Stato Patrimoniale Finanziario</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi del <b>Rendiconto Finanziario</b> e dello <b>Stato Patrimoniale Finanziario</b>
        consente di comprendere <b>come l‚Äôimpresa genera e utilizza la propria liquidit√†</b>.
        √à fondamentale per valutare la <b>sostenibilit√† della gestione</b> nel tempo e l‚Äôequilibrio
        tra <b>fonti e impieghi</b> di capitale.
      </p>

      <h3>üìä Dati sintetici</h3>
      <table>
        <tr><th>Voce</th><th>Importo</th><th>Interpretazione</th></tr>
        <tr><td>Cash Flow Operativo (CFO)</td><td style="text-align:right;">${itFmt(cashFlowOperativo)}</td><td>Flussi generati dall‚Äôattivit√† caratteristica</td></tr>
        <tr><td>Cash Flow da Investimenti (CFI)</td><td style="text-align:right;">${itFmt(cashFlowInvestimenti)}</td><td>Impatti da investimenti netti</td></tr>
        <tr><td>Cash Flow Finanziario (CFF)</td><td style="text-align:right;">${itFmt(cashFlowFinanziario)}</td><td>Movimenti di capitale e finanziamenti</td></tr>
        <tr style="font-weight:bold;background:#f0f4f8;">
          <td>Œî Liquidit√† Totale</td><td style="text-align:right;">${itFmt(deltaCassa)}</td>
          <td>${deltaCassa>=0?"Incremento di cassa":"Riduzione di cassa"}</td>
        </tr>
      </table>

      <div class="alert ${deltaCassa>0?"alert-success":cashFlowOperativo>0?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizio}
      </div>

      <h3>üßÆ Indicatori finanziari principali</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Cash Flow Operativo / Totale Debiti</td><td>CFO / Debiti totali</td><td>‚â• 20 %</td><td style="text-align:right;">${((cashFlowOperativo / (spLast.totDebiti || 1)) * 100).toFixed(1)} %</td><td>${(cashFlowOperativo / (spLast.totDebiti || 1))>=0.2?"üü¢ Buono":(cashFlowOperativo / (spLast.totDebiti || 1))>=0.1?"üü° Medio":"üî¥ Debole"}</td></tr>
        <tr><td>Autofinanziamento / Investimenti</td><td>CFO / CFI</td><td>‚â• 1</td><td style="text-align:right;">${(cashFlowOperativo / Math.abs(cashFlowInvestimenti || 1)).toFixed(2)}</td><td>${(cashFlowOperativo / Math.abs(cashFlowInvestimenti || 1))>=1?"üü¢ Autosufficiente":"üî¥ Dipendente da credito"}</td></tr>
        <tr><td>Leverage Finanziario</td><td>Debiti / Patrimonio Netto</td><td>‚â§ 3</td><td style="text-align:right;">${leverage.toFixed(2)}</td><td>${leverage<=3?"üü¢ Solido":leverage<=4?"üü° Medio":"üî¥ Elevato"}</td></tr>
        <tr><td>Rapporto Cassa / Debiti Breve</td><td>Liquidit√† / Debiti Entro 12 mesi</td><td>‚â• 0.2</td><td style="text-align:right;">${rapportoCassaDebiti.toFixed(2)}</td><td>${rapportoCassaDebiti>=0.2?"üü¢ Buono":rapportoCassaDebiti>=0.1?"üü° Limitato":"üî¥ Critico"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e utilit√†</h3>
      <ul>
        <li>Tabella ‚ÄúRendiconto Finanziario ‚Äì Metodo Indiretto‚Äù ‚Üí <b>Allegato 3</b></li>
        <li>Tabella ‚ÄúStato Patrimoniale Finanziario ‚Äì Fonti e Impieghi‚Äù ‚Üí <b>Allegato 3</b></li>
        <li>Grafico ‚ÄúFonti vs Impieghi‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúVariazione della Cassa 2022‚Äì2023‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p style="margin-top:10px;">
        Il <b>Rendiconto Finanziario</b> mostra come l‚Äôimpresa <b>genera o assorbe liquidit√†</b> e
        aiuta a comprendere se vive di <b>autofinanziamento o di credito</b>.
        Lo <b>Stato Patrimoniale Finanziario</b> evidenzia invece l‚Äôequilibrio tra le fonti di capitale
        (patrimonio e debiti) e gli impieghi (attivit√† e investimenti).
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco6_RendicontoFinanziario:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Rendiconto Finanziario.</div>`;
  }
}

// ============================================================
// üü© BLOCCO 7 ‚Äì ANALISI PER INDICI
// ============================================================

function generaBlocco7_IndiciBilancio() {
  try {
    // === Calcoli dinamici da funzioni ceoDOC ===
    const prev = window.calcolaIndiciComplessiviPrev?.() || {};
    const last = window.calcolaIndiciComplessivi?.() || {};
    const prod = window.calcolaIndiciProduttivitaEstesi?.() || {};

    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü© 7. Analisi per Indici di Bilancio</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        L‚Äôanalisi per indici consente di <b>valutare le performance economiche, patrimoniali e finanziarie</b>
        dell‚Äôimpresa attraverso indicatori sintetici che permettono di monitorare:
        <ul>
          <li>la <b>redditivit√†</b> del capitale proprio e investito,</li>
          <li>la <b>solidit√† patrimoniale</b> e l‚Äôequilibrio delle fonti,</li>
          <li>la <b>liquidit√† e la capacit√† di rimborso</b>,</li>
          <li>la <b>produttivit√† del personale</b> e l‚Äôefficienza gestionale.</li>
        </ul>
        Gli indici rappresentano la ‚Äúdiagnosi clinica‚Äù dell‚Äôazienda, utile per comprendere
        la solidit√† e la sostenibilit√† nel medio periodo.
      </p>

      <h3>üìä Indici Economici (Redditivit√†)</h3>
      <table>
        <tr><th>Indicatore</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî %</th><th>Soglia</th><th>Giudizio</th></tr>
        <tr><td>ROE ‚Äì Return on Equity</td>
            <td>${(prev.ROE||0).toFixed(2)} %</td>
            <td>${(last.ROE||0).toFixed(2)} %</td>
            <td>${(((last.ROE - prev.ROE) / (prev.ROE||1)) * 100).toFixed(1)} %</td>
            <td>‚â• 10 %</td>
            <td>${last.ROE>=10?"üü¢ Ottimo":last.ROE>=5?"üü° Adeguato":"üî¥ Basso"}</td></tr>
        <tr><td>ROI ‚Äì Return on Investment</td>
            <td>${(prev.ROI||0).toFixed(2)} %</td>
            <td>${(last.ROI||0).toFixed(2)} %</td>
            <td>${(((last.ROI - prev.ROI) / (prev.ROI||1)) * 100).toFixed(1)} %</td>
            <td>‚â• 8 %</td>
            <td>${last.ROI>=8?"üü¢ Efficiente":last.ROI>=4?"üü° Medio":"üî¥ Insufficiente"}</td></tr>
        <tr><td>ROS ‚Äì Return on Sales</td>
            <td>${(prev.ROS||0).toFixed(2)} %</td>
            <td>${(last.ROS||0).toFixed(2)} %</td>
            <td>${(((last.ROS - prev.ROS) / (prev.ROS||1)) * 100).toFixed(1)} %</td>
            <td>‚â• 5 %</td>
            <td>${last.ROS>=5?"üü¢ Buono":last.ROS>=2?"üü° Basso":"üî¥ Critico"}</td></tr>
        <tr><td>ROA ‚Äì Return on Assets</td>
            <td>${(prev.ROA||0).toFixed(2)} %</td>
            <td>${(last.ROA||0).toFixed(2)} %</td>
            <td>${(((last.ROA - prev.ROA) / (prev.ROA||1)) * 100).toFixed(1)} %</td>
            <td>‚â• 3 %</td>
            <td>${last.ROA>=3?"üü¢ Adeguato":"üî¥ Debole"}</td></tr>
        <tr><td>ROCE ‚Äì Return on Capital Employed</td>
            <td>${(prev.ROCE||0).toFixed(2)} %</td>
            <td>${(last.ROCE||0).toFixed(2)} %</td>
            <td>${(((last.ROCE - prev.ROCE) / (prev.ROCE||1)) * 100).toFixed(1)} %</td>
            <td>‚â• 10 %</td>
            <td>${last.ROCE>=10?"üü¢ Eccellente":last.ROCE>=7?"üü° Sufficiente":"üî¥ Critico"}</td></tr>
      </table>

      <h3>üèõÔ∏è Indici Patrimoniali (Solidit√†)</h3>
      <table>
        <tr><th>Indicatore</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî</th><th>Soglia</th><th>Giudizio</th></tr>
        <tr><td>Leverage</td>
            <td>${(prev.leverage||0).toFixed(2)}</td>
            <td>${(last.leverage||0).toFixed(2)}</td>
            <td>${((last.leverage - prev.leverage)||0).toFixed(2)}</td>
            <td>‚â§ 3</td>
            <td>${last.leverage<=3?"üü¢ Equilibrato":last.leverage<=4?"üü° Alto":"üî¥ Eccessivo"}</td></tr>
        <tr><td>Debt/Equity Ratio</td>
            <td>${(prev.debtEquityRatio||0).toFixed(2)}</td>
            <td>${(last.debtEquityRatio||0).toFixed(2)}</td>
            <td>${((last.debtEquityRatio - prev.debtEquityRatio)||0).toFixed(2)}</td>
            <td>‚â§ 2</td>
            <td>${last.debtEquityRatio<=2?"üü¢ Solido":"üî¥ Rischioso"}</td></tr>
        <tr><td>Equity Ratio</td>
            <td>${(prev.equityRatio||0).toFixed(2)} %</td>
            <td>${(last.equityRatio||0).toFixed(2)} %</td>
            <td>${((last.equityRatio - prev.equityRatio)||0).toFixed(2)} pp</td>
            <td>‚â• 33 %</td>
            <td>${last.equityRatio>=33?"üü¢ Buono":"üî¥ Basso"}</td></tr>
      </table>

      <h3>üíß Indici Finanziari (Liquidit√†)</h3>
      <table>
        <tr><th>Indicatore</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî</th><th>Soglia</th><th>Giudizio</th></tr>
        <tr><td>Current Ratio</td>
            <td>${(prev.currentRatio||0).toFixed(2)}</td>
            <td>${(last.currentRatio||0).toFixed(2)}</td>
            <td>${((last.currentRatio - prev.currentRatio)||0).toFixed(2)}</td>
            <td>‚â• 1.5</td>
            <td>${last.currentRatio>=1.5?"üü¢ Buono":last.currentRatio>=1.2?"üü° Limitato":"üî¥ Critico"}</td></tr>
        <tr><td>Quick Ratio</td>
            <td>${(prev.quickRatio||0).toFixed(2)}</td>
            <td>${(last.quickRatio||0).toFixed(2)}</td>
            <td>${((last.quickRatio - prev.quickRatio)||0).toFixed(2)}</td>
            <td>‚â• 1.0</td>
            <td>${last.quickRatio>=1?"üü¢ Ottimo":last.quickRatio>=0.8?"üü° Medio":"üî¥ Basso"}</td></tr>
        <tr><td>Cash Ratio</td>
            <td>${(prev.cashRatio||0).toFixed(2)}</td>
            <td>${(last.cashRatio||0).toFixed(2)}</td>
            <td>${((last.cashRatio - prev.cashRatio)||0).toFixed(2)}</td>
            <td>‚â• 0.2</td>
            <td>${last.cashRatio>=0.2?"üü¢ Buono":"üî¥ Scarso"}</td></tr>
        <tr><td>Interest Coverage Ratio</td>
            <td>${(prev.interestCoverage||0).toFixed(2)}</td>
            <td>${(last.interestCoverage||0).toFixed(2)}</td>
            <td>${((last.interestCoverage - prev.interestCoverage)||0).toFixed(2)}</td>
            <td>‚â• 3</td>
            <td>${last.interestCoverage>=3?"üü¢ Solvibile":"üî¥ Rischioso"}</td></tr>
      </table>

      <h3>‚öôÔ∏è Indici di Produttivit√†</h3>
      <table>
        <tr><th>Indicatore</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî</th><th>Benchmark</th><th>Giudizio</th></tr>
        <tr><td>Ricavi per Dipendente</td>
            <td>${itFmt(prod.prev?.ricaviPerDip||0)}</td>
            <td>${itFmt(prod.last?.ricaviPerDip||0)}</td>
            <td>${(((prod.last?.ricaviPerDip - prod.prev?.ricaviPerDip)/prod.prev?.ricaviPerDip)*100||0).toFixed(1)} %</td>
            <td>‚â• ‚Ç¨ 60.000</td>
            <td>${prod.last?.ricaviPerDip>=60000?"üü¢ Alta":"üî¥ Bassa"}</td></tr>
        <tr><td>Costo medio per addetto</td>
            <td>${itFmt(prod.prev?.costoMedioDip||0)}</td>
            <td>${itFmt(prod.last?.costoMedioDip||0)}</td>
            <td>${(((prod.last?.costoMedioDip - prod.prev?.costoMedioDip)/prod.prev?.costoMedioDip)*100||0).toFixed(1)} %</td>
            <td>‚â§ ‚Ç¨ 45.000</td>
            <td>${prod.last?.costoMedioDip<=45000?"üü¢ Buono":"‚ö†Ô∏è Elevato"}</td></tr>
        <tr><td>Giorni crediti (DSO)</td>
            <td>${(prod.prev?.DSO||0).toFixed(0)} gg</td>
            <td>${(prod.last?.DSO||0).toFixed(0)} gg</td>
            <td>${((prod.last?.DSO - prod.prev?.DSO)||0).toFixed(0)} gg</td>
            <td>‚â§ 60 gg</td>
            <td>${prod.last?.DSO<=60?"üü¢ Ottimo":prod.last?.DSO<=90?"üü° Medio":"üî¥ Lungo"}</td></tr>
        <tr><td>Giorni debiti (DPO)</td>
            <td>${(prod.prev?.DPO||0).toFixed(0)} gg</td>
            <td>${(prod.last?.DPO||0).toFixed(0)} gg</td>
            <td>${((prod.last?.DPO - prod.prev?.DPO)||0).toFixed(0)} gg</td>
            <td>60‚Äì90 gg</td>
            <td>${prod.last?.DPO<=90?"üü¢ Normale":prod.last?.DPO<=120?"üü° Alto":"üî¥ Eccessivo"}</td></tr>
      </table>

      <div class="alert alert-info" style="margin-top:10px;">
        Gli indici di bilancio offrono una <b>visione integrata della gestione</b>:
        i valori economici misurano la redditivit√†, quelli patrimoniali la solidit√†, quelli finanziari la liquidit√†
        e quelli di produttivit√† la capacit√† di trasformare risorse in valore.
      </div>

      <h3>üóÇÔ∏è Riferimenti e allegati</h3>
      <ul>
        <li>Tabella ‚ÄúIndici di Bilancio Completi 2022‚Äì2023‚Äù ‚Üí <b>Allegato 4</b></li>
        <li>Grafico ‚ÄúDashboard KPI ‚Äì Redditivit√† / Solidit√† / Liquidit√† / Produttivit√†‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúRadar ‚Äì Indice Globale di Salute Aziendale‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend ROI ‚Äì ROE ‚Äì ROS‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco7_IndiciBilancio:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Analisi per Indici.</div>`;
  }
}

// ============================================================
// üü™ BLOCCO 8 ‚Äì INDICI DI ALLERTA CRISI (CNDCEC)
// ============================================================

function generaBlocco8_AllertaCrisi() {
  try {
    // === Estrae i dati principali ===
    const last = window.calcolaIndiciComplessivi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const rating = window.calcolaRatingIntegrato?.(state.scoreEF, state.scoreAndamentale) || {};

    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Calcoli singoli indicatori (con punteggi 0‚Äì2) ===
    let scorePatrimonio = (last.patrimonioNetto || 1) > 0 ? 2 : 0;
    let scoreDSCR = dscr?.last?.ratio > 1.2 ? 2 : dscr?.last?.ratio > 1 ? 1 : 0;
    let scoreLiquidita = last.currentRatio > 1 ? 2 : last.currentRatio > 0.9 ? 1 : 0;
    let scoreROE = last.ROE > 3 ? 2 : last.ROE > 0 ? 1 : 0;
    let scoreOneriRicavi = last.interestOnSales < 5 ? 2 : last.interestOnSales < 7 ? 1 : 0;

    const totalScore = scorePatrimonio + scoreDSCR + scoreLiquidita + scoreROE + scoreOneriRicavi;
    const area =
      totalScore >= 8
        ? "üü¢ Area Verde ‚Äì nessuna allerta"
        : totalScore >= 5
        ? "üü° Area Gialla ‚Äì attenzione"
        : "üî¥ Area Rossa ‚Äì rischio crisi";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü™ 8. Indici di Allerta Crisi (CNDCEC)</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        Gli <b>indici di allerta crisi</b> introdotti dal <b>Codice della Crisi d‚ÄôImpresa (D.Lgs. 14/2019)</b>
        permettono di <b>identificare precocemente squilibri economici, patrimoniali e finanziari</b>
        che potrebbero compromettere la continuit√† aziendale.
        CeoDOC calcola automaticamente i 5 indicatori ufficiali CNDCEC, assegnando
        un punteggio da 0 a 12 (2 punti per ogni indice in soglia, 1 parziale, 0 fuori soglia).
      </p>

      <h3>üìä Risultati ${anni.last}</h3>
      <table>
        <tr><th>Indicatore</th><th>Valore</th><th>Soglia</th><th>Punteggio</th><th>Giudizio</th></tr>
        <tr><td>Patrimonio Netto</td><td>${itFmt(last.patrimonioNetto || 0)}</td><td>> 0</td><td>${scorePatrimonio}</td><td>${scorePatrimonio==2?"üü¢ OK":"üî¥ Negativo"}</td></tr>
        <tr><td>DSCR (6‚Äì12 mesi)</td><td>${(dscr?.last?.ratio||0).toFixed(2)}</td><td>> 1.0</td><td>${scoreDSCR}</td><td>${scoreDSCR==2?"üü¢ Adeguato":scoreDSCR==1?"üü° Debole":"üî¥ Critico"}</td></tr>
        <tr><td>Indice di Liquidit√†</td><td>${(last.currentRatio||0).toFixed(2)}</td><td>> 1.0</td><td>${scoreLiquidita}</td><td>${scoreLiquidita==2?"üü¢ Buono":scoreLiquidita==1?"üü° Sufficiente":"üî¥ Basso"}</td></tr>
        <tr><td>ROE</td><td>${(last.ROE||0).toFixed(2)} %</td><td>> 3 %</td><td>${scoreROE}</td><td>${scoreROE==2?"üü¢ Positivo":scoreROE==1?"üü° Basso":"üî¥ Negativo"}</td></tr>
        <tr><td>Oneri Finanziari / Ricavi</td><td>${(last.interestOnSales||0).toFixed(2)} %</td><td>< 5 %</td><td>${scoreOneriRicavi}</td><td>${scoreOneriRicavi==2?"üü¢ OK":scoreOneriRicavi==1?"üü° Al limite":"üî¥ Elevati"}</td></tr>
        <tr style="font-weight:bold;background:#f0f4f8;">
          <td colspan="2">Totale Score</td>
          <td> / 12</td>
          <td>${totalScore}</td>
          <td>${area}</td>
        </tr>
      </table>

      <div class="alert ${totalScore>=8?"alert-success":totalScore>=5?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${area}
      </div>

      <h3>üßÆ Interpretazione</h3>
      <ul>
        <li><b>Area Verde</b> (‚â• 8 punti) ‚Üí nessuna allerta: struttura equilibrata e continuit√† aziendale garantita.</li>
        <li><b>Area Gialla</b> (5‚Äì7 punti) ‚Üí attenzione: alcuni squilibri da monitorare entro 6 mesi.</li>
        <li><b>Area Rossa</b> (< 5 punti) ‚Üí rischio crisi: interventi urgenti su cassa, capitale proprio e redditivit√†.</li>
      </ul>

      <h3>üóÇÔ∏è Riferimenti e Allegati</h3>
      <ul>
        <li>Tabella ‚ÄúIndicatori di Allerta Crisi CNDCEC‚Äù ‚Üí <b>Allegato 5</b></li>
        <li>Grafico ‚ÄúSemaforo Allerta (verde/giallo/rosso)‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend DSCR e Patrimonio Netto ${anni.prev}‚Äì${anni.last}‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        Gli indici di allerta consentono di verificare la <b>presunzione di crisi</b>
        e sono utilizzati da revisori, banche e MCC per valutare la sostenibilit√† della gestione.
        CeoDOC integra i risultati di questi indicatori con il <b>DSCR</b> e il <b>Rating MCC</b>
        per un controllo completo del rischio di continuit√†.
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco8_AllertaCrisi:", err);
    return `<div class='alert alert-danger'>Errore nella generazione degli indici di allerta crisi.</div>`;
  }
}

// ============================================================
// üüß BLOCCO 9 ‚Äì ANALISI DSCR E Z-SCORE (Sostenibilit√† e Insolvenza)
// ============================================================

function generaBlocco9_DSCR_ZScore() {
  try {
    // === Estrae dati da funzioni ceoDOC ===
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    const dPrev = dscr.prev || {};
    const dLast = dscr.last || {};
    const zPrev = zscore.prev || {};
    const zLast = zscore.last || {};

    // === Calcolo variazioni e indicatori chiave ===
    const varDSCR = ((dLast.ratio - dPrev.ratio) / (dPrev.ratio || 1)) * 100 || 0;
    const varZ = ((zLast.score - zPrev.score) / (zPrev.score || 1)) * 100 || 0;

    // === Giudizi automatici ===
    const giudizioDSCR =
      dLast.ratio >= 1.25
        ? "üü¢ Sostenibile"
        : dLast.ratio >= 1.0
        ? "üü° Da monitorare"
        : "üî¥ Critico";

    const giudizioZ =
      zLast.score >= 3
        ? "üü¢ Zona Sana"
        : zLast.score >= 1.8
        ? "üü° Zona Grigia"
        : "üî¥ Zona Rossa";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üüß 9. Analisi DSCR e Z-Score</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        Questa sezione valuta la <b>sostenibilit√† finanziaria</b> e la <b>probabilit√† di insolvenza</b>
        dell‚Äôimpresa attraverso due indicatori fondamentali:
        <ul>
          <li><b>DSCR (Debt Service Coverage Ratio)</b> ‚Üí misura la capacit√† dell‚Äôimpresa di coprire il debito con i flussi di cassa.</li>
          <li><b>Z-Score di Altman</b> ‚Üí stima la probabilit√† statistica di default basandosi su redditivit√†, leva e liquidit√†.</li>
        </ul>
        Insieme forniscono una visione completa: il DSCR fotografa la situazione attuale, lo Z-Score prevede la stabilit√† futura.
      </p>

      <h3>üìä DSCR ‚Äì Debt Service Coverage Ratio</h3>
      <table>
        <tr><th>Voce</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî %</th><th>Giudizio</th></tr>
        <tr><td>EBITDA</td>
            <td>${itFmt(dPrev.EBITDA||0)}</td><td>${itFmt(dLast.EBITDA||0)}</td>
            <td>${(((dLast.EBITDA - dPrev.EBITDA)/(dPrev.EBITDA||1))*100).toFixed(1)} %</td><td>‚Äî</td></tr>
        <tr><td>Imposte correnti</td>
            <td>${itFmt(dPrev.imposteCorrenti||0)}</td><td>${itFmt(dLast.imposteCorrenti||0)}</td>
            <td>${(((dLast.imposteCorrenti - dPrev.imposteCorrenti)/(dPrev.imposteCorrenti||1))*100).toFixed(1)} %</td><td>‚Äî</td></tr>
        <tr><td>Cash Flow Operativo</td>
            <td>${itFmt(dPrev.cashFlow||0)}</td><td>${itFmt(dLast.cashFlow||0)}</td>
            <td>${(((dLast.cashFlow - dPrev.cashFlow)/(dPrev.cashFlow||1))*100).toFixed(1)} %</td><td>‚Äî</td></tr>
        <tr><td>Quote capitale</td>
            <td>${itFmt(dPrev.quoteCapitale||0)}</td><td>${itFmt(dLast.quoteCapitale||0)}</td>
            <td>${(((dLast.quoteCapitale - dPrev.quoteCapitale)/(dPrev.quoteCapitale||1))*100).toFixed(1)} %</td><td>‚Äî</td></tr>
        <tr><td>Interessi</td>
            <td>${itFmt(dPrev.oneriFinanziari||0)}</td><td>${itFmt(dLast.oneriFinanziari||0)}</td>
            <td>${(((dLast.oneriFinanziari - dPrev.oneriFinanziari)/(dPrev.oneriFinanziari||1))*100).toFixed(1)} %</td><td>‚Äî</td></tr>
        <tr style="background:#f0f4f8;font-weight:bold;">
          <td>DSCR</td>
          <td>${(dPrev.ratio||0).toFixed(2)}</td>
          <td>${(dLast.ratio||0).toFixed(2)}</td>
          <td>${varDSCR.toFixed(1)} %</td>
          <td>${giudizioDSCR}</td>
        </tr>
      </table>

      <div class="alert ${dLast.ratio>=1.25?"alert-success":dLast.ratio>=1.0?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${
          dLast.ratio>=1.25
            ? "üü¢ Flussi di cassa ampiamente sostenibili: l‚Äôimpresa genera liquidit√† pi√π che sufficiente per coprire il debito."
            : dLast.ratio>=1.0
            ? "üü° Equilibrio fragile: i flussi coprono appena il debito, serve monitoraggio trimestrale."
            : "üî¥ Criticit√†: DSCR sotto 1.0 indica rischio immediato di tensione finanziaria."
        }
      </div>

      <h3>üìâ Z-Score Altman ‚Äì Analisi Predittiva Insolvenza</h3>
      <table>
        <tr><th>Codice</th><th>Descrizione</th><th>${anni.last}</th></tr>
        <tr><td>X1</td><td>Capitale circolante / Totale attivo</td><td>${(zLast.X1||0).toFixed(2)}</td></tr>
        <tr><td>X2</td><td>Riserve / Totale attivo</td><td>${(zLast.X2||0).toFixed(2)}</td></tr>
        <tr><td>X3</td><td>EBIT / Totale attivo</td><td>${(zLast.X3||0).toFixed(2)}</td></tr>
        <tr><td>X4</td><td>Patrimonio netto / Debiti</td><td>${(zLast.X4||0).toFixed(2)}</td></tr>
        <tr><td>X5</td><td>Ricavi / Totale attivo</td><td>${(zLast.X5||0).toFixed(2)}</td></tr>
        <tr style="font-weight:bold;background:#f0f4f8;">
          <td colspan="2">Z-Score Totale</td>
          <td>${(zLast.score||0).toFixed(2)} ‚Äì ${giudizioZ}</td>
        </tr>
      </table>

      <div class="alert ${zLast.score>=3?"alert-success":zLast.score>=1.8?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${
          zLast.score>=3
            ? "üü¢ Zona sana: impresa solida e a basso rischio di insolvenza."
            : zLast.score>=1.8
            ? "üü° Zona grigia: equilibrio instabile, la redditivit√† deve sostenere la struttura finanziaria."
            : "üî¥ Zona rossa: elevato rischio di insolvenza nel medio periodo."
        }
      </div>

      <h3>üßÆ Indicatori e formule chiave</h3>
      <ul>
        <li><b>DSCR =</b> (EBITDA ‚Äì Imposte) / (Quote Capitale + Interessi)</li>
        <li><b>Z =</b> 1.2X1 + 1.4X2 + 3.3X3 + 0.6X4 + 0.999X5</li>
      </ul>

      <h3>üóÇÔ∏è Riferimenti e Allegati</h3>
      <ul>
        <li>Tabella ‚ÄúDSCR Dettagliato ‚Äì Copertura Debiti‚Äù ‚Üí <b>Allegato 5</b></li>
        <li>Grafico ‚ÄúAndamento DSCR 2022‚Äì2023‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúZ-Score Altman ‚Äì Trend Triennale‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Gauge ‚ÄúIndice Globale di Salute Aziendale‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        Il <b>DSCR</b> misura la capacit√† dell‚Äôimpresa di sostenere il debito nel breve periodo,
        mentre lo <b>Z-Score</b> valuta la probabilit√† di crisi nel medio-lungo.
        Questi due indicatori sono alla base del <b>Rating MCC</b> e della <b>simulazione Monte Carlo</b>.
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco9_DSCR_ZScore:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione DSCR e Z-Score.</div>`;
  }
}

// ============================================================
// üü® BLOCCO 10 ‚Äì RATING MCC INTEGRATO
// ============================================================

function generaBlocco10_RatingMCC() {
  try {
    // === Estrae o calcola i punteggi ===
    const scoreEF = state.scoreEF || window.calcolaScoreEconomicoFinanziario?.();
    const scoreAnd = state.scoreAndamentale || window.calcolaScoreAndamentaleCompleto?.();
    let ratingMCC = window.calcolaRatingIntegrato?.(scoreEF, scoreAnd) || {};

    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Recupera analisi precedente se disponibile ===
    let ratingPrev = {};
    try {
      const keyPrev = `ceodoc_ratingmcc_${state.cf}_${anni.prev}`;
      ratingPrev = JSON.parse(localStorage.getItem(keyPrev) || "{}")?.result || {};
    } catch { ratingPrev = {}; }

    // === Calcola variazioni (Œî) ===
    const deltaPD = ratingPrev?.pd ? (ratingMCC.pd - ratingPrev.pd).toFixed(2) : "‚Äî";
    const deltaClasse = ratingPrev?.rating ? ratingMCC.rating - ratingPrev.rating : "‚Äî";

    // === Giudizio dinamico su PD ===
    let giudizioPD = "";
    if (!ratingMCC.pd) giudizioPD = "‚ö†Ô∏è Rating non disponibile.";
    else if (ratingMCC.pd < 1)
      giudizioPD = "üîµ Eccellente solidit√† e basso rischio di default.";
    else if (ratingMCC.pd < 3)
      giudizioPD = "üü¢ Buon merito creditizio, rischio contenuto.";
    else if (ratingMCC.pd < 7)
      giudizioPD = "üü° Profilo di rischio medio: monitoraggio consigliato.";
    else if (ratingMCC.pd < 15)
      giudizioPD = "üü† Rischio elevato, necessario presidiare la posizione finanziaria.";
    else giudizioPD = "üî¥ Rischio molto alto di insolvenza: richiede interventi urgenti.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü® 10. Rating MCC ‚Äì Modello Integrato</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        Il <b>Rating MCC (Medio Credito Centrale)</b> √® il modello ufficiale utilizzato dal Fondo di Garanzia per le PMI
        per stimare la <b>probabilit√† di default (PD)</b> di un‚Äôimpresa.
        Combina due moduli:
        <ul>
          <li><b>Score Economico-Finanziario (EF)</b> ‚Üí valuta redditivit√†, solidit√† e liquidit√†;</li>
          <li><b>Score Andamentale</b> ‚Üí misura puntualit√†, affidamenti e comportamento creditizio (CR, CRIF, CERVED).</li>
        </ul>
        L‚Äôintegrazione dei due punteggi avviene tramite una <b>matrice 11x11</b> che produce la classe MCC finale (da F1 a F12).
      </p>

      <h3>üìä Risultati ${anni.last}</h3>
      <table>
        <tr><th>Modulo</th><th>Classe</th><th>Score / xb</th><th>Peso</th><th>Contributo</th></tr>
        <tr><td>Economico-Finanziario (EF)</td>
            <td>${scoreEF?.classe || "‚Äì"}</td>
            <td>${scoreEF?.xb ? scoreEF.xb.toFixed(4) : "‚Äì"}</td>
            <td>50 %</td><td>${scoreEF?.classe || "‚Äì"}</td></tr>
        <tr><td>Andamentale Integrato (A)</td>
            <td>${scoreAnd?.integrato?.classe || "‚Äì"}</td>
            <td>${scoreAnd?.integrato?.xb ? scoreAnd.integrato.xb.toFixed(4) : "‚Äì"}</td>
            <td>50 %</td><td>${scoreAnd?.integrato?.classe || "‚Äì"}</td></tr>
        <tr style="background:#f0f4f8;font-weight:bold;">
          <td colspan="2">Rating MCC Complessivo</td>
          <td style="text-align:center;">Classe ${ratingMCC.rating || "‚Äì"}</td>
          <td>Fascia ${ratingMCC.fascia || "‚Äì"}</td>
          <td>PD ${ratingMCC.pd ? ratingMCC.pd.toFixed(2) + "%" : "‚Äì"}</td>
        </tr>
      </table>

      <h3>üìâ Variazioni rispetto a ${anni.prev}</h3>
      <table>
        <tr><th>Indicatore</th><th>${anni.prev}</th><th>${anni.last}</th><th>Œî</th><th>Giudizio</th></tr>
        <tr><td>Classe MCC</td>
            <td>${ratingPrev?.rating || "‚Äì"}</td><td>${ratingMCC.rating || "‚Äì"}</td>
            <td>${deltaClasse}</td>
            <td>${deltaClasse<0?"üü¢ Miglioramento":deltaClasse>0?"üî¥ Peggioramento":"‚Äì"}</td></tr>
        <tr><td>PD (Probabilit√† Default)</td>
            <td>${ratingPrev?.pd ? ratingPrev.pd.toFixed(2)+" %" : "‚Äì"}</td>
            <td>${ratingMCC.pd ? ratingMCC.pd.toFixed(2)+" %" : "‚Äì"}</td>
            <td>${deltaPD}</td>
            <td>${ratingMCC.pd<1?"üü¢ Basso":ratingMCC.pd<5?"üü° Medio":"üî¥ Alto"}</td></tr>
      </table>

      <div class="alert ${ratingMCC.pd<3?"alert-success":ratingMCC.pd<7?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        <b>${giudizioPD}</b>
      </div>

      <h3>üßÆ Interpretazione</h3>
      <p>
        La <b>classe MCC</b> varia da <b>F1 (massima solidit√†)</b> a <b>F12 (rischio elevato)</b>.
        La <b>PD (Probabilit√† di Default)</b> rappresenta la probabilit√† stimata di insolvenza entro 12 mesi.
        <ul>
          <li><b>F1‚ÄìF3</b> ‚Üí rischio basso, impresa solida;</li>
          <li><b>F4‚ÄìF6</b> ‚Üí rischio medio, situazione da monitorare;</li>
          <li><b>F7‚ÄìF12</b> ‚Üí rischio alto, possibile squilibrio finanziario.</li>
        </ul>
      </p>

      <h3>üóÇÔ∏è Riferimenti e Allegati</h3>
      <ul>
        <li>Tabella ‚ÄúMatrice MCC ‚Äì Score EF + Andamentale‚Äù ‚Üí <b>Allegato 6</b></li>
        <li>Grafico ‚ÄúDistribuzione PD per Classe MCC (F1‚ÄìF12)‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend Rating MCC e Score Andamentale trimestrale‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúEvoluzione Score EF 2022‚Äì2023‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        Il Rating MCC integra i risultati economici, patrimoniali e andamentali per fornire
        un indice sintetico della solidit√† aziendale.
        La classe ${ratingMCC.fascia || "‚Äì"} con PD ${(ratingMCC.pd||0).toFixed(2)} % colloca l‚Äôimpresa in <b>${giudizioPD.replace(/^.{2}/,"")}</b>.
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco10_RatingMCC:", err);
    return `<div class='alert alert-danger'>Errore nella generazione del blocco Rating MCC.</div>`;
  }
}

// ============================================================
// üü¶ BLOCCO 11 ‚Äì ANALISI SCENARI PROBABILISTICI (MONTE CARLO)
// ============================================================

function generaBlocco11_MonteCarlo() {
  try {
    // === Estrae dati di base da funzioni ceoDOC ===
    const last = window.calcolaIndiciComplessivi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Parametri di base ===
    const ROI = last.ROI || 0;
    const ROS = last.ROS || 0;
    const EBITDA = dscr?.last?.EBITDA || 0;
    const dscrBase = dscr?.last?.ratio || 1;

    // === Simulazione statistica (10.000 scenari) ===
    const numScenari = 10000;
    let dscrUnder1 = 0;
    let crisiLiquidita = 0;
    let risultati = [];

    for (let i = 0; i < numScenari; i++) {
      const shockROI = ROI * (1 + (Math.random() - 0.5) * 0.4); // ¬±20 %
      const shockEBITDA = EBITDA * (1 + (Math.random() - 0.5) * 0.36); // ¬±18 %
      const shockDSCR = dscrBase * (shockROI / ROI);
      risultati.push(shockDSCR);
      if (shockDSCR < 1) dscrUnder1++;
      if (shockEBITDA < EBITDA * 0.85) crisiLiquidita++;
    }

    const probDSCR = ((dscrUnder1 / numScenari) * 100).toFixed(1);
    const probCrisi = ((crisiLiquidita / numScenari) * 100).toFixed(1);
    const mediaDSCR =
      risultati.reduce((a, b) => a + b, 0) / risultati.length || 0;
    const devDSCR = Math.sqrt(
      risultati.reduce((s, x) => s + Math.pow(x - mediaDSCR, 2), 0) /
        risultati.length
    );
    const VaR95 =
      EBITDA * (1 - 1.65 * (devDSCR / (mediaDSCR || 1))); // stima semplice del VaR 95 %

    // === Giudizio automatico ===
    let giudizioMonte = "";
    if (probDSCR < 10 && probCrisi < 15)
      giudizioMonte =
        "üü¢ Elevata resilienza: la gestione rimane solida anche in scenari sfavorevoli.";
    else if (probDSCR < 25)
      giudizioMonte =
        "üü° Stabilit√† moderata: alcuni scenari mostrano vulnerabilit√† ai cali di redditivit√†.";
    else
      giudizioMonte =
        "üî¥ Elevata sensibilit√†: rischio di squilibrio in oltre un quarto degli scenari simulati.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü¶ 11. Analisi Scenari Probabilistici ‚Äì Simulazione Monte Carlo</h2>

      <h3>üß≠ A cosa serve</h3>
      <p>
        La <b>simulazione Monte Carlo</b> permette di stimare come potrebbero evolvere gli indicatori
        di redditivit√† (<b>ROI, ROS</b>) e di sostenibilit√† (<b>DSCR</b>) in diverse condizioni di mercato.
        Generando 10.000 scenari, CeoDOC valuta la <b>probabilit√† che l‚Äôimpresa mantenga l‚Äôequilibrio
        finanziario</b> o incontri tensioni di liquidit√† nel prossimo anno.
      </p>

      <h3>üìä Risultati sintetici (${anni.last})</h3>
      <table>
        <tr><th>Metrica</th><th>Valore</th><th>Interpretazione</th></tr>
        <tr><td>Probabilit√† DSCR < 1</td><td>${probDSCR} %</td><td>${probDSCR<10?"Basso rischio":"Da monitorare"}</td></tr>
        <tr><td>Probabilit√† crisi liquidit√†</td><td>${probCrisi} %</td><td>${probCrisi<15?"Controllata":"Elevata"}</td></tr>
        <tr><td>VaR 95 %</td><td>${itFmt(VaR95)}</td><td>Perdita potenziale nel 5 % peggiore degli scenari</td></tr>
        <tr><td>Deviazione standard DSCR</td><td>${devDSCR.toFixed(2)}</td><td>Volatilit√† dei flussi</td></tr>
        <tr style="background:#f0f4f8;font-weight:bold;">
          <td>DSCR medio atteso</td><td>${mediaDSCR.toFixed(2)}</td><td>Equilibrio sostenibile</td>
        </tr>
      </table>

      <div class="alert ${probDSCR<10?"alert-success":probDSCR<25?"alert-warning":"alert-danger"}" style="margin-top:10px;">
        ${giudizioMonte}
      </div>

      <h3>üßÆ Indicatori di resilienza finanziaria</h3>
      <table>
        <tr><th>Indicatore</th><th>Formula</th><th>Soglia</th><th>Valore</th><th>Giudizio</th></tr>
        <tr><td>Probabilit√† DSCR < 1</td><td>Scenari DSCR < 1 / Tot.</td><td>‚â§ 10 %</td><td>${probDSCR} %</td>
            <td>${probDSCR<=10?"üü¢ Buono":probDSCR<=25?"üü° Medio":"üî¥ Alto"}</td></tr>
        <tr><td>Probabilit√† crisi liquidit√†</td><td>CFO < 0 / Tot.</td><td>‚â§ 15 %</td><td>${probCrisi} %</td>
            <td>${probCrisi<=15?"üü¢ Buono":probCrisi<=25?"üü° Medio":"üî¥ Alto"}</td></tr>
        <tr><td>VaR (95 %)</td><td>Perdita 95¬∞ percentile</td><td>‚â§ ‚Ç¨ 500 000</td><td>${itFmt(VaR95)}</td>
            <td>${VaR95<=500000?"üü¢ Limitato":VaR95<=700000?"üü° Moderato":"üî¥ Elevato"}</td></tr>
        <tr><td>Stabilit√† DSCR (œÉ)</td><td>Dev. Std DSCR</td><td>‚â§ 0.20</td><td>${devDSCR.toFixed(2)}</td>
            <td>${devDSCR<=0.2?"üü¢ Stabile":devDSCR<=0.3?"üü° Variabile":"üî¥ Instabile"}</td></tr>
      </table>

      <h3>üóÇÔ∏è Riferimenti e Allegati</h3>
      <ul>
        <li>Grafico ‚ÄúROI vs DSCR ‚Äì Distribuzione 10.000 Scenari‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúIstogramma DSCR Simulati (Distribuzione Probabilit√†)‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúHeatmap Densit√† Scenari ‚Äì Area di Rischio‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Tabella ‚ÄúScenari e Parametri di Input Monte Carlo‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        L‚Äôanalisi Monte Carlo quantifica in termini probabilistici la capacit√† dell‚Äôimpresa di resistere
        a stress gestionali o finanziari. Un‚Äôalta stabilit√† del DSCR e un VaR limitato indicano un‚Äôazienda resiliente e solida.
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco11_MonteCarlo:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Monte Carlo.</div>`;
  }
}

// ============================================================
// üü´ BLOCCO 12 ‚Äì CONCLUSIONI E SUGGERIMENTI
// ============================================================

function generaBlocco12_Conclusioni() {
  try {
    const last = window.calcolaIndiciComplessivi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const rating = window.calcolaRatingIntegrato?.(state.scoreEF, state.scoreAndamentale) || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    // === Giudizio generale in base ai dati chiave ===
    const ROE = last.ROE || 0;
    const ROI = last.ROI || 0;
    const leverage = last.leverage || 0;
    const dscrVal = dscr?.last?.ratio || 0;
    const zVal = zscore?.last?.score || 0;
    const PD = rating?.pd || 0;

    let profilo = "";
    if (PD < 1 && dscrVal > 1.25 && ROI > 8 && leverage < 3) profilo = "üü¢ solida";
    else if (PD < 5 && dscrVal >= 1 && ROI > 4) profilo = "üü° media";
    else profilo = "üî¥ critica";

    // === Suggerimenti dinamici ===
    const suggerimenti = [];
    if (last.currentRatio < 1.2)
      suggerimenti.push("Monitorare la gestione del capitale circolante: i crediti clienti elevati riducono la cassa e impattano sul DSCR.");
    if (leverage > 3)
      suggerimenti.push("Valutare una ricapitalizzazione parziale: la leva in crescita indica dipendenza dal debito, migliorabile con capitale proprio.");
    if (ROI < 8)
      suggerimenti.push("Agire per migliorare il margine operativo: la redditivit√† in calo pu√≤ riflettersi negativamente sul rating MCC.");
    if (dscrVal < 1.25)
      suggerimenti.push("Effettuare un monitoraggio trimestrale del DSCR: flussi di cassa prossimi alla soglia critica richiedono controllo costante.");
    if (zVal < 1.8)
      suggerimenti.push("Incrementare le riserve o ridurre l‚Äôindebitamento per evitare peggioramento dello Z-Score.");

    // === Punti di forza dinamici ===
    const puntiForza = [];
    if (ROE >= 10) puntiForza.push("Alta redditivit√† del capitale proprio (ROE " + ROE.toFixed(1) + "%).");
    if (leverage <= 3) puntiForza.push("Struttura patrimoniale equilibrata e sostenibile (Leverage " + leverage.toFixed(2) + ").");
    if (dscrVal >= 1.25) puntiForza.push("Adeguata capacit√† di copertura del debito (DSCR " + dscrVal.toFixed(2) + ").");
    if (zVal >= 3) puntiForza.push("Basso rischio di insolvenza (Z-Score " + zVal.toFixed(2) + ").");
    if (PD < 1) puntiForza.push("Rating MCC eccellente (PD " + PD.toFixed(2) + "%).");

    // === Criticit√† dinamiche ===
    const criticita = [];
    if (ROI < 5) criticita.push("Redditivit√† operativa insufficiente rispetto ai benchmark.");
    if (leverage > 3) criticita.push("Elevata leva finanziaria: rischio di eccessivo indebitamento.");
    if (dscrVal < 1) criticita.push("Flussi di cassa non sufficienti a coprire il servizio del debito.");
    if (last.currentRatio < 1.0) criticita.push("Liquidit√† a breve sotto la soglia di sicurezza.");
    if (zVal < 1.8) criticita.push("Probabilit√† di insolvenza in crescita (Z-Score basso).");

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü´ 12. Conclusioni e Suggerimenti</h2>

      <h3>üìà Valutazione complessiva</h3>
      <p>
        Nel complesso, l‚Äôimpresa presenta un profilo <b>${profilo.toUpperCase()}</b>.
        La redditivit√†, la sostenibilit√† dei flussi di cassa e la struttura patrimoniale
        indicano un equilibrio ${profilo.includes("üü¢")?"gestionale positivo":profilo.includes("üü°")?"accettabile ma sensibile":"fragile con rischio elevato"}.
      </p>

      <h3>üí° Suggerimenti operativi con spiegazione</h3>
      <ul>
        ${
          suggerimenti.length
            ? suggerimenti.map(s => `<li>üîπ ${s}</li>`).join("")
            : "<li>‚úÖ Nessun intervento urgente richiesto: mantenere l‚Äôattuale assetto gestionale.</li>"
        }
      </ul>

      <h3>üü© Punti di Forza</h3>
      <ul style="color:#16a34a;">
        ${
          puntiForza.length
            ? puntiForza.map(p => `<li>‚úÖ ${p}</li>`).join("")
            : "<li>‚Äî Nessun punto di forza rilevante individuato.</li>"
        }
      </ul>

      <h3>üü• Aree di Miglioramento</h3>
      <ul style="color:#dc2626;">
        ${
          criticita.length
            ? criticita.map(c => `<li>‚ùå ${c}</li>`).join("")
            : "<li>‚Äî Nessuna criticit√† significativa.</li>"
        }
      </ul>

      <div class="alert ${profilo.includes("üü¢")?"alert-success":profilo.includes("üü°")?"alert-warning":"alert-danger"}" style="margin-top:15px;">
        ${
          profilo.includes("üü¢")
            ? "üü¢ Impresa solida: mantenere l‚Äôattuale efficienza e monitorare periodicamente la gestione."
            : profilo.includes("üü°")
            ? "üü° Impresa equilibrata ma sensibile: monitorare trimestralmente DSCR, ROI e rating MCC."
            : "üî¥ Impresa in area di rischio: necessari interventi correttivi su capitale e flussi di cassa entro 12 mesi."
        }
      </div>

      <h3>üìä Collegamenti e Allegati</h3>
      <ul>
        <li>Grafico ‚ÄúRadar ‚Äì Punti di Forza vs Aree di Miglioramento‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend Rating MCC e DSCR trimestrale‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Tabella ‚ÄúIndicatori Sintetici e Diagnosi Finale‚Äù ‚Üí <b>Allegato 4</b></li>
      </ul>

      <p style="margin-top:10px;">
        Si consiglia di <b>ripetere l‚Äôanalisi ogni 3 mesi</b> fino al deposito del prossimo bilancio consuntivo,
        per monitorare l‚Äôevoluzione dello Score Andamentale e del Rating MCC.
      </p>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco12_Conclusioni:", err);
    return `<div class='alert alert-danger'>Errore nella generazione della sezione Conclusioni e Suggerimenti.</div>`;
  }
}

// ============================================================
// üü© BLOCCO 13 ‚Äì EXECUTIVE SUMMARY
// ============================================================

function generaBlocco13_ExecutiveSummary() {
  try {
    // === Estrae dati e indicatori chiave ===
    const last = window.calcolaIndiciComplessivi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const rating = window.calcolaRatingIntegrato?.(state.scoreEF, state.scoreAndamentale) || {};
    const prod = window.calcolaIndiciProduttivitaEstesi?.() || {};
    const anni = state?.anni || { prev: "N-1", last: "N" };

    const ROE = last.ROE || 0;
    const ROI = last.ROI || 0;
    const ROS = last.ROS || 0;
    const leverage = last.leverage || 0;
    const current = last.currentRatio || 0;
    const PD = rating?.pd || 0;
    const dscrVal = dscr?.last?.ratio || 0;
    const zVal = zscore?.last?.score || 0;

    // === Determina il profilo dell'impresa ===
    let profilo = "";
    if (PD < 1 && ROI > 8 && leverage < 3 && dscrVal > 1.25)
      profilo = "üü¢ Impresa solida";
    else if (PD < 5 && ROI > 4 && dscrVal >= 1)
      profilo = "üü° Impresa equilibrata ma sensibile";
    else
      profilo = "üî¥ Impresa critica o vulnerabile";

    // === Giudizio sintetico dinamico ===
    let giudizioSintetico = "";
    if (profilo.includes("üü¢"))
      giudizioSintetico = "gestione sana, margini elevati e rischio contenuto.";
    else if (profilo.includes("üü°"))
      giudizioSintetico = "equilibrio generale ma con margini e flussi di cassa da monitorare.";
    else
      giudizioSintetico = "disequilibrio economico-finanziario con segnali di vulnerabilit√† crescente.";

    // === HTML BLOCCO ===
    let html = `
    <div class="section">
      <h2>üü© 13. Executive Summary</h2>

      <h3>üß≠ Obiettivo</h3>
      <p>
        L‚ÄôExecutive Summary fornisce una <b>visione immediata dello stato di salute aziendale</b>,
        combinando i principali indicatori economici, patrimoniali e finanziari.
        √à pensato per fornire, in modo sintetico ma chiaro, le informazioni essenziali
        a banche, revisori, soci e management.
      </p>

      <h3>üìà Valutazione complessiva</h3>
      <div class="alert ${profilo.includes("üü¢")?"alert-success":profilo.includes("üü°")?"alert-warning":"alert-danger"}">
        <b>${profilo}</b> ‚Äì ${giudizioSintetico}
      </div>

      <h3>üìä Indicatori chiave ${anni.last}</h3>
      <table>
        <tr><th>Area</th><th>Indicatore</th><th>Valore</th><th>Soglia</th><th>Giudizio</th></tr>
        <tr><td>Redditivit√†</td><td>ROE</td><td>${ROE.toFixed(2)} %</td><td>‚â• 10 %</td><td>${ROE>=10?"üü¢ Ottimo":ROE>=5?"üü° Discreto":"üî¥ Basso"}</td></tr>
        <tr><td>Redditivit√†</td><td>ROI</td><td>${ROI.toFixed(2)} %</td><td>‚â• 8 %</td><td>${ROI>=8?"üü¢ Buono":ROI>=4?"üü° Medio":"üî¥ Debole"}</td></tr>
        <tr><td>Efficienza</td><td>ROS</td><td>${ROS.toFixed(2)} %</td><td>‚â• 5 %</td><td>${ROS>=5?"üü¢ Equilibrato":"üî¥ Margine basso"}</td></tr>
        <tr><td>Solidit√†</td><td>Leverage</td><td>${leverage.toFixed(2)}</td><td>‚â§ 3</td><td>${leverage<=3?"üü¢ Buono":"üî¥ Alto"}</td></tr>
        <tr><td>Liquidit√†</td><td>Current Ratio</td><td>${current.toFixed(2)}</td><td>‚â• 1.5</td><td>${current>=1.5?"üü¢ Buona":current>=1.2?"üü° Ridotta":"üî¥ Tesa"}</td></tr>
        <tr><td>Sostenibilit√†</td><td>DSCR</td><td>${dscrVal.toFixed(2)}</td><td>‚â• 1.25</td><td>${dscrVal>=1.25?"üü¢ Sostenibile":dscrVal>=1?"üü° Fragile":"üî¥ Critico"}</td></tr>
        <tr><td>Rischio Insolvenza</td><td>Z-Score</td><td>${zVal.toFixed(2)}</td><td>‚â• 3</td><td>${zVal>=3?"üü¢ Zona sana":zVal>=1.8?"üü° Zona grigia":"üî¥ Zona rossa"}</td></tr>
        <tr><td>Rischio Creditizio</td><td>Rating MCC</td><td>Classe ${rating.fascia||"‚Äì"} (PD ${(PD||0).toFixed(2)} %)</td><td>PD < 1.5 %</td><td>${PD<1.5?"üü¢ Basso":"üü° Medio"}</td></tr>
      </table>

      <h3>üí¨ Giudizio sintetico</h3>
      <p>
        L‚Äôimpresa presenta <b>${profilo.toLowerCase()}</b> con <b>ROI ${ROI.toFixed(1)} %</b>,
        <b>DSCR ${dscrVal.toFixed(2)}</b> e <b>PD ${(PD||0).toFixed(2)} %</b>.
        Nel complesso, la societ√† mostra ${giudizioSintetico}.
        ${
          profilo.includes("üü¢")
            ? "Il posizionamento competitivo √® superiore alla media di settore e il rischio creditizio √® contenuto."
            : profilo.includes("üü°")
            ? "√à consigliato rafforzare la struttura finanziaria e migliorare la marginalit√† per consolidare il rating MCC."
            : "Si evidenziano tensioni economico-finanziarie che richiedono interventi di riequilibrio e controllo dei flussi di cassa."
        }
      </p>

      <h3>üóÇÔ∏è Riferimenti e Allegati</h3>
      <ul>
        <li>Tabella ‚ÄúIndicatori di Sintesi e KPI Principali‚Äù ‚Üí <b>Allegato 4</b></li>
        <li>Grafico ‚ÄúDashboard KPI ‚Äì Redditivit√† / Liquidit√† / Solidit√†‚Äù ‚Üí <b>Allegato 7</b></li>
        <li>Grafico ‚ÄúTrend Rating MCC e PD trimestrale‚Äù ‚Üí <b>Allegato 7</b></li>
      </ul>

      <p>
        L‚ÄôExecutive Summary rappresenta la <b>fotografia complessiva dell‚Äôazienda</b>:
        permette di individuare rapidamente i punti di forza e le aree critiche,
        fornendo al management uno strumento di decisione immediato.
      </p>
    </div>
    `;

    return html;

  } catch (err) {
    console.error("‚ùå Errore generaBlocco13_ExecutiveSummary:", err);
    return `<div class='alert alert-danger'>Errore nella generazione dell‚ÄôExecutive Summary.</div>`;
  }
}

// ============================================================
// üü™ BLOCCO 14 ‚Äì ALLEGATI TECNICI E CHIUSURA (VERSIONE DEFINITIVA)
// ============================================================

function generaBlocco14_Allegati() {
  try {
    console.log("üìé [Blocco14] Avvio raccolta allegati tecnici...");

    // === üîÅ Aggiorna e genera i contenuti se mancano ===
    if (typeof window.mostraBilanciStandardizzati === "function" && !window.htmlBilancioStandardizzato) {
window.mostraBilanciStandardizzati(); // forza caricamento corretto
const stdTables = document.querySelectorAll("#tblSP, #tblCE, .bilancio-standard");
if (stdTables.length > 0) console.log("‚úÖ Bilanci standardizzati trovati:", stdTables.length);

      try {
        window.mostraBilanciStandardizzati();
        const tblSP = document.getElementById("tblSP");
        const tblCE = document.getElementById("tblCE");
        if (tblSP) window.htmlBilancioStandardizzato = tblSP.outerHTML;
        if (tblCE) window.htmlBilancioRiclassificato = tblCE.outerHTML;
        console.log("‚úÖ Allegati SP/CE raccolti da mostraBilanciStandardizzati");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione bilanci standardizzati:", e);
      }
    }

    if (typeof window.mostraBilanciRiclassificati === "function" && !window.htmlBilancioRiclassificato) {
      try {
        window.mostraBilanciRiclassificati();
        const tblRiclass = document.querySelector(".tabella-riclassificata, #tblRiclass");
        if (tblRiclass) window.htmlBilancioRiclassificato = tblRiclass.outerHTML;
        console.log("‚úÖ Allegato bilancio riclassificato acquisito");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione bilancio riclassificato:", e);
      }
    }

    if (typeof window.mostraRendiconto === "function" && !window.htmlRendiconto) {
      try {
        window.mostraRendiconto();
        const rend = document.querySelector("#rendicontoFinanziario, .tabella-rendiconto, #tblRendiconto");
        if (rend) window.htmlRendiconto = rend.outerHTML;
        console.log("‚úÖ Allegato rendiconto finanziario acquisito");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione rendiconto:", e);
      }
    }

    if (typeof window.calcolaIndiciComplessivi === "function" && !window.htmlIndici) {
      try {
        window.calcolaIndiciComplessivi();
        const ind = document.getElementById("predisponiContent");
        if (ind) window.htmlIndici = ind.outerHTML;
        console.log("‚úÖ Allegato indici di bilancio salvato");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione indici:", e);
      }
    }

    if (typeof window.mostraDashboardKPI === "function" && !window.htmlKPI) {
      try {
        window.mostraDashboardKPI();
        const dash = document.getElementById("dashboardKPI");
        if (dash) window.htmlKPI = dash.outerHTML;
        console.log("‚úÖ Allegato dashboard KPI acquisito");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore dashboard KPI:", e);
      }
    }

    if (typeof window.mostraDashboardGraficaKPI === "function" && !window.htmlGrafici) {
      try {
        window.mostraDashboardGraficaKPI();
        const graf = document.querySelector("#graficiKPI, .graficiKPI");
        if (graf) window.htmlGrafici = graf.outerHTML;
        console.log("‚úÖ Allegato grafici KPI acquisito");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione grafici KPI:", e);
      }
    }

    if (typeof window.calcolaRatingIntegrato === "function" && !window.htmlRating) {
      try {
        const ratingEF = window.calcolaScoreEconomicoFinanziario?.();
        const ratingAnd = window.calcolaScoreAndamentaleCompleto?.();
        const rating = window.calcolaRatingIntegrato(ratingEF, ratingAnd);
        const ratingBox = document.getElementById("ratingContent");
        if (ratingBox) window.htmlRating = ratingBox.outerHTML;
        console.log("‚úÖ Allegato rating MCC acquisito");
      } catch (e) {
        console.warn("‚ö†Ô∏è Errore acquisizione rating MCC:", e);
      }
    }

    // === üîç Conta gli allegati disponibili ===
    const allegatiDisponibili = [
      window.htmlBilancioStandardizzato,
      window.htmlBilancioRiclassificato,
      window.htmlRendiconto,
      window.htmlIndici,
      window.htmlKPI,
      window.htmlGrafici,
      window.htmlRating,
    ].filter(Boolean).length;

    console.log(`üìä Totale allegati disponibili: ${allegatiDisponibili}`);

    // === üß± HTML finale ===
    let html = `
    <div class="section" style="page-break-before:always;">
      <h2>üü™ 14. Allegati Tecnici e Chiusura</h2>

      <h3>üß≠ A cosa servono gli allegati</h3>
      <p>
        Gli allegati rappresentano la <b>base tecnica e verificabile</b> della presente analisi.
        Contengono i bilanci standardizzati, le riclassificazioni, i rendiconti, gli indici,
        i grafici KPI e il <b>Rating MCC</b>.
        Tutti i dati sono generati automaticamente da <b>ceoDOC Business Intelligence Platform</b>
        sulla base dei bilanci importati e delle elaborazioni interne (DSCR, Z-Score, Monte Carlo).
      </p>

      <h3>üìÅ Elenco Allegati</h3>
      <table>
        <tr><th>#</th><th>Contenuto</th><th>Descrizione</th></tr>
        <tr><td>1</td><td>Bilanci Standardizzati</td><td>Dati SP e CE omogeneizzati per analisi comparata</td></tr>
        <tr><td>2</td><td>Bilanci Riclassificati</td><td>Riclassificazioni a Costo del Venduto, Valore Aggiunto, Margine</td></tr>
        <tr><td>3</td><td>Rendiconto Finanziario</td><td>Flussi di cassa (CFO, CFI, CFF) e Stato Patrimoniale Finanziario</td></tr>
        <tr><td>4</td><td>Indici di Bilancio e KPI</td><td>Indicatori economico-patrimoniali e dashboard KPI</td></tr>
        <tr><td>5</td><td>Rating MCC</td><td>Score EF + Andamentale con PD e Classe MCC</td></tr>
        <tr><td>6</td><td>Grafici KPI</td><td>Andamento ROI, ROS, DSCR, Monte Carlo e Radar Performance</td></tr>
      </table>

      <h3>üìä Allegati tecnici inclusi</h3>
      <p>Totale allegati rilevati: <b>${allegatiDisponibili}</b></p>

      ${window.htmlBilancioStandardizzato ? `<h3>üìò Bilancio Standardizzato</h3>${window.htmlBilancioStandardizzato}` : ""}
      ${window.htmlBilancioRiclassificato ? `<h3>üìó Bilancio Riclassificato</h3>${window.htmlBilancioRiclassificato}` : ""}
      ${window.htmlRendiconto ? `<h3>üíß Rendiconto Finanziario</h3>${window.htmlRendiconto}` : ""}
      ${window.htmlIndici ? `<h3>üìä Indici di Bilancio Completi</h3>${window.htmlIndici}` : ""}
      ${window.htmlKPI ? `<h3>üìà Dashboard KPI</h3>${window.htmlKPI}` : ""}
      ${window.htmlGrafici ? `<h3>üìâ Grafici KPI e Andamenti</h3>${window.htmlGrafici}` : ""}
      ${window.htmlRating ? `<h3>üè¶ Rating MCC ‚Äì Dettaglio Tecnico</h3>${window.htmlRating}` : ""}

      <div style="margin-top:30px;padding:15px;border-top:2px solid #003d82;">
        <h3>üßæ Dichiarazione e Chiusura</h3>
        <p>
          La presente analisi √® stata elaborata automaticamente da <b>ceoDOC Business Intelligence Platform</b>
          versione 2.0, sulla base dei dati di bilancio importati dall‚Äôutente e delle informazioni andamentali disponibili.
        </p>
        <p>
          Tutti i calcoli (indici, DSCR, Z-Score, Rating MCC e Simulazioni Monte Carlo)
          sono effettuati secondo metodologie certificate e documentate.
        </p>
        <p style="font-size:13px;color:#555;margin-top:15px;text-align:center;">
          ¬© 2025 ceoDOC ‚Äì Sistema di Analisi Finanziaria e Rating MCC Integrato<br>
          <b>Relazione generata automaticamente il ${new Date().toLocaleString("it-IT")}</b>
        </p>
      </div>
    </div>
    `;

    return html;
  } catch (err) {
    console.error("‚ùå Errore generaBlocco14_Allegati:", err);
    return `<div class='alert alert-danger'>Errore durante la generazione della sezione Allegati Tecnici e Chiusura.</div>`;
  }
}


// =====================================================
// üíæ SALVA ELABORAZIONI COMPLETE ‚Äì versione finale 2025 FIX
// =====================================================
window.salvaElaborazioniComplete = function () {
  try {
    console.group("üíæ Salvataggio elaborazioni complete");

    // üü¶ 1Ô∏è‚É£ Attiva modalit√† silenziosa per evitare l‚Äôapertura di card/modali
    window.SILENT_MODE = true;

    // üü¢ 2Ô∏è‚É£ Controllo stato base
    if (!state?.cf || !state?.anni?.last) {
      toast("‚ö†Ô∏è Nessun bilancio o codice fiscale valido", true);
      console.warn("‚ö†Ô∏è Stato incompleto:", state);
      return;
    }

    const cf = state.cf;
    const anni = state.anni;
    const keyTabelle = `ceodoc_tabelle_${cf}_${anni.prev}_${anni.last}`;

    // üü° 3Ô∏è‚É£ Recupera o ricarica le tabelle (con ricerca alternativa)
    let tabelle = state.tabelle;
    let savedTabelle = null;

    if (!tabelle || !Object.keys(tabelle).length) {
      savedTabelle = localStorage.getItem(keyTabelle);

      // üß© FIX ‚Üí ricerca chiavi alternative se quella principale non esiste
      if (!savedTabelle) {
        const allKeys = Object.keys(localStorage);
        const altKey = allKeys.find(
          (k) => k.startsWith(`ceodoc_tabelle_${cf}_`) && k.includes(anni.last)
        );
        if (altKey) {
          savedTabelle = localStorage.getItem(altKey);
          console.warn(`‚öôÔ∏è Tabella trovata con chiave alternativa: ${altKey}`);
        }
      }

      // Se trovata, parse JSON
      if (savedTabelle) {
        try {
          tabelle = JSON.parse(savedTabelle);
          state.tabelle = tabelle;
          console.log("üìä Tabelle ricaricate da localStorage:", keyTabelle);
        } catch (err) {
          console.error("‚ùå Errore parsing tabelle salvate:", err);
          tabelle = {};
        }
      } else {
        console.warn("‚ö†Ô∏è Nessuna tabella trovata, salto salvataggio");
      }
    }

    // üßÆ 4Ô∏è‚É£ Calcoli principali (tutti in modalit√† silenziosa)
    const indiciPrev = window.calcolaIndiciComplessiviPrev?.() || {};
    const indiciLast = window.calcolaIndiciComplessivi?.() || {};
    const produttivita = window.calcolaIndiciProduttivitaEstesi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};

    // ‚úÖ 5Ô∏è‚É£ Score EF + Andamentale + Rating MCC
    const scoreEF = state.scoreEF || window.calcolaScoreEconomicoFinanziario?.();
    const scoreAnd = state.scoreAndamentale || window.calcolaScoreAndamentaleCompleto?.();
    const rating = window.calcolaRatingIntegrato?.(scoreEF, scoreAnd) || {};

    // üé≤ 6Ô∏è‚É£ Monte Carlo Simulation
    let montecarlo = {};
    if (typeof window.eseguiMonteCarloSimulationPro === "function") {
      try {
        montecarlo = window.eseguiMonteCarloSimulationPro();
        console.log("üé≤ Monte Carlo Simulation Results:", montecarlo);
      } catch (err) {
        console.warn("‚ö†Ô∏è Errore Monte Carlo (ignorato nel salvataggio):", err);
      }
    }

    // üóÇÔ∏è 7Ô∏è‚É£ Prepara pacchetto da salvare
    const analisi = {
      cf,
      anni,
      timestamp: new Date().toISOString(),
      tabelle,
      indici: { prev: indiciPrev, last: indiciLast },
      produttivita,
      dscr,
      zscore,
      rating,
      montecarlo
    };

    // üíæ 8Ô∏è‚É£ Salva in localStorage
    const keyAnalisi = `ceodoc_elaborazioni_${cf}_${anni.prev}_${anni.last}`;
    localStorage.setItem(keyAnalisi, JSON.stringify(analisi));
    console.log(`üíæ Tutte le elaborazioni salvate per ${cf}`, anni);

    // ‚úÖ 9Ô∏è‚É£ Aggiorna ultimo salvataggio
    localStorage.setItem(
      "ceodoc_ultima_analisi",
      JSON.stringify({
        dataGenerazione: new Date().toISOString(),
        azienda: state.denom,
        cf,
        tipo: state.tipo,
        esercizi: { precedente: anni.prev, ultimo: anni.last }
      })
    );

    // üü© 10Ô∏è‚É£ Feedback utente
    toast("‚úÖ Tutte le elaborazioni salvate con successo");
    console.groupEnd();

  } catch (err) {
    console.error("‚ùå Errore salvaElaborazioniComplete:", err);
    toast("Errore durante il salvataggio delle elaborazioni", true);
  } finally {
    // üîÑ 11Ô∏è‚É£ Riattiva interfaccia normale
    window.SILENT_MODE = false;
  }
};



// ============================================================
// üìò BLOCCO 15 GENERA ANALISI COMPLETA - Versione Professionale CARD SVG 2025  
// ============================================================
window.generaAnalisiCompleta = function () {
  try {
    console.log("üöÄ Avvio generazione Analisi Completa in card...");

    // 1Ô∏è‚É£ Verifica dati base
    if (!state?.spRows?.length || !state?.ceRows?.length) {
      toast("‚ö†Ô∏è Importa prima un bilancio per generare la relazione", true);
      return;
    }

    // 2Ô∏è‚É£ Crea o recupera la card principale
    let card = document.getElementById("cardAnalisiCompleta");
    if (!card) {
      card = document.createElement("div");
      card.id = "cardAnalisiCompleta";
      document.body.appendChild(card);
    }
    card.innerHTML = ""; // Pulisce eventuali contenuti precedenti
    card.style.cssText = `
      position: fixed;
      inset: 0;
      background: #f8fafc;
      overflow-y: auto;
      z-index: 9999;
      padding: 20px;
    `;

    // 3Ô∏è‚É£ Header con SVG logo e barra comandi
    const azienda = {
      nome: state.denom || "Impresa",
      cf: state.cf || "‚Äî",
      settore: state.settore || "‚Äî",
      tipo: state.tipo || "‚Äî",
      anni: state.anni || { prev: "N-1", last: "N" },
      dataAnalisi: new Date().toLocaleString("it-IT")
    };

    const headerHTML = `
      <div style="
        display:flex;justify-content:space-between;align-items:center;
        background:linear-gradient(90deg,#003d82,#2563eb);
        color:white;padding:20px 30px;border-radius:12px 12px 0 0;
      ">
        <div style="display:flex;align-items:center;gap:15px;">
          <!-- SVG LOGO -->
          <svg width="42" height="42" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#ff6b00"/>
                <stop offset="100%" stop-color="#2563eb"/>
              </linearGradient>
            </defs>
            <rect x="10" y="60" width="8" height="30" rx="2" fill="url(#grad1)"/>
            <rect x="25" y="45" width="8" height="45" rx="2" fill="url(#grad1)"/>
            <rect x="40" y="35" width="8" height="55" rx="2" fill="url(#grad1)"/>
            <rect x="55" y="50" width="8" height="40" rx="2" fill="url(#grad1)"/>
            <rect x="70" y="40" width="8" height="50" rx="2" fill="url(#grad1)"/>
          </svg>

          <div>
            <h2 style="margin:0;font-size:22px;">Analisi Completa ‚Äì ${azienda.nome}</h2>
            <small>CF: ${azienda.cf} ‚Ä¢ ${azienda.settore} ‚Ä¢ ${azienda.tipo}</small><br>
            <small>Periodo: ${azienda.anni.prev} ‚Äì ${azienda.anni.last}</small>
          </div>
        </div>

               <!-- === TOOLBAR AZIONI ANALISI === -->
        <div id="toolbarAnalisi" style="display:flex;gap:12px;">
          <button class="btn-analisi" onclick="openScoreAndamentaleInput()">
            <svg width="18" height="18" style="margin-right:6px;vertical-align:middle;">
              <use href="#icon-info"></use>
            </svg>
            Aggiorna Score Andamentale
          </button>

          <button class="btn-analisi" onclick="salvaAnalisiCompleta()">
            <svg width="18" height="18" style="margin-right:6px;vertical-align:middle;">
              <use href="#icon-ok"></use>
            </svg>
            Salva Analisi
          </button>

          <button class="btn-analisi" onclick="window.print()">
            <svg width="18" height="18" style="margin-right:6px;vertical-align:middle;">
              <use href="#icon-grafico"></use>
            </svg>
            Esporta Analisi PDF
          </button>

          <button class="btn-analisi danger"
            onclick="eliminaAnalisiSalvata(state?.cf ? 'ceodoc_analisi_' + state.cf + '_' + (state.anni?.last || '') : '')">
            <svg width="18" height="18" style="margin-right:6px;vertical-align:middle;">
              <use href="#icon-error"></use>
            </svg>
            Elimina Analisi
          </button>
        </div>
      </div>
    `;

    // 4Ô∏è‚É£ Aggiunge header e contenitore corpo
    card.innerHTML += headerHTML;
    card.innerHTML += `<div id="analisiContainer" style="max-width:1100px;margin:30px auto;"></div>`;
    const container = document.getElementById("analisiContainer");

    // 5Ô∏è‚É£ Stile base
    const style = document.createElement("style");
    style.innerHTML = `
      #cardAnalisiCompleta button {
        border:none;color:white;padding:8px 10px;border-radius:6px;
        font-weight:600;cursor:pointer;transition:0.2s;
      }
      #cardAnalisiCompleta button:hover { opacity:0.9; }
      #cardAnalisiCompleta .section {
        background:white;padding:25px;margin-top:25px;border-radius:12px;
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
      }
      #cardAnalisiCompleta h2 {
        color:#003d82;border-bottom:2px solid #003d82;padding-bottom:6px;
      }
      #cardAnalisiCompleta table {
        border-collapse:collapse;width:100%;margin-top:10px;
      }
      #cardAnalisiCompleta th, #cardAnalisiCompleta td {
        border:1px solid #e5e7eb;padding:8px;font-size:14px;text-align:left;
      }

  /* Toolbar analisi - pulsanti SVG */
  .btn-analisi {
    display:flex;
    align-items:center;
    background:#003d82;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
    transition:background 0.2s;
  }
  .btn-analisi:hover { background:#2563eb; }
  .btn-analisi.danger { background:#b91c1c; }
  .btn-analisi.danger:hover { background:#dc2626; }

      #cardAnalisiCompleta th { background:#f1f5f9;color:#003d82; }
    `;
    card.appendChild(style);

    // 6Ô∏è‚É£ Avvio generazione blocchi analisi
    toast("üìä Generazione analisi in corso...");
    let html = "";

    // BLOCCO 1 ‚Äî Nota Metodologica
    html += generaBlocco1_NoteMetodologica();
    html += generaBlocco2_CostoVenduto();
    html += generaBlocco3_ValoreAggiunto();
    html += generaBlocco4_MargineContribuzione();
    html += generaBlocco5_BreakEven();
    html += generaBlocco6_RendicontoFinanziario();
    html += generaBlocco7_IndiciBilancio();
    html += generaBlocco8_AllertaCrisi();
    html += generaBlocco9_DSCR_ZScore();
    html += generaBlocco10_RatingMCC();
    html += generaBlocco11_MonteCarlo();
    html += generaBlocco12_Conclusioni();
    html += generaBlocco13_ExecutiveSummary();
    html += generaBlocco14_Allegati();

    // 7Ô∏è‚É£ Inserisci nel contenitore
    container.innerHTML = html;

    console.groupEnd();
    toast("‚úÖ Analisi completa generata correttamente.");
  } catch (err) {
    console.error("‚ùå Errore generaAnalisiCompleta:", err);
    toast("Errore durante la generazione dell‚Äôanalisi", true);
  }
};


// =====================================================
// üíæ SALVA ANALISI COMPLETA (VERSIONE AGGIORNATA 2025)
// =====================================================
window.salvaAnalisiCompleta = function () {
  try {
    // Verifica che ci siano bilanci validi
    if (!state?.spRows?.length || !state?.ceRows?.length) {
      toast("‚ö†Ô∏è Nessun bilancio caricato da salvare", true);
      return;
    }

    // Normalizza informazioni aziendali
    const azienda = {
      denominazione: state.denom || "‚Äî",
      cf: state.cf || "‚Äî",
      settore: state.settore || "‚Äî",
      tipoBilancio: state.tipo || "‚Äî",
      anni: state.anni || { prev: null, last: null }
    };

    // Crea ID univoco
    const id = `ceodoc_analisi_${azienda.cf}_${azienda.anni.last || "NA"}`;

    // Calcola gli indicatori
    const prev = window.calcolaIndiciComplessiviPrev?.() || {};
    const last = window.calcolaIndiciComplessivi?.() || {};
    const prod = window.calcolaIndiciProduttivitaEstesi?.() || {};
    const dscr = window.calcolaDSCRCompleto?.() || {};
    const zscore = window.calcolaZScoreCompleto?.() || {};
    const rating = window.calcolaRatingIntegrato?.(state.scoreEF, state.scoreAndamentale) || {};

    // Crea oggetto analisi
    const analisi = {
      id,
      timestamp: new Date().toISOString(),
      azienda,
      dati: {
        bilanci: {
          sp: state.spRows || [],
          ce: state.ceRows || []
        },
        indici: { prev, last },
        produttivita: prod,
        dscr,
        zscore,
        rating
      },
      note: {
        economici: analisiSezione?.("economici", last) || "",
        finanziari: analisiSezione?.("finanziari", last) || "",
        patrimoniali: analisiSezione?.("patrimoniali", last) || "",
        produttivita: analisiSezione?.("produttivita", last) || "",
        crisi: analisiSezione?.("crisi", { DSCR: dscr?.last?.ratio, ZScore: zscore?.last?.score }) || "",
        analisiComplessiva: analisiComplessiva?.(last, dscr, zscore) || ""
      }
    };

    // üîπ Salva singola analisi
    localStorage.setItem(id, JSON.stringify(analisi));

    // üîπ Aggiorna storico
    let storico = [];
    try {
      storico = JSON.parse(localStorage.getItem("ceodoc_storico_analisi") || "[]");
    } catch {
      storico = [];
    }

    // Rimuove eventuale duplicato
    storico = storico.filter(a => a.id !== id);
    storico.push({
      id,
      azienda,
      timestamp: analisi.timestamp,
      rating: rating?.rating || "‚Äî",
      zscore: zscore?.last?.score || null,
      dscr: dscr?.last?.ratio || null
    });

    localStorage.setItem("ceodoc_storico_analisi", JSON.stringify(storico));

    toast(`‚úÖ Analisi salvata: ${azienda.denominazione} (${azienda.anni.last || "Anno"})`);
    console.log("üíæ Analisi completa salvata:", analisi);
  } catch (err) {
    console.error("‚ùå Errore salvaAnalisiCompleta:", err);
    toast("Errore nel salvataggio analisi", true);
  }
};


// =====================================================
// üìú MOSTRA LISTA ANALISI SALVATE (con pulsante Pulisci)
// =====================================================
window.mostraListaAnalisiSalvate = function () {
  try {
    const storico = JSON.parse(localStorage.getItem("ceodoc_storico_analisi") || "[]");

    // Nessuna analisi salvata
    if (!storico.length) {
      toast("Nessuna analisi salvata al momento", true);
      return;
    }

    // === CREA MODALE ===
    const modal = document.createElement("div");
    modal.id = "modalListaAnalisi";
    modal.style.cssText = `
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 10000; display: flex; align-items: center; justify-content: center;
    `;

    const container = document.createElement("div");
    container.style.cssText = `
      background: white; width: 90%; max-width: 1200px; max-height: 85vh;
      border-radius: 12px; overflow-y: auto; padding: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    `;

    // === HEADER ===
    container.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#003d82;margin:0;">üìú Analisi Salvate</h2>
        <button onclick="document.getElementById('modalListaAnalisi').remove()" 
          style="background:#dc2626;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
          Chiudi ‚úñ
        </button>
      </div>

      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead style="background:#f1f5f9;">
          <tr style="text-align:left;color:#003d82;">
            <th style="padding:8px;border-bottom:2px solid #003d82;">Azienda</th>
            <th style="padding:8px;border-bottom:2px solid #003d82;">CF</th>
            <th style="padding:8px;border-bottom:2px solid #003d82;">Anno</th>
            <th style="padding:8px;border-bottom:2px solid #003d82;">Settore</th>
            <th style="padding:8px;border-bottom:2px solid #003d82;">Data Salvataggio</th>
            <th style="padding:8px;border-bottom:2px solid #003d82;text-align:center;">Azioni</th>
          </tr>
        </thead>
        <tbody id="listaAnalisiBody"></tbody>
      </table>

      <!-- üî∏ PULISCI ANALISI CORROTTE -->
      <div style="text-align:right;margin-top:10px;">
        <button class="btn btn-orange" onclick="pulisciAnalisiCorrotte()" 
                style="background:#f97316;color:white;border:none;padding:8px 16px;
                       border-radius:6px;cursor:pointer;font-weight:600;">
          üßπ Pulisci Analisi Corrotte
        </button>
      </div>
    `;

    // === POPOLA TABELLA ===
    const body = container.querySelector("#listaAnalisiBody");
    body.innerHTML = storico.map(a => {
      const data = new Date(a.timestamp).toLocaleString("it-IT");
      return `
        <tr style="border-bottom:1px solid #e5e7eb;">
          <td style="padding:6px;">${a.azienda?.denominazione || "‚Äî"}</td>
          <td style="padding:6px;">${a.azienda?.cf || "‚Äî"}</td>
          <td style="padding:6px;">${a.azienda?.anni?.last || "‚Äî"}</td>
          <td style="padding:6px;">${a.azienda?.settore || "‚Äî"}</td>
          <td style="padding:6px;">${data || "‚Äî"}</td>
          <td style="padding:6px;text-align:center;">
            <button onclick="apriAnalisiSalvata('${a.id}')" 
              style="background:#1e40af;color:white;border:none;padding:6px 10px;
                     border-radius:4px;cursor:pointer;">üìÇ Apri</button>
            <button onclick="eliminaAnalisiSalvata('${a.id}')" 
              style="background:#dc2626;color:white;border:none;padding:6px 10px;
                     border-radius:4px;cursor:pointer;margin-left:6px;">üóëÔ∏è Elimina</button>
          </td>
        </tr>
      `;
    }).join("");

    modal.appendChild(container);
    document.body.appendChild(modal);

  } catch (err) {
    console.error("‚ùå Errore mostraListaAnalisiSalvate:", err);
    toast("Errore apertura lista analisi", true);
  }
};

// =====================================================
// üìÇ APRI ANALISI SALVATA (VERSIONE 2025 MIGLIORATA)
// =====================================================
window.apriAnalisiSalvata = function (id) {
  try {
    const analisi = JSON.parse(localStorage.getItem(id));
    if (!analisi) {
      toast("‚ùå Analisi non trovata", true);
      return;
    }

    // üîπ Ripristina lo stato base (bilanci, anagrafica, tabelle)
    state.cf = analisi.azienda.cf;
    state.denom = analisi.azienda.denominazione;
    state.settore = analisi.azienda.settore;
    state.anni = analisi.azienda.anni;
    state.spRows = analisi.dati.bilanci.sp;
    state.ceRows = analisi.dati.bilanci.ce;
    state.tabelle = analisi.dati.tabelle || {};

    // üîπ Aggiorna il salvataggio corrente
    localStorage.setItem("ceodoc_analisi_attiva", JSON.stringify(analisi));

    // üîπ Chiudi la modale (se aperta)
    document.getElementById("modalListaAnalisi")?.remove();

    // üîπ Notifica all‚Äôutente
    toast(`‚úÖ Analisi <b>${analisi.azienda.denominazione}</b> caricata con successo`);

    // üî∏ Rigenera automaticamente la relazione completa nella card
    if (typeof window.generaAnalisiCompleta === "function") {
      setTimeout(() => window.generaAnalisiCompleta(), 400);
    }

  } catch (err) {
    console.error("‚ùå Errore apriAnalisiSalvata:", err);
    toast("‚ùå Errore durante l‚Äôapertura dell‚Äôanalisi salvata", true);
  }
};

// =====================================================
// üóëÔ∏è ELIMINA ANALISI SALVATA
// =====================================================
window.eliminaAnalisiSalvata = function (id) {
  try {
    const conferma = confirm("Eliminare definitivamente questa analisi?");
    if (!conferma) return;

    let storico = JSON.parse(localStorage.getItem("ceodoc_storico_analisi") || "[]");
    storico = storico.filter((a) => a.id !== id);
    localStorage.setItem("ceodoc_storico_analisi", JSON.stringify(storico));

    localStorage.removeItem(id);
    document.getElementById("modalListaAnalisi")?.remove();
    mostraListaAnalisiSalvate();
    toast("üóëÔ∏è Analisi eliminata");
  } catch (err) {
    console.error("‚ùå Errore eliminaAnalisiSalvata:", err);
    toast("Errore durante eliminazione analisi", true);
  }
};

// üßπ PULISCE ANALISI SALVATE NON VALIDE O DUPLICATE
window.pulisciAnalisiCorrotte = function () {
  try {
    // 1Ô∏è‚É£ Ripulisce storico
    const storico = JSON.parse(localStorage.getItem("ceodoc_storico_analisi") || "[]");
    const valido = storico.filter(a => a?.azienda?.cf && a?.timestamp);
    localStorage.setItem("ceodoc_storico_analisi", JSON.stringify(valido));

    // 2Ô∏è‚É£ Elimina singole analisi corrotte o vuote
    Object.keys(localStorage)
      .filter(k => k.startsWith("ceodoc_analisi_"))
      .forEach(k => {
        try {
          const obj = JSON.parse(localStorage.getItem(k));
          if (!obj?.azienda?.cf) {
            console.warn("üóëÔ∏è Rimosso:", k);
            localStorage.removeItem(k);
          }
        } catch {
          console.warn("üóëÔ∏è Rimosso (non JSON):", k);
          localStorage.removeItem(k);
        }
      });

    toast(`üßπ Pulizia completata. Analisi valide: ${valido.length}`);
mostraListaAnalisiSalvate();
  } catch (err) {
    console.error("Errore pulizia analisi:", err);
    toast("Errore durante la pulizia delle analisi", true);
  }
};


/* ====== EVENT LISTENERS ====== */
document.addEventListener('DOMContentLoaded', function() {
    // Carica anagrafica attiva all'avvio e MOSTRA SUBITO IL SETTORE
    (function caricaAnagraficaDiretta() {
        try {
            const anagrafica = getAnagraficaAttiva();
            if (anagrafica) {
                state.denom = anagrafica.ragioneSociale || state.denom;
                state.cf = anagrafica.cf || state.cf;
                
                // Aggiorna display
                byId("denom").textContent = state.denom;
                byId("cf").textContent = state.cf;
                aggiornaHeaderAzienda();

                // SELEZIONA SUBITO IL SETTORE
                if (anagrafica.settore) {
                    const settoreMap = {
                        'AGRICOLTURA': 'Agricoltura',
                        'INDUSTRIA': 'Industria', 
                        'EDILIZIA': 'Edilizia',
                        'COMMERCIO': 'Commercio',
                        'IMMOBILIARE': 'Immobiliare',
                        'SERVIZI': 'Servizi'
                    };
                    const settoreDaUsare = settoreMap[anagrafica.settore] || 'Servizi';
                    selectSettore(settoreDaUsare);
                }
                
                // Carica anche ATECO se presente all'avvio
                if (anagrafica.codiceAteco) {
                    aggiornaAteco(anagrafica.codiceAteco);
                    console.log('‚úÖ ATECO precaricato:', anagrafica.codiceAteco);
                }
                
                console.log('‚úÖ Anagrafica e settore precaricati:', anagrafica.ragioneSociale, anagrafica.settore);
            }
        } catch(e) {
            console.error('Errore caricamento anagrafica:', e);
        }
    })();
    
    // Controlla periodicamente se l'anagrafica √® cambiata
    setInterval(() => {
        const anagraficaNuova = getAnagraficaAttiva();
        if (anagraficaNuova && anagraficaNuova.cf) {
            // Se √® cambiata, aggiorna tutto
            if (state.cf !== anagraficaNuova.cf) {
                // Reset codice ATECO quando cambia azienda
                state.codiceAteco = "";
                const valoreAteco = byId('valoreAteco');
                if (valoreAteco) {
                    valoreAteco.textContent = '‚Äî';
                }
                console.log('üîÑ Reset ATECO per cambio anagrafica');
                
                // Pulisci i check quando cambia anagrafica
                pulisciChecks();
                
                // Reset anche i campi verdi
                const tipoBilDisplay = byId('tipoBilDisplay');
                if (tipoBilDisplay) {
                    tipoBilDisplay.textContent = '‚Äî';
                    tipoBilDisplay.style.background = '';
                    tipoBilDisplay.style.color = '';
                }
                
                const eserciziDisplay = byId('eserciziDisplay');
                if (eserciziDisplay) {
                    eserciziDisplay.textContent = '‚Äî';
                    eserciziDisplay.style.background = '';
                    eserciziDisplay.style.color = '';
                }
                
                state.denom = anagraficaNuova.ragioneSociale || state.denom;
                state.cf = anagraficaNuova.cf || state.cf;
                
                // Aggiorna display
                byId("denom").textContent = state.denom;
                byId("cf").textContent = state.cf;
                aggiornaHeaderAzienda();

                // AGGIORNA ANCHE IL SETTORE
                if (anagraficaNuova.settore) {
                    const settoreMap = {
                        'AGRICOLTURA': 'Agricoltura',
                        'INDUSTRIA': 'Industria', 
                        'EDILIZIA': 'Edilizia',
                        'COMMERCIO': 'Commercio',
                        'IMMOBILIARE': 'Immobiliare',
                        'SERVIZI': 'Servizi'
                    };
                    const settoreDaUsare = settoreMap[anagraficaNuova.settore] || 'Servizi';
                    selectSettore(settoreDaUsare);
                    console.log('üîÑ Anagrafica cambiata, nuovo settore:', settoreDaUsare);
                }
                
                // Carica codice ATECO se gi√† presente per questa nuova azienda
                if (anagraficaNuova.codiceAteco) {
                    aggiornaAteco(anagraficaNuova.codiceAteco);
                    console.log('üîÑ ATECO caricato da anagrafica:', anagraficaNuova.codiceAteco);
                }
            }
        }
    }, 1000);
    
    // Il resto rimane uguale...
    
    // Import buttons (TUTTO IL RESTO RIMANE UGUALE)
    byId("btnImportXLS").onclick = importXLS;
    byId("btnImportXBRL").onclick = importXBRL;
    byId("btnAzzera").onclick = azzera;
    byId("btnCaricaBilancioSalvato").onclick = mostraListaBilanci;
    
    // Bilanci tab buttons
    if (byId("btnSalvaBilancio")) {
        byId("btnSalvaBilancio").onclick = salvaBilancio;
    }
    if (byId("btnListaBilanci")) {
        byId("btnListaBilanci").onclick = mostraListaBilanci;
    }
   
   if (byId("btnListaAnalisi")) {
  byId("btnListaAnalisi").onclick = mostraListaAnalisiSalvate;
}

    
    // Rating tab buttons
    if (byId("btnScoreEF")) {
        byId("btnScoreEF").onclick = () => wip("Score Economico Finanziario");
    }
    if (byId("btnScoreAnd")) {
        byId("btnScoreAnd").onclick = openScoreAndamentale;
    }
if (byId("btnRatingMCC")) {
    byId("btnRatingMCC").onclick = function() {
        const scoreEF = state.scoreEF || calcolaScoreEconomicoFinanziario();
        const scoreAnd = state.scoreAndamentale || calcolaScoreAndamentaleCompleto();

        if (!scoreEF || !scoreAnd) {
            toast("‚ö†Ô∏è Calcola prima Score EF e Score Andamentale", true);
            return;
        }

        const rating = calcolaRatingIntegrato(scoreEF, scoreAnd);

        if (!rating) {
            toast("Errore nel calcolo del Rating MCC", true);
            return;
        }

        const msg = `
            <div style="text-align:center;">
                <h2 style="color:#003d82;">üìä Rating MCC Integrato</h2>
                <div style="font-size:48px;font-weight:bold;color:#f97316;margin:10px 0;">
                    Classe ${rating.rating}
                </div>
                <div style="font-size:16px;">Fascia ${rating.fascia} ‚Ä¢ PD: ${rating.pd.toFixed(2)}%</div>
                <div style="margin-top:15px;font-size:14px;color:#555;">
                    Score EF: ${rating.scoreEF} ‚Ä¢ Score Andamentale: ${rating.scoreAnd}
                </div>
            </div>
        `;

        const modal = document.createElement("div");
        modal.style.cssText = `
            position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;
            display:flex;align-items:center;justify-content:center;
        `;
        modal.innerHTML = `
            <div style="background:#fff;padding:30px;border-radius:12px;width:420px;text-align:center;">
                ${msg}
                <button onclick="this.closest('div').parentNode.remove()" 
                        style="margin-top:20px;padding:8px 20px;background:#003d82;color:white;border:none;border-radius:6px;cursor:pointer;">
                    Chiudi
                </button>
            </div>`;
        document.body.appendChild(modal);
    };
}

    if (byId("btnGrafici")) {
        byId("btnGrafici").onclick = () => wip("Visualizza Grafici e KPI");
    }
    
// =====================================================
// üìä FASE 5 - ANALISI COMPLETA (nuova gestione pulsanti)
// =====================================================
if (byId("btnGeneraAnalisi")) {
    byId("btnGeneraAnalisi").onclick = generaAnalisiCompleta;
}
if (byId("btnListaAnalisi")) {
    byId("btnListaAnalisi").onclick = mostraListaAnalisiSalvate;
}
    
    // Tab navigation
    window.showTab = showTab;
    
    // Initial setup
    updateWorkflowSteps('import');
});
// ========== SCORING FDG - AGGIUNTE DOPO RIGA 3000 ==========

// Coefficienti completi per settore da Circolare MCC
const COEFFICIENTI_FDG = {
    INDUSTRIA: {
        K: -4.584023,
        variabili: {
            V1: {coef: 1.709764, cap: 1.4, floor: 0.4},
            V2: {coef: 1.006155, cap: 1, floor: -1},
            V3: {coef: 21.7339, cap: 0.06, floor: 0.01},
            V4: {coef: -3.257383, cap: 0.3, floor: 0.01},
            V5: {coef: -0.035931, cap: 11, floor: 1.4},
            V6: {coef: 0.874921, cap: 0.6, floor: -0.4, pret: -0.1},
            V7: {coef: -1.842869, cap: 0.64, floor: 0},
            D1: {coef: -1.380648},
            D2: {coef: 0.502537},
            D3: {coef: -1.318575},
            D4: {coef: 0.925375},
            D5: {coef: -0.672704},
            D6: {coef: -11.51058},
            D7: {coef: 1.934049}
        }
    },
    EDILIZIA: {
        K: -4.258458,
        variabili: {
            V2: {coef: 0.37765, cap: 1, floor: -1},
            V3: {coef: 34.64145, cap: 0.03, floor: 0},
            V7: {coef: -1.882866, cap: 2, floor: 0},
            V9: {coef: 1.314629, cap: 1, floor: 0},
            V10: {coef: 0.448655, cap: 1, floor: 0},
            V11: {coef: -5.638927, cap: 0.07, floor: 0},
            V12: {coef: -0.05176, cap: 8, floor: 0},
            V13: {coef: 0.329288, cap: 1.6, floor: -0.6, pret: -0.1},
            D1: {coef: -0.779867},
            D4: {coef: 0.48568},
            D8: {coef: -0.998434},
            D9: {coef: -0.655727}
        }
    },
    COMMERCIO: {
        K: -1.88977,
        variabili: {
            V2: {coef: 0.73753, cap: 1, floor: -1},
            V3: {coef: 16.97147, cap: 0.08, floor: 0},
            V4: {coef: -3.97341, cap: 0.1, floor: 0.01},
            V6: {coef: 1.446892, cap: 0.54, floor: -0.36, pret: -0.06},
            V7: {coef: -2.86327, cap: 1.6, floor: 0},
            V14: {coef: -1.68061, cap: 0.3, floor: 0},
            V15: {coef: -0.33307, cap: 2, floor: 0},
            V16: {coef: -0.85672, cap: 1.7, floor: 0.5},
            D1: {coef: -1.3164},
            D3: {coef: -2.98436},
            D6: {coef: -8.28285},
            D10: {coef: 1.368938},
            D11: {coef: 0.207691}
        }
    },
    SERVIZI: {
        K: -4.689249,
        variabili: {
            V1: {coef: 0.427293, cap: 2.5, floor: 0.2},
            V2A: {coef: 0.400514, cap: 1, floor: -1},
            V4: {coef: -7.428313, cap: 0.16, floor: 0.01},
            V6: {coef: 0.668981, cap: 0.84, floor: -0.36, pret: -0.06},
            V10: {coef: 0.82794, cap: 1, floor: 0},
            V18: {coef: 29.88155, cap: 0.04, floor: 0},
            V19: {coef: 0.031407, cap: 20, floor: -2},
            D3: {coef: -1.558519},
            D5: {coef: -0.245774},
            D7: {coef: 5.362561},
            D12: {coef: 0.542214}
        }
    },
    IMMOBILIARE: {
        K: -2.569235,
        variabili: {
            V2: {coef: 0.8130648, cap: 1, floor: -0.8},
            V3: {coef: 14.0119, cap: 0.06, floor: 0},
            V7: {coef: -2.721187, cap: 1, floor: 0},
            V21: {coef: -0.1391083, cap: 10, floor: 0.3},
            D1: {coef: -1.401464},
            D4: {coef: -0.5688427},
            D10: {coef: 1.765224}
        }
    },
    AGRICOLTURA: null // Usa INDUSTRIA
};

window.DIZIONARIO_VARIABILI_FDG = {

  // ===== VARIABILI QUANTITATIVE (V) =====

  V1:  "Autonomia finanziaria ‚Äì Patrimonio Netto / Totale Attivo. Indica la solidit√† patrimoniale dell‚Äôimpresa.",
  V2A: "Margine operativo lordo su Ricavi (EBITDA / Ricavi). Misura la redditivit√† operativa lorda.",
  V3:  "EBIT / Ricavi. Redditivit√† operativa netta al netto di ammortamenti e svalutazioni.",
  V4:  "Rotazione del capitale investito (Ricavi / Totale Attivo). Indica l‚Äôefficienza nell‚Äôuso delle risorse.",
  V5:  "Return on Investment (ROI). Redditivit√† del capitale investito.",
  V6:  "Incidenza dei mezzi propri sulle fonti totali. Maggiore = pi√π indipendenza finanziaria.",
  V7:  "Oneri finanziari / Ricavi. Misura l‚Äôincidenza dei costi del debito sull‚Äôattivit√†.",
  V8:  "Costi del personale / Valore aggiunto. Valuta la produttivit√† del lavoro.",
  V9:  "Debiti finanziari / Totale Passivo. Misura il grado di indebitamento.",
  V10: "Oneri finanziari / EBIT. Indica la copertura degli interessi tramite il reddito operativo.",
  V11: "Cash Flow / Ricavi. Capacit√† di generare liquidit√† rispetto al fatturato.",
  V12: "Disponibilit√† liquide / Totale Attivo. Indica la quota di attivit√† immediatamente liquide.",
  V13: "Crediti commerciali / Ricavi. Misura la durata media dell‚Äôincasso dei crediti.",
  V14: "Debiti commerciali / Ricavi. Indica la dilazione media di pagamento ai fornitori.",
  V15: "Magazzino / Ricavi. Misura la rotazione delle scorte.",
  V16: "Valore aggiunto / Ricavi. Indica la ricchezza generata dall‚Äôattivit√† caratteristica.",
  V17: "EBITDA / Attivo totale. Misura la redditivit√† complessiva dei mezzi impiegati.",
  V18: "Debiti a breve / Totale Passivo. Indica la quota di passivit√† con scadenza entro 12 mesi.",
  V19: "Crescita del fatturato rispetto all‚Äôanno precedente. Misura l‚Äôevoluzione della gestione.",

  // ===== VARIABILI DICOTOMICHE (DUMMY) =====

  D1:  "Dummy: Patrimonio netto positivo (Patrimonio Netto > 0).",
  D2:  "Dummy: Indebitamento a breve termine in calo rispetto all‚Äôanno precedente.",
  D3:  "Dummy: EBITDA in aumento rispetto all‚Äôanno precedente.",
  D4:  "Dummy: ROI superiore alla media di settore.",
  D5:  "Dummy: Utile netto positivo nell‚Äôesercizio corrente.",
  D6:  "Dummy: Leverage (Totale Debiti / Patrimonio Netto) inferiore a 3.",
  D7:  "Dummy: Posizione finanziaria netta migliorata (minori debiti finanziari netti).",
  D8:  "Dummy: Margine di struttura primario positivo (PN ‚â• Attivit√† immobilizzate).",
  D9:  "Dummy: DSCR superiore a 1 (adeguata capacit√† di copertura del debito).",
  D10: "Dummy: Capitale circolante netto positivo.",
  D11: "Dummy: ROI > 8% (buona redditivit√† del capitale investito).",
  D12: "Dummy: Patrimonio netto positivo e DSCR ‚â• 1,25 (impresa solida e sostenibile)."
};


// Funzione principale calcolo Score EF
function calcolaScoreEconomicoFinanziario(anno = null) {
    if (!state.spRows.length || !state.ceRows.length) {
        toast("Prima importa un bilancio", true);
        return null;
    }
    
// Leggi SEMPRE i dati per ENTRAMBI gli anni (serve per i confronti)
    const spLast = extractStandardizedSP();
    const ceLast = extractStandardizedCE();
    const spPrev = extractStandardizedSPPrev();
    const cePrev = extractStandardizedCEPrev();
    
    // Se anno specifico √® richiesto, usa SOLO quel dataset per il calcolo principale
    let sp, ce;
    
    if (anno === state.anni?.prev) {
        sp = spPrev;
        ce = cePrev;
    } else if (anno === state.anni?.last) {
        sp = spLast;
        ce = ceLast;
    } else {
        // Comportamento DEFAULT: usa last
        sp = spLast;
        ce = ceLast;
    }
    
    // Calcola MOL (Margine Operativo Lordo) secondo FdG
    const MOL = ce.differenzaAB + ce.ammortamenti;
    const MOLprev = cePrev.differenzaAB + cePrev.ammortamenti;
    
// Calcola tutte le variabili V1-V26
    const variabili = {
        V1: safeDivide(sp.debitiEntro12, ce.ricaviVendite),
        V2: safeDivide(ce.oneriFinanziari, MOL),
        V3: safeDivide(ce.oneriFinanziari, sp.totDebiti),
        V4: safeDivide(sp.disponibilitaLiquide, ce.ricaviVendite),
        V5: safeDivide(ce.ricaviVendite, sp.rimanenze),
        V6: anno === state.anni?.prev ? 0 : safeDivide(ce.ricaviVendite - cePrev.ricaviVendite, cePrev.ricaviVendite),
        V7: safeDivide(sp.patrimonioNetto - sp.creditiVsSoci, sp.totaleAttivo - sp.creditiVsSoci),
        V8: safeDivide(sp.immobilizzazioni + sp.creditiOltre12, sp.patrimonioNetto - sp.creditiVsSoci),
        V9: safeDivide(sp.totDebiti, ce.valoreProduzione),
        V10: safeDivide(sp.debitiEntro12 + sp.rateiRiscontiPassivi, sp.totaleAttivo - sp.creditiVsSoci),
        V11: safeDivide(ce.utileEsercizio, ce.valoreProduzione),
        V12: safeDivide(sp.patrimonioNetto - sp.creditiVsSoci, sp.immobilizzazioni + sp.creditiOltre12),
        V13: anno === state.anni?.prev ? 0 : safeDivide(ce.valoreProduzione - cePrev.valoreProduzione, cePrev.valoreProduzione),
        V14: safeDivide(MOL, ce.oneriFinanziari + sp.totDebiti),
        V15: safeDivide(sp.disponibilitaLiquide + sp.creditiEntro12 + sp.attFinNonImm, sp.debitiEntro12 + sp.rateiRiscontiPassivi),
        V16: safeDivide(ce.ricaviVendite, sp.totaleAttivo - sp.creditiVsSoci),
        V17: safeDivide(ce.valoreProduzione - ce.costiProduzione, sp.totDebiti),
        V18: safeDivide(ce.oneriFinanziari, ce.valoreProduzione),
        V19: safeDivide(sp.totDebiti, sp.patrimonioNetto - sp.creditiVsSoci),
        V20: safeDivide(sp.patrimonioNetto - sp.creditiVsSoci, ce.ricaviVendite),
        V21: safeDivide(ce.valoreProduzione, sp.attivoCircolante),
        V22: safeDivide(sp.patrimonioNetto - sp.creditiVsSoci + sp.totDebiti, sp.patrimonioNetto - sp.creditiVsSoci),
        V23: safeDivide(sp.disponibilitaLiquide + sp.creditiEntro12 + sp.attFinNonImm + sp.rimanenze + sp.rateiRiscontiAttivi, sp.totaleAttivo - sp.creditiVsSoci),
        V24: safeDivide(ce.utileEsercizio, ce.valoreProduzione - ce.costiProduzione),
        V25: safeDivide(MOL, ce.oneriFinanziari),
        V26: safeDivide(ce.valoreProduzione, sp.totaleAttivo - sp.creditiVsSoci)
    };
    
    // Calcola variabili dummy D1-D18
    const dummy = {
        D1: (MOL < 0) ? variabili.V2 : 0,
        D2: (MOL < 0) ? 1 : 0,
        D3: (variabili.V6 < 0) ? variabili.V6 : 0,
        D4: (ce.ricaviVendite <= 500000) ? 1 : 0,
        D5: (ce.ricaviVendite <= 500000) ? variabili.V1 : 0,
        D6: (ce.ricaviVendite <= 500000) ? variabili.V3 : 0,
        D7: (ce.ricaviVendite <= 500000) ? variabili.V4 : 0,
        D8: (variabili.V13 < 0) ? variabili.V13 : 0,
        D9: (ce.ricaviVendite <= 500000) ? variabili.V9 : 0,
        D10: (ce.ricaviVendite <= 500000) ? variabili.V7 : 0,
        D11: (ce.ricaviVendite <= 500000) ? variabili.V16 : 0,
        D12: ((sp.patrimonioNetto - sp.creditiVsSoci) < 0) ? 1 : 0,
        D13: (ce.ricaviVendite <= 500000) ? variabili.V20 : 0,
        D14: (ce.ricaviVendite <= 500000) ? variabili.V25 : 0,
        D15: (state.settore === 'Industria') ? safeDivide(MOL, ce.oneriFinanziari) : 0,
        D16: (ce.utileEsercizio < 0) ? 1 : 0,
        D17: (ce.ricaviVendite < ce.valoreProduzione) ? 1 : 0,
        D18: (ce.ricaviVendite < ce.valoreProduzione) ? variabili.V11 : 0
    };
    
    // Gestione V2A per SERVIZI
    if (state.settore === 'Servizi' && variabili.V2 < 0 && dummy.D2 === 1) {
        variabili.V2A = 1;
    } else {
        variabili.V2A = variabili.V2;
    }
    
    // Applica cap & floor
    const settore = state.settore === 'Agricoltura' ? 'INDUSTRIA' : state.settore.toUpperCase();
    const config = COEFFICIENTI_FDG[settore] || COEFFICIENTI_FDG.INDUSTRIA;
    
    for (let key in variabili) {
        const cfg = config.variabili[key];
        if (cfg) {
            let val = variabili[key];
            if (cfg.pret !== undefined) val += cfg.pret;
            if (val > cfg.cap) val = cfg.cap;
            if (val < cfg.floor) val = cfg.floor;
            variabili[key] = val;
        }
    }
    
    // Calcola score xb
    let xb = config.K;
    
    // Somma contributi
    for (let key in config.variabili) {
        const coef = config.variabili[key].coef;
        const valore = key.startsWith('D') ? dummy[key] : variabili[key];
        xb += (valore || 0) * coef;
    }
    
    // Determina classe F
    let classeF = determineClasseF(xb);
    
    return {
        xb: xb,
        classe: classeF,
        variabili: variabili,
        dummy: dummy,
        MOL: MOL
    };
}

function safeDivide(num, den) {
    if (!den || den === 0 || !isFinite(num/den)) return 0;
    return num / den;
}

function determineClasseF(xb) {
    if (xb > -1.532480597) return 'F11';
    if (xb > -2.19819808) return 'F10';
    if (xb > -2.619804621) return 'F9';
    if (xb > -2.884413958) return 'F8';
    if (xb > -3.213093996) return 'F7';
    if (xb > -3.467784882) return 'F6';
    if (xb > -3.888909817) return 'F5';
    if (xb > -4.254777908) return 'F4';
    if (xb > -4.433824062) return 'F3';
    if (xb > -4.706674576) return 'F2';
    return 'F1';
}


// ========== SCORE ANDAMENTALE CR/CRIF/CERVED ==========

// Apre modal per input dati andamentali
function openScoreAndamentaleInput() {
    const modal = document.createElement('div');
    modal.id = 'modalAndamentale';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 95%;
        max-width: 1400px;
        max-height: 90vh;
        border-radius: 12px;
        overflow-y: auto;
        padding: 20px;
    `;
    
    container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #003d82; margin: 0;">Score Andamentale - Input Dati</h2>
            <button onclick="document.getElementById('modalAndamentale').remove()" 
                    style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Chiudi
            </button>
        </div>
        
<div style="text-align:right; margin-bottom:10px;">
  <button onclick="mostraHelpAndamentale()" 
          style="background:#1e40af;color:white;border:none;border-radius:50%;
                 width:28px;height:28px;font-weight:bold;cursor:pointer;">
    ?
  </button>
</div>


        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <!-- CENTRALE RISCHI -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #1e40af; margin-bottom: 15px;">CENTRALE RISCHI</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Ultimi 6 mesi (valori in ‚Ç¨)</p>
                <table style="width: 100%; font-size: 12px;">
                    <thead>
                        <tr style="background: #e0e0e0;">
                            <th style="padding: 5px;">Mese</th>
                            <th style="padding: 5px;">Acc.Cassa</th>
                            <th style="padding: 5px;">Util.Cassa</th>
                            <th style="padding: 5px;">Acc.Scad</th>
                            <th style="padding: 5px;">Util.Scad</th>
                            <th style="padding: 5px;">Soff.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${[6,5,4,3,2,1].map(m => `
                            <tr>
                                <td style="padding: 3px;">t-${m}</td>
                                <td><input type="number" id="cr-acc-cassa-${m}" style="width: 60px; padding: 2px;"></td>
                                <td><input type="number" id="cr-uti-cassa-${m}" style="width: 60px; padding: 2px;"></td>
                                <td><input type="number" id="cr-acc-scad-${m}" style="width: 60px; padding: 2px;"></td>
                                <td><input type="number" id="cr-uti-scad-${m}" style="width: 60px; padding: 2px;"></td>
                                <td><input type="number" id="cr-soff-${m}" style="width: 60px; padding: 2px;"></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- CRIF -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #1e40af; margin-bottom: 15px;">CRIF</h3>
                <table style="width: 100%; font-size: 12px;">
                    <tr>
                        <td style="padding: 5px;">CB05 - Rate residue rateali:</td>
                        <td><input type="number" id="crif-cb05" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB06 - Rate scadute rateali:</td>
                        <td><input type="number" id="crif-cb06" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB10 - Accordato non rateali:</td>
                        <td><input type="number" id="crif-cb10" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB11 - Utilizzato non rateali:</td>
                        <td><input type="number" id="crif-cb11" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB12 - Sconfinato non rateali:</td>
                        <td><input type="number" id="crif-cb12" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB17 - Rate residue carte:</td>
                        <td><input type="number" id="crif-cb17" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB18 - Rate scadute carte:</td>
                        <td><input type="number" id="crif-cb18" style="width: 100px; padding: 4px;"></td>
                    </tr>
                </table>
            </div>
            
            <!-- CERVED -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #1e40af; margin-bottom: 15px;">CERVED</h3>
                <table style="width: 100%; font-size: 12px;">
                    <tr>
                        <td style="padding: 5px;">CB24 - Rate residue rateali:</td>
                        <td><input type="number" id="cerved-cb24" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB25 - Rate scadute rateali:</td>
                        <td><input type="number" id="cerved-cb25" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB30 - Accordato non rateali:</td>
                        <td><input type="number" id="cerved-cb30" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB31 - Utilizzato non rateali:</td>
                        <td><input type="number" id="cerved-cb31" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB32 - Sconfinato non rateali:</td>
                        <td><input type="number" id="cerved-cb32" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB38 - Rate residue carte:</td>
                        <td><input type="number" id="cerved-cb38" style="width: 100px; padding: 4px;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">CB39 - Rate scadute carte:</td>
                        <td><input type="number" id="cerved-cb39" style="width: 100px; padding: 4px;"></td>
                    </tr>
                </table>
            </div>
        </div>
        
<div style="margin-top: 20px; text-align: center;">
    <button onclick="salvaScoreAndamentale()" class="btn btn-success" style="padding: 12px 30px; margin-right:10px;">
        üíæ Salva Score Andamentale
    </button>
    <button onclick="calcolaScoreAndamentaleCompleto()" class="btn btn-primary" style="padding: 12px 30px;">
        üìä Calcola Score Andamentale
    </button>
</div>

        
        <div id="risultatiAndamentale" style="margin-top: 20px;"></div>
    `;
    
    modal.appendChild(container);
    document.body.appendChild(modal);

setTimeout(() => {
  if (typeof caricaScoreAndamentale === "function") caricaScoreAndamentale();
}, 300);

setTimeout(() => {
  if (typeof caricaRisultatoScoreAndamentale === "function") caricaRisultatoScoreAndamentale();
}, 500);

}

// =====================================================
// üß≠ HELP CONTESTUALE ‚Äì SCORE ANDAMENTALE (CR, CRIF, CERVED)
// =====================================================
function mostraHelpAndamentale() {
  // Se gi√† aperto, evita duplicati
  if (document.getElementById("modalHelpAndamentale")) return;

  const modal = document.createElement("div");
  modal.id = "modalHelpAndamentale";
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 11000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    background: white;
    max-width: 650px;
    width: 95%;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 12px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.25);
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #1e293b;
    line-height: 1.5;
    padding: 25px 30px;
    position: relative;
  `;

  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h2 style="color:#003d82;margin:0;font-size:20px;">üß≠ Guida alla compilazione ‚Äì Score Andamentale</h2>
      <button onclick="document.getElementById('modalHelpAndamentale').remove()"
              style="background:#dc2626;color:white;border:none;border-radius:6px;
                     padding:6px 12px;cursor:pointer;font-weight:600;">Chiudi</button>
    </div>

    <p style="font-size:15px;margin-bottom:15px;">
      Questa sezione consente di calcolare lo <b>Score Andamentale MCC</b>, che misura la puntualit√† dei pagamenti 
      e la corretta gestione dei rapporti di credito.
    </p>

    <h3 style="color:#1e40af;font-size:16px;margin-top:15px;">1Ô∏è‚É£ Centrale Rischi (CR)</h3>
    <p>
      Fonte: <b>Banca d‚ÄôItalia</b> ‚Äì dati obbligatori.<br>
      Inserisci gli importi <b>Accordato</b> e <b>Utilizzato</b> per <b>Cassa</b> e <b>a Scadenza</b> relativi agli ultimi 
      <b>6 mesi</b> (t-6 ‚Üí t-1).<br>
      Il sistema controlla automaticamente la presenza di <b>sofferenze</b> o <b>sconfinamenti</b>.
    </p>

    <h3 style="color:#1e40af;font-size:16px;margin-top:20px;">2Ô∏è‚É£ CRIF (Credit Bureau Privato)</h3>
    <p>
      Fonte: <b>CRIF</b> ‚Äì dati facoltativi.<br>
      Inserisci, se disponibili, le <b>rate residue e scadute</b>, gli importi <b>accordati</b>, <b>utilizzati</b> 
      e <b>sconfinati</b> relativi a crediti <b>rateali</b>, <b>non rateali</b> e <b>carte di credito</b>.<br>
      Se non possiedi un report CRIF aggiornato, puoi lasciare i campi vuoti: non influiranno sul calcolo MCC.
    </p>

    <h3 style="color:#1e40af;font-size:16px;margin-top:20px;">3Ô∏è‚É£ CERVED (Credit Bureau Corporate)</h3>
    <p>
      Fonte: <b>CERVED</b> ‚Äì dati facoltativi.<br>
      Analoghi ai dati CRIF ma riferiti ai rapporti commerciali e finanziari aziendali.<br>
      Puoi compilarli se disponi di un report CERVED ufficiale o di informazioni verificate sui debiti commerciali.
    </p>

    <div style="margin-top:25px;background:#f8fafc;padding:15px;border-radius:8px;font-size:14px;">
      <p style="margin:4px 0;">üí° <b>Suggerimenti utili</b></p>
      <ul style="margin:6px 0 0 20px;padding:0;list-style-type:square;">
        <li>I valori <b>non compilati</b> vengono considerati pari a <b>0</b>.</li>
        <li>Inserisci tutti gli importi in <b>euro</b> (senza separatori o simboli).</li>
        <li>I dati sono <b>salvati localmente</b> nel browser e non vengono trasmessi online.</li>
      </ul>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button onclick="document.getElementById('modalHelpAndamentale').remove()"
              style="background:#1e40af;color:white;border:none;padding:10px 20px;
                     border-radius:6px;cursor:pointer;font-weight:600;">
        Chiudi Guida
      </button>
    </div>
  `;

  modal.appendChild(box);
  document.body.appendChild(modal);
}



// =====================================================
// üíæ SALVA SCORE ANDAMENTALE (dati CR, CRIF, CERVED)
// =====================================================
window.salvaScoreAndamentale = function() {
  try {
    const dati = {};

    // --- Centrale Rischi ---
    for (let m = 1; m <= 6; m++) {
      ["acc-cassa", "uti-cassa", "acc-scad", "uti-scad", "soff"].forEach(field => {
        const id = `cr-${field}-${m}`;
        dati[id] = document.getElementById(id)?.value || "";
      });
    }

    // --- CRIF ---
    ["05","06","10","11","12","17","18"].forEach(k=>{
      dati[`crif-cb${k}`] = document.getElementById(`crif-cb${k}`)?.value || "";
    });

    // --- CERVED ---
    ["24","25","30","31","32","38","39"].forEach(k=>{
      dati[`cerved-cb${k}`] = document.getElementById(`cerved-cb${k}`)?.value || "";
    });

    const key = `ceodoc_scoreand_${state.cf}_${state.anni.last}`;
    localStorage.setItem(key, JSON.stringify({
      cf: state.cf,
      azienda: state.denom,
      anno: state.anni.last,
      timestamp: new Date().toISOString(),
      dati
    }));

    toast("üíæ Score Andamentale salvato correttamente!");
    console.log("‚úÖ Score Andamentale salvato:", key, dati);
  } catch (err) {
    console.error("‚ùå Errore salvataggio Score Andamentale:", err);
    toast("Errore durante il salvataggio Score Andamentale", true);
  }
};

// =====================================================
// üîÅ CARICA SCORE ANDAMENTALE SALVATO (auto-precompilazione)
// =====================================================
window.caricaScoreAndamentale = function() {
  try {
    const key = `ceodoc_scoreand_${state.cf}_${state.anni.last}`;
    const saved = JSON.parse(localStorage.getItem(key) || "null");
    if (!saved || !saved.dati) return;

    Object.entries(saved.dati).forEach(([id, val]) => {
      const el = document.getElementById(id);
      if (el) el.value = val;
    });

    toast("üìÇ Dati Score Andamentale caricati automaticamente");
    console.log("üìÇ Score Andamentale caricato:", saved);
  } catch (err) {
    console.warn("‚ö†Ô∏è Nessun Score Andamentale salvato:", err);
  }
};


// Calcola Score CR
function calcolaScoreCR() {
    const datiCR = [];
    for (let m = 1; m <= 6; m++) {
        datiCR.push({
            accCassa: parseFloat(document.getElementById(`cr-acc-cassa-${m}`)?.value) || 0,
            utiCassa: parseFloat(document.getElementById(`cr-uti-cassa-${m}`)?.value) || 0,
            accScad: parseFloat(document.getElementById(`cr-acc-scad-${m}`)?.value) || 0,
            utiScad: parseFloat(document.getElementById(`cr-uti-scad-${m}`)?.value) || 0,
            soff: parseFloat(document.getElementById(`cr-soff-${m}`)?.value) || 0
        });
    }
    
    // Quality check
    for (let mese of datiCR) {
        if (mese.soff > 0) {
            return { classe: 'UN', xb: 0, msg: 'Presenza sofferenze' };
        }
        if (mese.accCassa < mese.accScad || mese.utiCassa < mese.utiScad) {
            return { classe: 'UN', xb: 0, msg: 'Quality check non superato' };
        }
    }
    
    // Calcola variabili
    let sommaUtiCassa = 0, sommaUtiScad = 0;
    let sommaAccCassa = 0, sommaAccScad = 0;
    let C2 = 0, C3 = 0;
    
    for (let mese of datiCR) {
        sommaUtiCassa += mese.utiCassa;
        sommaUtiScad += mese.utiScad;
        sommaAccCassa += mese.accCassa;
        sommaAccScad += mese.accScad;
        
        if (mese.utiCassa > mese.accCassa) C2++;
        if (mese.utiScad > mese.accScad) C3++;
    }
    
    let C1 = (sommaAccCassa - sommaAccScad) !== 0 ? 
             (sommaUtiCassa - sommaUtiScad) / (sommaAccCassa - sommaAccScad) : 0;
    
    // Cap & floor
    if (C1 > 1.2) C1 = 1.2;
    if (C1 < 0) C1 = 0;
    
    const C4 = 0; // Assumiamo dati completi
    const DC1 = C4 >= 4 ? C1 : 0;
    const DC3 = C3 > 0 ? 1 : 0;
    
    // Formula CR
    let xbCR = -4.984468 + 3.179026 * C1 - 1.066972 * DC1 + 0.720867 * DC3 + 0.0326226 * C2;
    
    // Aggiustamento
    const adj = Math.log((0.0518888 / (1 - 0.0518888)) * ((1 - 0.0502134) / 0.0502134));
    xbCR = xbCR + adj;
    
    return {
        xb: xbCR,
        classe: determineClasseA(xbCR),
        C1: C1,
        C2: C2,
        C3: C3
    };
}

// Calcola Score CRIF
function calcolaScoreCRIF() {
    const CB05 = parseFloat(document.getElementById('crif-cb05')?.value) || 0;
    const CB06 = parseFloat(document.getElementById('crif-cb06')?.value) || 0;
    const CB10 = parseFloat(document.getElementById('crif-cb10')?.value) || 0;
    const CB11 = parseFloat(document.getElementById('crif-cb11')?.value) || 0;
    const CB12 = parseFloat(document.getElementById('crif-cb12')?.value) || 0;
    const CB17 = parseFloat(document.getElementById('crif-cb17')?.value) || 0;
    const CB18 = parseFloat(document.getElementById('crif-cb18')?.value) || 0;
    
    const A1 = CB12;
    const A2 = (CB05 + CB06) !== 0 ? CB06 / (CB05 + CB06) : 0;
    const A3 = (CB17 + CB18) !== 0 ? CB18 / (CB17 + CB18) : 0;
    let A4 = CB10 !== 0 ? CB11 / CB10 : 0.35;
    
    // Cap & floor A4
    if (A4 > 1) A4 = 1;
    if (A4 < 0) A4 = 0.35;
    
    const DA1 = A1 > 0 ? 1 : 0;
    const DA2 = A2 > 0 ? 1 : 0;
    const DA3 = A3 > 0 ? 1 : 0;
    
    // Formula CRIF
    let xbCRIF = -2.690569769;
    xbCRIF += 1.909890 * A4;
    xbCRIF += 0.750163 * DA1;
    xbCRIF += 1.355079 * DA2;
    xbCRIF += 1.025256 * DA3;
    
    return {
        xb: xbCRIF,
        classe: determineClasseSIC(xbCRIF),
        A1: A1,
        A2: A2,
        A3: A3,
        A4: A4
    };
}

// Calcola Score CERVED
function calcolaScoreCERVED() {
    const CB24 = parseFloat(document.getElementById('cerved-cb24')?.value) || 0;
    const CB25 = parseFloat(document.getElementById('cerved-cb25')?.value) || 0;
    const CB30 = parseFloat(document.getElementById('cerved-cb30')?.value) || 0;
    const CB31 = parseFloat(document.getElementById('cerved-cb31')?.value) || 0;
    const CB32 = parseFloat(document.getElementById('cerved-cb32')?.value) || 0;
    const CB38 = parseFloat(document.getElementById('cerved-cb38')?.value) || 0;
    const CB39 = parseFloat(document.getElementById('cerved-cb39')?.value) || 0;
    
    const B1 = CB32;
    const B2 = (CB24 + CB25) !== 0 ? CB25 / (CB24 + CB25) : 0;
    const B3 = (CB38 + CB39) !== 0 ? CB39 / (CB38 + CB39) : 0;
    let B4 = CB30 !== 0 ? CB31 / CB30 : 0.35;
    
    // Cap & floor B4
    if (B4 > 1) B4 = 1;
    if (B4 < 0) B4 = 0.35;
    
    const DB1 = B1 > 0 ? 1 : 0;
    const DB2 = B2 > 0 ? 1 : 0;
    const DB3 = B3 > 0 ? 1 : 0;
    
    // Formula CERVED (stessi coefficienti CRIF)
    let xbCERVED = -2.690569769;
    xbCERVED += 1.909890 * B4;
    xbCERVED += 0.750163 * DB1;
    xbCERVED += 1.355079 * DB2;
    xbCERVED += 1.025256 * DB3;
    
    return {
        xb: xbCERVED,
        classe: determineClasseSIC(xbCERVED),
        B1: B1,
        B2: B2,
        B3: B3,
        B4: B4
    };
}

// Determina classe A per CR
function determineClasseA(xb) {
    if (xb > -1.532480597) return 'A11';
    if (xb > -2.19819808) return 'A10';
    if (xb > -2.619804621) return 'A9';
    if (xb > -2.884413958) return 'A8';
    if (xb > -3.213093996) return 'A7';
    if (xb > -3.467784882) return 'A6';
    if (xb > -3.888909817) return 'A5';
    if (xb > -4.254777908) return 'A4';
    if (xb > -4.433824062) return 'A3';
    if (xb > -4.706674576) return 'A2';
    return 'A1';
}

// Determina classe SIC per CRIF/CERVED
function determineClasseSIC(xb) {
    if (xb > -1.53) return 'SIC11';
    if (xb > -2.20) return 'SIC10';
    if (xb > -2.62) return 'SIC9';
    if (xb > -2.88) return 'SIC8';
    if (xb > -3.21) return 'SIC7';
    if (xb > -3.47) return 'SIC6';
    if (xb > -3.89) return 'SIC5';
    if (xb > -4.25) return 'SIC4';
    if (xb > -4.43) return 'SIC3';
    if (xb > -4.71) return 'SIC2';
    return 'SIC1';
}

// Integra score andamentale
function calcolaScoreAndamentaleCompleto() {
    const scoreCR = calcolaScoreCR();
    const scoreCRIF = calcolaScoreCRIF();
    const scoreCERVED = calcolaScoreCERVED();
    
    // Conta componenti valide
    let sommaXb = 0;
    let componenti = 0;
    
    if (scoreCR.xb && scoreCR.classe !== 'UN') {
        sommaXb += scoreCR.xb;
        componenti++;
    }
    
    if (scoreCRIF.xb) {
        sommaXb += scoreCRIF.xb;
        componenti++;
    }
    
    if (scoreCERVED.xb) {
        sommaXb += scoreCERVED.xb;
        componenti++;
    }
    
    if (componenti === 0) {
        toast("Nessun dato andamentale valido", true);
        return null;
    }
    
    // Media ponderata
    const xbIntegrato = sommaXb / componenti;
    const classeIntegrata = determineClasseA(xbIntegrato);
    
    // Mostra risultati
    const divRisultati = document.getElementById('risultatiAndamentale');
    if (divRisultati) {
        divRisultati.innerHTML = `
            <div style="background: #e8f4f8; padding: 20px; border-radius: 8px;">
                <h3 style="color: #003d82; margin-bottom: 15px;">Risultati Score Andamentale</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="text-align: center;">
                        <h4>Centrale Rischi</h4>
                        <div style="font-size: 24px; font-weight: bold; color: ${scoreCR.classe === 'UN' ? '#dc2626' : '#1e40af'};">
                            ${scoreCR.classe}
                        </div>
                        <div style="font-size: 14px; color: #666;">xb: ${scoreCR.xb.toFixed(4)}</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>CRIF</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #1e40af;">
                            ${scoreCRIF.classe}
                        </div>
                        <div style="font-size: 14px; color: #666;">xb: ${scoreCRIF.xb.toFixed(4)}</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>CERVED</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #1e40af;">
                            ${scoreCERVED.classe}
                        </div>
                        <div style="font-size: 14px; color: #666;">xb: ${scoreCERVED.xb.toFixed(4)}</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #1e40af; text-align: center;">
                    <h3>Score Andamentale Integrato</h3>
                    <div style="font-size: 36px; font-weight: bold; color: #f97316;">
                        ${classeIntegrata}
                    </div>
                    <div style="font-size: 16px; color: #666;">xb integrato: ${xbIntegrato.toFixed(4)}</div>
                </div>
            </div>
        `;
    }
    
    // Salva in state
    state.scoreAndamentale = {
        CR: scoreCR,
        CRIF: scoreCRIF,
        CERVED: scoreCERVED,
        integrato: {
            xb: xbIntegrato,
            classe: classeIntegrata
        }
    };
    
    toast(`Score Andamentale calcolato: ${classeIntegrata}`);

// === üíæ Salva anche il risultato integrato nel localStorage ===
try {
  const key = `ceodoc_scoreand_result_${state.cf}_${state.anni.last}`;
  localStorage.setItem(key, JSON.stringify({
    cf: state.cf,
    azienda: state.denom,
    anno: state.anni.last,
    integrato: state.scoreAndamentale.integrato,
    dettagli: state.scoreAndamentale,
    timestamp: new Date().toISOString()
  }));
  console.log("üíæ Risultato Score Andamentale integrato salvato:", key, state.scoreAndamentale.integrato);
} catch (err) {
  console.warn("‚ö†Ô∏è Errore salvataggio risultato andamentale:", err);
}

    
    return state.scoreAndamentale;
}

// Matrice di integrazione per Societ√† di Capitali
const MATRICE_INTEGRAZIONE = [
    [1, 1, 1, 1, 1, 2, 3, 4, 5, 6, 6],   // A1
    [1, 2, 2, 2, 2, 3, 3, 4, 5, 6, 7],   // A2
    [1, 2, 3, 3, 3, 3, 4, 5, 5, 6, 8],   // A3
    [1, 2, 3, 4, 4, 5, 5, 6, 6, 7, 9],   // A4
    [2, 2, 3, 4, 5, 5, 5, 6, 7, 8, 10],  // A5
    [3, 3, 3, 4, 5, 6, 6, 6, 8, 9, 11],  // A6
    [3, 3, 3, 4, 5, 6, 7, 7, 8, 10, 11], // A7
    [4, 4, 4, 5, 6, 7, 7, 8, 9, 10, 12], // A8
    [5, 5, 5, 5, 7, 8, 8, 9, 9, 11, 12], // A9
    [7, 7, 7, 7, 8, 9, 10, 10, 11, 11, 12], // A10
    [9, 9, 9, 9, 10, 11, 11, 12, 12, 12, 12] // A11
];

// =====================================================
// üìÇ CARICA RISULTATO SCORE ANDAMENTALE SALVATO
// =====================================================
window.caricaRisultatoScoreAndamentale = function() {
  try {
    const key = `ceodoc_scoreand_result_${state.cf}_${state.anni.last}`;
    const saved = JSON.parse(localStorage.getItem(key) || "null");
    if (!saved || !saved.integrato) {
      console.log("‚ÑπÔ∏è Nessun risultato andamentale salvato per:", key);
      return null;
    }

    state.scoreAndamentale = saved.dettagli;
    console.log("üìÇ Score Andamentale (salvato) caricato:", saved.integrato);

    toast(`üìà Score Andamentale ${saved.integrato.classe} caricato da memoria`);
    return saved.integrato;
  } catch (err) {
    console.warn("‚ö†Ô∏è Errore caricamento risultato Score Andamentale:", err);
    return null;
  }
};


// Calcola rating integrato
// =====================================================
// üß≠ CALCOLO RATING MCC INTEGRATO (FdG + Andamentale)
// =====================================================
function calcolaRatingIntegrato(scoreEF, scoreAnd) {
if (window.SILENT_MODE) return; // üü¶ non mostrare la modale durante il salvataggio

  try {
  // Leggi Score EF da ENTRAMBI anni (per confronto N-1 vs N e matrice)
    const annoCorrente = state.anni?.last || "2022";
    const annoPrecedente = state.anni?.prev || "2021";
    const scoreEF_prev = JSON.parse(localStorage.getItem(`ceodoc_scoreef_${state.cf}_${annoPrecedente}`) || '{}');
    const scoreEF_last = JSON.parse(localStorage.getItem(`ceodoc_scoreef_${state.cf}_${annoCorrente}`) || '{}');
    // === Se mancano dati Andamentali, prova a recuperarli dal localStorage ===
    if (!scoreAnd || !scoreAnd.integrato) {
      console.log("‚ÑπÔ∏è Tentativo di caricamento Score Andamentale salvato...");
      if (typeof caricaRisultatoScoreAndamentale === "function") {
        const recuperato = caricaRisultatoScoreAndamentale();
        if (recuperato) scoreAnd = { integrato: recuperato };
      }
    }

    // === Se ancora mancano, blocca il calcolo ===
    if (!scoreEF || !scoreAnd || !scoreAnd.integrato) {
      toast("‚ö†Ô∏è Calcola prima Score EF e Score Andamentale", true);
      return null;
    }

    // === Estrai classi e coefficienti ===
    const indiceF = parseInt(String(scoreEF.classe || "").replace("F", "")) || 1;
    const indiceA = parseInt(String(scoreAnd.integrato.classe || "").replace("A", "")) || 1;

    // === Applica matrice MCC (societ√† di capitali) ===
    const MATRICE_INTEGRAZIONE = [
      [1,1,1,1,1,2,3,4,5,6,6],
      [1,2,2,2,2,3,3,4,5,6,7],
      [1,2,3,3,3,3,4,5,5,6,8],
      [1,2,3,4,4,5,5,6,6,7,9],
      [2,2,3,4,5,5,5,6,7,8,10],
      [3,3,3,4,5,6,6,6,8,9,11],
      [3,3,3,4,5,6,7,7,8,10,11],
      [4,4,4,5,6,7,7,8,9,10,12],
      [5,5,5,5,7,8,8,9,9,11,12],
      [7,7,7,7,8,9,10,10,11,11,12],
      [9,9,9,9,10,11,11,12,12,12,12]
    ];

    const rating = MATRICE_INTEGRAZIONE[indiceA - 1]?.[indiceF - 1] || 12;

    // === Probabilit√† di Default (PD) ===
    const PD_MAP = {
      1: 0.12, 2: 0.33, 3: 0.67, 4: 1.02, 5: 1.61,
      6: 2.87, 7: 3.62, 8: 5.18, 9: 8.45, 10: 9.43,
      11: 16.30, 12: 22.98
    };

    const fascia = rating <= 2 ? "F1" : rating <= 5 ? "F2" : rating <= 8 ? "F3" : rating <= 10 ? "F4" : "F5";

    const result = {
      rating,
      pd: PD_MAP[rating],
      fascia,
      scoreEF: scoreEF.classe,
      scoreAnd: scoreAnd.integrato.classe
    };

    // === Salva nel localStorage per richiamo automatico ===
    try {
      const key = `ceodoc_ratingmcc_${state.cf}_${state.anni.last}`;
      localStorage.setItem(key, JSON.stringify({
        cf: state.cf,
        azienda: state.denom,
        anno: state.anni.last,
        timestamp: new Date().toISOString(),
        result
      }));
      console.log("üíæ Rating MCC salvato:", key, result);
    } catch (err) {
      console.warn("‚ö†Ô∏è Errore salvataggio Rating MCC:", err);
    }

    // === Mostra il modale con il risultato ===
    const modal = document.createElement("div");
    modal.id = "modalRatingMCC";
    modal.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,0.6);
      z-index:10000; display:flex; align-items:center; justify-content:center;
    `;

    const container = document.createElement("div");
container.style.cssText = `
  background:#fff; padding:25px; border-radius:12px;
  width:1000px; max-height:95vh; overflow-y:auto; text-align:center; box-shadow:0 15px 45px rgba(0,0,0,0.3);
  animation: fadeIn .3s ease;
`;

// === CARD ‚ÄúSCORING INTEGRATO MCC‚Äù (nuova versione grafica) ===
container.innerHTML = `
  <h2 style="color:#003d82;margin-top:0;margin-bottom:10px;text-align:center;">
    üè¶ Scoring Integrato MCC
  </h2>

  <div style="font-size:13px;color:#444;margin-bottom:20px;text-align:center;">
    Integrazione dei moduli Economico-Finanziario (F) e Andamentale (A) secondo la matrice ufficiale MCC.
  </div>

  <!-- üìã DATI AZIENDALI -->
  <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:25px;">
    <tr style="background:#f1f5f9;color:#003d82;font-weight:bold;">
      <td style="padding:6px;">Nome azienda</td><td style="padding:6px;">${state.denom || "-"}</td>
      <td style="padding:6px;">Forma giuridica</td><td style="padding:6px;">${state.tipo || "-"}</td>
      <td style="padding:6px;">Settore</td><td style="padding:6px;">${state.settore || "-"}</td>
    </tr>
    <tr>
      <td style="padding:6px;">Dati CRIF</td>
      <td style="padding:6px;color:${state.scoreAndamentale?.CRIF?.xb ? '#10b981' : '#9ca3af'};font-weight:bold;">
        ${state.scoreAndamentale?.CRIF?.xb ? "‚úì Disponibili" : "‚Äî Non presenti"}
      </td>
      <td style="padding:6px;">Dati CERVED</td>
      <td style="padding:6px;color:${state.scoreAndamentale?.CERVED?.xb ? '#10b981' : '#9ca3af'};font-weight:bold;">
        ${state.scoreAndamentale?.CERVED?.xb ? "‚úì Disponibili" : "‚Äî Non presenti"}
      </td>
      <td style="padding:6px;">Dati Centrale Rischi</td>
      <td style="padding:6px;color:#10b981;font-weight:bold;">‚úì Obbligatori</td>
    </tr>
  </table>

  <!-- üìä RISULTATI SCORE -->
  <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:25px;">
    <tr style="background:#f0f9ff;">
      <td style="padding:6px;">Score Economico-Finanziario (FdG)</td>
      <td style="padding:6px;text-align:right;">${scoreEF.xb?.toFixed(4) || "-"} ‚Üí <b>${scoreEF.classe || "-"}</b></td>
    </tr>
    <tr style="background:#f9fafb;">
      <td style="padding:6px;">Score Andamentale Integrato (CR+CRIF+CERVED)</td>
      <td style="padding:6px;text-align:right;">${scoreAnd.integrato?.xb?.toFixed(4) || "-"} ‚Üí <b>${scoreAnd.integrato?.classe || "-"}</b></td>
    </tr>
    <tr style="background:#f0f9ff;">
      <td style="padding:6px;">Classe MCC finale</td>
      <td style="padding:6px;text-align:right;font-size:15px;font-weight:bold;color:#003d82;">${result.rating}</td>
    </tr>
    <tr style="background:#f9fafb;">
      <td style="padding:6px;">PD ‚Äì Probabilit√† di Default</td>
      <td style="padding:6px;text-align:right;color:#f97316;font-weight:bold;">${result.pd.toFixed(2)}%</td>
    </tr>
    <tr style="background:#f0f9ff;">
      <td style="padding:6px;">Fascia sintetica</td>
      <td style="padding:6px;text-align:right;font-weight:bold;color:#10b981;">${result.fascia}</td>
    </tr>
  </table>

  <!-- üß© MATRICE DI INTEGRAZIONE -->
  <div style="margin:20px auto;max-width:600px;text-align:center;">
    <h4 style="color:#003d82;margin-bottom:10px;">Matrice di Integrazione MCC (F √ó A)</h4>
    <svg id="svgMatriceMCC" width="440" height="440" xmlns="http://www.w3.org/2000/svg" style="border:1px solid #e5e7eb;border-radius:6px;">
      ${(() => {
        const colors = ["#10b981","#84cc16","#facc15","#f97316","#dc2626"];
        let svg = "";
        for (let y = 0; y < 11; y++) {
          for (let x = 0; x < 11; x++) {
            const val = MATRICE_INTEGRAZIONE[y][x];
            const fill =
              val <= 3 ? colors[0] :
              val <= 5 ? colors[2] :
              val <= 8 ? colors[3] :
              colors[4];
            const highlight =
              (x === indiceF - 1 && y === indiceA - 1)
                ? 'stroke="#003d82" stroke-width="3"'
                : 'stroke="white" stroke-width="1"';
            svg += `<rect x="${x * 40}" y="${y * 40}" width="40" height="40" fill="${fill}" ${highlight}></rect>`;
            svg += `<text x="${x * 40 + 20}" y="${y * 40 + 26}" text-anchor="middle" font-size="12" font-weight="bold" fill="white">${val}</text>`;
          }
        }
        return svg;
      })()}
    </svg>
    <div style="margin-top:10px;font-size:12px;color:#555;">
      Riga = Modulo F (Economico-Finanziario) ‚Ä¢ Colonna = Modulo A (Andamentale)
    </div>
  </div>

  <!-- üßæ NOTA -->
  <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-top:20px;font-size:13px;color:#374151;">
    <b>Nota:</b> Il rating MCC tiene conto dei moduli <b>EF</b> e <b>Andamentale</b> (CR, CRIF, CERVED).<br>
    Le informazioni CRIF e CERVED non modificano la classe MCC ufficiale, ma forniscono un contesto pi√π completo per la valutazione del rischio.
  </div>

  <!-- üîò PULSANTI FINALI -->
  <div style="margin-top:25px;text-align:center;">
    <button onclick="salvaRatingMCC()" 
            style="background:#10b981;color:white;border:none;
                   padding:10px 25px;border-radius:6px;
                   font-weight:600;cursor:pointer;">
      üíæ Salva Rating MCC
    </button>
    <button onclick="document.getElementById('modalRatingMCC').remove()" 
            style="background:#dc2626;color:white;border:none;
                   padding:10px 25px;border-radius:6px;
                   font-weight:600;cursor:pointer;margin-left:10px;">
      Chiudi
    </button>
  </div>
`;
    modal.appendChild(container);
    document.body.appendChild(modal);

    toast(`‚úÖ Rating MCC: Classe ${result.rating} (${result.fascia})`);
    return result;

  } catch (err) {
    console.error("‚ùå Errore calcolo Rating MCC Integrato:", err);
    toast("Errore durante il calcolo del Rating MCC", true);
    return null;
  }
}

// =====================================================
// üíæ SALVA RATING MCC (manuale) ‚Äì MCC integrato (EF + Andamentale)
// =====================================================
window.salvaRatingMCC = function() {
  try {
    if (!state?.scoreEF || !state?.scoreAndamentale?.integrato) {
      toast("‚ö†Ô∏è Calcola prima lo Score EF e lo Score Andamentale", true);
      return;
    }

    const key = `ceodoc_ratingmcc_${state.cf}_${state.anni.last}`;
    const scoreEF = state.scoreEF;
    const scoreAnd = state.scoreAndamentale.integrato;
    const rating = window.calcolaRatingIntegrato(scoreEF, { integrato: scoreAnd });

    const payload = {
      cf: state.cf,
      azienda: state.denom,
      anno: state.anni.last,
      timestamp: new Date().toISOString(),
      result: rating
    };

    localStorage.setItem(key, JSON.stringify(payload));
    toast("üíæ Rating MCC salvato correttamente!");
    console.log("‚úÖ Rating MCC manualmente salvato:", key, payload);
  } catch (err) {
    console.error("‚ùå Errore salvataggio Rating MCC:", err);
    toast("Errore durante il salvataggio Rating MCC", true);
  }
};


// Rendi funzioni globali
window.openScoreAndamentaleInput = openScoreAndamentaleInput;
window.calcolaScoreAndamentaleCompleto = calcolaScoreAndamentaleCompleto;
window.calcolaRatingIntegrato = calcolaRatingIntegrato;
window.salvaRatingMCC = salvaRatingMCC;


// ========== RICLASSIFICAZIONI BILANCIO ==========

// Riclassificazione CEV (Costo del Venduto)
function riclassificazioneCEV() {
    const ce = extractStandardizedCE();
    
    const cev = {
        // RICAVI
        ricaviVendite: ce.ricaviVendite || 0,
        totValoreProduzione: ce.valoreProduzione || 0,
        
        // COSTI DIRETTI
        materiePrime: ce.materiePrime || 0,
        varRimanenzeMaterie: ce.varRimanenzeMaterie || 0,
        varRimanenzeProdotti: ce.varRimanenzeProdotti || 0,
        consumiMateriePrime: 0, // calcolato dopo
        
        // COSTO DEL VENDUTO
        costoVenduto: 0,
        margineLordo: 0,
        margineLordoPerc: 0,
        
        // COSTI OPERATIVI
        servizi: ce.servizi || 0,
        godimentoBeniTerzi: ce.godimentoBeniTerzi || 0,
        personale: ce.personale || 0,
        costiCommerciali: 0,
        costiAmministrativi: 0,
        
        // VALORE AGGIUNTO E MOL
        valoreAggiunto: 0,
        MOL: 0, // Margine Operativo Lordo = EBITDA
        MOLpercentuale: 0,
        EBITDA: 0,
        
        // AMMORTAMENTI E ACCANTONAMENTI
        ammortamenti: ce.ammortamenti || 0,
        svalutazioni: ce.svalutazioni || 0,
        accantonamenti: ce.accantonamenti || 0,
        oneriDiversi: ce.oneriDiversi || 0,
        
        // EBIT
        EBIT: 0,
        ebit: 0, // alias
        EBITpercentuale: 0,
        ebitPerc: 0, // alias
        
        // GESTIONE FINANZIARIA
        proventiFinanziari: ce.proventiFinanziari || 0,
        oneriFinanziari: ce.oneriFinanziari || 0,
        saldoFinanziario: 0,
        
        // EBT E RISULTATO
        EBT: 0,
        EBTpercentuale: 0,
        imposte: ce.imposte || 0,
        taxRate: 0,
        risultatoNetto: ce.utileEsercizio || 0,
        RNpercentuale: 0,
        
        // Altri campi CE originali
        varLavoriCorso: ce.varLavoriCorso || 0,
        incrementiImm: ce.incrementiImm || 0,
        altriRicavi: ce.altriRicavi || 0
    };
    
    // CALCOLI
    // Consumi materie prime
    cev.consumiMateriePrime = cev.materiePrime + cev.varRimanenzeMaterie;
    
    // Costo del venduto (formula tipica)
    cev.costoVenduto = cev.materiePrime + cev.varRimanenzeMaterie - cev.varRimanenzeProdotti;
    
    // Margine lordo
    cev.margineLordo = cev.ricaviVendite - cev.costoVenduto;
    
    // Valore aggiunto
    cev.valoreAggiunto = cev.totValoreProduzione - cev.consumiMateriePrime - cev.servizi - cev.godimentoBeniTerzi;
    
    // MOL/EBITDA
    cev.MOL = cev.valoreAggiunto - cev.personale;
    cev.EBITDA = cev.MOL;
    
    // Stima costi commerciali e amministrativi
    cev.costiCommerciali = (cev.servizi * 0.7) + (cev.personale * 0.3);
    cev.costiAmministrativi = (cev.servizi * 0.3) + (cev.personale * 0.4) + cev.godimentoBeniTerzi;
    
    // EBIT
    cev.EBIT = cev.MOL - cev.ammortamenti - cev.svalutazioni - cev.accantonamenti - cev.oneriDiversi;
    cev.ebit = cev.EBIT; // alias
    
    // Saldo finanziario
    cev.saldoFinanziario = cev.proventiFinanziari - cev.oneriFinanziari;
    
    // EBT
    cev.EBT = cev.EBIT + cev.saldoFinanziario;
    
    // Calcola percentuali
    if (cev.totValoreProduzione > 0) {
        cev.MOLpercentuale = (cev.MOL / cev.totValoreProduzione) * 100;
        cev.EBITpercentuale = (cev.EBIT / cev.totValoreProduzione) * 100;
        cev.EBTpercentuale = (cev.EBT / cev.totValoreProduzione) * 100;
        cev.RNpercentuale = (cev.risultatoNetto / cev.totValoreProduzione) * 100;
    }
    
    if (cev.ricaviVendite > 0) {
        cev.margineLordoPerc = (cev.margineLordo / cev.ricaviVendite) * 100;
        cev.ebitPerc = (cev.EBIT / cev.ricaviVendite) * 100;
    }
    
    if (cev.EBT > 0 && cev.EBT !== 0) {
        cev.taxRate = (cev.imposte / cev.EBT) * 100;
    }
    
    return cev;
}

// Riclassificazione Valore Aggiunto
function riclassificazioneValoreAggiunto() {
    const ce = extractStandardizedCE();
    
    const va = {
        // PRODUZIONE
        ricaviVendite: ce.ricaviVendite || 0,
        varRimanenze: (ce.varRimanenzeProdotti || 0) + (ce.varLavoriCorso || 0),
        incrementiImm: ce.incrementiImm || 0,
        altriRicavi: ce.altriRicavi || 0,
        produzioneLorda: ce.valoreProduzione || 0,
        
        // CONSUMI ESTERNI
        acquistiMaterie: ce.materiePrime || 0,
        varRimanenzeMaterie: ce.varRimanenzeMaterie || 0,
        servizi: ce.servizi || 0,
        godimentoBeniTerzi: ce.godimentoBeniTerzi || 0,
        oneriDiversi: ce.oneriDiversi || 0,
        totConsumiEsterni: 0,
        
        // VALORE AGGIUNTO
        valoreAggiuntoLordo: 0,
        ammortamenti: ce.ammortamenti || 0,
        valoreAggiuntoNetto: 0,
        
        // DISTRIBUZIONE VA
        costiPersonale: ce.personale || 0,
        margineLordo: 0,
        accantonamenti: ce.accantonamenti || 0,
        risultatoOperativo: ce.differenzaAB || 0,
        
        // ALTRI COMPONENTI
        saldoFinanziario: (ce.proventiFinanziari || 0) - (ce.oneriFinanziari || 0),
        saldoStraordinario: ce.saldoStraordinario || 0,
        risultatoPrimaImposte: ce.risultatoPrimaImposte || 0,
        imposte: ce.imposte || 0,
        risultatoNetto: ce.utileEsercizio || 0
    };
    
    // Calcola aggregati
    va.totConsumiEsterni = va.acquistiMaterie + va.varRimanenzeMaterie + 
                           va.servizi + va.godimentoBeniTerzi + va.oneriDiversi;
    va.valoreAggiuntoLordo = va.produzioneLorda - va.totConsumiEsterni;
    va.valoreAggiuntoNetto = va.valoreAggiuntoLordo - va.ammortamenti;
    va.margineLordo = va.valoreAggiuntoNetto - va.costiPersonale;
    
    return va;
}

// Riclassificazione per Margini
function riclassificazionePerMargini() {
    const sp = extractStandardizedSP();
    const ce = extractStandardizedCE();
    
    const margini = {
        // MARGINE DI STRUTTURA
        patrimonioNetto: sp.patrimonioNetto || 0,
        immobilizzazioni: sp.immobilizzazioni || 0,
        margineStrutturaPrimario: 0,
        quozienteStrutturaPrimario: 0,
        
        debitiMLT: sp.debitiOltre12 || 0,
        fondiRischi: sp.fondiRischiOneri || 0,
        tfr: sp.tfr || 0,
        passivoConsolidato: 0,
        margineStrutturaSecondario: 0,
        quozienteStrutturaSecondario: 0,
        
        // MARGINE DI TESORERIA
        liquiditaImmediate: sp.disponibilitaLiquide || 0,
        liquiditaDifferite: sp.creditiEntro12 || 0,
        passivoCorrente: sp.debitiEntro12 || 0,
        margineTesoreria: 0,
        quozienteTesoreria: 0,
        
        // CAPITALE CIRCOLANTE NETTO
        attivoCircolante: sp.attivoCircolante || 0,
        CCNoperativo: 0,
        CCNcommerciale: 0,
        
        // MARGINE DI DISPONIBILITA
        rimanenze: sp.rimanenze || 0,
        margineDisponibilita: 0,
        quozienteDisponibilita: 0
    };
    
    // Calcola margini
    margini.margineStrutturaPrimario = margini.patrimonioNetto - margini.immobilizzazioni;
    margini.quozienteStrutturaPrimario = margini.immobilizzazioni > 0 ? 
        margini.patrimonioNetto / margini.immobilizzazioni : 0;
    
    margini.passivoConsolidato = margini.debitiMLT + margini.fondiRischi + margini.tfr;
    margini.margineStrutturaSecondario = (margini.patrimonioNetto + margini.passivoConsolidato) - 
                                         margini.immobilizzazioni;
    margini.quozienteStrutturaSecondario = margini.immobilizzazioni > 0 ? 
        (margini.patrimonioNetto + margini.passivoConsolidato) / margini.immobilizzazioni : 0;
    
    margini.margineTesoreria = (margini.liquiditaImmediate + margini.liquiditaDifferite) - 
                               margini.passivoCorrente;
    margini.quozienteTesoreria = margini.passivoCorrente > 0 ? 
        (margini.liquiditaImmediate + margini.liquiditaDifferite) / margini.passivoCorrente : 0;
    
    margini.CCNoperativo = margini.attivoCircolante - margini.passivoCorrente;
    margini.CCNcommerciale = (margini.rimanenze + margini.liquiditaDifferite) - margini.passivoCorrente;
    
    margini.margineDisponibilita = margini.attivoCircolante - margini.passivoCorrente;
    margini.quozienteDisponibilita = margini.passivoCorrente > 0 ? 
        margini.attivoCircolante / margini.passivoCorrente : 0;
    
    return margini;
}

// ========== INDICI DI BILANCIO ==========

// Calcola tutti gli indici

// Z-Score Altman
function calcolaZScoreAltman() {
    const sp = extractStandardizedSP();
    const ce = extractStandardizedCE();
    
    const totaleAttivo = sp.totaleAttivo || 1; // evita divisione per zero
    
    // Componenti Z-Score
    const X1 = (sp.attivoCircolante - sp.debitiEntro12) / totaleAttivo; // Working Capital/Total Assets
    const X2 = (sp.utiliNonDistribuiti || 0) / totaleAttivo; // Retained Earnings/Total Assets
    const X3 = ce.differenzaAB / totaleAttivo; // EBIT/Total Assets
    const X4 = sp.patrimonioNetto / sp.totDebiti || 0; // Market Value Equity/Total Liabilities
    const X5 = ce.ricaviVendite / totaleAttivo; // Sales/Total Assets
    
    // Formula Z-Score per aziende private
    const Z = 1.2 * X1 + 1.4 * X2 + 3.3 * X3 + 0.6 * X4 + 1.0 * X5;
    
    // Interpretazione
    let interpretazione = '';
    let rischio = '';
    if (Z > 2.99) {
        interpretazione = 'Zona Sicura';
        rischio = 'Basso';
    } else if (Z >= 1.81) {
        interpretazione = 'Zona Grigia';
        rischio = 'Medio';
    } else {
        interpretazione = 'Zona di Rischio';
        rischio = 'Alto';
    }
    
    return {
        score: Z,
        X1: X1,
        X2: X2,
        X3: X3,
        X4: X4,
        X5: X5,
        interpretazione: interpretazione,
        rischio: rischio
    };
}


// =======================================================
// ‚úÖ INDICI DI BILANCIO ULTIMO (ANNO N-1 / LAST)
// =======================================================
window.calcolaIndiciComplessivi = function() {
  const sp = extractStandardizedSP();
  const ce = extractStandardizedCE();

  if (!sp || !ce) {
    console.warn('Dati non disponibili per calcolo indici');
    return {
      ROE: 0, ROI: 0, ROS: 0, ROA: 0, ROCE: 0,
      currentRatio: 0, quickRatio: 0, cashRatio: 0,
      leverage: 0, debtEquityRatio: 0, equityRatio: 0, debtRatio: 0,
      gradoCopertura: 0,
      interestCoverageRatio: 0,
      rotazioneCapitaleInvestito: 0, rotazioneCapitaleCircolante: 0,
      rotazioneMagazzino: 0, giorniMagazzino: 365,
      giorniCrediti: 90, giorniDebiti: 90,
      coverageRatio: 0,
      debtServiceCoverageRatio: 0
    };
  }

  // Totale debiti calcolato in modo robusto
  const totDebiti = (sp.debitiEntro12 || 0) + (sp.debitiOltre12 || 0);

  return {
    // REDDITIVIT√Ä
    ROE: sp.patrimonioNetto > 0 ? (ce.utileEsercizio / sp.patrimonioNetto) * 100 : 0,
    ROI: sp.totaleAttivo > 0 ? (ce.differenzaAB / sp.totaleAttivo) * 100 : 0,
    ROS: ce.ricaviVendite > 0 ? (ce.differenzaAB / ce.ricaviVendite) * 100 : 0,
    ROA: sp.totaleAttivo > 0 ? (ce.utileEsercizio / sp.totaleAttivo) * 100 : 0,
    ROCE: (sp.totaleAttivo - sp.debitiEntro12) > 0
      ? (ce.differenzaAB / (sp.totaleAttivo - sp.debitiEntro12)) * 100
      : 0,

    // LIQUIDIT√Ä
    currentRatio: sp.debitiEntro12 > 0 ? sp.attivoCircolante / sp.debitiEntro12 : 0,
    quickRatio: sp.debitiEntro12 > 0
      ? (sp.attivoCircolante - sp.rimanenze) / sp.debitiEntro12
      : 0,
    cashRatio: sp.debitiEntro12 > 0 ? sp.disponibilitaLiquide / sp.debitiEntro12 : 0,

    // SOLIDIT√Ä
    leverage: sp.patrimonioNetto > 0 ? sp.totaleAttivo / sp.patrimonioNetto : 0,
    debtEquityRatio: sp.patrimonioNetto > 0 ? totDebiti / sp.patrimonioNetto : 0,
    equityRatio: sp.totaleAttivo > 0 ? (sp.patrimonioNetto / sp.totaleAttivo) * 100 : 0,
    debtRatio: sp.totaleAttivo > 0 ? (totDebiti / sp.totaleAttivo) * 100 : 0,
    gradoCopertura: sp.immobilizzazioni > 0 ? sp.patrimonioNetto / sp.immobilizzazioni : 0,

    // COPERTURA
    interestCoverageRatio: Math.abs(ce.oneriFinanziari) > 0
      ? ce.differenzaAB / Math.abs(ce.oneriFinanziari)
      : 0,
    coverageRatio: Math.abs(ce.oneriFinanziari) > 0
      ? (ce.differenzaAB + ce.ammortamenti) / Math.abs(ce.oneriFinanziari)
      : 0,

    // EFFICIENZA
    rotazioneCapitaleInvestito: sp.totaleAttivo > 0 ? ce.ricaviVendite / sp.totaleAttivo : 0,
    rotazioneCapitaleCircolante: sp.attivoCircolante > 0 ? ce.ricaviVendite / sp.attivoCircolante : 0,
    rotazioneMagazzino: sp.rimanenze > 0 ? ce.costiProduzione / sp.rimanenze : 0,
    giorniMagazzino: ce.costiProduzione > 0 ? (sp.rimanenze / ce.costiProduzione) * 365 : 0,
    giorniCrediti: ce.ricaviVendite > 0 ? (sp.totaleCrediti / ce.ricaviVendite) * 365 : 0,
    giorniDebiti: ce.costiProduzione > 0 ? (sp.debitiEntro12 / ce.costiProduzione) * 365 : 0,

    // DSCR
    debtServiceCoverageRatio: 0
  };
};

// ======================================================
// üë• INDICI DI PRODUTTIVIT√Ä ESTESI (Personale + Amm.)
// Usa dati da CompilaTabelle e Conto Economico standardizzato
// ======================================================
window.calcolaIndiciProduttivitaEstesi = function () {
  try {
    // ‚úÖ 1Ô∏è‚É£ Recupera dati tabelle da memoria o localStorage
    let t = {};
    if (typeof getDatiTabelleSafe === "function") {
      t = getDatiTabelleSafe(); // forza sempre il refresh
      if (!t || Object.keys(t).length === 0) {
        console.warn("‚ö†Ô∏è Nessun dato in getDatiTabelleSafe, provo a leggere localStorage‚Ä¶");
        const cfKey = (state?.cf || state?.codiceFiscale || "").trim();
        const yPrev = state?.anni?.prev || "";
        const yLast = state?.anni?.last || "";
        const key = `ceodoc_tabelle_${cfKey}_${yPrev}_${yLast}`;
        const saved = localStorage.getItem(key);
        if (saved) t = JSON.parse(saved);
      }
    } else if (state?.tabelle && Object.keys(state.tabelle).length > 0) {
      t = state.tabelle;
    }

    console.log("üß© Dati tabelle caricati in calcolaIndiciProduttivitaEstesi:", t);

    const cePrev = window.extractStandardizedCEPrev?.() || {};
    const ceLast = window.extractStandardizedCE?.() || {};

    // ‚úÖ Parser robusto per numeri italiani
    const num = v => {
      if (v == null || v === "") return 0;
      if (typeof v === "number") return v;
      const cleaned = String(v)
        .replace(/[^0-9,.-]/g, "")
        .replace(/\./g, "")
        .replace(",", ".");
      const n = parseFloat(cleaned);
      return isFinite(n) ? n : 0;
    };

    // === 2Ô∏è‚É£ Dati PREV ===
    const ricaviPrev = num(cePrev.ricaviVendite || cePrev.valoreProduzione);
    const addPrev = num(t.addetti_tot_prev);
    const ammPrev = num(t.amm_numero_prev);
    const costoPrev = num(t.costo_pers_tot_prev || t.cp_prod_prev);
    const ammCompPrev = num(t.amm_totale_prev || 0);

    // === 3Ô∏è‚É£ Dati LAST ===
    const ricaviLast = num(ceLast.ricaviVendite || ceLast.valoreProduzione);
    const addLast = num(t.addetti_tot_last);
    const ammLast = num(t.amm_numero_last);
    const costoLast = num(t.costo_pers_tot_last || t.cp_prod_last);
    const ammCompLast = num(t.amm_totale_last || 0);

    // === 4Ô∏è‚É£ Calcolo per ciascun anno ===
    const calc = (ricavi, add, amm, costo, costoAmm, anno) => ({
      anno,
      ricavi,
      addetti: add,
      numAmm: amm,
      ricaviPerDip: add > 0 ? ricavi / add : 0,
      ricaviPerAmm: amm > 0 ? ricavi / amm : 0,
      costoMedioDip: add > 0 ? costo / add : 0,
      costoMedioAmm: amm > 0 ? costoAmm / amm : 0,
      costoTotale: costo,
      incidenzaPersonale: ricavi > 0 ? (costo / ricavi) * 100 : 0,
      incidenzaAmm: ricavi > 0 ? (costoAmm / ricavi) * 100 : 0
    });

    const prev = calc(ricaviPrev, addPrev, ammPrev, costoPrev, ammCompPrev, state?.anni?.prev || "‚Äî");
    const last = calc(ricaviLast, addLast, ammLast, costoLast, ammCompLast, state?.anni?.last || "‚Äî");

    // === 5Ô∏è‚É£ Log e ritorno ===
    console.log("‚úÖ Indici di Produttivit√† Estesi:", { prev, last });
    return { prev, last };

  } catch (err) {
    console.error("‚ùå Errore calcolaIndiciProduttivitaEstesi:", err);
    return { prev: {}, last: {} };
  }
};


// ========== FUNZIONI HELPER PER COMPATIBILIT√Ä ==========
window.calcolaTotaleCostiFissi = function() {
    // Prima prova a leggere dal DOM (se il modal √® aperto)
    const el = document.getElementById('be-fissi-tot-last');
    if (el) {
        return parseFloat(el.textContent.replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    // Altrimenti leggi da localStorage
    const cfKey = (state?.cf || state?.codiceFiscale || 'NA').toString().trim();
    const yLast = state?.anni?.last || 'NA';
    const saved = localStorage.getItem(`breakeven_${cfKey}_${yLast}`);
    
    if (saved) {
        const dati = JSON.parse(saved);
        return dati.costiFissi || 0;
    }
    
    return 0;
};

window.calcolaTotaleCostiVariabili = function() {
    // Prima prova a leggere dal DOM (se il modal √® aperto)
    const el = document.getElementById('be-var-tot-last');
    if (el) {
        return parseFloat(el.textContent.replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    // Altrimenti leggi da localStorage
    const cfKey = (state?.cf || state?.codiceFiscale || 'NA').toString().trim();
    const yLast = state?.anni?.last || 'NA';
    const saved = localStorage.getItem(`breakeven_${cfKey}_${yLast}`);
    
    if (saved) {
        const dati = JSON.parse(saved);
        return dati.costiVariabili || 0;
    }
    
    return 0;
};

window.showDSCRTab = function(tab) {
    // Nascondi tutti i tab
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    
    // Rimuovi active da tutti i bottoni
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Mostra il tab selezionato
    if (tab === 'dscr') {
        document.getElementById('tabDSCR').style.display = 'block';
        document.querySelector('[onclick*="dscr"]').classList.add('active');
    } else if (tab === 'zscore') {
        document.getElementById('tabZScore').style.display = 'block';
        document.querySelector('[onclick*="zscore"]').classList.add('active');
    }
};



// Indici Allerta Crisi (CNDCEC)
// Calcolo indici di allerta (settoriali + segnali strutturali)
function calcolaIndiciAllertaCrisi() {
  try {
    const sp = (typeof extractStandardizedSP === 'function') ? extractStandardizedSP() : null;
    const ce = (typeof extractStandardizedCE === 'function') ? extractStandardizedCE() : null;

    // Safe numeric helpers
    const N = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const sdiv = (num, den) => (N(den) !== 0 ? N(num) / N(den) : 0);

    // Identificativi
    const cfKey = (state?.cf ?? state?.codiceFiscale ?? 'NA').toString().trim();
    const yPrev = state?.anni?.prev ?? 'NA';
    const yLast = state?.anni?.last ?? 'NA';

    // Base oggetto di risposta
    const allerta = {
      cf: cfKey,
      anni: { prev: yPrev, last: yLast },
      timestamp: new Date().toISOString(),
      patrimonioNettoNegativo: false,
      DSCRinferiore1: false,
      dscrValue: 0,
      settoreRiferimento: '',
      indiciSettoriali: [],            // dettagli singolo indice (nome, valore, soglia, esito)
      soglie: {                        // soglie usate
        equity: 0, oneriFinanziari: 0, liquidita: 0, rotazione: 0, leverage: 0
      },
      valori: {                        // valori calcolati
        indiceEquity: 0, indiceOneriFinanziari: 0, indiceLiquidita: 0,
        indiceRotazione: 0, indiceLeverage: 0
      },
      superamenti: 0,
      allertaCrisi: false
    };

    // Se mancano i dati minimi, restituisco oggetto default
    if (!sp || !ce) {
      console.warn('calcolaIndiciAllertaCrisi: dati SP/CE non disponibili.');
      return allerta;
    }

    // === DSCR (accetta oggetto o numero) ===
    let dscrRaw = 0;
    try {
      const dscrRes = window.calcolaDSCRCompleto ? window.calcolaDSCRCompleto() : 0;
      dscrRaw = typeof dscrRes === 'object'
        ? (Number(dscrRes.ratio) || Number(dscrRes.value) || Number(dscrRes.dscr) || 0)
        : Number(dscrRes) || 0;
    } catch (_) { /* no-op */ }
    allerta.dscrValue = dscrRaw;
    allerta.DSCRinferiore1 = dscrRaw > 0 ? (dscrRaw < 1) : false;

    // === Patrimonio netto negativo ===
    const PN = N(sp.patrimonioNetto);
    allerta.patrimonioNettoNegativo = PN < 0;

    // === Normalizzazione settore per soglie ===
    const sectorRaw = (state?.settore ?? state?.ateco ?? '').toString().toLowerCase();
    const mappaSettore = () => {
      if (sectorRaw.startsWith('c') || sectorRaw.includes('industr')) return 'Industria';
      if (sectorRaw.startsWith('g') || sectorRaw.includes('commerc')) return 'Commercio';
      if (sectorRaw.startsWith('f') || sectorRaw.includes('edil')) return 'Edilizia';
      if (sectorRaw.startsWith('l') || sectorRaw.includes('immob')) return 'Immobiliare';
      return 'Servizi';
    };
    const settore = mappaSettore();
    allerta.settoreRiferimento = settore;

    // === Soglie settoriali ===
    const soglieSettoriali = {
      'Industria':   { equity: 0.05, oneriFinanziari: 0.08, liquidita: 0.80, rotazione: 1.00, leverage: 5.0 },
      'Commercio':   { equity: 0.03, oneriFinanziari: 0.06, liquidita: 0.70, rotazione: 1.50, leverage: 6.0 },
      'Servizi':     { equity: 0.04, oneriFinanziari: 0.07, liquidita: 0.90, rotazione: 1.20, leverage: 4.5 },
      'Edilizia':    { equity: 0.06, oneriFinanziari: 0.10, liquidita: 0.60, rotazione: 0.80, leverage: 7.0 },
      'Immobiliare': { equity: 0.08, oneriFinanziari: 0.05, liquidita: 0.50, rotazione: 0.30, leverage: 8.0 }
    };
    const soglie = soglieSettoriali[settore] || soglieSettoriali['Industria'];
    allerta.soglie = soglie;

    // === Valori necessari SP/CE ===
    const TotAttivo        = N(sp.totaleAttivo);
    const TotDebiti        = N(sp.totDebiti);
    const DebitiEntro12    = N(sp.debitiEntro12);
    const AttivoCircolante = N(sp.attivoCircolante);

    const Ricavi           = N(ce.ricaviVendite);
    const OneriFin        = Math.abs(N(ce.oneriFinanziari)); // in valore assoluto

    // === Calcolo indici ===
    allerta.valori.indiceEquity          = sdiv(PN, TotAttivo);                 // PN / TotAttivo
    allerta.valori.indiceOneriFinanziari = sdiv(OneriFin, Ricavi);              // |Oneri fin| / Ricavi
    allerta.valori.indiceLiquidita       = sdiv(AttivoCircolante, DebitiEntro12); // Current ratio (proxy allerta)
    allerta.valori.indiceRotazione       = sdiv(Ricavi, TotAttivo);             // Asset turnover
    allerta.valori.indiceLeverage        = PN > 0 ? (TotAttivo / PN) : 0;       // Leverage

    // === Verifica soglie e popolamento dettagli ===
    const dettagli = [];

    const testEquity = allerta.valori.indiceEquity < soglie.equity;
    if (testEquity) allerta.superamenti++;
    dettagli.push({
      indice: 'Equity ratio (PN/TotAttivo)',
      valore: allerta.valori.indiceEquity,
      soglia: soglie.equity,
      operatore: '<',
      esito: !testEquity
    });

    const testOneri = allerta.valori.indiceOneriFinanziari > soglie.oneriFinanziari;
    if (testOneri) allerta.superamenti++;
    dettagli.push({
      indice: 'Oneri finanziari/Ricavi',
      valore: allerta.valori.indiceOneriFinanziari,
      soglia: soglie.oneriFinanziari,
      operatore: '>',
      esito: !testOneri
    });

    const testLiq = allerta.valori.indiceLiquidita < soglie.liquidita;
    if (testLiq) allerta.superamenti++;
    dettagli.push({
      indice: 'Liquidit√† (AC/PC)',
      valore: allerta.valori.indiceLiquidita,
      soglia: soglie.liquidita,
      operatore: '<',
      esito: !testLiq
    });

    const testRot = allerta.valori.indiceRotazione < soglie.rotazione;
    if (testRot) allerta.superamenti++;
    dettagli.push({
      indice: 'Rotazione attivo (Ricavi/TotAttivo)',
      valore: allerta.valori.indiceRotazione,
      soglia: soglie.rotazione,
      operatore: '<',
      esito: !testRot
    });

    const testLev = allerta.valori.indiceLeverage > soglie.leverage;
    if (testLev) allerta.superamenti++;
    dettagli.push({
      indice: 'Leverage (TotAttivo/PN)',
      valore: allerta.valori.indiceLeverage,
      soglia: soglie.leverage,
      operatore: '>',
      esito: !testLev
    });

    allerta.indiciSettoriali = dettagli;

    // === Valutazione allerta complessiva ===
    allerta.allertaCrisi =
      allerta.patrimonioNettoNegativo ||
      allerta.DSCRinferiore1 ||
      allerta.superamenti >= 3;

    return allerta;
  } catch (e) {
    console.error('‚ùå calcolaIndiciAllertaCrisi:', e);
    return {
      cf: (state?.cf ?? state?.codiceFiscale ?? 'NA').toString().trim(),
      anni: { prev: state?.anni?.prev ?? 'NA', last: state?.anni?.last ?? 'NA' },
      timestamp: new Date().toISOString(),
      patrimonioNettoNegativo: false,
      DSCRinferiore1: false,
      dscrValue: 0,
      settoreRiferimento: '',
      indiciSettoriali: [],
      soglie: { equity: 0, oneriFinanziari: 0, liquidita: 0, rotazione: 0, leverage: 0 },
      valori: { indiceEquity: 0, indiceOneriFinanziari: 0, indiceLiquidita: 0, indiceRotazione: 0, indiceLeverage: 0 },
      superamenti: 0,
      allertaCrisi: false
    };
  }
}

// Rendi funzioni globali
window.riclassificazioneCEV = riclassificazioneCEV;
window.riclassificazioneValoreAggiunto = riclassificazioneValoreAggiunto;
window.riclassificazionePerMargini = riclassificazionePerMargini;
window.calcolaIndiciComplessivi = calcolaIndiciComplessivi;
window.calcolaZScoreAltman = calcolaZScoreAltman;
window.calcolaIndiciAllertaCrisi = calcolaIndiciAllertaCrisi;

// ========== UI SCORE ECONOMICO-FINANZIARIO ==========

function mostraScoreEF() {
  const risultato = calcolaScoreEconomicoFinanziario();
  if (!risultato) return;

  const modal = document.createElement("div");
  modal.id = "modalScoreEF";
  modal.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  const container = document.createElement("div");
  container.style.cssText = `
    background: white;
    width: 95%; max-width: 1200px;
    max-height: 90vh;
    border-radius: 12px;
    overflow-y: auto;
    font-family: 'Segoe UI', Arial, sans-serif;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  `;

  const ind = window.calcolaIndiciComplessivi?.() || {};
  const dscr = window.calcolaDSCRCompleto?.() || {};
  const ratioDSCR = dscr?.last?.ratio || dscr?.ratio || 0;

  // === HEADER ===
  container.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;
                background:#003d82;color:white;padding:14px 20px;
                border-radius:12px 12px 0 0;">
      <h2 style="margin:0;font-size:18px;font-weight:600;">Score Economico-Finanziario (FdG)</h2>
      <div style="display:flex;align-items:center;gap:12px;">
        <svg width="42" height="42">
          <circle cx="21" cy="21" r="19" fill="#1e3a8a" stroke="white" stroke-width="2"></circle>
          <text x="50%" y="55%" text-anchor="middle" font-size="16" font-weight="700" fill="white" dy=".3em">
            ${risultato.classe || "-"}
          </text>
        </svg>
        <button onclick="document.getElementById('modalScoreEF').remove()" 
                style="background:none;border:none;color:white;font-size:22px;cursor:pointer;">√ó</button>
      </div>
    </div>

    <!-- BOX PRINCIPALE -->
    <div style="background:linear-gradient(135deg,#2563eb,#4f46e5);
                color:white;text-align:center;padding:25px;
                box-shadow:inset 0 2px 6px rgba(0,0,0,0.2);">
      <div style="font-size:14px;opacity:0.9;">Classe di Rating</div>
      <div style="font-size:40px;font-weight:800;line-height:1;">${risultato.classe}</div>
      <div style="font-size:14px;">xb = ${risultato.xb?.toFixed(4) || "‚Äî"}</div>
      <div style="font-size:13px;margin-top:4px;">MOL ${itFmt(risultato.MOL)} ‚Ç¨</div>
    </div>

    <!-- INDICATORI SINTETICI -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px;">
      ${(() => {
        const box = (label, val, color) => `
          <div style="background:${color};color:white;padding:10px;border-radius:8px;text-align:center;">
            <div style="font-size:12px;opacity:0.9;">${label}</div>
            <div style="font-size:18px;font-weight:700;">${val}</div>
          </div>`;
        return [
          box("ROI %", (ind.ROI || 0).toFixed(2), ind.ROI>=8?"#10b981":ind.ROI>=4?"#facc15":"#dc2626"),
          box("ROE %", (ind.ROE || 0).toFixed(2), ind.ROE>=10?"#10b981":ind.ROE>=5?"#facc15":"#dc2626"),
          box("DSCR", ratioDSCR.toFixed(2), ratioDSCR>=1.25?"#10b981":ratioDSCR>=1?"#facc15":"#dc2626"),
          box("Leverage", (ind.leverage || 0).toFixed(2), ind.leverage<=3?"#10b981":ind.leverage<=4?"#facc15":"#dc2626")
        ].join('');
      })()}
    </div>

    <!-- BOTTONE DETTAGLIO TECNICO -->
    <div style="text-align:center;margin:20px;">
      <button id="btnDettagliEF"
              onclick="document.getElementById('dettagliTecniciEF').style.display =
                        document.getElementById('dettagliTecniciEF').style.display==='none'?'block':'none';"
              style="background:#003d82;color:white;border:none;padding:8px 18px;
                     border-radius:6px;font-weight:600;cursor:pointer;">
        ‚ñº Mostra dettagli tecnici
      </button>
    </div>

    <!-- DETTAGLI TECNICI -->
    <div id="dettagliTecniciEF" style="display:none;margin-bottom:20px;">
      <div style="background:#e0f2fe;padding:10px;border-radius:6px;margin:0 15px 20px 15px;
                  font-size:13px;color:#1e3a8a;line-height:1.5;">
        <b>Nota interpretativa:</b><br>
        Le variabili (V) e Dummy (D) rappresentano gli indicatori economico-finanziari del modello MCC.<br>
        <b>Valore</b> = dato reale aziendale &nbsp;‚Ä¢&nbsp;
        <b>Peso</b> = coefficiente MCC &nbsp;‚Ä¢&nbsp;
        <b>Impatto</b> = contributo sul punteggio finale.<br>
        La barra colorata mostra l‚Äôeffetto: verde positivo, rosso negativo.
      </div>

      ${(() => {
        const buildTable = (type, title) => {
          const variabiliUsate = COEFFICIENTI_FDG[state.settore.toUpperCase()]?.variabili || {};
          let rows = "";

          for (let key in variabiliUsate) {
            if (key.startsWith(type)) {
              const valore = (type==="V"?risultato.variabili[key]:risultato.dummy?.[key]) || 0;
              const coef = variabiliUsate[key].coef || 0;
              const contrib = valore * coef;
              const sign = contrib >= 0 ? "+" : "";
              const abs = Math.abs(contrib);
              const color = contrib >= 0 ? "#10b981" : "#dc2626";
              const barWidth = Math.min(100, Math.round(abs * 200));
              rows += `
                <tr>
                  <td style="padding:6px;">${key}</td>
                  <td style="padding:6px;">${window.DIZIONARIO_VARIABILI_FDG[key] || "‚Äî"}</td>
                  <td style="padding:6px;text-align:right;">${valore.toFixed(4)}</td>
                  <td style="padding:6px;text-align:right;">${coef.toFixed(4)}</td>
                  <td style="padding:6px;text-align:right;color:${color};font-weight:600;">
                    <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
                      <div style="width:${barWidth}px;height:6px;background:${color};border-radius:3px;"></div>
                      ${sign}${contrib.toFixed(4)}
                    </div>
                  </td>
                </tr>`;
            }
          }

          // ‚úÖ Gestione Dummy non attive
          if (type === "D" && Object.values(risultato.dummy || {}).every(v => v === 0)) {
            rows = `<tr><td colspan="5" style="padding:10px;text-align:left;color:#374151;
              font-size:13px;line-height:1.5;background:#f8fafc;border-radius:6px;">
              <b>Nessuna delle condizioni qualitative (Dummy) risulta verificata per l‚Äôesercizio analizzato.</b><br>
              Questo significa che, secondo i criteri del modello MCC, non si sono attivati miglioramenti o fattori premiali specifici.<br>
              In particolare, non si rilevano condizioni come:
              <ul style="margin:6px 0 6px 20px;padding:0;">
                <li>aumento dell‚ÄôEBITDA rispetto all‚Äôanno precedente,</li>
                <li>utile netto positivo,</li>
                <li>miglioramento della posizione finanziaria netta,</li>
                <li>patrimonio netto positivo con DSCR ‚â• 1,25.</li>
              </ul>
              L‚Äôassenza di tali condizioni non rappresenta una criticit√†, ma indica semplicemente che la gestione
              mantiene un profilo neutro ai fini del rating qualitativo.
            </td></tr>`;
          }

return `
  <div style="margin:0 15px 25px 15px;">
    <h4 style="color:#003d82;margin:0 0 10px 0;">${title}</h4>
    ${
      type === "D"
        ? `<div style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;
                      font-size:13px;color:#1e3a8a;line-height:1.5;">
              Le variabili Dummy (D) rappresentano <b>condizioni qualitative</b> che influenzano il punteggio MCC.<br>
              Ogni Dummy vale 1 se la condizione √® verificata, 0 se non lo √®.<br>
              Esempi di condizioni:<br>
              ‚Ä¢ aumento dell‚ÄôEBITDA rispetto all‚Äôanno precedente<br>
              ‚Ä¢ utile netto positivo<br>
              ‚Ä¢ miglioramento della posizione finanziaria netta<br>
              ‚Ä¢ patrimonio netto positivo con DSCR ‚â• 1,25<br>
              Se nessuna condizione √® soddisfatta, il risultato rimane <b>neutro</b> ai fini del rating qualitativo.
           </div>`
        : ""
    }
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:#f1f5f9;color:#003d82;">
          <th style="padding:6px;text-align:left;">Var</th>
          <th style="padding:6px;text-align:left;">Significato</th>
          <th style="padding:6px;text-align:right;">Valore</th>
          <th style="padding:6px;text-align:right;">Peso</th>
          <th style="padding:6px;text-align:right;">Impatto</th>
        </tr>
      </thead>
      <tbody>${rows || `<tr><td colspan="5" style="padding:6px;text-align:center;">‚Äî Nessun dato disponibile ‚Äî</td></tr>`}</tbody>
    </table>
  </div>`;
        };

        return buildTable("V", "Variabili Principali (V)") + buildTable("D", "Variabili Dummy (D)");
      })()}
    </div>

    <!-- PULSANTI FINALI -->
    <div style="text-align:center;margin-bottom:25px;">
      <button onclick="salvaScoreEF()" 
              style="background:#10b981;color:white;border:none;padding:10px 25px;
                     border-radius:6px;font-weight:600;cursor:pointer;">
        Salva Score EF
      </button>
      <button onclick="openScoreAndamentaleInput()" 
              style="background:#003d82;color:white;border:none;padding:10px 25px;
                     border-radius:6px;font-weight:600;cursor:pointer;margin-left:10px;">
        Procedi con Score Andamentale
      </button>
    </div>
  `;

  modal.appendChild(container);
  document.body.appendChild(modal);

  state.scoreEF = risultato;
}

   

// ========== UI ANALISI COMPLETA ==========

function mostraAnalisiCompleta() {
    const cev = riclassificazioneCEV();
    const va = riclassificazioneValoreAggiunto();
    const margini = riclassificazionePerMargini();
    const indici = calcolaIndiciComplessivi();
    const zScore = calcolaZScoreAltman();
    const dscr = calcolaDSCRCompleto();
    const allerta = calcolaIndiciAllertaCrisi();
    
    const modal = document.createElement('div');
    modal.id = 'modalAnalisi';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        background: white;
        width: 95%;
        max-width: 1600px;
        height: 90vh;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    `;
    
    const header = document.createElement('div');
    header.style.cssText = `
        padding: 15px 20px;
        background: #003d82;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;
    header.innerHTML = `
        <h2 style="margin: 0;">Analisi di Bilancio Completa</h2>
        <button onclick="document.getElementById('modalAnalisi').remove()" 
                style="background: rgba(255,255,255,0.2); border: none; color: white; 
                       font-size: 24px; cursor: pointer;">&times;</button>
    `;
    
    const tabs = document.createElement('div');
    tabs.style.cssText = `
        display: flex;
        background: #f0f0f0;
        border-bottom: 2px solid #1e40af;
    `;
    tabs.innerHTML = `
        <button class="tab-analisi active" onclick="showAnalisiTab('riclassificazioni')">Riclassificazioni</button>
        <button class="tab-analisi" onclick="showAnalisiTab('indici')">Indici</button>
        <button class="tab-analisi" onclick="showAnalisiTab('score')">Score & Rating</button>
        <button class="tab-analisi" onclick="showAnalisiTab('allerta')">Allerta Crisi</button>
        <button class="tab-analisi" onclick="showAnalisiTab('grafici')">Grafici</button>
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
        flex: 1;
        overflow: auto;
        padding: 20px;
    `;
    
    // Tab Riclassificazioni
    const tabRiclass = document.createElement('div');
    tabRiclass.id = 'tab-riclassificazioni';
    tabRiclass.innerHTML = `
        <h3 style="color: #003d82;">Riclassificazione Costo del Venduto</h3>
        <table style="width: 60%; margin-bottom: 30px; border-collapse: collapse;">
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Ricavi Vendite</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.ricaviVendite)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Costi Materie Prime</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚àí${itFmt(cev.consumiMateriePrime)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Servizi</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚àí${itFmt(cev.servizi)}</td></tr>
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td style="padding: 8px; border: 1px solid #ddd;">VALORE AGGIUNTO</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.valoreAggiunto)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Costo Personale</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚àí${itFmt(cev.personale)}</td></tr>
            <tr style="background: #e8f4f8; font-weight: bold;">
                <td style="padding: 8px; border: 1px solid #ddd;">MOL/EBITDA</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.MOL)} (${cev.MOLpercentuale.toFixed(1)}%)</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Ammortamenti</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚àí${itFmt(cev.ammortamenti)}</td></tr>
            <tr style="background: #e8f4f8; font-weight: bold;">
                <td style="padding: 8px; border: 1px solid #ddd;">EBIT</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.EBIT)} (${cev.EBITpercentuale.toFixed(1)}%)</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Saldo Finanziario</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.saldoFinanziario)}</td></tr>
            <tr style="background: #e8f4f8; font-weight: bold;">
                <td style="padding: 8px; border: 1px solid #ddd;">EBT</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.EBT)} (${cev.EBTpercentuale.toFixed(1)}%)</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Imposte</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚àí${itFmt(cev.imposte)} (${cev.taxRate.toFixed(1)}%)</td></tr>
            <tr style="background: #d4edda; font-weight: bold;">
                <td style="padding: 8px; border: 1px solid #ddd;">RISULTATO NETTO</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(cev.risultatoNetto)} (${cev.RNpercentuale.toFixed(1)}%)</td></tr>
        </table>
        
        <h3 style="color: #003d82;">Margini di Struttura</h3>
        <table style="width: 60%; border-collapse: collapse;">
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Margine Struttura Primario</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(margini.margineStrutturaPrimario)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Quoziente Struttura Primario</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${margini.quozienteStrutturaPrimario.toFixed(2)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">Margine Struttura Secondario</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(margini.margineStrutturaSecondario)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;">CCN Operativo</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${itFmt(margini.CCNoperativo)}</td></tr>
        </table>
    `;
    
    // Tab Indici
    const tabIndici = document.createElement('div');
    tabIndici.id = 'tab-indici';
    tabIndici.style.display = 'none';
    tabIndici.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <div>
                <h4 style="color: #1e40af;">Redditivit√†</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">ROE</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${indici.ROE > 0 ? 'green' : 'red'};">
                            ${indici.ROE.toFixed(2)}%</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">ROI</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.ROI.toFixed(2)}%</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">ROS</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.ROS.toFixed(2)}%</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">ROA</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.ROA.toFixed(2)}%</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">ROCE</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.ROCE.toFixed(2)}%</td></tr>
                </table>
            </div>
            
            <div>
                <h4 style="color: #1e40af;">Liquidit√†</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Current Ratio</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${indici.currentRatio > 1.5 ? 'green' : indici.currentRatio > 1 ? 'orange' : 'red'};">
                            ${indici.currentRatio.toFixed(2)}</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Quick Ratio</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.quickRatio.toFixed(2)}</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Cash Ratio</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.cashRatio.toFixed(2)}</td></tr>
                </table>
            </div>
            
            <div>
                <h4 style="color: #1e40af;">Solidit√†</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Leverage</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.leverage.toFixed(2)}</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Debt/Equity</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${indici.debtEquityRatio.toFixed(2)}</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Equity Ratio</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${(indici.equityRatio*100).toFixed(1)}%</td></tr>
                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Interest Coverage</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${indici.interestCoverageRatio > 3 ? 'green' : indici.interestCoverageRatio > 1.5 ? 'orange' : 'red'};">
                            ${indici.interestCoverageRatio.toFixed(2)}</td></tr>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h4 style="color: #003d82;">Z-Score Altman</h4>
            <div style="display: flex; align-items: center; gap: 30px;">
                <div style="flex: 1;">
                    <div style="font-size: 48px; font-weight: bold; color: ${zScore.rischio === 'Alto' ? '#dc2626' : zScore.rischio === 'Medio' ? '#f97316' : '#10b981'};">
                        ${zScore.score.toFixed(2)}
                    </div>
                    <div style="font-size: 18px; margin-top: 10px;">
                        ${zScore.interpretazione} - Rischio ${zScore.rischio}
                    </div>
                </div>
                <div style="flex: 2;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr><td>X1 (Working Capital/Assets)</td><td style="text-align: right;">${zScore.X1.toFixed(4)}</td></tr>
                        <tr><td>X2 (Retained Earnings/Assets)</td><td style="text-align: right;">${zScore.X2.toFixed(4)}</td></tr>
                        <tr><td>X3 (EBIT/Assets)</td><td style="text-align: right;">${zScore.X3.toFixed(4)}</td></tr>
                        <tr><td>X4 (Equity/Debt)</td><td style="text-align: right;">${zScore.X4.toFixed(4)}</td></tr>
                        <tr><td>X5 (Sales/Assets)</td><td style="text-align: right;">${zScore.X5.toFixed(4)}</td></tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; background: #e8f4f8; padding: 20px; border-radius: 8px;">
            <h4 style="color: #003d82;">DSCR - Debt Service Coverage Ratio</h4>
            <div style="display: flex; align-items: center; gap: 30px;">
                <div style="flex: 1;">
                    <div style="font-size: 48px; font-weight: bold; color: ${dscr.sostenibilita === 'Critica' ? '#dc2626' : dscr.sostenibilita === 'Sufficiente' ? '#f97316' : '#10b981'};">
                        ${dscr.ratio.toFixed(2)}
                    </div>
                    <div style="font-size: 18px; margin-top: 10px;">
                        ${dscr.interpretazione}
                    </div>
                </div>
                <div style="flex: 2;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr><td style="padding: 6px;">EBITDA</td><td style="text-align: right;">${itFmt(dscr.EBITDA)}</td></tr>
                        <tr><td style="padding: 6px;">‚àí Imposte</td><td style="text-align: right;">‚àí${itFmt(dscr.imposte)}</td></tr>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td style="padding: 6px;">= Numeratore</td><td style="text-align: right;">${itFmt(dscr.EBITDA - dscr.imposte)}</td></tr>
                        <tr><td style="padding: 6px;">Quote Capitale</td><td style="text-align: right;">${itFmt(dscr.quoteCapitale)}</td></tr>
                        <tr><td style="padding: 6px;">+ Interessi</td><td style="text-align: right;">${itFmt(dscr.interessi)}</td></tr>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td style="padding: 6px;">= Denominatore</td><td style="text-align: right;">${itFmt(dscr.quoteCapitale + dscr.interessi)}</td></tr>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Altri tab...
    const tabScore = document.createElement('div');
    tabScore.id = 'tab-score';
    tabScore.style.display = 'none';
    tabScore.innerHTML = `<h3>Score e Rating - Da completare</h3>`;
    
    const tabAllerta = document.createElement('div');
    tabAllerta.id = 'tab-allerta';
    tabAllerta.style.display = 'none';
    tabAllerta.innerHTML = generaHTMLAllertaCrisi(allerta);
    
    const tabGrafici = document.createElement('div');
    tabGrafici.id = 'tab-grafici';
    tabGrafici.style.display = 'none';
    tabGrafici.innerHTML = `<h3>Grafici - Da implementare</h3>`;
    
    content.appendChild(tabRiclass);
    content.appendChild(tabIndici);
    content.appendChild(tabScore);
    content.appendChild(tabAllerta);
    content.appendChild(tabGrafici);
    
    container.appendChild(header);
    container.appendChild(tabs);
    container.appendChild(content);
    modal.appendChild(container);
    document.body.appendChild(modal);
}

function generaHTMLAllertaCrisi(allerta) {
    const statoAllerta = allerta.allertaCrisi ? 
        '<span style="color: #dc2626; font-weight: bold; font-size: 24px;">‚ö†Ô∏è ALLERTA CRISI ATTIVA</span>' :
        '<span style="color: #10b981; font-weight: bold; font-size: 24px;">‚úì NESSUNA ALLERTA</span>';
    
    return `
        <div style="text-align: center; margin-bottom: 30px;">
            ${statoAllerta}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4 style="color: #003d82;">Indicatori Primari</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">Patrimonio Netto Negativo</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            ${allerta.patrimonioNettoNegativo ? 
                                '<span style="color: red;">‚ùå SI</span>' : 
                                '<span style="color: green;">‚úì NO</span>'}
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">DSCR < 1</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            ${allerta.DSCRinferiore1 ? 
                                '<span style="color: red;">‚ùå SI</span>' : 
                                '<span style="color: green;">‚úì NO</span>'}
                        </td>
                    </tr>
                </table>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4 style="color: #003d82;">Indici Settoriali (${state.settore})</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #e0e0e0;">
                            <th style="padding: 5px; border: 1px solid #ddd;">Indice</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Valore</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Soglia</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Stato</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Equity</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                ${allerta.valori.indiceEquity.toFixed(3)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                > ${allerta.soglie.equity}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                                ${allerta.valori.indiceEquity >= allerta.soglie.equity ? 
                                    '<span style="color: green;">‚úì</span>' : 
                                    '<span style="color: red;">‚ùå</span>'}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Oneri Fin.</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                ${allerta.valori.indiceOneriFinanziari.toFixed(3)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                < ${allerta.soglie.oneriFinanziari}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                                ${allerta.valori.indiceOneriFinanziari <= allerta.soglie.oneriFinanziari ? 
                                    '<span style="color: green;">‚úì</span>' : 
                                    '<span style="color: red;">‚ùå</span>'}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Liquidit√†</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                ${allerta.valori.indiceLiquidita.toFixed(3)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">
                                > ${allerta.soglie.liquidita}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                                ${allerta.valori.indiceLiquidita >= allerta.soglie.liquidita ? 
                                    '<span style="color: green;">‚úì</span>' : 
                                    '<span style="color: red;">‚ùå</span>'}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 10px; padding: 10px; background: ${allerta.superamenti >= 3 ? '#fef2f2' : '#f0fdf4'}; border-radius: 6px;">
                    Soglie superate: ${allerta.superamenti}/5
                    ${allerta.superamenti >= 3 ? ' - ATTENZIONE!' : ' - OK'}
                </div>
            </div>
        </div>
    `;
}

// Funzione per switch tab analisi
window.showAnalisiTab = function(tabName, ev) {
    document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
    document.getElementById('tab-' + tabName).style.display = 'block';
    document.querySelectorAll('.tab-analisi').forEach(b => b.classList.remove('active'));
    (ev || window.event)?.target?.classList?.add('active');
};

// Salva Score EF
window.salvaScoreEF = function() {
    if (state.scoreEF) {
        const annoCorrente = state.anni?.last || "2022";
                       localStorage.setItem(`ceodoc_scoreef_${state.cf}_${annoCorrente}`, JSON.stringify({

            ...state.scoreEF,
            timestamp: new Date().toISOString(),
            azienda: state.denom
        }));
        toast("Score EF salvato con successo!");
    }
};

// Procedi con Score Andamentale
window.procediConScoreAndamentale = function() {
    document.getElementById('modalScoreEF')?.remove();
    openScoreAndamentaleInput();
};

// Rendi funzioni globali
window.mostraScoreEF = mostraScoreEF;
window.mostraAnalisiCompleta = mostraAnalisiCompleta;

// ========== GRAFICI E VISUALIZZAZIONI ==========

// Genera grafici con Canvas
function disegnaWaterfallEBITDA(cev) {
    const canvas = document.getElementById('grafico-waterfall');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    const steps = [
        { label: 'Ricavi', valore: cev.ricaviVendite, cumulative: cev.ricaviVendite },
        { label: 'Mat.Prime', valore: -cev.consumiMateriePrime, cumulative: cev.ricaviVendite - cev.consumiMateriePrime },
        { label: 'Servizi', valore: -cev.servizi, cumulative: cev.ricaviVendite - cev.consumiMateriePrime - cev.servizi },
        { label: 'Personale', valore: -cev.personale, cumulative: cev.valoreAggiunto - cev.personale },
        { label: 'EBITDA', valore: 0, cumulative: cev.MOL, isTotal: true }
    ];
    
    const maxVal = Math.max(...steps.map(s => Math.abs(s.cumulative)));
    const scale = 200 / maxVal;
    const barWidth = 60;
    let x = 40;
    
    steps.forEach((step, i) => {
        const prevCumulative = i > 0 ? steps[i-1].cumulative : 0;
        const height = Math.abs(step.valore) * scale;
        const y = 250 - Math.max(prevCumulative, step.cumulative) * scale;
        
        if (step.isTotal) {
            ctx.fillStyle = '#667eea';
            ctx.fillRect(x, 250 - step.cumulative * scale, barWidth, step.cumulative * scale);
        } else {
            ctx.fillStyle = step.valore > 0 ? '#10b981' : '#dc2626';
            ctx.fillRect(x, y, barWidth, height);
        }
        
        // Connettori
        if (i < steps.length - 1 && !step.isTotal) {
            ctx.strokeStyle = '#999';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(x + barWidth, 250 - step.cumulative * scale);
            ctx.lineTo(x + barWidth + 20, 250 - step.cumulative * scale);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // Labels
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(step.label, x + barWidth/2, 270);
        
        x += barWidth + 20;
    });
}

function disegnaTrendBiennale() {
    const canvas = document.getElementById('grafico-trend');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const ce = extractStandardizedCE();
    const cePrev = extractStandardizedCEPrev();
    
    const dati = [
        { label: 'Ricavi', prev: cePrev.ricaviVendite || 0, last: ce.ricaviVendite || 0 },
        { label: 'EBITDA', prev: (cePrev.differenzaAB + cePrev.ammortamenti) || 0, last: (ce.differenzaAB + ce.ammortamenti) || 0 },
        { label: 'Utile', prev: cePrev.utileEsercizio || 0, last: ce.utileEsercizio || 0 }
    ];
    
    const maxVal = Math.max(...dati.flatMap(d => [d.prev, d.last]));
    const scale = 180 / maxVal;
    
    // Assi
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(50, 30);
    ctx.lineTo(50, 230);
    ctx.lineTo(380, 230);
    ctx.stroke();
    
    // Gruppi di barre
    dati.forEach((item, i) => {
        const groupX = 80 + i * 100;
        
        // Barra anno precedente
        ctx.fillStyle = '#9ca3af';
        const prevHeight = item.prev * scale;
        ctx.fillRect(groupX, 230 - prevHeight, 35, prevHeight);
        
        // Barra ultimo anno
        ctx.fillStyle = '#1e40af';
        const lastHeight = item.last * scale;
        ctx.fillRect(groupX + 40, 230 - lastHeight, 35, lastHeight);
        
        // Variazione %
        const variazione = item.prev > 0 ? ((item.last - item.prev) / item.prev * 100) : 0;
        ctx.fillStyle = variazione >= 0 ? '#10b981' : '#dc2626';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText((variazione >= 0 ? '+' : '') + variazione.toFixed(1) + '%', groupX + 37, 15);
        
        // Label
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.fillText(item.label, groupX + 37, 250);
    });
    
    // Legenda
    ctx.fillStyle = '#9ca3af';
    ctx.fillRect(290, 40, 15, 15);
    ctx.fillStyle = '#333';
    ctx.font = '11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Anno Prec.', 310, 51);
    
    ctx.fillStyle = '#1e40af';
    ctx.fillRect(290, 60, 15, 15);
    ctx.fillStyle = '#333';
    ctx.fillText('Ultimo Anno', 310, 71);
}

// ========== MODIFICHE FINALI AL DOM ==========

// Sovrascrivi le funzioni placeholder
window.wip = function(feature) {
    // Invece di solo toast, apri le funzionalit√† reali
    switch(feature) {
        case "Score Economico Finanziario":
            mostraScoreEF();
            break;
        case "Analisi di Bilancio":
            mostraAnalisiCompleta();
            break;
        case "Visualizza Grafici e KPI":
            generaGraficiAnalisi();
            break;
        default:
            toast(`${feature} - In sviluppo`, true);
    }
};

// Aggancia i pulsanti corretti al DOM quando √® pronto
document.addEventListener('DOMContentLoaded', function() {
    // Sovrascrivi handlers esistenti
    setTimeout(() => {
        // Score EF
        const btnScoreEF = byId("btnScoreEF");
        if (btnScoreEF) {
            btnScoreEF.onclick = mostraScoreEF;
        }
        
        // Score Andamentale (gi√† funziona, solo rinomina)
        const btnScoreAnd = byId("btnScoreAnd");
        if (btnScoreAnd) {
            btnScoreAnd.onclick = openScoreAndamentaleInput;
        }
        
// === Pulsante Rating MCC Integrato ===
const btnRatingMCC = byId("btnRatingMCC");
if (btnRatingMCC) {
  btnRatingMCC.onclick = function() {
    try {
      // Recupera Score EF dal localStorage se non in memoria
      let scoreEF = state.scoreEF;
      if (!scoreEF) {
        const annoCorrente = state.anni?.last || "2022";
                       const savedEF = localStorage.getItem(`ceodoc_scoreef_${state.cf}_${annoCorrente}`);
        if (savedEF) scoreEF = JSON.parse(savedEF);
      }

      // Recupera Score Andamentale salvato
      let scoreAnd = state.scoreAndamentale;
      if (!scoreAnd || !scoreAnd.integrato) {
        if (typeof caricaRisultatoScoreAndamentale === "function") {
          const rec = caricaRisultatoScoreAndamentale();
          if (rec) scoreAnd = { integrato: rec };
        }
      }

      if (!scoreEF || !scoreAnd) {
        toast("‚ö†Ô∏è Calcola prima Score EF e Score Andamentale", true);
        return;
      }

      // Calcola Rating MCC Integrato
      const rating = calcolaRatingIntegrato(scoreEF, scoreAnd);
      if (!rating) {
        toast("Errore nel calcolo Rating MCC", true);
      }

    } catch (err) {
      console.error("‚ùå Errore pulsante Rating MCC:", err);
      toast("Errore apertura Rating MCC", true);
    }
  };
}
 
        
        // Pulsante Bilanci Standard (gi√† esistente, aggiungi handler per Break-even)
        const btnBilanciStandard = byId("btnBilanciStandard");
        if (btnBilanciStandard) {
            btnBilanciStandard.onclick = function() {
                mostraBilanciStandard();
                setTimeout(() => {
                    // Popola automaticamente voci break-even
                    popolaVociBreakeven();
                }, 500);
            };
        }
        
        console.log('‚úÖ Tutti i moduli FdG caricati e funzionanti');
    }, 500);
});

// Funzione per generare report completo
window.generaReportCompleto = function() {
    const scoreEF = state.scoreEF || calcolaScoreEconomicoFinanziario();
    const scoreAnd = state.scoreAndamentale;
    
    if (!scoreEF) {
        toast("Prima importa un bilancio", true);
        return;
    }
    
    if (!scoreAnd) {
        toast("Calcola prima lo Score Andamentale", true);
        return;
    }
    
    const rating = calcolaRatingIntegrato(scoreEF, scoreAnd);
    const indici = calcolaIndiciComplessivi();
    const zScore = calcolaZScoreAltman();
    const dscr = calcolaDSCRCompleto();
    const allerta = calcolaIndiciAllertaCrisi();
    
    const report = {
        timestamp: new Date().toISOString(),
        azienda: {
            denominazione: state.denom,
            cf: state.cf,
            settore: state.settore,
            tipo: state.tipo
        },
        scoring: {
            economicoFinanziario: scoreEF,
            andamentale: scoreAnd,
            ratingIntegrato: rating
        },
        analisi: {
            indici: indici,
            zScore: zScore,
            dscr: dscr,
            allertaCrisi: allerta
        }
    };
    
    // Salva report
    localStorage.setItem(`ceodoc_report_completo_${state.cf}`, JSON.stringify(report));
    
    // Mostra riepilogo
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        z-index: 10001;
        max-width: 600px;
    `;
    
    modal.innerHTML = `
        <h2 style="color: #003d82; margin-bottom: 20px; text-align: center;">Report Completo Generato</h2>
        
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 20px; border-radius: 8px; color: white; text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; font-weight: bold;">
                RATING ${rating.rating}
            </div>
            <div style="margin-top: 10px;">
                Fascia ${rating.fascia} - PD: ${rating.pd.toFixed(2)}%
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 12px; color: #666;">Score EF</div>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af;">${rating.scoreEF}</div>
            </div>
            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 12px; color: #666;">Score And.</div>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af;">${rating.scoreAnd}</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="this.closest('div').remove()" class="btn btn-primary">Chiudi</button>
            <button onclick="esportaReportExcel()" class="btn btn-success">Esporta Excel</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    toast("‚úÖ Report completo generato con successo!");
};

// Funzione export Excel (placeholder)
window.esportaReportExcel = function() {
    toast("Export Excel in sviluppo. Usa Export PDF per ora.");
};

// Log finale
console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     ceoDOC - MODULO BILANCI COMPLETO v2.0       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë ‚úÖ Import XLS/XBRL                              ‚ïë
‚ïë ‚úÖ Score Economico-Finanziario (FdG)            ‚ïë
‚ïë ‚úÖ Score Andamentale (CR/CRIF/CERVED)           ‚ïë
‚ïë ‚úÖ Rating Integrato 1-12                        ‚ïë
‚ïë ‚úÖ Riclassificazioni (CEV, VA, Margini)         ‚ïë
‚ïë ‚úÖ Indici (ROE, ROI, ROS, Z-Score, DSCR)        ‚ïë
‚ïë ‚úÖ Allerta Crisi CNDCEC                         ‚ïë
‚ïë ‚úÖ Break-Even Analysis                          ‚ïë
‚ïë ‚úÖ Grafici e KPI                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`);

// === EXPORT FINALE FUNZIONI GLOBALI ===
try {
  Object.assign(window, {
    getDatiTabelleSafe,
    calcolaDSCRCompleto,
    renderDSCRKPI,
    mostraDSCRZScore,
    calcolaZScoreCompleto,
    generaTabDSCR,
    generaTabZScore
  });
  console.log("‚úÖ Funzioni DSCR/Z-Score globali esposte:", {
    mostraDSCRZScore: typeof mostraDSCRZScore,
    calcolaDSCRCompleto: typeof calcolaDSCRCompleto
  });
} catch (e) {
  console.error("‚ùå Errore export funzioni DSCR/Z-Score:", e);
}


// FINE CODICE - Chiusura script
</script>

<!-- === Libreria grafici Chart.js === -->
<script src="../libs/cr/backup/chart.min.js"></script>

</body>
</html>
